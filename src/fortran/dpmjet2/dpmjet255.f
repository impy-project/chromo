C     This file contains changes by J.Ranft from Sept.5 2007

C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      BLOCK DATA BLKD41
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
*KEEP,PANAME.
C------------------
C
C     /PANAME/ CONTAINS PARTICLE NAMES
C        BTYPE  = LITERAL NAME OF THE PARTICLE
C
      CHARACTER*8 BTYPE
      COMMON /PANAME/ BTYPE(30)
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,HADTHR.
      COMMON /HADTHR/ EHADTH,INTHAD
*KEEP,NSHMAK.
      COMMON /NSHMAK/ NNSHMA,NPSHMA,NTSHMA,NSHMAC,NSHMA2
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,DSHM.
      COMMON /DSHM/ RASH,RBSH,BMAX,BSTEP,SIGSH,ROSH,GSH,
     *              BSITE(0:1,200),NSTATB,NSITEB
*KEEP,DAMP.
      COMPLEX*16 CA,CI
      COMMON /DAMP/   CA,CI,GA
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEND.
      COMMON /DIFFRA/ ISINGD,IDIFTP,IOUDIF,IFLAGD
      COMMON /NOMIJE/ PTMIJE(10),NNMIJE(10)
      DATA PTMIJE /5.D0,7.D0,9.D0,11.D0,13.D0,15.D0,17.D0
     +,19.D0,21.D0,23.D0 /
*
*---rejection counters
      DATA IRCO1,IRCO2,IRCO3,IRCO4,IRCO5 /5*0/
      DATA IRSS11,IRSS12,IRSS13,IRSS14,IRSV11,IRSV12,IRSV13,IRSV14 /8*0/
      DATA IRVS11,IRVS12,IRVS13,IRVS14,IRVV11,IRVV12,IRVV13,IRVV14 /8*0/
C-------------------
      DATA INTHAD  /0/
*---predefinition of nuclear potentials, average binding energies, ...
      DATA PREPOT /210*0.0/
      DATA TAEPOT /210*0.0/
      DATA TAEBIN,PREBIN,FERMOD /2*0.0D0,0.6D0/
*---internal particle names
      DATA BTYPE /'PROTON  ' , 'APROTON ' , 'ELECTRON' , 'POSITRON' ,
     +'NEUTRIE ' , 'ANEUTRIE' , 'PHOTON  ' , 'NEUTRON ' , 'ANEUTRON' ,
     +'MUON+   ' , 'MUON-   ' , 'KAONLONG' , 'PION+   ' , 'PION-   ' ,
     +'KAON+   ' , 'KAON-   ' , 'LAMBDA  ' , 'ALAMBDA ' , 'KAONSHRT' ,
     +'SIGMA-  ' , 'SIGMA+  ' , 'SIGMAZER' , 'PIZERO  ' , 'KAONZERO' ,
     +'AKAONZER' , 'RESERVED' , 'BLANK   ' , 'BLANK   ' , 'BLANK   ' ,
     +'BLANK   ' /
*---print options
      DATA IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR /0, 0, 0, -1, 0,
     +0, 0,  0/
C-------------------
      DATA INTPT, FERMP, IHADSS,IHADSV,IHADVS,IHADVV, IHADA /.TRUE.,
     +.TRUE., 4*.FALSE., .TRUE./
      DATA IPADIS, ISHMAL, LPAULI /.FALSE., .FALSE., .TRUE./
C----------------------------------
      DATA NSHMAC /0/
      DATA NSHMA2 /0/
*---parameters for Glauber initialization / calculation
      DATA NSTATB, NSITEB /2000, 200/
      DATA CI /1.0/
*---parameters for combination of q-aq chains to color ropes
C     DATA LCOMBI /.FALSE./, NCUTOF /100/
      DATA ISINGD,IDIFTP,IOUDIF,IFLAGD /0,0,0,0/
*
      END
************************************************************************
************************************************************************
*
                      BLOCK DATA BOOKLE
*                                               
*  *********************************************************************
*                         /BOOKLT/
*
* neeeded in the following routines: DTUMAIN
*
* description
*     /BOOKLT/ contains the final  particle names and PPDB-numbers
*        BTYPE  = literal name of the particle
*        NBOOK  = the number of the particle
*                 proposed in the particle data booklet (90)
*  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      CHARACTER*8 BTYPE
      COMMON/BOOKLT/BTYPE(30),NBOOK(30)
*
      DATA BTYPE /'PROTON  ' , 'APROTON ' , 'ELECTRON' ,
     1            'POSITRON' , 'NEUTRIE ' , 'ANEUTRIE' ,
     2            'PHOTON  ' , 'NEUTRON ' , 'ANEUTRON' ,
     3            'MUON+   ' , 'MUON-   ' , 'KAONLONG' ,
     4            'PION+   ' , 'PION-   ' , 'KAON+   ' ,
     5            'KAON-   ' , 'LAMBDA  ' , 'ALAMBDA ' ,
     6            'KAONSHRT' , 'SIGMA-  ' , 'SIGMA+  ' ,
     7            'SIGMAZER' , 'PIZERO  ' , 'KAONZERO' ,
     9            'AKAONZER' , '        ' , '        ' ,
     Z            '        ' , '        ' , '        ' /
*
*
      DATA NBOOK / 2212      , -2212      ,  11        ,
     1            -11        ,  14        , -14        ,
     2             22        ,  2112      , -2112      ,
     3            -13        ,  13        ,  130       ,
     4             211       , -211       ,  321       ,
     5            -321       ,  3122      , -3122      ,
     6             310       ,  3114      ,  3224      ,
     7             3214      ,  111       ,  311       ,
     9            -311       ,  0         ,  0         ,
     Z              0        ,  0         ,  0         /
*
      END


C______________________________________________________________________
      SUBROUTINE SAMPPT(MODE,PT)
* pt for partons at the end of soft chains
*  this pt is sampled from the distribution
*  exp(-b*pt^2) with pt=0..ptcut
*  MODE = 0  - initialization to determine parameter b from total soft
*              and differential hard cross section
*  MODE = 1  - sample pt
*  MODE = 2  - PLOT PT DISTRIBUTION SAMPLED
*
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      PARAMETER ( ZERO=0.D0, ONE=1.D0)
      PARAMETER ( ALFA=0.56268D-01, BETA=0.17173D+03 )
      PARAMETER ( ACC = 0.0001D0 )
      COMMON /XSECPT/ PTCUT,SIGS,DSIGH
      COMMON /SIGMA / SIGSOF,BS,ZSOF,SIGHAR,FILL(7)
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C repl. COMMON/COLLIS/ECM,S,IJPROJ,IJTAR,PTTHR,IOPHRD,IJ1LU,IJ2LU,PTTHR2
      COMMON/COLLIS/S,IJPROJ,IJTAR,PTTHR,PTTHR2,IOPHRD,IJPRLU,IJTALU
      CHARACTER*80 TITLE
      CHARACTER*8 PROJTY,TARGTY
C     COMMON /USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    &            ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
*
      COMMON/PTSAMP/ ISAMPT
      DIMENSION PPTT(50),DPPTT(50)
      DATA ECM0 /0.1D0/
C     to keep identical commons for patchy ect
      ECM=CMENER
      PTTHR=2.5+0.12*(LOG10(CMENER/50.))**3
      PTCUT=PTTHR      
      CALL SIGSHD(ECM)
      IF ( MODE.EQ.0 ) THEN
        DO 201 II=1,50
          PPTT(II)=II*PTCUT/50.
          DPPTT(II)=0.
  201   CONTINUE
        SIGS  = 0.15*SIGSOF
        IF(ECM.LT.1000.)THEN
          AACUCU=0.85*(ECM-400.)/600.
          SIGS=(1.-AACUCU)*SIGSOF
        ENDIF
C*************************************************************
C
C       OPTIONS FOR SOFT PT SAMPLING
C
CWRITE(6,'(A,4E12.4)')' SAMPPT:ECM,PTCUT,SIGS,DSIGH',
C    *	ECM,PTCUT,SIGS,DSIGH
        IF(ECM0.NE.ECM)THEN
C         WRITE(6,'(A,5E12.4)')' SAMPPT:ECM,PTCUT,SIGS,DSIGH,SIGHAR',
C    *    ECM,PTCUT,SIGS,DSIGH,SIGHAR
C         WRITE(6,5559)PTCUT,SIGSOF,SIGHAR,ISAMPT
 5559     FORMAT(' SAMPPT:PTCUT,SIDSOF.SIGHATD,ISAMPT:',3E12.3,I5)
        ENDIF
        IF( ISAMPT.EQ.0 ) THEN
          C  = DSIGH/(2.*SIGS*PTCUT)
          B  = BSOFPT(ACC,C,PTCUT)
        IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
        ELSEIF( ISAMPT.EQ.1 ) THEN
          EB = ECM/BETA
          C = ALFA*LOG(EB)
          B  = BSOFPT(ACC,C,PTCUT)
        IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
        ELSEIF( ISAMPT.EQ.2 ) THEN
          B=-6.
        IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
        ELSEIF( ISAMPT.EQ.3 ) THEN
          B=1.E-06
        IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
        ELSEIF( ISAMPT.EQ.4)THEN
          AAAA=PTCUT**2*(SIGSOF+SIGHAR)
          IF (AAAA.LE.0.00001D0) THEN
            AAAA=ABS(AAAA)+0.0002
C           WRITE(6,5559)PTCUT,SIGSOF,SIGHAR
C5559       FORMAT(' SAMPPT:PTCUT,SIDSOF.SIGHATD:',3E12.3)
          ENDIF
          C=SIGHAR/AAAA
          B  = 0.5*BSOFPT(ACC,C,PTCUT)
	IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
        ENDIF
        ECM0=ECM
C*************************************************************
        RMIN = EXP(B*PTCUT**2)
C
C        IOUTPO=IOUTPA
C        IOUTPA=1
        IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
9010  FORMAT(' SAMPPT MODE,ISAMPT,PTCUT,SIGS,DSIGH,B,C,SIGSOF',
     *' SIGHAR,RMIN ',
     *         2I2,F5.2,7E13.6)
C        IOUTPA=IOUTPO
      ELSEIF ( MODE.EQ.1 ) THEN
        IF( IOUTPA.GE.1 )WRITE(6,9010)MODE,ISAMPT,PTCUT,SIGS,DSIGH,B
     * ,C,SIGSOF,SIGHAR,RMIN
        PTT   =LOG(1.0-RNDM(V)*(1.0-RMIN))/(B+0.00001D0)
        PT=SQRT(PTT)
        IIPT=PT*50./PTCUT+1.
        IIPT=MIN( IIPT,50 )
        DPPTT(IIPT)=DPPTT(IIPT)+1./(PT+0.000001D0)
C       WRITE(6,111)MODE,PTT,PT,B,RMIN
C 111   FORMAT ('SAMPPT: MODE,PTT,PT,B RMIN',I5,4E15.8)
      ELSEIF(MODE.EQ.2)THEN
        DO 202 II=1,50
          DPPTT(II)=LOG10(1.E-8+DPPTT(II))
  202   CONTINUE
        IF(IOUXEV.GE.-1)THEN
         WRITE (6,203)
  203   FORMAT(' PT DISTRIBUTION OF SOFT PARTONS AS SAMPLED IN BSOFPT')
         CALL PLOT(PPTT,DPPTT,50,1,50,ZERO,PTCUT/50.D0,ZERO,0.05D0*ONE)
        ENDIF
      ENDIF
      RETURN
      END
C****************************************************************8****
       REAL
     *      * 8
     * FUNCTION BSOFPT(ACC,CC,PPTCUT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      LOGICAL SUCCES
      COMMON /BSOFF1/C,PTCUT
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      EXTERNAL BSOFC1,BSOF1
      DIMENSION X(50),Y(50)
      C=CC
      PTCUT=PPTCUT
      DO 100 I=1,50
        X(I)=-2.5+I*0.1
        Y(I)=BSOF1(X(I))
  100 CONTINUE
C     CALL PLOT (X,Y,50,1,50,-2.5D0,0.1D0,-1.D0,0.02D0)
      IF(C.LT.1.D-10) THEN
        BB=-30.
        GO TO 999
      ENDIF
C     IF (C.GT.1.) THEN
        KKKK=0
        JJJJ=0
        B1=C+3.
        B2=0.0001
        GO TO 300
  400 CONTINUE
      KKKK=KKKK+1
C     ENDIF
C     IF (C.LT.1.)THEN
        B1=-0.00001
        B2=-3.
C     ENDIF
  300 CONTINUE
      CALL ZBRAC(BSOF1,B1,B2,SUCCES)
      IF (.NOT.SUCCES)THEN
        IF (KKKK.EQ.0)GO TO 400
        JJJJ=1
      ENDIF
      IF(IOUXEV.GE.1)WRITE(6,111)B1,B2
  111 FORMAT(2F10.4)
      IF (SUCCES)THEN
        BB=RTSAFE(BSOFC1,B1,B2,ACC)
      ENDIF
      IF (JJJJ.EQ.1)BB=0.
  999 CONTINUE
      BSOFPT=BB
      RETURN
      END
      SUBROUTINE BSOFC1(B,F,DF)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      COMMON /BSOFF1/C,PTCUT
      AAA=EXP(B*PTCUT**2)
      F=C*(AAA-1.)-B*AAA
      DF=C*PTCUT**2*AAA-AAA
     *                       -B*PTCUT**2*AAA
      RETURN
      END
*
*******************************************************************
*
       REAL
     *      * 8
     *  FUNCTION BSOF1(B)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      COMMON /BSOFF1/C,PTCUT
      QQQ=B*PTCUT**2
      AAA=0.
      IF(QQQ.GT.-60.) THEN
        AAA=EXP(B*PTCUT**2)
      ENDIF
      BSOF1=C*(AAA-1.)-B*AAA
C     WRITE(6,10)B,PTCUT,BSOF1,C
C  10 FORMAT (4E15.4)
      RETURN
      END
*
*******************************************************************************
       REAL
     *      * 8
     *  FUNCTION RTSAFE(FUNCD,X1,X2,XACC)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      PARAMETER (MAXIT=200,ITEPRI=0)
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      CALL FUNCD(X1,FL,DF)
C     IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1) WRITE(6,9999) FL,DF
      CALL FUNCD(X2,FH,DF)
C     IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1) WRITE(6,9999) FH,DF
      IF(FL*FH.GE.0.) PAUSE 'ROOT MUST BE BRACKETED'
      IF(FL.LT.0.)THEN
        XL=X1
        XH=X2
      ELSE
        XH=X1
        XL=X2
        SWAP=FL
        FL=FH
        FH=SWAP
      ENDIF
      RTSAFE=.5*(X1+X2)
      DXOLD=ABS(X2-X1)
      DX=DXOLD
      CALL FUNCD(RTSAFE,F,DF)
C     IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1) WRITE(6,9998) RTSAFE,F,DF
C     IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1) WRITE(6,9996)
      DO 11 J=1,MAXIT
C       IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1)
C    *  WRITE(6,9997) RTSAFE,XH,XL,DXOLD,F,DF
        VR1 = VAR( RTSAFE,XH,DF,F )
        VR2 = VAR( RTSAFE,XL,DF,F )
C       IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1) WRITE(6,9995) VR1,VR2
C       IF(((RTSAFE-XH)*DF-F)*((RTSAFE-XL)*DF-F).GE.0.
C    *      .OR. ABS(2.*F).GT.ABS(DXOLD*DF) ) THEN
        IF( VR1*VR2 .GE. 0.
     *      .OR. ABS(2.*F).GT.ABS(DXOLD*DF) ) THEN
          DXOLD=DX
          DX=0.5*(XH-XL)
          RTSAFE=XL+DX
          IF(XL.EQ.RTSAFE)RETURN
        ELSE
          DXOLD=DX
C         IF(IOUXEV.GE.0.AND.ITEPRI.EQ.1) WRITE(6,9999) F,DF
          DX=F/DF
          TEMP=RTSAFE
          RTSAFE=RTSAFE-DX
          IF(TEMP.EQ.RTSAFE)RETURN
        ENDIF
        IF(ABS(DX).LT.XACC) RETURN
        CALL FUNCD(RTSAFE,F,DF)
        IF(F.LT.0.) THEN
          XL=RTSAFE
          FL=F
        ELSE
          XH=RTSAFE
          FH=F
        ENDIF
11    CONTINUE
      PAUSE 'RTSAFE EXCEEDING MAXIMUM ITERATIONS'
      RETURN
9995  FORMAT('  VR1,VR2:',2E12.5)
9996  FORMAT('  RTSAFE,XH,XL,DXOLD,F,DF IN LOOP 11 J=1,MAXIT')
9997  FORMAT(3X,6E10.3)
9998  FORMAT('  RTSAFE: RTSAFE,F,DF =',3E12.5)
9999  FORMAT('  RTSAFE: F,DF =',2E12.5)
      END
*
*****************************************************************
       REAL
     *      * 8
     *  FUNCTION VAR(A,B,C,D)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      PARAMETER( AMBMAX = 1.0D+38, EPSI = 1.2D-38, ONE=1.D0 )
      AMB = A - B
C     SIAB= SIGN(ONE,AMB)
               SIAB= DSIGN(ONE,AMB)
      ABL = ABS(AMB)
      ABL = LOG10( ABL + EPSI )
C     SICC= SIGN(ONE, C )
             SICC= DSIGN(ONE, C )
      CCL = ABS( C )
      CCL = LOG10( CCL + EPSI )
      RCHECK=ABL + CCL
      IF( RCHECK .LE. 38.D0 ) THEN
        VAR = AMB*C-D
      ELSE
        VAR = AMBMAX*SIAB*SICC - D
      ENDIF
      IF( VAR .GT. 1.0D+18 ) VAR = 1.0E+18
      IF( VAR .LT. -1.0D+18 ) VAR = -1.0E+18
      RETURN
      END
C
      SUBROUTINE ZBRAC(FUNC,X1,X2,SUCCES)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      EXTERNAL FUNC
      PARAMETER (FACTOR=1.6D0,NTRY=50)
      LOGICAL SUCCES
      IF(X1.EQ.X2)PAUSE 'You have to guess an initial range'
      F1=FUNC(X1)
      F2=FUNC(X2)
      SUCCES=.TRUE.
      DO 11 J=1,NTRY
        IF(F1*F2.LT.0.D0)RETURN
        IF(ABS(F1).LT.ABS(F2))THEN
          X1=X1+FACTOR*(X1-X2)
          F1=FUNC(X1)
        ELSE
          X2=X2+FACTOR*(X2-X1)
          F2=FUNC(X2)
        ENDIF
11    CONTINUE
      SUCCES=.FALSE.
      RETURN
      END
*
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE CHECKF(EPN,PPN,IREJ,IORIG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (AMUAMU=0.93149432D0)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DELP.
      COMMON /DELP/ DELPX,DELPY,DELPZ,DELPE
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      DATA ICHECK/0/
      HELP=LOG10(EPN)
      PHELP=0.
      IF(HELP.GT.5.D0)PHELP=HELP-5.
      PTHELP=12.+PHELP*5.
      IREJ=0
      IREJJ=0
      PX=0.
      PY=0.
      PZ=0.
      PE=0.
      EEXT=0.
      EEXP=0.
      EEE1=0.
      EEEM1=0.
      EE1001=0.
      DO 10 I=1,NHKK
C                               Projectiles
        IF(ISTHKK(I).EQ.11.OR.ISTHKK(I).EQ.13) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - GAM*PHKK(3,I) - BGAM*PHKK(4,I)
          PE=PE - GAM*PHKK(4,I) - BGAM*PHKK(3,I)
        ENDIF
C                            Target
        IF(ISTHKK(I).EQ.12.OR.ISTHKK(I).EQ.14) THEN
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - PHKK(3,I)
          PE=PE - PHKK(4,I)
        ENDIF
*                                 sum final state momenta
        IF(ISTHKK(I).EQ.1) THEN
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
C                      noninteracting  Projectiles
        IF(ISTHKK(I).EQ.13.AND.JDAHKK(2,I).EQ.0) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
        ENDIF
        IF(ISTHKK(I).EQ.14.AND.JDAHKK(2,I).EQ.0) THEN
C                      noninteracting  Targets
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
        IF(ISTHKK(I).EQ.16) THEN
          IMO=JMOHKK(1,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
          EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
        ENDIF
        IF(ISTHKK(I).EQ.15) THEN
          IMO=JMOHKK(1,I)
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
          EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
        ENDIF
        IF(ISTHKK(I).EQ.1) THEN
	  EEE1=EEE1+PHKK(4,I)
        ENDIF
        IF(ISTHKK(I).EQ.-1) THEN
	  EEEM1=EEEM1+PHKK(4,I)
        ENDIF
        IF(ISTHKK(I).EQ.1001) THEN
	  EE1001=EE1001+PHKK(4,I)
        ENDIF
   10 CONTINUE
      EEE=EEE1+EEEM1+EE1001
      EPNTO=EPN*IP
      AEEE=EEE/EPNTO
      EEEE=EEE-EPN*IP
      AEEEE=EEE/EPN-IP
      AEEE1=EEE1/EPNTO
      AEEEM1=EEEM1/EPNTO
      AEE101=EE1001/EPNTO
      AIP=1
      AIT=IT
      AITZ=ITZ
      AIP=AIP+(AIT*AMUAMU+1.D-3*ENERGY(AIT,AITZ))/EPNTO
      DELLE=ABS(AIP-AEEE)
      ELLE=DELLE*EPNTO
      TOLE=0.030
C     TOLE=0.012
      IF(IT.LE.50)THEN
        IF(IT.EQ.IP)TOLE=0.02
C       IF(IT.EQ.IP)TOLE=0.05
      ENDIF
      IF(DELLE.GE.TOLE)IREJ=1
      IF(IREJ.EQ.1)THEN
        ICHECK=ICHECK+1
	IF(ICHECK.LE.-100)THEN
          WRITE(6,'(A,I5,E10.3,5F10.4)')
     *    ' IP,EPN,AEEE,AEEEE,AEEE1,AEEEM1,AEE101:',
     *    IP,EPN,AEEE,AEEEE,AEEE1,AEEEM1,AEE101
          WRITE(6,'(A,I5,E10.3,7E12.4)')
     *    ' IP,EPN,EEE,EEEE,EEE1,EEEM1,EE1001,DELLE,ELLE:',
     *    IP,EPN,EEE,EEEE,EEE1,EEEM1,EE1001,DELLE,ELLE
        ENDIF
      ENDIF
C     PX=PX + DELPX
C     PY=PY + DELPY
C     PZ=PZ + DELPZ
C     PE=PE + DELPE
C     IF(IPRI.GT.1) THEN
C       IF (ABS(PX).GT.PTHELP.OR. ABS(PY).GT.PTHELP.OR. 
C    * 	ABS(PZ)/EPN.GT.0.025*IP.
C    +  OR. ABS(PE)/EPN.GT.0.025*IP) THEN
C         IREJJ=1
C         ICHECK=ICHECK+1
C         IF(ICHECK.LE.500.AND.IREJJ.EQ.1)THEN 
C     WRITE(6,1000) PX,PY,PZ,PE,EEXT,EEXP,DELPX,DELPY,DELPZ,DELPE,IORIG
C         ENDIF
 1000 FORMAT(' CHECKF: PX,PY,PZ,PE,EEXT,EEXP',2F7.3,2E12.3,2F7.3
     * / 8X,' DELPX/Y/Z/E',4F7.3,I10,' IORIG')
C     WRITE(6,'(8X,A,6F8.3)') ' TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA',
C    +TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
 
      IF(IPRI.GT.1) THEN
          DO 20 I=1,NHKK
            IF(ISTHKK(I).EQ.11) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.12) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.1) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
 1010 FORMAT (I6,I4,5I6,9(1PE10.2))
            ENDIF
            IF(ISTHKK(I).EQ.16) THEN
              IMO=JMOHKK(1,I)
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
   20     CONTINUE
        ENDIF
C     ENDIF
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE CHECKN(EPN,PPN,IREJ,IORIG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (AMUAMU=0.93149432D0)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DELP.
      COMMON /DELP/ DELPX,DELPY,DELPZ,DELPE
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      DATA ICHECK/0/
      HELP=LOG10(EPN)
      PHELP=0.
      IF(HELP.GT.5.D0)PHELP=HELP-5.D0
      PTHELP=12.D0+PHELP*5.D0
      IREJ=0
      IREJJ=0
      PX=0.D0
      PY=0.D0
      PZ=0.D0
      PE=0.D0
      EEXT=0.D0
      EEXP=0.D0
      EEE1=0.D0
      EEEM1=0.D0
      EE1001=0.D0
      PZ1=0.D0
      PZM1=0.D0
      PZ1001=0.D0
      PX1=0.D0
      PXM1=0.0
      PX1001=0.D0
      DO 10 I=1,NHKK
C                               Projectiles
        IF(ISTHKK(I).EQ.11.OR.ISTHKK(I).EQ.13) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - GAM*PHKK(3,I) - BGAM*PHKK(4,I)
          PE=PE - GAM*PHKK(4,I) - BGAM*PHKK(3,I)
        ENDIF
C                            Target
        IF(ISTHKK(I).EQ.12.OR.ISTHKK(I).EQ.14) THEN
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - PHKK(3,I)
          PE=PE - PHKK(4,I)
        ENDIF
*                                 sum final state momenta
        IF(ISTHKK(I).EQ.1) THEN
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
C                      noninteracting  Projectiles
        IF(ISTHKK(I).EQ.13.AND.JDAHKK(2,I).EQ.0) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
        ENDIF
        IF(ISTHKK(I).EQ.14.AND.JDAHKK(2,I).EQ.0) THEN
C                      noninteracting  Targets
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
        IF(ISTHKK(I).EQ.16) THEN
          IMO=JMOHKK(1,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
          EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
        ENDIF
        IF(ISTHKK(I).EQ.15) THEN
          IMO=JMOHKK(1,I)
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
          EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
        ENDIF
        IF(ISTHKK(I).EQ.1) THEN
	  EEE1=EEE1+PHKK(4,I)
	  PZ1=PZ1+PHKK(3,I)
	  PX1=PX1+PHKK(1,I)
        ENDIF
        IF(ISTHKK(I).EQ.-1) THEN
	  EEEM1=EEEM1+PHKK(4,I)
	  PZM1=PZM1+PHKK(3,I)
	  PXM1=PXM1+PHKK(1,I)
        ENDIF
        IF(ISTHKK(I).EQ.1001) THEN
	  EE1001=EE1001+PHKK(4,I)
	  PZ1001=PZ1001+PHKK(3,I)
	  PX1001=PX1001+PHKK(1,I)
        ENDIF
   10 CONTINUE
      EEE=EEE1+EEEM1+EE1001
      PZPZ=PZ1+PZM1+PZ1001
      PXPX=PX1+PXM1+PX1001
C--------------------------------------------------------------
C
C                    patch to correct pz of residual nuclei
C
C--------------------------------------------------------------
      DELPZ=PPN-PZPZ
      PZPZ=PZPZ+DELPZ
      PZ1001=PZ1001+DELPZ
      EE1001=0.D0
      DO 101 I=1,NHKK
        IF(ISTHKK(I).EQ.1001) THEN
	  PHKK(3,I)=PHKK(3,I)+DELPZ
	  PHKK(4,I)=SQRT(PHKK(1,I)**2+PHKK(2,I)**2+PHKK(3,I)**2
     *                   +PHKK(5,I)**2)
	  EE1001=EE1001+PHKK(4,I)
        ENDIF
  101 CONTINUE
      EEE=EEE1+EEEM1+EE1001
C--------------------------------------------------------------
      AIP=1
      EPNTO=EPN*AIP
      EEEE=EEE-EPN*AIP
      AIP=1
      AIT=IT
      AITZ=ITZ
      BIP=EPN+(AIT*AMUAMU+1.D-3*ENERGY(AIT,AITZ))
      BMI=1.D-3*ENERGY(AIT,AITZ)
      DELLE=ABS(BIP-EEE)
C     TOLE=EPN/450000.D0
C     TOLE=EPN/2500.D0
      TOLE=0.16D0
      IF(DELLE.GE.TOLE)IREJ=1
      IF(IREJ.EQ.1)THEN
        ICHECK=ICHECK+1
	IF(ICHECK.LE.-20)THEN
          WRITE(6,'(A,I5,E10.3,4F10.4)')
     *    ' IP,EPN,PXPX,PX1,PXM1,PX1001:',
     *    IP,EPN,PXPX,PX1,PXM1,PX1001
          WRITE(6,'(A,I5,E10.3,6F10.4)')
     *    ' IP,PPN,PZPZ,PZ1,PZM1,PZ1001,BIP,BMI:',
     *    IP,PPN,PZPZ,PZ1,PZM1,PZ1001,BIP,BMI
          WRITE(6,'(A,I5,E10.3,5E12.4)')
     *    ' IP,EPN,EEE,EEE1,EEEM1,EE1001,DELLE:',
     *    IP,EPN,EEE,EEE1,EEEM1,EE1001,DELLE
        ENDIF
      ENDIF
C     PX=PX + DELPX
C     PY=PY + DELPY
C     PZ=PZ + DELPZ
C     PE=PE + DELPE
C     IF(IPRI.GT.1) THEN
C       IF (ABS(PX).GT.PTHELP.OR. ABS(PY).GT.PTHELP.OR. 
C    * 	ABS(PZ)/EPN.GT.0.025D0*IP.
C    +  OR. ABS(PE)/EPN.GT.0.025D0*IP) THEN
C         IREJJ=1
C         ICHECK=ICHECK+1
C         IF(ICHECK.LE.500.AND.IREJJ.EQ.1)THEN 
C     WRITE(6,1000) PX,PY,PZ,PE,EEXT,EEXP,DELPX,DELPY,DELPZ,DELPE,IORIG
C         ENDIF
 1000 FORMAT(' CHECKF: PX,PY,PZ,PE,EEXT,EEXP',2F7.3,2E12.3,2F7.3
     * / 8X,' DELPX/Y/Z/E',4F7.3,I10,' IORIG')
C     WRITE(6,'(8X,A,6F8.3)') ' TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA',
C    +TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
 
      IF(IPRI.GT.1) THEN
          DO 20 I=1,NHKK
            IF(ISTHKK(I).EQ.11) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.12) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.1) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
 1010 FORMAT (I6,I4,5I6,9(1PE10.2))
            ENDIF
            IF(ISTHKK(I).EQ.16) THEN
              IMO=JMOHKK(1,I)
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
   20     CONTINUE
        ENDIF
C     ENDIF
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE CHECKO(EPN,PPN,IREJ,IORIG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (AMUAMU=0.93149432D0)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
      COMMON /ZENTRA/ ICENTR
*KEEP,DELP.
      COMMON /DELP/ DELPX,DELPY,DELPZ,DELPE
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      DATA ICHECK/0/
      HELP=LOG10(EPN)
      PHELP=0.
      IF(HELP.GT.5.D0)PHELP=HELP-5.
      PTHELP=12.+PHELP*5.
      IREJ=0
      IREJJ=0
      PX=0.
      PY=0.
      PZ=0.
      PE=0.
      EEXT=0.
      EEXP=0.
      EEE1=0.
      EEEM1=0.
      EE1001=0.
      DO 10 I=1,NHKK
C                               Projectiles
        IF(ISTHKK(I).EQ.11.OR.ISTHKK(I).EQ.13) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - GAM*PHKK(3,I) - BGAM*PHKK(4,I)
          PE=PE - GAM*PHKK(4,I) - BGAM*PHKK(3,I)
        ENDIF
C                            Target
        IF(ISTHKK(I).EQ.12.OR.ISTHKK(I).EQ.14) THEN
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - PHKK(3,I)
          PE=PE - PHKK(4,I)
        ENDIF
*                                 sum final state momenta
        IF(ISTHKK(I).EQ.1) THEN
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
C                      noninteracting  Projectiles
        IF(ISTHKK(I).EQ.13.AND.JDAHKK(2,I).EQ.0) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
        ENDIF
        IF(ISTHKK(I).EQ.14.AND.JDAHKK(2,I).EQ.0) THEN
C                      noninteracting  Targets
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
        IF(ISTHKK(I).EQ.16) THEN
          IMO=JMOHKK(1,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
c pb stabilizing effort
          if (imo.eq.0) then
             EEXT=EEXT + PHKK(4,I)
          else
             EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
          endif
c pb stabilizing effort
        ENDIF
        IF(ISTHKK(I).EQ.15) THEN
          IMO=JMOHKK(1,I)
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
c pb stabilizing effort
          if (imo.eq.0) then
             EEXT=EEXT + PHKK(4,I)
          else
             EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
          endif
c pb stabilizing effort
        ENDIF
        IF(ISTHKK(I).EQ.1) THEN
	  EEE1=EEE1+PHKK(3,I)
        ENDIF
   10 CONTINUE
      EEE=EEE1
      EPNTO=PPN*IP
      AEEE=EEE/EPNTO
      EEEE=EEE-PPN*IP
      AEEEE=EEE/PPN-IP
      AEEE1=EEE1/EPNTO
      AIP=1
      AIT=IT
      AITZ=ITZ
      AIP=AIP
      DELLE=ABS(AIP-AEEE)
      ELLE=DELLE*EPNTO
C     IF(DELLE.GE.0.025)IREJ=1
C     IF(IREJ.EQ.1)
C    * WRITE(6,'(A,I5,E10.3,3F10.4)')
C    *' IP,EPN,AEEE,AEEEE,AEEE1:',
C    * IP,EPN,AEEE,AEEEE,AEEE1
C     IF(IREJ.EQ.1)
C    * WRITE(6,'(A,I5,E10.3,5F10.4)')
C    *' IP,EPN,EEE,EEEE,EEE1,DELLE,ELLE:',
C    * IP,EPN,EEE,EEEE,EEE1,DELLE,ELLE
      PX=PX + DELPX
      PY=PY + DELPY
      PZ=PZ + DELPZ
      PE=PE + DELPE
      TOLE=0.025D0*IP
      IF(IP.EQ.IT.AND.IT.GT.1)TOLE=0.05D0*IP
C     IF(ICENTR.EQ.1)TOLE=TOLE*2.
      IF(EPN.LE.5.D0)TOLE=3.D0*TOLE
C     IF(IPRI.GT.1) THEN
        IF (ABS(PX).GT.PTHELP.OR. ABS(PY).GT.PTHELP.OR. 
     * 	ABS(PZ)/EPN.GT.TOLE.
     +  OR. ABS(PE)/EPN.GT.TOLE) THEN
          IREJ=1
          ICHECK=ICHECK+1
          IF(ICHECK.LE.50.AND.IREJ.EQ.1)THEN 
          IF(IPRI.GE.1)
     &WRITE(6,1000) PX,PY,PZ,PE,EEXT,EEXP,DELPX,DELPY,DELPZ,DELPE,IORIG
          ENDIF
 1000 FORMAT(' CHECKO: PX,PY,PZ,PE,EEXT,EEXP',2F7.3,2E12.3,2F7.3
     * / 8X,' DELPX/Y/Z/E',4F7.3,I10,' IORIG')
C     WRITE(6,'(8X,A,6F8.3)') ' TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA',
C    +TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
          IF(IPRI.GE.1)THEN 
      WRITE(6,1000) PX,PY,PZ,PE,EEXT,EEXP,DELPX,DELPY,DELPZ,DELPE,IORIG
          ENDIF
      IF(IPRI.GT.1) THEN
          DO 20 I=1,NHKK
            IF(ISTHKK(I).EQ.11) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.12) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.1) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
 1010 FORMAT (I6,I4,5I6,9(1PE10.2))
            ENDIF
            IF(ISTHKK(I).EQ.16) THEN
              IMO=JMOHKK(1,I)
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
   20     CONTINUE
        ENDIF
      ENDIF
          IF(IPRI.GE.1)THEN 
      WRITE(6,1000) PX,PY,PZ,PE,EEXT,EEXP,DELPX,DELPY,DELPZ,DELPE,IORIG
          ENDIF
      RETURN
      END
C
      SUBROUTINE CHECKE(EPN,PPN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DELP.
      COMMON /DELP/ DELPX,DELPY,DELPZ,DELPE
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      PX=0.
      PY=0.
      PZ=0.
      PE=0.
      EEXT=0.
      EEXP=0.
      DO 10 I=1,NHKK
C                               Projectiles
        IF(ISTHKK(I).EQ.11.OR.ISTHKK(I).EQ.13) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - GAM*PHKK(3,I) - BGAM*PHKK(4,I)
          PE=PE - GAM*PHKK(4,I) - BGAM*PHKK(3,I)
        ENDIF
C                            Target
        IF(ISTHKK(I).EQ.12.OR.ISTHKK(I).EQ.14) THEN
          PX=PX - PHKK(1,I)
          PY=PY - PHKK(2,I)
          PZ=PZ - PHKK(3,I)
          PE=PE - PHKK(4,I)
        ENDIF
*                                 sum final state momenta
        IF(ISTHKK(I).EQ.1) THEN
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
C                      noninteracting  Projectiles
        IF(ISTHKK(I).EQ.13.AND.JDAHKK(1,I).EQ.0) THEN
          GAM=EPN/PHKK(5,I)
          BGAM=PPN/PHKK(5,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + GAM*PHKK(3,I) + BGAM*PHKK(4,I)
          PE=PE + GAM*PHKK(4,I) + BGAM*PHKK(3,I)
        ENDIF
        IF(ISTHKK(I).EQ.14.AND.JDAHKK(1,I).EQ.0) THEN
C                      noninteracting  Targets
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
        ENDIF
        IF(ISTHKK(I).EQ.16) THEN
          IMO=JMOHKK(1,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
c pb stabilizing effort
          if (imo.eq.0) then
             EEXT=EEXT + PHKK(4,I)
          else
             EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
          endif
c pb stabilizing effort
        ENDIF
        IF(ISTHKK(I).EQ.15) THEN
          IMO=JMOHKK(1,I)
          PX=PX + PHKK(1,I)
          PY=PY + PHKK(2,I)
          PZ=PZ + PHKK(3,I)
          PE=PE + PHKK(4,I)
c pb stabilizing effort
          if (imo.eq.0) then
             EEXT=EEXT + PHKK(4,I)
          else
             EEXT=EEXT + PHKK(4,I) - PHKK(4,IMO)
          endif
c pb stabilizing effort
        ENDIF
   10 CONTINUE
      PX=PX + DELPX
      PY=PY + DELPY
      PZ=PZ + DELPZ
      PE=PE + DELPE
      WRITE(6,1000) PX,PY,PZ,PE,EEXT,EEXP,DELPX,DELPY,DELPZ,DELPE
 1000 FORMAT(' CHECKE: PX,PY,PZ,PE,EEXT,EEXP',6F7.3/ 8X,' DELPX/Y/Z/E',4
     +F7.3)
      WRITE(6,'(8X,A,6F8.3)') ' TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA',
     +TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
      IF(IPRI.GT.1) THEN
        IF (ABS(PX).GT.0.004.OR. ABS(PY).GT.0.004.OR. ABS(PZ).GT.0.004.
     +  OR. ABS(PE).GT.0.004) THEN
 
 
          DO 20 I=1,NHKK
            IF(ISTHKK(I).EQ.11) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.12) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
            IF(ISTHKK(I).EQ.1) THEN
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
 1010 FORMAT (I6,I4,5I6,9(1PE10.2))
            ENDIF
            IF(ISTHKK(I).EQ.16) THEN
              IMO=JMOHKK(1,I)
              WRITE(6,1010) I,ISTHKK(I),IDHKK(I),JMOHKK(1,I),JMOHKK
     +        (2,I), JDAHKK(1,I),JDAHKK(2,I),(PHKK(KHKK,I),KHKK=1,5),
     +        (VHKK(KHKK,I),KHKK=1,4)
 
            ENDIF
   20     CONTINUE
        ENDIF
      ENDIF
      RETURN
      END
C######################################################################
C######################################################################
C######################################################################
*
C######################################################################
C######################################################################
C######################################################################
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C######################################################################
C######################################################################
C######################################################################
C######################################################################
C######################################################################
C######################################################################
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      DOUBLE PRECISION FUNCTION EBIND(IA,IZ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C***
C   Binding energy for nuclei with mass number IA
C                              and atomic number IZ
C   from Shirokov & Yudin, Yad. Fizika, Nauka, Moskva 1972
C***
      DATA A1,A2,A3,A4,A5 /0.01575, 0.0178, 0.000710, 0.0237, 0.034/
C
C     WRITE (6,'(A,2I5)')' EBIND IA,IZ ',IA,IZ
      IF(IA.LE.1.OR.IZ.EQ.0)THEN
	EBIND=0
	RETURN
      ENDIF
      AA=IA
      EBIND = A1*AA - A2*AA**0. 666667- A3*IZ*IZ*AA**(-0.333333) - A4
     +*(IA-2*IZ)**2/AA
      IF (MOD(IA,2).EQ.1) THEN
        IA5=0
      ELSEIF (MOD(IZ,2).EQ.1) THEN
        IA5=1
      ELSE
        IA5=-1
      ENDIF
      EBIND=EBIND - IA5*A5*AA**(-0.75)
      RETURN
      END
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE DEFAUL(EPN,PPN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*---set default values for some parameters
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,FACTMO.
      COMMON /FACTMO/ IFACTO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
*KEEP,HADTHR.
      COMMON /HADTHR/ EHADTH,INTHAD
*KEEP,NUCC.
C     COMMON /NUCCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C     COMMON /NUCC/   JT,JTZ,JP,JPZ,JJPROJ,JBPROJ,JJTARG,JBTARG
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /NUCCC/   JT,JTZ,JP,JPZ,JJPROJ,JBPROJ,JJTARG,JBTARG
*KEEP,ZENTRA.
      COMMON /ZENTRA/ ICENTR
*KEEP,CMHICO.
      COMMON /CMHICO/ CMHIS
*KEEP,RESONA.
      COMMON /RESONA/ IRESO
*KEEP,XSEADI.
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA, CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
*KEEP,COULO.
      COMMON/COULO/ICOUL
*KEEP,EDENS.
      COMMON/EDENS/IEDEN
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEND.
       COMMON /RECOM/IRECOM
C---------------------
*---minimum bias interactions
      ICENTR=0
*---threshold for the use of HADRIN in the primary hadron-nucleon collision
      EHADTH=5.
*---lab energy and momentum of the projectile: pion+
      EPN=200.
      IJPROJ=13
      JJPROJ=13
      PPN=SQRT((EPN-AAM(IJPROJ))*(EPN+AAM(IJPROJ)))
      IBPROJ=IIBAR(IJPROJ)
      IP=1
      IPZ=1
      JBPROJ=IIBAR(IJPROJ)
      JP=1
      JPZ=1
*---copper target
      IT=14
      ITZ=7 
      JT=14
      JTZ=7 
*---formation zone intranuclear cascade
      TAUFOR=105.
      KTAUGE=0 
      ITAUVE=1
*---inclusion of Coulomb potential for hA interactions
      ICOUL=1
      ICOULL=1
*---cascade within projectile switched off
      IPROJK=1
*---nucleus independent meson potential
      POTMES=0.002
      TAEPOT(13)=POTMES
      TAEPOT(14)=POTMES
      TAEPOT(15)=POTMES
      TAEPOT(16)=POTMES
      TAEPOT(23)=POTMES
      TAEPOT(24)=POTMES
      TAEPOT(25)=POTMES
*---definition of soft quark distributions
      XSEACU=0.05
      UNON=1.11D0
      UNOM=1.11D0
      UNOSEA=5.0D0
*---cutoff parameters for x-sampling
      CVQ=2.0D0
      CDQ=2.0D0
      CSEA=0.3D0
      SSMIMA=0.90D0
      SSMIMQ=SSMIMA**2
*---
      IRESO=0
      CMHIS=0.D0
      IEDEN=0
      IFACTO=0
C---Chain recombination
C     IRECOM=1
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADHAD(EPN,PPN,NHKKH1,IHTAWW,ITTA,IREJFO)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C*** AT LOW ENERGIES EPN.LE.EHADTH HADRIN IS USED WITH ONE INTERACTION
C*** IN THE NUCLEUS INSTEAD OF THE DUAL PARTON MODEL (GLAUBER CASCADE)
C*** ONLY FOR HADRON-NUCLEUS COLLISIONS!
C
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DFINLS.
      PARAMETER (MAXFIN=10)
      COMMON /DFINLS/ ITRH(MAXFIN),CXRH(MAXFIN),CYRH(MAXFIN), CZRH
     +(MAXFIN),ELRH(MAXFIN),PLRH(MAXFIN),IRH
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEND.
C------------------------------------------------------------------
C     PPN=SQRT((EPN-AAM(IJPROJ))*(EPN+AAM(IJPROJ)))
c     ipaupr=2
c     ipri=3
      IREJFO=0
      IF(IPRI.GE.2) WRITE(6,1001) IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,
     +CCCZP,IHTAWW,ITTA,IELINE
 1001 FORMAT(' HADHAD 1:',
     +' IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,CCCZP,IHTAWW,ITTA,IELINE'/ 2
     +I3,2E12.3,3F7.3,3I4)
      CCCXP=0.
      CCCYP=0.
      CCCZP=1.
      IELINE=0
      CALL SIHNIN(IJPROJ,ITTA,PPN,SIGHT)
      CALL SIHNEL(IJPROJ,ITTA,PPN,SIGHTE)
      SIGTOT=SIGHT + SIGHTE
      IF (SIGTOT*RNDM(BB).LE.SIGHTE)IELINE=1
      IF(IPRI.GE.2) WRITE(6,1000) IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,
     +CCCZP,IHTAWW,ITTA,IELINE
 1000 FORMAT(' HADHAD 2 nach si...:',
     +' IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,CCCZP,IHTAWW,ITTA,IELINE'/ 2
     +I3,2E12.3,3F7.3,3I4)
      IHADHA=0
   12 CONTINUE
      IHADHA=IHADHA+1
      IF(IPRI.GE.2) WRITE(6,1012) IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,
     +CCCZP,IHTAWW,ITTA,IELINE
 1012 FORMAT(' HADHAD 12 loop:',
     +' IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,CCCZP,IHTAWW,ITTA,IELINE'/ 2
     +I3,2E12.3,3F7.3,3I4)
        IF(IPRI.GE.3) THEN
          do 1212 ii=1,irh
          WRITE(6,'(I3,5(1PE12.4),I5/3X,5(1PE12.4))') II,ELRH(II),PLRH
     +    (II),CXRH(II),CYRH(II),CZRH(II),ITRH(II), (PHKK(JJJ,NHKK),JJJ
     +    =1,5)
 1212     continue
        ENDIF
*   repeated entry if Pauli blocking was active
      CALL FHAD(IJPROJ,IJPROJ,PPN,EPN,CCCXP,CCCYP,CCCZP, IHTAWW,ITTA,
     +IELINE,IREJFH)
            IF(IREJFH.EQ.1)THEN
              IREJFO=1
        IF(IPRI.GE.3) 
     + WRITE(6,'(A)')'  exit from hadhad with irejfo=1 '
              RETURN
            ENDIF
*
*   require Pauli blocking for final state nucleons
*
      IF (IHADHA.LT.3)THEN
        DO 11 II=1,IRH
          ITSEC=ITRH(II)
          IF(ITSEC.EQ.1.AND.ELRH(II).LE.TAEFEP+AAM(ITSEC))     GOTO 12
          IF(ITSEC.EQ.8.AND.ELRH(II).LE.TAEFEN+AAM(ITSEC))     GOTO 12
          IF(IIBAR(ITSEC).NE.1.AND.ELRH(II)-AAM(ITSEC)
     +                                   .LE.TAEPOT(ITSEC))  GOTO 12
   11   CONTINUE
      ENDIF
      NHKKH1=NHKK
C
      IF (IPRI.GE.2) WRITE (6,1010)IRH,NHKKH1,IHTAWW,ITTA
 1010 FORMAT (' HADHAD IRH,NHKKH1,IHTAWW,ITTA = ',4I5)
C
      IF(IPRI.GE.3) THEN
        WRITE(6,'(A/5X,A)')
     +  ' HADHAD - PARTICLE TRANSFER FROM /FINLSP/ INTO /HKKEVT/',
     +  ' II, ELRH, PLRH, CXRH, CYRH, CZRH / PHKK(1-5)'
      ENDIF
C
      ISTHKK(1)=11
      DO 10 II=1,IRH
C       IF( (ITSEC.EQ.1.AND.ELRH(II).GE.TAEFEP+AAM(ITSEC)) .OR.
C    +      (ITSEC.EQ.8.AND.ELRH(II).GE.TAEFEN+AAM(ITSEC)) )THEN
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)') ' HADHAD:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          ITSEC=ITRH(II)
          IDHKK(NHKK)=MPDGHA(ITSEC)
          JMOHKK(1,NHKK)=1
          JMOHKK(2,NHKK)=IHTAWW
          JDAHKK(1,NHKK)=0
          JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=PLRH(II)*CXRH(II)
        PHKK(2,NHKK)=PLRH(II)*CYRH(II)
        PHKK(3,NHKK)=PLRH(II)*CZRH(II)
        PHKK(4,NHKK)=ELRH(II)
        IF(PHKK(4,NHKK)-AAM(ITSEC).LE.TAEPOT(ITSEC).
     +                                    AND.IIBAR(ITSEC).EQ.1)THEN
          ISTHKK(NHKK)=16
        ELSE
          ISTHKK(NHKK)=1
        ENDIF
        PHKK(5,NHKK)=AAM(ITRH(II))
C
        IF(IPRI.GE.3) THEN
          WRITE(6,'(I3,5(1PE12.4),I5/3X,5(1PE12.4),I5)') 
     +                    II,ELRH(II),PLRH
     +    (II),CXRH(II),CYRH(II),CZRH(II),ITRH(II), (PHKK(JJJ,NHKK),JJJ
     +    =1,5),IREJFO
        ENDIF
        VHKK(1,NHKK)=VHKK(1,IHTAWW)
        VHKK(2,NHKK)=VHKK(2,IHTAWW)
        VHKK(3,NHKK)=VHKK(3,IHTAWW)
        VHKK(4,NHKK)=VHKK(4,1)
C       ENDIF
   10 CONTINUE
      JDAHKK(1,1)=NHKKH1+1
      JDAHKK(2,1)=NHKK
      JDAHKK(1,IHTAWW)=NHKKH1+1
      JDAHKK(2,IHTAWW)=NHKK
c     ipaupr=0
c     ipri=0
        IF(IPRI.GE.3) 
     + WRITE(6,'(A)')'  exit from hadhad with irejfo=0 '
      RETURN
      END
      SUBROUTINE CHEBCH(IREJ,NHKKH1)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      COMMON /CHABAI/CHARGI,BARNUI
      COMMON /EVAPPP/IEVAP
C-----------------------------------------------------------------------
      DATA IEVL /0/
C----------------------------------------------------------------------
      ZERO=0
      ONEONE=1
      TWOTWO=2
      NHAD=0
      NIP=IP
      AIP=IP
      IEVL=IEVL+1
      CHAEVE=0.
      BAEVE=0.
      IF(IEVAP.EQ.0)THEN
      DO 1171 I=1,NHKKH1
        IF (ISTHKK(I).EQ.13)THEN
          BAEVE=BAEVE+1
	  IF(IDHKK(I).EQ.2212)CHAEVE=CHAEVE+1.D0
        ENDIF
        IF (ISTHKK(I).EQ.14)THEN
          BAEVE=BAEVE+1
	  IF(IDHKK(I).EQ.2212)CHAEVE=CHAEVE+1.D0
        ENDIF
 1171 CONTINUE
      DO 521 I=NHKKH1,NHKK
        IF (ISTHKK(I).EQ.1.OR.ISTHKK(I).EQ.15.OR.ISTHKK(I).EQ.16)THEN
          NHAD=NHAD+1
          NRHKK=MCIHAD(IDHKK(I))
          IF (NRHKK.LE.0.OR.NRHKK.GT.410)THEN
            WRITE(6,1389)NRHKK,I,IDHKK(I),NHKKH1,NHKK
 1389       FORMAT (' distr: NRHKK ERROR ',5I10)
            NRHKK=1
          ENDIF
          ICHHKK=IICH(NRHKK)
          IBHKK=IIBAR(NRHKK)
	  CHAEVE=CHAEVE+ICHHKK
          BAEVE=BAEVE+IBHKK
        ENDIF
  521 CONTINUE
      ELSEIF(IEVAP.EQ.1)THEN
      DO 1521 I=1,NHKK
        IF (ISTHKK(I).EQ.1)THEN
          NRHKK=MCIHAD(IDHKK(I))
          ICHHKK=IICH(NRHKK)
          IBHKK=IIBAR(NRHKK)
	  CHAEVE=CHAEVE+ICHHKK
          BAEVE=BAEVE+IBHKK
	ENDIF
 1521 CONTINUE
C     WRITE(6,'(A,2F12.1)')' after isthkk=1 ',CHAEVE,BAEVE
      DO 2521 I=1,NHKK
        IF (ISTHKK(I).EQ.-1)THEN
	  IF(IDHKK(I).EQ.2112)THEN
            BAEVE=BAEVE+1
C	    WRITE(6,'(A,2F12.1)')' evap isthkk=-1',CHAEVE,BAEVE
	  ENDIF
	  IF(IDHKK(I).EQ.2212)THEN
	    CHAEVE=CHAEVE+1
            BAEVE=BAEVE+1
C	    WRITE(6,'(A,2F12.1)')' evap isthkk=-1',CHAEVE,BAEVE
	  ENDIF
	ENDIF
	IF((IDHKK(I).EQ.80000).AND.(ISTHKK(I).NE.1000))THEN
	  CHAEVE=CHAEVE+IDXRES(I)
	  BAEVE=BAEVE+IDRES(I)
C     WRITE(6,'(A,2F12.1,2I5)')' h.f.',CHAEVE,BAEVE,IDXRES(I),IDRES(I)
	ENDIF
 2521 CONTINUE
      ENDIF
      IF(IEVL.LE.-10)WRITE(6,'(2A,4F10.2)')' Event charge and B-number',
     * '=',CHAEVE,BAEVE,CHARGI,BARNUI
      IF(CHAEVE-CHARGI.NE.0.D0.OR.BAEVE-BARNUI.NE.0.D0)THEN
C     DO 775 JJJ=1,200
      IF(IEVL.LE.-1000)WRITE(6,'(2A,4F10.2)')'Event charge and B-numb',
     *'(violated)  =',CHAEVE,BAEVE,CHARGI,BARNUI
C 775 CONTINUE
      IREJ=1
      ENDIF
      RETURN
      END 
C****************************************************************
C
      SUBROUTINE PARPT(IFL,PT1,PT2,IPT,NEVT)
C                          Plot parton pt distribution
C 
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      DIMENSION PT(50,10),YPT(50,10)
      GO TO (1,2,3),IFL
 1    CONTINUE
      DPT=0.1
      DO 10 I=1,10
        DO 10 J=1,50
          PT(J,I)=J*DPT-DPT/2.
          YPT(J,I)=1.D-50
 10   CONTINUE
      RETURN
 2    CONTINUE
      IPT1=PT1/DPT+1.
      IPT2=PT2/DPT+1.
      IF(IPT1.GT.50)IPT1=50
      IF(IPT2.GT.50)IPT2=50
      YPT(IPT1,IPT)=YPT(IPT1,IPT)+1.
      YPT(IPT2,IPT)=YPT(IPT2,IPT)+1.
      YPT(IPT1,10)=YPT(IPT1,10)+1.
      YPT(IPT2,10)=YPT(IPT2,10)+1.
      RETURN
 3    CONTINUE
      DO 30 I=1,10
        DO 30 J=1,50
          YPT(J,I)=YPT(J,I)/NEVT
          YPT(J,I)=LOG10(YPT(J,I)+1.D-18)
 30   CONTINUE
C     WRITE(6,*)' Parton pt distribution,vv=1,vsr=+2,sv=3,ss=4,zz=5,
C    *  hh=6,10=all'
C     CALL PLOT(PT,YPT,500,10,50,0.D0,DPT,-5.D0,0.1D0)
      RETURN
      END
*
*
*
*===hkkfil=============================================================*
*
      SUBROUTINE HKKFIL(IST,ID,M1,M2,PX,PY,PZ,E,NHKKAU,KORMO)

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY10=1.0D-10,TINY4=1.0D-3)

*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
      COMMON /NNCMS/  GACMS,BGCMS,UMO,PCM,EPROJ,PPROJ
      COMMON /TRAFOP/GALAB,BGLAB,BLAB
      COMMON /PROJK/ IPROJK

C     IF (MODE.GT.100) THEN
C        WRITE(LOUT,'(1X,A,I5,A,I5)')
C    &        'HKKFIL: reset NHKK = ',NHKK,' to NHKK =',NHKK-MODE+100
C        NHKK = NHKK-MODE+100
C        RETURN
C     ENDIF
      MO1  = M1
      MO2  = M2
      NHKK = NHKK+1
      IF (NHKK.GT.NMXHKK) THEN
         WRITE(LOUT,1000) NHKK
 1000    FORMAT(1X,'HKKFIL: NHKK exeeds NMXHKK = ',I7,
     &             '! program execution stopped..')
         STOP
      ENDIF
      IF (M1.LT.0) MO1 = NHKK+M1
      IF (M2.LT.0) MO2 = NHKK+M2
      ISTHKK(NHKK)   = IST
      IDHKK(NHKK)    = ID
      IF(KORMO.EQ.999)THEN
        JMOHKK(1,NHKK) = MO1
        JMOHKK(2,NHKK) = MO2
      ELSE
        JMOHKK(1,NHKK)=NHKKAU+KORMO-1
        JMOHKK(2,NHKK)=0
      ENDIF
      JDAHKK(1,NHKK) = 0
      JDAHKK(2,NHKK) = 0
      IF (MO1.GT.0) THEN
         IF (JDAHKK(1,MO1).NE.0) THEN
            JDAHKK(2,MO1) = NHKK
         ELSE
            JDAHKK(1,MO1) = NHKK
         ENDIF
	 JDAHKK(1,MO1)=NHKKAU
      ENDIF
      IF (MO2.GT.0) THEN
         IF (JDAHKK(1,MO2).NE.0) THEN
            JDAHKK(2,MO2) = NHKK
         ELSE
            JDAHKK(1,MO2) = NHKK
         ENDIF
         JDAHKK(1,MO2) = NHKKAU
      ENDIF
      PHKK(1,NHKK) = PX
      PHKK(2,NHKK) = PY
      PHKK(3,NHKK) = PZ
      PHKK(4,NHKK) = E
      PHKK(5,NHKK) = PHKK(4,NHKK)**2-PHKK(1,NHKK)**2-
     &               PHKK(2,NHKK)**2-PHKK(3,NHKK)**2
      IF ((PHKK(5,NHKK).LT.0.0D0).AND.(ABS(PHKK(5,NHKK)).GT.TINY4))
     &   WRITE(LOUT,'(1X,A,G10.3)')
     &     'HKKFIL: negative mass**2 ',PHKK(5,NHKK)
      PHKK(5,NHKK) = SQRT(ABS(PHKK(5,NHKK)))
      IF (IST.EQ.88888.OR.IST.EQ.88887.OR.IST.EQ.88889) THEN
* special treatment for chains:
*    position of chain in Lab      = pos. of target nucleon
*    time of chain-creation in Lab = time of passage of projectile
*                                    nucleus at pos. of taget nucleus
         DO 1 I=1,3
            VHKK(I,NHKK) = VHKK(I,MO2)
    1    CONTINUE
         VHKK(4,NHKK) = VHKK(3,MO2)/BLAB-VHKK(3,MO1)/BGLAB
      ELSE
         IF(MO1.GE.1)THEN
         DO 2 I=1,4
            VHKK(I,NHKK) = VHKK(I,MO1)
            IF (IPROJK.EQ.1) THEN
              WHKK(I,NHKK) = WHKK(I,MO1)
	    ENDIF
    2    CONTINUE
         ENDIF
      ENDIF

      RETURN
      END

C*********************************************************************
C*********************************************************************

      SUBROUTINE JSPARR
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      INTEGER PYCOMP

C...Purpose: to give program heading, or list an event, or particle
C...data, or current parameter values.
      COMMON/PYJETS/N,NPAD,K(4000,5),P(4000,5),V(4000,5)
      COMMON/PYDAT1/MSTU(200),PARU(200),MSTJ(200),PARJ(200)
      COMMON/PYDAT2/KCHG(500,4),PMAS(500,4),PARF(2000),VCKM(4,4)
      COMMON/PYDAT3/MDCY(500,3),MDME(4000,2),BRAT(4000),KFDP(4000,5)
ctp060123       SAVE /PYJETS/,/PYDAT1/,/PYDAT2/,/PYDAT3/
      CHARACTER CHAP*16,CHAN*16,CHAD(5)*16
      DIMENSION	  KBAMDP(5)

C...List parton/particle data table. Check whether to be listed.
        WRITE(MSTU(11),6800)
        MSTJ24=MSTJ(24)
        MSTJ(24)=0
        KFMAX=20883
        IF(MSTU(2).NE.0) KFMAX=MSTU(2)
C                               KF = PDG Particle number
        DO 220 KF=100,KFMAX
C                               KC = Lund particle number
        KC=PYCOMP(KF)
        IF(KC.EQ.0) GOTO 220
        IF(MSTU(14).EQ.0.AND.KF.GT.100.AND.KC.LE.100) GOTO 220
        IF(MSTU(14).GT.0.AND.KF.GT.100.AND.MAX(MOD(KF/1000,10),
     &  MOD(KF/100,10)).GT.MSTU(14)) GOTO 220
C                          BAMJET particle number
	KBAM=MCIHAD(KF)
C                          BAMJET  antiparticle number
	KABAM=MCIHAD(-KF)

C...Find  Lund particle name and mass. Print information.
        CALL PYNAME(KF,CHAP)
        IF(KF.LE.100.AND.CHAP.EQ.' '.AND.MDCY(KC,2).EQ.0) GOTO 220
C                          Lund Antiparticle Name
        CALL PYNAME(-KF,CHAN)
        PM=PYMASS(KF)
	IDC1=MDCY(KC,2)
	IDC2=MDCY(KC,2)+MDCY(KC,3)-1
        WRITE(MSTU(11),6900)KBAM,
     &	KF,KC,IDC1,IDC2,CHAP,CHAN,KCHG(KC,1),KCHG(KC,2),
     &  KCHG(KC,3),PM,PMAS(KC,2),PMAS(KC,3),PMAS(KC,4),MDCY(KC,1)
        WRITE(26,6900)KBAM,
     &	KF,KC,IDC1,IDC2,CHAP,CHAN,KCHG(KC,1),KCHG(KC,2),
     &  KCHG(KC,3),PM,PMAS(KC,2),PMAS(KC,3),PMAS(KC,4),MDCY(KC,1)

C...Particle decay: channel number, branching ration, matrix element,
C...decay products.
        IF(KF.GT.100.AND.KC.LE.100) GOTO 220
        DO 210 IDC=MDCY(KC,2),MDCY(KC,2)+MDCY(KC,3)-1
        DO 200 J=1,5
C                         Lund names of decay products
          CALL PYNAME(KFDP(IDC,J),CHAD(J))
C                         Bamjet numbers of decay products
	  KBAMDP(J)=MCIHAD(KFDP(IDC,J))
	  IF(KBAMDP(J).EQ.26)KBAMDP(J)=0
  200   CONTINUE
        WRITE(26,7001) IDC,MDME(IDC,1),MDME(IDC,2),BRAT(IDC),
     &  (KBAMDP(J),J=1,5)
  210   WRITE(MSTU(11),7000) IDC,MDME(IDC,1),MDME(IDC,2),BRAT(IDC),
     &  (CHAD(J),J=1,5)
C              The same for the antiparticle, if it exists
	IF(KABAM.NE.410)THEN
        WRITE(MSTU(11),6900)KABAM,
     &	-KF,-KC,IDC1,IDC2,CHAN,CHAP,-KCHG(KC,1),KCHG(KC,2),
     &  KCHG(KC,3),PM,PMAS(KC,2),PMAS(KC,3),PMAS(KC,4),MDCY(KC,1)
        WRITE(26,6900)KABAM,
     &	-KF,-KC,IDC1,IDC2,CHAN,CHAP,-KCHG(KC,1),KCHG(KC,2),
     &  KCHG(KC,3),PM,PMAS(KC,2),PMAS(KC,3),PMAS(KC,4),MDCY(KC,1)
        DO 211 IDC=MDCY(KC,2),MDCY(KC,2)+MDCY(KC,3)-1
        DO 201 J=1,5
C                               KC = Lund particle number
        KCDP=PYCOMP(KFDP(IDC,J))
	IF(KCDP.LE.0.OR.KCDP.GT.500)THEN
C      	WRITE(MSTU(11),'(A,I10)')' KCDP= ',KCDP
	KCDP=1
	ENDIF
C                         Bamjet numbers of decay products
	  KFDPM=-KFDP(IDC,J)
	  IF(KCHG(KCDP,3).EQ.0)KFDPM=KFDP(IDC,J)
	  KBAMDP(J)=MCIHAD(KFDPM)
	  IF(KBAMDP(J).EQ.26)KBAMDP(J)=0
C                         Lund names of decay products
          CALL PYNAME(KFDPM,CHAD(J))
  201   CONTINUE
        WRITE(26,7001) IDC,MDME(IDC,1),MDME(IDC,2),BRAT(IDC),
     &  (KBAMDP(J),J=1,5)
  211   WRITE(MSTU(11),7000) IDC,MDME(IDC,1),MDME(IDC,2),BRAT(IDC),
     &  (CHAD(J),J=1,5)
	ENDIF
  220   CONTINUE
        MSTJ(24)=MSTJ24


C...Format statements for output on unit MSTU(11) (by default 6).
 6800 FORMAT(///30X,'Particle/parton data table'//1X,'BAM',
     &1X,'ABAM',1X,'KF',1X,'KC',1X,'DCF',1X,'DCL',1X,
     &'particle',8X,'antiparticle',6X,'chg  col  anti',8X,'mass',7X,
     &'width',7X,'w-cut',5X,'lifetime',1X,'decay'/11X,'IDC',1X,'on/off',
     &1X,'ME',3X,'Br.rat.',4X,'decay products')
 6900 FORMAT(/1X,I4,I6,I4,2I5,A16,A16,3I3,1X,F12.5,2(1X,F11.5),
     &1X,F12.5,1X,I2)
 7000 FORMAT(10X,I4,2X,I3,2X,I3,2X,F8.5,4X,5A16)
 7001 FORMAT(10X,I4,2X,I3,2X,I3,2X,F8.5,4X,5I5)

      RETURN
      END

C*********************************************************************

C----------------------------------------------------------------------
C
C    FILE DPMNUC2.FOR
C
C----------------------------------------------------------------------
*
      SUBROUTINE PRIMPT(MPO,ECM)
C
C  SELECT PRIMORDIAL PT FOR HARD SCATTERED PARTONS
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      PARAMETER(MSH=250)
      COMMON /ABRHRD/XH1(MSH),XH2(MSH),IJHI1(MSH),IJHI2(MSH),
     *IJHF1(MSH),IJHF2(MSH),PHARD1(MSH,4),PHARD2(MSH,4)
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      B33=4.0+3.0/LOG10(ECM+10.D0)
      DO 20 I=1,MPO
        ES=-2./(B33**2)*LOG(RNDM(V)*RNDM(U))
        HPS=SQRT(ES*ES+2.*ES*0.94)
        CALL DSFECF(SFE,CFE)
        PTXSQ1=HPS*CFE
        PTYSQ1=HPS*SFE
        PTXSA1=-PTXSQ1
        PTYSA1=-PTYSQ1
        IF (IOUXEV.GE.6)WRITE(6,115)PTXSQ1,PTYSQ1,PTXSA1,PTYSA1
  115   FORMAT (' PT S  ',8F12.6)
        PHARD1(I,1)=PHARD1(I,1)+PTXSQ1
        PHARD1(I,2)=PHARD1(I,2)+PTYSQ1
        PHARD2(I,1)=PHARD2(I,1)+PTXSA1
        PHARD2(I,2)=PHARD2(I,2)+PTYSA1
        DE1=SQRT(PHARD1(I,1)**2+PHARD1(I,2)**2+PHARD1(I,3)**2)
     *                                        -PHARD1(I,4)
        DE2=SQRT(PHARD2(I,1)**2+PHARD2(I,2)**2+PHARD2(I,3)**2)
     *                                        -PHARD2(I,4)
        PHARD1(I,4)=PHARD1(I,4)+DE1
        PHARD2(I,4)=PHARD2(I,4)+DE2
        DX1=2.*DE1/ECM
        DX2=2.*DE2/ECM
        XH1(I)=XH1(I)+DX1
        XH2(I)=XH2(I)+DX2
   20 CONTINUE
      RETURN
      END

C______________________________________________________________________
C
C****************************************************************8**
      SUBROUTINE SELPTH(PQUAR,PAQUAR,TQUAR,TAQUAR,ECM,
     *                 PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     *                 PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     *                 AMCH1,AMCH2,IREJ,IKVALA,pttq1,ptta1,pttq2,ptta2)
C  SELECT PT VALUES FOR A TWO CHAIN SYSTEM
C                            SELECT SEA QUARK AND ANTIQUARK PT-VALUES
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      DIMENSION PQUAR(4),TQUAR(4),PAQUAR(4),TAQUAR(4)
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
        B33=1.55
      B33=4.0+3.0/LOG10(ECM+10.D0)
        IF (IKVALA.EQ.1)B33=8.0
        ICOUNT=0
        IREJ=0
    1   CONTINUE
        B33=2.*B33
        ICOUNT=ICOUNT+1
        IF (ICOUNT.EQ.4)THEN
          IREJ=1
C                            REJECT EVENT
          RETURN
        ENDIF
        ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+1.E-18)
        HPS=SQRT(ES*ES+2.*ES*0.94)
        CALL DSFECF(SFE,CFE)
        PTXSQ1=HPS*CFE+PQUAR(1)
        PTYSQ1=HPS*SFE+PQUAR(2)
        PTXSA1=-PTXSQ1+PAQUAR(1)
        PTYSA1=-PTYSQ1+PAQUAR(2)
        ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+1.E-18)
        HPS=SQRT(ES*ES+2.*ES*0.94)
        CALL DSFECF(SFE,CFE)
        PTXSQ2=HPS*CFE+TQUAR(1)
        PTYSQ2=HPS*SFE+TQUAR(2)
        PTXSA2=-PTXSQ2+TAQUAR(1)
        PTYSA2=-PTYSQ2+TAQUAR(2)
        IF (IOUXEV.GE.6)WRITE(6,115)PTXSQ1,PTYSQ1,PTXSA1,PTYSA1
     *                             ,PTXSQ2,PTYSQ2,PTXSA2,PTYSA2
  115   FORMAT (' PT S  ',8F12.6)
C                           KINEMATICS OF THE TWO CHAINS Q1-AQ2,AQ1-Q2
        PTTQ1=PTXSQ1**2+PTYSQ1**2
        PTTA1=PTXSA1**2+PTYSA1**2
        PTTQ2=PTXSQ2**2+PTYSQ2**2
        PTTA2=PTXSA2**2+PTYSA2**2
        EQ1=PQUAR(4)
        EAQ1=PAQUAR(4)
        EQ2=TQUAR(4)
        EAQ2=TAQUAR(4)
        IF((EQ1**2.LE.PTTQ1).OR.(EQ2**2.LE.PTTQ2)
     *           .OR.(EAQ1**2.LE.PTTA1).OR.(EAQ2**2.LE.PTTA2))THEN
          GO TO 1
        ENDIF
        PLQ1=SQRT(EQ1**2-PTTQ1+1.E-6)*PQUAR(3)/ABS(PQUAR(3))
        PLQ2=SQRT(EQ2**2-PTTQ2+1.E-6)*TQUAR(3)/ABS(TQUAR(3))
        PLAQ1=SQRT(EAQ1**2-PTTA1+1.E-6)*PAQUAR(3)/ABS(PAQUAR(3))
C                          CHAIN 1: Q1-AQ2     CHAIN2:  AQ1-Q2
        PLAQ2=SQRT(EAQ2**2-PTTA2+1.E-6)*TAQUAR(3)/ABS(TAQUAR(3))
      AMCH1=SQRT(MAX(0D0,((EQ1+EAQ2)+(PLQ1+PLAQ2))*((EQ1+EAQ2)-(PL
     * Q1+PLAQ2))-(PTYSQ1+PTYSA2)**2-(PTXSQ1+PTXSA2)**2))
      AMCH2=SQRT(MAX(0D0,((EQ2+EAQ1)+(PLQ2+PLAQ1))*((EQ2+EAQ1)-(PL
     * Q2+PLAQ1))-(PTYSQ2+PTYSA1)**2-(PTXSQ2+PTXSA1)**2))
        RETURN
        END
C
C****************************************************************8**
      SUBROUTINE XPTFL(NHARD,NSEA,IREG,XMAX1,XMAX2)
C  PARTON LEVEL COLLISION EVENTS (X,PT FLAVOR)
C  THE ROUTINE XPTFL CALLS ONE EVENT (in DTUJET)
C  in DTUNUC, DPMJET it calls the multiple soft and hard chains
C   in one elementary collision 
C
C   IJPROJ,IJTAR: PROJECTILE AND TARGET PARTICLE OF THE REACTION
C                 1=PROTON,  2=ANTIPROTON
C   IJPVAL,IJTVAL =0 VALENCE QUARKS OF PROJECTILE OR TARGET NOT INVOLVED
C                                                     IN HARD SCATTERING
C   IJPVAL,IJTVAL =1 VALENCE QUARKS OF PROJECTILE OR TARGET  INVOLVED
C                                                     IN HARD SCATTERING
C
C   PARTEV VERSIONS CONTROLLED BY NVERS
C              NVERS=1: ALL HARD PARTONS CONSIDERED TO BE GLUONS
C                       soft x values by rejection
C              NVERS=2: ALL HARD PARTONS CONSIDERED TO BE GLUONS
C                       soft x values by P.Aurenche P.Maire method
C
C THE RESULTS (HARD SCATTERING) ARE IN COMMON /ABRHRD/
C               XH1(I),XH2(I):     X-VALUES OF INITIAL PARTONS
C               IJHI1(I),IJHI2(I): FLAVOR OF INITIAL PARTON
C                                  0            GLUON
C                                  1,2          VALENCE U,D QUARKS
C                                  11,12,13,14  SEA UDSC-QUARKS
C                                  NEGATIVE     ANTI S OR V QUARKS
C               IJHF1(I),IJHF2(I): FLAVOR OF FINAL STATE PARTONS
C               PHARD1(I,J),PHARD2(I,J): FINAL PART. MOMENTUM AND ENERGY
C                                J=1   PX
C                                 =2   PY
C                                 =3   PZ
C                                 =4   ENERGY  (MASSLESS PARTONS)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      PARAMETER ( ONE=1.D0,ONEH=.5D0, ZERO=0.D0)
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      PARAMETER(MSH=250)
      COMMON /ABRHRD/XH1(MSH),XH2(MSH),IJHI1(MSH),IJHI2(MSH),
     *IJHF1(MSH),IJHF2(MSH),PHARD1(MSH,4),PHARD2(MSH,4)
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
c     addded as needed:
      COMMON /SINGDI/SILMSD,SIGDI
C repl:COMMON/DIFFRA/ISINGD,IDUBLD,SDFRAC
C repl:COMMON /COLLIS/ECM,S,IJPROJ,IJTAR,PTTHR,IOPHRD,IJPRLU,IJTALU,PTTHR2
C     COMMON /COLLIS/S,IJPROJ,IJTAR,PTTHR,IOPHRD,IJPRLU,IJTALU,PTTHR2
      COMMON/COLLIS/S,IJPROJ,IJTAR,PTTHR,PTTHR2,IOPHRD,IJPRLU,IJTALU
      CHARACTER*80 TITLE
      CHARACTER*8 PROJTY,TARGTY
C     COMMON /USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    &            ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
*
      COMMON /COLLE/ NEVHAD,NVERS,IHADRZ,NFILE
      COMMON /POMTYP/IPIM,ICON,ISIG,LMAX,MMAX,NMAX,DEFEL,DIFNU
      common/IPIMM/IPIMO
C-------------------------------------------------------------

      PARAMETER (INTMX=2488)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
C-------------------------------------------------------------
C     COMMON /SVSWAP/ISVSWP,ISVSWT,JSVSWP,JSVSWT,XPSVSW,XTSVSW
      COMMON /VALHVG/PHPVAL(4),PHTVAL(4),IJVGP,IJVGT,IVALHP,IVALHT
      COMMON /PTLARG/ XSMAX
      COMMON /GLUSPL/NUGLUU,NSGLUU
      COMMON /SEASU3/SEASQ
      COMMON/VVDIFF/NVALCH,NVALDI,NSOFVD,IDIFTP,AMCHDD,NVADUD
      COMMON/INTNEZ/NDZ,NZD
C
C  THE COMMON BLOCK /PART/ DEFINES THE PARTICLE PROPERTIES AS USED IN
C  BAMJET AND DECAY
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
C  THE COMMON BLOCK /INPDAT/ DEFINES QUANTITIES NEEDED IN THE BAMJET
C  CHAIN DECAY CODE
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
      COMMON /LMMAXI/ LMMAX
      PARAMETER (NSTRMX=50)
      COMMON/SKINE1/NGLUEF,NNN,GL(NSTRMX),GR(NSTRMX),VL,VR,WL,WR,
     *              PTGL(2,NSTRMX),PTVL(2),PTWL(2),
     *              PTGR(2,NSTRMX),PTVR(2),PTWR(2)
      COMMON /DROPJJ/DROPJT,DROPVA
C     COMMON /XYTES/XTEST(50),XYTEST(0:11,50)
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,KPROJ,IBPROJ,IJTARG,IBTARG
      DATA NCMPO/0/
      DATA INICHA/0/
C     COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      IF(XMAX1.LE.0.D0.OR.XMAX2.LE.0.D0)THEN
      WRITE(6,'(A,3I5,2F10.4)')' XPTFL(',NHARD,NSEA,IREG,XMAX1,XMAX2
	NHARD=0
	NSEA=0
	IREG=0
	RETURN
      ENDIF
      IJPVAL=0
      IJTVAL=0
      NONUJ1=NONUJT+1
      NONUS1=NONUST+1
      IREG=0
      IOUXEV=IPEV
      IOUTPA=IPPA
      IOPTPO=IPRI
      IOUCOl=IPCO
C     NDZ=0
C     NZD=0
C     to keep identical commons
      ECM=CMENER
C----------------------------------------------------------------------
C----------------------------------------------------------------------
C----------------------------------------------------------------------
C                     Initialize Charm selection at hard chain ends
C
C     IF(INICHA.EQ.0)THEN
C       INICHA=1
C      IPEV=1
      IF(INICH1.EQ.0)THEN
        SEASQ=0.5D0
        INICH1=1
        PCC1=0.333*(UMMM/(CMMM*LOG(CMMM/0.2)))**2
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PCCC=PCC1*CHAFAC
C        J.R. 2.9.07      
        IF(IPEV.GE.1)WRITE(6,4567)PCCC
 4567   FORMAT(' Charm at hard chain ends XPTFL: PCCC ',1F10.5)
      ENDIF
C
C----------------------------------------------------------------------
*
      ZXC=5000.
C  CALL NSOFT-NHARD EVENT
      NHARD=0
      NSEA=0
      NVAL=0
      IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,NSEA,NVAL,NVERS
  107 FORMAT ('  XPTFL  IOUXEV,NHARD,NSEA,NVAL,NVERS = ',6I10)
      NC1000=0
 1000 CONTINUE
      DROPVA=0.
      NC1000=NC1000+1
      IF (IOUXEV.GE.1.AND.MOD(NC1000,20).EQ.0)WRITE(6,1100)NC1000
 1100 FORMAT(' REJECTION IN XPTFL ',I10)
      NNPO=0
      IF (IPIM.NE.2)THEN
        CALL SAMPLM(LPO,MPO,NPO)
        NPOLO=0
        NPODD=0
      ELSEIF(IPIM.EQ.2)THEN
      IF (IOUXEV.GE.6)WRITE(6,'(A)')' XPTFL call SAMPLX'

        CALL SAMPLX(LPO,MPO,NPO,NPODD,NPOLO)
        NCMPO=NCMPO+MPO
C       WRITE(6,*) ' NCMPO,MPO', NCMPO,MPO
      ENDIF
C     EACH HARD SCATTERING ALSO GETS SOFT COLOR MIXUP
      LPO = LPO + MPO
      IF (IOUXEV.GE.6)WRITE(6,107)IOUXEV,NHARD,NSEA,NVAL,NVERS
      NHARD=MPO
      IF (IOUXEV.GE.1)WRITE(6,101)LPO,MPO,NPO ,NNPO
  101 FORMAT (' XPTFL SAMPLM-LPO,MPO,NPO,NNPO= ',4I10
     *          /' NEXT CALL SELHRD')
C  CALL HARD PARTON EVENT
      NAX12=0
 2628   CONTINUE
      HAX1=0.
      HAXX1=0.
      HAX2=0.
      HAXX2=0.
 7717 CONTINUE
      IF(MPO.GE.1)THEN
      IF (IOUXEV.GE.6)WRITE(6,'(A)')' XPTFL call SELHRD'
        CALL SELHRD(MPO,IJPVAL,IJTVAL,PTTHR2)
        NHARD = MPO
 7727   CONTINUE
        IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,NSEA,NVAL,NVERS
        DO 10 I=1,MPO
          HAX1=HAX1+XH1(I)
          HAX2=HAX2+XH2(I)
          IF(IOUXEV.GE.1.AND.XH1(I).LT.0 )WRITE(6,7788) I,XH1(I)
          IF(IOUXEV.GE.1.AND.XH2(I).LT.0 )WRITE(6,7787) I,XH2(I)
 7788     FORMAT(' XPTFL: XH1(',I5,') =',E12.5)
 7787     FORMAT(' XPTFL: XH2(',I5,') =',E12.5)
   10   CONTINUE
      ENDIF
      SOXM=0.
      SOX1=XMAX1-HAX1
      SOX2=XMAX2-HAX2
      IF (SOX1.LT.SOXM .OR. SOX2.LT.SOXM)THEN
        IF (IOUTPA.GE.1)WRITE (6,2510)HAX1,HAX2,XMAX1,XMAX2,MPO
 2510   FORMAT(' REJECT HAX1,HAX2.GT.1 HAX1,HAX2,XMAX1,XMAX2MPO='
     *         ,4F10.3,I10)
        NAX12=NAX12+1
        IF(MOD(NAX12,2).EQ.0)THEN
          GO TO 1000
        ELSE
          GO TO 2628
        ENDIF
      ENDIF
      NC1002=0
      GO TO 1002
 1001 CONTINUE
C     NDZ=0
C     NZD=0
      IF (LPO.GT.1) THEN
        IF(MOD(NC1002,6).EQ.0) THEN
          LPO=LPO-1
        ELSEIF( NC1002.GT.50 ) THEN
          IF(IOUXEV.GE.3)WRITE(6,9874) MPO
 9874     FORMAT(' XPTFL: 1001 SOFT X REJECTION TO 1000, MPO=',I5)
          GO TO 1000
        ENDIF
        NC1002=NC1002 + 1
      ENDIF
 1002 CONTINUE
      SOXUS1=0
      SOXUS2=0
      IF (IOUXEV.GE.3)WRITE (6,105)SOXUS1,SOXUS2,SOX1,SOX2,HAX1,HAX2
  105     FORMAT('XPTFL SOXUS1,SOXUS2,SOX1,SOX2,HAX1,HAX2 ',6F10.6)
      NHARD=MPO
      LPASOF=0
      IF (LPO.GT.1)THEN
        IF (NVERS.EQ.1) THEN
          UNOGLU=5.
          UNOVAL=2.
      IF (IOUXEV.GE.6)WRITE(6,*)' XPTFL call XPTFL1,NSEA,NVAL',NSEA,NVAL
          CALL XPTFL1(NHARD,NSEA,NVAL,SOXUS1,SOXUS2,SOX1,SOX2,HAX1,HAX2,
     *          LPO,MPO,NPO,LPASOF,IJPVAL,IJTVAL,RJ1000,XMAX1,XMAX2)
          IF (RJ1000.EQ.1.D0) THEN
           IF (IOUXEV.GE.6) THEN
            WRITE(6,*)'REJECTION TO 1001 AFTER XPTFL1 RJ1000=',RJ1000
           ENDIF
C	   IREG=1
C	   RETURN
           GO TO 1001
          ENDIF
        ENDIF
      ENDIF
 2020 CONTINUE
C
      NSEA=LPASOF
      IF (IOUXEV.GE.3)THEN
       WRITE (6,1303)NSEA
 1303  FORMAT ('  XPTFL (after xptfl1/2): NSEA=',I10,
     *'ii,ijsq1,ijsaq1,ijsq2,ijsaq2,amcch1,amcch2,...')
       DO 305 II=1,NSEA
        WRITE(6,304)II,
     *               IJSQ1(II),IJSAQ1(II),IJSQ2(II),IJSAQ2(II),
     *               AMCCH1(II),AMCCH2(II),GAMCH1(II),GAMCH2(II),
     *               BGXCH1(II),BGYCH1(II),BGZCH1(II),
     *               BGXCH2(II),BGYCH2(II),BGZCH2(II),
     *               NCH1(II),NCH2(II),IJCH1(II),IJCH2(II),
     *               (PSOFA1(II,JU),PSOFA2(II,JU),PSOFB1(II,JU),
     *               PSOFB2(II,JU),JU=1,4)
  304   FORMAT(5I4,6E18.8/4E18.8,4I4,2E18.8/7E18.8/7E18.8)
  305  CONTINUE
      ENDIF
C
C  END LOOP OVER SOFT SEA-SEA CHAINS--------------------------------
C
C                                X-VALUES REMAINING FOR VALENCE CHAINS
C
      SOXVA2=SOX2-SOXUS2
      SOXVA1=SOX1-SOXUS1
      IF(SOXVA1.LT.0.0D0.OR.SOXVA2.LT.0.0D0) THEN
       IF(IOUXEV.GE.6) THEN
        WRITE(6,*) '  XPTFL: REJECTION TO 1001 DUE TO SOXVA1/2 < 0.1'
     *  ,SOXVA1,SOXVA2
       ENDIF
       GOTO 1001
      ENDIF
C
C  PARTEV VERSIONS
C
      IF ((NVERS.EQ.1.OR.NVERS.EQ.2).AND.MPO.GE.1) THEN
C   PARTEV VERSION 1 : ALL HARD PARTONS CONSIDERED TO BE GLUONS
C                      IN AP-P ALSO VALENCE GLUON SCATTERING TREATED
C                      CHAINS FRAGMENTING:
C                          -SOFT VALENCE CHAINS
C                          -SOFT SEA CHAINS
C                          -SPLIT EACHHARD GLUON INTO Q-AQ PAIR
C                          -GLUON-GLUON BECOMES TWO Q-AQ CHAINS
C
        I=0
        NONUJY=NONUJT+1
        DO 301 IXNUJT=1,MPO
          I=I+1
          NONUJT=NONUJT+1
C                                 FIRST SPLIT GLUON MOMENTUM
          IC302=0
  302     CONTINUE
          IC302=IC302+1
          IF (IOUXEV.GE.3.AND.MOD(IC302,12).EQ.0)WRITE(6,1302)IC302
 1302 FORMAT(' REJECTION IN XPTFL 302 HARD GLUON SPLIT ',I10)
C                                 REJECT TOTAL EVENT FOR IC302=12
          IF (IC302.EQ.12) GO TO 1001
          XXXG1=(RNDM(V))**0.50
          XXXG2=(RNDM(U))**0.50
          IF (NUGLUU.EQ.1) THEN
            XXXG1=0.999999999999D0
            XXXG2=0.000000000001D0 
          ENDIF
          XJQ1(NONUJT)=XH1(I)
          XJQ2(NONUJT)=XH2(I)
          DO 303 J=1,3
            PJETA1(NONUJT,J)=PHARD1(I,J)*XXXG1
            PJETB1(NONUJT,J)=PHARD2(I,J)*XXXG2
            PJETA2(NONUJT,J)=PHARD2(I,J)*(1.-XXXG2)
            PJETB2(NONUJT,J)=PHARD1(I,J)*(1.-XXXG1)
  303     CONTINUE
          PJETA1(NONUJT,4)=SQRT(PJETA1(NONUJT,1)**2+
     *                          PJETA1(NONUJT,2)**2
     *                         +PJETA1(NONUJT,3)**2)
          PJETB1(NONUJT,4)=SQRT(PJETB1(NONUJT,1)**2+
     *                          PJETB1(NONUJT,2)**2
     *                         +PJETB1(NONUJT,3)**2)
          PJETA2(NONUJT,4)=SQRT(PJETA2(NONUJT,1)**2+
     *                          PJETA2(NONUJT,2)**2
     *                         +PJETA2(NONUJT,3)**2)
C                                  MASSES OF SUBCHAINS
          PJETB2(NONUJT,4)=SQRT(PJETB2(NONUJT,1)**2+
     *                          PJETB2(NONUJT,2)**2
     *                         +PJETB2(NONUJT,3)**2)
      AMJCH1(NONUJT)=SQRT(MAX(0D0,((PJETA1(NONUJT,4)+PJETA2(NONUJT
     * ,4))+(PJETA1(NONUJT,3)+PJETA2(NONUJT,3)))*((PJETA1(NONUJT,4)
     * +PJETA2(NONUJT,4))-(PJETA1(NONUJT,3)+PJETA2(NONUJT,3)))-(PJE
     * TA1(NONUJT,2)+PJETA2(NONUJT,2))**2-(PJETA1(NONUJT,1)+PJETA2(
     * NONUJT,1))**2))
C                                  FLAVORS OF QUARKS
      AMJCH2(NONUJT)=SQRT(MAX(0D0,((PJETB1(NONUJT,4)+PJETB2(NONUJT
     * ,4))+(PJETB1(NONUJT,3)+PJETB2(NONUJT,3)))*((PJETB1(NONUJT,4)
     * +PJETB2(NONUJT,4))-(PJETB1(NONUJT,3)+PJETB2(NONUJT,3)))-(PJE
     * TB1(NONUJT,2)+PJETB2(NONUJT,2))**2-(PJETB1(NONUJT,1)+PJETB2(
     * NONUJT,1))**2))
          AI=I
          BI=I+I
          IPJQ1=1.D0+RNDM(QA1)*(2.D0+SEASQ)
          IF(RNDM(V3).LT.PCCC)IPJQ1=4
          IPJAQ1=-IPJQ1
          IPJQ2=1.D0+RNDM(QB1)*(2.D0+SEASQ)
          IF(RNDM(V4).LT.PCCC)IPJQ2=4
          IPJAQ2=-IPJQ2
          IF (IOUXEV.GE.6)WRITE (6,113)IPJQ1,IPJQ2
  113     FORMAT(' IPJQ1,IPJQ2 ',2I10)
C                               REJECT SPLITTING FOR SMALL CHAIN MASSE
          IFPS1=IMPS(IPJQ2,IPJQ1)
          IFV1=IMVE(IPJQ2,IPJQ1)
          AMPS1=AAM(IFPS1)
          AMV1=AAM(IFV1)
          AMFF1=AMV1+0.3
C
          IFPS2=IMPS(IPJQ1,IPJQ2)
          IFV2=IMVE(IPJQ1,IPJQ2)
          AMPS2=AAM(IFPS2)
          AMV2=AAM(IFV2)
          AMFF2=AMV2+0.3
C
          IF(NUGLUU.EQ.0.AND.
     *    ((AMJCH1(NONUJT).LE.AMFF1).OR.
     *     (AMJCH2(NONUJT).LE.AMFF2))) GO TO 302
C
          GAMJH1(NONUJT)=(PJETA1(NONUJT,4)+
     *                    PJETA2(NONUJT,4))/AMJCH1(NONUJT)
          BGXJH1(NONUJT)=(PJETA1(NONUJT,1)+
     *                    PJETA2(NONUJT,1))/AMJCH1(NONUJT)
          BGYJH1(NONUJT)=(PJETA1(NONUJT,2)+
     *                    PJETA2(NONUJT,2))/AMJCH1(NONUJT)
          BGZJH1(NONUJT)=(PJETA1(NONUJT,3)+
     *                    PJETA2(NONUJT,3))/AMJCH1(NONUJT)
          GAMJH2(NONUJT)=(PJETB1(NONUJT,4)+
     *                    PJETB2(NONUJT,4))/AMJCH2(NONUJT)
          BGXJH2(NONUJT)=(PJETB1(NONUJT,1)+
     *                    PJETB2(NONUJT,1))/AMJCH2(NONUJT)
          BGYJH2(NONUJT)=(PJETB1(NONUJT,2)+
     *                    PJETB2(NONUJT,2))/AMJCH2(NONUJT)
          BGZJH2(NONUJT)=(PJETB1(NONUJT,3)+
     *                    PJETB2(NONUJT,3))/AMJCH2(NONUJT)
          IJJQ1 (NONUJT)=IPJQ1
          IJJAQ1(NONUJT)=IPJAQ1
          IJJQ2 (NONUJT)=IPJQ2
C         CHange r.e.21.4.94 flavor conservation
C         IJJAQ2(NONUJT)=IPJAQ2
          IJJAQ2(NONUJT)=-IPJQ1
  301   CONTINUE
  403 FORMAT (I10)
      DO 405 II=NONUJY,NONUJT
      IF (IOUTPA.GE.3)
     *  WRITE(6,404)II,
     *               IJJQ1(II),IJJAQ1(II),IJJQ2(II),IJJAQ2(II),
     *               AMJCH1(II),AMJCH2(II),GAMJH1(II),GAMJH2(II),
     *               BGXJH1(II),BGYJH1(II),BGZJH1(II),
     *               BGXJH2(II),BGYJH2(II),BGZJH2(II),
     *               (PJETA1(II,JU),PJETA2(II,JU),PJETB1(II,JU),
     *               PJETB2(II,JU),JU=1,4)
  404   FORMAT(5I4,6E18.8/4E18.8,2E18.8/7E18.8/7E18.8)
  405 CONTINUE
      ENDIF
      IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,NSEA,NVAL,NVERS
      RETURN
      END
C-----------------------------------------------------------------     
C-----------------------------------------------------------------     
C-----------------------------------------------------------------     
      SUBROUTINE XPTFL1(NHARD,NSEA,NVAL,SOXUS1,SOXUS2,SOX1,SOX2,HAX1,
     *      HAX2,LPO,MPO,NPO,LPASOF,IJPVAL,IJTVAL,RJ1000,XMAX1,XMAX2)
C  PARTON LEVEL COLLISION EVENTS (X,PT FLAVOR)
C  THE ROUTINE XPTFL CALLS ONE EVENT
C
C   IJPROJ,IJTAR: PROJECTILE AND TARGET PARTICLE OF THE REACTION
C                 1=PROTON,  2=ANTIPROTON
C   IJPVAL,IJTVAL =0 VALENCE QUARKS OF PROJECTILE OR TARGET NOT INVOLVED
C                                                     IN HARD SCATTERING
C   IJPVAL,IJTVAL =1 VALENCE QUARKS OF PROJECTILE OR TARGET  INVOLVED
C                                                     IN HARD SCATTERING
C
C   PARTEV VERSIONS CONTROLLED BY NVERS
C              NVERS=1: ALL HARD PARTONS CONSIDERED TO BE GLUONS
C                       soft x values by rejection
C              NVERS=2: ALL HARD PARTONS CONSIDERED TO BE GLUONS
C                       soft x values by P.Aurenche P.Maire method
C
C THE RESULTS (HARD SCATTERING) ARE IN COMMON /ABRHRD/
C               XH1(I),XH2(I):     X-VALUES OF INITIAL PARTONS
C               IJHI1(I),IJHI2(I): FLAVOR OF INITIAL PARTON
C                                  0            GLUON
C                                  1,2          VALENCE U,D QUARKS
C                                  11,12,13,14  SEA UDSC-QUARKS
C                                  NEGATIVE     ANTI S OR V QUARKS
C               IJHF1(I),IJHF2(I): FLAVOR OF FINAL STATE PARTONS
C               PHARD1(I,J),PHARD2(I,J): FINAL PART. MOMENTUM AND ENERGY
C                                J=1   PX
C                                 =2   PY
C                                 =3   PZ
C                                 =4   ENERGY  (MASSLESS PARTONS)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      PARAMETER ( ONE=1.D0,ONEH=.5D0, ZERO=0.D0)
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      PARAMETER(MSH=250)
      PARAMETER (INTMD=252)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,MJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /ABRHRD/XH1(MSH),XH2(MSH),IJHI1(MSH),IJHI2(MSH),
     *IJHF1(MSH),IJHF2(MSH),PHARD1(MSH,4),PHARD2(MSH,4)
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      COMMON/INTNEZ/NDZ,NZD
C repl:COMMON /COLLIS/ECM,S,IJPROJ,IJTAR,PTTHR,IOPHRD,IJPRLU,IJTALU,PTTHR2
C     COMMON /COLLIS/S,IJPROJ,IJTAR,PTTHR,IOPHRD,IJPRLU,IJTALU,PTTHR2
      COMMON/COLLIS/S,IJPROJ,IJTAR,PTTHR,PTTHR2,IOPHRD,IJPRLU,IJTALU
      CHARACTER*80 TITLE
      CHARACTER*8 PROJTY,TARGTY
C     COMMON /USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    &            ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
*
      COMMON /COLLE/ NEVHAD,NVERS,IHADRZ,NFILE
      COMMON /IPIMM/IPIM
      COMMON /SEASU3/SEASQ
      COMMON /POMTYP/ IPOM2,IPOM1,IPOSOM(4),APOSOM(2)
      COMMON /DIQUAX/AMEDD,IDIQUA,IDIQUU
C-------------------------------------------------------------

      PARAMETER (INTMX=2488)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
*KEEP,ABRZD.
      COMMON /ABRZD/ AMCZD1(INTMD),AMCZD2(INTMD),
     +GACZD1(INTMD),GACZD2(INTMD),
     +BGXZD1(INTMD),BGYZD1(INTMD),BGZZD1(INTMD), 
     +BGXZD2(INTMD),BGYZD2(INTMD),
     +BGZZD2(INTMD), NCHZD1(INTMD),NCHZD2(INTMD),
     +IJCZD1(INTMD),IJCZD2(INTMD),
     +PQZDA1(INTMD,4),PQZDA2(INTMD,4), PQZDB1(INTMD,4),
     +PQZDB2(INTMD,4),
     +IPCQ(INTMD),ITCQ(INTMD),ITCQ2(INTMD),IPCAQ(INTMD),
     +ITCAQ(INTMD),ITCAQ2(INTMD)
     +,IZDSS(INTMD)
*KEEP,ABRDZ.
      COMMON /ABRDZ/ AMCDZ1(INTMD),AMCDZ2(INTMD),
     +GACDZ1(INTMD),GACDZ2(INTMD),
     +BGXDZ1(INTMD),BGYDZ1(INTMD),BGZDZ1(INTMD), 
     +BGXDZ2(INTMD),BGYDZ2(INTMD),
     +BGZDZ2(INTMD), NCHDZ1(INTMD),NCHDZ2(INTMD),
     +IJCDZ1(INTMD),IJCDZ2(INTMD),
     +PQDZA1(INTMD,4),PQDZA2(INTMD,4), PQDZB1(INTMD,4),
     +PQDZB2(INTMD,4),
     +IPZQ(INTMD),IPZQQ2(INTMD),ITZQ(INTMD),IPZAQ(INTMD),
     +IZAQQ2(INTMD),ITZAQ(INTMD)
     +,IDZSS(INTMD)
C-------------------
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
C-------------------------------------------------------------
C     COMMON /SVSWAP/ISVSWP,ISVSWT,JSVSWP,JSVSWT,XPSVSW,XTSVSW
      COMMON /VALHVG/PHPVAL(4),PHTVAL(4),IJVGP,IJVGT,IVALHP,IVALHT
      COMMON /PTLARG/XSMAX
      COMMON /GLUSPL/NUGLUU,NSGLUU
C
C  THE COMMON BLOCK /PART/ DEFINES THE PARTICLE PROPERTIES AS USED IN
C  BAMJET AND DECAY
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------

C  THE COMMON BLOCK /INPDAT/ DEFINES QUANTITIES NEEDED IN THE BAMJET
C  CHAIN DECAY CODE
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
      COMMON /LMMAXI/ LMMAX
      PARAMETER (NSTRMX=50)
      COMMON/SKINE1/NGLUEF,NNN,GL(NSTRMX),GR(NSTRMX),VL,VR,WL,WR,
     *              PTGL(2,NSTRMX),PTVL(2),PTWL(2),
     *              PTGR(2,NSTRMX),PTVR(2),PTWR(2)
      COMMON /PCHARM/PC
      COMMON /SEAQXX/ SEAQX,SEAQXN
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C      DATA INIPRI/0/
       DATA INICHA/0/
       DATA JTSP /0/
C      to keep identical commons
       ECM=CMENER
*
      IF(IOUXEV.GE.4)WRITE(6,*)'XPTFL1:entry:NDZ,NZD,NNDZ,NNZD,NHARD,',
     *'NSEA,NVAL'
     *,NDZ,NZD,NNDZ,NNZD,NHARD,NSEA,NVAL
      NOSTIN=NONUST
      GO TO 1179
 1199 CONTINUE
      NDZ=NDZ-NNDZ
      NZD=NZD-NNZD
C                       change 27.10.96
C     NDZ=0
C     NZD=0
      IF (IOUXEV.GE.6)WRITE (6,*)'XPTFL1: 1199 ndz nzd nndz nnzd'
     *,NDZ,NZD,NNDZ,NNZD
      IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF
 1179 CONTINUE
      NONUST=NOSTIN
C     NDZ=0
C     NZD=0
      NNDZ=0
      NNZD=0
      IPIM  =0
      RJ1000=0.D0
      NHARD=MPO
      UNOGLU=5.
      UNOVAL=2.
      SOX1=XMAX1-HAX1
      SOX2=XMAX2-HAX2
        LPASOF=0
C       LLPPOO=LPO-1+MPO
        LLPPOO=LPO-1
        IF (LLPPOO.LE.0) GO TO 2020
        ALPO=LPO
C       ALPO=LPO+MPO
        NSEA=0
          IF(IPOM1.EQ.48.AND.IPOM2.EQ.2.AND.ECM.LT.20.D0)THEN
            XPTHRO=1.5*LOG10(ECM/2000.)+5.
            XPTHRO=1.5*LOG10(ECM/200.)+3.5
          ELSEIF(IPOM1.EQ.48.AND.IPOM2.EQ.2.AND.ECM.GE.20.D0)THEN
            XPTHRO=5.0
          ENDIF
          IF(IPOM1.EQ.11.AND.IPOM2.EQ.5)XPTHRO=15.
          IF(IPOM1.EQ.5.AND.IPOM2.EQ.5)XPTHRO=20.
          IF (IPIM.EQ.2)XPTHRO=2.
	  XPTHRO=8.
	  IF(ISTRUF.EQ.15) XPTHRO=5.
	  IF(ISTRUF.EQ.22) XPTHRO=8.
          IF( JTSP.EQ.0 ) THEN
            IF (IOUXEV.GE.1) WRITE(6,*)' XPTFL1: XPTHRO=',XPTHRO
            JTSP=1
          ENDIF
C                                 j.r.5.12.94
C         XPTHR=XPTHRO/ECM
          XPTHR=1.5*XPTHRO/(ECM**1.5*14.)
C------------------------------------------------------------
C                                  j.r.11.5.94---16.5.94
C	  IF(IP.EQ.1)XPTHR=1.5*XPTHRO/ECM**2
 	  IF(IP.EQ.1)XPTHR=1.5*XPTHRO/(ECM**1.5*14.)
C------------------------------------------------------------
          XPTHR2=1.8
          IF (XPTHR2.GT.XPTHRO)XPTHR2=XPTHRO
C                                     j.r,5.12.94
C         XSTHR2=XPTHR2/ECM
          XSTHR2=1.5*XPTHR2/(ECM**1.5*14.)
C------------------------------------------------------------
C                                  j.r.11.5.94---16.5.94
C	  IF(IP.EQ.1)XSTHR2=1.5*XPTHR2/ECM**2
 	  IF(IP.EQ.1)XSTHR2=1.5*XPTHR2/(ECM**1.5*14.)
C------------------------------------------------------------
C         IF(INIPRI.EQ.0)THEN
C           INIPRI=1
            ALOX1=LOG(SOX1/XPTHR)
            ALOX2=LOG(SOX2/XPTHR)
            ALOOX1=1.+ALOX1
            ALOOX2=1.+ALOX2
            ALOOO1=1./ALOOX1
            ALOOO2=1./ALOOX2
          IF( JTSP.EQ.1 ) THEN
            IF(IOUXEV.GE.1)WRITE(6,9753)XPTHRO,XPTHR,XSTHR2
 9753       FORMAT(' XPTFL1: XPTHRO,XPTHR,XSTHR2= ',3E15.5)
            JTSP=2
          ENDIF
C         ENDIF
C       one pair of soft chains for each hard pomeron
C       IF(NPO.EQ.1)LLPPOO=LPO-2
C       IF(NPO.EQ.1)LLPPOO=LPO
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
C     IF(INICHA.EQ.0)THEN
      IF(INICH2.EQ.0)THEN
        SEASQ=0.5D0
        GM=2.140
        X2=UMMM
	BETOO=7.5D0
      ENDIF
        RX=XPTHRO
        X1=RX
        BETCHA=BETOO+1.3-LOG10(ECM)
        PU=DBETA(X1,X2,BETCHA)
        X2=SMMM
        PS=DBETA(X1,X2,BETCHA)
        X2=CMMM
        PC=DBETA(X1,X2,BETCHA)
C       PU1=PU/(2*PU+PS+PC)
C       PS1=PS/(2*PU+PS+PC)
        PC1=PC/(2*PU+PS+PC)
        PCC1=PC1*1.5D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
        PU1=PU/(2*PU+PS+PC)
        PS1=PS/(2*PU+PS+PC)
      IF(INICH2.EQ.0)THEN
        INICH2=1
        IF(IOUXEV.GE.1)WRITE(6,4567)PC,BETCHA,PU1,PS1
 4567   FORMAT(' Charm at chain ends XPTFL1: PC,BETCHA,PU,PS ',4F10.5)
      ENDIF
C----------------------------------------------------------------------
C
        DO 20 I=1,LLPPOO
C         JSVSWP=0
C         JSVSWT=0
          AI=I-1
C         XPTHRX=XPTHR-0.5*AI/ECM
          XPTHRX=XPTHR-0.5*AI/ECM**2
C------------------------------------------------------------
C                                  j.r.11.5.94---16.5.94
 	  IF(IP.EQ.1)XPTHRX=XPTHR-0.5*AI/ECM**2
C------------------------------------------------------------
C         IF (XPTHRX.LT.2.D0/ECM)XPTHRX=2./ECM
          IF (XPTHRX.LT.4.D0/ECM**2)XPTHRX=4./ECM**2
C------------------------------------------------------------
C                                  j.r.11.5.94---16.5.94
          IF(IP.EQ.1.AND.XPTHRX.LT.4.D0/ECM**2)XPTHRX=4./ECM**2
C------------------------------------------------------------
C
C  LOOP OVER (LPO-1) SOFT SEA-SEA CHAINS WITH GLUONS AT CHAIN ENDS
C  GLUONS WILL BE SPLIT INTO QUARK-ANTIQUARK PAIRS
C  AND TWO Q-AQ CHAINS FORMED PER COLLISION
C
C                            GLUON X-VALUES
C                                             CHANGE J.R.21.5.90
C---------------------------------------------------------------
          NCOGLU=0
 5577     CONTINUE
          NCOGLU=NCOGLU+1
	  IF(NCOGLU.GE.6)THEN
C            REJECT XGLU values too large	    
C                                 REJECT THE TOTAL EVENT
            IF (IOUXEV.GE.6)WRITE (6,*)' REJECT  EVENT XGLU-VALUES'
            LPO=LPO-1
            SOXUS1=0.
            SOXUS2=0.
            GO TO 1199
	  ENDIF
          IF (RNDM(V1).LT.ALOOO1)THEN
            XGLU1=RNDM(A2)*(XPTHRX-XSTHR2)+XSTHR2
          ELSE
   25       CONTINUE
C................................................................a
	    IF(SEAQX.LE.0.75D0)THEN
              XGLU1=SAMPEX(XPTHRX,SOX1)
	    ELSEIF(SEAQX.GT.0.75D0)THEN
              XGLU1=SAMPEY(XPTHRX,SOX1)
            ENDIF
C................................................................
          ENDIF
          IF (RNDM(V3).LT.ALOOO2)THEN
            XGLU2=RNDM(A4)*(XPTHRX-XSTHR2)+XSTHR2
          ELSE
   26       CONTINUE
C................................................................
	    IF(SEAQX.LE.0.75D0)THEN
              XGLU2=SAMPEX(XPTHRX,SOX1)
	    ELSEIF(SEAQX.GT.0.75D0)THEN
              XGLU2=SAMPEY(XPTHRX,SOX1)
            ENDIF
C................................................................
C                                   CHANGE 18.6.90 PREVENT EVENT LOOP
          ENDIF
C---------------------------------------------------------------
C                              SPLIT GLUON INTO TWO SEA QUARKS
C                              FLAVORS OF SEA QUARKS
          IF(IOUXEV.GE.6)WRITE (6,109) XGLU1,XGLU2
C                 Are these xglu values allowed
          IF(XGLU1+SOXUS1.GT.SOX1.OR.XGLU2+SOXUS2.GT.SOX2)GO TO 5577
  109     FORMAT (' XPTFL1  XGLU1,XGLU2 ',2F10.6)
          AI=I
          BI=I+I
          IPSQ1=1.D0+RNDM(QA1)*(2.D0+SEASQ)
          IF(RNDM(W1).LT.PC)IPSQ1=4
          IPSAQ1=-IPSQ1
          IPSQ2=1.D0+RNDM(QB1)*(2.D0+SEASQ)
          IF(RNDM(W2).LT.PC)IPSQ2=4
          IPSAQ2=-IPSQ2
          IF (IOUXEV.GE.6)WRITE (6,113)IPSQ1,IPSQ2
  113     FORMAT(' XPTFL1  IPSQ1,IPSQ2 ',2I10)
C                              X-FRAXTIONS OF SEA QUARKS
C------------------------------------------------------j.r.29.4.93
          IF(IPSQ1.LE.2)THEN
            XPSQ1=(0.2+(0.36*RNDM(A1))**0.50)*XGLU1
            XPSAQ1=XGLU1-XPSQ1
          ELSEIF(IPSQ1.EQ.3)THEN
            BSQ=0.7/ECM
            XSTHR=2./ECM
	    ICOXS1=0
 5588       CONTINUE	    
	    ICOXS1=ICOXS1+1
	    IF(ICOXS1.GT.8)THEN
C             REJECT XPSQ1 values too large	    
C                                 REJECT THE TOTAL EVENT
              IF (IOUXEV.GE.6)WRITE (6,*)' REJECT  EVENT XPSQ1-VALUES'
              LPO=LPO-1
              SOXUS1=0.
              SOXUS2=0.
	  IF(IOUXEV.GE.4) WRITE(6,*)' xptfl1 LPO,SOXUS1,SOXUS2 reject ',
     *	      LPO,SOXUS1,SOXUS2
              GO TO 1199
	    ENDIF
            XPSQ1=SAMPXB(XSTHR+BSQ,0.9D0,BSQ)
	    IF(XPSQ1.GE.XGLU1)GO TO 5588
	    XPSAQ1=XGLU1-XPSQ1
C           XPSAQ1=SAMPXB(XSTHR+BSQ,0.9D0,BSQ)
          ELSEIF(IPSQ1.EQ.4)THEN
            BCQ=2./ECM
            XSTHR=2./ECM
            XPSQ1=SAMPXB(XSTHR+BCQ,0.9D0,BCQ)
            XPSAQ1=SAMPXB(XSTHR+BCQ,0.9D0,BCQ)
          ENDIF
          IF(IPSQ2.LE.2)THEN
            XPSQ2=(0.2+(0.36*RNDM(B1))**0.50)*XGLU2
            XPSAQ2=XGLU2-XPSQ2
          ELSEIF(IPSQ2.EQ.3)THEN
            BSQ=0.7/ECM
            XSTHR=2./ECM
	    ICOXS2=0
 5599       CONTINUE	    
	    ICOXS2=ICOXS2+1
	    IF(ICOXS2.GT.8)THEN
C             REJECT XPSQ2 values too large	    
C                                 REJECT THE TOTAL EVENT
              IF (IOUXEV.GE.6)WRITE (6,*)' REJECT  EVENT XPSQ2-VALUES'
              LPO=LPO-1
              SOXUS1=0.
              SOXUS2=0.
              GO TO 1199
	    ENDIF
            XPSQ2=SAMPXB(XSTHR+BSQ,0.9D0,BSQ)
	    IF(XPSQ2.GE.XGLU2)GO TO 5599
	    XPSAQ2=XGLU2-XPSQ2
C           XPSAQ2=SAMPXB(XSTHR+BSQ,0.9D0,BSQ)
          ELSEIF(IPSQ2.EQ.4)THEN
            BCQ=2./ECM
            XSTHR=2./ECM
            XPSQ2=SAMPXB(XSTHR+BCQ,0.9D0,BCQ)
            XPSAQ2=SAMPXB(XSTHR+BCQ,0.9D0,BCQ)
          ENDIF
C------------------------------------------------------j.r.29.4.93
      IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF
  107 FORMAT ('  XPTFL1  IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF = ',6I10)
          IF(IOUXEV.GE.6)WRITE(6,114) XPSQ1,XPSAQ1,XPSQ2,XPSAQ2
  114     FORMAT('  XPSQ1,XPSAQ1,XPSQ2,XPSAQ2 ',4F12.6)
C  ------------------------------------------------------------------
C                        define eventually D-Z chains (sea-diquark--sea)
C
       IREJDZ=0
       IREJZD=0
       NDIQDZ=0
       NDIQZD=0
C      AME=0.9
       IF(RNDM(V).GT.2.D0*AMEDD-1.D0)THEN
         IF(IDIQUU.EQ.1)THEN
           IF(IOUXEV.GE.3)WRITE(6,*)' XPTFL1 call DIQDZZ ',
     *	   'LPO,AMEDD',LPO,AMEDD
           CALL DIQDZZ(ECM,XPSQ1,XPSAQ1,XPSQ2,XPSAQ2,IPSQ1,IPSAQ1,
     *               IPSQ2,IPSAQ2,IREJDZ)
           IF(IREJDZ.EQ.1)THEN
             IF (IOUXEV.GE.4)WRITE (6,'(2A,4I5)')'DIQDZZ1 ndz nzd nndz '
     *       ,'nnzd XPTFL1',NDZ,NZD,NNDZ,NNZD
	   ENDIF
           IF(IREJDZ.EQ.0) THEN
             NNDZ=NNDZ+1
             IF (IOUXEV.GE.3)WRITE (6,'(2A,4I5)')' DIQDZZ0 ndz nzd nndz'
     *       ,' nnzd XPTFL1',NDZ,NZD,NNDZ,NNZD
             NDIQDZ=1
C                                   TEST ARE THESE X VALUES ALLOWED
             SOXUS1=SOXUS1+XPSQ1+XPSAQ1
             SOXUS2=SOXUS2+XPSQ2+XPSAQ2
             IF(IOUXEV.GE.3)WRITE (6,*)' SOXUS1,SOXUS2,SOX1,SOX2 ',
     *	     'HAX1,HAX2 after call diqdzz ',
     *       SOXUS1,SOXUS2,SOX1,SOX2,
     *	     HAX1,HAX2
             IF ((SOXUS1.GT.SOX1).OR.(SOXUS2.GT.SOX2)) THEN
C                                   REJECT THE TOTAL EVENT
               IF (IOUXEV.GE.3)WRITE (6,106)
               RJ1000=1.D0
               NDZ=NDZ-NNDZ
               NZD=NZD-NNZD
C                          change 27.10.96
	       NNDZ=0
	       NNZD=0
C                          change 27.10.96
               NDIQDZ=0 
               LPO=LPO-1
               SOXUS1=0.
               SOXUS2=0.
               NONUST=NOSTIN
               IF (IOUXEV.GE.3)WRITE (6,*)' RETURN ndz nzd '
     *         ,'nndz,nnzd,LPO soxus.GT.sox  DIQDZZ0',
     *         NDZ,NZD,NNDZ,NNZD,LPO
               RETURN
             ENDIF
C            GO TO 20
           ENDIF
         ENDIF
       ENDIF
       IF(RNDM(V).GT.2.D0*AMEDD-1.D0.AND.NDIQDZ.EQ.0)THEN
         IF(IDIQUU.EQ.1)THEN
           IF(IOUXEV.GE.3)WRITE(6,*)' XPTFL1 call DIQZZD ',
     *	   'LPO,AMEDD',LPO,AMEDD
           CALL DIQZZD(ECM,XPSQ1,XPSAQ1,XPSQ2,XPSAQ2,IPSQ1,IPSAQ1,
     *               IPSQ2,IPSAQ2,IREJZD)
           IF(IREJZD.EQ.1)THEN
             IF (IOUXEV.GE.3)WRITE (6,'(2A,4I5)')' DIQZZD1 ndz nzd nndz'
     *       ,' nnzd XPTFL1',NDZ,NZD,NNDZ,NNZD
C	     NZD=NZD-1
	   ENDIF
           IF(IREJZD.EQ.0) THEN
             NNZD=NNZD+1
             IF (IOUXEV.GE.3)WRITE (6,'(2A,4I5)')' DIQZZD0 ndz nzd '
     *       ,'nndz,nnzd XPTFL1',NDZ,NZD,NNDZ,NNZD
             NDIQZD=1
C                                   TEST ARE THESE X VALUES ALLOWED
             SOXUS1=SOXUS1+XPSQ1+XPSAQ1
             SOXUS2=SOXUS2+XPSQ2+XPSAQ2
             IF(IOUXEV.GE.3)WRITE (6,*)' SOXUS1,SOXUS2,SOX1,SOX2 ,',
     *	     'HAX1,HAX2 after call diqzzd0',
     *       SOXUS1,SOXUS2,SOX1,SOX2,
     *	     HAX1,HAX2
             IF ((SOXUS1.GT.SOX1).OR.(SOXUS2.GT.SOX2)) THEN
C                                   REJECT THE TOTAL EVENT
               IF (IOUXEV.GE.3)WRITE (6,106)
               RJ1000=1.D0
               NZD=NZD-NNZD
               NDZ=NDZ-NNDZ
C                          change 27.10.96
C	       NDZ=0
C	       NZD=0
	       NNDZ=0
	       NNZD=0
C                          change 27.10.96
               NDIQZD=0
               LPO=LPO-1
               SOXUS1=0.
               SOXUS2=0.
               NONUST=NOSTIN
               IF (IOUXEV.GE.3)WRITE (6,*)' RETURN2 ndz nzd '
     *         ,'nndz,nnzd,LPO SOXUS.GT.SOX',
     *         'diqzzd0',NDZ,NZD,NNDZ,NNZD,LPO
               RETURN
             ENDIF
C            GO TO 20
           ENDIF
         ENDIF
       ENDIF
       AME=0.95
       PTXSQ1=0  
       PTYSQ1=0
       PTXSA1=0
       PTYSA1=0 
       PTXSQ2=0  
       PTYSQ2=0
       PTXSA2=0
       PTYSA2=0 
       PLQ1 = XPSQ1 *ECM/2.
       EQ1  = XPSQ1 *ECM/2. 
       PLAQ1= XPSAQ1*ECM/2.
       EAQ1 = XPSAQ1*ECM/2.
       PLQ2 =-XPSQ2 *ECM/2.
       EQ2  = XPSQ2 *ECM/2. 
       PLAQ2=-XPSAQ2*ECM/2.
       EAQ2 = XPSAQ2*ECM/2.
C  ------------------------------------------------------------------

C                            SELECT SEA QUARK AND ANTIQUARK PT-VALUES
C
          IKVALA=2
          NSELPT=1
       IF(IOUXEV.GE.6)WRITE(6,'(A)')' XPTFL1 call SELPT'
          CALL     SELPT(
     *                 PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     *                 PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     *                 AMCH1,AMCH2,IREJ,IKVALA,pttq1,ptta1,PTTQ2,PTTA2,
     *                 NSELPT)
C
          IF (IREJ.EQ.1) THEN
           IF(IOUXEV.GE.6)WRITE(6,*)'  XPTFL1: --> 9922 IREJ=',IREJ
           IF(IOUXEV.GE.6)WRITE(6,'(A,6I5)')
     *' XPTFL1:NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD ',
     *NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD 
           IF(NDIQDZ.EQ.1)THEN
             NDZ=NDZ-1
             NDIQDZ=0
             NNDZ=NNDZ-1
           ENDIF
           IF(NDIQZD.EQ.1)THEN
             NZD=NZD-1
             NDIQZD=0
             NNZD=NNZD-1
           ENDIF
           GO TO 9922
          ENDIF
      IF (IOUXEV.GE.6)WRITE (6,*)'IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF',
     *IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C  FIRST FOR CHAIN 1
C
          IFPS1=IMPS(IPSQ2,IPSQ1)
          IFV1=IMVE(IPSQ2,IPSQ1)
          AMPS1=AAM(IFPS1)
          AMV1=AAM(IFV1)
          NNCH1=0
          AMFF1=AMV1+0.3
          IF(IOUXEV.GE.3)WRITE(6,102)AMCH1,AMPS1,AMV1,IFPS1,IFV1
  102     FORMAT(' AMCH1,AMPS1,AMV1,IFPS1,IFV1 ',3F12.4,2I10)
          IF(AMCH1.LT.AMFF1) THEN
           IF(IOUXEV.GE.6)WRITE(6,*)'  XPTFL1: --> 9922 AMCH1 < AMFF1'
           IF(IOUXEV.GE.6)WRITE(6,'(A,6I5)')
     *' XPTFL1:NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD ',
     *NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD 
           IF(NDIQDZ.EQ.1)THEN
             NDZ=NDZ-1
             NDIQDZ=0
             NNDZ=NNDZ-1
           ENDIF
           IF(NDIQZD.EQ.1)THEN
             NZD=NZD-1
             NDIQZD=0
             NNZD=NNZD-1
           ENDIF
           GO TO 9922
          ENDIF
          IF (AMCH1.LT.AMV1)THEN
C                                  PRODUCE PSEUDOSCALAR
            IJNCH1=IFPS1
            NNCH1=-1
C                                   CORRECT KINEMATICS
            XPSQ1=XPSQ1*AMPS1/AMCH1
            XPSAQ2=XPSAQ2*AMPS1/AMCH1
            AMCH1=AMPS1
C                                   GO TO REDO THE KINEMATICS
          ELSEIF(AMCH1.LT.AMFF1) THEN
C                                   PRODUCE VECTOR MESON
            IJNCH1=IFV1
            NNCH1=1
C                                   CORRECT KINEMATICS
            XPSQ1=XPSQ1*AMV1/AMCH1
            XPSAQ2=XPSAQ2*AMV1/AMCH1
            AMCH1=AMV1
C                                   GO TO REDO THE KINEMATICS
          ELSE
C                                   NO CORRECTIONS BUT DO  CHAIN 2
            GO TO 31
          ENDIF
C                                   CORRECT KINEMATICS FOR CHAIN 1

          EQ1=XPSQ1*ECM/2.
          EAQ2=XPSAQ2*ECM/2.
          IF(    (EQ1**2.LT.PTTQ1)
     *     .OR.(EAQ2**2.LT.PTTA2)) THEN
           IF(IOUXEV.GE.6)WRITE(6,*)'  XPTFL1: --> 9922 EQ^2 < PT'
     *     ,'EQ1 PTTQ1 EAQ2 PTTA2',EQ1,PTTQ1,EAQ2,PTTA2
           IF(IOUXEV.GE.6)WRITE(6,'(A,6I5)')
     *' XPTFL1:NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD ',
     *NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD 
           IF(NDIQDZ.EQ.1)THEN
             NDZ=NDZ-1
             NDIQDZ=0
             NNDZ=NNDZ-1
           ENDIF
           IF(NDIQZD.EQ.1)THEN
             NZD=NZD-1
             NDIQZD=0
             NNZD=NNZD-1
           ENDIF
           GO TO 9922
          ENDIF
          PLQ1=SQRT(EQ1**2-PTTQ1)
          PLAQ2=-SQRT(EAQ2**2-PTTA2)
   31     CONTINUE
      IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C  SECOND FOR CHAIN 2
C
          IFPS2=IMPS(IPSQ1,IPSQ2)
          IFV2=IMVE(IPSQ1,IPSQ2)
          AMPS2=AAM(IFPS2)
          AMV2=AAM(IFV2)
          NNCH2=0
          AMFF2=AMV2+0.3
          IF(IOUXEV.GE.3)WRITE(6,103)AMCH2,AMPS2,AMV2,IFPS2,IFV2
  103     FORMAT(' AMCH2,AMPS2,AMV2,IFPS2,IFV2 ',3F12.4,2I10)
          IF(AMCH2.LT.AMFF2) THEN
           IF(IOUXEV.GE.6)WRITE(6,*)'  XPTFL1: --> 9922 AMCH2 < AMFF2'
           IF(IOUXEV.GE.6)WRITE(6,'(A,6I5)')
     *' XPTFL1:NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD ',
     *NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD 
           IF(NDIQDZ.EQ.1)THEN
             NDZ=NDZ-1
             NDIQDZ=0
             NNDZ=NNDZ-1
           ENDIF
           IF(NDIQZD.EQ.1)THEN
             NZD=NZD-1
             NDIQZD=0
             NNZD=NNZD-1
           ENDIF
           GO TO 9922
          ENDIF
          IF (AMCH2.LT.AMV2)THEN
C                                PRODUCE PSEUDO SCALAR
            IJNCH2=IFPS2
            NNCH2=-1
C                                   CORRECT KINEMATICS
            XPSQ2=XPSQ2*AMPS2/AMCH2
            XPSAQ1=XPSAQ1*AMPS2/AMCH2
            AMCH2=AMPS2
C                                   GO TO REDO THE KINEMATICS
          ELSEIF(AMCH2.LT.AMFF2) THEN
C                                   PRODUCE VECTOR MESON
            IJNCH2=IFV2
            NNCH2=1
C                                   CORRECT KINEMATICS
            XPSQ2=XPSQ2*AMV2/AMCH2
            XPSAQ1=XPSAQ1*AMV2/AMCH2
            AMCH2=AMV2
C                                   GO TO REDO THE KINEMATICS
          ELSE
C                                   NO CORRECTIONS
            GO TO 32
          ENDIF
C                                   CORRECT KINEMATICS FOR CHAIN 2

          EQ2=XPSQ2*ECM/2.
          EAQ1=XPSAQ1*ECM/2.
          IF(    (EQ2**2.LT.PTTQ2)
     *       .OR.(EAQ1**2.LT.PTTA1)) THEN
           IF(IOUXEV.GE.6)WRITE(6,*)'  XPTFL1: --> 9922 EQ^2 < PT'
     *     ,'EQ2 PTTQ2 EAQ1 PTTA1',EQ2,PTTQ2,EAQ1,PTTA1
           IF(IOUXEV.GE.6)WRITE(6,'(A,6I5)')
     *' XPTFL1:NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD ',
     *NDZ,NNDZ,NDIQDZ,NZD,NNZD,NDIQZD 
           IF(NDIQDZ.EQ.1)THEN
             NDZ=NDZ-1
             NDIQDZ=0
             NNDZ=NNDZ-1
           ENDIF
           IF(NDIQZD.EQ.1)THEN
             NZD=NZD-1
             NDIQZD=0
             NNZD=NNZD-1
           ENDIF
           GO TO 9922
          ENDIF
          PLQ2=-SQRT(EQ2**2-PTTQ2)
          PLAQ1=SQRT(EAQ1**2-PTTA1)
   32     CONTINUE
C                                   TEST ARE THESE X VALUES ALLOWED
          IF(NDIQDZ.EQ.0.AND.NDIQZD.EQ.0)THEN
            SOXUS1=SOXUS1+XPSQ1+XPSAQ1
            SOXUS2=SOXUS2+XPSQ2+XPSAQ2
          ENDIF
          IF(IOUXEV.GE.3)WRITE (6,105)SOXUS1,SOXUS2,SOX1,SOX2,HAX1,HAX2
  105     FORMAT('XPTFL1 SOXUS1,SOXUS2,SOX1,SOX2,HAX1,HAX2 ',6F10.6)
          IF ((SOXUS1.GT.SOX1).OR.(SOXUS2.GT.SOX2)) THEN
C                                   REJECT THE TOTAL EVENT
            IF (IOUXEV.GE.6)WRITE (6,106)
  106       FORMAT(' REJECT THE EVENT  SEA X-VALUES')
C                                              j.r.10.5.94
            LPO=LPO-1
            SOXUS1=0.
            SOXUS2=0.
            GO TO 1199
          ENDIF
          GO TO 9923
 9922     CONTINUE
CC          LPO=LPO-1
            SOXUS1=0.
            SOXUS2=0.
            GO TO 1199
C                                   VALENCE-SEA SWAP-------------------
C         IF (JSVSWP.EQ.1)ISVSWP=0
C         IF (JSVSWT.EQ.1)ISVSWT=0
          GO TO 22
 9923     CONTINUE
C  NOW WE HAVE AN ACCEPTABLE SOFT GLUON-GLUON EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
      IF (IOUXEV.GE.6)WRITE (6,107)IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF
          LPASOF=LPASOF+1
          II=LPASOF
          NONUST=NONUST+1
          II=NONUST
          XSQ1(II)=XPSQ1
          XSAQ1(II)=XPSAQ1
          XSQ2(II)=XPSQ2
          XSAQ2(II)=XPSAQ2
          IJSQ1(II)=IPSQ1
          IJSAQ1(II)=IPSAQ1
          IJSQ2(II)=IPSQ2
          IJSAQ2(II)=IPSAQ2
          AMCCH1(II)=AMCH1
          AMCCH2(II)=AMCH2
          GAMCH1(II)=(EQ1+EAQ2)/AMCH1
          BGXCH1(II)=(PTXSQ1+PTXSA2)/AMCH1
          BGYCH1(II)=(PTYSQ1+PTYSA2)/AMCH1
          BGZCH1(II)=(PLQ1+PLAQ2)/AMCH1
          GAMCH2(II)=(EQ2+EAQ1)/AMCH2
          BGXCH2(II)=(PTXSQ2+PTXSA1)/AMCH2
          BGYCH2(II)=(PTYSQ2+PTYSA1)/AMCH2
          BGZCH2(II)=(PLAQ1+PLQ2)/AMCH2
          NCH1(II)=NNCH1
          NCH2(II)=NNCH2
          IF (IREJDZ.EQ.0.AND.NDIQDZ.EQ.1)THEN
            NCH1(II)=88
            NCH2(II)=88
          ENDIF
          IF (IREJZD.EQ.0.AND.NDIQZD.EQ.1)THEN
            NCH1(II)=88
            NCH2(II)=88
          ENDIF
          IF(NDIQDZ.EQ.1.AND.NDZ.GT.0)IDZSS(NDZ)=II
          IF(NDIQZD.EQ.1.AND.NZD.GT.0)IZDSS(NZD)=II
          IJCH1(II)=IJNCH1
          IJCH2(II)=IJNCH2
          PSOFA1(II,1)=PTXSQ1
          PSOFA1(II,2)=PTYSQ1
          PSOFA1(II,3)=PLQ1
          PSOFA1(II,4)=EQ1
          PSOFA2(II,1)=PTXSA2
          PSOFA2(II,2)=PTYSA2
          PSOFA2(II,3)=PLAQ2
          PSOFA2(II,4)=EAQ2
          PSOFB1(II,1)=PTXSQ2
          PSOFB1(II,2)=PTYSQ2
          PSOFB1(II,3)=PLQ2
          PSOFB1(II,4)=EQ2
          PSOFB2(II,1)=PTXSA1
          PSOFB2(II,2)=PTYSA1
          PSOFB2(II,3)=PLAQ1
          PSOFB2(II,4)=EAQ1
          IF (IOUXEV.GE.3)WRITE(6,104)II,
     *                 XSQ1(II),XSAQ1(II),XSQ2(II),XSAQ2(II),
     *                 IJSQ1(II),IJSAQ1(II),IJSQ2(II),IJSAQ2(II),
     *                 AMCCH1(II),AMCCH2(II),GAMCH1(II),GAMCH2(II),
     *                 BGCH1(II),BGCH2(II),THECH1(II),THECH2(II),
     *                 BGXCH1(II),BGYCH1(II),BGZCH1(II),
     *                 BGXCH2(II),BGYCH2(II),BGZCH2(II),
     *                 NCH1(II),NCH2(II),IJCH1(II),IJCH2(II),
     *               (PSOFA1(II,JU),PSOFA2(II,JU),PSOFB1(II,JU),
     *               PSOFB2(II,JU),JU=1,4)
  104     FORMAT(I10,4F12.7,4I5/10X,8F12.6/10X,6F12.6,4I5/8F15.5/8F15.5)
   22     CONTINUE
   20   CONTINUE
        IF (IOUXEV.GE.6) WRITE(6,*)'  LPASOF =',LPASOF
 2020   CONTINUE
      IF (IOUXEV.GE.4)WRITE (6,*)'END XPTFL1',
     * '  IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF,IREJ',
     * IOUXEV,NHARD,LPO,NZD,NDZ,LPASOF,IREJ
      RETURN
      END
C*****************************************************************
      SUBROUTINE PTVAL(XP,XXP,XXT,XT,ECM,
     *                 PTXVQ1,PTYVQ1,PLQ1,EQ1,PTXVA1,PTYVA1,PLAQ1,EAQ1,
     *                 PTXVQ2,PTYVQ2,PLQ2,EQ2,PTXVA2,PTYVA2,PLAQ2,EAQ2,
     *                 AMCH1,AMCH2,IREJ,IKVALA)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE
      COMMON /COLLE/ NEVHAD,NVERS,IHADRZ,NFILE
      PARAMETER (NSTRMX=50)
      COMMON/SKINE1/NGLUEF,NNN,GL(NSTRMX),GR(NSTRMX),VL,VR,WL,WR,
     *              PTGL(2,NSTRMX),PTVL(2),PTWL(2),
     *              PTGR(2,NSTRMX),PTVR(2),PTWR(2)
      PTXVQ1 = PTVL(1)
      PTYVQ1 = PTVL(2)
      PTXVA1 = PTWL(1)
      PTYVA1 = PTWL(2)
      PTXVQ2 = PTVR(1)
      PTYVQ2 = PTVR(2)
      PTXVA2 = PTWR(1)
      PTYVA2 = PTWR(2)
      EQ1    = XP*ECM/2.
      EQ2    = XT*ECM/2.
      EAQ1   = XXP*ECM/2.
      EAQ2   = XXT*ECM/2.
C     PLQ1   = SQRT(EQ1**2-PTXVQ1**2-PTYVQ1**2)
C     PLQ2   = SQRT(EQ2**2-PTXVQ2**2-PTYVQ2**2)
C     PLAQ1  = SQRT(EAQ1**2-PTXVA1**2-PTYVA1**2)
C     PLAQ2  = SQRT(EAQ2**2-PTXVA2**2-PTYVA2**2)
      PLQ1   = EQ1
      PLQ2   = -EQ2
      PLAQ1  = EAQ1
      PLAQ2  = -EAQ2
C     AMCH1=SQRT((EQ1+EAQ2)**2-(PTXVQ1+PTXVA2)**2
C    *       -(PTYVQ1+PTYVA2)**2-(PLQ1+PLAQ2)**2)
      AMCH1=SQRT(XP*XXT*ECM*ECM-(PTXVQ1+PTXVA2)**2
     *       -(PTYVQ1+PTYVA2)**2)
C     AMCH2=SQRT((EQ2+EAQ1)**2-(PTXVQ2+PTXVA1)**2
C    *       -(PTYVQ2+PTYVA1)**2-(PLQ2+PLAQ1)**2)
      AMCH2=SQRT(XT*XXP*ECM*ECM-(PTXVQ2+PTXVA1)**2
     *       -(PTYVQ2+PTYVA1)**2)
      RETURN
      END
      SUBROUTINE KKEVTO(NHKKH1,EPN,PPN,KKMAT,IREJ)
*
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON/INTNEZ/NDZ,NZD
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C      /
C INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,RPTSHM.
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
*KEEP,NSHMAK.
      COMMON /NSHMAK/ NNSHMA,NPSHMA,NTSHMA,NSHMAC,NSHMA2
*KEEP,ZENTRA.
      COMMON /ZENTRA/ ICENTR
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,NUCPOS.
      COMMON /NUCPOS/INVVP(248),INVVT(248),INVSP(248),INVST(248), NUVV,
     +NUVS,NUSV,NUSS,INSVP(248),INSVT(248),INSSP(248),INSST(248), ISVEAP
     +(248),ISVEAT(248),ISSEAP(248),ISSEAT(248), IVSEAP(248),IVSEAT
     +(248), ISLOSP(248),ISLOST(248),INOOP(248),INOOT(248),NUOO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
      COMMON /EVAPPP/IEVAP
*KEEP,RTAR.
      COMMON /RTAR/ RTARNU
*KEEP,INNU.
      COMMON /INNU/INUDEC
*KEEP,HADTHR.
      COMMON /HADTHR/ EHADTH,INTHAD
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEND.
      COMMON /DIFFRA/ ISINGD,IDIFTP,IOUDIF,IFLAGD
*
      LOGICAL LSEADI
      COMMON /SEADIQ/ LSEADI
      COMMON /EVFLAG/NUMEV
      COMMON /DIQUAX/AMEDD,IDIQUA,IDIQUU
C
C-----------------------------------------------------------------------
C     PARAMETER (INTMX=2488)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
*KEEP,ABRSS.
C     INCLUDE (ABRSS)
      COMMON /ABRSS/ AMCSS1(INTMX),AMCSS2(INTMX), GACSS1(INTMX),GACSS2
     +(INTMX), BGXSS1(INTMX),BGYSS1(INTMX),BGZSS1(INTMX), BGXSS2(INTMX),
     +BGYSS2(INTMX),BGZSS2(INTMX), NCHSS1(INTMX),NCHSS2(INTMX), IJCSS1
     +(INTMX),IJCSS2(INTMX), PQSSA1(INTMX,4),PQSSA2(INTMX,4), PQSSB1
     +(INTMX,4),PQSSB2(INTMX,4)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON /NCSHXX/NCOUXH,NCOUXT
      COMMON/INTNEU/NDZSU,NZDSU
      COMMON /VXSVD/VXSP(50),VXST(50),VXSAP(50),VXSAT(50),
     *              VXVP(50),VXVT(50),VXDP(50),VXDT(50),
     *      NXSP,NXST,NXSAP,NXSAT,NXVP,NXVT,NXDP,NXDT
      COMMON /NPARTT/NPART
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      DATA NCOUSH/0/
      DATA NCOUST/0/
      DATA SUNDZ /0/
      DATA SUNZD /0/
      ANZSEA=0.D0
      ZSEASU=0.D0
      ZSEAAV=0.D0
C
      DO 5533 JJ=1,INTMX
        NCHSS1(JJ)=0
        NCHSS2(JJ)=0
 5533 CONTINUE
C                                    smoth transition between HADRIN and DPM
       EHADTW=EHADTH-RNDM(V)*2.D0
C*******************************************************************"
C
C     KINEMATICS
C
C********************************************************************
C
      IREJ = 0
*
      AAM(26)=AAM(23)
C
      KPROJ=1
      IF(IJPROJ.NE.0) KPROJ=IJPROJ
      KTARG=1
      ATNUC=IT
      ITN=IT-ITZ
      APNUC=IP
      IPN=IP-IPZ
      AMPROJ =AAM(KPROJ)
      AMTAR =AAM(KTARG)
*                             nucleon-nucleon cms
C     IBPROJ=1
      EPROJ=EPN
      PPROJ = SQRT((EPN-AMPROJ)*(EPN+AMPROJ))
      UMO = SQRT(AMPROJ**2 + AMTAR**2 + 2.*AMTAR*EPROJ)
      GAMCM = (EPROJ+AMTAR)/UMO
      BGCM=PPROJ/UMO
      ECM=UMO
      PCM=GAMCM*PPROJ - BGCM*EPROJ
C
      IF(IPEV.GE.1) PRINT 1000,IP,IPZ,IT,ITZ,IJPROJ,IBPROJ, EPROJ,PPROJ,
     +AMPROJ,AMTAR,UMO,GAMCM,BGCM
 1000 FORMAT(' ENTRY KKEVT'/ '    IP,IPZ,IT,ITZ,IJPROJ,IBPROJ',6I5/
     +'    EPROJ,PPROJ,AMPROJ,AMTAR,UMO,GAMCM,BGCM'/10E12.3)
 
C
C****                            CHANGE PARAMETERS FROM COMMON \INPDAT\
      AS=0.5
      B8=0.4
C                                CHAIN PT BIGGER THAN PARTICLE PT
      N9483=0
*  entry after rejection of an event because of kinematical reasons
*  several trials are made to realize a sampled Glauber event
   10 CONTINUE
      NDZ=0
      NZD=0
      N9483=N9483+1
      IF (MOD(N9483,125000).EQ.0) THEN
        WRITE(6,'(A,I5,A,I5,A)') ' KKEVT: Glauber event',NUMEV,
     +  ' rejected after', N9483, ' trials'
        WRITE(6, 1010) NN,NP,NT
        WRITE(6,1020) IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +  IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,
     +  IRVS13,IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
        N9483=1
        GO TO 20
      ELSEIF(N9483.GT.1) THEN
                                                                 GOTO 30
      ENDIF
 1010 FORMAT (5X,' N9483 LOOP - NN, NP, NT',5I10)
 1020 FORMAT (5X,' N9483 LOOP - REJECTION COUNTERS ',/,5I8/2(8I8/))
C
C***************************************************************
C
C     SAMPLE NUMBERS OF COLLISION A LA SHMAKOV---------------
C
C     TOTAL NUMBER OF INTERACTIONS = NN
C     NUMBER OF INTERACTING NUCLEONS
C                  FROM PROJECTILE = NP
C                  FROM TARGET = NT
C
      NCOUSH=NCOUSH+1
      NCOUXH=NCOUSH
      GO TO 2077
   20 CONTINUE
   22 CONTINUE
      NCOUST=NCOUST+1
      NCOUXT=NCOUST
 2077 CONTINUE
C     WRITE(6,*)'bSHMAKO: IP,IT,BIMP,NN,NP,NT,KKMAT',
C    * IP,IT,BIMP,NN,NP,NT,KKMAT
      CALL SHMAKO(IP,IT,BIMP,NN,NP,NT,JSSH,JTSH,PPROJ,KKMAT)
C     WRITE(6,*)'aSHMAKO: IP,IT,BIMP,NN,NP,NT ',IP,IT,BIMP,NN,NP,NT
      NPART=NP+NT
************    score characteristics of all sampled Glauber events
      CALL SHMAK(2,NN,NP,NT,IP,IT,ECM,BIMP)
      NSHMAC=NSHMAC+1
      IF ((ISINGD.GE.2).AND.((NT.NE.1).OR.(NN.NE.1))) GOTO 22
*
      IF (NN.GT.INTMX) THEN
        WRITE (6,1030)NN,NP,NT
 1030 FORMAT (' NN.GT.INTMX  SHMAKO SET TO INTMX ',3I10)
        NN=INTMX
      ENDIF
      NNSHMA=NN
      NPSHMA=NP
      NTSHMA=NT
C                    CENTRAL PRODUCTION FOR ICENTR.EQ.1 or 2
      IF (IP.LT.IT.AND.IT.LE.150)THEN
        IF(IP.LE.8)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-1)GO TO 20
        ELSEIF(IP.LE.16)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-2)GO TO 20
        ELSEIF(IP.LT.32)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-3)GO TO 20
        ELSEIF(IP.GE.32)THEN
C      Example S-Ag	
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-1)GO TO 20
        ENDIF
      ELSEIF (IP.LT.IT.AND.IT.GT.150)THEN
        IF(IP.LE.8)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-1)GO TO 20
        ELSEIF(IP.LE.16)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-2)GO TO 20
        ELSEIF(IP.LT.32)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-3)GO TO 20
        ELSEIF(IP.GE.32)THEN
C      Example S-Au	
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP)GO TO 20
        ENDIF
      ELSEIF(IP.EQ.IT)THEN
        IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.IP.EQ.32)THEN
C      Example S-S	
           IF(NP.LT.22.OR.NT.LT.22)                             GO TO 20
        ELSEIF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).
     *AND.(UMO.GT.100.).AND.(NP.LT.IP-IP/10))THEN
C      Example Pb-Pb   central like at RHIC,LHC  UMO .GT.100	
                     GO TO 20
        ELSEIF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).
     *AND.(UMO.LT.100.).AND.(NP.LT.IP-IP/4))THEN
C      Example Pb-Pb   central like at SPS umo .LT.100	
                     GO TO 20
        ELSEIF ((ICENTR.EQ.3).AND.NP.LT.IP-2*IP/3)THEN
C      Example Pb-Pb less central	
                     GO TO 20
        ENDIF
      ELSEIF(ABS(IP-IT).LT.3)THEN
        IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-IP/8)GO TO 20
      ENDIF
      BIMPAC=BIMP
C                    PERIPHERAL PRODUCTION FOR ICENTR.EQ.10
          IF (ICENTR.EQ.10.AND.NP.GT.6)                        GO TO 20
C------------------------------------------------------------
C     Drop diffractive collisions out of the Glauber
C     cascade in nucleus-nucleus collisions (For NN > 1 only)
      IF((ISINGD.LE.1).AND.(NN.GE.2).AND.(IP.GE.2).AND.(IT.GE.2).AND.
     *(IP.LE.200))THEN
        CALL DROPDI(NN,NP,NT,ECM)
        IF (IPEV.GE.3) THEN
        WRITE(6, 1040) IP,IPZ,IT,ITZ,EPROJ,PPROJ,NN,NP,NT
        WRITE (6,'(/A,2I5,1PE10.2,3I5)') ' KKEVT: IP,IT,BIMP,NN,NP,NT ',
     +  IP,IT,BIMP,NN,NP,NT
        WRITE (6,'(/2A)')
     +  ' KKEVT: JSSH(KKK),JTSH(KKK),INTER1(KKK),INTER2(KKK),',
     +  ' PKOO(3,KKK),TKOO(3,KKK)'
        ITUM=MAX(IT,IP,NN)
        DO 4011 KKK=1,ITUM
          WRITE (6,'(4I5,6(1PE11.3))') JSSH(KKK),JTSH(KKK),INTER1(KKK),
     +    INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),PKOO(3,KKK), TKOO(1,KKK),
     +    TKOO(2,KKK),TKOO(3,KKK)
 4011   CONTINUE
        ENDIF
      ENDIF
************    score characteristics of all sampled Glauber events
      CALL SHMAK1(2,NN,NP,NT,IP,IT,ECM,BIMP)
      NSHMA2=NSHMA2+1
C------------------------------------------------------------
C
*  entry for repeated trial to realize a sampled Glauber event
   30 CONTINUE
      IF (IPEV.GE.3) THEN
        WRITE(6, 1040) IP,IPZ,IT,ITZ,EPROJ,PPROJ,NN,NP,NT
 1040 FORMAT ('   752 FORM ',4I10,2F10.3,5I10)
        WRITE (6,'(/A,2I5,1PE10.2,3I5)') ' KKEVT: IP,IT,BIMP,NN,NP,NT ',
     +  IP,IT,BIMP,NN,NP,NT
        WRITE (6,'(/2A)')
     +  ' KKEVT: JSSH(KKK),JTSH(KKK),INTER1(KKK),INTER2(KKK),',
     +  ' PKOO(3,KKK),TKOO(3,KKK)'
        ITUM=MAX(IT,IP,NN)
        DO 40 KKK=1,ITUM
          WRITE (6,'(4I5,6(1PE11.3))') JSSH(KKK),JTSH(KKK),INTER1(KKK),
     +    INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),PKOO(3,KKK), TKOO(1,KKK),
     +    TKOO(2,KKK),TKOO(3,KKK)
 
   40   CONTINUE
      ENDIF
C
C-----------------------------------------------------------------------
C                  STORE PROJECTILE HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING PROJECTILES ISTHKK=11
C                              NONINTERACTING ...      ISTHKK=13
C                            - FERMI MOMENTA IN CORRESP. REST SYSTEM
C-----------
      NHKK=0
C
      NCPP=0
      NCPN=0
C                      DEFINE FERMI MOMENTA/ENERGIES FOR PROJECTILE
C
      PXFE=0.0
      PYFE=0.0
      PZFE=0.0
      DO 50 KKK=1,IP
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IF (JSSH(KKK).GT.0) THEN
          ISTHKK(NHKK)=11
        ELSE
          ISTHKK(NHKK)=13
        ENDIF
C*
C                                       CHANGED 28.2.90.J.R.
C       IF(IJPROJ.EQ.0) THEN
        IF(IP.GE.2) THEN
C
          FRPNEU=FLOAT(IPN)/APNUC
          SAMTES=RNDM(v)
          IF(SAMTES.LT.FRPNEU.AND.NCPN.LT.IPN) THEN
            KPROJ=8
            NCPN=NCPN + 1
          ELSEIF(SAMTES.GE.FRPNEU.AND.NCPP.LT.IPZ) THEN
            KPROJ=1
            NCPP=NCPP + 1
          ELSEIF(NCPN.LT.IPN) THEN
            KPROJ=8
            NCPN=NCPN + 1
          ELSEIF(NCPP.LT.IPZ) THEN
            KPROJ=1
            NCPP=NCPP + 1
          ENDIF
C
          IF(KPROJ.EQ.1) THEN
            PFERM = PRMFEP
          ELSE
            PFERM = PRMFEN
          ENDIF
C         CALL FER4M(PFERM,FPX,FPY,FPZ,FE,KPROJ)
          CALL FER4MP(IP,PFERM,FPX,FPY,FPZ,FE,KPROJ)
          PXFE=PXFE + FPX
          PYFE=PYFE + FPY
          PZFE=PZFE + FPZ
          PHKK(1,NHKK)=FPX
          PHKK(2,NHKK)=FPY
          PHKK(3,NHKK)=FPZ
          PHKK(4,NHKK)=FE
          PHKK(5,NHKK)=AAM(KPROJ)
C
        ELSE
          KPROJ=IJPROJ
          PHKK(1,NHKK)=0.
          PHKK(2,NHKK)=0.
          PHKK(3,NHKK)=0.
          PHKK(4,NHKK)=AAM(KPROJ)
          PHKK(5,NHKK)=AAM(KPROJ)
        ENDIF
C
        KKPROJ(KKK)=KPROJ
        IDHKK(NHKK)=MPDGHA(KPROJ)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
C
        PHKK(5,NHKK)=AAM(KPROJ)
        VHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        VHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        WHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNP(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1050 FORMAT (I6,I4,5I6,9E10.2)
C
   50 CONTINUE
C                          balance Sampled Fermi momenta
      IF(IP.GE.2) THEN
        PXFE=PXFE/IP
        PYFE=PYFE/IP
        PZFE=PZFE/IP
        DO 60 KKK=1,IP
          IHKK=KKK
          PHKK(1,IHKK)=PHKK(1,IHKK) - PXFE
          PHKK(2,IHKK)=PHKK(2,IHKK) - PYFE
          PHKK(3,IHKK)=PHKK(3,IHKK) - PZFE
          PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)** 2+ PHKK(1,IHKK)** 2+ PHKK
     +    (2,IHKK)** 2+ PHKK(3,IHKK)**2)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
   60   CONTINUE
      ENDIF
C
C-----------------------------------------------------------------------
C                  STORE TARGET HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING TARGETS     ISTHKK=12
C                              NONINTERACTING ...      ISTHKK=14
C-----------
C---------------------
      NHADRI=0
      NCTP=0
      NCTN=0
C
      TXFE=0.0
      TYFE=0.0
      TZFE=0.0
      DO 70 KKK=1,IT
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IF (JTSH(KKK).GT.0) THEN
          ISTHKK(NHKK)=12
          NHADRI=NHADRI+1
          IF (NHADRI.EQ.1) IHTAWW=NHKK
          IF (EPN.LE.EHADTW) THEN
            IF (NHADRI.GT.1) ISTHKK(NHKK)=14
          ENDIF
        ELSE
          ISTHKK(NHKK)=14
        ENDIF
        IF(IT.GE.2)THEN
        FRTNEU=FLOAT(ITN)/ATNUC
        SAMTES=RNDM(V)
        IF(SAMTES.LT.FRTNEU.AND.NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(SAMTES.GE.FRTNEU.AND.NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ELSEIF(NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ENDIF
C
        IF(KTARG.EQ.1) THEN
          PFERM = TAMFEP
        ELSE
          PFERM = TAMFEN
        ENDIF
C       CALL FER4M(PFERM,FPX,FPY,FPZ,FE,KTARG)
        CALL FER4MT(IT,PFERM,FPX,FPY,FPZ,FE,KTARG)
        TXFE=TXFE + FPX
        TYFE=TYFE + FPY
        TZFE=TZFE + FPZ
        PHKK(1,NHKK)=FPX
        PHKK(2,NHKK)=FPY
        PHKK(3,NHKK)=FPZ
        PHKK(4,NHKK)=FE
        PHKK(5,NHKK)=AAM(KTARG)
        ELSE
        PHKK(1,NHKK)=0. 
        PHKK(2,NHKK)=0. 
        PHKK(3,NHKK)=0. 
        PHKK(4,NHKK)=AAM(KTARG)
        PHKK(5,NHKK)=AAM(KTARG)
        ENDIF
C
        KKTARG(KKK)=KTARG
        IDHKK(NHKK)=MPDGHA(KTARG)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        VHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        VHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        WHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNT(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
   70 CONTINUE
C                          balance Sampled Fermi momenta
      IF(IT.GE.2) THEN
        TASUMA=ITZ*AAM(1) + (IT-ITZ)*AAM(8)
        TASUBI=0.0
        TAMASU=0.0
        TXFE=TXFE/IT
        TYFE=TYFE/IT
        TZFE=TZFE/IT
        DO 80 KKK=1,IT
          IHKK=KKK + IP
          PHKK(1,IHKK)=PHKK(1,IHKK) - TXFE
          PHKK(2,IHKK)=PHKK(2,IHKK) - TYFE
          PHKK(3,IHKK)=PHKK(3,IHKK) - TZFE
          PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)** 2+ PHKK(1,IHKK)** 2+ PHKK
     +    (2,IHKK)** 2+ PHKK(3,IHKK)**2)
          ITSEC=MCIHAD(IDHKK(IHKK))
          TASUBI=TASUBI + PHKK(4,IHKK) - PHKK(5,IHKK) - TAEPOT(ITSEC)
          TAMASU=TAMASU + PHKK(4,IHKK) - TAEPOT(ITSEC)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
   80   CONTINUE
C***         definition of initial state
        TABI=-EBIND(IT,ITZ)
        TAMA=(IT-ITZ)*AAM(8) + ITZ*AAM(1) + TABI
        TAIMMA=TAMA - TAMASU
      ENDIF
C
      IF(IPEV.GT.3) THEN
        WRITE(6,'(/A/5X,A/5X,4(1PE11.3))') ' KKEVT: FERMI MOMENTA',
     +  'PRMFEP,PRMFEN, TAMFEP,TAMFEN', PRMFEP,PRMFEN, TAMFEP,TAMFEN
 
      ENDIF
C-----------------------------------------------------------------------
      IFLAGD = 0
C-----------------------------------------------------------------
C
C                                   Test j.r. 2/94
C
C----------------------------------------------------------------
	IQQDD=0
      IF(IPEV.GT.3) THEN
	WRITE(6,'(A,4I5)')' KKEVT before SDIFF',NP,NT,NN,ISINGD
      ENDIF
      IF ((NP.EQ.1).AND.(NT.EQ.1).AND.(NN.EQ.1)
C         Diffraction als for A-B collisions j.r. 2.2.99
C    &.AND.((IP.EQ.1).OR.(IT.EQ.1))
     &.AND.(EPN.GT.EHADTW))
     &   CALL SDIFF(EPROJ,PPROJ,KPROJ,NHKKH1,IQQDD)
C----------------------------------------------------------------
      IF (IFLAGD.EQ.1) RETURN
*
C----------------------------------------------------------------------
C
C********************************    SAMPLE THE X FRACTIONS
C                                    OF INTERACTING NUCLEONS / HADRONS
C
      IF (EPN.LE.EHADTW) THEN
 7107   CONTINUE
        ITTA=MCIHAD(IDHKK(IHTAWW))
      IF(IPEV.GT.1) THEN
        WRITE(6,'(A,I5,2F10.3)')' HADRIN CALL, IREJFO=',IREJFO, EHADTW
     *	,EHADTH
      ENDIF   
        CALL HADHAD(EPN,PPN,NHKKH1,IHTAWW,ITTA,IREJFO)
        IF(IREJFO.EQ.1) GO TO 7107
C                                  Transform into cms
	DO 111 I=NHKKH1+1,NHKK
	  PZNN=PHKK(3,I)
	  ENN=PHKK(4,I)
	  PHKK(3,I)=GAMCM*PZNN-BGCM*ENN
	  PHKK(4,I)=GAMCM*ENN-BGCM*PZNN
  111   CONTINUE
	
                                                           GO TO 110
      ENDIF
C-----------------------------------------------------------------------
C
C*********************  SAMPLE THE FLAVORS OF INTERACTING
C                       PROJECTILE AND TARGET HADRONS/NUCLEONS
C                       first run sea quarks
      CALL FLKSAA(NN,ECM)
C
      CALL XKSAMP(NN,ECM)
      DO 90 N=1,NSS
        INLOSS(N)=.TRUE.
   90 CONTINUE
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT ,NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD ',
     *' after XKSAMP ',
     *NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD
C
      IF (IPEV.GE.6) THEN
        ITUM=MAX0(IP,IT,NN)
        WRITE(6,'(A,I10)')' KKEVT ITUM loop limit',ITUM
        WRITE(6,'(A,2A)') ' KKEVT (AFTER XKSAMP):',
     +  ' JSSH, JSSHS, JTSH, JTSHS, INTER1, INTER2',
     +  ' PKOO(1),PKOO(2),PKOO(3), TKOO(1),TKOO(2),TKOO(3)'
        DO 100 KKK=1,ITUM
          WRITE (6,'(6I5,6(1PE11.3))') JSSH(KKK),JSSHS(KKK),JTSH(KKK),
     +    JTSHS(KKK), INTER1(KKK),INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),
     +    PKOO(3,KKK), TKOO(1,KKK),TKOO(2,KKK),TKOO(3,KKK)
 
 
  100   CONTINUE
      ENDIF
C-----------------------------------------------------------------------
C
C*********************  SAMPLE THE FLAVORS OF INTERACTING
C                       PROJECTILE AND TARGET HADRONS/NUCLEONS
C                       second run valence quarks
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT ,NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD ',
     *NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before flksam'
      CALL FLKSAM
C     IPEV=8
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after flksam'
      
 1012 FORMAT(' XKSAMP:',
     +' I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I),KKPROJ(I)')
 1022 FORMAT(I5,2E15.5,2I5,L5,I5)
 1032 FORMAT(' XKSAMP :  I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)')
 1042 FORMAT(I5,2E15.5,I5,L5)
 1060 FORMAT(' XKSAMP :  I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)')
 1052 FORMAT(' XKSAMP:',
     +' I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I),KKTARG(I)')
C     COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
C    +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
C    +JHKKNT
C    +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
C    +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
C    &                MHKKHH(INTMX),
C    +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
C
      DO 511 I=1,IXPV
        IIPV=1+XPVQ(I)/0.02D0
	VXVP(IIPV)=VXVP(IIPV)+1.D0
        IIPD=1+XPVD(I)/0.02D0
	VXDP(IIPD)=VXDP(IIPD)+1.D0
	NXVP=NXVP+1
	NXDP=NXDP+1
  511 CONTINUE      
      DO 521 I=1,IXPS
        IIPS=1+XPSQ(I)/0.02D0
	VXSP(IIPS)=VXSP(IIPS)+1.D0
        IIPA=1+XPSAQ(I)/0.02D0
	VXSAP(IIPA)=VXSAP(IIPA)+1.D0
	NXSP=NXSP+1
	NXSAP=NXSAP+1
  521 CONTINUE      
      DO 531 I=1,IXTV
        IITV=1+XTVQ(I)/0.02D0
	VXVT(IITV)=VXVT(IITV)+1.D0
        IITD=1+XTVD(I)/0.02D0
	VXDT(IITD)=VXDT(IITD)+1.D0
	NXVT=NXVT+1
	NXDT=NXDT+1
  531 CONTINUE      
      DO 541 I=1,IXTS
        IITS=1+XTSQ(I)/0.02D0
	VXST(IITS)=VXST(IITS)+1.D0
        IITA=1+XTSAQ(I)/0.02D0
	VXSAT(IITA)=VXSAT(IITA)+1.D0
	NXST=NXST+1
	NXSAT=NXSAT+1
  541 CONTINUE      
      IF(IPCO.GE.1)THEN
        WRITE(6,'(A)')
     +  ' XKSAMP :  FINAL X-VALUES AFTER POTENTIAL CORRECTION'
        WRITE(6,1012)
        DO 510 I=1,IXPV
          WRITE(6,1022) I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I)
          WRITE(6,*)' I(1-IXPV),IPVQ(I),IPPV1(I),IPPV2(I)JHKKPV(I) ',
     *    I,IPVQ(I),IPPV1(I),IPPV2(I),JHKKPV(I)
  510   CONTINUE
        WRITE(6,1032)
        DO 520 I=1,IXPS
          WRITE(6,1042) I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)
          WRITE(6,*)' I(1-IXPS),IPSQ(I),IPSAQ(I ),JHKKPS(I) ',
     *    I,IPSQ(I),IPSAQ(I),JHKKPS(I)
  520   CONTINUE
        WRITE(6,1052)
        DO 530 I=1,IXTV
          WRITE(6,1022) I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I)
          WRITE(6,*)' I(1-IXTV),ITVQ(I),ITTV1(I),ITTV2(I),JHKKTV(I) ',
     *    I,ITVQ(I),ITTV1(I),ITTV2(I),JHKKTV(I)
  530   CONTINUE
        WRITE(6,1060)
        DO 540 I=1,IXTS
          WRITE(6,1042) I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)
          WRITE(6,*)' I(1-IXTS),ITSQ(I),ITSAQ(I),JHKKTS(I) ',
     *    I,ITSQ(I),ITSAQ(I),JHKKTS(I)
  540   CONTINUE
      ENDIF
      IF(IPEV.GE.6)WRITE(6,'(A,6I5)')
     *' XKSAMP NSV,NDV,NVS,NVD',
     +    NSV,NDV,NVS,NVD
C     IPEV=-1
C
C-------------------------
C                 TRANSFORM MOMENTA OF INTERACTING NUCLEONS
C                 (INCLUDING FERMI MOMENTA FROM NUCLEUS REST FRAMES)
C                 INTO NUCLEON-NUCLEON CMS (DEFINED WITHOUT FERMI MOM.
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before NUCMOM'
      DO 7745 IHKK=1,NHKK
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 7745 CONTINUE
      CALL NUCMOM
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after NUCMOM'
      NONUST=0
      NONUJT=0
      NOMJE=0
      NOMJER=0
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT ,NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD ',
     *NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD
C
C-----------------------------------------------------------------------
C
C          NOTE: THE FOLLOWING TREATMENT OF CHAIN SYSTEMS
C          ****  GENERALLY STARTS FROM THE NUCLEON-NUCLEON CMS
C                (DEFINED WITHOUT FERMI MOMENTA)
C-------------------------    TREATMENT OF SEA-SEA CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVSS, NSS',NSS
      IF(NSS.GT.0) CALL KKEVSS
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVSS'
C
C-----------------  TREATMENT OF sea diquark - sea CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVDS, NDS',NDS
C     IF(NDS.GT.0 .AND. LSEADI) THEN
      IF(NDS.GT.0) THEN
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before KKEVDS'
      IF(IDIQUA.EQ.1)  CALL KKEVDS(IREJDS)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVDS'
C       IPEV=1
        IF (IREJDS.EQ.1)                                        GO TO 10
      ENDIF
C
C
C-----------------  TREATMENT OF sea  - sea-diquark CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVSD NSD',NSD
C     IF(NSD.GT.0 .AND. LSEADI) THEN
      IF(NSD.GT.0) THEN
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before KKEVSD'
      IF(IDIQUA.EQ.1)  CALL KKEVSD(IREJSD)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVSD'
C       IPEV=1
        IF (IREJSD.EQ.1)                                        GO TO 10
      ENDIF
C
C
C-------------------------    TREATMENT OF SEA-VALENCE CHAIN SYSTEMS
C     IPEV=6
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVSV, NSV',NSV
      IF(NSV.GT.0) THEN
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before KKEVSV'
        CALL KKEVSV(IREJSV)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVSV'
C       IPEV=1
        IF (IREJSV.EQ.1)                                        GO TO 10
      ENDIF
C
C-----------------  TREATMENT OF sea diquark - VALENCE CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVDV, NDV',NDV
C     IF(NDV.GT.0 .AND. LSEADI) THEN
      IF(NDV.GT.0) THEN
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before KKEVDV'
      IF(IDIQUA.EQ.1)  CALL KKEVDV(IREJDV)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVDV'
C       IPEV=1
        IF (IREJDV.EQ.1)                                        GO TO 10
      ENDIF
C
C-------------------------    TREATMENT OF VALENCE-SEA CHAIN SYSTEMS
C     IPEV=6
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVVS, NVS',NVS
      IF(NVS.GT.0) THEN
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before KKEVVS'
        CALL KKEVVS(IREJVS)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVVS'
C       IPEV=1
        IF (IREJVS.EQ.1)                                        GO TO 10
      ENDIF
C
C-----------------  TREATMENT OF valence - sea diquark CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVVD,NVD',NVD
C     IF(NVD.GT.0 .AND. LSEADI) THEN
      IF(NVD.GT.0) THEN
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before KKEVVD'
      IF(IDIQUA.EQ.1)  CALL KKEVVD(IREJVD)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVVD'
C       IPEV=1
        IF (IREJVD.EQ.1)                                        GO TO 10
      ENDIF
C
C-------------------    TREATMENT OF VALENCE-VALENCE CHAIN SYSTEMS
C
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVVV, NVV',NVV
      CALL KKEVVV(IREJVV,IBPROJ)
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVVV'
C    &            IPVQ,IPPV1,IPPV2,ITVQ,ITTV1,ITTV2)
      IF (IREJVV.EQ.1)                                          GO TO 10
C     DO 5004 IHKK=1,NHKK
C         IF (IPHKK.GE.1) WRITE(6,5001)
C    *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
C    &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
C    &      (VHKK(KHKK,IHKK),KHKK=1,4)
C5004 CONTINUE
C

C
C-------------------    TREATMENT OF HARD CHAIN SYSTEMS
C
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVHH, NHH',NHH
      IF (IMINIJ.EQ.1) CALL KKEVHH
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVHH'
      IF(IPEV.GE.6)WRITE(6,*)' KKEVT before KKEVZZ, NZZ',NZZ
      CALL KKEVZZ
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVZZ'
      NOMJT=NOMJT+NOMJE
      NOMJTR=NOMJTR+NOMJER
      IEVI=IEVI+1
C     IF(IEVI.LE.20)WRITE (6,7233)NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
C7233 FORMAT (  '   NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR ',5I10)
        DO 7787 III=1,NONUJT
          IF (IJJQ1(III).EQ.0.OR.IJJAQ1(III).EQ.0)THEN
            WRITE (6,7786)III,JHKKEX(III),IJJQ1(III),IJJAQ1(III),
     *                    AMJCH1(III)
 7786       FORMAT(' KKEVHH: III,JHKKEX,IJJQ1,IJJAQ1,AMCH1 ',4I10,F10.3)
            JHKKEX(III)=0
          ENDIF
 7787   CONTINUE
C-------------------------------------------------------------------
C
C                        COMBINE JETS
C
C------------------------------------------------------------------
C     IF(IPEV.GE.1)WRITE(6,*)' KKEVT before KKEVCC',LCOMBI
C     IF(LCOMBI) CALL KKEVCC(NN,IP,IT)
C     IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVCC'
C----------------------------------------------------------------------
C          - TEST OF ENERGY MOMENTUM CONSERVATION ON NIVEAU OF CHAINS
C                                      AND ON NIVEAU OF CHAIN  ENDS
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before EVTEST'
C     IF(IPEV.GE.1)CALL EVTEST(IREJ)
      CALL EVTEST(IREJ)
        IF (IPEV.GE.1) THEN
        WRITE(6,'(/A/)') ' KKEVT: FINAL LIST OF ENTRIES TO /HKKEVT/'
          DO 121 IHKK=1,NHKK
          WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
  121     CONTINUE
        ENDIF
      IF (IREJ.EQ.1)THEN 
        IF(IPEV.GE.1)WRITE(6,'(A)')' EVTEST REJECTION would be '
 	IREJ=0
        IF (IREJ.EQ.1)GO TO 10
      ENDIF
      IF(IPEV.GE.1)WRITE(6,'(A)')' KKEVT after EVTEST'
C
C-----------------------------------------------------------------------
C                        CONSTRUCT HISTOGRAMS FROM PARTONS ON CHAIN ENDS
C
C     IF(IPADIS) CALL DISTPA(2)
C
C-----------------------------------------------------------------------
C               -  HADRONIZATION OF CHAINS  (HADRKK)
C                  AND BACK TRANSFORMATION FROM NN-CMS INTO LAB (HADRKK)
C
      IF(IPEV.GE.1)WRITE(6,'(A)')' KKEVT long before HADRKK'
      IF(IHADA.OR.IHADSS.OR.IHADSV.OR.IHADVS.OR.IHADVV) THEN
      IF(IPEV.GE.1)WRITE(6,'(A)')' KKEVT before HADRKK'
        CALL HADRKK(NHKKH1,PPN)
      IF(IPEV.GE.1)WRITE(6,'(A)')' KKEVT after HADRKK'
      ENDIF
C
  110 CONTINUE
C
C                           Correct HKKEVT COMMON
C                           ONLY FOR RUNS WITHOUT EVAPORATION
C     IF((IEVAP.EQ.0).AND.(KTAUGE.EQ.0))CALL CORRCO
C     not for runs with hadhad
      IF (EPN.GE.EHADTW) THEN
        CALL CORRCO
      ENDIF
C
C        Trigger ICENTR=8 NCH > 5 (NA35 p-S data)
      IIICH=0
      IF (ICENTR.EQ.8)THEN
        DO 128 IHKK=1,NHKK
	  IF(ISTHKK(IHKK).EQ.1)THEN
            NRHKK=MCIHAD(IDHKK(IHKK))
            ICHHKK=IICH(NRHKK)
            IF(ICHHKK.NE.0)THEN
C             PTT=PHKK(1,IHKK)**2+PHKK(2,IHKK)**2+0.000001
C             AMT=SQRT(PTT+PHKK(5,IHKK)**2)
C             YL=LOG((ABS(PHKK(3,IHKK) + PHKK(4,IHKK)))/AMT+1.E-18)
C             IF(YL.GT.0.6D0.AND.YL.LT.7.D0)THEN
	        IIICH=IIICH+1
C             ENDIF
	    ENDIF
	  ENDIF
  128   CONTINUE
         IF(IIICH.LE.14)THEN
          WRITE(6,*)' reject ',IIICH
          GO TO 22
	ENDIF
          WRITE(6,*)' no reject ',IIICH
      ENDIF
C
      IF (IPEV.GE.1) THEN
        WRITE(6,'(/A/)') ' KKEVT: FINAL LIST OF ENTRIES TO /HKKEVT/'
        DO 120 IHKK=1,NHKK
          WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
  120   CONTINUE
      ENDIF
C
      SUNDZ=SUNDZ+NDZ
      SUNZD=SUNZD+NZD
      NZDSU=SUNZD
      NDZSU=SUNDZ
      IF(IPEV.GE.6)WRITE(6,*)' END KKEVT NZD,NZDSU,NDZ,NDZSU',
     * NZD,NZDSU,NDZ,NDZSU
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE KKEVVV(IREJVV,NBPROJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C    &                  IPVQ,IPPV1,IPPV2,ITVQ,ITTV1,ITTV2)
C
C-------------------    TREATMENT OF VALENCE-VALENCE CHAIN SYSTEMS
C
C
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,ABRVV.
      COMMON /ABRVV/ AMCVV1(248),AMCVV2(248),GACVV1(248),GACVV2(248),
     +BGXVV1(248),BGYVV1(248),BGZVV1(248), BGXVV2(248),BGYVV2(248),
     +BGZVV2(248), NCHVV1(248),NCHVV2(248),IJCVV1(248),IJCVV2(248),
     +PQVVA1(248,4),PQVVA2(248,4), PQVVB1(248,4),PQVVB2(248,4)
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,NUCPOS.
      COMMON /NUCPOS/INVVP(248),INVVT(248),INVSP(248),INVST(248), NUVV,
     +NUVS,NUSV,NUSS,INSVP(248),INSVT(248),INSSP(248),INSST(248), ISVEAP
     +(248),ISVEAT(248),ISSEAP(248),ISSEAT(248), IVSEAP(248),IVSEAT
     +(248), ISLOSP(248),ISLOST(248),INOOP(248),INOOT(248),NUOO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
*KEEP,RTAR.
      COMMON /RTAR/ RTARNU
*KEEP,INNU.
      COMMON /INNU/INUDEC
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
*KEND.
C
C-----------------------------------------------------------------------
C     PARAMETER (INTMX=3988)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
C-----------------------------------------------------------------
C-------------------------------Single Chain Option-----------
      COMMON /SINCHA/ISICHA
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      DATA ISCH/0/
      DATA NZSEA/0/
      ISCH=ISCH+1
      ZERO=0 
C------------------------------Single Chain Option--------------------
      IREJVV=0
C
      IMINIJ=1
      DO 20 N=1,NVV
C
C---------------------------drop recombined chain pairs
        IF(NCHVV1(N).EQ.99.AND.NCHVV2(N).EQ.99)GO TO 20
C
C
C
        IXVPR=INTVV1(N)
        INUCPR=IFROVP(IXVPR)
C
        IXVTA=INTVV2(N)
        INUCTA=IFROVT(IXVTA)
C
        XMAX1=XPVQ(IXVPR)+XPVD(IXVPR)-XVTHR-XDTHR
        XMAX2=XTVQ(IXVTA)+XTVD(IXVTA)-XVTHR-XDTHR
C
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,3F9.3)')' KKEVVV,bef xptfl:n,nvv'
     *  ,N,NVV,XMAX1,XMAX2
        IF (IMINIJ.EQ.1)THEN
      	  CALL XPTFL(NHARD,NSEA,IREG,XMAX1,XMAX2)
C	  NZSEA=NZSEA+1
C	  ANZSEA=NZSEA
	  ANZSEA=ANZSEA+1.D0
	  ZSEASU=ZSEASU+NSEA
	  ZSEAAV=ZSEASU/ANZSEA
        ENDIF
        IF(IPEV.GE.1)WRITE(6,'(A,3I10)')' VV,xptfl:nhard,nsea,ireg '
     *  ,NHARD,NSEA,IREG
	IF(IREG.EQ.1)NHARD=0
	IF(IREG.EQ.1)NSEA=0
        NOMJE=NOMJE+NHARD
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1)THEN
        DO 71 IXX=NONUJ1,NONUJT
          JHKKPH(IXX)=IXVPR
          JHKKEX(IXX)=0
          JHKKE1(IXX)=0
          IF (XPVQ(IXVPR)-XJQ1(IXX).GT.XVTHR)THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=1
          ELSEIF (XPVD(IXVPR)-XJQ1(IXX).GT.XDTHR)THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=2
          ENDIF
   71   CONTINUE
        ENDIF
C
        IF(IPEV.GE.1)THEN
          PQP=GAMCM*PRMOM(3,INUCPR)+BGCM*PRMOM(4,INUCPR)
          PQE=GAMCM*PRMOM(4,INUCPR)+BGCM*PRMOM(3,INUCPR)
          PQPQ=GAMCM*PVQPZ+BGCM*PVQE
          PQEQ=GAMCM*PVQE+BGCM*PVQPZ
          PQPD=GAMCM*PVDQPZ+BGCM*PVDQE
          PQED=GAMCM*PVDQE+BGCM*PVDQPZ
        WRITE(6,1655)PRMOM(3,INUCPR),PRMOM(4,INUCPR),PQP,PQE,
     +  XPVQ(IXVPR),XPVD(IXVPR),IXVPR
        WRITE(6,1656)PVQPZ,PVQE,PQPQ,PQEQ
        WRITE(6,1657)PVDQPZ,PVDQE,PQPD,PQED
        ENDIF 
C
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1)THEN
        DO 771 IXX=NONUJ1,NONUJT
          JHKKTH(IXX)=IXVTA
          IF (JHKKE1(IXX).EQ.0)THEN
            JHKKEX(IXX)=0
            GO TO 771
          ENDIF
          IF (XTVQ(IXVTA)-XJQ2(IXX).GT. XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF(XTVD(IXVTA)-XJQ2(IXX).GT.XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSE
            JHKKEX(IXX)=0
            IF (JHKKE1(IXX).EQ.1)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XJQ1(IXX)
            ELSEIF(JHKKE1(IXX).EQ.2)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XJQ1(IXX)
            ENDIF
          ENDIF
  771   CONTINUE
        ENDIF
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        IF(IPEV.GE.1)WRITE(6,'(A,3I10)')' VV,NSEA:NONUS1,NONUST '
     * ,NSEA,NONUS1,NONUST
        DO 271 IXX=NONUS1,NONUST
          JHKKPZ(IXX)=IXVPR
          JHKKSX(IXX)=0
          JHKKS1(IXX)=0
          IF (XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XVTHR)THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=1
          ELSEIF (XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XDTHR)THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=2
          ENDIF
  271   CONTINUE
        ENDIF
C
        IXVTA=INTVV2(N)
        INUCTA=IFROVT(IXVTA)
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        DO 2771 IXX=NONUS1,NONUST
          JHKKTZ(IXX)=IXVTA
          IF (JHKKS1(IXX).EQ.0)THEN
            JHKKSX(IXX)=0
            GO TO 2775
          ENDIF
          IF (XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF(XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT.XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSE
            JHKKSX(IXX)=0
            IF (JHKKS1(IXX).EQ.1)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.2)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ENDIF
          ENDIF
 2775   CONTINUE
        IF(IPEV.GE.1)WRITE(6,'(A,3I10)')' VV,ixx:jhkksx,jhkks1, '
     * ,IXX,JHKKSX(IXX),JHKKS1(IXX)
 2771   CONTINUE
        ENDIF
Cx
C
        XMAX1=XPVQ(IXVPR)+XPVD(IXVPR)-XVTHR-XDTHR
        XMAX2=XTVQ(IXVTA)+XTVD(IXVTA)-XVTHR-XDTHR
C
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,3F9.3)')' KKEVVV,aft xptfl:n,nvv'
     *  ,N,NVV,XMAX1,XMAX2
C-----------------------------------------------------------------------
      IREJVV=0
C
C---------------------------drop recombined chain pairs
        IF(NCHVV1(N).EQ.99.AND.NCHVV2(N).EQ.99)GO TO 20
C
C***             4-MOMENTA OF PROJECTILE QUARK-DIQUARK PAIRS IN NN-CMS
        IXVPR=INTVV1(N)
        INUCPR=IFROVP(IXVPR)
C-------------------------------------Single Chain Option------
C                  NSICHA=0 : Normal 2 chain event
C                  NSICHA=1 : Single chain event
C     single chain  Meson  -Bayon  : Chain 1 ( q-qq  ) remains
C     single chain  Abaryon-Baryon : Chain 2 (aqaq-qq) remains
        NSICHA=0
        IF (ISICHA.EQ.1) THEN
          IF (NBPROJ.LE.0) THEN
C                                     Projectile particle
            IS1=INTVV1(N)
            IS2=INTVV2(N) 
            KHPROJ=KKPROJ(IS1)
C
C                                     Projectile Momentum(lab)
            PQP=GAMCM*PRMOM(3,INUCPR)+BGCM*PRMOM(4,INUCPR)
            PHPROJ=PQP
C                                     Original flavors
            IIQP=IPVQ(IS1)
            IIDP1=IPPV1(IS1)
            IIDP2=IPPV2(IS1)
            IIQT=ITVQ(IS2)
            IIDT1=ITTV1(IS2)
            IIDT2=ITTV2(IS2)
C                                    Target     particle
            IITSUM=IIQT+IIDT1+IIDT2
            IF(IITSUM.EQ.4)KHTARG=1
            IF(IITSUM.EQ.5)KHTARG=8
C           KHTARG=KKTARG(IS2)
C                                     Single chain probability  
            SICHAP=PHNSCH(KHPROJ,KHTARG,PHPROJ)
            IF (RNDM(V).LE.SICHAP)NSICHA=1
C           IF (NBPROJ.EQ.-1)NSICHA=0
C                                     Single chain quark flavors
            AAAAA=SCHQUA(JQFSC1,JQFSC2,JQBSC1,JQBSC2)
            IF(ISCH.LE.20)
     +      WRITE(6,'(A,3I5,2F10.3,10I5)')' KKEVVV Single chain ',
     +          NSICHA,KHPROJ,KHTARG,PHPROJ,SICHAP,
     +          IIQP,IIDP1,IIDP2,IIQT,IIDT1,IIDT2,
     +          JQFSC1,JQFSC2,JQBSC1,JQBSC2 
            IF(NBPROJ.EQ.0.AND.NSICHA.EQ.1)THEN
C                         Correct x-values and quark flavors
              NCHVV2(N)=99
              XPVQ(IXVPR)=XPVQ(IXVPR)+XPVD(IXVPR)
              XPVD(IXVPR)=0
              XTVD(IXVTA)=XTVD(IXVTA)+XTVQ(IXVTA)
              XTVQ(IXVTA)=0
C             IPVQ(IS1)=JQFSC1
              ITTV1(IS2)=JQBSC1
              ITTV2(IS2)=JQBSC2
            ELSEIF(NBPROJ.EQ.-1.AND.NSICHA.EQ.1)THEN
C                         Correct x-values and quark flavors
C                                                       ?
              XPVD(IXVPR)=XPVQ(IXVPR)+XPVD(IXVPR)
              XPVQ(IXVPR)=0
              XTVD(IXVTA)=XTVD(IXVTA)+XTVQ(IXVTA)
              XTVQ(IXVTA)=0
              NCHVV1(N)=99
              IPPV1(IS1)=JQFSC1
              IPPV2(IS1)=JQFSC2
              ITTV1(IS2)=JQBSC1
              ITTV2(IS2)=JQBSC2
            ENDIF         
          ENDIF 
        ENDIF
C-------------------------------------Single Chain Option------
C
        PVQPX=XPVQ(IXVPR)*PRMOM(1,INUCPR)
        PVQPY=XPVQ(IXVPR)*PRMOM(2,INUCPR)
        PVQPZ=XPVQ(IXVPR)*PRMOM(3,INUCPR)
        PVQE =XPVQ(IXVPR)*PRMOM(4,INUCPR)
C
        PVDQPX=XPVD(IXVPR)*PRMOM(1,INUCPR)
        PVDQPY=XPVD(IXVPR)*PRMOM(2,INUCPR)
        PVDQPZ=XPVD(IXVPR)*PRMOM(3,INUCPR)
        PVDQE =XPVD(IXVPR)*PRMOM(4,INUCPR)
        IF(IPEV.GE.1)THEN
          PQP=GAMCM*PRMOM(3,INUCPR)+BGCM*PRMOM(4,INUCPR)
          PQE=GAMCM*PRMOM(4,INUCPR)+BGCM*PRMOM(3,INUCPR)
          PQPQ=GAMCM*PVQPZ+BGCM*PVQE
          PQEQ=GAMCM*PVQE+BGCM*PVQPZ
          PQPD=GAMCM*PVDQPZ+BGCM*PVDQE
          PQED=GAMCM*PVDQE+BGCM*PVDQPZ
        WRITE(6,1655)PRMOM(3,INUCPR),PRMOM(4,INUCPR),PQP,PQE,
     +  XPVQ(IXVPR),XPVD(IXVPR),IXVPR
 1655     FORMAT(' vv PQP,PQE ',6F12.5,I5)
        WRITE(6,1656)PVQPZ,PVQE,PQPQ,PQEQ
 1656     FORMAT(' vv PQPQ,PQEQ ',4F12.5)
        WRITE(6,1657)PVDQPZ,PVDQE,PQPD,PQED
 1657     FORMAT(' vv PQPD,PQED ',4F12.5)
        ENDIF 
C
C***                 4-MOMENTA OF TARGET QUARK-DIQUARK PAIRS IN NN-CMS
        IXVTA=INTVV2(N)
        INUCTA=IFROVT(IXVTA)
C
        TVQPX=XTVQ(IXVTA)*TAMOM(1,INUCTA)
        TVQPY=XTVQ(IXVTA)*TAMOM(2,INUCTA)
        TVQPZ=XTVQ(IXVTA)*TAMOM(3,INUCTA)
        TVQE =XTVQ(IXVTA)*TAMOM(4,INUCTA)
 
C
        TVDQPX=XTVD(IXVTA)*TAMOM(1,INUCTA)
        TVDQPY=XTVD(IXVTA)*TAMOM(2,INUCTA)
        TVDQPZ=XTVD(IXVTA)*TAMOM(3,INUCTA)
        TVDQE =XTVD(IXVTA)*TAMOM(4,INUCTA)
        IF(IPEV.GE.1)THEN
          TQP=GAMCM*TAMOM(3,INUCTA)+BGCM*TAMOM(4,INUCTA)
          TQE=GAMCM*TAMOM(4,INUCTA)+BGCM*TAMOM(3,INUCTA)
          TQPQ=GAMCM*TVQPZ+BGCM*TVQE
          TQEQ=GAMCM*TVQE+BGCM*TVQPZ
          TQPD=GAMCM*TVDQPZ+BGCM*TVDQE
          TQED=GAMCM*TVDQE+BGCM*TVDQPZ
        WRITE(6,1455)TAMOM(3,INUCTA),TAMOM(4,INUCTA),TQP,TQE
 1455     FORMAT(' vv TQP,TQE ',4F12.5)
        WRITE(6,1456)TVQPZ,TVQE,TQPQ,TQEQ
 1456     FORMAT(' vv TQPQ,TQEQ ',4F12.5)
        WRITE(6,1457)TVDQPZ,TVDQE,TQPD,TQED
 1457     FORMAT(' vv TQPD,TQED ',4F12.5)
          WRITE(6,1355)XPVQ(IXVPR),XPVD(IXVPR),XTVQ(IXVTA),
     *          XTVD(IXVTA),PRMOM(4,INUCPR),TAMOM(4,INUCTA)
 1355     FORMAT(' VV  xpq.xpd,xtq,xtd,ep,et ',6F12.5)
        ENDIF 
C                                               j.r.6.5.93
C
C                     multiple scattering of valence quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PVQPX,PVQPY,PVQPZ,PVQE,RTIX,RTIY,RTIZ,
     *            PVQNX,PVQNY,PVQNZ,PVQNE,1)
      PVQPX=PVQNX
      PVQPY=PVQNY
      PVQPZ=PVQNZ
      PVQE=PVQNE
      CALL CROMSC(PVDQPX,PVDQPY,PVDQPZ,PVDQE,RTIX,RTIY,RTIZ,
     *            PVDQNX,PVDQNY,PVDQNZ,PVDQNE,2)
      PVDQPX=PVDQNX
      PVDQPY=PVDQNY
      PVDQPZ=PVDQNZ
      PVDQE=PVDQNE
C                                                ---------
 
C                                               j.r.6.5.93
C
C                     multiple scattering of valence quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TVQPX,TVQPY,TVQPZ,TVQE,RTIX,RTIY,RTIZ,
     *            TVQNX,TVQNY,TVQNZ,TVQNE,3)
      TVQPX=TVQNX
      TVQPY=TVQNY
      TVQPZ=TVQNZ
      TVQE=TVQNE
      CALL CROMSC(TVDQPX,TVDQPY,TVDQPZ,TVDQE,RTIX,RTIY,RTIZ,
     *            TVDQNX,TVDQNY,TVDQNZ,TVDQNE,4)
      TVDQPX=TVDQNX
      TVDQPY=TVDQNY
      TVDQPZ=TVDQNZ
      TVDQE=TVDQNE
      ENDIF
 
C                                                j.r.10.5.93
       IF(IP.GE.1)GO TO 1779
        PVQPZ2=PVQE**2-PVQPX**2-PVQPY**2
        IF(PVQPZ2.GE.0.)THEN
          PVQPZ=SQRT(PVQPZ2)
        ELSE
          PVQPX=0.
          PVQPY=0.
          PVQPZ=PVQE
        ENDIF
C
        PDQPZ2=PVDQE**2-PVDQPX**2-PVDQPY**2
        IF(PDQPZ2.GE.0.)THEN
          PVDQPZ=SQRT(PDQPZ2)
        ELSE
          PVDQPX=0.
          PVDQPY=0.
          PVDQPZ=PVDQE
        ENDIF
C
        TVQPZ2=TVQE**2-TVQPX**2-TVQPY**2
        IF(TVQPZ2.GE.0.)THEN
          TVQPZ=-SQRT(TVQPZ2)
        ELSE
          TVQPX=0.
          TVQPY=0.
          TVQPZ=TVQE
        ENDIF
C
        TDQPZ2=TVDQE**2-TVDQPX**2-TVDQPY**2
        IF(TDQPZ2.GE.0.)THEN
          TVDQPZ=-SQRT(TDQPZ2)
        ELSE
          TVDQPX=0.
          TVDQPY=0.
          TVDQPZ=PVDQE
        ENDIF
 1779  CONTINUE
C                                            ----------------
***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
C
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PVQPX
        PTXSA1=PVDQPX
        PTXSQ2=TVQPX
        PTXSA2=TVDQPX
        PTYSQ1=PVQPY
        PTYSA1=PVDQPY
        PTYSQ2=TVQPY
        PTYSA2=TVDQPY
        PLQ1=PVQPZ
        PLAQ1=PVDQPZ
        PLQ2=TVQPZ
        PLAQ2=TVDQPZ
        EQ1=PVQE
        EAQ1=PVDQE
        EQ2=TVQE
        EAQ2=TVDQE
C                                       ---------------
        IF(IPEV.GE.1) THEN
          WRITE(6,1050)  PTXSQ1,PTYSQ1,
     +    PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +    PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          BPLQ1=GAMCM*PLQ1+BGCM*EQ1
          BEQ1=GAMCM*EQ1+BGCM*PLQ1
          BPLAQ1=GAMCM*PLAQ1+BGCM*EAQ1
          BEAQ1=GAMCM*EAQ1+BGCM*PLAQ1
          BPLQ2=GAMCM*PLQ2+BGCM*EQ2
          BEQ2=GAMCM*EQ2+BGCM*PLQ2
          BPLAQ2=GAMCM*PLAQ2+BGCM*EAQ2
          BEAQ2=GAMCM*EAQ2+BGCM*PLAQ2
          WRITE(6,1050)  PTXSQ1,PTYSQ1,
     +    BPLQ1,BEQ1,PTXSA1,PTYSA1,BPLAQ1,BEAQ1,
     +     PTXSQ2,PTYSQ2,BPLQ2,BEQ2,
     +    PTXSA2,PTYSA2,BPLAQ2,BEAQ2,
     +     AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
        ENDIF
        IKVALA=1
        NSELPT=0
        IF(NSICHA.EQ.0)THEN
          IF(NBPROJ.GE.0)THEN
       IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVVV call SELPT'
            CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +       PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +       PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +       PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +       AMCH1,AMCH2,
     +       IREJ,IKVALA,PTTQ1,PTTA1,
     *       PTTQ2,PTTA2,
     +       NSELPT)
          ENDIF
          IF(NBPROJ.EQ.-1)THEN
       IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVVV call SELPT'
            CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +       PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +       PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +       PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +       AMCH1,AMCH2,
     +       IREJ,IKVALA,PTTQ1,PTTA1,
     *       PTTQ2,PTTA2,
     +       NSELPT)
          ENDIF
        ENDIF
C-------------------------------------Single Chain Option------
        IF(NSICHA.EQ.1.AND.NBPROJ.EQ.0)THEN
          CALL SELPTS( PTXSQ1,PTYSQ1,
     +        PLQ1,EQ1,PTXSA2,
     +        PTYSA2,PLAQ2,EAQ2, AMCH1,IREJ,IKVALA,PTTQ1)
        ENDIF
        IF(NSICHA.EQ.1.AND.NBPROJ.EQ.-1)THEN
          CALL SELPTS( PTXSA1,PTYSA1,
     +        PLAQ1,EAQ1,PTXSA2,
     +        PTYSA2,PLAQ2,EAQ2, AMCH2,IREJ,IKVALA,PTTA1)
        ENDIF
C-------------------------------------Single Chain Option------
        IF(IPEV.GE.1) THEN
          WRITE(6,1050)  PTXSQ1,PTYSQ1,
     +    PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +    PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
        ENDIF
C
        IF (IREJ.EQ.1) THEN
          IRVV13=IRVV13 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1100) IRVV13
            WRITE(6,1050)  PTXSQ1,
     +      PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,
     +      PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,
     +      PTTQ1,PTTA1
          ENDIF
                                                                GO TO 10
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        IF(NBPROJ.GE.0)THEN
          PTXCH1=PTXSQ1 + PTXSA2
          PTYCH1=PTYSQ1 + PTYSA2
          PTZCH1=PLQ1 + PLAQ2
          ECH1=EQ1 + EAQ2
          PTXCH2=PTXSQ2 + PTXSA1
          PTYCH2=PTYSQ2 + PTYSA1
          PTZCH2=PLQ2 + PLAQ1
          ECH2=EQ2 + EAQ1
        ENDIF
        IF(NBPROJ.EQ.-1)THEN
          PTXCH1=PTXSQ1 + PTXSQ2
          PTYCH1=PTYSQ1 + PTYSQ2
          PTZCH1=PLQ1 + PLQ2
          ECH1=EQ1 + EQ2
          PTXCH2=PTXSA2 + PTXSA1
          PTYCH2=PTYSA2 + PTYSA1
          PTZCH2=PLAQ2 + PLAQ1
          ECH2=EAQ2 + EAQ1
        ENDIF
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6)WRITE(6,1040) IREJ,
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY OCTETT OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1
C                    PROJ VAL-QUARK  - TAR DIQUARK   FOR MESONS/BARYONS
C                    PROJ VAL-AQUARK - TAR QUARK     FOR ANTIBARYONS
C
C     IF(NBPROJ.LE.100)GO TO 5559
      IF(NSICHA.EQ.0)THEN 
        IF(NBPROJ.GE.0) THEN
          CALL COBCMA(IPVQ(IXVPR),ITTV1(IXVTA),ITTV2(IXVTA), IJNCH1,
     +    NNCH1,IREJ,AMCH1,AMCH1N,1)
        ELSE
          CALL COMCMA(ITVQ(IXVTA),IPVQ(IXVPR), IJNCH1,NNCH1,IREJ,AMCH1,
     +    AMCH1N)
        ENDIF
C***                      MASS BELOW OCTETT BARYON MASS (MESON/BARYON)
C***                      MASS BELOW PSEUDOSCALAR MASS  (ANTIBARYON)
        IF(IREJ.EQ.1) THEN
          IRVV11=IRVV11 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1110) IRVV11
            WRITE(6,1060) IPVQ(IXVPR),ITTV1(IXVTA),ITTV2(IXVTA), IJNCH1,
     +      NNCH1,IREJ, XPVQ(IXVPR),XPVD(IXVPR),XPVQCM,XPVDCM, XTVQ
     +      (IXVTA),XTVD(IXVTA),AMCH1,AMCH1N
 
          ENDIF
                                                                 GOTO 10
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0) THEN
          IF(NBPROJ.GE.0) THEN
            CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N,
     +      PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +      PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +      PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +      PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1,
     +      PTXCH2,PTYCH2,PTZCH2,ECH2,IREJ)
          AMCH2=AMCH2N
          ELSE
            CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N, 
     +      PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +      PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +      PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1,
     +      PTXCH2,PTYCH2,PTZCH2,ECH2,IREJ)
            AMCH2=AMCH2N
          ENDIF
          IF(IREJ.EQ.1)THEN
	    IF(IPEV.GE.1)WRITE(6,'(A)')' vv cormom rej'
	  GO TO 10
	  ENDIF
C
          IF (IPEV.GE.1)WRITE(6,1040) IREJ,
     +    AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,
     +    ECH2
        ENDIF
C
C  SECOND FOR CHAIN 2:
C             PROJ VAL-DIQUARK  - TAR VAL-QUARK     FOR INC. BARYONS
C             PROJ VAL-AQUARK   - TAR VAL-QUARK     FOR INC. MESONS
C             PROJ VAL-ADIQUARK - TAR VAL-DIQUARK   FOR INC. ANTIBARYON
C
C	IF(NBPROJ.LE.100)GO TO 5557
        IF(NBPROJ.GT.0) THEN
          CALL COBCMA(ITVQ(IXVTA),IPPV1(IXVPR),IPPV2(IXVPR), IJNCH2,
     +    NNCH2,IREJ,AMCH2,AMCH2N,2)
        ELSEIF(NBPROJ.EQ.0) THEN
          CALL COMCMA(ITVQ(IXVTA),IPPV1(IXVPR), IJNCH2,NNCH2,IREJ,AMCH2,
     +    AMCH2N)
        ELSE
          CALL COMCM2(ITTV1(IXVTA),ITTV2(IXVTA), IPPV1(IXVPR),IPPV2
     +    (IXVPR), NNCH2,IREJ,AMCH2)
 
        ENDIF
C***                  MASS BELOW OCTETT BARYON/PSEUDOSCALAR MESON MASS
C                     OR INCONSISTENT QUARK FLAVORS FOR ANTIBARYONS
C
C5557   CONTINUE

        IF(IREJ.EQ.1) THEN
          IRVV12=IRVV12 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1120) IRVV12
            WRITE(6,1080) IPPV1(IXVPR),IPPV2(IXVPR),ITTV1(IXVTA), ITTV2
     +      (IXVTA),IJNCH2,NNCH2,IREJ, XPVQ(IXVPR),XPVD(IXVPR),XPVQCM,
     +      XPVDCM, XTVQ(IXVTA),XTVD(IXVTA),XTVQCM,XTVDCM, AMCH2,AMCH2N
          ENDIF
                                                                 GOTO 10
        ENDIF
       ENDIF
C5559   CONTINUE
       IF(NSICHA.EQ.0)THEN
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        EEE=ECH1+ECH2
        PXXX=PTXCH1+PTXCH2
        PYYY=PTYCH1+PTYCH2
        PZZZ=PTZCH1+PTZCH2
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  PPPCH1, QTXCH1,QTYCH1,QTZCH1,QECH1)
C
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH2,PTYCH2,PTZCH2,ECH2,
     +  PPPCH2, QTXCH2,QTYCH2,QTZCH2,QECH2)
C
C                                IF AMCH2 CHANGED IN COBCMA/COMCMA
C                                CORRESPONDING REPLACEMENT IN CORMOM
          NORIG=21
C	IF(NBPROJ.LE.100)GO TO 5558
          CALL CORVAL(AMMM,IREJ,AMCH1,AMCH2, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +    QTXCH2,QTYCH2,QTZCH2,QECH2,NORIG)
C5558   CONTINUE
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +  PPPCH1, PTXCH1,PTYCH1,PTZCH1,ECH1)
C
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH2,QTYCH2,QTZCH2,QECH2,
     +  PPPCH2, PTXCH2,PTYCH2,PTZCH2,ECH2)
C
C
          IF(IPEV.GE.3) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' VV - CALL CORVAL: AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ
          ENDIF
          IF(IREJ.EQ.1) THEN
	    IF(IPEV.GE.1)WRITE(6,'(A)')' vv14 rej.'
C                           AMCH1N + AMCH2N > AMMM - 0.2
C                           REJECT EVENT
            IRVV14=IRVV14+1
                                                                 GOTO 10
          ENDIF
        ENDIF
       ENDIF
       QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQVVA1(N,1)=PTXSQ1
       PQVVA1(N,2)=PTYSQ1
       PQVVA1(N,3)=PLQ1
       PQVVA1(N,4)=EQ1
       PQVVA2(N,1)=PTXSA2
       PQVVA2(N,2)=PTYSA2
       PQVVA2(N,3)=PLAQ2
       PQVVA2(N,4)=EAQ2
       PQVVB1(N,1)=PTXSQ2
       PQVVB1(N,2)=PTYSQ2
       PQVVB1(N,3)=PLQ2
       PQVVB1(N,4)=EQ2
       PQVVB2(N,1)=PTXSA1
       PQVVB2(N,2)=PTYSA1
       PQVVB2(N,3)=PLAQ1
       PQVVB2(N,4)=EAQ1
C-------------------
C                                PUT V-V CHAIN ENDS AND CHAINS
C                                                 INTO /HKKEVT/
C                                 MOMENTA IN NN-CMS
C                                 POSITION OF ORIGINAL NUCLEONS
C
C                                 FLAG FOR VV-CHAIN ENDS
C                                            PROJECTILE: ISTHKK=121
C                                            TARGET:     ISTHKK=122
C                                      FOR VV-CHAINS     ISTHKK=3
        IHKKPD=JHKKPV(IXVPR)
        IHKKPO=IHKKPD - 1
C***                                 hjm 27/08/90
        IF(NBPROJ.GE.0) THEN
          IHKKTD=JHKKTV(IXVTA)
          IHKKTO=IHKKTD - 1
        ELSE
          IHKKTO=JHKKTV(IXVTA)
          IHKKTD=IHKKTO - 1
        ENDIF
C
C
        IF (IPEV.GT.3) THEN
          WRITE(6,1000) IXVPR,INUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXVPR,INUCPR,IHKKPO,IHKKPD ',5I5)
          WRITE(6,1010) IXVTA,INUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXVTA,INUCTA,IHKKTO,IHKKTD ',5I5)
        ENDIF
C                                     CHAIN 1 PROJECTILE QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        ISTHKK(NHKK)=121
        IDHKK(NHKK)=IDHKK(IHKKPO)
        JMOHKK(1,NHKK)=IHKKPO
        JMOHKK(2,NHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,NHKK)=NHKK+2
        JDAHKK(2,NHKK)=NHKK+2
        PHKK(1,NHKK)=PQVVA1(N,1)
        PHKK(2,NHKK)=PQVVA1(N,2)
        PHKK(3,NHKK)=PQVVA1(N,3)
        PHKK(4,NHKK)=PQVVA1(N,4)
        PHKK(5,NHKK)=0.
      CALL QINNUC(XXPP,YYPP)
        VHKK(1,NHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,NHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,NHKK)=VHKK(3,IHKKPO)
        VHKK(4,NHKK)=VHKK(4,IHKKPO)
C
        IF (IPHKK.GE.2) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET DIQUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        ISTHKK(NHKK)=122
        IDHKK(NHKK)=IDHKK(IHKKTD)
        JMOHKK(1,NHKK)=IHKKTD
        JMOHKK(2,NHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,NHKK)=NHKK+1
        JDAHKK(2,NHKK)=NHKK+1
        PHKK(1,NHKK)=PQVVA2(N,1)
        PHKK(2,NHKK)=PQVVA2(N,2)
        PHKK(3,NHKK)=PQVVA2(N,3)
        PHKK(4,NHKK)=PQVVA2(N,4)
        PHKK(5,NHKK)=0.
      CALL QINNUC(XXPP,YYPP)
        VHKK(1,NHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,NHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,NHKK)=VHKK(3,IHKKTD)
        VHKK(4,NHKK)=VHKK(4,IHKKTD)
C
        IF (IPHKK.GE.2) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        ISTHKK(NHKK)=3
        IDHKK(NHKK)=88888+NNCH1
	IF(NCHVV1(N).EQ.99)IDHKK(NHKK)=77777
        JMOHKK(1,NHKK)=NHKK-2
        JMOHKK(2,NHKK)=NHKK-1
        PHKK(1,NHKK)=QTXCH1
        PHKK(2,NHKK)=QTYCH1
        PHKK(3,NHKK)=QTZCH1
        PHKK(4,NHKK)=QECH1
        PHKK(5,NHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKVV(N)=NHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (WHKK(KHKK,NHKK),KHKK=1,4)
 
        ENDIF
C
        IF (IPHKK.GE.1) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
C
C                                     CHAIN 2 PROJECTILE DIQUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        ISTHKK(NHKK)=121
        IDHKK(NHKK)=IDHKK(IHKKPD)
        JMOHKK(1,NHKK)=IHKKPD
        JMOHKK(2,NHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,NHKK)=NHKK+2
        JDAHKK(2,NHKK)=NHKK+2
        PHKK(1,NHKK)=PQVVB1(N,1)
        PHKK(2,NHKK)=PQVVB1(N,2)
        PHKK(3,NHKK)=PQVVB1(N,3)
        PHKK(4,NHKK)=PQVVB1(N,4)
        PHKK(5,NHKK)=0.
      CALL QINNUC(XXPP,YYPP)
        VHKK(1,NHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,NHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,NHKK)=VHKK(3,IHKKPD)
        VHKK(4,NHKK)=VHKK(4,IHKKPD)
C
        IF (IPHKK.GE.2) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        ISTHKK(NHKK)=122
        IDHKK(NHKK)=IDHKK(IHKKTO)
        JMOHKK(1,NHKK)=IHKKTO
        JMOHKK(2,NHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,NHKK)=NHKK+1
        JDAHKK(2,NHKK)=NHKK+1
        PHKK(1,NHKK)=PQVVB2(N,1)
        PHKK(2,NHKK)=PQVVB2(N,2)
        PHKK(3,NHKK)=PQVVB2(N,3)
        PHKK(4,NHKK)=PQVVB2(N,4)
        PHKK(5,NHKK)=0.
      CALL QINNUC(XXPP,YYPP)
        VHKK(1,NHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,NHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,NHKK)=VHKK(3,IHKKTO)
        VHKK(4,NHKK)=VHKK(4,IHKKTO)
C
        IF (IPHKK.GE.2) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        ISTHKK(NHKK)=3
        IDHKK(NHKK)=88888+NNCH2
	IF(NCHVV2(N).EQ.99)IDHKK(NHKK)=77777
        JMOHKK(1,NHKK)=NHKK-2
        JMOHKK(2,NHKK)=NHKK-1
        PHKK(1,NHKK)=QTXCH2
        PHKK(2,NHKK)=QTYCH2
        PHKK(3,NHKK)=QTZCH2
        PHKK(4,NHKK)=QECH2
        PHKK(5,NHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKVV(N)=NHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.1) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (WHKK(KHKK,NHKK),KHKK=1,4)
 
        ENDIF
C
        IF (IPHKK.GE.1) WRITE(6,1020) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
C
C  NOW WE HAVE AN ACCEPTABLE VALENCE-VALENCE EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCVV1(N)=AMCH1
        AMCVV2(N)=AMCH2
        IF(AMCH1.GT.0.D0)THEN
        GACVV1(N)=QECH1/AMCH1
        BGXVV1(N)=QTXCH1/AMCH1
        BGYVV1(N)=QTYCH1/AMCH1
        BGZVV1(N)=QTZCH1/AMCH1
        ELSE
        GACVV1(N)=0
        BGXVV1(N)=0
        BGYVV1(N)=0
        BGZVV1(N)=0
        ENDIF
        IF(AMCH2.GT.0.D0)THEN
        GACVV2(N)=QECH2/AMCH2
        BGXVV2(N)=QTXCH2/AMCH2
        BGYVV2(N)=QTYCH2/AMCH2
        BGZVV2(N)=QTZCH2/AMCH2
        ELSE
        GACVV2(N)=0
        BGXVV2(N)=0
        BGYVV2(N)=0
        BGZVV2(N)=0
        ENDIF
       IF(NSICHA.EQ.0)THEN
        NCHVV1(N)=NNCH1
        NCHVV2(N)=NNCH2
       ENDIF
C-------------------------------------Single Chain Option------
       IF(NSICHA.EQ.1.AND.IBPROJ.EQ.0)THEN
         NCHVV1(N)=0
         NCHVV2(N)=99
       ENDIF
       IF(NSICHA.EQ.1.AND.IBPROJ.EQ.-1)THEN
         NCHVV1(N)=99
         NCHVV2(N)=0
       ENDIF
C-------------------------------------Single Chain Option------
C-----------------------------------------------------------------
        IJCVV1(N)=IJNCH1
        IJCVV2(N)=IJNCH2
C
        IF (IPEV.GE.6)WRITE(6,1030) N, XPVQ(IXVPR),XPVD(IXVPR),XTVQ
     +  (IXVTA),XTVD(IXVTA), IPVQ(IXVPR),IPPV1(IXVPR),IPPV2(IXVPR), ITVQ
     +  (IXVTA),ITTV1(IXVTA),ITTV2(IXVTA), AMCVV1(N),AMCVV2(N),GACVV1
     +  (N),GACVV2(N), BGXVV1(N),BGYVV1(N),BGZVV1(N), BGXVV2(N),BGYVV2
     +  (N),BGZVV2(N), NCHVV1(N),NCHVV2(N),IJCVV1(N),IJCVV2(N), (PQVVA1
     +  (N,JU),PQVVA2(N,JU),PQVVB1(N,JU), PQVVB2(N,JU),JU=1,4)
 
 
 
 
   20 CONTINUE
C--------------------------------------------------------
      RETURN
   10   CONTINUE
C                                     EVENT REJECTED
C                                     START A NEW ONE
        IREJVV=1
      RETURN
C
 1030 FORMAT(I10,4F12.7,6I5/10X,4F12.6/10X,6F12.6,4I5/8F15.5/8F15.5)
 1040 FORMAT (' VV IREJ ',I10/
     +' AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +' AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
 1050 FORMAT(' VV',4(4E12.4/),2E12.4/2I5/4E12.4)
 1060 FORMAT(' VV',6I5/6E12.4/2E12.4)
 1070 FORMAT(' VV',5I5/2(4E12.4/),2E12.4)
 1080 FORMAT(' VV',7I5/2(4E12.4/),2E12.4)
 1090 FORMAT(' VV',4I5/6E12.4/2E12.4)
 1100 FORMAT(' KKEVT - IRVV13=',I5)
 1110 FORMAT(' KKEVT - IRVV11=',I5)
 1120 FORMAT(' KKEVT - IRVV12=',I5)
C
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE KKEVSS
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C-------------------------    TREATMENT OF SEA-SEA CHAIN SYSTEMS
C
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,ABRSS.
C     INCLUDE (ABRSS)
      COMMON /ABRSS/ AMCSS1(INTMX),AMCSS2(INTMX), GACSS1(INTMX),GACSS2
     +(INTMX), BGXSS1(INTMX),BGYSS1(INTMX),BGZSS1(INTMX), BGXSS2(INTMX),
     +BGYSS2(INTMX),BGZSS2(INTMX), NCHSS1(INTMX),NCHSS2(INTMX), IJCSS1
     +(INTMX),IJCSS2(INTMX), PQSSA1(INTMX,4),PQSSA2(INTMX,4), PQSSB1
     +(INTMX,4),PQSSB2(INTMX,4)
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
*KEND.
C===================================================================

      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
C
      XSOTHR=XSTHR
      IF(NREJEV.GE.0)XSOTHR=0.
      IMINIJ=1
C
      IF(IPEV.GE.4)WRITE(6,*)' KKEVSS:NSS ',NSS 
C-----------------------------------------------------------------------
      DO 20 N=1,NSS
C---------------------------drop recombined chain pairs
        IF(IPEV.GE.4)WRITE(6,*)' KKEVSS:NCHSS1(N),NCHSS2(N)',
     *    NCHSS1(N),NCHSS2(N)
        IF(NCHSS1(N).EQ.99.AND.NCHSS2(N).EQ.99)GO TO 20
C
C
C***                 4-MOMENTA OF PROJECTILE SEA-QUARK PAIRS IN NN-CMS
        IXSPR=INTSS1(N)
        IXSPR1=INTSS1(N+1)
        IF (N.EQ.NSS)THEN
          IF (NSS.GE.2)THEN
            IXSPR1=INTSS1(N-1)
          ELSE
            IXSPR1=IXSPR
          ENDIF
        ENDIF
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IIFROP=IFROSP(IXSPR)
        IXVPR=ITOVP(IIFROP)
C
        IXSTA=INTSS2(N)
        IIFROT=IFROST(IXSTA)
        IXVTA=ITOVT(IIFROT)
C
        XMAX1=XPSQ(IXSPR)+XPSAQ(IXSPR)+XPVQ(IXVPR)+XPVD(IXVPR)
     *        -2.D0*XSOTHR-XVTHR-XDTHR            
        XMAX2=XTSQ(IXSTA)+XTSAQ(IXSTA)+XTVQ(IXVTA)+XTVD(IXVTA)
     *        -2.D0*XSOTHR-XVTHR-XDTHR            
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,4F9.3/A,2I5,4F9.3/A,3F9.3)')
     *'IXSPR,IXVPR,XPSQ(IXSPR),XPSAQ(IXSPR),XPVQ(IXVPR),XPVD(IXVPR)'
     *,IXSPR,IXVPR,XPSQ(IXSPR),XPSAQ(IXSPR),XPVQ(IXVPR),XPVD(IXVPR),
     *'IXSTA,IXVTA,XTSQ(IXSTA),XTSAQ(IXSTA),XTVQ(IXVTA),XTVD(IXVTA)'
     *,IXSTA,IXVTA,XTSQ(IXSTA),XTSAQ(IXSTA),XTVQ(IXVTA),XTVD(IXVTA),
     *'XSOTHR,XVTHR,XDTHR'
     *,XSOTHR,XVTHR,XDTHR
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,2F9.3)')' KKEVSS,bef xptfl:n,nss'
     *  ,N,NSS,XMAX1,XMAX2
        IF (IMINIJ.EQ.1)THEN
      	  CALL XPTFL(NHARD,NSEA,IREG,XMAX1,XMAX2)
C	  NZSEA=NZSEA+1
C	  ANZSEA=NZSEA
	  ANZSEA=ANZSEA+1.D0
	  ZSEASU=ZSEASU+NSEA
	  ZSEAAV=ZSEASU/ANZSEA
        ENDIF
        IF(IPEV.GE.1)WRITE(6,'(A,3I10)')' SS,xptfl:nhard,nsea,ireg '
     *  ,NHARD,NSEA,IREG
	IF(IREG.EQ.1)NHARD=0
	IF(IREG.EQ.1)NSEA=0
C
        NOMJE=NOMJE+NHARD
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1)THEN
        DO 71 IXX=NONUJ1,NONUJT
          JHKKPH(IXX)=IXVPR
          JHKKEX(IXX)=0
          JHKKE1(IXX)=0
          IF (XPSQ(IXSPR)-XJQ1(IXX).GE.XSOTHR) THEN
            XPSQ(IXSPR)=XPSQ(IXSPR)-XJQ1(IXX)
            JHKKE1(IXX)=1
          ELSEIF (XPSAQ(IXSPR)-XJQ1(IXX).GE.XSOTHR) THEN
            XPSAQ(IXSPR)=XPSAQ(IXSPR)-XJQ1(IXX)
            JHKKE1(IXX)=2
          ELSEIF (XPSAQ(IXSPR)-XJQ1(IXX)/2..GE.XSOTHR.AND.
     *            XPSQ(IXSPR)-XJQ1(IXX)/2..GE.XSOTHR) THEN
            XPSQ(IXSPR)=XPSQ(IXSPR)-XJQ1(IXX)/2.
            XPSAQ(IXSPR)=XPSAQ(IXSPR)-XJQ1(IXX)/2.
            JHKKE1(IXX)=5
          ELSEIF (XPSQ(IXSPR1)-XJQ1(IXX).GE.XSOTHR) THEN
            XPSQ(IXSPR1)=XPSQ(IXSPR1)-XJQ1(IXX)
            JHKKE1(IXX)=6
          ELSEIF (XPSAQ(IXSPR1)-XJQ1(IXX).GE.XSOTHR) THEN
            XPSAQ(IXSPR1)=XPSAQ(IXSPR1)-XJQ1(IXX)
            JHKKE1(IXX)=7
          ELSEIF (XPSAQ(IXSPR1)-XJQ1(IXX)/2..GE.XSOTHR.AND.
     *            XPSQ(IXSPR1)-XJQ1(IXX)/2..GE.XSOTHR) THEN
            XPSQ(IXSPR1)=XPSQ(IXSPR1)-XJQ1(IXX)/2.
            XPSAQ(IXSPR1)=XPSAQ(IXSPR1)-XJQ1(IXX)/2.
            JHKKE1(IXX)=8
          ELSEIF (XPVQ(IXVPR)-XJQ1(IXX).GE.XVTHR) THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=3
          ELSEIF(XPVD(IXVPR)-XJQ1(IXX).GE.XDTHR) THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=4
          ENDIF
   71   CONTINUE
        ENDIF
C
        IXSTA=INTSS2(N)
        IXSTA1=INTSS2(N+1)
        IF (N.EQ.NSS)THEN
          IF (NSS.GE.2)THEN
            IXSTA1=INTSS2(N-1)
          ELSE
            IXSTA1=IXSTA
          ENDIF
        ENDIF
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
C
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IIFROT=IFROST(IXSTA)
        IXVTA=ITOVT(IIFROT)
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1) THEN
        DO 771 IXX=NONUJ1,NONUJT
          JHKKTH(IXX)=IXVTA
          IF(JHKKE1(IXX).EQ.0) THEN
            JHKKEX(IXX)=0
            GO TO 771
          ENDIF
          IF (XTSQ(IXSTA)-XJQ2(IXX).GE.XSOTHR) THEN
            XTSQ(IXSTA)=XTSQ(IXSTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA)-XJQ2(IXX).GE.XSOTHR) THEN
            XTSAQ(IXSTA)=XTSAQ(IXSTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA)-XJQ2(IXX)/2..GE.XSOTHR.AND.
     *            XTSQ(IXSTA)-XJQ2(IXX)/2..GE.XSOTHR) THEN
            XTSAQ(IXSTA)=XTSAQ(IXSTA)-XJQ2(IXX)/2.
            XTSQ(IXSTA)=XTSQ(IXSTA)-XJQ2(IXX)/2.
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTSQ(IXSTA1)-XJQ2(IXX).GE.XSOTHR) THEN
            XTSQ(IXSTA1)=XTSQ(IXSTA1)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA1)-XJQ2(IXX).GE.XSOTHR) THEN
            XTSAQ(IXSTA1)=XTSAQ(IXSTA1)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA1)-XJQ2(IXX)/2..GE.XSOTHR.AND.
     *            XTSQ(IXSTA1)-XJQ2(IXX)/2..GE.XSOTHR) THEN
            XTSAQ(IXSTA1)=XTSAQ(IXSTA1)-XJQ2(IXX)/2.
            XTSQ(IXSTA1)=XTSQ(IXSTA1)-XJQ2(IXX)/2.
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTVQ(IXVTA)-XJQ2(IXX).GE.XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF(XTVD(IXVTA)-XJQ2(IXX).GE.XDTHR) THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSE
            JHKKEX(IXX)=0
            IF (JHKKE1(IXX).EQ.1) THEN
              XPSQ(IXSPR)=XPSQ(IXSPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.2) THEN
              XPSAQ(IXSPR)=XPSAQ(IXSPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.3) THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.4) THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.5) THEN
              XPSQ(IXSPR)=XPSQ(IXSPR)+XJQ1(IXX)/2.
              XPSAQ(IXSPR)=XPSAQ(IXSPR)+XJQ1(IXX)/2.
            ELSEIF (JHKKE1(IXX).EQ.6) THEN
              XPSQ(IXSPR1)=XPSQ(IXSPR1)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.7) THEN
              XPSAQ(IXSPR1)=XPSAQ(IXSPR1)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.8) THEN
              XPSQ(IXSPR1)=XPSQ(IXSPR1)+XJQ1(IXX)/2.
              XPSAQ(IXSPR1)=XPSAQ(IXSPR1)+XJQ1(IXX)/2.
            ENDIF
          ENDIF
  771   CONTINUE
        ENDIF
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        DO 271 IXX=NONUS1,NONUST
          JHKKPZ(IXX)=IXVPR
          JHKKSX(IXX)=0
          JHKKS1(IXX)=0
          IF (XPSQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XVTHR)THEN
            XPSQ(IXSPR)=XPSQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=3
          ELSEIF (XPSAQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XVTHR)THEN
            XPSAQ(IXSPR)=XPSAQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=4
          ELSEIF (XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XVTHR)THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=1
          ELSEIF (XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XDTHR)THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=2
          ENDIF
  271   CONTINUE
        ENDIF
C
        INUCTA=IFROVT(IXVTA)
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        DO 2771 IXX=NONUS1,NONUST
          JHKKTZ(IXX)=IXVTA
          IF (JHKKS1(IXX).EQ.0)THEN
            JHKKSX(IXX)=0
            GO TO 2771
          ENDIF
          IF (XTSQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTSQ(IXSTA)=XTSQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTSAQ(IXSTA)=XTSAQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF (XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF(XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT.XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSE
            JHKKSX(IXX)=0
            IF (JHKKS1(IXX).EQ.1)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.2)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.3)THEN
              XPSQ(IXSPR)=XPSQ(IXSPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.4)THEN
              XPSAQ(IXSPR)=XPSAQ(IXSPR)+XSQ1(IXX)+XSAQ1(IXX)
            ENDIF
          ENDIF
 2771   CONTINUE
        ENDIF
C
C
        XMAX1=XPSQ(IXSPR)+XPSAQ(IXSPR)+XPVQ(IXVPR)+XPVD(IXVPR)
     *        -2.D0*XSOTHR-XVTHR-XDTHR            
        XMAX2=XTSQ(IXSTA)+XTSAQ(IXSTA)+XTVQ(IXVTA)+XTVD(IXVTA)
     *        -2.D0*XSOTHR-XVTHR-XDTHR            
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,4F9.3/A,2I5,4F9.3/A,3F9.3)')
     *'IXSPR,IXVPR,XPSQ(IXSPR),XPSAQ(IXSPR),XPVQ(IXVPR),XPVD(IXVPR)'
     *,IXSPR,IXVPR,XPSQ(IXSPR),XPSAQ(IXSPR),XPVQ(IXVPR),XPVD(IXVPR),
     *'IXSTA,IXVTA,XTSQ(IXSTA),XTSAQ(IXSTA),XTVQ(IXVTA),XTVD(IXVTA)'
     *,IXSTA,IXVTA,XTSQ(IXSTA),XTSAQ(IXSTA),XTVQ(IXVTA),XTVD(IXVTA),
     *'XSOTHR,XVTHR,XDTHR'
     *,XSOTHR,XVTHR,XDTHR
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,2F9.3)')' KKEVSS,aft xptfl:n,nss'
     *  ,N,NSS,XMAX1,XMAX2
C===================================================================
C-----------------------------------------------------------------------
C     DO 20 N=1,NSS
C---------------------------drop recombined chain pairs
C       IF(NCHSS1(N).EQ.99.AND.NCHSS2(N).EQ.99)GO TO 20
C***                 4-MOMENTA OF PROJECTILE SEA-QUARK PAIRS IN NN-CMS
        IXSPR=INTSS1(N)
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
C
        PSQPX=XPSQ(IXSPR)*PRMOM(1,INUCPR)
        PSQPY=XPSQ(IXSPR)*PRMOM(2,INUCPR)
        PSQPZ=XPSQ(IXSPR)*PRMOM(3,INUCPR)
        PSQE=XPSQ(IXSPR)*PRMOM(4,INUCPR)
        PSAQPX=XPSAQ(IXSPR)*PRMOM(1,INUCPR)
        PSAQPY=XPSAQ(IXSPR)*PRMOM(2,INUCPR)
        PSAQPZ=XPSAQ(IXSPR)*PRMOM(3,INUCPR)
        PSAQE=XPSAQ(IXSPR)*PRMOM(4,INUCPR)
C
C***                 4-MOMENTA OF TARGET SEA-QUARK PAIRS IN NN-CMS
        IXSTA=INTSS2(N)
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
C
        TSQPX=XTSQ(IXSTA)*TAMOM(1,INUCTA)
        TSQPY=XTSQ(IXSTA)*TAMOM(2,INUCTA)
        TSQPZ=XTSQ(IXSTA)*TAMOM(3,INUCTA)
        TSQE=XTSQ(IXSTA)*TAMOM(4,INUCTA)
        TSAQPX=XTSAQ(IXSTA)*TAMOM(1,INUCTA)
        TSAQPY=XTSAQ(IXSTA)*TAMOM(2,INUCTA)
        TSAQPZ=XTSAQ(IXSTA)*TAMOM(3,INUCTA)
        TSAQE=XTSAQ(IXSTA)*TAMOM(4,INUCTA)
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PSQPX,PSQPY,PSQPZ,PSQE,RTIX,RTIY,RTIZ,
     *            PSQNX,PSQNY,PSQNZ,PSQNE,5)
      PSQPX=PSQNX
      PSQPY=PSQNY
      PSQPZ=PSQNZ
      PSQE=PSQNE
      CALL CROMSC(PSAQPX,PSAQPY,PSAQPZ,PSAQE,RTIX,RTIY,RTIZ,
     *            PSAQNX,PSAQNY,PSAQNZ,PSAQNE,6)
      PSAQPX=PSAQNX
      PSAQPY=PSAQNY
      PSAQPZ=PSAQNZ
      PSAQE=PSAQNE
C                                                ---------
 
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TSQPX,TSQPY,TSQPZ,TSQE,RTIX,RTIY,RTIZ,
     *            TSQNX,TSQNY,TSQNZ,TSQNE,7)
      TSQPX=TSQNX
      TSQPY=TSQNY
      TSQPZ=TSQNZ
      TSQE=TSQNE
      CALL CROMSC(TSAQPX,TSAQPY,TSAQPZ,TSAQE,RTIX,RTIY,RTIZ,
     *            TSAQNX,TSAQNY,TSAQNZ,TSAQNE,8)
      TSAQPX=TSAQNX
      TSAQPY=TSAQNY
      TSAQPZ=TSAQNZ
      TSAQE=TSAQNE
      ENDIF 
C                                                j.r.10.5.93
       IF(IP.GE.1)GO TO 1779
        PSQPZ2=PSQE**2-PSQPX**2-PSQPY**2
        IF(PSQPZ2.GE.0.)THEN
          PSQPZ=SQRT(PSQPZ2)
        ELSE
          PSQPX=0.
          PSQPY=0.
          PSQPZ=PSQE
        ENDIF
C
        PAQPZ2=PSAQE**2-PSAQPX**2-PSAQPY**2
        IF(PAQPZ2.GE.0.)THEN
          PSAQPZ=SQRT(PAQPZ2)
        ELSE
          PSAQPX=0.
          PSAQPY=0.
          PSAQPZ=PSAQE
        ENDIF
C
        TSQPZ2=TSQE**2-TSQPX**2-TSQPY**2
        IF(TSQPZ2.GE.0.)THEN
          TSQPZ=-SQRT(TSQPZ2)
        ELSE
          TSQPX=0.
          TSQPY=0.
          TSQPZ=TSQE
        ENDIF
C
        TAQPZ2=TSAQE**2-TSAQPX**2-TSAQPY**2
        IF(TAQPZ2.GE.0.)THEN
          TSAQPZ=-SQRT(TAQPZ2)
        ELSE
          TSAQPX=0.
          TSAQPY=0.
          TSAQPZ=PSAQE
        ENDIF
 1779  CONTINUE
C                                                ---------
C
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PSQPX
        PTXSA1=PSAQPX
        PTXSQ2=TSQPX
        PTXSA2=TSAQPX
        PTYSQ1=PSQPY
        PTYSA1=PSAQPY
        PTYSQ2=TSQPY
        PTYSA2=TSAQPY
        PLQ1=PSQPZ
        PLAQ1=PSAQPZ
        PLQ2=TSQPZ
        PLAQ2=TSAQPZ
        EQ1=PSQE
        EAQ1=PSAQE
        EQ2=TSQE
        EAQ2=TSAQE
C                                       ---------------
          IF(IPEV.GE.1) THEN
            WRITE(6,1060) IRSS13
            WRITE(6,1070)  PTXSQ1,
     +      PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,
     +      PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,
     +      PTTQ1,PTTA1
          ENDIF
        IKVALA=0
        NSELPT=0
	IF(IP.EQ.1)NSELPT=1
       IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVSS call SELPT'
        IF(NSELPT.EQ.1)CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +  EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +  PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *       PTTQ2,PTTA2,
     +  NSELPT)
        IF(NSELPT.EQ.0)CALL SELPT4( PTXSQ1,PTYSQ1,PLQ1,
     +  EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +  PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     +  NSELPT)
          IF(IPEV.GE.1) THEN
            WRITE(6,1060) IRSS13
            WRITE(6,1070)  PTXSQ1,
     +      PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,
     +      PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,
     +      PTTQ1,PTTA1
          ENDIF
        IF (IREJ.EQ.1) THEN
          IRSS13=IRSS13 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1060) IRSS13
            WRITE(6,1070) PTXSQ1,
     +      PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,
     +      PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,
     +      PTTQ1,PTTA1
          ENDIF
                                                                GO TO 10
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSA2
        PTYCH1=PTYSQ1 + PTYSA2
        PTZCH1=PLQ1 + PLAQ2
        ECH1=EQ1 + EAQ2
        PTXCH2=PTXSQ2 + PTXSA1
        PTYCH2=PTYSQ2 + PTYSA1
        PTZCH2=PLQ2 + PLAQ1
        ECH2=EQ2 + EAQ1
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
*
        IF (IPEV.GE.6) WRITE(6,1040) IREJ,
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C      FIRST FOR CHAIN 1  (PROSQ - TARASQ,  I.E. QUARK-AQUARK)
C
        CALL COMCMA(IPSQ(IXSPR),ITSAQ(IXSTA), IJNCH1,NNCH1,IREJ,AMCH1,
     +  AMCH1N)
C***                                       MASS BELOW PSEUDOSCALAR MASS
        IF(IREJ.EQ.1) THEN
          IRSS11=IRSS11 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1080) IRSS11
            WRITE(6,1100) IPSQ(IXSPR),ITSAQ(IXSTA),IJNCH1,NNCH1,IREJ,
     +      XPSQ(IXSPR),XPSAQ(IXSPR),XPSQCM,XPSACM, XTSQ(IXSTA),XTSAQ
     +      (IXSTA),XTSQCM,XTSACM, AMCH1,AMCH1N
 
          ENDIF
                                                                 GOTO 10
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)THEN
             CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N, 
     +  PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +  PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,
     +  PLAQ2,EAQ2, PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,
     +  ECH2,IREJ)
          AMCH2=AMCH2N
        ENDIF
        IF(IREJ.EQ.1)GO TO 10
C
        IF(IPEV.GE.6)WRITE(6,1050) IREJ,
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C            SECOND FOR CHAIN 2 (PROSAQ - TARSQ,  I.E. AQUARK-QUARK)
C
        CALL COMCMA(ITSQ(IXSTA),IPSAQ(IXSPR), IJNCH2,NNCH2,IREJ,AMCH2,
     +  AMCH2N)
c  rejection of both s-s chains if mass of chain 2 too low
        IF(IREJ.EQ.1) THEN
          IRSS12=IRSS12 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1090) IRSS12
            WRITE(6,1100) IPSAQ(IXSPR),ITSQ(IXSTA),IJNCH2,NNCH2,IREJ,
     +      XPSQ(IXSPR),XPSAQ(IXSPR),XPSQCM,XPSACM, XTSQ(IXSTA),XTSAQ
     +      (IXSTA),XTSQCM,XTSACM, AMCH2,AMCH2N
 
          ENDIF
                                                                 GOTO 10
        ENDIF
C                                if AMCH2 changed in COBCMA/COMCMA
C                                CORVAL corrects chain kinematics
C                                according to 2-body kinem.
C                                with fixed masses
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        EEE=ECH1+ECH2
        PXXX=PTXCH1+PTXCH2
        PYYY=PTYCH1+PTYCH2
        PZZZ=PTZCH1+PTZCH2
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  PPPCH1, QTXCH1,QTYCH1,QTZCH1,QECH1)
C
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH2,PTYCH2,PTZCH2,ECH2,
     +  PPPCH2, QTXCH2,QTYCH2,QTZCH2,QECH2)
C
          NORIG=22
          CALL CORVAL(AMMM,IREJ,AMCH1,AMCH2, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +    QTXCH2,QTYCH2,QTZCH2,QECH2,NORIG)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
 
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +  PPPCH1, PTXCH1,PTYCH1,PTZCH1,ECH1)
C
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH2,QTYCH2,QTZCH2,QECH2,
     +  PPPCH2, PTXCH2,PTYCH2,PTZCH2,ECH2)
C
C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' SS - CALL CORVAL: AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ
            WRITE(6,1050) IREJ, AMCH1,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
          ENDIF
          IF(IREJ.EQ.1) THEN
*                           AMCH1N + AMCH2N > AMMM - 0.2
*                           reject event
            IRSS14=IRSS14+1
                                                                 GOTO 10
          ENDIF
        ENDIF
       QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQSSA1(N,1)=PTXSQ1
       PQSSA1(N,2)=PTYSQ1
       PQSSA1(N,3)=PLQ1
       PQSSA1(N,4)=EQ1
       PQSSA2(N,1)=PTXSA2
       PQSSA2(N,2)=PTYSA2
       PQSSA2(N,3)=PLAQ2
       PQSSA2(N,4)=EAQ2
       PQSSB1(N,1)=PTXSQ2
       PQSSB1(N,2)=PTYSQ2
       PQSSB1(N,3)=PLQ2
       PQSSB1(N,4)=EQ2
       PQSSB2(N,1)=PTXSA1
       PQSSB2(N,2)=PTYSA1
       PQSSB2(N,3)=PLAQ1
       PQSSB2(N,4)=EAQ1
C-------------------
 
C
C                                      PUT S-S CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
        IHKKPD=JHKKPS(IXSPR)
        IHKKPO=IHKKPD -1
        IHKKTD=JHKKTS(IXSTA)
        IHKKTO=IHKKTD - 1
        IF (IPEV.GT.3)WRITE(6,1000)IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1010)IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(2,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQSSA1(N,1)
        PHKK(2,IHKK)=PQSSA1(N,2)
        PHKK(3,IHKK)=PQSSA1(N,3)
        PHKK(4,IHKK)=PQSSA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(2,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQSSA2(N,1)
        PHKK(2,IHKK)=PQSSA2(N,2)
        PHKK(3,IHKK)=PQSSA2(N,3)
        PHKK(4,IHKK)=PQSSA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=6
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                           POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)=                VHKK(1,NHKK-1)
        VHKK(2,NHKK)=                VHKK(2,NHKK-1)
        VHKK(3,NHKK)=                VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKSS(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)=                VHKK(1,NHKK-2)
          WHKK(2,NHKK)=                VHKK(2,NHKK-2)
          WHKK(3,NHKK)=                VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C                                     CHAIN 2 PROJECTILE SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(2,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQSSB1(N,1)
        PHKK(2,IHKK)=PQSSB1(N,2)
        PHKK(3,IHKK)=PQSSB1(N,3)
        PHKK(4,IHKK)=PQSSB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(2,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQSSB2(N,1)
        PHKK(2,IHKK)=PQSSB2(N,2)
        PHKK(3,IHKK)=PQSSB2(N,3)
        PHKK(4,IHKK)=PQSSB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=6
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                            POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)=                VHKK(1,NHKK-1)
        VHKK(2,NHKK)=                VHKK(2,NHKK-1)
        VHKK(3,NHKK)=                VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKSS(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)=                VHKK(1,NHKK-2)
          WHKK(2,NHKK)=                VHKK(2,NHKK-2)
          WHKK(3,NHKK)=                VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C  NOW WE HAVE AN ACCEPTABLE SEA--SEA  EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCSS1(N)=AMCH1
        AMCSS2(N)=AMCH2
        GACSS1(N)=QECH1/AMCH1
        BGXSS1(N)=QTXCH1/AMCH1
        BGYSS1(N)=QTYCH1/AMCH1
        BGZSS1(N)=QTZCH1/AMCH1
        GACSS2(N)=QECH2/AMCH2
        BGXSS2(N)=QTXCH2/AMCH2
        BGYSS2(N)=QTYCH2/AMCH2
        BGZSS2(N)=QTZCH2/AMCH2
        NCHSS1(N)=NNCH1
        NCHSS2(N)=NNCH2
        IJCSS1(N)=IJNCH1
        IJCSS2(N)=IJNCH2
        IF (IPEV.GE.6)WRITE(6,1030)N, XPSQ(IXSPR),XPSAQ(IXSPR),XTSQ
     +  (IXSTA),XTSAQ(IXSTA), IPSQ(IXSPR),IPSAQ(IXSPR),ITSQ(IXSTA),ITSAQ
     +  (IXSTA), ITSAQ(IXSTA), AMCSS1(N),AMCSS2(N),GACSS1(N),GACSS2(N),
     +  BGXSS1(N),BGYSS1(N),BGZSS1(N), BGXSS2(N),BGYSS2(N),BGZSS2(N),
     +  NCHSS1(N),NCHSS2(N),IJCSS1(N),IJCSS2(N), (PQSSA1(N,JU),PQSSA2
     +  (N,JU),PQSSB1(N,JU), PQSSB2(N,JU),JU=1,4)
 
 
 
 
                                                                GO TO 20
C***                     TREATMENT OF REJECTED SEA-SEA INTERACTIONS
   10   CONTINUE
        INLOSS(N)=.FALSE.
        XPVD(JNUCPR)=XPVD(JNUCPR) + XPSQ(IXSPR) + XPSAQ(IXSPR)
        XTVD(JNUCTA)=XTVD(JNUCTA) + XTSAQ(IXSTA) + XTSQ(IXSTA)
   20 CONTINUE
C
 1030 FORMAT(' SS - 104', I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,4I5/8F15.
     +5/8F15.5)
 1040 FORMAT (' SS: IREJ ',I10/
     +'     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +'     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
 1050 FORMAT (' SS: IREJ  ',I10/
     +'     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +'     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
 1060 FORMAT(' KKEVSS - IRSS13=',I5)
 1070 FORMAT( ' SS - 8002',4(4E12.4/),2E12.4/2I5/4E12.4)
 1080 FORMAT(' KKEVSS - IRSS11=',I5)
 1090 FORMAT(' KKEVSS - IRSS12=',I5)
 1100 FORMAT(' SS - 8006', 5I5/2(4E12.4/),2E12.4)
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE KKEVVS(IREJVS)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C                             TREATMENT OF VALENCE-SEA CHAIN SYSTEMS
C
C---------------------------------------------------------------------
C
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,ABRVS.
      COMMON /ABRVS/ AMCVS1(248),AMCVS2(248),GACVS1(248),GACVS2(248),
     +BGXVS1(248),BGYVS1(248),BGZVS1(248), BGXVS2(248),BGYVS2(248),
     +BGZVS2(248), NCHVS1(248),NCHVS2(248),IJCVS1(248),IJCVS2(248),
     +PQVSA1(248,4),PQVSA2(248,4), PQVSB1(248,4),PQVSB2(248,4)
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,NUCPOS.
      COMMON /NUCPOS/INVVP(248),INVVT(248),INVSP(248),INVST(248), NUVV,
     +NUVS,NUSV,NUSS,INSVP(248),INSVT(248),INSSP(248),INSST(248), ISVEAP
     +(248),ISVEAT(248),ISSEAP(248),ISSEAT(248), IVSEAP(248),IVSEAT
     +(248), ISLOSP(248),ISLOST(248),INOOP(248),INOOT(248),NUOO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
*KEEP,RTAR.
      COMMON /RTAR/ RTARNU
*KEEP,INNU.
      COMMON /INNU/INUDEC
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
 
*KEND.
C===============================================================

      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      IREJVS=0
      IMINIJ=1
C
      DO 10 N=1,NVS
C---------------------------drop recombined chain pairs
        IF(NCHVS1(N).EQ.99.AND.NCHVS2(N).EQ.99)GO TO 10
C
C-----------------------------------------------------------
        IXVPR=INTVS1(N)
        INUCPR=IFROVP(IXVPR)
        JNUCPR=ITOVP(INUCPR)
C---
        IXSTA=INTVS2(N)
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
        IIFROT=IFROST(IXSTA)
        IXVTA=ITOVT(IIFROT)
C
        XMAX1=XPVQ(IXVPR)+XPVD(IXVPR)-XVTHR-XDTHR
        XMAX2=XTSQ(IXSTA)+XTSAQ(IXSTA)+XTVQ(IXVTA)+XTVD(IXVTA)
     *        -2.D0*XSTHR-XVTHR-XDTHR
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,2F9.3)')' KKEVVS,bef xptfl:n,nvs'
     *  ,N,NVS,XMAX1,XMAX2
        IF (IMINIJ.EQ.1)THEN
      	  CALL XPTFL(NHARD,NSEA,IREG,XMAX1,XMAX2)
C	  NZSEA=NZSEA+1
C	  ANZSEA=NZSEA
	  ANZSEA=ANZSEA+1.D0
	  ZSEASU=ZSEASU+NSEA
	  ZSEAAV=ZSEASU/ANZSEA
        ENDIF
        IF(IPEV.GE.1)WRITE(6,'(A,3I10)')' VS,xptfl:nhard,nsea,ireg '
     *  ,NHARD,NSEA,IREG
	IF(IREG.EQ.1)NHARD=0
	IF(IREG.EQ.1)NSEA=0
        NOMJE=NOMJE+NHARD
C
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1)THEN
        DO 71 IXX=NONUJ1,NONUJT
          JHKKPH(IXX)=IXVPR
          JHKKEX(IXX)=0
          JHKKE1(IXX)=0
          IF (XPVQ(IXVPR)-XJQ1(IXX).GE.XVTHR) THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=1
          ELSEIF(XPVD(IXVPR)-XJQ1(IXX).GE.XDTHR) THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=2
          ENDIF
   71   CONTINUE
        ENDIF
C---
        IXSTA=INTVS2(N)
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IIFROT=IFROST(IXSTA)
        IXVTA=ITOVT(IIFROT)
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1) THEN
        DO 771 IXX=NONUJ1,NONUJT
          JHKKTH(IXX)=IXVTA
          IF (JHKKE1(IXX).EQ.0)THEN
            JHKKEX(IXX)=0
            GOTO 771
          ENDIF
          IF (XTSQ(IXSTA)-XJQ2(IXX).GE.XSTHR) THEN
            XTSQ(IXSTA)=XTSQ(IXSTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA)-XJQ2(IXX).GE.XSTHR) THEN
            XTSAQ(IXSTA)=XTSAQ(IXSTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTVQ(IXVTA)-XJQ2(IXX).GE.XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTVD(IXVTA)-XJQ2(IXX).GE.XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSE
            JHKKEX(IXX)=0
            IF (JHKKE1(IXX).EQ.1)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.2)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XJQ1(IXX)
            ENDIF
          ENDIF
  771   CONTINUE
        ENDIF
C
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        DO 271 IXX=NONUS1,NONUST
          JHKKPZ(IXX)=IXVPR
          JHKKSX(IXX)=0
          JHKKS1(IXX)=0
          IF (XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XVTHR)THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=1
          ELSEIF (XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.XDTHR)THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=2
          ENDIF
  271   CONTINUE
        ENDIF
C
        INUCTA=IFROVT(IXVTA)
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        DO 2771 IXX=NONUS1,NONUST
          JHKKTZ(IXX)=IXVTA
          IF (JHKKS1(IXX).EQ.0)THEN
            JHKKSX(IXX)=0
            GO TO 2771
          ENDIF
          IF (XTSQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTSQ(IXSTA)=XTSQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF (XTSAQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTSAQ(IXSTA)=XTSAQ(IXSTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF (XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT. XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF(XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT.XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSE
            JHKKSX(IXX)=0
            IF (JHKKS1(IXX).EQ.1)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.2)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ENDIF
          ENDIF
 2771   CONTINUE
        ENDIF
C
C
        XMAX1=XPVQ(IXVPR)+XPVD(IXVPR)-XVTHR-XDTHR
        XMAX2=XTSQ(IXSTA)+XTSAQ(IXSTA)+XTVQ(IXVTA)+XTVD(IXVTA)
     *        -2.D0*XSTHR-XVTHR-XDTHR
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,2F9.3)')' KKEVVS,aft xptfl:n,nvs'
     *  ,N,NVS,XMAX1,XMAX2
        GO TO 1302
 2302   CONTINUE
C
C               TRY TO INCREASE THE X-FRACTION OF TARGET SEA QUARK
C               ANTIQUARK PAIR BY XSTHR  XTSQ(IXSTA) XTSAQ(IXSTA)
C               DECREASING TARGET DIQUARK XTVD(IXVTA)
C
C       IF(XTSUT(IXVTA).EQ.0..AND.
C    *     XTVD(IXVTA)-2.*XSTHR.GE.XDTHR) THEN
C         XTSQ(IXSTA)=XTSQ(IXSTA)+XSTHR
C         XTSAQ(IXSTA)=XTSAQ(IXSTA)+XSTHR
C         XTVD(IXVTA)=XTVD(IXVTA)-2.*XSTHR
C         IREJ=0
C       ELSE
C         GO TO 302
C         GO TO 10
C       ENDIF
 1302   CONTINUE
C===============================================================
C***          4-MOMENTA OF PROJECTILE QUARKS AND DIQUARK-PAIRS IN NN-CMS
        IXVPR=INTVS1(N)
        INUCPR=IFROVP(IXVPR)
        JNUCPR=ITOVP(INUCPR)
C
        PVQPX=XPVQ(IXVPR)*PRMOM(1,INUCPR)
        PVQPY=XPVQ(IXVPR)*PRMOM(2,INUCPR)
        PVQPZ=XPVQ(IXVPR)*PRMOM(3,INUCPR)
        PVQE=XPVQ(IXVPR)*PRMOM(4,INUCPR)
        PVDQPX=XPVD(IXVPR)*PRMOM(1,INUCPR)
        PVDQPY=XPVD(IXVPR)*PRMOM(2,INUCPR)
        PVDQPZ=XPVD(IXVPR)*PRMOM(3,INUCPR)
        PVDQE=XPVD(IXVPR)*PRMOM(4,INUCPR)
C
        IF(IPEV.GE.7) THEN
          WRITE(6,1000) PVQPX,PVQPY,PVQPZ,PVQE, PVDQPX,PVDQPY,PVDQPZ,
     +    PVDQE
 1000 FORMAT(' VS:  PVQPX,PVQPY,PVQPZ,PVQE',
     +' PVDQPX,PVDQPY,PVDQPZ,PVDQE',/4E15.5/15X,4E15.5)
        ENDIF
C
C***                 4-MOMENTA OF TARGET SEA-QUARK PAIRS IN NN-CMS
        IXSTA=INTVS2(N)
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
C
        TSQPX=XTSQ(IXSTA)*TAMOM(1,INUCTA)
        TSQPY=XTSQ(IXSTA)*TAMOM(2,INUCTA)
        TSQPZ=XTSQ(IXSTA)*TAMOM(3,INUCTA)
        TSQE=XTSQ(IXSTA)*TAMOM(4,INUCTA)
        TSAQPX=XTSAQ(IXSTA)*TAMOM(1,INUCTA)
        TSAQPY=XTSAQ(IXSTA)*TAMOM(2,INUCTA)
        TSAQPZ=XTSAQ(IXSTA)*TAMOM(3,INUCTA)
        TSAQE=XTSAQ(IXSTA)*TAMOM(4,INUCTA)
C                                               j.r.6.5.93
C
C                     multiple scattering of valence quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PVQPX,PVQPY,PVQPZ,PVQE,RTIX,RTIY,RTIZ,
     *            PVQNX,PVQNY,PVQNZ,PVQNE,9)
      PVQPX=PVQNX
      PVQPY=PVQNY
      PVQPZ=PVQNZ
      PVQE=PVQNE
      CALL CROMSC(PVDQPX,PVDQPY,PVDQPZ,PVDQE,RTIX,RTIY,RTIZ,
     *            PVDQNX,PVDQNY,PVDQNZ,PVDQNE,10)
      PVDQPX=PVDQNX
      PVDQPY=PVDQNY
      PVDQPZ=PVDQNZ
      PVDQE=PVDQNE
C                                                ---------
C
        IF(IPEV.GE.7) THEN
          WRITE(6,1010) N,NVS,IXVPR,INUCPR,INUCPR,IXSTA,INUCTA,JNUCTA
 1010 FORMAT(' VS: N,NVS,IXVPR,INUCPR,INUCPR,IXSTA,INUCTA,JNUCTA'/ 8I5)
 
          WRITE(6,1020) TSQPX,TSQPY,TSQPZ,TSQE, TSAQPX,TSAQPY,TSAQPZ,
     +    TSAQE
 1020 FORMAT(' VS:  TSQPX,TSQPY,TSQPZ,TSQE',
     +' TSAQPX,TSAQPY,TSAQPZ,TSAQE',/4E15.5/15X,4E15.5)
        ENDIF
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TSQPX,TSQPY,TSQPZ,TSQE,RTIX,RTIY,RTIZ,
     *            TSQNX,TSQNY,TSQNZ,TSQNE,11)
      TSQPX=TSQNX
      TSQPY=TSQNY
      TSQPZ=TSQNZ
      TSQE=TSQNE
      CALL CROMSC(TSAQPX,TSAQPY,TSAQPZ,TSAQE,RTIX,RTIY,RTIZ,
     *            TSAQNX,TSAQNY,TSAQNZ,TSAQNE,12)
      TSAQPX=TSAQNX
      TSAQPY=TSAQNY
      TSAQPZ=TSAQNZ
      TSAQE=TSAQNE
      ENDIF  
C                                                ---------
C                                                j.r.10.5.93
       IF(IP.GE.1)GO TO 1779
        PVQPZ2=PVQE**2-PVQPX**2-PVQPY**2
        IF(PVQPZ2.GE.0.)THEN
          PVQPZ=SQRT(PVQPZ2)
        ELSE
          PVQPX=0.
          PVQPY=0.
          PVQPZ=PVQE
        ENDIF
C
        PDQPZ2=PVDQE**2-PVDQPX**2-PVDQPY**2
        IF(PDQPZ2.GE.0.)THEN
          PVDQPZ=SQRT(PDQPZ2)
        ELSE
          PVDQPX=0.
          PVDQPY=0.
          PVDQPZ=PVDQE
        ENDIF
C
        TSQPZ2=TSQE**2-TSQPX**2-TSQPY**2
        IF(TSQPZ2.GE.0.)THEN
          TSQPZ=-SQRT(TSQPZ2)
        ELSE
          TSQPX=0.
          TSQPY=0.
          TSQPZ=TSQE
        ENDIF
C
        TAQPZ2=TSAQE**2-TSAQPX**2-TSAQPY**2
        IF(TAQPZ2.GE.0.)THEN
          TSAQPZ=-SQRT(TAQPZ2)
        ELSE
          TSAQPX=0.
          TSAQPY=0.
          TSAQPZ=TSAQE
        ENDIF
 1779  CONTINUE
C                                            ----------------
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
        IKVALA=0
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PVQPX
        PTXSA1=PVDQPX
        PTXSQ2=TSQPX
        PTXSA2=TSAQPX
        PTYSQ1=PVQPY
        PTYSA1=PVDQPY
        PTYSQ2=TSQPY
        PTYSA2=TSAQPY
        PLQ1=PVQPZ
        PLAQ1=PVDQPZ
        PLQ2=TSQPZ
        PLAQ2=TSAQPZ
        EQ1=PVQE
        EAQ1=PVDQE
        EQ2=TSQE
        EAQ2=TSAQE
C                                       ---------------
          IF(IPEV.GE.1) THEN
            WRITE(6,1140) IRVS13
            WRITE(6,1090)  PTXSQ1,
     +      PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,
     +      PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,
     +      PTTQ1,PTTA1
          ENDIF
        IKVALA=0
        NSELPT=1
        NSELPT=0
	IF(IP.EQ.1)NSELPT=1
       IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVVS call SELPT'
        IF(NSELPT.EQ.1)CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +  EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +  PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *       PTTQ2,PTTA2,
     +  NSELPT)
        IF(NSELPT.EQ.0)CALL SELPT4( PTXSQ1,PTYSQ1,PLQ1,
     +  EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +  PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     +  NSELPT)
        IF (IPEV.GE.1) WRITE(6,1070) IREJ
        IF (IREJ.EQ.1) THEN
          IRVS13=IRVS13 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1140) IRVS13
            WRITE(6,1090) PTXSQ1,
     +      PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,
     +      PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,
     +      PTTQ1,PTTA1
          ENDIF
                                                                GO TO 20
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSA2
        PTYCH1=PTYSQ1 + PTYSA2
        PTZCH1=PLQ1 + PLAQ2
        ECH1=EQ1 + EAQ2
        PTXCH2=PTXSQ2 + PTXSA1
        PTYCH2=PTYSQ2 + PTYSA1
        PTZCH2=PLQ2 + PLAQ1
        ECH2=EQ2 + EAQ1
C
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6)WRITE(6,1070) IREJ,
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ VAL-QUARK  -  TARGET SEA-AQUARK)
C
        CALL COMCMA(IPVQ(IXVPR),ITSAQ(IXSTA), IJNCH1,NNCH1,IREJ,AMCH1,
     +  AMCH1N)
C***                                       MASS BELOW PSEUDOSCALAR MASS
        IF(IREJ.EQ.1) THEN
          IRVS11=IRVS11 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1150) IRVS11
            WRITE(6,1110) IPVQ(IXVPR),ITSAQ(IXSTA),IJNCH1,NNCH1,IREJ,
     +      XPVQ(IXVPR),XPVD(IXVPR),XPVQCM,XPVDCM, XTSQ(IXSTA),XTSAQ
     +      (IXSTA),XTSQCM,XTSACM, AMCH1,AMCH1N
 
          ENDIF
                                                                 GOTO 20
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0) THEN
             CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N,
     +  PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +  PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,
     +  PLAQ2,EAQ2, PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,
     +  ECH2,IREJ)
          AMCH2=AMCH2N
        ENDIF
        IF(IREJ.EQ.1)THEN
	  IF(IPEV.EQ.1)WRITE(6,'(A)')' VS CORMOM REJECTION'
	  GO TO 20
	ENDIF
C
        IF (IPEV.GE.6)WRITE(6,1080) IREJ,
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
C
C  SECOND FOR CHAIN 2  (PROJ VAL-DIQUARK  -  TAR SEA-QUARK)
C
        CALL COBCMA(ITSQ(IXSTA),IPPV1(IXVPR),IPPV2(IXVPR), IJNCH2,NNCH2,
     +  IREJ,AMCH2,AMCH2N,2)
C***                            MASS BELOW OCTETT BARYON MASS
C
C                           AT PRESENT NO CORRECTION FOR CHAIN 2
        IF(IREJ.EQ.1) THEN
          IRVS12=IRVS12 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,1160) IRVS12
            WRITE(6,1100) IPPV1(IXVPR),IPPV2(IXVPR),ITSQ(IXSTA), IJNCH2,
     +      NNCH2,IREJ, XPVQ(IXVPR),XPVD(IXVPR),XPVQCM,XPVDCM, XTSQ
     +      (IXSTA),XTSAQ(IXSTA),AMCH2,AMCH2N
 
          ENDIF
                                                                 GOTO 20
        ENDIF
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        EEE=ECH1+ECH2
        PXXX=PTXCH1+PTXCH2
        PYYY=PTYCH1+PTYCH2
        PZZZ=PTZCH1+PTZCH2
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  PPPCH1, QTXCH1,QTYCH1,QTZCH1,QECH1)
C
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH2,PTYCH2,PTZCH2,ECH2,
     +  PPPCH2, QTXCH2,QTYCH2,QTZCH2,QECH2)
C
 
C                                if AMCH2 changed in COBCMA/COMCMA
C                                CORVAL corrects chain kinematics
C                                according to 2-body kinem.
C                                with fixed masses
           NORIG=23
          CALL CORVAL(AMMM,IREJ,AMCH1,AMCH2, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +    QTXCH2,QTYCH2,QTZCH2,QECH2,NORIG)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
C	  IREJ=1
          IF(IREJ.EQ.1) THEN
	  IF(IPEV.GE.1)WRITE(6,'(A)')' vs14 rej. '
C                           AMCH1N + AMCH2N > AMMM - 0.2
C                           REJECT EVENT
            IRVS14=IRVS14+1
                                                                 GOTO 20
          ENDIF
 
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +  PPPCH1, PTXCH1,PTYCH1,PTZCH1,ECH1)
C
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH2,QTYCH2,QTZCH2,QECH2,
     +  PPPCH2, PTXCH2,PTYCH2,PTZCH2,ECH2)
C
 
C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' VS - CALL CORVAL: AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ
            WRITE(6,1080) IREJ, AMCH1,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 
          ENDIF
C
          IF(IREJ.EQ.1) THEN
	  IF(IPEV.GE.1)WRITE(6,'(A)')' vs14 rej. '
C                           AMCH1N + AMCH2N > AMMM - 0.2
C                           REJECT EVENT
            IRVS14=IRVS14+1
                                                                 GOTO 20
          ENDIF
        ENDIF
        QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQVSA1(N,1)=PTXSQ1
       PQVSA1(N,2)=PTYSQ1
       PQVSA1(N,3)=PLQ1
       PQVSA1(N,4)=EQ1
       PQVSA2(N,1)=PTXSA2
       PQVSA2(N,2)=PTYSA2
       PQVSA2(N,3)=PLAQ2
       PQVSA2(N,4)=EAQ2
       PQVSB1(N,1)=PTXSQ2
       PQVSB1(N,2)=PTYSQ2
       PQVSB1(N,3)=PLQ2
       PQVSB1(N,4)=EQ2
       PQVSB2(N,1)=PTXSA1
       PQVSB2(N,2)=PTYSA1
       PQVSB2(N,3)=PLAQ1
       PQVSB2(N,4)=EAQ1
C-------------------
 
C
C                                      PUT V-S CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
        IHKKPD=JHKKPV(IXVPR )
        IHKKPO=JHKKPV(IXVPR )-1
        IHKKTD=JHKKTS(IXSTA )
        IHKKTO=JHKKTS(IXSTA )-1
        IF (IPEV.GT.3)WRITE(6,1030)IXVPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1030 FORMAT (' VS: IXVPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1040)IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1040 FORMAT (' VS: IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=121
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQVSA1(N,1)
        PHKK(2,IHKK)=PQVSA1(N,2)
        PHKK(3,IHKK)=PQVSA1(N,3)
        PHKK(4,IHKK)=PQVSA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1050 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQVSA2(N,1)
        PHKK(2,IHKK)=PQVSA2(N,2)
        PHKK(3,IHKK)=PQVSA2(N,3)
        PHKK(4,IHKK)=PQVSA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=5
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKVS(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (WHKK(KHKK,NHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
C
C                                     CHAIN 2 PROJECTILE DIQUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=121
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQVSB1(N,1)
        PHKK(2,IHKK)=PQVSB1(N,2)
        PHKK(3,IHKK)=PQVSB1(N,3)
        PHKK(4,IHKK)=PQVSB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQVSB2(N,1)
        PHKK(2,IHKK)=PQVSB2(N,2)
        PHKK(3,IHKK)=PQVSB2(N,3)
        PHKK(4,IHKK)=PQVSB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=5
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKVS(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C  NOW WE HAVE AN ACCEPTABLE VALENCE-SEA EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCVS1(N)=AMCH1
        AMCVS2(N)=AMCH2
        GACVS1(N)=QECH1/AMCH1
        BGXVS1(N)=QTXCH1/AMCH1
        BGYVS1(N)=QTYCH1/AMCH1
        BGZVS1(N)=QTZCH1/AMCH1
        GACVS2(N)=QECH2/AMCH2
        BGXVS2(N)=QTXCH2/AMCH2
        BGYVS2(N)=QTYCH2/AMCH2
        BGZVS2(N)=QTZCH2/AMCH2
        NCHVS1(N)=NNCH1
        NCHVS2(N)=NNCH2
        IJCVS1(N)=IJNCH1
        IJCVS2(N)=IJNCH2
        IF (IPEV.GE.6)WRITE(6,1060) N, XPVQ(IXVPR),XPVD(IXVPR),XTSQ
     +  (IXSTA),XTSAQ(IXSTA), IPVQ(IXVPR),IPPV1(IXVPR),IPPV2(IXVPR),
     +  ITSQ(IXSTA),ITSAQ(IXSTA), AMCVS1(N),AMCVS2(N),GACVS1(N),GACVS2
     +  (N), BGXVS1(N),BGYVS1(N),BGZVS1(N), BGXVS2(N),BGYVS2(N),BGZVS2
     +  (N), NCHVS1(N),NCHVS2(N),IJCVS1(N),IJCVS2(N), (PQVSA1(N,JU),
     +  PQVSA2(N,JU),PQVSB1(N,JU), PQVSB2(N,JU),JU=1,4)
 
 
 
 
   10   CONTINUE
	RETURN
   20 CONTINUE
C                                     EVENT REJECTED
C                                     START A NEW ONE
        IREJVS=1
C---------------------------------------------------------------------
C
      RETURN
C
 1060 FORMAT(I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,4I5/8F15.5/8F15.5)
 1070 FORMAT (' VS IREJ ',I10/
     +' AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +' AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
 1080 FORMAT (' VS IREJ  ',I10/
     +' AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +' AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
C
 1090 FORMAT(' VS', 4(4E12.4/),2E12.4/2I5/4E12.4)
 1100 FORMAT(' VS',6I5/6E12.4/2E12.4)
 1110 FORMAT(' VS ',5I5/2(4E12.4/),2E12.4)
 1120 FORMAT(' VS',7I5/2(4E12.4/),2E12.4)
 1130 FORMAT(' VS',4I5/6E12.4/2E12.4)
 1140 FORMAT(' KKEVT - IRVS13=',I5)
 1150 FORMAT(' KKEVT - IRVS11=',I5)
 1160 FORMAT(' KKEVT - IRVS12=',I5)
C
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE KKEVSV(IREJSV)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C-------------------------    TREATMENT OF SEA-VALENCE CHAIN SYSTEMS
C
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,ABRSV.
      COMMON /ABRSV/ AMCSV1(248),AMCSV2(248),GACSV1(248),GACSV2(248),
     +BGXSV1(248),BGYSV1(248),BGZSV1(248), BGXSV2(248),BGYSV2(248),
     +BGZSV2(248), NCHSV1(248),NCHSV2(248),IJCSV1(248),IJCSV2(248),
     +PQSVA1(248,4),PQSVA2(248,4), PQSVB1(248,4),PQSVB2(248,4)
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
*KEND.
C=============================================================

      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
C
      THMOD=1.
      IMINIJ=1
      IF(IP.GT.1)THMOD=20.
C     DO 201 N=1,NSV
C-------------------
      IREJSV=0
      IF(IPEV.GE.1)THEN
      WRITE(6,6589) NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD
 6589 FORMAT(' KKEVSV: NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD',8I5)
      ENDIF
      DO 10 N=1,NSV
C---------------------------drop recombined chain pairs
        IF(NCHSV1(N).EQ.99.OR.NCHSV2(N).EQ.99)GO TO 10
C
        IXSPR=INTSV1(N)
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
        IF(IPEV.GE.1)THEN
          PQP=GAMCM*PRMOM(3,INUCPR)+BGCM*PRMOM(4,INUCPR)
          PQE=GAMCM*PRMOM(4,INUCPR)+BGCM*PRMOM(3,INUCPR)
          PQPQ=GAMCM*PSQPZ+BGCM*PSQE
          PQEQ=GAMCM*PSQE+BGCM*PSQPZ
          PQPD=GAMCM*PSAQPZ+BGCM*PSAQE
          PQED=GAMCM*PSAQE+BGCM*PSAQPZ
        WRITE(6,1655)PRMOM(3,INUCPR),PRMOM(4,INUCPR),PQP,PQE,
     +  XPSQ(IXSPR),XPSAQ(IXSPR),IXSPR
        WRITE(6,1656)PVQPZ,PVQE,PQPQ,PQEQ
        WRITE(6,1657)PVDQPZ,PVDQE,PQPD,PQED
        ENDIF 
C
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IIFROP=IFROSP(IXSPR)
        IXVPR=ITOVP(IIFROP)
C
        IXVTA=INTSV2(N)
        INUCTA=IFROVT(IXVTA)
        JNUCTA=ITOVT(INUCTA)
C
C
        XMAX1=XPSQ(IXSPR)+XPSAQ(IXSPR)+XPVQ(IXVPR)+XPVD(IXVPR)
     *        -2.D0*XSTHR-XVTHR-XDTHR
        XMAX2=XTVQ(IXVTA)+XTVD(IXVTA)-XVTHR-XDTHR
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,2F9.3)')' KKEVSV,bef xptfl:n,nsv'
     *  ,N,NSV,XMAX1,XMAX2
        IF (IMINIJ.EQ.1)THEN
      	  CALL XPTFL(NHARD,NSEA,IREG,XMAX1,XMAX2)
C	  NZSEA=NZSEA+1
C	  ANZSEA=NZSEA
	  ANZSEA=ANZSEA+1.D0
	  ZSEASU=ZSEASU+NSEA
	  ZSEAAV=ZSEASU/ANZSEA
        ENDIF
        IF(IPEV.GE.1)WRITE(6,'(A,3I10)')' SV,xptfl:nhard,nsea,ireg '
     *  ,NHARD,NSEA,IREG
	IF(IREG.EQ.1)NHARD=0
	IF(IREG.EQ.1)NSEA=0
        NOMJE=NOMJE+NHARD
C
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1)THEN
        DO 71 IXX=NONUJ1,NONUJT
          JHKKPH(IXX)=IXVPR
          JHKKEX(IXX)=0
          JHKKE1(IXX)=0
          IF (XPSQ(IXSPR)-XJQ1(IXX).GE.THMOD*XSTHR) THEN
            XPSQ(IXSPR)=XPSQ(IXSPR)-XJQ1(IXX)
            JHKKE1(IXX)=1
          ELSEIF (XPSAQ(IXSPR)-XJQ1(IXX).GE.THMOD*XSTHR) THEN
            XPSAQ(IXSPR)=XPSAQ(IXSPR)-XJQ1(IXX)
            JHKKE1(IXX)=2
          ELSEIF (XPVQ(IXVPR)-XJQ1(IXX).GE.THMOD*XVTHR) THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=3
          ELSEIF(XPVD(IXVPR)-XJQ1(IXX).GE.THMOD*XDTHR) THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XJQ1(IXX)
            JHKKE1(IXX)=4
          ENDIF
   71   CONTINUE
        ENDIF
C
        IXVTA=INTSV2(N)
        INUCTA=IFROVT(IXVTA)
        JNUCTA=ITOVT(INUCTA)
C
C                        SUBTRACT HARD SCATTERED X VALUES FROM DIQUARKS
C
        IF (NHARD.GE.1.AND.IMINIJ.EQ.1) THEN
        DO 771 IXX=NONUJ1,NONUJT
          JHKKTH(IXX)=IXVTA
          IF (JHKKE1(IXX).EQ.0)THEN
            JHKKEX(IXX)=0
            GO TO 771
          ENDIF
          IF (XTVQ(IXVTA)-XJQ2(IXX).GE.THMOD*XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSEIF (XTVD(IXVTA)-XJQ2(IXX).GE.THMOD*XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XJQ2(IXX)
            JHKKEX(IXX)=1
            NOMJER=NOMJER+1
          ELSE
            JHKKEX(IXX)=0
            IF (JHKKE1(IXX).EQ.1)THEN
              XPSQ(IXSPR)=XPSQ(IXSPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.2)THEN
              XPSAQ(IXSPR)=XPSAQ(IXSPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.3)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XJQ1(IXX)
            ELSEIF (JHKKE1(IXX).EQ.4)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XJQ1(IXX)
            ENDIF
          ENDIF
  771   CONTINUE
        ENDIF
C
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
	IF(IPEV.GE.1)WRITE(6,'(A,2I10)')' sv: NONUS1,NONUST ',
     *	NONUS1,NONUST
        IF (NSEA.GE.1)THEN
        DO 271 IXX=NONUS1,NONUST
          JHKKPZ(IXX)=IXVPR
          JHKKSX(IXX)=0
          JHKKS1(IXX)=0
          IF (XPSQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX).GT.THMOD*XSTHR)THEN
            XPSQ(IXSPR)=XPSQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=3
          ELSEIF (XPSAQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX).GT.THMOD*XSTHR)THEN
            XPSAQ(IXSPR)=XPSAQ(IXSPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=4
          ELSEIF (XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.THMOD*XVTHR)THEN
            XPVQ(IXVPR)=XPVQ(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=1
          ELSEIF (XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX).GT.THMOD*XDTHR)THEN
            XPVD(IXVPR)=XPVD(IXVPR)-XSQ1(IXX)-XSAQ1(IXX)
            JHKKS1(IXX)=2
          ENDIF
	IF(IPEV.GE.1)WRITE(6,'(A,2I10)')' sv:JHKKS1(IXX), SX  ',
     *	JHKKS1(IXX),JHKKSX(IXX)
	IF(IPEV.GE.1)WRITE(6,'(A,I10)')' sv:IXSPR  ',
     *	IXSPR
	IF(IPEV.GE.1)WRITE(6,'(A,2F10.2)')' sv:XPSQ(IXSPR),SAQ',
     *	XPSQ(IXSPR),XPSAQ(IXSPR)
  271   CONTINUE
        ENDIF
C
        INUCTA=IFROVT(IXVTA)
C
C                        SUBTRACT SECONDARY SEA X VALUES FROM DIQUARKS
C
        IF (NSEA.GE.1)THEN
        DO 2771 IXX=NONUS1,NONUST
          JHKKTZ(IXX)=IXVTA
          IF (JHKKS1(IXX).EQ.0)THEN
            JHKKSX(IXX)=0
            GO TO 2771
          ENDIF
          IF (XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT. THMOD*XVTHR) THEN
            XTVQ(IXVTA)=XTVQ(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSEIF(XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX).GT.THMOD*XDTHR)THEN
            XTVD(IXVTA)=XTVD(IXVTA)-XSQ2(IXX)-XSAQ2(IXX)
            JHKKSX(IXX)=1
C           NOMJER=NOMJER+1
          ELSE
            JHKKSX(IXX)=0
            IF (JHKKS1(IXX).EQ.1)THEN
              XPVQ(IXVPR)=XPVQ(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.2)THEN
              XPVD(IXVPR)=XPVD(IXVPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.3)THEN
              XPSQ(IXSPR)=XPSQ(IXSPR)+XSQ1(IXX)+XSAQ1(IXX)
            ELSEIF(JHKKS1(IXX).EQ.4)THEN
              XPSAQ(IXSPR)=XPSAQ(IXSPR)+XSQ1(IXX)+XSAQ1(IXX)
            ENDIF
          ENDIF
	IF(IPEV.GE.1)WRITE(6,'(A,2I10)')' sv:JHKKS1(IXX), SX  ',
     *	JHKKS1(IXX),JHKKSX(IXX)
	IF(IPEV.GE.1)WRITE(6,'(A,2F10.2)')' sv:XPSQ(IXSPR),SAQ',
     *	XPSQ(IXSPR),XPSAQ(IXSPR)
 2771   CONTINUE
        ENDIF
C
C
        XMAX1=XPSQ(IXSPR)+XPSAQ(IXSPR)+XPVQ(IXVPR)+XPVD(IXVPR)
     *        -2.D0*XSTHR-XVTHR-XDTHR
        XMAX2=XTVQ(IXVTA)+XTVD(IXVTA)-XVTHR-XDTHR
C
        IF(IPEV.GE.1)WRITE(6,'(A,2I5,2F9.3)')' KKEVSV,aft xptfl:n,nsv'
     *  ,N,NSV,XMAX1,XMAX2
        GO TO 1202
 2202   CONTINUE
C
C                     TRY TO INCREASE X-FRACTION OF PROJECTILE SEA
C                     QUARK ANTIQUARK PAIR BY XSTHR
C                     XPSQ(IXSPR), XPSAQ(IXSPR)
C                     DECREASING VALENCE DIQUARK XPVD(IXVPR)
C
C       IF (XPSUT(IXVPR).EQ.0..AND.
C    *      XPVD(IXVPR)-2.*XSTHR.GE.XDTHR) THEN
C         XPSQ(IXSPR)=XPSQ(IXSPR)+XSTHR
C         XPSAQ(IXSPR)=XPSAQ(IXSPR)+XSTHR
C         XPVD(IXVPR)=XPVD(IXVPR)-2.*XSTHR
C         IREJ=0
C       ELSE
C         GO TO 202
C         GO TO 10
C       ENDIF
 1202   CONTINUE
C============================================================
C-------------------
C     IREJSV=0
C     IF(IPEV.GE.1)THEN
C     WRITE(6,6589) NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD
C6589 FORMAT(' KKEVSV: NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD',8I5)
C     ENDIF
C     DO 10 N=1,NSV
C---------------------------drop recombined chain pairs
C       IF(NCHSV1(N).EQ.99.OR.NCHSV2(N).EQ.99)GO TO 10
      IF(IPEV.GE.1)THEN
      WRITE(6,6588)NCHSV1(N),NCHSV2(N)
 6588 FORMAT(' NCHSV1(N),NCHSV2(N)',2I5)
      ENDIF
C
C***                 4-MOMENTA OF PROJECTILE SEA-QUARK PAIRS IN NN-CMS
        IXSPR=INTSV1(N)
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
C
        PRAMOM=SQRT(PRMOM(1,INUCPR)**2
     +  +PRMOM(2,INUCPR)**2
     +  +PRMOM(3,INUCPR)**2)
        IF(PRAMOM.EQ.0.)THEN
          XXQQ=1.
        ELSE
          XXQQ=PRMOM(4,INUCPR)/PRAMOM
        ENDIF
          XXQQ=1.
        PSQPX=XPSQ(IXSPR)*PRMOM(1,INUCPR)*XXQQ
        PSQPY=XPSQ(IXSPR)*PRMOM(2,INUCPR)*XXQQ
        PSQPZ=XPSQ(IXSPR)*PRMOM(3,INUCPR)*XXQQ
        PSQE=XPSQ(IXSPR)*PRMOM(4,INUCPR)
        PSAQPX=XPSAQ(IXSPR)*PRMOM(1,INUCPR)*XXQQ
        PSAQPY=XPSAQ(IXSPR)*PRMOM(2,INUCPR)*XXQQ
        PSAQPZ=XPSAQ(IXSPR)*PRMOM(3,INUCPR)*XXQQ
        PSAQE=XPSAQ(IXSPR)*PRMOM(4,INUCPR)
        IF(IPEV.GE.1)THEN
          PQP=GAMCM*PRMOM(3,INUCPR)+BGCM*PRMOM(4,INUCPR)
          PQE=GAMCM*PRMOM(4,INUCPR)+BGCM*PRMOM(3,INUCPR)
          PQPQ=GAMCM*PSQPZ+BGCM*PSQE
          PQEQ=GAMCM*PSQE+BGCM*PSQPZ
          PQPD=GAMCM*PSAQPZ+BGCM*PSAQE
          PQED=GAMCM*PSAQE+BGCM*PSAQPZ
C  DO III=1,200
        WRITE(6,1655)PRMOM(3,INUCPR),PRMOM(4,INUCPR),PQP,PQE,
     +  XPSQ(IXSPR),XPSAQ(IXSPR),IXSPR
C  ENDDO
 1655     FORMAT(' sv PQP,PQE ',6E12.3,I5)
C	  DO III=1,200
        WRITE(6,1656)PVQPZ,PVQE,PQPQ,PQEQ
C	  ENDDO
 1656     FORMAT(' sv PQPQ,PQEQ ',4E15.5)
C	  DO III=1,200
        WRITE(6,1657)PVDQPZ,PVDQE,PQPD,PQED
C	  ENDDO
 1657     FORMAT(' sv PQPD,PQED ',4E15.5)
        ENDIF 
C
C***                 4-MOMENTA OF TARGET QUARK-DIQUARK PAIRS IN NN-CMS
        IXVTA=INTSV2(N)
        INUCTA=IFROVT(IXVTA)
        JNUCTA=ITOVT(INUCTA)
C
        TAAMOM=SQRT(TAMOM(1,INUCPR)**2
     +  +TAMOM(2,INUCPR)**2
     +  +TAMOM(3,INUCPR)**2)
        IF(TAAMOM.EQ.0.)THEN
          XXQQ=1.
        ELSE
          XXQQ=TAMOM(4,INUCTA)/TAAMOM
        ENDIF
          XXQQ=1.
        TVQPX=XTVQ(IXVTA)*TAMOM(1,INUCTA)*XXQQ
        TVQPY=XTVQ(IXVTA)*TAMOM(2,INUCTA)*XXQQ
        TVQPZ=XTVQ(IXVTA)*TAMOM(3,INUCTA)*XXQQ
        TVQE=XTVQ(IXVTA)*TAMOM(4,INUCTA)
        TVDQPX=XTVD(IXVTA)*TAMOM(1,INUCTA)*XXQQ
        TVDQPY=XTVD(IXVTA)*TAMOM(2,INUCTA)*XXQQ
        TVDQPZ=XTVD(IXVTA)*TAMOM(3,INUCTA)*XXQQ
        TVDQE=XTVD(IXVTA)*TAMOM(4,INUCTA)
        IF(PSAQE.LT.0..OR.PSQE.LE.0..OR.TVDQE.LT.0..OR.TVQE.LT.0.)
     + THEN
C	  DO III=1,200
          WRITE(6,7799)PSQPX,PSQPY,PSQPZ,PSQE,
     +    PSAQPX,PSAQPY,PSAQPZ, PSAQE,
     +    TVQPX,TVQPY,TVQPZ,TVQE,
     +    TVDQPX,TVDQPY,TVDQPZ,TVDQE
 7799     FORMAT('PSQPX,PSQPY,PSQPZ,PSQE,PSAQPX,PSAQPY,PSAQPZ
     +    PSAQE,TVQPX,TVQPY,TVQPZ,TVQE,TVDQPX,TVDQPY,TVDQPZ,TVDQE',
     +  /4(4E15.5/))
          WRITE (6,7798)IXSPR,INUCPR,IXVTA,INUCTA,
     +     XPSQ(IXSPR),XPSAQ(IXSPR),XTVQ(IXVTA),XTVD(IXVTA),
     +     PRMOM(4,INUCPR),TAMOM(4,INUCTA)
 7798     FORMAT('IXSPR,INUCPR,IXVTA,INUCTA,
     +     XPSQ(IXSPR),XPSAQ(IXSPR),XTVQ(IXVTA),XTVD(IXVTA),
     +     PRMOM(4,INUCPR),TAMOM(4,INUCTA)'/4I10/4E15.5/2E15.5)
C	  ENDDO
        ENDIF
        IF(IPEV.GE.1)THEN
          TQP=GAMCM*TAMOM(3,INUCTA)+BGCM*TAMOM(4,INUCTA)
          TQE=GAMCM*TAMOM(4,INUCTA)+BGCM*TAMOM(3,INUCTA)
          TQPQ=GAMCM*TVQPZ+BGCM*TVQE
          TQEQ=GAMCM*TVQE+BGCM*TVQPZ
          TQPD=GAMCM*TVDQPZ+BGCM*TVDQE
          TQED=GAMCM*TVDQE+BGCM*TVDQPZ
C	  DO III=1,200
        WRITE(6,1455)TAMOM(3,INUCTA),TAMOM(4,INUCTA),TQP,TQE
 1455     FORMAT(' sv TQP,TQE ',4F12.5)
        WRITE(6,1456)TVQPZ,TVQE,TQPQ,TQEQ
 1456     FORMAT(' sv TQPQ,TQEQ ',4F12.5)
        WRITE(6,1457)TVDQPZ,TVDQE,TQPD,TQED
 1457     FORMAT(' sv TQPD,TQED ',4E15.5)
          WRITE(6,7799)PSQPX,PSQPY,PSQPZ,PSQE,
     +    PSAQPX,PSAQPY,PSAQPZ, PSAQE,
     +    TVQPX,TVQPY,TVQPZ,TVQE,
     +    TVDQPX,TVDQPY,TVDQPZ,TVDQE
          WRITE (6,7798)IXSPR,INUCPR,IXVTA,INUCTA,
     +     XPSQ(IXSPR),XPSAQ(IXSPR),XTVQ(IXVTA),XTVD(IXVTA),
     +     PRMOM(4,INUCPR),TAMOM(4,INUCTA)
C	  ENDDO
        ENDIF
C                                               j.r.6.5.93
C
C                     multiple scattering of valence quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TVQPX,TVQPY,TVQPZ,TVQE,RTIX,RTIY,RTIZ,
     *            TVQNX,TVQNY,TVQNZ,TVQNE,13)
      TVQPX=TVQNX
      TVQPY=TVQNY
      TVQPZ=TVQNZ
      TVQE=TVQNE
      CALL CROMSC(TVDQPX,TVDQPY,TVDQPZ,TVDQE,RTIX,RTIY,RTIZ,
     *            TVDQNX,TVDQNY,TVDQNZ,TVDQNE,14)
      TVDQPX=TVDQNX
      TVDQPY=TVDQNY
      TVDQPZ=TVDQNZ
      TVDQE=TVDQNE
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PSQPX,PSQPY,PSQPZ,PSQE,RTIX,RTIY,RTIZ,
     *            PSQNX,PSQNY,PSQNZ,PSQNE,15)
      PSQPX=PSQNX
      PSQPY=PSQNY
      PSQPZ=PSQNZ
      PSQE=PSQNE
      CALL CROMSC(PSAQPX,PSAQPY,PSAQPZ,PSAQE,RTIX,RTIY,RTIZ,
     *            PSAQNX,PSAQNY,PSAQNZ,PSAQNE,16)
      PSAQPX=PSAQNX
      PSAQPY=PSAQNY
      PSAQPZ=PSAQNZ
      PSAQE=PSAQNE
      ENDIF
C                                                ---------
C
C                                                j.r.10.5.93
       IF(IP.GE.1) GO TO 1779
        PSQPZ2=PSQE**2-PSQPX**2-PSQPY**2
        IF(PSQPZ2.GE.0.)THEN
          PSQPZ=SQRT(PSQPZ2)
        ELSE
          PSQPX=0.
          PSQPY=0.
          PSQPZ=PSQE
        ENDIF
C
        PSAQP2=PSAQE**2-PSAQPX**2-PSAQPY**2
        IF(PSAQP2.GE.0.)THEN
          PSAQPZ=SQRT(PSAQP2)
        ELSE
          PSAQPX=0.
          PSAQPY=0.
          PSAQPZ=PSAQE
        ENDIF
C
        TVQPZ2=TVQE**2-TVQPX**2-TVQPY**2
        IF(TVQPZ2.GE.0.)THEN
          TVQPZ=-SQRT(TVQPZ2)
        ELSE
          TVQPX=0.
          TVQPY=0.
          TVQPZ=TVQE
        ENDIF
C
        TDQPZ2=TVDQE**2-TVDQPX**2-TVDQPY**2
        IF(TDQPZ2.GE.0.)THEN
          TVDQPZ=-SQRT(TDQPZ2)
        ELSE
          TVDQPX=0.
          TVDQPY=0.
          TVDQPZ=TVDQE
        ENDIF
 1779  CONTINUE
C                                            ----------------
 
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
        IKVALA=0
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PSQPX
        PTXSA1=PSAQPX
        PTXSQ2=TVQPX
        PTXSA2=TVDQPX
        PTYSQ1=PSQPY
        PTYSA1=PSAQPY
        PTYSQ2=TVQPY
        PTYSA2=TVDQPY
        PLQ1=PSQPZ
        PLAQ1=PSAQPZ
        PLQ2=TVQPZ
        PLAQ2=TVDQPZ
        EQ1=PSQE
        EAQ1=PSAQE
        EQ2=TVQE
        EAQ2=TVDQE
C                                       ---------------
C                                       ---------------
          IF(IPEV.GE.1) THEN
C	    DO III=1,200
            WRITE(6,'(A,I5)') ' HAEVSV - IRSV13=',IRSV13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' SV:   ...',
     +       PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +      PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
            BPLQ1=GAMCM*PLQ1+BGCM*EQ1
            BEQ1=GAMCM*EQ1+BGCM*PLQ1
            BPLAQ1=GAMCM*PLAQ1+BGCM*EAQ1
            BEAQ1=GAMCM*EAQ1+BGCM*PLAQ1
            BPLQ2=GAMCM*PLQ2+BGCM*EQ2
            BEQ2=GAMCM*EQ2+BGCM*PLQ2
            BPLAQ2=GAMCM*PLAQ2+BGCM*EAQ2
            BEAQ2=GAMCM*EAQ2+BGCM*PLAQ2
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' SV:   ...',
     +       PTXSQ1,PTYSQ1,BPLQ1,BEQ1,PTXSA1,PTYSA1,
     +      BPLAQ1,BEAQ1, PTXSQ2,PTYSQ2,BPLQ2,BEQ2,
     +      PTXSA2,PTYSA2,BPLAQ2,BEAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
C	     ENDDO
          ENDIF
        IKVALA=0
        NSELPT=1
        NSELPT=0
	IF(IP.EQ.1)NSELPT=1
C	    DO III=1,200
       IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVSV call SELPT'
C	    ENDDO
        IF(NSELPT.EQ.1)CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +  EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +  PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *       PTTQ2,PTTA2,
     +  NSELPT)
        IF(NSELPT.EQ.0)CALL SELPT4( PTXSQ1,PTYSQ1,PLQ1,
     +  EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +  PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     +  NSELPT)
          IF(IPEV.GE.1) THEN
C	    DO III=1,200
             WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' SV:  ...',
     +       PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
C	    ENDDO
          ENDIF
 
        IF (IPEV.GE.1) WRITE(6,'(A/5X,I10)')
     +  'SV   ,IREJ ',
     +  IREJ
        IF (IREJ.EQ.1) THEN
          IRSV13=IRSV13 + 1
           IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' HAEVSV - IRSV13=',IRSV13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' SV:   ...',
     +       PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
           ENDIF
                                                                GO TO 20
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSA2
        PTYCH1=PTYSQ1 + PTYSA2
        PTZCH1=PLQ1 + PLAQ2
        ECH1=EQ1 + EAQ2
        PTXCH2=PTXSQ2 + PTXSA1
        PTYCH2=PTYSQ2 + PTYSA1
        PTZCH2=PLQ2 + PLAQ1
        ECH2=EQ2 + EAQ1
C
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' SV: IREJ ',
     +  IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ SEA-QUARK - TAR DIQUARK)
C
        CALL COBCMA(IPSQ(IXSPR),ITTV1(IXVTA),ITTV2(IXVTA), IJNCH1,NNCH1,
     +  IREJ,AMCH1,AMCH1N,1)
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' HAEVSV - IRSV11=',IRSV11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' SV:', IPSQ(IXSPR),ITTV1
     +      (IXVTA),ITTV2(IXVTA),IJNCH1,NNCH1,IREJ, XPSQ(IXSPR),XPSAQ
     +      (IXSPR),XPSQCM,XPSACM, XTVQ(IXVTA),XTVD(IXVTA),AMCH1,AMCH1N
          ENDIF
 
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJ.EQ.1) THEN
	  IF(IPEV.GE.1)WRITE(6,'(A)')' sv11 rej.'
          IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' HAEVSV - IRSV11=',IRSV11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' SV:', IPSQ(IXSPR),ITTV1
     +      (IXVTA),ITTV2(IXVTA),IJNCH1,NNCH1,IREJ, XPSQ(IXSPR),XPSAQ
     +      (IXSPR),XPSQCM,XPSACM, XTVQ(IXVTA),XTVD(IXVTA),AMCH1,AMCH1N
          ENDIF
          IRSV11=IRSV11 + 1
                                                                 GOTO 20
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0) THEN
              CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N, 
     +  PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +  PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,
     +  PLAQ2,EAQ2, PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,
     +  ECH2,IREJ)
          AMCH2=AMCH2N
        ENDIF
C
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' SV(2): IREJ ',
     +  IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' HAEVSV - IRSV11=',IRSV11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' SV:', IPSQ(IXSPR),ITTV1
     +      (IXVTA),ITTV2(IXVTA),IJNCH1,NNCH1,IREJ, XPSQ(IXSPR),XPSAQ
     +      (IXSPR),XPSQCM,XPSACM, XTVQ(IXVTA),XTVD(IXVTA),AMCH1,AMCH1N
          ENDIF
        IF(IREJ.EQ.1) THEN
	  IF(IPEV.GE.1)WRITE(6,'(A)')' sv cormom rej.'
	  GO TO 20
	ENDIF
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C  SECOND FOR CHAIN 2  XPSAQ(N)---XTVQ(ITTA)   ANTIQUARK-QUARK
C
        CALL COMCMA(ITVQ(IXVTA),IPSAQ(IXSPR), IJNCH2,NNCH2,IREJ,AMCH2,
     +  AMCH2N)
C
C                           AT PRESENT NO CORRECTION FOR CHAIN 2
        IF(IREJ.EQ.1) THEN
          IRSV12=IRSV12 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' HAEVSV - IRSV12=',IRSV12
            WRITE(6,'(A/5I5/2(4E12.4/),2E12.4)')
     +      ' SV: ITVQ(IXVTA),IPSAQ(IXSPR),IJNCH2,NNCH2,IREJ...', ITVQ
     +      (IXVTA),IPSAQ(IXSPR),IJNCH2,NNCH2,IREJ, XPSQ(IXSPR),XPSAQ
     +      (IXSPR),XPSQCM,XPSACM, XTVQ(IXVTA),XTVD(IXVTA),XTVQCM,
     +      XTVDCM, AMCH2,AMCH2N
 
          ENDIF
                                                                 GOTO 20
        ENDIF
          AMCH2=AMCH2N
C
        IF (IPEV.GE.2) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' SV: IREJ ',
     +  IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
          IF(IPEV.GE.1) THEN
             WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' SV:  ...',
     +       PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
 
          ENDIF
 
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
C                                IF AMCH1 CHANGED IN COBCMA/COMCMA
C                                CORRESPONDING REPLACEMENT IN CORMOM
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        EEE=ECH1+ECH2
        PXXX=PTXCH1+PTXCH2
        PYYY=PTYCH1+PTYCH2
        PZZZ=PTZCH1+PTZCH2
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  PPPCH1, QTXCH1,QTYCH1,QTZCH1,QECH1)
C
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH2,PTYCH2,PTZCH2,ECH2,
     +  PPPCH2, QTXCH2,QTYCH2,QTZCH2,QECH2)
C
          NORIG=24
          CALL CORVAL(AMMM,
     +    IREJ,AMCH1,AMCH2, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +    QTXCH2,QTYCH2,QTZCH2,QECH2,NORIG)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
 
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +  PPPCH1, PTXCH1,PTYCH1,PTZCH1,ECH1)
C
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH2,QTYCH2,QTZCH2,QECH2,
     +  PPPCH2, PTXCH2,PTYCH2,PTZCH2,ECH2)
C
 
C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' SV - CALL CORVAL: AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ
          ENDIF
          IF(IREJ.EQ.1) THEN
	    IF(IPEV.GE.1)WRITE(6,'(A)')' sv14 rej.'
C                           AMCH1N + AMCH2N > AMMM - 0.2
C                           REJECT EVENT
            IRSV14=IRSV14+1
                                                                 GOTO 20
          ENDIF
C                         12.5.95
C         GO TO 20
        ENDIF
C
       QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQSVA1(N,1)=PTXSQ1
       PQSVA1(N,2)=PTYSQ1
       PQSVA1(N,3)=PLQ1
       PQSVA1(N,4)=EQ1
       PQSVA2(N,1)=PTXSA2
       PQSVA2(N,2)=PTYSA2
       PQSVA2(N,3)=PLAQ2
       PQSVA2(N,4)=EAQ2
       PQSVB1(N,1)=PTXSQ2
       PQSVB1(N,2)=PTYSQ2
       PQSVB1(N,3)=PLQ2
       PQSVB1(N,4)=EQ2
       PQSVB2(N,1)=PTXSA1
       PQSVB2(N,2)=PTYSA1
       PQSVB2(N,3)=PLAQ1
       PQSVB2(N,4)=EAQ1
C-------------------
 
C
C                                      PUT S-V CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
C                                 FLAG FOR SV-CHAIN ENDS
C                                            PROJECTILE: ISTHKK=131
C                                            TARGET:     ISTHKK=122
C                                      FOR SV-CHAINS     ISTHKK=4
C
        IHKKPD=JHKKPS(IXSPR )
        IHKKPO=JHKKPS(IXSPR )-1
        IHKKTD=JHKKTV(IXVTA )
        IHKKTO=JHKKTV(IXVTA )-1
        IF (IPEV.GT.3)WRITE(6,1000)IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1010)IXVTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXVTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQSVA1(N,1)
        PHKK(2,IHKK)=PQSVA1(N,2)
        PHKK(3,IHKK)=PQSVA1(N,3)
        PHKK(4,IHKK)=PQSVA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET DIQUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=122
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQSVA2(N,1)
        PHKK(2,IHKK)=PQSVA2(N,2)
        PHKK(3,IHKK)=PQSVA2(N,3)
        PHKK(4,IHKK)=PQSVA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=4
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        IF (IPEV.GT.3)WRITE(6,'(A,3E12.3)')' BETP,GAMP,BGAMP',
     *  BETP,GAMP,BGAMP
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKSV(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C                                     CHAIN 2 PROJECTILE SEA-ANTIQUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQSVB1(N,1)
        PHKK(2,IHKK)=PQSVB1(N,2)
        PHKK(3,IHKK)=PQSVB1(N,3)
        PHKK(4,IHKK)=PQSVB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=122
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQSVB2(N,1)
        PHKK(2,IHKK)=PQSVB2(N,2)
        PHKK(3,IHKK)=PQSVB2(N,3)
        PHKK(4,IHKK)=PQSVB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=4
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKSV(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCSV1(N)=AMCH1
        AMCSV2(N)=AMCH2
        GACSV1(N)=QECH1/AMCH1
        BGXSV1(N)=QTXCH1/AMCH1
        BGYSV1(N)=QTYCH1/AMCH1
        BGZSV1(N)=QTZCH1/AMCH1
        GACSV2(N)=QECH2/AMCH2
        BGXSV2(N)=QTXCH2/AMCH2
        BGYSV2(N)=QTYCH2/AMCH2
        BGZSV2(N)=QTZCH2/AMCH2
        NCHSV1(N)=NNCH1
        NCHSV2(N)=NNCH2
        IJCSV1(N)=IJNCH1
        IJCSV2(N)=IJNCH2
        IF (IPEV.GE.2) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/                8F15.5)') ' SV / FINAL PRINT',N, XPSQ
     +  (IXSPR),XPSAQ(IXSPR),XTVQ(IXVTA),XTVD(IXVTA), IPSQ(IXSPR),IPSAQ
     +  (IXSPR), ITVQ(IXVTA),ITTV1(IXVTA),ITTV2(IXVTA), AMCSV1(N),AMCSV2
     +  (N),GACSV1(N),GACSV2(N), BGXSV1(N),BGYSV1(N),BGZSV1(N), BGXSV2
     +  (N),BGYSV2(N),BGZSV2(N), NCHSV1(N),NCHSV2(N),IJCSV1(N),IJCSV2
     +  (N), (PQSVA1(N,JU),PQSVA2(N,JU),PQSVB1(N,JU), PQSVB2(N,JU),JU=1,
     +  4)
 
 
 
 
   10 CONTINUE
      RETURN
C
   20 CONTINUE
C                                     EVENT REJECTED
C                                     START A NEW ONE
      IREJSV=1
      RETURN
      END
C-------------------------------------------------------------------

C-------------------------------------------------------------------
      SUBROUTINE CROMSC(PX,PY,PZ,E,RX,RY,RZ,PXN,PYN,PZN,EN,IORIG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C                                                     j.r.6.5.93
C      parton with momentum components px,py,pz
C      at position rx,ry,rz in target nucleus
C      gets multiple scattering during travel through target
C
      COMMON /NNCMS/GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
      COMMON/CRONIN/CRONCO,MKCRON
      COMMON/DPRIN/IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
C      IPRI=1
      IF(E.LE.0.D0)IPRI=1
      IF(MKCRON.EQ.0) THEN
        PXN=PX
        PYN=PY
        PZN=PZ
        EN=E
        RETURN
      ENDIF
      IF(IPRI.GE.1)
     * WRITE(6,'(A,7E12.3,I5)')
     *        ' CROMSC:PX,PY,PZ,E,RX,RY,RZ,IORIG',
     *          PX,PY,PZ,E,RX,RY,RZ,IORIG
C
C  first transform parton momenta px,py,pz,e back into target systen
C
      IF(IPRI.GE.1)
     * WRITE(6,'(A,7E12.3)')' CROMSC:GAMCM,BGCM',
     *                              GAMCM,BGCM 
      CALL SLTRAF(GAMCM,-BGCM,E,PZ,EL,PZL)
      IF(IPRI.GE.1)
     * WRITE(6,'(A,4E12.3)')' CROMSC:E,PZ,EL,PZL',
     *                               E,PZ,EL,PZL
C
C                       direction cosines of parton
C
      PP=PX**2+PY**2+PZL**2
      P=SQRT(PP)
      IF(P.LE.2.0)THEN
        PXN=PX
        PYN=PY
        PZN=PZ
        EN=E
        RETURN
      ENDIF
C
      CX=PX/P
      CY=PY/P
      CZ=PZL/P
      IF(IPRI.GE.1)
     * WRITE(6,'(A,4E12.3)')' CROMSC:P,CX,CY,CZ',
     *                               P,CX,CY,CZ
C
C     is position of parton within standard target nucleus (r=rtarg)
C
      RTESQ= RX**2+RY**2+RZ**2-RTARG**2
      IF(IPRI.GE.1)
     * WRITE(6,'(A,2E12.3)')' CROMSC:RTARG,RTESQ',
     *                               RTARG,RTESQ
      IF(RTESQ.GE.-0.001)THEN
        PXN=PX
        PYN=PY
        PZN=PZ
        EN=E
        RETURN
      ENDIF
C
C    calculate distance from point rx,ry,rz to surface of rtarg sphere
C                                             (origin:0,0,0)
C
      B=RTESQ
      A=CX*RX+CY*RY+CZ*RZ
C                      distance to surface ts
      TS=-A+SQRT(A**2-B)
      IF(IPRI.GE.1)
     * WRITE(6,'(A,3E12.3)')' CROMSC:A,B,TS',
     *                               A,B,TS
 
C
C     calculate multiple scattering angle
C
C     IF(IPRI.GE.0.AND.THETO.GT.0.10D0)
C    * WRITE(6,'(A,4E12.3)')' CROMSC:A,B,TS,THETO,truncate',
C    *                               A,B,TS,THETO
C     IF(THETO.GT.0.10D0)THETO=0.1
C       PXN=PX
C       PYN=PY
C       PZN=PZ
C       EN=E
C       RETURN
C     ENDIF
      THETO=CRONCO*SQRT(TS)/P
 1212 CONTINUE
C
C     Gaussian sampling of space angle
C
      CALL RANNORR(R1,R2)
      THETA=ABS(R1*THETO)
C     IF(THETA.GE.0.3D0)THEN
      IF(THETA.GE.0.9D0)THEN
      IF(IPRI.GE.1)
     * WRITE(6,'(A,4E12.3)')' CROMSC:A,B,TS,THETA,reject',
     *                               A,B,TS,THETA
        PXN=PX
        PYN=PY
        PZN=PZ
        EN=E
        RETURN
      ENDIF
      CALL DSFECF(SFE,CFE)
      CT=COS(THETA)
      ST=SIN(THETA)
      IF(IPRI.GE.1)
     * WRITE(6,'(A,2E12.3)')' CROMSC:THETO,THETA',
     *                               THETO,THETA
C
C       new direction cosines
C
      CALL DTRANS(CX,CY,CZ,CT,ST,CFE,SFE,CXN,CYN,CZN)
      IF(IPRI.GE.1)
     * WRITE(6,'(A,3E12.3)')' CROMSC:CXN,CYN,CZN',
     *                               CXN,CYN,CZN
C
C        new momenta in target system
C
      PXLN=CXN*P
      PYLN=CYN*P
      PZLN=CZN*P
      IF(IPRI.GE.1)
     * WRITE(6,'(A,3E12.3)')' CROMSC:PXLN,PYLN,PZLN',
     *                               PXLN,PYLN,PZLN
C
C        transformation back into cms
C
      PXN=PXLN
      PYN=PYLN
      IF(IPRI.GE.1)
     * WRITE(6,'(A,7E12.3)')' CROMSC:GAMCM,BGCM',
     *                              GAMCM,BGCM 
      CALL SLTRAF(GAMCM,BGCM,EL,PZLN,EN,PZN)
      IF(IPRI.GE.1)
     * WRITE(6,'(A,4E12.3)')' CROMSC:PXN,PYN,PZN,EN',
     *                               PXN,PYN,PZN,EN
      IF(ABS(E-EN).GT.0.2)THEN
        THETO=THETO/2.
        GO TO 1212
      ENDIF
C      IPRI=0
      IF (E.LE.0.)IPRI=0
      RETURN
      END

C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE KKEVHH
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C-------------------------    TREATMENT OF Hard scattered CHAIN SYSTEMS
C
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,RPTSHM.
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
      PARAMETER (INTMX=2488,INTMD=252)
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
      COMMON /DXQX/   XPVQ(248),XPVD(248),XTVQ(248),XTVD(248),
     *                XPSQ(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
C--------------------
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX),
     *                IFROVT(248),ITOVT(248),IFROST(INTMX),
     *            JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),JHKKNT(248),
     *                JHKKPV(INTMX),JHKKPS(INTMX),
     *                JHKKTV(INTMX),JHKKTS(INTMX),
     *                MHKKVV(INTMX),MHKKSS(INTMX),
     &                MHKKVS(INTMX),MHKKSV(INTMX),
     +                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
C-------------------
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     *               INTLO(INTMX),INLOSS(INTMX)
C-------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
C--------------------
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248),
     &                PRMFEP,PRMFEN,TAMFEP,TAMFEN,
     &                PREFEP,PREFEN,TAEFEP,TAEFEN,
     &        PREPOT(210),TAEPOT(210),PREBIN,TAEBIN,FERMOD,ETACOU
C--------------------
C--------------------
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     *        IPADIS,ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     *                IPADIS,ISHMAL,LPAULI
C-------------------
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5,IRSS11,IRSS12,IRSS13,
     *               IRSS14,
     *               IRSV11,IRSV12,IRSV13,IRSV14,
     *               IRVS11,IRVS12,IRVS13,IRVS14,
     *               IRVV11,IRVV12,IRVV13,IRVV14
      COMMON /ABRHH/ AMCHH1(INTMX),AMCHH2(INTMX),
     *               GACHH1(INTMX),GACHH2(INTMX),
     *               BGXHH1(INTMX),BGYHH1(INTMX),BGZHH1(INTMX),
     *               BGXHH2(INTMX),BGYHH2(INTMX),BGZHH2(INTMX),
     *               NCHHH1(INTMX),NCHHH2(INTMX),
     *               IJCHH1(INTMX),IJCHH2(INTMX),
     *               PQHHA1(INTMX,4),PQHHA2(INTMX,4),
     *               PQHHB1(INTMX,4),PQHHB2(INTMX,4)
C-------------------
      PARAMETER (NMXHKK=  49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),
     & VHKK(4,NMXHKK),WHKK(4,NMXHKK)
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
      COMMON /PROJK/ IPROJK
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C
C-----------------------------------------------------------------------
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
C----------------------------------------------------------------------
      DIMENSION IHKKQ(-6:6)
      DATA IHKKQ/-6,-5,-4,-3,-1,-2,0,2,1,3,4,5,6/
C
C----------------------------------------------------------------------
      DO 101 N=1,NONUJT
        IF (JHKKEX(N).EQ.1)THEN
C
          IXVPR=JHKKPH(N)
          IXVTA=JHKKTH(N)
          IHKKPO=JHKKPV(IXVPR)
          IHKKTO=JHKKTV(IXVTA)
C
C                               Cronin multiple scattering
      IF(IT.GT.1)THEN
      ITNU=IHKKTO
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      RTIR2=(RTIX**2+RTIY**2+RTIZ**2)
      IF(RTIR2.GT.RTARG**2)THEN
        IF(IPEV.GE.2)
     *  WRITE(6,774)RTARG,RTIX,RTIY,RTIZ,BIMPAC,IHKKTO,IXVTA
 774    FORMAT(' KKEVHH: RTARG,RTIX,RTIY,RTIZ,BIMPAC,IHKKTO,IXVTA'
     *  ,5E12.4,2I10)
        GO TO 779
      ENDIF
      PVQPX=PJETA1(N,1)
      PVQPY=PJETA1(N,2)
      PVQPZ=PJETA1(N,3)
      PVQE =PJETA1(N,4)
      CALL CROMSC(PVQPX,PVQPY,PVQPZ,PVQE,RTIX,RTIY,RTIZ,
     *            PVQNX,PVQNY,PVQNZ,PVQNE,20)
      PVDQPX=PJETA2(N,1)
      PVDQPY=PJETA2(N,2)
      PVDQPZ=PJETA2(N,3)
      PVDQE =PJETA2(N,4)
      CALL CROMSC(PVDQPX,PVDQPY,PVDQPZ,PVDQE,RTIX,RTIY,RTIZ,
     *            PVDQNX,PVDQNY,PVDQNZ,PVDQNE,21)
      AMTES2=((PVQNE+PVDQNE)**2-(PVQNX+PVDQNX)**2
     *       -(PVQNY+PVDQNY)**2-(PVQNZ+PVDQNZ)**2)
      IF(AMTES2.GE.AMJCH1(N)**2.OR.AMTES2.GE.25.D0)THEN 
      PJETA1(N,1)=PVQNX
      PJETA1(N,2)=PVQNY
      PJETA1(N,3)=PVQNZ
      PJETA1(N,4)=PVQNE
      PJETA2(N,1)=PVDQNX
      PJETA2(N,2)=PVDQNY
      PJETA2(N,3)=PVDQNZ
      PJETA2(N,4)=PVDQNE
      ENDIF
C                                  MASSES OF SUBCHAINS
      XMJCH1=SQRT(MAX(0D0,((PJETA1(N,4)+PJETA2(N,4))+(PJETA1(N,3)+
     * PJETA2(N,3)))*((PJETA1(N,4)+PJETA2(N,4))-(PJETA1(N,3)+PJETA2
     * (N,3)))-(PJETA1(N,2)+PJETA2(N,2))**2-(PJETA1(N,1)+PJETA2(N,1
     * ))**2))
         IF(XMJCH1.GE.AMJCH1(N))THEN
         AMJCH1(N)=XMJCH1
C
          GAMJH1(N)=(PJETA1(N,4)+
     *                    PJETA2(N,4))/AMJCH1(N)
          BGXJH1(N)=(PJETA1(N,1)+
     *                    PJETA2(N,1))/AMJCH1(N)
          BGYJH1(N)=(PJETA1(N,2)+
     *                    PJETA2(N,2))/AMJCH1(N)
          BGZJH1(N)=(PJETA1(N,3)+
     *                    PJETA2(N,3))/AMJCH1(N)
      ENDIF
      ENDIF
 779  CONTINUE
C                                                ---------
C
C
C                                      PUT h-h CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
c                                      flags for h-h chain ends
c                                        projectile: isthkk=151
c                                        target:     isthkk=152
c                                        h-h chains: isthkk=7
C
          IXVPR=JHKKPH(N)
          IXVTA=JHKKTH(N)
          IHKKPO=JHKKPV(IXVPR)
          IHKKTO=JHKKTV(IXVTA)
          IF (IPEV.GT.3)WRITE(6,5002)IXVPR,IHKKPO
 5002     FORMAT (' IXVPR,IHKKPO ',5I5)
          IF (IPEV.GT.3)WRITE(6,5003)IXVTA,IHKKTO
 5003     FORMAT (' IXVTA,IHKKTO ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=151
          IDHKK(IHKK)=IHKKQ(IJJQ1(N))
          JMOHKK(1,IHKK)=IHKKPO
          JMOHKK(2,IHKK)=IHKKPO
          JDAHKK(1,IHKK)=IHKK+2
          JDAHKK(2,IHKK)=IHKK+2
          PHKK(1,IHKK)=PJETA1(N,1)
          PHKK(2,IHKK)=PJETA1(N,2)
          PHKK(3,IHKK)=PJETA1(N,3)
          PHKK(4,IHKK)=PJETA1(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKPO)
          VHKK(4,IHKK)=VHKK(4,IHKKPO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
 5001     FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=152
          IDHKK(IHKK)=IHKKQ(IJJAQ2(N))
          JMOHKK(1,IHKK)=IHKKTO
          JMOHKK(2,IHKK)=IHKKTO
          JDAHKK(1,IHKK)=IHKK+1
          JDAHKK(2,IHKK)=IHKK+1
          PHKK(1,IHKK)=PJETA2(N,1)
          PHKK(2,IHKK)=PJETA2(N,2)
          PHKK(3,IHKK)=PJETA2(N,3)
          PHKK(4,IHKK)=PJETA2(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKTO)
          VHKK(4,IHKK)=VHKK(4,IHKKTO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=7
          IDHKK(IHKK)=88888
          JMOHKK(1,IHKK)=IHKK-2
          JMOHKK(2,IHKK)=IHKK-1
          PHKK(1,IHKK)=PHKK(1,IHKK-2)+PHKK(1,IHKK-1)
          PHKK(2,IHKK)=PHKK(2,IHKK-2)+PHKK(2,IHKK-1)
          PHKK(3,IHKK)=PHKK(3,IHKK-2)+PHKK(3,IHKK-1)
          PHKK(4,IHKK)=PHKK(4,IHKK-2)+PHKK(4,IHKK-1)
          PHKK(5,IHKK)=AMJCH1(N)
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
          VHKK(1,NHKK)=                VHKK(1,NHKK-1)
          VHKK(2,NHKK)=                VHKK(2,NHKK-1)
          VHKK(3,NHKK)=                VHKK(3,NHKK-1)
          VHKK(4,NHKK)=0.
          MHKKHH(N)=IHKK
          IF (IPROJK.EQ.1)THEN
            WHKK(1,NHKK)=                VHKK(1,NHKK-2)
            WHKK(2,NHKK)=                VHKK(2,NHKK-2)
            WHKK(3,NHKK)=                VHKK(3,NHKK-2)
            WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
            IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (WHKK(KHKK,IHKK),KHKK=1,4)
          ENDIF
          IF (IPHKK.GE.1)THEN
	  WRITE(6,'(A)')' KKEVHH:'
	  WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
	  ENDIF
C
C
C                                     CHAIN 2 PROJECTILE SEA-QUARK
          IIJJKK=0
          IF(IIJJKK.EQ.0)GO TO 33446	  
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=151
          IDHKK(IHKK)=IHKKQ(IJJAQ1(N))
          JMOHKK(1,IHKK)=IHKKPO
          JMOHKK(2,IHKK)=IHKKPO
          JDAHKK(1,IHKK)=IHKK+2
          JDAHKK(2,IHKK)=IHKK+2
          PHKK(1,IHKK)=PJETB1(N,1)
          PHKK(2,IHKK)=PJETB1(N,2)
          PHKK(3,IHKK)=PJETB1(N,3)
          PHKK(4,IHKK)=PJETB1(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKPO)
          VHKK(4,IHKK)=VHKK(4,IHKKPO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C                                     CHAIN 2 TARGET SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=152
          IDHKK(IHKK)=IHKKQ(IJJQ2(N))
          JMOHKK(1,IHKK)=IHKKTO
          JMOHKK(2,IHKK)=IHKKTO
          JDAHKK(1,IHKK)=IHKK+1
          JDAHKK(2,IHKK)=IHKK+1
          PHKK(1,IHKK)=PJETB2(N,1)
          PHKK(2,IHKK)=PJETB2(N,2)
          PHKK(3,IHKK)=PJETB2(N,3)
          PHKK(4,IHKK)=PJETB2(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKTO)
          VHKK(4,IHKK)=VHKK(4,IHKKTO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=7
          IDHKK(IHKK)=88888
          JMOHKK(1,IHKK)=IHKK-2
          JMOHKK(2,IHKK)=IHKK-1
          PHKK(1,IHKK)=PHKK(1,IHKK-2)+PHKK(1,IHKK-1)
          PHKK(2,IHKK)=PHKK(2,IHKK-2)+PHKK(2,IHKK-1)
          PHKK(3,IHKK)=PHKK(3,IHKK-2)+PHKK(3,IHKK-1)
          PHKK(4,IHKK)=PHKK(4,IHKK-2)+PHKK(4,IHKK-1)
          PHKK(5,IHKK)=AMJCH2(N)
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
          VHKK(1,NHKK)=                VHKK(1,NHKK-1)
          VHKK(2,NHKK)=                VHKK(2,NHKK-1)
          VHKK(3,NHKK)=                VHKK(3,NHKK-1)
          VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
          MHKKHH(N)=IHKK
          IF (IPROJK.EQ.1)THEN
            WHKK(1,NHKK)=                VHKK(1,NHKK-2)
            WHKK(2,NHKK)=                VHKK(2,NHKK-2)
            WHKK(3,NHKK)=                VHKK(3,NHKK-2)
            WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
            IF (IPHKK.GE.2) THEN
	  WRITE(6,'(A)')' KKEVHH:'
	    WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (WHKK(KHKK,IHKK),KHKK=1,4)
	    ENDIF
          ENDIF
          IF (IPHKK.GE.2) THEN
	  WRITE(6,'(A)')' KKEVHH:'
	  WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
	  ENDIF
33446     CONTINUE	  
C
C  NOW WE HAVE AN ACCEPTABLE HARD  EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCHH1(N)=AMJCH1(N)
        AMCHH2(N)=AMJCH2(N)
        GACHH1(N)=GAMJH1(N)
        BGXHH1(N)=BGXJH1(N)
        BGYHH1(N)=BGYJH1(N)
        BGZHH1(N)=BGZJH1(N)
        GACHH2(N)=GAMJH2(N)
        BGXHH2(N)=BGXJH2(N)
        BGYHH2(N)=BGYJH2(N)
        BGZHH2(N)=BGZJH2(N)
	NNCH1=0
	NNCH2=0
	IJNCH1=0
	IJNCH2=0
        NCHHH1(N)=NNCH1
        NCHHH2(N)=NNCH2
        IJCHH1(N)=IJNCH1
        IJCHH2(N)=IJNCH2
        DO 1234 III=1,4
          PQHHA1(N,III)=PJETA1(N,III)
          PQHHA2(N,III)=PJETA2(N,III)
          PQHHB1(N,III)=PJETB1(N,III)
          PQHHB2(N,III)=PJETB2(N,III)
 1234   CONTINUE
        IF (IPEV.GE.6)WRITE(6,104)N,
     *               AMCHH1(N),AMCHH2(N),GACHH1(N),GACHH2(N),
     *               BGXHH1(N),BGYHH1(N),BGZHH1(N),
     *               BGXHH2(N),BGYHH2(N),BGZHH2(N),
     *               NCHHH1(N),NCHHH2(N),IJCHH1(N),IJCHH2(N)
      ENDIF
  101 CONTINUE
C
  104 FORMAT(' HH - 104',
     *       I10,4F12.7    /10X,6F12.6,4I5)
  211 FORMAT (' HH: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJ ',5F12.5,I10/
     *        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     *        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
  212 FORMAT (' HH: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJ || ',5F12.5,I10/
     *        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     *        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
 8001 FORMAT(' KKEVHH - IRHH13=',I5)
 8002 FORMAT( ' HH - 8002',5E12.4/4(4E12.4/),2E12.4/2I5/4E12.4)
 8003 FORMAT(' KKEVHH - IRHH11=',I5)
 8005 FORMAT(' KKEVHH - IRHH12=',I5)
 8006 FORMAT(' HH - 8006', 5I5/2(4E12.4/),2E12.4)
      RETURN
      END
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE KKEVZZ
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C---------------    TREATMENT OF SUPPLEMENTARY SEA CHAIN SYSTEMS
C
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,RPTSHM.
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
      PARAMETER (INTMX=2488,INTMD=252)
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
      COMMON /DXQX/   XPVQ(248),XPVD(248),XTVQ(248),XTVD(248),
     *                XPSQ(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
C--------------------
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX),
     *                IFROVT(248),ITOVT(248),IFROST(INTMX),
     *            JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),JHKKNT(248),
     *                JHKKPV(INTMX),JHKKPS(INTMX),
     *                JHKKTV(INTMX),JHKKTS(INTMX),
     *                MHKKVV(INTMX),MHKKSS(INTMX),
     &                MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
C-------------------
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     *               INTLO(INTMX),INLOSS(INTMX)
C-------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
C--------------------
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248),
     &                PRMFEP,PRMFEN,TAMFEP,TAMFEN,
     &                PREFEP,PREFEN,TAEFEP,TAEFEN,
     &        PREPOT(210),TAEPOT(210),PREBIN,TAEBIN,FERMOD,ETACOU
C--------------------
C--------------------
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     *        IPADIS,ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     *                IPADIS,ISHMAL,LPAULI
C-------------------
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5,IRSS11,IRSS12,IRSS13,
     *               IRSS14,
     *               IRSV11,IRSV12,IRSV13,IRSV14,
     *               IRVS11,IRVS12,IRVS13,IRVS14,
     *               IRVV11,IRVV12,IRVV13,IRVV14
      COMMON /ABRZZ/ AMCZZ1(INTMX),AMCZZ2(INTMX),
     *               GACZZ1(INTMX),GACZZ2(INTMX),
     *               BGXZZ1(INTMX),BGYZZ1(INTMX),BGZZZ1(INTMX),
     *               BGXZZ2(INTMX),BGYZZ2(INTMX),BGZZZ2(INTMX),
     *               NCHZZ1(INTMX),NCHZZ2(INTMX),
     *               IJCZZ1(INTMX),IJCZZ2(INTMX),
     *               PQZZA1(INTMX,4),PQZZA2(INTMX,4),
     *               PQZZB1(INTMX,4),PQZZB2(INTMX,4)
C-------------------
      PARAMETER (NMXHKK=  49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),
     & VHKK(4,NMXHKK),WHKK(4,NMXHKK)
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
      COMMON /PROJK/ IPROJK
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C
C-----------------------------------------------------------------------
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
*KEEP,ABRZD.
      COMMON /ABRZD/ AMCZD1(INTMD),AMCZD2(INTMD),
     +GACZD1(INTMD),GACZD2(INTMD),
     +BGXZD1(INTMD),BGYZD1(INTMD),BGZZD1(INTMD), 
     +BGXZD2(INTMD),BGYZD2(INTMD),
     +BGZZD2(INTMD), NCHZD1(INTMD),NCHZD2(INTMD),
     +IJCZD1(INTMD),IJCZD2(INTMD),
     +PQZDA1(INTMD,4),PQZDA2(INTMD,4), PQZDB1(INTMD,4),
     +PQZDB2(INTMD,4),
     +IPCQ(INTMD),ITCQ(INTMD),ITCQ2(INTMD),IPCAQ(INTMD),
     +ITCAQ(INTMD),ITCAQ2(INTMD)
     +,IZDSS(INTMD)
*KEEP,ABRDZ.
      COMMON /ABRDZ/ AMCDZ1(INTMD),AMCDZ2(INTMD),
     +GACDZ1(INTMD),GACDZ2(INTMD),
     +BGXDZ1(INTMD),BGYDZ1(INTMD),BGZDZ1(INTMD), 
     +BGXDZ2(INTMD),BGYDZ2(INTMD),
     +BGZDZ2(INTMD), NCHDZ1(INTMD),NCHDZ2(INTMD),
     +IJCDZ1(INTMD),IJCDZ2(INTMD),
     +PQDZA1(INTMD,4),PQDZA2(INTMD,4), PQDZB1(INTMD,4),
     +PQDZB2(INTMD,4),
     +IPZQ(INTMD),IPZQQ2(INTMD),ITZQ(INTMD),IPZAQ(INTMD),
     +IZAQQ2(INTMD),ITZAQ(INTMD)
     +,IDZSS(INTMD)
C-------------------
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON/INTNEZ/NDZ,NZD
C----------------------------------------------------------------------
      DIMENSION IHKKQ(-6:6)
      DATA IHKKQ/-6,-5,-4,-3,-1,-2,0,2,1,3,4,5,6/
C
C----------------------------------------------------------------------
      DO 1001 N=1,NONUST
         DO 1002 I=1,NDZ 
           IF(IDZSS(I).EQ.N.AND.NCH1(N).EQ.99)THEN
             NCHDZ1(I)=99
             NCHDZ2(I)=99
           ENDIF
           IF(IDZSS(I).EQ.N.AND.JHKKSX(N).NE.1)THEN
             NCHDZ1(I)=99
             NCHDZ2(I)=99
           ENDIF
           IF(IPEV.EQ.2)THEN
             WRITE(6,'(A,6I10)')' kkevzz:n,i,ndz,nchdz1,jhkksx,idzss'
     *       ,N,I,NDZ,NCHDZ1(I),JHKKSX(N),IDZSS(I)
           ENDIF
 1002    CONTINUE
         DO 1003 I=1,NZD 
           IF(IZDSS(I).EQ.N.AND.NCH1(N).EQ.99)THEN
             NCHZD1(I)=99
             NCHZD2(I)=99
           ENDIF
           IF(IZDSS(I).EQ.N.AND.JHKKSX(N).NE.1)THEN
             NCHZD1(I)=99
             NCHZD2(I)=99
           ENDIF
           IF(IPEV.EQ.2)THEN
             WRITE(6,'(A,6I10)')' kkevzz:n,i,nzd,nchzd1,jhkksx,izdss'
     *       ,N,I,NZD,NCHZD1(I),JHKKSX(N),IZDSS(I)
           ENDIF
 1003    CONTINUE
 1001 CONTINUE
      DO 101 N=1,NONUST
        IF(NCH1(N).EQ.88)GO TO 101
        IF(NCH2(N).EQ.88)GO TO 101
        IF (JHKKSX(N).EQ.1)THEN
          IXVPR=JHKKPZ(N)
          IXVTA=JHKKTZ(N)
          IHKKPO=JHKKPV(IXVPR)
          IHKKTO=JHKKTV(IXVTA)
C
C                               Cronin multiple scattering
C     IF(IT.GT.1.AND.N.GT.100)THEN
      IF(IT.GT.1)THEN
      ITNU=IHKKTO
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      RTIR2=(RTIX**2+RTIY**2+RTIZ**2)
      IF(RTIR2.GT.RTARG**2)THEN
        IF(IPEV.GE.2)
     *  WRITE(6,774)RTARG,RTIX,RTIY,RTIZ,BIMPAC,IHKKTO,IXVTA
 774    FORMAT(' KKEVZZ: RTARG,RTIX,RTIY,RTIZ,BIMPAC,IHKKTO,IXVTA'
     *  ,5E12.4,2I10)
        GO TO 779
      ENDIF
      IF(NCH1(N).EQ.0)THEN
      PVQPX=PSOFA1(N,1)
      PVQPY=PSOFA1(N,2)
      PVQPZ=PSOFA1(N,3)
      PVQE =PSOFA1(N,4)
      IF(PVQE.LE.0.D0)THEN
        PVQEN=SQRT(PVQPX**2+PVQPY**2+PVQPZ**2)
        WRITE(6,776)PVQE,PVQEN,N,NONUST
 776    FORMAT(' KKEVZZ: PVQE,PVQEN,N,NONUST ',2E12.4,2I5)
        PVQE=PVQEN
      ENDIF
      CALL CROMSC(PVQPX,PVQPY,PVQPZ,PVQE,RTIX,RTIY,RTIZ,
     *            PVQNX,PVQNY,PVQNZ,PVQNE,30)
      PVDQPX=PSOFA2(N,1)
      PVDQPY=PSOFA2(N,2)
      PVDQPZ=PSOFA2(N,3)
      PVDQE =PSOFA2(N,4)
      IF(PVDQE.LE.0.D0)THEN
        PVDQEN=SQRT(PVDQPX**2+PVDQPY**2+PVDQPZ**2)
        WRITE(6,778)PVDQE,PVDQEN,N,NONUST
 778    FORMAT(' KKEVZZ: PVDQE,PVDQEN,N,NONUST ',2E12.4,2I5)
        PVDQE=PVDQEN 
      ENDIF
      CALL CROMSC(PVDQPX,PVDQPY,PVDQPZ,PVDQE,RTIX,RTIY,RTIZ,
     *            PVDQNX,PVDQNY,PVDQNZ,PVDQNE,31)
      AMTES2=((PVQNE+PVDQNE)**2-(PVQNX+PVDQNX)**2
     *       -(PVQNY+PVDQNY)**2-(PVQNZ+PVDQNZ)**2)
      IF(AMTES2.GE.AMCCH1(N)**2.OR.AMTES2.GE.25.D0)THEN 
      PSOFA1(N,1)=PVQNX
      PSOFA1(N,2)=PVQNY
      PSOFA1(N,3)=PVQNZ
      PSOFA1(N,4)=PVQNE
      PSOFA2(N,1)=PVDQNX
      PSOFA2(N,2)=PVDQNY
      PSOFA2(N,3)=PVDQNZ
      PSOFA2(N,4)=PVDQNE
      ENDIF
C                                  MASSES OF SUBCHAINS
      XMCCH1=SQRT(MAX(0D0,((PSOFA1(N,4)+PSOFA2(N,4))+(PSOFA1(N,3)+
     * PSOFA2(N,3)))*((PSOFA1(N,4)+PSOFA2(N,4))-(PSOFA1(N,3)+PSOFA2
     * (N,3)))-(PSOFA1(N,2)+PSOFA2(N,2))**2-(PSOFA1(N,1)+PSOFA2(N,1
     * ))**2))
         IF(XMCCH1.GE.AMCCH1(N))THEN
          AMCCH1(N)=XMCCH1
C
          GAMCH1(N)=(PSOFA1(N,4)+
     *                    PSOFA2(N,4))/AMCCH1(N)
          BGXCH1(N)=(PSOFA1(N,1)+
     *                    PSOFA2(N,1))/AMCCH1(N)
          BGYCH1(N)=(PSOFA1(N,2)+
     *                    PSOFA2(N,2))/AMCCH1(N)
          BGZCH1(N)=(PSOFA1(N,3)+
     *                    PSOFA2(N,3))/AMCCH1(N)
      ENDIF
      ENDIF
      IF(NCH2(N).EQ.0)THEN
      PVQTX=PSOFB1(N,1)
      PVQTY=PSOFB1(N,2)
      PVQTZ=PSOFB1(N,3)
      PVQTE=PSOFB1(N,4)
      IF(PVQTE.LE.0.D0)THEN
        PVQTEN=SQRT(PVQTX**2+PVQTY**2+PVQTZ**2)
        WRITE(6,786)PVQTE,PVQTEN,N,NONUST
 786    FORMAT(' KKEVZZ: PVQTE,PVQTEN,N,NONUST ',2E12.4,2I5)
        PVQTE=PVQTEN
      ENDIF
      CALL CROMSC(PVQTX,PVQTY,PVQTZ,PVQTE,RTIX,RTIY,RTIZ,
     *            PVQNTX,PVQNTY,PVQNTZ,PVQNTE,32)
      PVDQTX=PSOFB2(N,1)
      PVDQTY=PSOFB2(N,2)
      PVDQTZ=PSOFB2(N,3)
      PVDQTE=PSOFB2(N,4)
      IF(PVDQTE.LE.0.D0)THEN
        PVDTEN=SQRT(PVDQTX**2+PVDQTY**2+PVDQTZ**2)
        WRITE(6,796)PVDQTE,PVDTEN,N,NONUST
 796    FORMAT(' KKEVZZ: PVQTE,PVQTEN,N,NONUST ',2E12.4,2I5)
        PVDQTE=PVDTEN
      ENDIF
      CALL CROMSC(PVDQTX,PVDQTY,PVDQTZ,PVDQTE,RTIX,RTIY,RTIZ,
     *            PVTQNX,PVTQNY,PVTQNZ,PVTQNE,33)
      AMTES2=((PVQNTE+PVTQNE)**2-(PVQNTX+PVTQNX)**2
     *       -(PVQNTY+PVTQNY)**2-(PVQNTZ+PVTQNZ)**2)
      IF(AMTES2.GE.AMCCH1(N)**2.OR.AMTES2.GE.25.D0)THEN 
      PSOFB1(N,1)=PVQNTX
      PSOFB1(N,2)=PVQNTY
      PSOFB1(N,3)=PVQNTZ
      PSOFB1(N,4)=PVQNTE
      PSOFB2(N,1)=PVTQNX
      PSOFB2(N,2)=PVTQNY
      PSOFB2(N,3)=PVTQNZ
      PSOFB2(N,4)=PVTQNE
      ENDIF
C                                  MASSES OF SUBCHAINS
      XMCCH2=SQRT(MAX(0D0,((PSOFB1(N,4)+PSOFB2(N,4))+(PSOFB1(N,3)+
     * PSOFB2(N,3)))*((PSOFB1(N,4)+PSOFB2(N,4))-(PSOFB1(N,3)+PSOFB2
     * (N,3)))-(PSOFB1(N,2)+PSOFB2(N,2))**2-(PSOFB1(N,1)+PSOFB2(N,1
     * ))**2))
         IF(XMCCH2.GE.AMCCH2(N))THEN
          AMCCH2(N)=XMCCH2
C
          GAMCH2(N)=(PSOFB1(N,4)+
     *                    PSOFB2(N,4))/AMCCH2(N)
          BGXCH2(N)=(PSOFB1(N,1)+
     *                    PSOFB2(N,1))/AMCCH2(N)
          BGYCH2(N)=(PSOFB1(N,2)+
     *                    PSOFB2(N,2))/AMCCH2(N)
          BGZCH2(N)=(PSOFB1(N,3)+
     *                    PSOFB2(N,3))/AMCCH2(N)
      ENDIF
      ENDIF
      ENDIF
 779  CONTINUE
C
C
C                                      PUT Z-Z CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
c                                      flags for Z-Z chain ends
c                                        projectile: isthkk=251
c                                        target:     isthkk=252
c                                        h-h chains: isthkk=9
C
          IXVPR=JHKKPZ(N)
          IXVTA=JHKKTZ(N)
          IHKKPO=JHKKPV(IXVPR)
          IHKKTO=JHKKTV(IXVTA)
          IF (IPEV.GT.3)WRITE(6,5002)IXVPR,IHKKPO
 5002     FORMAT (' IXVPR,IHKKPO ',5I5)
          IF (IPEV.GT.3)WRITE(6,5003)IXVTA,IHKKTO
 5003     FORMAT (' IXVTA,IHKKTO ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=251
          IDHKK(IHKK)=IHKKQ(IJSQ1(N))
          JMOHKK(1,IHKK)=IHKKPO
          JMOHKK(2,IHKK)=IHKKPO
          JDAHKK(1,IHKK)=IHKK+2
          JDAHKK(2,IHKK)=IHKK+2
          PHKK(1,IHKK)=PSOFA1(N,1)
          PHKK(2,IHKK)=PSOFA1(N,2)
          PHKK(3,IHKK)=PSOFA1(N,3)
          PHKK(4,IHKK)=PSOFA1(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKPO)
          VHKK(4,IHKK)=VHKK(4,IHKKPO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
 5001     FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=252
          IDHKK(IHKK)=IHKKQ(IJSAQ2(N))
          JMOHKK(1,IHKK)=IHKKTO
          JMOHKK(2,IHKK)=IHKKTO
          JDAHKK(1,IHKK)=IHKK+1
          JDAHKK(2,IHKK)=IHKK+1
          PHKK(1,IHKK)=PSOFA2(N,1)
          PHKK(2,IHKK)=PSOFA2(N,2)
          PHKK(3,IHKK)=PSOFA2(N,3)
          PHKK(4,IHKK)=PSOFA2(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKTO)
          VHKK(4,IHKK)=VHKK(4,IHKKTO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=9
          IDHKK(IHKK)=88888+NCH1(N)
          JMOHKK(1,IHKK)=IHKK-2
          JMOHKK(2,IHKK)=IHKK-1
          PHKK(1,IHKK)=PHKK(1,IHKK-2)+PHKK(1,IHKK-1)
          PHKK(2,IHKK)=PHKK(2,IHKK-2)+PHKK(2,IHKK-1)
          PHKK(3,IHKK)=PHKK(3,IHKK-2)+PHKK(3,IHKK-1)
          PHKK(4,IHKK)=PHKK(4,IHKK-2)+PHKK(4,IHKK-1)
          PHKK(5,IHKK)=AMCCH1(N)
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
          VHKK(1,NHKK)=                VHKK(1,NHKK-1)
          VHKK(2,NHKK)=                VHKK(2,NHKK-1)
          VHKK(3,NHKK)=                VHKK(3,NHKK-1)
          VHKK(4,NHKK)=0.
          MHKKHH(N)=IHKK
          IF (IPROJK.EQ.1)THEN
            WHKK(1,NHKK)=                VHKK(1,NHKK-2)
            WHKK(2,NHKK)=                VHKK(2,NHKK-2)
            WHKK(3,NHKK)=                VHKK(3,NHKK-2)
            WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
            IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (WHKK(KHKK,IHKK),KHKK=1,4)
          ENDIF
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C
C
C                                     CHAIN 2 PROJECTILE SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=251
          IDHKK(IHKK)=IHKKQ(IJSAQ1(N))
          JMOHKK(1,IHKK)=IHKKPO
          JMOHKK(2,IHKK)=IHKKPO
          JDAHKK(1,IHKK)=IHKK+2
          JDAHKK(2,IHKK)=IHKK+2
          PHKK(1,IHKK)=PSOFB1(N,1)
          PHKK(2,IHKK)=PSOFB1(N,2)
          PHKK(3,IHKK)=PSOFB1(N,3)
          PHKK(4,IHKK)=PSOFB1(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKPO)
          VHKK(4,IHKK)=VHKK(4,IHKKPO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C                                     CHAIN 2 TARGET SEA-QUARK
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=252
          IDHKK(IHKK)=IHKKQ(IJSQ2(N))
          JMOHKK(1,IHKK)=IHKKTO
          JMOHKK(2,IHKK)=IHKKTO
          JDAHKK(1,IHKK)=IHKK+1
          JDAHKK(2,IHKK)=IHKK+1
          PHKK(1,IHKK)=PSOFB2(N,1)
          PHKK(2,IHKK)=PSOFB2(N,2)
          PHKK(3,IHKK)=PSOFB2(N,3)
          PHKK(4,IHKK)=PSOFB2(N,4)
          PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
          VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
          VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
          VHKK(3,IHKK)=VHKK(3,IHKKTO)
          VHKK(4,IHKK)=VHKK(4,IHKKTO)
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
          NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
          IHKK=NHKK
          ISTHKK(IHKK)=9
          IDHKK(IHKK)=88888+NCH2(N)
          JMOHKK(1,IHKK)=IHKK-2
          JMOHKK(2,IHKK)=IHKK-1
          PHKK(1,IHKK)=PHKK(1,IHKK-2)+PHKK(1,IHKK-1)
          PHKK(2,IHKK)=PHKK(2,IHKK-2)+PHKK(2,IHKK-1)
          PHKK(3,IHKK)=PHKK(3,IHKK-2)+PHKK(3,IHKK-1)
          PHKK(4,IHKK)=PHKK(4,IHKK-2)+PHKK(4,IHKK-1)
          PHKK(5,IHKK)=AMCCH2(N)
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
          VHKK(1,NHKK)=                VHKK(1,NHKK-1)
          VHKK(2,NHKK)=                VHKK(2,NHKK-1)
          VHKK(3,NHKK)=                VHKK(3,NHKK-1)
          VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
          MHKKHH(N)=IHKK
          IF (IPROJK.EQ.1)THEN
            WHKK(1,NHKK)=                VHKK(1,NHKK-2)
            WHKK(2,NHKK)=                VHKK(2,NHKK-2)
            WHKK(3,NHKK)=                VHKK(3,NHKK-2)
            WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
            IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (WHKK(KHKK,IHKK),KHKK=1,4)
          ENDIF
          IF (IPHKK.GE.2) WRITE(6,5001)
     *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
     &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
     &      (VHKK(KHKK,IHKK),KHKK=1,4)
C
C  NOW WE HAVE AN ACCEPTABLE HARD  EVENT
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCZZ1(N)=AMCCH1(N)
        AMCZZ2(N)=AMCCH2(N)
        GACZZ1(N)=GAMCH1(N)
        BGXZZ1(N)=BGXCH1(N)
        BGYZZ1(N)=BGYCH1(N)
        BGZZZ1(N)=BGZCH1(N)
        GACZZ2(N)=GAMCH2(N)
        BGXZZ2(N)=BGXCH2(N)
        BGYZZ2(N)=BGYCH2(N)
        BGZZZ2(N)=BGZCH2(N)
        NCHZZ1(N)=NCH1(N)
        NCHZZ2(N)=NCH2(N)
        IJCZZ1(N)=IJCH1(N)
        IJCZZ2(N)=IJCH2(N)
        DO 1234 III=1,4
          PQZZA1(N,III)=PSOFA1(N,III)
          PQZZA2(N,III)=PSOFA2(N,III)
          PQZZB1(N,III)=PSOFB1(N,III)
          PQZZB2(N,III)=PSOFB2(N,III)
 1234   CONTINUE
        IF (IPEV.GE.6)WRITE(6,104)N,
     *               AMCZZ1(N),AMCZZ2(N),GACZZ1(N),GACZZ2(N),
     *               BGXZZ1(N),BGYZZ1(N),BGZZZ1(N),
     *               BGXZZ2(N),BGYZZ2(N),BGZZZ2(N),
     *               NCHZZ1(N),NCHZZ2(N),IJCZZ1(N),IJCZZ2(N)
      ENDIF
  101 CONTINUE
C
  104 FORMAT(' ZZ - 104',
     *       I10,4F12.7    /10X,6F12.6,           4I5              )
  211 FORMAT (' ZZ: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJ ',5F12.5,I10/
     *        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     *        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
  212 FORMAT (' ZZ: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJ || ',5F12.5,I10/
     *        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     *        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
 8001 FORMAT(' KKEVZZ - IRZZ13=',I5)
 8002 FORMAT( ' ZZ - 8002',5E12.4/4(4E12.4/),2E12.4/2I5/4E12.4)
 8003 FORMAT(' KKEVZZ - IRZZ11=',I5)
 8005 FORMAT(' KKEVZZ - IRZZ12=',I5)
 8006 FORMAT(' ZZ - 8006', 5I5/2(4E12.4/),2E12.4)
      RETURN
      END
C------------------------------------------------------------------------
      SUBROUTINE CORRCO
*
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
C     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
C     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************

      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     +                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)

      DO 1 I=1,NHKK
        IF (IDHKK(I).EQ.88888) THEN
          M1=I-2
          M2=I-1
          IF (JMOHKK(2,M1).EQ.0) THEN
            JM1=JMOHKK(1,M1)
            JMOHKK(2,M1)=JMOHKK(1,JM1)
          ENDIF
          IF (JMOHKK(2,M2).EQ.0) THEN
            JM2=JMOHKK(1,M2)
            JMOHKK(2,M2)=JMOHKK(1,JM2)
          ENDIF
        ENDIF
   1  CONTINUE

      DO 2 I=1,NHKK
        IF (IDHKK(I).EQ.88888) THEN
          M1=I-2
          M2=I-1
          M2M1=JMOHKK(2,M1)
          M2M2=JMOHKK(2,M2)
          IF (JDAHKK(1,M2M1).EQ.0) THEN
            JDAHKK(1,M2M1)=M1
          ELSE
            IF (JDAHKK(2,M2M1).EQ.0) THEN
            JDAHKK(2,M2M1)=M1
            ENDIF
          ENDIF
          IF (JDAHKK(1,M2M2).EQ.0) THEN
            JDAHKK(1,M2M2)=M2
          ELSE
            IF (JDAHKK(2,M2M2).EQ.0) THEN
            JDAHKK(2,M2M2)=M2
            ENDIF
          ENDIF
        ENDIF
        MO1=JMOHKK(1,M1)
        MO2=JMOHKK(1,M2)
        IF(JDAHKK(1,MO1).EQ.0)JDAHKK(1,MO1)=M1
	IF(JDAHKK(2,MO1).EQ.0)JDAHKK(2,MO1)=M1
        IF(JDAHKK(1,MO2).EQ.0)JDAHKK(1,MO2)=M2
        IF(JDAHKK(2,MO2).EQ.0)JDAHKK(2,MO2)=M2
   2  CONTINUE

      DO 3 I=1,NHKK
        IF (ISTHKK(I).EQ.11) THEN
          IF ((JDAHKK(1,I).EQ.0).AND.(JDAHKK(2,I).EQ.0)) THEN
            ISTHKK(I)=13
          ENDIF
        ENDIF
        IF (ISTHKK(I).EQ.12) THEN
          IF ((JDAHKK(1,I).EQ.0).AND.(JDAHKK(2,I).EQ.0)) THEN
          ISTHKK(I)=14
          ENDIF
        ENDIF
   3  CONTINUE

      RETURN
      END

C--------------------------------------------------------------      
      SUBROUTINE KKEVNU(NHKKH1,EPN,PPN,KKMAT,IREJ,ECM)
*
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON/INTNEZ/NDZ,NZD
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C      /
C INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,RPTSHM.
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
*KEEP,NSHMAK.
      COMMON /NSHMAK/ NNSHMA,NPSHMA,NTSHMA,NSHMAC,NSHMA2
*KEEP,ZENTRA.
      COMMON /ZENTRA/ ICENTR
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMOJ,PCMJ,EPROJJ,PPROJJ
      COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
*KEEP,NUCPOS.
      COMMON /NUCPOS/INVVP(248),INVVT(248),INVSP(248),INVST(248), NUVV,
     +NUVS,NUSV,NUSS,INSVP(248),INSVT(248),INSSP(248),INSST(248), ISVEAP
     +(248),ISVEAT(248),ISSEAP(248),ISSEAT(248), IVSEAP(248),IVSEAT
     +(248), ISLOSP(248),ISLOST(248),INOOP(248),INOOT(248),NUOO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
      COMMON /EVAPPP/IEVAP
      COMMON /NEUTYY/NEUTYP,NEUDEC
*KEEP,RTAR.
      COMMON /RTAR/ RTARNU
*KEEP,INNU.
      COMMON /INNU/INUDEC
*KEEP,HADTHR.
      COMMON /HADTHR/ EHADTH,INTHAD
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEND.
      COMMON /DIFFRA/ ISINGD,IDIFTP,IOUDIF,IFLAGD
*
      LOGICAL LSEADI
      COMMON /SEADIQ/ LSEADI
      COMMON /EVFLAG/NUMEV
      COMMON /DIQUAX/AMEDD,IDIQUA,IDIQUU
C
C-----------------------------------------------------------------------
C     PARAMETER (INTMX=2488)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON/PYJETS/NLU,NPAD,KLU(4000,5),PLU(4000,5),VLU(4000,5)
      COMMON/POL/POLARX(4),PMODUL
      COMMON /NEUREJ/ NONEUR
C     DIMENSION KKQ(1000,2),PPP(1000,5)
      DATA INIQEL /0/
C*******************************************************************"
C
C     KINEMATICS
C
C********************************************************************
C
      IREJ = 0
*
      AAM(26)=AAM(23)
C
      KPROJ=1
      IF(IJPROJ.NE.0) KPROJ=IJPROJ
      KPROJ=5
      IJPROJ=5
      KTARG=1
      ATNUC=IT
      ITN=IT-ITZ
      APNUC=IP
      IPN=IP-IPZ
      AMPROJ =AAM(KPROJ)
      AMTAR =AAM(KTARG)
*                             nucleon-nucleon cms
C     IBPROJ=1
      EPROJJ=EPN
C     PPROJJ= EPN
      PPROJJ= SQRT((EPN-AMPROJ)*(EPN+AMPROJ))
C     UMOJ= SQRT( AMTAR**2 + 2.*AMTAR*EPROJJ)
      UMOJ= SQRT(AMPROJ**2 + AMTAR**2 + 2.*AMTAR*EPROJJ)
      GAMCM = (EPROJJ+AMTAR)/UMOJ
      BGCM=PPROJJ/UMOJ
      ECM=UMOJ
      PCMJ=GAMCM*PPROJJ - BGCM*EPROJJ
C
      IF(IPEV.GE.1)WRITE(6, 1000)IP,IPZ,IT,ITZ,IJPROJ,IBPROJ,
     + EPROJJ,PPROJJ,
     +AMPROJ,AMTAR,UMO,GAMCM,BGCM
 1000 FORMAT(' ENTRY KKEVNU'/ '    IP,IPZ,IT,ITZ,IJPROJ,IBPROJ',6I5/
     +'    EPROJJ,PPROJJ,AMPROJ,AMTAR,UMO,GAMCM,BGCM'/10E12.3)
 
C
C****                            CHANGE PARAMETERS FROM COMMON \INPDAT\
      AS=0.5
      B8=0.4
C                                CHAIN PT BIGGER THAN PARTICLE PT
      N9483=0
*  entry after rejection of an event because of kinematical reasons
*  several trials are made to realize a sampled Glauber event
   10 CONTINUE
      NDZ=0
      NZD=0
      N9483=N9483+1
      IF (MOD(N9483,200).EQ.0) THEN
        WRITE(6,'(A,I5,A,I5,A)') ' KKEVT: Glauber event',NUMEV,
     +  ' rejected after', N9483, ' trials'
        WRITE(6, 1010) NN,NP,NT
        WRITE(6,1020) IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +  IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,
     +  IRVS13,IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
        N9483=1
        GO TO 20
      ELSEIF(N9483.GT.1) THEN
                                                                 GOTO 30
      ENDIF
 1010 FORMAT (5X,' N9483 LOOP - NN, NP, NT',5I10)
 1020 FORMAT (5X,' N9483 LOOP - REJECTION COUNTERS ',/,5I8/2(8I8/))
C
C***************************************************************
C
C     SAMPLE NUMBERS OF COLLISION A LA SHMAKOV---------------
C
C
C                 This is done here for a h-A event to obtain
C                the positions of the nucleons of A
C
C
C     TOTAL NUMBER OF INTERACTIONS = NN
C     NUMBER OF INTERACTING NUCLEONS
C                  FROM PROJECTILE = NP
C                  FROM TARGET = NT
C
   20 CONTINUE
   22 CONTINUE
      CALL SHMAKO(IP,IT,BIMP,NN,NP,NT,JSSH,JTSH,PPROJ,KKMAT)
      BIMPAC=BIMP
      NSHMAC=NSHMAC+1
      NNSHMA=NN
      NPSHMA=NP
      NTSHMA=NT
*  entry for repeated trial to realize a sampled Glauber event
   30 CONTINUE
      IF (IPEV.GE.2) THEN
        WRITE(6, 1040) IP,IPZ,IT,ITZ,EPROJ,PPROJ,NN,NP,NT
 1040 FORMAT ('   752 FORM ',4I10,2F10.3,5I10)
        WRITE (6,'(/A,2I5,1PE10.2,3I5)') ' KKEVT: IP,IT,BIMP,NN,NP,NT ',
     +  IP,IT,BIMP,NN,NP,NT
        WRITE (6,'(/2A)')
     +  ' KKEVT: JSSH(KKK),JTSH(KKK),INTER1(KKK),INTER2(KKK),',
     +  ' PKOO(3,KKK),TKOO(3,KKK)'
        ITUM=MAX(IT,IP)
        DO 40 KKK=1,ITUM
          WRITE (6,'(4I5,6(1PE11.3))') JSSH(KKK),JTSH(KKK),INTER1(KKK),
     +    INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),PKOO(3,KKK), TKOO(1,KKK),
     +    TKOO(2,KKK),TKOO(3,KKK)
 
   40   CONTINUE
      ENDIF
C
C-----------------------------------------------------------------------
C                  STORE PROJECTILE HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING PROJECTILES ISTHKK=11
C                              NONINTERACTING ...      ISTHKK=13
C                            - FERMI MOMENTA IN CORRESP. REST SYSTEM
C-----------
      NHKK=0
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
      NCPP=0
      NCPN=0
C                      DEFINE FERMI MOMENTA/ENERGIES FOR PROJECTILE
C
      PXFE=0.0
      PYFE=0.0
      PZFE=0.0
      DO 50 KKK=1,IP
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C       IF (JSSH(KKK).GT.0) THEN
          ISTHKK(NHKK)=11
C       ELSE
C         ISTHKK(NHKK)=13
C       ENDIF
C*
          KPROJ=IJPROJ
          PHKK(1,NHKK)=0.
          PHKK(2,NHKK)=0.
          PHKK(3,NHKK)=0.
          PHKK(4,NHKK)=AAM(KPROJ)
          PHKK(5,NHKK)=AAM(KPROJ)
C
        KKPROJ(KKK)=KPROJ
        IDHKK(NHKK)=MPDGHA(KPROJ)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
C
        PHKK(5,NHKK)=AAM(KPROJ)
        VHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        VHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        WHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNP(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1050 FORMAT (I6,I4,5I6,9E10.2)
C
   50 CONTINUE
C
C-----------------------------------------------------------------------
C                  STORE TARGET HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING TARGETS     ISTHKK=12
C                              NONINTERACTING ...      ISTHKK=14
C-----------
C---------------------
      NHADRI=0
      NCTP=0
      NCTN=0
C
      TXFE=0.0
      TYFE=0.0
      TZFE=0.0
      DO 70 KKK=1,IT
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C       IF (JTSH(KKK).GT.0) THEN
C         ISTHKK(NHKK)=12
C         NHADRI=NHADRI+1
C         IF (NHADRI.EQ.1) IHTAWW=NHKK
C         IF (EPN.LE.EHADTW) THEN
C           IF (NHADRI.GT.1) ISTHKK(NHKK)=14
C         ENDIF
C       ELSE
          ISTHKK(NHKK)=14
C       ENDIF
        IF(IT.GE.2)THEN
        FRTNEU=FLOAT(ITN)/ATNUC
        SAMTES=RNDM(v)
        IF(SAMTES.LT.FRTNEU.AND.NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(SAMTES.GE.FRTNEU.AND.NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ELSEIF(NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ENDIF
C
        IF(KTARG.EQ.1) THEN
          PFERM = TAMFEP
        ELSE
          PFERM = TAMFEN
        ENDIF
C       CALL FER4M(PFERM,FPX,FPY,FPZ,FE,KTARG)
        CALL FER4MT(IT,PFERM,FPX,FPY,FPZ,FE,KTARG)
CWRITE(6,*)' Fermi PFERM;FPX,FPY,FPZ,FE '
C    & 	,PFERM,FPX,FPY,FPZ,FE
        TXFE=TXFE + FPX
        TYFE=TYFE + FPY
        TZFE=TZFE + FPZ
        PHKK(1,NHKK)=FPX
        PHKK(2,NHKK)=FPY
        PHKK(3,NHKK)=FPZ
        PHKK(4,NHKK)=FE
        PHKK(5,NHKK)=AAM(KTARG)
        ELSE
        PHKK(1,NHKK)=0. 
        PHKK(2,NHKK)=0. 
        PHKK(3,NHKK)=0. 
        PHKK(4,NHKK)=AAM(KTARG)
        PHKK(5,NHKK)=AAM(KTARG)
        ENDIF
C
        KKTARG(KKK)=KTARG
        IDHKK(NHKK)=MPDGHA(KTARG)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        VHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        VHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        WHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNT(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
   70 CONTINUE
C                          balance Sampled Fermi momenta
      IF(IT.GE.2) THEN
        TASUMA=ITZ*AAM(1) + (IT-ITZ)*AAM(8)
        TASUBI=0.0
        TAMASU=0.0
        TXFE=TXFE/IT
        TYFE=TYFE/IT
        TZFE=TZFE/IT
        DO 80 KKK=1,IT
          IHKK=KKK + IP
          PHKK(1,IHKK)=PHKK(1,IHKK) - TXFE
          PHKK(2,IHKK)=PHKK(2,IHKK) - TYFE
          PHKK(3,IHKK)=PHKK(3,IHKK) - TZFE
          PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)** 2+ PHKK(1,IHKK)** 2+ PHKK
     +    (2,IHKK)** 2+ PHKK(3,IHKK)**2)
          ITSEC=MCIHAD(IDHKK(IHKK))
          TASUBI=TASUBI + PHKK(4,IHKK) - PHKK(5,IHKK) - TAEPOT(ITSEC)
          TAMASU=TAMASU + PHKK(4,IHKK) - TAEPOT(ITSEC)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
   80   CONTINUE
C***         definition of initial state
        TABI=-EBIND(IT,ITZ)
        TAMA=(IT-ITZ)*AAM(8) + ITZ*AAM(1) + TABI
        TAIMMA=TAMA - TAMASU
      ENDIF
C
      IF(IPEV.GT.2) THEN
        WRITE(6,'(/A/5X,A/5X,4(1PE11.3))') ' KKEVT: FERMI MOMENTA',
     +  'PRMFEP,PRMFEN, TAMFEP,TAMFEN', PRMFEP,PRMFEN, TAMFEP,TAMFEN
 
      ENDIF
C-----------------------------------------------------------------------
      IFLAGD = 0
C-----------------------------------------------------------------------
C
      IF (IPEV.GE.6) THEN
        ITUM=MAX0(IP,IT,NN)
        WRITE(6,'(A,I10)')' KKEVT ITUM loop limit',ITUM
        WRITE(6,'(A,2A)') ' KKEVT (AFTER XKSAMP):',
     +  ' JSSH, JSSHS, JTSH, JTSHS, INTER1, INTER2',
     +  ' PKOO(1),PKOO(2),PKOO(3), TKOO(1),TKOO(2),TKOO(3)'
        DO 100 KKK=1,ITUM
          WRITE (6,'(6I5,6(1PE11.3))') JSSH(KKK),JSSHS(KKK),JTSH(KKK),
     +    JTSHS(KKK), INTER1(KKK),INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),
     +    PKOO(3,KKK), TKOO(1,KKK),TKOO(2,KKK),TKOO(3,KKK)
 
 
  100   CONTINUE
      ENDIF
C-----------------------------------------------------------------------
C                 TRANSFORM MOMENTA OF INTERACTING NUCLEONS
C                 (INCLUDING FERMI MOMENTA FROM NUCLEUS REST FRAMES)
C                 INTO NUCLEON-NUCLEON CMS (DEFINED WITHOUT FERMI MOM.
      IF(IPEV.GE.2)WRITE(6,'(A)')' KKEVT before NUCMOM'
      DO 7745 IHKK=1,NHKK
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 7745 CONTINUE
      CALL NUCMOM
      IF(IPEV.GE.2)THEN
C	DO IKI=1,200
	WRITE(6,'(A)')' KKEVNU after NUCMOM'
C	ENDDO
      ENDIF
      NONUST=0
      NONUJT=0
      NOMJE=0
      NOMJER=0
C
C-----------------------------------------------------------------------
C-----------------------------------------------------------------------
C
      INIQEL=INIQEL+1
      IF(INIQEL.EQ.1)CALL MASS_INI
      IF(IPEV.GE.2)THEN
C	DO IKI=1,200
	WRITE(6,'(A)')' KKEVNU after MASS_INI'
C	ENDDO
      ENDIF
      NHKKH1=NHKK
C-----------------------------------------------------------
C
C-----------------------------------------------------------
C
C                              Select target nucleon
C
C            NEUDEC < 9 qel_pol events
C
C.  INPUT  : LTYP = neutrino type (1,...,6)nue,anue,numu,anumu
C                                          nutau,anutau
C     for LTYP=1,3,5 Target is neutron
C     for LTYP=2,4,6 Target is proton
C
C-----------------------------------------------------------
C
C            NEUDEC > 10 gen_delta events
C
C.  INPUT  : LTYP = neutrino type (1,...,6)nue,anue,numu,anumu
C                                          nutau,anutau
C           The target nucleus is choosen randomly p or n
C
C-----------------------------------------------------------
	 IF(NEUDEC.LE.9)THEN
	   LTYP=NEUTYP
	   IF(LTYP.EQ.1.OR.LTYP.EQ.3.OR.LTYP.EQ.5)NUCTYP=2112
	   IF(LTYP.EQ.2.OR.LTYP.EQ.4.OR.LTYP.EQ.6)NUCTYP=2212
	 ELSEIF(NEUDEC.GE.10)THEN
	   LTYP=NEUTYP
	   NUCTYP=2112
	   RTYP=RNDM(V)*IT+1.
	   AITZ=ITZ
	   IF(RTYP.LE.AITZ)NUCTYP=2212
	 ENDIF
C            Neutrino energy is EPN in lab
  202      CONTINUE
	   IKTA=IT*RNDM(V)+2.
      IF(IPEV.GE.2)THEN
	WRITE(6,*)' NEUTYP,NUCTYP,IKTA,IDHKK(IKTA)',
     *              NEUTYP,NUCTYP,IKTA,IDHKK(IKTA)
      ENDIF
	   IF(IDHKK(IKTA).NE.NUCTYP) GO TO 202
	   ISTHKK(IKTA)=12
C          ENDIF
C	   IF(KKQ(III,1).EQ.1)THEN
	   IF(NUCTYP.EQ.2112)NUCTOP=2
	   IF(NUCTYP.EQ.2212)NUCTOP=1
           PLU21=PHKK(1,IKTA)
	   PLU22=PHKK(2,IKTA)
	   PLU23=PHKK(3,IKTA)
	   PLU24=PHKK(4,IKTA)
	   PLU25=PHKK(5,IKTA)
C          Call one qeldmo event
C	   CALL GEN_QEL(EPN,LTYP,PLU21,PLU22,PLU23,PLU24,PLU25)
C          Call one qel-pol event
	   IF(NEUDEC.LT.9)THEN
 	   CALL QEL_POL(EPN,LTYP,PLU21,PLU22,PLU23,PLU24,PLU25)
	   ELSEIF(NEUDEC.EQ.10)THEN
	      JINT=1
      IF(IPEV.GE.2)THEN
        WRITE(6,*)' CALL GEN_DELTA',EPN,LTYP,NUCTOP,JINT,
     &	      PLU21,PLU22,PLU23,PLU24,PLU25
      ENDIF
              CALL GEN_DELTA(EPN,LTYP,NUCTOP,JINT,
     &	      PLU21,PLU22,PLU23,PLU24,PLU25)
	   ELSEIF(NEUDEC.EQ.11)THEN
	      JINT=2
              CALL GEN_DELTA(EPN,LTYP,NUCTOP,JINT,
     &	      PLU21,PLU22,PLU23,PLU24,PLU25)
	   ELSEIF(NEUDEC.EQ.20)THEN
	     CALL FILENU(EPNN,LTYP,NUTYP,PLU21,PLU22,PLU23,
     &                      NHAD,IFLAG,LEND )
	     CALL ROTATE
	     EPN=EPNN
C
C            first initialize everything for energy EPN

             CALL LTINI(5,EPN,PPPN,EEECM)
C
C
      KPROJ=1
      IF(IJPROJ.NE.0) KPROJ=IJPROJ
      KPROJ=5
      IJPROJ=5
      KTARG=1
      ATNUC=IT
      ITN=IT-ITZ
      APNUC=IP
      IPN=IP-IPZ
      AMPROJ =AAM(KPROJ)
      AMTAR =AAM(KTARG)
*                             nucleon-nucleon cms
C     IBPROJ=1
      EPROJJ=EPN
      PPROJJ= SQRT((EPN-AMPROJ)*(EPN+AMPROJ))
      PPN=PPROJJ
C     PPROJJ= EPN
C     UMOJ= SQRT( AMTAR**2 + 2.*AMTAR*EPROJJ)
      UMOJ= SQRT(AMPROJ**2 + AMTAR**2 + 2.*AMTAR*EPROJJ)
      GAMCM = (EPROJJ+AMTAR)/UMOJ
      BGCM=PPROJJ/UMOJ
      GACMS=GAMCM
      BGCMS=BGCM
      UMO=UMOJ
      EPROJ=EPROJJ
      PPROJ=PPROJJ
C     COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
      ECM=UMOJ
      PCMJ=GAMCM*PPROJJ - BGCM*EPROJJ
      PCM=PCMJ
C
      IF(IPEV.GE.1)WRITE(6,*)' EPN,PPROJJ,UMOJ,GAMCM,BGCM,PCMJ,ECM',
     &EPN,PPROJJ,UMOJ,GAMCM,BGCM,PCMJ,ECM

C&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
C
C            pick out interacting nucleon and give the
C            Fermi momentum PLU21,PLU22,PLU23 to it
	     NUCTYP=NUTYP
	     NEUTYP=LTYP
  702        CONTINUE
	     IKTA=IT*RNDM(V)+2.
             IF(IPEV.GE.1)THEN
	       WRITE(6,*)' NEUTYP,NUCTYP,IKTA,IDHKK(IKTA)',
     *              NEUTYP,NUCTYP,IKTA,IDHKK(IKTA)
             ENDIF
	     IF(IDHKK(IKTA).NE.NUTYP) GO TO 702
	     ISTHKK(IKTA)=12
             PHKK(1,IKTA)=PLU21
	     PHKK(2,IKTA)=PLU22
	     PHKK(3,IKTA)=PLU23
C                Balance Fermi momenta
               PHKK(4,IKTA)=SQRT(PHKK(5,IKTA)**2+ 
     +         PHKK(1,IKTA)**2+ PHKK(2,IKTA)**2+ PHKK(3,IKTA)**2)
	     TXFE=0.0
             TYFE=0.0
             TZFE=0.0
             DO 704 KKK=1,IT
	       III=KKK+1
	       TXFE=TXFE+PHKK(1,III)
	       TYFE=TYFE+PHKK(2,III)
	       TZFE=TZFE+PHKK(3,III)
  704        CONTINUE
             TXFE=TXFE/(IT-1)
             TYFE=TYFE/(IT-1)
             TZFE=TZFE/(IT-1)
             DO 705 KKK=1,IT
               IHKK=KKK + 1
	       IF(IHKK.NE.IKTA)THEN
               PHKK(1,IHKK)=PHKK(1,IHKK) - TXFE
               PHKK(2,IHKK)=PHKK(2,IHKK) - TYFE
               PHKK(3,IHKK)=PHKK(3,IHKK) - TZFE
               PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)**2+ 
     +         PHKK(1,IHKK)**2+ PHKK(2,IHKK)**2+ PHKK(3,IHKK)**2)
	       ENDIF
  705        CONTINUE
	   ENDIF
           IF(INIQEL.LE.20)THEN
C	     DO IKI=1,40
	     CALL PYLIST(1)
C	     ENDDO
           ENDIF
C
C                        Write events to file qeld.evt
C                       this is now done in dpmnuc6.f
C
C                              ADD particle to HKKEVT COMMON	 
      IIIMAX = 5
      IF(NEUDEC.GE.10)IIIMAX=7
      IF(NEUDEC.EQ.20)IIIMAX=NHAD
      IF(KLU(1,2).EQ.16.OR.KLU(1,2).EQ.-16)THEN
        IF(NEUDEC.EQ.1)THEN
	  IIIMAX = 8
        ENDIF
      ENDIF
      DO 200 III=4,IIIMAX
	 IF(KLU(III,1).EQ.1)THEN 
	   NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
	   ISTHKK(NHKK)=KLU(III,1)
	   IDHKK(NHKK)=KLU(III,2)
	   IF (ISTHKK(NHKK).EQ.15)ISTHKK(NHKK)=2
	   IF (ISTHKK(NHKK).EQ.11)ISTHKK(NHKK)=2
	   JMOHKK(1,NHKK)=IKTA
	   JMOHKK(2,NHKK)=0
	   JDAHKK(1,NHKK)=0
	   JDAHKK(2,NHKK)=0
	   PHKK(1,NHKK)=PLU(III,1)
	   PHKK(2,NHKK)=PLU(III,2)
	   PHKK(3,NHKK)=PLU(III,3)
	   PHKK(4,NHKK)=PLU(III,4)
C	   WRITE(6,*)'PHKK',NHKK,(PHKK(IKLO,NHKK),IKLO=1,4)
           NRHKK=MCIHAD(IDHKK(NHKK))
C                     drop Pauli blocking test (is in dpmqelpo)
C	   IF(NRHKK.EQ.1.OR.NRHKK.EQ.8)THEN
C	    IF(NRHKK.EQ.1)THEN
C     IF(PHKK(4,NHKK).LE.TAEFEP+AAM(NRHKK))THEN
C	       WRITE(6,*)' Pauli Blocking of p',PHKK(4,NHKK),TAEFEP
C	     ENDIF
C	    ENDIF
C	    IF(NRHKK.EQ.8)THEN
C     IF(PHKK(4,NHKK).LE.TAEFEN+AAM(NRHKK))THEN
C       WRITE(6,*)' Pauli Blocking of n',PHKK(4,NHKK),TAEFEN
C     ENDIF
C    ENDIF
	  IF(NRHKK.EQ.1.OR.NRHKK.EQ.8)THEN
	    IF(PHKK(4,NHKK)-AAM(NRHKK).LE.TAEPOT(NRHKK))THEN
	     ISTHKK(NHKK)=16
	    ENDIF
          ENDIF
C   ENDIF
C	   PHKK(5,NHKK)=AAM(NRHKK)
	   PHKK(5,NHKK)=PLU(III,5)
	   VHKK(1,NHKK)=VHKK(1,IKTA)
	   VHKK(2,NHKK)=VHKK(2,IKTA)
	   VHKK(3,NHKK)=VHKK(3,IKTA)
	   VHKK(4,NHKK)=VHKK(4,IKTA)
           IF(III.EQ.4)THEN
             WHKK(1,NHKK)=POLARX(1)
             WHKK(2,NHKK)=POLARX(2)
             WHKK(3,NHKK)=POLARX(3)
             WHKK(4,NHKK)=POLARX(4)
           ELSE
	   WHKK(1,NHKK)=WHKK(1,IKTA)
	   WHKK(2,NHKK)=WHKK(2,IKTA)
	   WHKK(3,NHKK)=WHKK(3,IKTA)
	   WHKK(4,NHKK)=WHKK(4,IKTA)
           ENDIF
C	 ENDIF
	ENDIF
  200 CONTINUE
  201 CONTINUE
         CALL BACKROT
           IF(INIQEL.LE.20)THEN
	     CALL PYLIST(1)
           ENDIF
C
C                                  Transform into cms
 	DO 111 I=NHKKH1+1,NHKK
 	  PZNN=PHKK(3,I)
 	  ENN=PHKK(4,I)
 	  PHKK(3,I)=GACMS*PZNN-BGCMS*ENN
 	  PHKK(4,I)=GACMS*ENN-BGCMS*PZNN
C	   WRITE(6,*)'PHKK',I,(PHKK(IKLO,I),IKLO=1,4)
  111   CONTINUE
C-----------------------------------------------------------------------
C
C
C-----------------------------------------------------------------------
C-----------------------------------------------------------------------

      IF (IPEV.GE.1) THEN
C	DO IKI=1,200
        WRITE(6,'(/A/)') ' KKEVT: FINAL LIST OF ENTRIES TO /HKKEVT/'
C	ENDDO
          DO 121 IHKK=1,NHKK
          WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
  121     CONTINUE
        ENDIF
C
C
  110 CONTINUE
C
C
C
      RETURN
      END
      SUBROUTINE KKEVDI(NHKKH1,EPN,PPN,KKMAT,IREJ)
*
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON/INTNEZ/NDZ,NZD
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C      /
C INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,RPTSHM.
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
*KEEP,NSHMAK.
      COMMON /NSHMAK/ NNSHMA,NPSHMA,NTSHMA,NSHMAC,NSHMA2
*KEEP,ZENTRA.
      COMMON /ZENTRA/ ICENTR
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,NUCPOS.
      COMMON /NUCPOS/INVVP(248),INVVT(248),INVSP(248),INVST(248), NUVV,
     +NUVS,NUSV,NUSS,INSVP(248),INSVT(248),INSSP(248),INSST(248), ISVEAP
     +(248),ISVEAT(248),ISSEAP(248),ISSEAT(248), IVSEAP(248),IVSEAT
     +(248), ISLOSP(248),ISLOST(248),INOOP(248),INOOT(248),NUOO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
      COMMON /EVAPPP/IEVAP
*KEEP,RTAR.
      COMMON /RTAR/ RTARNU
*KEEP,INNU.
      COMMON /INNU/INUDEC
*KEEP,HADTHR.
      COMMON /HADTHR/ EHADTH,INTHAD
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEND.
      COMMON /DIFFRA/ ISINGD,IDIFTP,IOUDIF,IFLAGD
*
      LOGICAL LSEADI
       CHARACTER*108  A109
      COMMON /SEADIQ/ LSEADI
      COMMON /EVFLAG/NUMEV
      COMMON /DIQUAX/AMEDD,IDIQUA,IDIQUU
C
C-----------------------------------------------------------------------
C     PARAMETER (INTMX=2488)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON /FELIRE/AMRECD,KJPRO
      DIMENSION PPPP(4),RMAX(5),NOMAX(5)
C*******************************************************************"
C
C     KINEMATICS
C
C********************************************************************
C
      IREJ = 0
*
      AAM(26)=AAM(23)
C
      KPROJ=1
      IF(IJPROJ.NE.0) KPROJ=IJPROJ
      KTARG=1
      ATNUC=IT
      ITN=IT-ITZ
      APNUC=IP
      IPN=IP-IPZ
      AMPROJ =AAM(KPROJ)
      AMTAR =AAM(KTARG)
*                             nucleon-nucleon cms
C     IBPROJ=1
      EPROJ=EPN
      PPROJ = SQRT((EPN-AMPROJ)*(EPN+AMPROJ))
      UMO = SQRT(AMPROJ**2 + AMTAR**2 + 2.*AMTAR*EPROJ)
      GAMCM = (EPROJ+AMTAR)/UMO
      BGCM=PPROJ/UMO
      ECM=UMO
      PCM=GAMCM*PPROJ - BGCM*EPROJ
C
      IF(IPEV.GE.1) PRINT 1000,IP,IPZ,IT,ITZ,IJPROJ,IBPROJ, EPROJ,PPROJ,
     +AMPROJ,AMTAR,UMO,GAMCM,BGCM
 1000 FORMAT(' ENTRY KKEVDI'/ '    IP,IPZ,IT,ITZ,IJPROJ,IBPROJ',6I5/
     +'    EPROJ,PPROJ,AMPROJ,AMTAR,UMO,GAMCM,BGCM'/10E12.3)
 
C
C****                            CHANGE PARAMETERS FROM COMMON \INPDAT\
      AS=0.5
      B8=0.4
C                                CHAIN PT BIGGER THAN PARTICLE PT
      N9483=0
*  entry after rejection of an event because of kinematical reasons
*  several trials are made to realize a sampled Glauber event
   10 CONTINUE
      NDZ=0
      NZD=0
      N9483=N9483+1
      IF (MOD(N9483,200).EQ.0) THEN
        WRITE(6,'(A,I5,A,I5,A)') ' KKEVT: Glauber event',NUMEV,
     +  ' rejected after', N9483, ' trials'
        WRITE(6, 1010) NN,NP,NT
        WRITE(6,1020) IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +  IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,
     +  IRVS13,IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
        N9483=1
        GO TO 20
      ELSEIF(N9483.GT.1) THEN
                                                                 GOTO 30
      ENDIF
 1010 FORMAT (5X,' N9483 LOOP - NN, NP, NT',5I10)
 1020 FORMAT (5X,' N9483 LOOP - REJECTION COUNTERS ',/,5I8/2(8I8/))
C
C***************************************************************
C
C     SAMPLE NUMBERS OF COLLISION A LA SHMAKOV---------------
C
C
C                 This is done here for a h-A event to obtain
C                the positions of the nucleons of A
C
C
C     TOTAL NUMBER OF INTERACTIONS = NN
C     NUMBER OF INTERACTING NUCLEONS
C                  FROM PROJECTILE = NP
C                  FROM TARGET = NT
C
   20 CONTINUE
   22 CONTINUE
      CALL SHMAKO(IP,IT,BIMP,NN,NP,NT,JSSH,JTSH,PPROJ,KKMAT)
      BIMPAC=BIMP
      NSHMAC=NSHMAC+1
      NNSHMA=NN
      NPSHMA=NP
      NTSHMA=NT
*  entry for repeated trial to realize a sampled Glauber event
   30 CONTINUE
      IF (IPEV.GE.3) THEN
        WRITE(6, 1040) IP,IPZ,IT,ITZ,EPROJ,PPROJ,NN,NP,NT
 1040 FORMAT ('   752 FORM ',4I10,2F10.3,5I10)
        WRITE (6,'(/A,2I5,1PE10.2,3I5)') ' KKEVT: IP,IT,BIMP,NN,NP,NT ',
     +  IP,IT,BIMP,NN,NP,NT
        WRITE (6,'(/2A)')
     +  ' KKEVT: JSSH(KKK),JTSH(KKK),INTER1(KKK),INTER2(KKK),',
     +  ' PKOO(3,KKK),TKOO(3,KKK)'
        ITUM=MAX(IT,IP)
        DO 40 KKK=1,ITUM
          WRITE (6,'(4I5,6(1PE11.3))') JSSH(KKK),JTSH(KKK),INTER1(KKK),
     +    INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),PKOO(3,KKK), TKOO(1,KKK),
     +    TKOO(2,KKK),TKOO(3,KKK)
 
   40   CONTINUE
      ENDIF
C
C-----------------------------------------------------------------------
C                  STORE PROJECTILE HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING PROJECTILES ISTHKK=11
C                              NONINTERACTING ...      ISTHKK=13
C                            - FERMI MOMENTA IN CORRESP. REST SYSTEM
C-----------
      NHKK=0
C
      NCPP=0
      NCPN=0
C                      DEFINE FERMI MOMENTA/ENERGIES FOR PROJECTILE
C
      PXFE=0.0
      PYFE=0.0
      PZFE=0.0
      DO 50 KKK=1,IP
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C       IF (JSSH(KKK).GT.0) THEN
          ISTHKK(NHKK)=11
C       ELSE
C         ISTHKK(NHKK)=13
C       ENDIF
C*
          KPROJ=IJPROJ
          PHKK(1,NHKK)=0.
          PHKK(2,NHKK)=0.
          PHKK(3,NHKK)=0.
          PHKK(4,NHKK)=AAM(KPROJ)
          PHKK(5,NHKK)=AAM(KPROJ)
C
        KKPROJ(KKK)=KPROJ
        IDHKK(NHKK)=MPDGHA(KPROJ)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
C
        PHKK(5,NHKK)=AAM(KPROJ)
        VHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        VHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        WHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNP(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1050 FORMAT (I6,I4,5I6,9E10.2)
C
   50 CONTINUE
C
C-----------------------------------------------------------------------
C                  STORE TARGET HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING TARGETS     ISTHKK=12
C                              NONINTERACTING ...      ISTHKK=14
C-----------
C---------------------
      NHADRI=0
      NCTP=0
      NCTN=0
C
      TXFE=0.0
      TYFE=0.0
      TZFE=0.0
      DO 70 KKK=1,IT
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C       IF (JTSH(KKK).GT.0) THEN
C         ISTHKK(NHKK)=12
C         NHADRI=NHADRI+1
C         IF (NHADRI.EQ.1) IHTAWW=NHKK
C         IF (EPN.LE.EHADTW) THEN
C           IF (NHADRI.GT.1) ISTHKK(NHKK)=14
C         ENDIF
C       ELSE
          ISTHKK(NHKK)=14
C       ENDIF
        IF(IT.GE.2)THEN
        FRTNEU=FLOAT(ITN)/ATNUC
        SAMTES=RNDM(v)
        IF(SAMTES.LT.FRTNEU.AND.NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(SAMTES.GE.FRTNEU.AND.NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ELSEIF(NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ENDIF
C
        IF(KTARG.EQ.1) THEN
          PFERM = TAMFEP
        ELSE
          PFERM = TAMFEN
        ENDIF
C       CALL FER4M(PFERM,FPX,FPY,FPZ,FE,KTARG)
        CALL FER4MT(IT,PFERM,FPX,FPY,FPZ,FE,KTARG)
        TXFE=TXFE + FPX
        TYFE=TYFE + FPY
        TZFE=TZFE + FPZ
        PHKK(1,NHKK)=FPX
        PHKK(2,NHKK)=FPY
        PHKK(3,NHKK)=FPZ
        PHKK(4,NHKK)=FE
        PHKK(5,NHKK)=AAM(KTARG)
        ELSE
        PHKK(1,NHKK)=0. 
        PHKK(2,NHKK)=0. 
        PHKK(3,NHKK)=0. 
        PHKK(4,NHKK)=AAM(KTARG)
        PHKK(5,NHKK)=AAM(KTARG)
        ENDIF
C
        KKTARG(KKK)=KTARG
        IDHKK(NHKK)=MPDGHA(KTARG)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        VHKK(1,NHKK)=(TKOO(1,KKK))*1.E-12
        VHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        WHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNT(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(6,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
   70 CONTINUE
C                          balance Sampled Fermi momenta
      IF(IT.GE.2) THEN
        TASUMA=ITZ*AAM(1) + (IT-ITZ)*AAM(8)
        TASUBI=0.0
        TAMASU=0.0
        TXFE=TXFE/IT
        TYFE=TYFE/IT
        TZFE=TZFE/IT
        DO 80 KKK=1,IT
          IHKK=KKK + IP
          PHKK(1,IHKK)=PHKK(1,IHKK) - TXFE
          PHKK(2,IHKK)=PHKK(2,IHKK) - TYFE
          PHKK(3,IHKK)=PHKK(3,IHKK) - TZFE
          PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)** 2+ PHKK(1,IHKK)** 2+ PHKK
     +    (2,IHKK)** 2+ PHKK(3,IHKK)**2)
          ITSEC=MCIHAD(IDHKK(IHKK))
          TASUBI=TASUBI + PHKK(4,IHKK) - PHKK(5,IHKK) - TAEPOT(ITSEC)
          TAMASU=TAMASU + PHKK(4,IHKK) - TAEPOT(ITSEC)
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
   80   CONTINUE
C***         definition of initial state
        TABI=-EBIND(IT,ITZ)
        TAMA=(IT-ITZ)*AAM(8) + ITZ*AAM(1) + TABI
        TAIMMA=TAMA - TAMASU
      ENDIF
C
      IF(IPEV.GT.3) THEN
        WRITE(6,'(/A/5X,A/5X,4(1PE11.3))') ' KKEVT: FERMI MOMENTA',
     +  'PRMFEP,PRMFEN, TAMFEP,TAMFEN', PRMFEP,PRMFEN, TAMFEP,TAMFEN
 
      ENDIF
C-----------------------------------------------------------------------
      IFLAGD = 0
C-----------------------------------------------------------------------
C
      IF (IPEV.GE.6) THEN
        ITUM=MAX0(IP,IT,NN)
        WRITE(6,'(A,I10)')' KKEVT ITUM loop limit',ITUM
        WRITE(6,'(A,2A)') ' KKEVT (AFTER XKSAMP):',
     +  ' JSSH, JSSHS, JTSH, JTSHS, INTER1, INTER2',
     +  ' PKOO(1),PKOO(2),PKOO(3), TKOO(1),TKOO(2),TKOO(3)'
        DO 100 KKK=1,ITUM
          WRITE (6,'(6I5,6(1PE11.3))') JSSH(KKK),JSSHS(KKK),JTSH(KKK),
     +    JTSHS(KKK), INTER1(KKK),INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),
     +    PKOO(3,KKK), TKOO(1,KKK),TKOO(2,KKK),TKOO(3,KKK)
 
 
  100   CONTINUE
      ENDIF
C-----------------------------------------------------------------------
C                 TRANSFORM MOMENTA OF INTERACTING NUCLEONS
C                 (INCLUDING FERMI MOMENTA FROM NUCLEUS REST FRAMES)
C                 INTO NUCLEON-NUCLEON CMS (DEFINED WITHOUT FERMI MOM.
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT before NUCMOM'
      DO 7745 IHKK=1,NHKK
        IF (IPHKK.GE.2) WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 7745 CONTINUE
      CALL NUCMOM
      IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after NUCMOM'
      NONUST=0
      NONUJT=0
      NOMJE=0
      NOMJER=0
C
C-----------------------------------------------------------------------
C-----------------------------------------------------------------------
C
      NHKKH1=NHKK
C-----------------------------------------------------------------------
C
C                 Read momentum shifts for nucleons from file
C                             diffnuc.evt
C
C                  KFORM=1 J.R.file diffnuc.evt
C                  KFORM=2 R.E.file diffnuc.evt
C----------------------------------------------------------------------
      KFORM=2
  214 CONTINUE
      IF(KFORM.EQ.1)THEN
        READ(29,'(I5,4E15.6)')NDIFFN,PPPP(1),PPPP(2),PPPP(3),PPPP(4)
      ELSEIF(KFORM.EQ.2)THEN
	READ(29,'(1X,I5,E12.4)')KJPRO,AMRECD
	WRITE(6,'(1X,I5,E12.4)')KJPRO,AMRECD
	READ(29,'(1X,I5)')IMIST
C	WRITE(6,'(1X,I5)')IMIST
	READ(29,'(1X,I5)')IMIST
C	WRITE(6,'(1X,I5)')IMIST
	READ(29,'(1X,I5,4E18.10)')IMIST,PPPP(1),PPPP(2),PPPP(3),PPPP(4)
	WRITE(6,'(1X,I5,4E18.10)')IMIST,PPPP(1),PPPP(2),PPPP(3),PPPP(4)
C                    The following READ were fine for CD
C	READ(29,'(1X,I5)')IMIST
C	WRITE(6,'(1X,I5)')IMIST
C	READ(29,'(1X,I5)')IMIST
C	WRITE(6,'(1X,I5)')IMIST
C	READ(29,'(1X,I5)')IMIST
C	WRITE(6,'(1X,I5)')IMIST
      ENDIF
C-----------------------------------------------------------------------
C
C               determine one of the target nucleons as involved
C                         in the diffractive scattering
C
C-----------------------------------------------------------------------
      RMAX(1)=0.
      RMAX(2)=0.
      RMAX(3)=0.
      RMAX(4)=0.
      RMAX(5)=0.
      NOMAX(1)=0
      NOMAX(2)=0
      NOMAX(3)=0
      NOMAX(4)=0
      NOMAX(5)=0
      DO 211 I=2,NHKK
	RRRN=SQRT(VHKK(1,I)**2+VHKK(2,I)**2)
	IF(RMAX(1).LT.RRRN)THEN
	  RMAX(1)=RRRN
	  NOMAX(1)=I
        ENDIF
  211 CONTINUE
      DO 212 I=2,NHKK
	IF(I.EQ.NOMAX(1))GO TO 212
	RRRN=SQRT(VHKK(1,I)**2+VHKK(2,I)**2)
	IF(RMAX(2).LT.RRRN)THEN
	  RMAX(2)=RRRN
	  NOMAX(2)=I
        ENDIF
  212 CONTINUE
      DO 213 I=2,NHKK
	IF(I.EQ.NOMAX(1))GO TO 213
	IF(I.EQ.NOMAX(2))GO TO 213
	RRRN=SQRT(VHKK(1,I)**2+VHKK(2,I)**2)
	IF(RMAX(3).LT.RRRN)THEN
	  RMAX(3)=RRRN
	  NOMAX(3)=I
        ENDIF
  213 CONTINUE
C-----------------------------------------------------------------------
C
C        have interaction with nucleon nomax(3)
C
C     READ(29,'(I5,4E15.6)')NDIFFN,PPPP(1),PPPP(2),PPPP(3),PPPP(4)
C-----------------------------------------------------------------------
C
      NWEPAU=0
 215  CONTINUE
      IF(NWEPAU.EQ.0)IINT=NOMAX(3)
      IF(NWEPAU.EQ.1)IINT=NOMAX(2)
      IF(NWEPAU.EQ.2)IINT=NOMAX(1)
      NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
      ISTHKK(NHKK)=1
      IDHKK(NHKK)=IDHKK(IINT)
      JMOHKK(1,NHKK)=IINT
      JMOHKK(2,NHKK)=0
      JDAHKK(1,NHKK)=0
      JDAHKK(2,NHKK)=0
      NRHKK=MCIHAD(IDHKK(NHKK))
      PHKK(1,NHKK)=PHKK(1,IINT)+PPPP(1)
      PHKK(2,NHKK)=PHKK(2,IINT)+PPPP(2)
      PHKK(3,NHKK)=PHKK(3,IINT)+PPPP(3)
      PHKK(4,NHKK)=SQRT(PHKK(1,NHKK)**2+PHKK(2,NHKK)**2+
     * PHKK(3,NHKK)**2+AAM(NRHKK)**2)
      PHKK(5,NHKK)=AAM(NRHKK)
      IF(NRHKK.EQ.-1.OR.NRHKK.EQ.-8)THEN
       IF(NRHKK.EQ.1)THEN
        IF(PHKK(4,NHKK).LE.TAEFEP+AAM(NRHKK))THEN
         WRITE(6,*)' Pauli Blocking of p',NWEPAU,PHKK(4,NHKK),TAEFEP
	 NWEPAU=NWEPAU+1
	 NHKK=NHKK-1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C 	 IF(NWEPAU.LE.2)GO TO 215
         KFORM=2
         IF(KFORM.EQ.1)THEN
           AABBCC=0.
         ELSEIF(KFORM.EQ.2.AND.IREJ.EQ.0)THEN
C          The next 3 lines only for 6 (J/psi)
           READ(29,'(1X,I5)')KREPA
           READ(29,'(1X,I5)')KREPA
           READ(29,'(1X,I5)')KREPA
C
           READ(29,'(1X,I5)')KREPA
           DO 1975 KRE=1,KREPA
             READ(29,'(1X,A)')A109
 1975      CONTINUE
         ENDIF
         GO TO 214
        ENDIF
       ENDIF
       IF(NRHKK.EQ.8)THEN
        IF(PHKK(4,NHKK).LE.TAEFEN+AAM(NRHKK))THEN
         WRITE(6,*)' Pauli Blocking of n',NWEPAU,PHKK(4,NHKK),TAEFEN
	 NWEPAU=NWEPAU+1
	 NHKK=NHKK-1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C	 IF(NWEPAU.LE.2)GO TO 215
       KFORM=2
       IF(KFORM.EQ.1)THEN
         AABBCC=0.
       ELSEIF(KFORM.EQ.2.AND.IREJ.EQ.0)THEN
C             The next 3 lines only for 6 (J/psi)
         READ(29,'(1X,I5)')KREPA
         READ(29,'(1X,I5)')KREPA
         READ(29,'(1X,I5)')KREPA
C
         READ(29,'(1X,I5)')KREPA
         DO 1976 KRE=1,KREPA
           READ(29,'(1X,A)')A109
 1976    CONTINUE
       ENDIF
	 GO TO 214
        ENDIF
       ENDIF
       IF(PHKK(4,NHKK)-AAM(NRHKK).LE.TAEPOT(NRHKK))THEN
        ISTHKK(NHKK)=16
       ENDIF
      ENDIF
      ISTHKK(IINT)=12
      IKTA=IINT
      VHKK(1,NHKK)=VHKK(1,IKTA)
      VHKK(2,NHKK)=VHKK(2,IKTA)
      VHKK(3,NHKK)=VHKK(3,IKTA)
      VHKK(4,NHKK)=VHKK(4,IKTA)
      WHKK(1,NHKK)=WHKK(1,IKTA)
      WHKK(2,NHKK)=WHKK(2,IKTA)
      WHKK(3,NHKK)=WHKK(3,IKTA)
      WHKK(4,NHKK)=WHKK(4,IKTA)
C
C-----------------------------------------------------------------------
        IF (IPEV.GE.1) THEN
        WRITE(6,'(/A/)') ' KKEVT: FINAL LIST OF ENTRIES TO /HKKEVT/'
          DO 121 IHKK=1,NHKK
          WRITE(6,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
  121     CONTINUE
        ENDIF
C
C
  110 CONTINUE
C
C
C
      RETURN
      END
      SUBROUTINE LUINOL
C
C
      COMMON/LUDAT3/MDCY(500,3),MDME(2000,2),BRAT(2000),KFDP(2000,5)
C                           Prevent particles dacaying
C                 KOS
      KC=LUCOMP(310)
      MDCY(KC,1)=0
C                 PIO
      KC=LUCOMP(111)
      MDCY(KC,1)=0
C                 LAMBDA
      KC=LUCOMP(3122)
      MDCY(KC,1)=0
C                 ALAMBDA
      KC=LUCOMP(-3122)
      MDCY(KC,1)=0
C                 SIG+
      KC=LUCOMP(3222)
      MDCY(KC,1)=0
C                 ASIG+
      KC=LUCOMP(-3222)
      MDCY(KC,1)=0
C                 SIG-
      KC=LUCOMP(3112)
      MDCY(KC,1)=0
C                 ASIG-
      KC=LUCOMP(-3112)
      MDCY(KC,1)=0
C                 SIG0
C     KC=LUCOMP(3212)
C     MDCY(KC,1)=0
C                 ASIG0
C     KC=LUCOMP(-3212)
C     MDCY(KC,1)=0
C                 TET0
      KC=LUCOMP(3322)
      MDCY(KC,1)=0
C                 ATET0
      KC=LUCOMP(-3322)
      MDCY(KC,1)=0
C                 TET-
      KC=LUCOMP(3312)
      MDCY(KC,1)=0
C                 ATET-
      KC=LUCOMP(-3312)
      MDCY(KC,1)=0
C                 OMEGA-
      KC=LUCOMP(3334)
      MDCY(KC,1)=0
C                 AOMEGA-
      KC=LUCOMP(-3334)
      MDCY(KC,1)=0
C
      RETURN
      END
      SUBROUTINE TESTFILENU
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C      COMMON/BATLUND/N,K(4000,5),P(4000,5),V(4000,5)
      COMMON/PYJETS/N,NPAD,K(4000,5),P(4000,5),V(4000,5)
      COMMON/PHIROT/phr1,phr2,phr3
      INTEGER NFLAG(7)
      DO NEV = 1,100000
         CALL FILENU(EPN,LTYP,NUTYP,PLU21,PLU22,PLU23,NHAD,IFLAG,LEND)
         IF(LEND.EQ.1) GO TO 100
         NFLAG(IFLAG) = NFLAG(IFLAG) + 1
         write(6,150) (kw,K(kw,1),k(kw,2),(p(kw,j),j=1,5),kw=1,N)
         write(6,*)
C
C        Here rotates the event with the neutrino along +z
C
         CALL ROTATE
         write(6,150) (kw,K(kw,1),k(kw,2),(p(kw,j),j=1,5),kw=1,N)
         write(6,*)
c
c     Here returns the control to DPMJET
c
C
C        Here rotates the event back to lab frame
C
         CALL BACKROT
         write(6,150) (kw,K(kw,1),k(kw,2),(p(kw,j),j=1,5),kw=1,N)
         write(6,*)
      END DO
 100  CONTINUE
      WRITE(6,*) (NFLAG(J),J=1,7)
      STOP
 150  FORMAT(I5,2I5,5G10.3)
      END

      SUBROUTINE FILENU(EPN,LTYP,NUTYP,PLU21,PLU22,PLU23,NHO,
     $     IFLAG,LEND)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
ctp060123      SAVE
C     COMMON/BATLUND/N,K(4000,5),P(4000,5),V(4000,5)
      COMMON/PYJETS/N,NPAD,K(4000,5),P(4000,5),V(4000,5)
      COMMON /CLOUT/ LUN
      LOGICAL FIRST
      DATA FIRST/.TRUE./
      DATA LUN /25/
      DATA INIT/0/
      SAVE !FIRST
      OPEN (LUN,FILE='nuatm_new.dat',STATUS='OLD')
      IF(FIRST) THEN
         CALL READ_INI 
         FIRST = .FALSE.
      ENDIF
      INIT=INIT+1
      LEND = 0
      IFLAG = 0
      NHAD = 0
      READ (LUN, 10, ERR=1) NEV,  N, (V(1,J),J=1,3)      
      NHO=N
      DO L=1,N
	 READ (LUN, 15)LL, (K(L,J),J=1,5),(P(L,J),J=1,5)
         IF(L.GT.4.AND.K(L,1).EQ.1) NHAD = NHAD + 1
      ENDDO
      NONO=6
      IF(INIT.LE.20) THEN
         DO L=1,N
            WRITE(6, 15) L, (K(L,J),J=1,5),(P(L,J),J=1,5)
         ENDDO
      ENDIF
      EPN = P(1,4)
      LTYP = K(1,2)
      NUTYP = K(2,2)
      PLU21 = P(2,1)
      PLU21 = P(2,2)
      PLU21 = P(2,3)
      IF(N.EQ.4.OR.N.EQ.5) THEN
         IF(K(4,2).NE.K(1,2)) THEN
            IFLAG = 1                      ! quasi-elastic CC
         ELSE IF(K(4,2).EQ.K(1,2)) THEN
            IFLAG = 2                      ! quasi-elastic NC
         ENDIF
      ELSE IF(N.EQ.7) THEN
         IF(K(4,2).NE.K(1,2)) THEN
            IFLAG = 3                      ! delta resonance CC
         ELSE IF(K(4,2).EQ.K(1,2)) THEN
            IFLAG = 4                      ! delta resonance NC
         ENDIF
      ELSE IF(N.GT.7) THEN
         IF(K(4,2).NE.K(1,2)) THEN
            IFLAG = 5                      ! DIS CC
         ELSE IF(K(4,2).EQ.K(1,2)) THEN
            IFLAG = 6                      ! DIS NC
         ENDIF
      ELSE
         WRITE(6,*) N,NEV,K(1,2),K(4,2)
         IFLAG  = 7                        ! impossible
      ENDIF
      RETURN
1     LEND  = 1
10    FORMAT(1X,I7, 3X, I3, 2X, 3G12.4)
15    FORMAT(I5,5I7,5G12.4)
      END

      SUBROUTINE  READ_INI
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON /CLOUT/ LUN
      REAL*4  RRAT(6),EMIN,VERS,AK
      CHARACTER*50  LINE
      DO J=1,10000
         READ(LUN, 10)   LINE
         IF (LINE(1:1) .EQ. '!')   GOTO 100
      ENDDO
 100  CONTINUE
      READ (LUN,  110) VERS, JCODE, JFLUX, JRAT, AK
      READ (LUN, 120) EMIN, (RRAT(J),J=1,6)
      RETURN
 10   FORMAT (A50)
 110  FORMAT(1X,F5.2,3X, I2, 3X, 2I2, 3X, F10.2)
 120  FORMAT(1X,F12.4, 3X, 6G12.4)
      END


      SUBROUTINE TESTROT1S(PI,PO,PHI)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      DIMENSION ROT(3,3),PI(3),PO(3)
      ROT(1,1)=1.D0
      ROT(1,2)=0.D0
      ROT(1,3)=0.D0
      ROT(2,1)=0.D0
      ROT(2,2)=cos(phi)
      ROT(2,3)=-sin(phi)
      ROT(3,1)=0.D0
      ROT(3,2)=SIN(phi)
      ROT(3,3)=COS(phi)
      DO 140 J=1,3
        PO(J)=ROT(J,1)*PI(1)+ROT(J,2)*PI(2)+ROT(J,3)*PI(3)
  140 CONTINUE
      RETURN
      END


      SUBROUTINE TESTROT2S(PI,PO,PHI)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      DIMENSION ROT(3,3),PI(3),PO(3)
      ROT(1,1)=0.D0
      ROT(1,2)=1.D0
      ROT(1,3)=0.D0
      ROT(2,1)=cos(phi)
      ROT(2,2)=0.D0
      ROT(2,3)=-sin(phi)
      ROT(3,1)=sin(phi)
      ROT(3,2)=0.D0
      ROT(3,3)=COS(phi)
      DO 140 J=1,3
        PO(J)=ROT(J,1)*PI(1)+ROT(J,2)*PI(2)+ROT(J,3)*PI(3)
  140 CONTINUE
      RETURN
      END

      SUBROUTINE TESTROT3S(PI,PO,PHI)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      DIMENSION ROT(3,3),PI(3),PO(3)
      ROT(1,1)=0.D0
      ROT(2,1)=1.D0
      ROT(3,1)=0.D0
      ROT(1,2)=cos(phi)
      ROT(2,2)=0.D0
      ROT(3,2)=-sin(phi)
      ROT(1,3)=sin(phi)
      ROT(2,3)=0.D0
      ROT(3,3)=COS(phi)
      DO 140 J=1,3
        PO(J)=ROT(J,1)*PI(1)+ROT(J,2)*PI(2)+ROT(J,3)*PI(3)
  140 CONTINUE
      RETURN
      END

      SUBROUTINE TESTROT4S(PI,PO,PHI)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      DIMENSION ROT(3,3),PI(3),PO(3)
      ROT(1,1)=1.D0
      ROT(2,1)=0.D0
      ROT(3,1)=0.D0
      ROT(1,2)=0.D0
      ROT(2,2)=cos(phi)
      ROT(3,2)=-sin(phi)
      ROT(1,3)=0.D0
      ROT(2,3)=SIN(phi)
      ROT(3,3)=COS(phi)
      DO 140 J=1,3
        PO(J)=ROT(J,1)*PI(1)+ROT(J,2)*PI(2)+ROT(J,3)*PI(3)
  140 CONTINUE
      RETURN
      END

      SUBROUTINE ROTATE
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON/PYJETS/N,NPAD,K(4000,5),P(4000,5),V(4000,5)
      COMMON/PHIROT/phr1,phr2,phr3
      DIMENSION PI(3),PO(3)
C
C     Rotate events so that neutrino goeas along +z
C
      phr1=atan(p(1,2)/p(1,3))
      DO kw=1,N
         pi(1)=p(kw,1)
         pi(2)=p(kw,2)
         pi(3)=p(kw,3)
         CALL TESTROT1S(PI,Po,PHR1)
         DO ll=1,3
            IF(abs(po(ll)).LT.1.D-07) po(ll)=0.
         END DO
         p(kw,1)=po(1)
         p(kw,2)=po(2)
         p(kw,3)=po(3)
      END DO
      phr2=atan(p(1,1)/p(1,3))
      DO kw=1,N
         pi(1)=p(kw,1)
         pi(2)=p(kw,2)
         pi(3)=p(kw,3)
         CALL TESTROT2S(Pi,Po,PHR2)
         DO ll=1,3
            IF(abs(po(ll)).LT.1.D-07) po(ll)=0.
         END DO
         p(kw,1)=po(1)
         p(kw,2)=po(2)
         p(kw,3)=po(3)
      END DO
      phr3 = 0
      IF(p(1,3).lt.0) THEN
         phr3 = -1.
         DO kw=1,N
            P(kw,3) = -P(kw,3)
         END DO
      ENDIF
      RETURN
      END

      SUBROUTINE BACKROT
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON/PYJETS/N,NPAD,K(4000,5),P(4000,5),V(4000,5)
      COMMON/PHIROT/phr1,phr2,phr3
      DIMENSION PI(3),PO(3)

c
c     Rotates back event to lab frame
c
      IF(phr3.EQ.-1.) THEN
         DO kw=1,N
            P(kw,3) = -P(kw,3)
         END DO
      END IF
      DO kw=1,N
         pi(1)=p(kw,1)
         pi(2)=p(kw,2)
         pi(3)=p(kw,3)
         CALL TESTROT3S(Pi,Po,PHR2)
         DO ll=1,3
            IF(abs(po(ll)).LT.1.D-07) po(ll)=0.
         END DO
         p(kw,1)=po(1)
         p(kw,2)=po(2)
         p(kw,3)=po(3)
      END DO
      DO kw=1,N
         pi(1)=p(kw,1)
         pi(2)=p(kw,2)
         pi(3)=p(kw,3)
         CALL TESTROT4S(Pi,Po,PHR1)
         DO ll=1,3
            IF(abs(po(ll)).LT.1.D-07) po(ll)=0.
         END DO
         p(kw,1)=po(1)
         p(kw,2)=po(2)
         p(kw,3)=po(3)
      END DO
      RETURN
      END

      SUBROUTINE BACKDPM
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
      COMMON/PHIROT/phr1,phr2,phr3
      DIMENSION PI(3),PO(3)

c
c     Rotates back event to lab frame
c
      IF(phr3.EQ.-1.) THEN
         DO kw=1,NHKK
         IF((ISTHKK(KW).EQ.-1).OR.
     *    (ISTHKK(KW).EQ.1).OR.
     *    (ISTHKK(KW).EQ.1001))THEN
            PHKK(3,kw) = -PHKK(3,kw)
         ENDIF
         END DO
      END IF
         DO kw=1,NHKK
         IF((ISTHKK(KW).EQ.-1).OR.
     *    (ISTHKK(KW).EQ.1).OR.
     *    (ISTHKK(KW).EQ.1001))THEN
         pi(1)=pHKK(1,kw)
         pi(2)=pHKK(2,kw)
         pi(3)=pHKK(3,kw)
         CALL TESTROT3S(Pi,Po,PHR2)
         DO ll=1,3
            IF(abs(po(ll)).LT.1.D-07) po(ll)=0.
         END DO
         pHKK(1,kw)=po(1)
         pHKK(2,kw)=po(2)
         pHKK(3,kw)=po(3)
         ENDIF
      END DO
         DO kw=1,NHKK
         IF((ISTHKK(KW).EQ.-1).OR.
     *    (ISTHKK(KW).EQ.1).OR.
     *    (ISTHKK(KW).EQ.1001))THEN
         pi(1)=pHKK(1,kw)
         pi(2)=pHKK(2,kw)
         pi(3)=pHKK(3,kw)
         CALL TESTROT4S(Pi,Po,PHR1)
         DO ll=1,3
            IF(abs(po(ll)).LT.1.D-07) po(ll)=0.
         END DO
         pHKK(1,kw)=po(1)
         pHKK(2,kw)=po(2)
         pHKK(3,kw)=po(3)
         ENDIF
      END DO
      RETURN
      END

      SUBROUTINE DROPDI(NN,NP,NT,ECM)
C     Drop diffractive collisions out of the Glauber
C     cascade in nuclear collisions (For NN > 1 only)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (INTMX=2488)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
C     Fraction of diffractive collisions at given Energy
      FRACDIF=SIPPSD(ECM)/SIINEL(1,1,ECM)
      ANN=NN
      DANN=FRACDIF*ANN
      IDANN=DANN
      AIDANN=IDANN
      FDANN=DANN-AIDANN
      IF(RNDM(V).LT.FDANN)IDANN=IDANN+1
C     Total number of collisions NN is reduced by IDANN
C     WRITE(6,*)'NN,FRACDIF,FDANN,IDANN ',NN,FRACDIF,FDANN,IDANN
      NNNEW=NN-IDANN
      NPNEW=NP
      NTNEW=NT
      IF(IDANN.GT.0)THEN
        DO 1 I= NN-IDANN+1,NN
	  NI1=INTER1(I)
	  NI2=INTER2(I)
	  JSSH(NI1)=JSSH(NI1)-1
	  JTSH(NI2)=JTSH(NI2)-1
	  IF(JSSH(NI1).EQ.0)NPNEW=NPNEW-1
	  IF(JTSH(NI2).EQ.0)NTNEW=NTNEW-1
	  INTER1(I)=0
	  INTER2(I)=0
 1      CONTINUE	
      ENDIF	
C     WRITE (6,*)'NNNEW,NPNEW,NTNEW ',NNNEW,NPNEW,NTNEW
      NN=NNNEW
      NP=NPNEW
      NT=NTNEW
      RETURN
      END
      SUBROUTINE SAPTRE(AM1,G1,BGX1,BGY1,BGZ1,
     &                  AM2,G2,BGX2,BGY2,BGZ2)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C                   SELECT PT FOR CHAIN PAIRS, WHICH ARE RESONANCES
      B3=4.
      E1=G1*AM1
      PX1=BGX1*AM1
      PY1=BGY1*AM1
      PZ1=BGZ1*AM1
      E2=G2*AM2
      PX2=BGX2*AM2
      PY2=BGY2*AM2
      PZ2=BGZ2*AM2
C                   SAMPLE TRANSVERSE MOMENTUM LIKE IN BAMJET
C       ES DEFINED AS ES=SQRT(PT**2+AM**2)-AM
      ESMAX1=E1-AM1
      ESMAX2=E2-AM2
      ESMAX=MIN(ESMAX1,ESMAX2)
      IF(ESMAX.LE.0.05D0) RETURN
      HMA=AM1
      IF (B3*ESMAX.GT.60.D0)THEN
        EXEB=0.
      ELSE
        EXEB=EXP(-B3*ESMAX)
      ENDIF
      BEXP=HMA*(1.-EXEB)/B3
      AXEXP=(1.D0-(B3*ESMAX-1.D0)*EXEB)/B3**2
      WA=AXEXP/(BEXP+AXEXP)
      XAB=RNDM(WU)
   10 CONTINUE
      IF (XAB.LT.WA)THEN
        X=RNDM(V)
        Y=RNDM(V)
        ES=-2./(B3**2)*LOG(X*Y+1.E-7)
      ELSE
        X=RNDM(V)
        ES=ABS(-LOG(X+1.E-7)/B3)
      END IF
      IF(ES.GT.ESMAX)                                             GOTO10
      ES=ES+HMA
      HPS=SQRT((ES-HMA)*(ES+HMA))
   20 CONTINUE
      CALL DSFECF(SFE,CFE)
      SIP=SFE
      COP=CFE
      HPX=HPS*COP
      HPY=HPS*SIP
      PZ1NSQ=PZ1**2-HPS**2-2.*PX1*HPX-2.*PY1*HPY
      PZ2NSQ=PZ2**2-HPS**2+2.*PX2*HPX+2.*PY2*HPY
      IF(PZ1NSQ.LT.0.001D0.OR.PZ2NSQ.LT.0.001D0) RETURN
C     PZ1=SIGN(SQRT(PZ1NSQ),PZ1)
C     PZ2=SIGN(SQRT(PZ2NSQ),PZ2)
              PZ1=DSIGN(SQRT(PZ1NSQ),PZ1)
              PZ2=DSIGN(SQRT(PZ2NSQ),PZ2)
      PX1=PX1+HPX
      PY1=PY1+HPY
      PX2=PX2-HPX
      PY2=PY2-HPY
      BGX1=PX1/AM1
      BGY1=PY1/AM1
      BGZ1=PZ1/AM1
      BGX2=PX2/AM2
      BGY2=PY2/AM2
      BGZ2=PZ2/AM2
C     WRITE(6,1001) HPX,HPY
C1001 FORMAT(' HPX,HPY ',2F10.3)
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE SLTRAF(GA,BGA,EIN,PZIN,EOUT,PZOUT)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PZOUT=GA*PZIN - BGA*EIN
      EOUT=GA*EIN - BGA*PZIN
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE NUCMOM
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C***
C   FERMI-MOMENTA FOR ALL NUCLEONS
C                 TRANSFORMED INTO NN-CMS
C   FOR INCIDENT HADRONS USE CMS MOMENTUM
C***
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
       IF(IJPROJ.EQ.5)RETURN
C
C******************************    PROJECTILE
C                            - INTERACTING PROJECTILES ISTHKK=11
      DO 10 J=1,IP
C       IF(ISTHKK(J).EQ.11) THEN
          KK=KKPROJ(J)
          PRMOM(1,J)=PHKK(1,J)
          PRMOM(2,J)=PHKK(2,J)
          GAPROJ=EPROJ/AAM(KK)
          BGPROJ=PPROJ/AAM(KK)
          CALL SLTRAF(GAPROJ,-BGPROJ, PHKK(4,J),PHKK(3,J),PRMOM4,PRMOM3)
 
          CALL SLTRAF(GAMCM,+BGCM, PRMOM4,PRMOM3,PRMOM(4,J),PRMOM(3,J))
 
C       ENDIF
          PRMOM(5,J)=SQRT( ABS((PRMOM(4,J)-AAM(KK)) *(PRMOM(4,J)+AAM(KK)
     +    )))
   10 CONTINUE
C
C------------------------------    TARGET
C                             INTERACTING TARGET NUCLEONS ISTHKK=12
      IHKK=IP
      DO 20 J=1,IT
        IHKK=IHKK + 1
C       IF(ISTHKK(IHKK).EQ.12) THEN
          KK=KKTARG(J)
          TAMOM(1,J)=PHKK(1,IHKK)
          TAMOM(2,J)=PHKK(2,IHKK)
          CALL SLTRAF(GAMCM,BGCM, PHKK(4,IHKK),PHKK(3,IHKK),TAMOM(4,J),
     +    TAMOM(3,J))
          TAMOM(5,J)=SQRT(ABS( (TAMOM(4,J)-AAM(KK)) 
     +    *(TAMOM(4,J)+AAM(KK))))
 
C       ENDIF
   20 CONTINUE
C
      IF(IPEV.GE.6) THEN
        WRITE(6,'(/A,I5/5X,A)') ' NUCMOM: IP=',IP,
     +  ' J,IPVQ(J),IPPV1(J),IPPV2(J),ISTHKK,KKPROJ,PRMOM'
        DO 30 J=1,IP
          WRITE(6,'(I4,5I3,5(1PE11.3))') J,ISTHKK(J),KKPROJ(J), IPVQ(J),
     +    IPPV1(J),IPPV2(J), (PRMOM(JJ,J),JJ=1,5)
 
   30   CONTINUE
C
        WRITE(6,'(/A,I5/5X,A)') ' NUCMOM: IT=',IT,
     +  ' J,ITVQ(J),ITTV1(J),ITTV2(J),ISTHKK,KKTARG,TAMOM'
        IHKK=IP
        DO 40 J=1,IT
          IHKK=IHKK + 1
          WRITE(6,'(I4,5I3,5(1PE11.3))') J,ISTHKK(IHKK),KKTARG(J), ITVQ
     +    (J),ITTV1(J),ITTV2(J), (TAMOM(JJ,J),JJ=1,5)
 
   40   CONTINUE
      ENDIF
C
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE FER4M(PFERM,PXT,PYT,PZT,ET,KT)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C                SAMPLE FERMI MOMENTUM FROM DISTRIBUTION WITH T=0
C-----------
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEND.
C-----------
      IF (FERMP) THEN
        CALL DFERMI(PABS)
        PABS=PFERM*PABS
C                                 SAMPLE ANGLES
        CALL DPOLI(POLC,POLS)
        CALL DSFECF(SFE,CFE)
C
        CXTA=POLS*CFE
        CYTA=POLS*SFE
        CZTA=POLC
        ET=SQRT(PABS*PABS+AAM(KT)**2)
        PXT=CXTA*PABS
        PYT=CYTA*PABS
        PZT=CZTA*PABS
C
      ELSE
        ET=AAM(KT)
        PXT=0.
        PYT=0.
        PZT=0.
      ENDIF
C
      RETURN
      END
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE FER4MP(IP,PFERM,PXT,PYT,PZT,ET,KT)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON /FERFOR/IFERFO
C
C                SAMPLE FERMI MOMENTUM FROM DISTRIBUTION WITH T=0
C-----------
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEND.
C-----------
      IF (FERMP) THEN
        IF(IFERFO.EQ.1)THEN
	  CALL DFERMI(PABS)
          PABS=PFERM*PABS
        ENDIF
	IF(IFERFO.EQ.2)CALL DFATPR(IP,PABS)
C                                 SAMPLE ANGLES
        CALL DPOLI(POLC,POLS)
        CALL DSFECF(SFE,CFE)
C
        CXTA=POLS*CFE
        CYTA=POLS*SFE
        CZTA=POLC
        ET=SQRT(PABS*PABS+AAM(KT)**2)
        PXT=CXTA*PABS
        PYT=CYTA*PABS
        PZT=CZTA*PABS
C
      ELSE
        ET=AAM(KT)
        PXT=0.
        PYT=0.
        PZT=0.
      ENDIF
C
      RETURN
      END
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE FER4MT(IT,PFERM,PXT,PYT,PZT,ET,KT)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      COMMON /FERFOR/IFERFO
C
C                SAMPLE FERMI MOMENTUM FROM DISTRIBUTION WITH T=0
C-----------
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEND.
C-----------
C     WRITE(6,*)' FERMP',FERMP
      IF (FERMP) THEN
        IF(IFERFO.EQ.1)THEN
	  CALL DFERMI(PABS)
CWRITE(6,*)' PABS',PABS
          PABS=PFERM*PABS
CWRITE(6,*)' PABS',PABS
        ENDIF
	IF(IFERFO.EQ.2)CALL DFATTA(IT,PABS)
C                                 SAMPLE ANGLES
CWRITE(6,*)' PABS',PABS
        CALL DPOLI(POLC,POLS)
        CALL DSFECF(SFE,CFE)
C
        CXTA=POLS*CFE
        CYTA=POLS*SFE
        CZTA=POLC
        ET=SQRT(PABS*PABS+AAM(KT)**2)
        PXT=CXTA*PABS
        PYT=CYTA*PABS
        PZT=CZTA*PABS
C
      ELSE
        ET=AAM(KT)
        PXT=0.
        PYT=0.
        PZT=0.
      ENDIF
C
      RETURN
      END
      SUBROUTINE DFATTA(IT,PABS)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C       FERMI MOMENTUM A LA C. CIOFI DEGLI ATTI ET AL PRC53(96)1689
      DIMENSION PAR10(6),PAR20(6),PAR30(6),PAR40(6),PAR50(6),
     *          PAR60(6),PAR11(6),PAR21(6),PAR31(6),PAR41(6),
     *          AIA(6),ATT(101),CATT(101),AKA(101)
      COMMON/FATTAD/DAKA(101),FATT(101)
      DATA PAR10/1.61D0,2.74D0,3.24D0,3.57D0,1.80D0,0.D0/
      DATA PAR20/2.66D0,3.33D0,3.72D0,4.97D0,4.77D0,0.D0/
      DATA PAR30/3.54D0,6.66D0,0.D0,0.D0,0.D0,0.D0/
      DATA PAR40/0.D0,0.D0,11.1D0,19.8D0,25.5D0,0.D0/
      DATA PAR50/0.D0,0.D0,0.D0,15.D0,0.D0,0.D0/
      DATA PAR60/0.D0,0.D0,0.D0,0.D0,40.3D0,0.D0/
      DATA PAR11/.426D0,.326D0,.419D0,.230D0,.275D0,0.D0/
      DATA PAR21/1.6D0,1.4D0,1.77D0,1.2D0,1.01D0,0.D0/
      DATA PAR31/.0237D0,.0263D0,.0282D0,.0286D0,.0304D0,0.D0/
      DATA PAR41/.22D0,.22D0,.22D0,.22D0,.22D0,0.D0/
      DATA AIA/12.D0,16.D0,40.D0,56.D0,208.D0,209.D0/
      DATA INIT/0/
      AIT=IT
      IF(INIT.EQ.0)THEN
C                 INITIALIZATION
C                 INTERPOLATE PARAMETERS
      DO 1 I=1,4
	IF(AIT.GE.AIA(I).AND.AIT.LT.AIA(I+1))THEN
	  DAIT=(AIT-AIA(I))/(AIA(I+1)-AIA(I))
	  DBIT=1.D0-DAIT
	  III=I
        ENDIF
   1  CONTINUE
      IF(AIT.LT.AIA(1))THEN
	DBIT=1.D0
	DAIT=0.D0
	III=1
      ENDIF
      IF(AIT.GE.AIA(5))THEN
	DBIT=1.D0
	DAIT=0.D0
	III=5
      ENDIF
      A0=DBIT*PAR10(III)+DAIT*PAR10(III+1)
      B0=DBIT*PAR20(III)+DAIT*PAR20(III+1)
      C0=DBIT*PAR30(III)+DAIT*PAR30(III+1)
      D0=DBIT*PAR40(III)+DAIT*PAR40(III+1)
      E0=DBIT*PAR50(III)+DAIT*PAR50(III+1)
      F0=DBIT*PAR60(III)+DAIT*PAR60(III+1)
      A1=DBIT*PAR11(III)+DAIT*PAR11(III+1)
      B1=DBIT*PAR21(III)+DAIT*PAR21(III+1)
      C1=DBIT*PAR31(III)+DAIT*PAR31(III+1)
      D1=DBIT*PAR41(III)+DAIT*PAR41(III+1)
      INIT=1
      DK=0.04D0
      CATT(1)=0.D0
      DO 2 I=1,101
	AI=I
	AK=(AI-1.D0)*DK
	AKA(I)=AK
	DAKA(I)=AKA(I)
	ATT(I)=AK**2*(A0*EXP(-B0*AK**2)*(1.D0+C0*AK**2+
     *         D0*AK**4+E0*AK**6+F0*AK**8)+
     *         A1*EXP(-B1*AK**2)+C1*EXP(-D1*AK**2))
	IF(I.GT.1)CATT(I)=CATT(I-1)+ATT(I)
   2  CONTINUE
      DO 3 I=1,101
	CATT(I)=CATT(I)/CATT(101)
	FATT(I)=0.D0
   3  CONTINUE
      ENDIF
C          END INITIALIZATION
      RNDFA=RNDM(V)
      DO 10 I=1,101
	IF(RNDFA.LT.CATT(I))THEN
	  IATT=I
	  GO TO 11
	ENDIF
   10 CONTINUE
   11 CONTINUE
      PABS=AKA(IATT)*0.197D0
      FATT(IATT)=FATT(IATT)+1.D0/PABS**2
      RETURN
      END
      SUBROUTINE DFATPR(IP,PABS)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C       FERMI MOMENTUM A LA C. CIOFI DEGLI ATTI ET AL PRC53(96)1689
      DIMENSION PAR10(6),PAR20(6),PAR30(6),PAR40(6),PAR50(6),
     *          PAR60(6),PAR11(6),PAR21(6),PAR31(6),PAR41(6),
     *          AIA(6),ATT(101),CATT(101),AKA(101)
      DATA PAR10/1.61D0,2.74D0,3.24D0,3.57D0,1.80D0,0.D0/
      DATA PAR20/2.66D0,3.33D0,3.72D0,4.97D0,4.77D0,0.D0/
      DATA PAR30/3.54D0,6.66D0,0.D0,0.D0,0.D0,0.D0/
      DATA PAR40/0.D0,0.D0,11.1D0,19.8D0,25.5D0,0.D0/
      DATA PAR50/0.D0,0.D0,0.D0,15.D0,0.D0,0.D0/
      DATA PAR60/0.D0,0.D0,0.D0,0.D0,40.3D0,0.D0/
      DATA PAR11/.426D0,.326D0,.419D0,.230D0,.275D0,0.D0/
      DATA PAR21/1.6D0,1.4D0,1.77D0,1.2D0,1.01D0,0.D0/
      DATA PAR31/.0237D0,.0263D0,.0282D0,.0286D0,.0304D0,0.D0/
      DATA PAR41/.22D0,.22D0,.22D0,.22D0,.22D0,0.D0/
      DATA AIA/12.D0,16.D0,40.D0,56.D0,208.D0,209.D0/
      DATA INIT/0/
      AIT=IP
      IF(INIT.EQ.0)THEN
C                 INITIALIZATION
C                 INTERPOLATE PARAMETERS
      DO 1 I=1,4
	IF(AIT.GE.AIA(I).AND.AIT.LT.AIA(I+1))THEN
	  DAIT=(AIT-AIA(I))/(AIA(I+1)-AIA(I))
	  DBIT=1.D0-DAIT
	  III=I
        ENDIF
   1  CONTINUE
      IF(AIT.LT.AIA(1))THEN
	DBIT=1.D0
	DAIT=0.D0
	III=1
      ENDIF
      IF(AIT.GE.AIA(5))THEN
	DBIT=1.D0
	DAIT=0.D0
	III=5
      ENDIF
      A0=DBIT*PAR10(III)+DAIT*PAR10(III+1)
      B0=DBIT*PAR20(III)+DAIT*PAR20(III+1)
      C0=DBIT*PAR30(III)+DAIT*PAR30(III+1)
      D0=DBIT*PAR40(III)+DAIT*PAR40(III+1)
      E0=DBIT*PAR50(III)+DAIT*PAR50(III+1)
      F0=DBIT*PAR60(III)+DAIT*PAR60(III+1)
      A1=DBIT*PAR11(III)+DAIT*PAR11(III+1)
      B1=DBIT*PAR21(III)+DAIT*PAR21(III+1)
      C1=DBIT*PAR31(III)+DAIT*PAR31(III+1)
      D1=DBIT*PAR41(III)+DAIT*PAR41(III+1)
      INIT=1
      DK=0.04D0
      CATT(1)=0.D0
      DO 2 I=1,101
	AI=I
	AK=(AI-1.D0)*DK
	AKA(I)=AK
	ATT(I)=AK**2*(A0*EXP(-B0*AK**2)*(1.D0+C0*AK**2+
     *         D0*AK**4+E0*AK**6+F0*AK**8)+
     *         A1*EXP(-B1*AK**2)+C1*EXP(-D1*AK**2))
	IF(I.GT.1)CATT(I)=CATT(I-1)+ATT(I)
   2  CONTINUE
      DO 3 I=1,101
	CATT(I)=CATT(I)/CATT(101)
   3  CONTINUE
      ENDIF
C          END INITIALIZATION
      RNDFA=RNDM(V)
      DO 10 I=1,101
	IF(RNDFA.LT.CATT(I))THEN
	  IATT=I
	  GO TO 11
	ENDIF
   10 CONTINUE
   11 CONTINUE
      PABS=AKA(IATT)*0.197D0
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE FLKSAM
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C                              QUARK CONTENT
C                              OF PROJECTILE AND TARGET
C                              (HADRONS / ALL NUCLEONS)
C---------------------------------------------------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
C----------
      DIMENSION IHKKQ(-6:6),IHKKQQ(-3:3,-3:3)
      DATA IHKKQ/-6,-5,-4,-3,-1,-2,0,2,1,3,4,5,6/
      DATA IHKKQQ/-3303,-3103,-3203,0,0,0,0, -3103,-1103,-2103,0,0,0,0,
     +-3203,-2103,-2203,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,2203,2103,3203,
     +0,0,0,0,2103,1103,3103, 0,0,0,0,3203,3103,3303/
C----------------------------------------------------------------------
C
C   FLAVORS OF VALENCE QUARKS FROM PROJECTILE HADRON/NUCLEONS
C
C-----
C
      IF(IPEV.GE.3) WRITE(6,'(A,6I4)')
     +' FLKSAM-ENTRY: IT,ITZ, IP,IPZ, IJPROJ,IBPROJ', IT,ITZ,IP,IPZ,
     +IJPROJ,IBPROJ
C
      IXPSS=IXPS
      IXTSS=IXTS
      IXPVV=IXPV
      IXTVV=IXTV
      DO 10 JP=1,IXPVV
        IFR=IFROVP(JP)
        KPROJ=KKPROJ(IFR)
        CALL FLAHAD(KPROJ,IBPROJ,IPVQ(JP),IPPV1(JP),IPPV2(JP))
C
        IF (IPEV.GE.6) WRITE (6,1000)IPVQ(JP),IPPV1(JP),IPPV2(JP)
 1000 FORMAT (' FLKSAM: IPVQ,IPPV1,IPPV2 ',3I4)
C
        JHKK=JHKKPV(JP)
        JHKKQ=JHKK - 1
        IDHKK(JHKKQ)=IHKKQ(IPVQ(JP))
        IF(IBPROJ.EQ.0) THEN
          IDHKK(JHKK)=IHKKQ(IPPV1(JP))
        ELSE
          IDHKK(JHKK)=IHKKQQ(IPPV1(JP),IPPV2(JP))
        ENDIF
C
   10 CONTINUE
C
C*********************************************************************
C
C-------------------------------SAMPLING PROJECTILE SEA FLAVORS-------
C
C*********************************************************************
C
      DO 20 N=1,IXPSS
C
        JHKKAQ=JHKKPS(N)
        JHKKQ=JHKKAQ - 1
        IDHKK(JHKKQ)=IHKKQ(IPSQ(N))
        IDHKK(JHKKAQ)=IHKKQ(IPSAQ(N))
C
   20 CONTINUE
C--------------------------------------------------------------------
C
C   FLAVORS OF VALENCE QUARKS FROM TARGET HADRON / ALL NUCLEONS
C
C-----
C
      DO 30 JT=1,IXTVV
        IFR=IFROVT(JT)
        KTARG=KKTARG(IFR)
        IBTARG=IIBAR(KTARG)
        CALL FLAHAD(KTARG,IBTARG,ITVQ(JT),ITTV1(JT),ITTV2(JT))
C
        JHKK=JHKKTV(JT)
        JHKKQ=JHKK - 1
        IDHKK(JHKKQ)=IHKKQ(ITVQ(JT))
        IF(IBTARG.EQ.0) THEN
          IDHKK(JHKK)=IHKKQ(ITTV1(JT))
        ELSE
          IDHKK(JHKK)=IHKKQQ(ITTV1(JT),ITTV2(JT))
        ENDIF
        IF (IPEV.GE.8) WRITE (6,'(A,8I4)')
     +  ' FLKSAM: KTARG,ITVQ(JT),ITTV1(JT),ITTV2(JT)', KTARG,ITVQ(JT),
     +  ITTV1(JT),ITTV2(JT), IDHKK(JHKKQ),JHKKQ,IDHKK(JHKK),JHKK
 
C
C
   30 CONTINUE
C
C*********************************************************************
C
C-------------------------------SAMPLING TARGET SEA FLAVORS-------
C
C*********************************************************************
C
      DO 40 N=1,IXTSS
C
        JHKKAQ=JHKKTS(N)
        JHKKQ=JHKKAQ - 1
        IDHKK(JHKKQ)=IHKKQ(ITSQ(N))
        IDHKK(JHKKAQ)=IHKKQ(ITSAQ(N))
C
   40 CONTINUE
C
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE FLKSAA(NN,ECM)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C                              QUARK CONTENT
C                              OF PROJECTILE AND TARGET
C                              (HADRONS / ALL NUCLEONS)
C                              first run sea quark flavors
C---------------------------------------------------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /SEASU3/SEASQ 
C     COMMON /PCHARM/PCCCC
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C     DIMENSION IHKKQ(-6:6),IHKKQQ(-3:3,-3:3)
C     DATA IHKKQ/-6,-5,-4,-3,-1,-2,0,2,1,3,4,5,6/
C     DATA IHKKQQ/-3303,-3103,-3203,0,0,0,0, -3103,-1103,-2103,0,0,0,0,
C    +-3203,-2103,-2203,0,0,0,0, 0,0,0,0,0,0,0, 0,0,0,0,2203,2103,3203,
C    +0,0,0,0,2103,1103,3103, 0,0,0,0,3203,3103,3303/
C----------------------------------------------------------------------
C
C   FLAVORS OF VALENCE QUARKS FROM PROJECTILE HADRON/NUCLEONS
C
C-----
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH3.EQ.0)THEN
        RX=8.
        SEASQ=0.5D0
        X1=RX
        GM=2.140
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.
      X1=RX
      BETCHA=BETOO+1.3-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
C     PC=PC1/2.9
C                       changed j.r.14.12.94
C     PC=PC1/5.0
C     PC=PC1/10.0
      PCC1=PC1/7.0D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
        PU1=PU/(2*PU+PS+PC)
        PS1=PS/(2*PU+PS+PC)
      IF(INICH3.EQ.0)THEN
        INICH3=1
C       IPEV=1
        IF(IPEV.GE.1)WRITE(6,4567)PC,BETCHA,PU1,PS1
 4567   FORMAT(' Charm at chain ends FLKSAA: PC,BETCHA,PU,PS ',4F10.5)
      ENDIF
C----------------------------------------------------------------------
C
      IF(IPEV.GE.3) WRITE(6,'(A,6I4)')
     +' FLKSAA-ENTRY: IT,ITZ, IP,IPZ, IJPROJ,IBPROJ', IT,ITZ,IP,IPZ,
     +IJPROJ,IBPROJ
C
      IXPSS=NN
      IXTSS=NN
C
C*********************************************************************
C
C-------------------------------SAMPLING PROJECTILE SEA FLAVORS-------
C
C*********************************************************************
C
      DO 20 N=1,IXPSS
        IS=1
        RR=RNDM(V)
        IS=1.D0+RNDM(V1)*(2.D0+SEASQ)
	IF(RR.LT.PC)IS=4
        IPSQ(N)=IS
        IPSAQ(N)=-IS
        IF (IPEV.GE.8) WRITE (6,1010) N,IPSQ(N),IPSAQ(N)
 1010 FORMAT (' FLKSAA: N,IPSQ(N),IPSAQ(N) ',3I4)
C
   20 CONTINUE
C
C*********************************************************************
C
C-------------------------------SAMPLING TARGET SEA FLAVORS-------
C
C*********************************************************************
C
      DO 40 N=1,IXTSS
        IS=1
        RR=RNDM(V)
        IS=1.D0+RNDM(V1)*(2.D0+SEASQ) 
	IF(RR.LT.PC)IS=4
        ITSQ(N)=IS
        ITSAQ(N)=-IS
        IF (IPEV.GE.8) WRITE (6,1020) N,ITSQ(N),ITSAQ(N)
 1020 FORMAT (' FLKSAA: N,ITSQ(N),ITSAQ(N) ',3I4)
C
   40 CONTINUE
C
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE FLAHAD(ITYP,IBAR,IF1,IF2,IF3)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C                               QUARK FLAVOR COMPOSITION FOR HADRONS
C                               ITYP : NUMBERING AS FOR BAMJET ...
C                                      LE.30 !!!!!!!!!!
C
C----------------------------------------------------------------------
C
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      DIMENSION MQUARK(3,30)
      DATA MQUARK/ 2,1,1, -2,-1,-1, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0,
     +2,2,1, -2,-2,-1, 0,0,0, 0,0,0, 0,0,0, 1,-2,0, 2,-1,0, 1,-3,0, 3,
     +-1,0, 1,2,3, -1,-2,-3, 0,0,0, 2,2,3, 1,1,3, 1,2,3, 1,-1,0, 2,-3,0,
     +3,-2,0, 2,-2,0, 3,-3,0, 0,0,0, 0,0,0, 0,0,0/
C----------------------------------------------------------------------
      IF(IBAR.NE.0) THEN
        IPQ1 = MQUARK(1,ITYP)
        IPQ2 = MQUARK(2,ITYP)
        IPQ3 = MQUARK(3,ITYP)
C
        IF(IPEV.GE.3) PRINT 1000, ITYP,IBAR
 1000 FORMAT(' FLAHAD: ITYP,IBAR',2I5)
C
        ISAM5=1. + 6.*RNDM(V)
        GO TO (10,20,30,40,50,60),ISAM5
   10   CONTINUE
        IF1=IPQ1
        IF2=IPQ2
        IF3=IPQ3
                                                                GO TO 70
   20   CONTINUE
        IF1=IPQ2
        IF2=IPQ3
        IF3=IPQ1
                                                                GO TO 70
   30   CONTINUE
        IF1=IPQ3
        IF2=IPQ1
        IF3=IPQ2
                                                                GO TO 70
   40   CONTINUE
        IF1=IPQ1
        IF2=IPQ3
        IF3=IPQ2
                                                                GO TO 70
   50   CONTINUE
        IF1=IPQ2
        IF2=IPQ1
        IF3=IPQ3
                                                                GO TO 70
   60   CONTINUE
        IF1=IPQ3
        IF2=IPQ2
        IF3=IPQ1
   70   CONTINUE
        IF (IPEV.GE.3) WRITE (6,1010) IF1,IF2,IF3
 1010 FORMAT (' FLAHAD: IF1,IF2,IF3 ',3I4)
      ELSE
C                         VALENCE QUARK FLAVORS FOR MESONS
        IF1=MQUARK(1,ITYP)
        IF2=MQUARK(2,ITYP)
        IF3=0
        IF(IPEV.GE.3) THEN
          WRITE(6,'(A,6I4)') ' FLAHAD (MESON): IF1,IF2,IF3', IF1,IF2,IF3
 
 
        ENDIF
      ENDIF
C
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE XKSAMP(NN,ECM)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*-----------------------------------------------------------
* SAMPLING MOMENTUM FRACTIONS OF QUARKS AND DIQUARKS
*-----------------------------------------------------------
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
      PARAMETER (AMIS=0.8D0,AMAS=2.6D0,AMIU=0.5D0,AMAU=2.6D0)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEZ/NDZ,NZD
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,XSEADI.
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA, CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
*
*KEEP,ABRVV.
      COMMON /ABRVV/ AMCVV1(248),AMCVV2(248),GACVV1(248),GACVV2(248),
     +BGXVV1(248),BGYVV1(248),BGZVV1(248), BGXVV2(248),BGYVV2(248),
     +BGZVV2(248), NCHVV1(248),NCHVV2(248),IJCVV1(248),IJCVV2(248),
     +PQVVA1(248,4),PQVVA2(248,4), PQVVB1(248,4),PQVVB2(248,4)
*KEEP,ABRSS.
C     INCLUDE (ABRSS)
      COMMON /ABRSS/ AMCSS1(INTMX),AMCSS2(INTMX), GACSS1(INTMX),GACSS2
     +(INTMX), BGXSS1(INTMX),BGYSS1(INTMX),BGZSS1(INTMX), BGXSS2(INTMX),
     +BGYSS2(INTMX),BGZSS2(INTMX), NCHSS1(INTMX),NCHSS2(INTMX), IJCSS1
     +(INTMX),IJCSS2(INTMX), PQSSA1(INTMX,4),PQSSA2(INTMX,4), PQSSB1
     +(INTMX,4),PQSSB2(INTMX,4)
*KEEP,ABRVS.
      COMMON /ABRVS/ AMCVS1(248),AMCVS2(248),GACVS1(248),GACVS2(248),
     +BGXVS1(248),BGYVS1(248),BGZVS1(248), BGXVS2(248),BGYVS2(248),
     +BGZVS2(248), NCHVS1(248),NCHVS2(248),IJCVS1(248),IJCVS2(248),
     +PQVSA1(248,4),PQVSA2(248,4), PQVSB1(248,4),PQVSB2(248,4)
*KEEP,ABRSV.
      COMMON /ABRSV/ AMCSV1(248),AMCSV2(248),GACSV1(248),GACSV2(248),
     +BGXSV1(248),BGYSV1(248),BGZSV1(248), BGXSV2(248),BGYSV2(248),
     +BGZSV2(248), NCHSV1(248),NCHSV2(248),IJCSV1(248),IJCSV2(248),
     +PQSVA1(248,4),PQSVA2(248,4), PQSVB1(248,4),PQSVB2(248,4)
*KEND.
      LOGICAL LSEADI
      COMMON /SEADIQ/LSEADI
      COMMON/RECOM/IRECOM
      COMMON/DIQUAX/AMEDD,IDIQUA,IDIQUU
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /SEAQXX/ SEAQX,SEAQXN 
      DIMENSION ISXPVQ(248),ISXPVD(248),ISXTVQ(248),ISXTVD(248)
      PARAMETER (SQMA=0.7D0)
C*******************************************************************"
C***     ACTUAL STANDARD VALUES FROM BLOCK DATA:
C
C      CSEA=1.0,  CVQ=1.,  CDQ=2.
C      UNON=2.,   UNOM=1.5,  UNOSEA=2.0
C----------------------------------
      PARAMETER (NSEA=3,NVAL=10)
      DATA ICOUN /0/
      DATA JCOUN /0/
*  NSEA: maximum number of trials to generate x's for the required number
*        of sea quark pairs for a given hadron
*    changed from 10 to 3      22/04/92
C---------------------------------------------------------------------
      JCOUN=JCOUN+1
      DO 10 I=1,IP
        JSSHS(I)=0
   10 CONTINUE
      DO 20 I=1,IT
        JTSHS(I)=0
   20 CONTINUE
      DO 30 I=1,INTMX
        ZUOSP(I)=.FALSE.
        ZUOST(I)=.FALSE.
        IF (I.GT.248)                                           GO TO 30
        ZUOVP(I)=.FALSE.
        ZUOVT(I)=.FALSE.
   30 CONTINUE
      IF(ECM.LE.1.D-3)THEN
	IF(IPEV.GE.1) WRITE(6,*)' xksamp: ECM=0.D0 '
	ECM=ECM+1.D-3
      ENDIF
      XSTHR=CSEA/ECM
      IF(XSTHR.LE.1.D-12)THEN
	IF(IPEV.GE.1)WRITE(6,*)' xksamp 30 : XSTHR=0.D0 ',CSEA,ECM,XSTHR
	XSTHR=XSTHR+1.D-12
      ENDIF
C-----------------------------------------------------------------
C
C                                  J.R.21.2.94
C
C----------------------------------------------------------------
C                                      j.r.12.3.97
C                                      j.r.11.4.97 part restored
      IF(IP.EQ.1) XSTHR=4./ECM**2
C                               test 28.4.97
C     IF(IP.EQ.1) XSTHR=4./ECM**2
      IF(XSTHR.LE.1.D-12)THEN
	XSTHR=XSTHR+1.D-12
      ENDIF
C----------------------------------------------------------------
C-----------------------------------------------------------------
C
C                                  J.R.16.3.95
C
C----------------------------------------------------------------
C----------------------------------------------------------------
      IF(IP.GE.150.AND.IT.GE.150) XSTHR=2.5/(ECM*SQRT(ECM))
      BSQMA=SQMA/ECM
C                       before 28.8.97
C     IF (ECM.LT.10.D0) XSTHR=((12.-ECM)/5.+1.)*CSEA/ECM
C                       28.4.97 test
      IF (ECM.LT.10.D0.AND.IP.GT.1)XSTHR=((12.-ECM)/5.+1.)*CSEA/ECM
      XVTHR=CVQ/ECM
      XDTHR=CDQ/ECM
C      j.r.30.8.01
      IF(IBPROJ.EQ.0)THEN
        XVTHR=CVQ/ECM
        XDTHR=CVQ/ECM
      ENDIF

      IF (XVTHR+XDTHR.GT.0.90D0)THEN
	XVTHR=0.95-XDTHR
	IF(XVTHR.LE.0.05D0)THEN
          WRITE (6,1000)ECM
	ENDIF
      ENDIF
      IF(ECM.LE.1.D-3)THEN
	IF(IPEV.GE.1)WRITE(6,*)' xksamp: ECM=0.D0 '
	ECM=ECM+1.D-3
      ENDIF
      XSSTHR=SSMIMA/ECM
C-------------------------          20.12.91.j.r.
c     IF(JCOUN.EQ.1)WRITE(6,'(A,4E15.5)')
c    *' XKSAMP: XSTHR,XVTHR,XDTHR,XSSTHR ',
c    * XSTHR,XVTHR,XDTHR,XSSTHR 
      IF(IPEV.GE.1)WRITE(6,'(A,4E15.5)')
     *' XKSAMP: XSTHR,XVTHR,XDTHR,XSSTHR ',
     * XSTHR,XVTHR,XDTHR,XSSTHR 
C-------------------------
C                                   TEST KINEMATICAL LIMITS
      IF (XVTHR+XDTHR.GT.0.95D0)THEN
        WRITE (6,1000)ECM
 1000   FORMAT (' PROGRAMM STOPPED IN XSAMP1 ECM = ',F6.2,' TOO SMALL')
        STOP
      ENDIF
C                  MAXIMUM NUMBER OF SEA-PAIRS ALLOWED KINEMATICALLY
C     XXSEAM=1.0 - XVTHR*(1.D0+RNDM(V1)) - XDTHR*(1.D0+RNDM(V2))
C    *             -0.01*(1.D0+5.D0*RNDM(V3))
C                                      28.4.97 test
      XXSEAM=1.0 - XVTHR*(1.D0+0.3D0*RNDM(V1)) 
     *            - XDTHR*(1.D0+0.3D0*RNDM(V2))
     *             -0.01*(1.D0+1.5D0*RNDM(V3))
C..............................................................  
C                           1/x seaquarks
      IF(SEAQXN.GE.0.75D0)THEN
	XSTHR=8.*CSEA/ECM
C                             23.5.95
	XSTHR=4.*CSEA/ECM
	XXSEAM=1.D0-XVTHR-XDTHR
C                  MAXIMUM NUMBER OF SEA-PAIRS ALLOWED KINEMATICALLY
        XXSEAM=1.0 - XVTHR*(1.D0+RNDM(V1)) - XDTHR*(1.D0+RNDM(V2))
     *             -0.01*(1.D0+5.D0*RNDM(V3))
      ENDIF
C..............................................................      
      IF(XSTHR.LE.1.D-9)THEN
	ICOUN=ICOUN+1
	IF(ICOUN.LE.50)THEN
          IF(IPEV.GE.1)WRITE(6,*)' xksamp: XSTHR=0.D0 '
          IF(IPEV.GE.1)WRITE(6,'(A,2E20.5,I10)')
     *            ' XXSEAM,XSTHR,NSMAX',XXSEAM,XSTHR,NSMAX
	ENDIF
	XSTHR=XSTHR+1.D-9
      ENDIF
      NSMAX=0.50*XXSEAM / XSTHR
      IF(IPEV.GE.1)WRITE(6,'(A,E15.5,I10)')
     *            ' XXSEAM,NSMAX',XXSEAM,NSMAX
*--------------------------------------------------------------------
*-------------------------------------------------------------------
C                                    Change XVTHR and XDTHR at low energies
C                                    TEST j.r. 9.2.95
      IF (XDTHR.GT.0.14D0)XDTHR=0.14D0
      IF (XVTHR.GT.0.14D0)XVTHR=0.14D0
*--------------------------------------------------------------------
C                                 PARTON X-VALUES OF INTERACTING
C                                         PROJECTILE HADRON / NUCLEONS
      IXPV=0
      IXPS=0
      UNOPRV=UNON
      IF(IJPROJ.NE.0.AND.IBPROJ.EQ.0) UNOPRV=UNOM
c     IF(JCOUN.EQ.1)WRITE(6,'(A,4E15.5)')
      IF(IPEV.GE.1)WRITE(6,'(A,4E15.5)')
     *' XKSAMP: XSTHR,XVTHR,XDTHR,XSSTHR ',
     * XSTHR,XVTHR,XDTHR,XSSTHR 
*  loop over projectile nucleons
      DO 100 IPP=1,IP
        IF (JSSH(IPP).NE.0) THEN
C--------------------------------------------------------------
C                          prepare diquark rejection
C--------------------------------------------------------------
          IIXPSS=IXPS
	  IIXPVV=IXPV
   99     CONTINUE
	  IXPS=IIXPSS
	  IXPV=IIXPVV
C--------------------------------------------------------------
          JIPP=JSSH(IPP)-1
          JIPP=MIN(JIPP,NSMAX)
 41       CONTINUE
          XXSEA=0.0
          IF(JIPP.GT.0) THEN
C                         j.r.11.12.97
	    XSMAX=XXSEAM - 1.5*JIPP*XSTHR
C           XSMAX=XXSEAM - 2.*JIPP*XSTHR
            IF(XSTHR.GE.XSMAX) THEN
              JIPP=JIPP-1
              GOTO 41
            ENDIF
*  x-values of sea-quark pairs
            NSCOUN=0
   40       CONTINUE
            IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-40'
            XXSEA=0.0
            NSCOUN=NSCOUN+1
            IF (NSCOUN.GT.NSEA) THEN
              JIPP=JIPP-1
              NSCOUN=0
            ENDIF
            DO 70 ISQ=1,JIPP
C                                             j.r.29.4.93---
              IF(IPSQ(IXPS+1).LE.2)THEN
C..............................................................  
C                           1/sqrt(x) seaquarks
                IF(SEAQXN.LE.0.75D0)THEN
                  XPSQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
                ELSEIF(SEAQXN.GT.0.75D0)THEN
                  XPSQI=SAMPEY(XSTHR,XSMAX)
                ENDIF
C..............................................................      
		IF(IPEV.GE.1)WRITE(6,'(A,3E15.5)')
     *          'XPSQI 1:XPSQI,XSTHR,XSMAX',
     *          XPSQI,XSTHR,XSMAX
              ELSE
                IF(XSMAX.GT.XSTHR+BSQMA)THEN
                  XPSQI=SAMPXB(XSTHR+BSQMA,XSMAX,BSQMA)
	       	  IF(IPEV.GE.1)WRITE(6,'(A,4E15.5)')
     *            'XPSQI 2:XPSQI,XSTHR,XSMAX,BSQMA',
     *            XPSQI,XSTHR,XSMAX,BSQMA
                ELSE
C..............................................................  
C                           1/sqrt(x) seaquarks
                  IF(SEAQXN.LE.0.75D0)THEN
                    XPSQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
                  ELSEIF(SEAQXN.GT.0.75D0)THEN
                    XPSQI=SAMPEY(XSTHR,XSMAX)
                  ENDIF
C..............................................................      
	          IF(IPEV.GE.1)WRITE(6,'(A,3E15.5)')
     *            'XPSQI 3:XPSQI,XSTHR,XSMAX',
     *             XPSQI,XSTHR,XSMAX
                ENDIF
              ENDIF
C
              IF(IPSAQ(IXPS+1).GE.-2)THEN
C..............................................................  
C                           1/sqrt(x) seaquarks
                IF(SEAQXN.LE.0.75D0)THEN
                  XPSAQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
                ELSEIF(SEAQXN.GT.0.75D0)THEN
                  XPSAQI=SAMPEY(XSTHR,XSMAX)
                ENDIF
C..............................................................      
		IF(IPEV.GE.1)WRITE(6,'(A,3E15.5)')
     *          'XPSAQI 1:XPSAQI,XSTHR,XSMAX',
     *          XPSAQI,XSTHR,XSMAX
              ELSE
                IF(XSMAX.GT.XSTHR+BSQMA)THEN
                  XPSAQI=SAMPXB(XSTHR+BSQMA,XSMAX,BSQMA)
		  IF(IPEV.GE.1)WRITE(6,'(A,4E15.5)')
     *            'XPSAQI 2:XPSAQI,XSTHR,XSMAX,BSQMA',
     *            XPSAQI,XSTHR,XSMAX,BSQMA
                ELSE
C..............................................................  
C                           1/sqrt(x) seaquarks
                  IF(SEAQXN.LE.0.75D0)THEN
                    XPSAQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
                  ELSEIF(SEAQXN.GT.0.75D0)THEN
                    XPSAQI=SAMPEY(XSTHR,XSMAX)
                  ENDIF
C..............................................................      
		  IF(IPEV.GE.1)WRITE(6,'(A,3E15.5)')
     *            'XPSAQI 3:XPSAQI,XSTHR,XSMAX',
     *            XPSAQI,XSTHR,XSMAX
                ENDIF
              ENDIF
C                                                      ---
   50         CONTINUE
	      IF(IPEV.GE.1)
     *        WRITE(6,'(A,3E15.4)') ' XKSAMP-50: XPSQI,XSTHR,XSMAX',
     &        XPSQI,XSTHR,XSMAX
   60         CONTINUE
              IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-60'
              IF(IPEV.GE.1)
     *        WRITE(6,'(A,3E15.4)') ' XKSAMP-60: XPSAQI,XSTHR,XSMAX',
     &        XPSAQI,XSTHR,XSMAX
              XXSEA=XXSEA + XPSQI + XPSAQI
              IF(XXSEA.GE.XXSEAM) THEN
                IXPS=IXPS - ISQ + 1
                GOTO 40
              ENDIF
              IXPS=IXPS+1
              IF(IPEV.GE.1)WRITE(6,'(A,I10)') ' XKSAMP-60: IXPS',IXPS
              XPSQ(IXPS)=XPSQI
              XPSAQ(IXPS)=XPSAQI
C                  Test 14.4.99	      
              XPSQ(IXPS)=XPSAQI
              XPSAQ(IXPS)=XPSQI
              IFROSP(IXPS)=IPP
              ZUOSP(IXPS)=.TRUE.
   70       CONTINUE
          ENDIF
          JSSHS(IPP)=JIPP
*  projectile valence quarks
   80     CONTINUE
          IF(XVTHR.GT.0.05D0)THEN
            IF(XVTHR.GT.1.D0-XXSEA-XDTHR)THEN
              IF(IPEV.GE.1)
     *        WRITE(6,*)' xvthr,xxsea,xdthr ', XVTHR,XXSEA,XDTHR
            ENDIF
C                  TEST 15.4.99	    
C           XPVQI=BETREJ(0.5D0,UNOPRV,XVTHR,1.D0-XXSEA-XDTHR)
C           XPVQI=BETREJ(0.1D0,UNOPRV,XVTHR,1.D0-XXSEA-XDTHR)
            IF(IBPROJ.EQ.0)THEN
              XPVQI=BETREJ(0.5D0,UNOPRV,XVTHR,1.D0-XXSEA-XDTHR)
            ELSE
              XPVQI=BETREJ(0.1D0,UNOPRV,XVTHR,1.D0-XXSEA-XDTHR)
            ENDIF

   81       CONTINUE
          ELSE
   90       CONTINUE
            IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-90'
C                  TEST 15.4.99	    
C           XPVQI=DBETAR(0.5D0,UNOPRV)
C           XPVQI=DBETAR(0.1D0,UNOPRV)
            IF(IBPROJ.EQ.0)THEN
              XPVQI=DBETAR(0.5D0,UNOPRV)
            ELSE
              XPVQI=DBETAR(0.1D0,UNOPRV)
            ENDIF

            IF ((XPVQI.LT.XVTHR).OR.(1.D0-XPVQI-XXSEA.LT.XDTHR))
     *      GOTO 90
          ENDIF
          XPVDI=1. - XPVQI - XXSEA
C               J.R.30.8.01
          IF(IBPROJ.EQ.0)THEN
            IF(XPVQI.LE.XPVDI-XDTHR)THEN
C        WRITE(6,*)'x..',XPVQI,XPVDI,IXPS,(XPSQ(II),XPSAQ(II),II=1,IXPS)
              DUX=RNDM(V)*(XPVDI-XDTHR-XPVQI)
              XPVQI=XPVQI+DUX
              XPVDI=XPVDI-DUX
            ENDIF
            IF(XPVDI.LE.XPVQI-XDTHR)THEN
C        WRITE(6,*)'x..',XPVQI,XPVDI,IXPS,(XPSQ(II),XPSAQ(II),II=1,IXPS)
              DUX=RNDM(V)*(XPVQI-XDTHR-XPVDI)
              XPVDI=XPVDI+DUX
              XPVQI=XPVQI-DUX
            ENDIF
          ENDIF
C        WRITE(6,*)'x.2',XPVQI,XPVDI,IXPS,(XPSQ(II),XPSAQ(II),II=1,IXPS)

C                                    CONSISTENCY TEST
C                                    TO BE FULFILLED AUTOMATICALLY
          IF(XPVDI.LT.XDTHR) THEN
           WRITE(6,'(A/A/E12.3,4I4,3E11.3)')
     +      ' INCONSISTENT X-SAMPLING / XKSAMP / PROJECTILE',
     +      ' ECM, IP, IPP, JSSH(IPP), JIPP, XPVQI, XPVDI, XXSEA', ECM,
     +      IP, IPP, JSSH(IPP), JIPP, XPVQI, XPVDI, XXSEA
            STOP
          ENDIF
C
C--------------------------------------------------------------
C                                   diquark rejection
C                      Here we have a projectile diquark
C                      Reject it according to xd**1.5 rule
C--------------------------------------------------------------
          XTEST=XPVDI**1.5
          VV=IPP
C--------------------------------------------------------------
          IXPV=IXPV+1
          XPVQ(IXPV)=XPVQI
          XPVD(IXPV)=XPVDI
          ISXPVQ(IXPV)=0
          ISXPVD(IXPV)=0
          IFROVP(IXPV)=IPP
          ITOVP(IPP)=IXPV
          ZUOVP(IXPV)=.TRUE.
        ENDIF
  100 CONTINUE
C******************************
C                        PARTON X-VALUES OF INTERACTING TARGET NUCLEONS
       IXTV=0
       IXTS=0
       DO 170 ITT=1,IT
         IF (JTSH(ITT).NE.0) THEN
C--------------------------------------------------------------
C                          prepare diquark rejection
C--------------------------------------------------------------
           IIXTSS=IXTS
	   IIXTVV=IXTV
  169      CONTINUE
	   IXTS=IIXTSS
	   IXTV=IIXTVV
C--------------------------------------------------------------
           JITT=JTSH(ITT)-1
           JITT=MIN(JITT,NSMAX)
 111       CONTINUE
           XXSEA=0.0
           IF(JITT.GT.0) THEN
C                     j.r.11.12.97
	     XSMAX=XXSEAM -1.5*JITT*XSTHR
C            XSMAX=XXSEAM - 2.*JITT*XSTHR
             IF(XSTHR.GE.XSMAX) THEN
               JITT=JITT-1
               GOTO 111
             ENDIF
             NSCOUN=0
  110        CONTINUE
             IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-110'
             XXSEA=0.0
             NSCOUN=NSCOUN+1
             IF (NSCOUN.GT.NSEA)THEN
               JITT=JITT-1
               NSCOUN=0
             ENDIF
             DO 140 ISQ=1,JITT
C                               CHANGE 23.5.90 / 13.9.90
C              IF(XSTHR.GT.0.05D0)THEN
C                                         J.R.29.4.93---
               IF(ITSQ(IXTS+1).LE.2)THEN
C..............................................................  
C                           1/sqrt(x) seaquarks
                 IF(SEAQXN.LE.0.75D0)THEN
                   XTSQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
                 ELSEIF(SEAQXN.GT.0.75D0)THEN
                   XTSQI=SAMPEY(XSTHR,XSMAX)
                 ENDIF
C..............................................................      
               ELSE
               IF(XSMAX.GT.XSTHR+BSQMA)THEN
                  XTSQI=SAMPXB(XSTHR+BSQMA,XSMAX,BSQMA)
                ELSE
C..............................................................  
C                           1/sqrt(x) seaquarks
      IF(SEAQXN.LE.0.75D0)THEN
                XTSQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
      ELSEIF(SEAQXN.GT.0.75D0)THEN
                XTSQI=SAMPEY(XSTHR,XSMAX)
      ENDIF
C..............................................................      
                ENDIF
              ENDIF
C
              IF(ITSAQ(IXTS+1).GE.-2)THEN
C..............................................................  
C                           1/sqrt(x) seaquarks
      IF(SEAQXN.LE.0.75D0)THEN
                XTSAQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
      ELSEIF(SEAQXN.GT.0.75D0)THEN
                XTSAQI=SAMPEY(XSTHR,XSMAX)
      ENDIF
C..............................................................      
              ELSE
                IF(XSMAX.GT.XSTHR+BSQMA)THEN
                  XTSAQI=SAMPXB(XSTHR+BSQMA,XSMAX,BSQMA)
                ELSE
C..............................................................  
C                           1/sqrt(x) seaquarks
      IF(SEAQXN.LE.0.75D0)THEN
                XTSAQI=SAMPEX(XSTHR,XSMAX)
C                           1/x seaquarks
      ELSEIF(SEAQXN.GT.0.75D0)THEN
                XTSAQI=SAMPEY(XSTHR,XSMAX)
      ENDIF
C..............................................................      
                ENDIF
              ENDIF
C                                                  ---
C               XTSQI=SAMPEX(XSTHR,XSMAX)
C
C               XTSAQI=SAMPEX(XSTHR,XSMAX)
C              ELSE
  120           CONTINUE
         IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-120'
C               XTSQI=SAMPEX(XSTHR,XSMAX)
C               IF (XTSQI.LT.XSTHR.OR.XTSQI.GE.XSMAX)           GOTO 120
  130           CONTINUE
         IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-130'
C               XTSAQI=SAMPEX(XSTHR,XSMAX)
C               IF (XTSAQI.LT.XSTHR.OR.XTSAQI.GE.XSMAX)         GOTO 130
C             ENDIF
              XXSEA=XXSEA + XTSQI + XTSAQI
              IF(XXSEA.GE.XXSEAM) THEN
                IXTS=IXTS - ISQ + 1
                                                                GOTO 110
              ENDIF
              IXTS=IXTS+1
         IF(IPEV.GE.1)WRITE(6,'(A,I10)')' XKSAMP-130: IXTS',IXTS
              XTSQ(IXTS)=XTSQI
              XTSAQ(IXTS)=XTSAQI
              IFROST(IXTS)=ITT
              ZUOST(IXTS)=.TRUE.
  140       CONTINUE
          ENDIF
          JTSHS(ITT)=JITT
C
C***                             TARGET VALENCE QUARKS
  150     CONTINUE
          IF(XVTHR.GT.0.05D0)THEN
            IF(XVTHR.GT.1.D0-XXSEA-XDTHR)THEN
              WRITE(6,*)' xvthr,xxsea,xdthr ', XVTHR,XXSEA,XDTHR
            ENDIF
C                  TEST 15.4.99	    
C           XTVQI=BETREJ(0.5D0,UNON,XVTHR,1.-XXSEA-XDTHR)
            XTVQI=BETREJ(0.1D0,UNON,XVTHR,1.-XXSEA-XDTHR)
  151     CONTINUE
          ELSE
  160       CONTINUE
         IF(IPEV.GE.1)WRITE(6,'(A)') ' XKSAMP-160'
C                  TEST 15.4.99	    
C           XTVQI=DBETAR(0.5D0,UNON)
            XTVQI=DBETAR(0.1D0,UNON)
	    XMIST=1.-XTVQI-XXSEA
	    IF(IPEV.GE.1)WRITE(6,'(A,5E15.5)')
     *      ' XTVQI,XVTHR,XXSEA,XMIST,XDTHR',
     *        XTVQI,XVTHR,XXSEA,XMIST,XDTHR
          IF((XTVQI.LT.XVTHR).OR.(1.D0-XTVQI-XXSEA.LT.XDTHR+0.0001D0))
     *                                                        GOTO 160
          ENDIF
          XTVDI=1. - XTVQI - XXSEA
C                                    CONSISTENCY TEST
C                                    TO BE FULFILLED AUTOMATICALLY
          IF(XTVDI.LT.XDTHR) THEN
            WRITE(6,'(A/A/E12.3,4I4,3E11.3)')
     +      ' INCONSISTENT X-SAMPLING / XKSAMP / TARGET',
     +      ' ECM, IT, ITT, JTSH(ITT), JITT, XTVQI, XTVDI, XXSEA', ECM,
     +      IT, ITT, JTSH(ITT), JITT, XTVQI, XTVDI, XXSEA
            STOP
          ENDIF
C
C--------------------------------------------------------------
C                                   diquark rejection
C                      Here we have a target diquark
C                      Reject it according to xd**1.5 rule
C--------------------------------------------------------------
          XTEST=XTVDI**1.5
	  VV=ITT
C	  IF(RNDM(VV).GT.XTEST)GO TO 169
C--------------------------------------------------------------
          IXTV=IXTV+1
          XTVQ(IXTV)=XTVQI
          XTVD(IXTV)=XTVDI
          ISXTVQ(IXTV)=0
          ISXTVD(IXTV)=0
          IFROVT(IXTV)=ITT
          ITOVT(ITT)=IXTV
          ZUOVT(IXTV)=.TRUE.
        ENDIF
  170 CONTINUE
C
      IF (IPEV.GE.6) THEN
        WRITE(6,1010)
 1010 FORMAT(' XKSAMP:',
     +' I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I),KKPROJ(I)')
        DO 180 I=1,IXPV
          WRITE(6,1020) I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I),
     +    KKPROJ(I)
 1020 FORMAT(I5,2E15.5,2I5,L5,I5)
  180   CONTINUE
        WRITE(6,1030)
 1030 FORMAT(' XKSAMP :  I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)')
        DO 190 I=1,IXPS
          WRITE(6,1040) I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)
 1040 FORMAT(I5,2E15.5,I5,L5)
  190   CONTINUE
C
        WRITE(6,1050)
 1050 FORMAT(' XKSAMP:',
     +' I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I),KKTARG(I)')
        DO 200 I=1,IXTV
          WRITE(6,1020) I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I),
     +    KKTARG(I)
  200   CONTINUE
        WRITE(6,1060)
 1060 FORMAT(' XKSAMP :  I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)')
        DO 210 I=1,IXTS
          WRITE(6,1040) I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)
  210   CONTINUE
      ENDIF
      IF(IPEV.GE.6) THEN
        WRITE(6,'(A)')
     +  ' XKSAMP :  I,ITOVP(I),ITOVT(I),JSSHS(I),JTSHS(I)'
        IMA=MAX(IP,IT)
        DO 220 I=1,IMA
          WRITE(6,1070) I,ITOVP(I),ITOVT(I),JSSHS(I),JTSHS(I)
 1070 FORMAT(5I5)
  220   CONTINUE
        DO 181 I=1,IXPV
	  WRITE(6,*)' I,IPVQ(I),IPPV1(I),IPPV2(I) ',
     *	  I,IPVQ(I),IPPV1(I),IPPV2(I)
  181   CONTINUE
        DO 182 I=1,IXTV
	  WRITE(6,*)' I,ITVQ(I),ITTV1(I),ITTV2(I) ',
     *	  I,ITVQ(I),ITTV1(I),ITTV2(I)
  182   CONTINUE
        DO 183 I=1,IXPS
	  WRITE(6,*)' I,IPSQ(I),IPSAQ(I) ',
     *	  I,IPSQ(I),IPSAQ(I)
  183   CONTINUE
        DO 184 I=1,IXTS
	  WRITE(6,*)' I,ITSQ(I),ITSAQ(I) ',
     *	  I,ITSQ(I),ITSAQ(I)
  184   CONTINUE
      ENDIF
C
C----------------------------------------------------------------------
C               COLLECTION OF VALENCE-VALENCE PAIRS
      NVV=0
      IF(IPEV.GE.4)WRITE(6,*)' collect v-v pairs NVV',NVV
      DO 230 I=1,NN
        INTLO(I)=.TRUE.
  230 CONTINUE
      DO 240 I=1,NN
        IIPP=INTER1(I)
        IITT=INTER2(I)
        IIPPV=ITOVP(IIPP)
        IITTV=ITOVT(IITT)
        IF(ZUOVP(IIPPV).AND.ZUOVT(IITTV)) THEN
          INTLO(I)=.FALSE.
      IF(IPEV.GE.6)WRITE(6,'(A,5I5)')
     * ' XKSAMP v-v loop IIPP,IITT,IIPPV,IITTV,NVV',IIPP,IITT,IIPPV,IITTV,NVV
          ZUOVP(IIPPV)=.FALSE.
          ZUOVT(IITTV)=.FALSE.
          NVV=NVV + 1
      IF(IPEV.GE.4)WRITE(6,*)' collect v-v pairs NVV',NVV
          NCHVV1(NVV)=0
          NCHVV2(NVV)=0
          INTVV1(NVV)=IIPPV
          INTVV2(NVV)=IITTV
C -----------------------------------------------------J.R. 6.1.92
C       AMVVP2=XTVQ(IITTV)*XPVD(IIPPV)*ECM*ECM
C       IF(AMVVP2.GT.6.D0)THEN
C                                     RESAMPLE XTVQ
C         XTVQTH=6./(XPVD(IIPPV)*ECM*ECM)
C         XTVQXX=BETREJ(0.5D0,UNOPRV,XTVQTH,XTVQ(IITTV))
C         DXTVQ=XTVQ(IITTV)-XTVQXX
C         XTVQ(IITTV)=XTVQ(IITTV)-DXTVQ
C         XTVD(IITTV)=XTVD(IITTV)+DXTVQ
C       ENDIF
C       AMVVT2=XTVD(IITTV)*XPVQ(IIPPV)*ECM*ECM
C       IF(AMVVT2.GT.6.D0)THEN
C                                     RESAMPLE XPVQ
C         XPVQTH=6./(XTVD(IITTV)*ECM*ECM)
C         XPVQXX=BETREJ(0.5D0,UNOPRV,XPVQTH,XPVQ(IIPPV))
C         DXPVQ=XPVQ(IIPPV)-XPVQXX
C         XPVQ(IIPPV)=XPVQ(IIPPV)-DXPVQ
C         XPVD(IIPPV)=XPVD(IIPPV)+DXPVQ
C       ENDIF
C--------------------------------------------------------------
        ENDIF
  240 CONTINUE
C
C                        COLLECTION OF THE SEA-VALENCE PAIRS
      NDV=0
      NSV=0
      DO 270 I=1,NN
        IF(INTLO(I)) THEN
          IIPP=INTER1(I)
          IITT=INTER2(I)
          IITTV=ITOVT(IITT)
          DO 250 J=1,IXPS
            IF(ZUOSP(J).AND.(IFROSP(J).EQ.IIPP).AND.ZUOVT(IITTV)) THEN
              ZUOSP(J)=.FALSE.
      IF(IPEV.GE.6)WRITE(6,'(A,6I5)')
     *' XKSAMP s-v loop I(NN),J(IXPS),iitt,iittv,NSV,NDV',
     +    I,J, IITT,IITTV,NSV,NDV
              ZUOVT(IITTV)=.FALSE.
              INTLO(I)=.FALSE.
C             IF(LSEADI.AND.RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
              IF(RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
C                               DEFINE D-V CHAINS (SEA-DIQUARK-VALENCE)
                CALL DIQSV(ECM,IITTV,J,IREJ)
                IF(IREJ.EQ.0)GO TO 260
              ENDIF
              NSV=NSV + 1
              NCHSV1(NSV)=0
              NCHSV2(NSV)=0
              INTSV1(NSV)=J
              INTSV2(NSV)=IITTV
C----------------correct sv chains to get minimum mass ------
C     IF(IP.GE.2)GO TO 5270
              AMSVQ1=XPSQ(J)*XTVD(IITTV)*ECM**2
              AMSVQ2=XPSAQ(J)*XTVQ(IITTV)*ECM**2
              JXPV=ITOVP(IIPP)
              IF(IPSQ(J).EQ.3)THEN
                IF(AMSVQ1.GT.AMAS)THEN
                  XPSQXX=(XTVD(IITTV)*ECM**2)
		  IF(XPSQXX.LE.1.D-1)XPSQXX=1.D-1
                  XPSQTH=AMAS/XPSQXX
                  XPSQXX=SAMPEX(XPSQTH,XPSQ(J))
                  DXPSQ=XPSQ(J)-XPSQXX
                  XPSQ(J)=XPSQ(J)-DXPSQ
                  XPVD(JXPV)=XPVD(JXPV)+DXPSQ
                ELSEIF(AMSVQ1.LT.AMAS)THEN
		  IF(XTVD(IITTV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XTVD(IITTV)=0 ',IITTV
		    XTVD(IITTV)=0.1D0
		  ENDIF
                  XPSQW=AMAS/(XTVD(IITTV)*ECM**2)
                  DXPSQ=XPSQW-XPSQ(J)
                  ISXTVD(IITTV)=1
                  IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                    XPVD(JXPV)=XPVD(JXPV)-DXPSQ
                    XPSQ(J)=XPSQW
                  ENDIF
                ENDIF
                IF(AMSVQ2.GT.AMIS)THEN
                ELSEIF(AMSVQ2.LT.AMIS)THEN
		  IF(XTVQ(IITTV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XTVQ(IITTV)=0 ',IITTV
		    XTVQ(IITTV)=0.1D0
		  ENDIF
                  XPSQW=AMIS/(XTVQ(IITTV)*ECM**2)
                  DXPSQ=XPSQW-XPSAQ(J)
                  ISXTVQ(IITTV)=1
                  IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                    XPVD(JXPV)=XPVD(JXPV)-DXPSQ
                    XPSAQ(J)=XPSQW
                  ENDIF
                ENDIF
              ELSE
                IF(AMSVQ1.GT.AMAU)THEN
		  IF(XTVD(IITTV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XTVD(IITTV)=0 ',IITTV
		    XTVD(IITTV)=0.1D0
		  ENDIF
                  XPSQTH=AMAU/(XTVD(IITTV)*ECM**2)
                  XPSQXX=SAMPEX(XPSQTH,XPSQ(J))
                  DXPSQ=XPSQ(J)-XPSQXX
                  XPSQ(J)=XPSQ(J)-DXPSQ
                  XPVD(JXPV)=XPVD(JXPV)+DXPSQ
                ELSEIF(AMSVQ1.LT.AMAU)THEN
		  IF(XTVD(IITTV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XTVD(IITTV)=0 ',IITTV
		    XTVD(IITTV)=0.1D0
		  ENDIF
                  XPSQW=AMAU/(XTVD(IITTV)*ECM**2)
                  DXPSQ=XPSQW-XPSQ(J)
                  ISXTVD(IITTV)=1
                  IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                    XPVD(JXPV)=XPVD(JXPV)-DXPSQ
                    XPSQ(J)=XPSQW
                  ENDIF
                ENDIF
                IF(AMSVQ2.GT.AMIU)THEN
                ELSEIF(AMSVQ2.LT.AMIU)THEN
		  IF(XTVQ(IITTV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XTVQ(IITTV)=0 ',IITTV
		    XTVQ(IITTV)=0.1D0
		  ENDIF
                  XPSQW=AMIU/(XTVQ(IITTV)*ECM**2)
                  DXPSQ=XPSQW-XPSAQ(J)
                  ISXTVQ(IITTV)=1
                  IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                    XPVD(JXPV)=XPVD(JXPV)-DXPSQ
                    XPSAQ(J)=XPSQW
                  ENDIF
                ENDIF
              ENDIF
C5270 CONTINUE
C-----------------------------------------------------------------
                                                                GOTO 260
            ENDIF
      IF(IPEV.GE.6)WRITE(6,'(A,6I5)')
     *' XKSAMP s-v loop I(NN),J(IXPS),iitt,iittv,NSV,NDV',
     +    I,J, IITT,IITTV,NSV,NDV
  250     CONTINUE
        ENDIF
  260   CONTINUE
  270 CONTINUE
C
C                        COLLECTION OF THE VALENCE-SEA PAIRS
      NVS=0
      NVD=0
      DO 300 I=1,NN
        IF(INTLO(I)) THEN
          IIPP=INTER1(I)
          IITT=INTER2(I)
          IIPPV=ITOVP(IIPP)
          DO 280 J=1,IXTS
            IF(ZUOVP(IIPPV).AND.ZUOST(J).AND.(IFROST(J).EQ.IITT)) THEN
              ZUOST(J)=.FALSE.
              IF(IPEV.GE.6)WRITE(6,*)
     *        ' XKSAMP v-s loop IIPP,IITT,IIPPV,NVS,NVD,I,J,IXTS',
     *        IIPP,IITT,IIPPV,NVS,NVD,I,J,IXTS
              ZUOVP(IIPPV)=.FALSE.
              INTLO(I)=.FALSE.
C             IF(LSEADI.AND.RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
              IF(RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
C                               DEFINE V-D CHAINS (valence - sea diquark)
                CALL DIQVS(ECM,IIPPV,J,IREJ)
                IF(IPEV.GE.6)WRITE(6,*)
     *          ' XKSAMP v-s loop IIPP,IITT,IIPPV,NVS,NVD,I,J,IXTS,JXTV'
     *          ,IIPP,IITT,IIPPV,NVS,NVD,I,J,IXTS,JXTV
                IF(IREJ.EQ.0)GO TO 290
              ENDIF
              NVS=NVS + 1
              NCHVS1(NVS)=0
              NCHVS2(NVS)=0
              INTVS1(NVS)=IIPPV
              INTVS2(NVS)=J
C----------------correct vs chains to get minimum mass ------
              AMVSQ1=XPVQ(IIPPV)*XTSAQ(J)*ECM**2
              AMVSQ2=XPVD(IIPPV)*XTSQ(J)*ECM**2
              JXTV=ITOVT(IITT)
              IF(ITSQ(J).EQ.3)THEN
C               IF(AMVSQ1.GT.AMIS)THEN
                IF(AMVSQ1.LT.AMIS)THEN
		  IF(XPVQ(IIPPV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XPVQ(IIPPV)=0 ',IIPPV
		    XPVQ(IIPPV)=0.1D0
		  ENDIF
                  XTSQW=AMIS/(XPVQ(IIPPV)*ECM**2)
                  DXTSQ=XTSQW-XTSAQ(J)
                  ISXPVQ(IIPPV)=1
                  IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                    XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                    XTSAQ(J)=XTSQW
                  ENDIF
                ENDIF
                IF(AMVSQ2.GT.AMAS)THEN
		  IF(XPVD(IIPPV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XPVD(IIPPV)=0 ',IIPPV
		    XPVD(IIPPV)=0.1D0
		  ENDIF
                  XTSQTH=AMAS/(XPVD(IIPPV)*ECM**2)
                  XTSQXX=SAMPEX(XTSQTH,XTSQ(J))
                  DXTSQ=XTSQ(J)-XTSQXX
                  XTSQ(J)=XTSQ(J)-DXTSQ
                  XTVD(JXTV)=XTVD(JXTV)+DXTSQ
                ELSEIF(AMVSQ2.LT.AMAS)THEN
		  IF(XPVD(IIPPV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XPVD(IIPPV)=0 ',IIPPV
		    XPVD(IIPPV)=0.1D0
		  ENDIF
                  XTSQW=AMAS/(XPVD(IIPPV)*ECM**2)
                  DXTSQ=XTSQW-XTSQ(J)
                  ISXPVD(IIPPV)=1
                  IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                    XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                    XTSQ(J)=XTSQW
                  ENDIF
                ENDIF
              ELSE
C               IF(AMVSQ1.GT.AMIU)THEN
                IF(AMVSQ1.LT.AMIU)THEN
		  IF(XPVQ(IIPPV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XPVQ(IIPPV)=0 ',IIPPV
		    XPVQ(IIPPV)=0.1D0
		  ENDIF
                  XTSQW=AMIU/(XPVQ(IIPPV)*ECM**2)
                  DXTSQ=XTSQW-XTSAQ(J)
                  ISXPVQ(IIPPV)=1
                  IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                    XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                    XTSAQ(J)=XTSQW
                  ENDIF
                ENDIF
                IF(AMVSQ2.GT.AMAU)THEN
		  IF(XPVD(IIPPV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XPVD(IIPPV)=0 ',IIPPV
		    XPVD(IIPPV)=0.1D0
		  ENDIF
                  XTSQTH=AMAU/(XPVD(IIPPV)*ECM**2)
                  XTSQXX=SAMPEX(XTSQTH,XTSQ(J))
                  DXTSQ=XTSQ(J)-XTSQXX
                  XTSQ(J)=XTSQ(J)-DXTSQ
                  XTVD(JXTV)=XTVD(JXTV)+DXTSQ
                ELSEIF(AMVSQ2.LT.AMAU)THEN
		  IF(XPVD(IIPPV)*ECM**2.LE.1.D-12)THEN
		    WRITE(6,*)' xksamp: XPVD(IIPPV)=0 ',IIPPV
		    XPVD(IIPPV)=0.1D0
		  ENDIF
                  XTSQW=AMAU/(XPVD(IIPPV)*ECM**2)
                  DXTSQ=XTSQW-XTSQ(J)
                  ISXPVD(IIPPV)=1
                  IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                    XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                    XTSQ(J)=XTSQW
                  ENDIF
                ENDIF
              ENDIF
C-----------------------------------------------------------------
                                                                GOTO 290
            ENDIF
  280     CONTINUE
        ENDIF
  290   CONTINUE
  300 CONTINUE
C   End loop:         COLLECTION OF THE VALENCE-SEA PAIRS
C
C                        COLLECTION OF THE SEA-SEA PAIRS
*---------------------   new version 8/03/1991  hjm
      NSS=0
      NDS=0
      NSD=0
      NDZ=0
      NZD=0
      DO 420 I=1,NN
        IF(INTLO(I)) THEN
          IIPP=INTER1(I)
          IITT=INTER2(I)
          DO 400 J=1,IXTS
            IF(ZUOST(J).AND.(IFROST(J).EQ.IITT)) THEN
              DO 390 JJ=1,IXPS
                IF(ZUOSP(JJ).AND.(IFROSP(JJ).EQ.IIPP)) THEN
                  NSS=NSS+1
                  IF(IPEV.GE.6)WRITE(6,'(A,5I5)')
     *            ' XKSAMP s-s loop IIPP,IITT,NSS',IIPP,IITT,NSS
                  NCHSS1(NSS)=0
                  NCHSS2(NSS)=0
                  IF(IPEV.GE.6)WRITE(6,*)
     *            ' XKSAMP s-s loop ,NCHSS1(NSS),NCHSS2(NSS),NSS ',
     *            NCHSS1(NSS),NCHSS2(NSS),NSS
                  INTSS1(NSS)=JJ
                  INTSS2(NSS)=J
                  INTLO(I)=.FALSE.
                  ZUOST(J)=.FALSE.
                  ZUOSP(JJ)=.FALSE.
C-------------------------------------------Mass check j.r.12/94------- 
                  SSMA1Q=XPSQ(JJ)*XTSAQ(J)*ECM**2
                  SSMA2Q=XPSAQ(JJ)*XTSQ(J)*ECM**2
                  IF(SSMA1Q.LT.1.2D0.OR.SSMA2Q.LT.1.2D0) THEN
                    ZUOST(J)=.TRUE.
                    ZUOSP(JJ)=.TRUE.
                    NSS=NSS-1
                    GO TO 410
                  ENDIF
C-------------------------------------------Mass check j.r.12/94------- 
C**********************************************************************
C**********************************************************************
C
C                                     Chain recombination option
C
                  ALLKET=(NVV+IXPS+IXTS)
		  IF(ALLKET.LE.1.D-5)THEN
		    WRITE(6,*)' xksamp ALLKET=0' , ALLKET
		    ALLKET=1.
		  ENDIf
C                 VALFRA=NVV/ALLKET
C                                       j.r.31.3.95
		  ANVVO=MIN(IXPV,IXTV)
		  ANSVO=IXTV-ANVVO
		  ANVSO=IXPV-ANVVO
		  ANSSO=(IXPV+IXPS)-ANVVO-ANSVO-ANVSO
		  IF(ANVVO+ANSSO.LE.1.D-5)THEN
		    WRITE(6,*)' xksamp (...)=0' ,ANVVO,ANSSO
		    ANSSO=1.
		  ENDIf
C		  VALFRA=1.D0
		  IF(ANVVO+ANSSO.GT.1.D-5)VALFRA=ANVVO/(ANVVO+ANSSO)
C                 IF(IRECOM.EQ.1.AND.RNDM(VALFRA).GT.VALFRA)THEN
                  IF(IRECOM.EQ.1)THEN
C--- sea-sea pair found, is there a v-v pair suitable for recombination
C    1. is there a v-v chain pair belonging to same projectile
C    2. is there a v-v chain pair belonging to same target
                    DO 4201 IVV=1,NVV
                      IF (NCHVV1(IVV).NE.99.AND.NCHVV2(IVV).NE.99)THEN
                        IXVPR=INTVV1(IVV)
                        INUCPR=IFROVP(IXVPR)
                        IXVTA=INTVV2(IVV)
                        INUCTA=IFROVT(IXVTA)
                        IF(IIPP.EQ.INUCPR.OR.IITT.EQ.INUCTA)THEN
C   suitable v-v chain pair found, calculate masses of recombined ch's
C   old chains:
C                         SSMA1Q=XPSQ(JJ)*XTSAQ(J)*ECM**2
C                         SSMA2Q=XPSAQ(JJ)*XTSQ(J)*ECM**2
C                         VVMA1Q=XPVQ(IXVPR)*XTVD(IXVTA)*ECM**2
C                         VVMA2Q=XPVD(IXVPR)*XTVQ(IXVTA)*ECM**2
C   new chains:
C                         SVMA1Q=XPSQ(JJ)*XTVD(IXVTA)*ECM**2
C                         SVMA2Q=XPSAQ(JJ)*XTVQ(IXVTA)*ECM**2
C                         VSMA1Q=XPVQ(IXVPR)*XTSAQ(J)*ECM**2
C                         VSMA2Q=XPVD(IXVPR)*XTSQ(J)*ECM**2
C
C                                  drop old v-v and s-s chains
C
                          NCHSS1(NSS)=99
                          NCHSS2(NSS)=99
                          NCHVV1(IVV)=99
                          NCHVV2(IVV)=99
                          IF(IPEV.GE.6)WRITE(6,*)
     *                    ' XKSAMP before DIQSV ,NCHSS1(NSS),',
     *                    'NCHSS2(NSS),NSS ',
     *                    NCHSS1(NSS),NCHSS2(NSS),NSS
C
C                                  assign new s-v and v-s chains
C
C             IF(LSEADI.AND.RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
                          IF(RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
C                           DEFINE D-V CHAINS (SEA-DIQUARK-VALENCE)
                            CALL DIQSV(ECM,IXVTA,JJ,IREJ)
                            IF(IREJ.EQ.0)GO TO 4202
                          ENDIF
                          IF(IPEV.GE.6)WRITE(6,*)
     *			  ' XKSAMP: NSS,NSV,NVS ',NSS,NSV,NVS
                          NSV=NSV+1
                          INTSV1(NSV)=JJ
                          INTSV2(NSV)=IXVTA
                          IF(IPEV.GE.6)WRITE(6,*)
     *		  	  ' XKSAMP: NSS,NSV,NVS ',NSS,NSV,NVS
C----------------correct sv chains to get minimum mass ------
                          AMSVQ1=XPSQ(JJ)*XTVD(IXVTA)*ECM**2
                          AMSVQ2=XPSAQ(JJ)*XTVQ(IXVTA)*ECM**2
                          JXPV=ITOVP(IIPP)
                          IF(IPEV.GE.6)WRITE(6,'(A,5I5)')
     *' XKSAMP s-s loop rec sv,vs IXVTA,JXPV,JJ',IXVTA,JXPV,JJ
                          IF(IPSQ(JJ).EQ.3)THEN
                            IF(AMSVQ1.GT.AMAS)THEN
		              IF(XTVD(IXVTA)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XTVD(IXVTA)=0 ',IXVTA
		                XTVD(IXVTA)=0.1D0
		              ENDIF
                              XPSQTH=AMAS/(XTVD(IXVTA)*ECM**2)
                              XPSQXX=SAMPEX(XPSQTH,XPSQ(JJ))
                              DXPSQ=XPSQ(JJ)-XPSQXX
                              XPSQ(JJ)=XPSQ(JJ)-DXPSQ
                              XPVD(JXPV)=XPVD(JXPV)+DXPSQ
                            ELSEIF(AMSVQ1.LT.AMAS)THEN
		              IF(XTVD(IXVTA)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *			        'xksamp: XTVD(IXVTA)=0 ',IXVTA
		                XTVD(IXVTA)=0.1D0
		              ENDIF
                              XPSQW=AMAS/(XTVD(IXVTA)*ECM**2)
                              DXPSQ=XPSQW-XPSQ(JJ)
                              ISXTVD(IXVTA)=1
                              IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                                XPVD(JXPV)=XPVD(JXPV)-DXPSQ
                                XPSQ(JJ)=XPSQW
                              ENDIF
                            ENDIF
C                           IF(AMSVQ2.GT.AMIS)THEN
                            IF(AMSVQ2.LT.AMIS)THEN
		              IF(XTVQ(IXVTA)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XTVQ(IXVTA)=0 ',IXVTA
		                XTVQ(IXVTA)=0.1D0
		              ENDIF
                              XPSQW=AMIS/(XTVQ(IXVTA)*ECM**2)
                              DXPSQ=XPSQW-XPSAQ(JJ)
                              ISXTVQ(IXVTA)=1
                              IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                                XPVD(JXPV)=XPVD(JXPV)-DXPSQ
C                                           s.r.xpsaq statt xpsq! 1294
                                XPSAQ(JJ)=XPSQW
                              ENDIF
                            ENDIF
                          ELSE
                            IF(AMSVQ1.GT.AMAU)THEN
		              IF(XTVD(IXVTA)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XTVD(IXVTA)=0 ',IXVTA
		                XTVD(IXVTA)=0.1D0
		              ENDIF
                              XPSQTH=AMAU/(XTVD(IXVTA)*ECM**2)
                              XPSQXX=SAMPEX(XPSQTH,XPSQ(JJ))
                              DXPSQ=XPSQ(JJ)-XPSQXX
                              XPSQ(JJ)=XPSQ(JJ)-DXPSQ
                              XPVD(JXPV)=XPVD(JXPV)+DXPSQ
                            ELSEIF(AMSVQ1.LT.AMAU)THEN
		              IF(XTVD(IXVTA)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XTVD(IXVTA)=0 ',IXVTA
		                XTVD(IXVTA)=0.1D0
		              ENDIF
                              XPSQW=AMAU/(XTVD(IXVTA)*ECM**2)
                              DXPSQ=XPSQW-XPSQ(JJ)
                              ISXTVD(IXVTA)=1
                              IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                                XPVD(JXPV)=XPVD(JXPV)-DXPSQ
                                XPSQ(JJ)=XPSQW
                              ENDIF
                            ENDIF
C                           IF(AMSVQ2.GT.AMIU)THEN
                            IF(AMSVQ2.LT.AMIU)THEN
		              IF(XTVQ(IXVTA)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XTVQ(IXVTA)=0 ',IXVTA
		                XTVQ(IXVTA)=0.1D0
		              ENDIF
                              XPSQW=AMIU/(XTVQ(IXVTA)*ECM**2)
                              DXPSQ=XPSQW-XPSAQ(JJ)
                              ISXTVQ(IXVTA)=1
                              IF(XPVD(JXPV).GE.XDTHR+DXPSQ)THEN 
                                XPVD(JXPV)=XPVD(JXPV)-DXPSQ
C                                           s.r.xpsaq statt xpsq! 1294
                                XPSAQ(JJ)=XPSQW
                              ENDIF
                            ENDIF
                          ENDIF
 4202                     CONTINUE
C-----------------------------------------------------------------
C
C                                  assign new s-v and v-s chains
C
C             IF(LSEADI.AND.RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
                          IF(RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
C                               DEFINE V-D CHAINS (valence - sea diquark)
                            CALL DIQVS(ECM,IXVPR,J,IREJ)
                            IF(IREJ.EQ.0)GO TO 4203
                          ENDIF
                          IF(IPEV.GE.6)WRITE(6,*)
     *			  ' XKSAMP: NSS,NSV,NVS ',NSS,NSV,NVS
                          NVS=NVS+1
                          INTVS1(NVS)=IXVPR
                          INTVS2(NVS)=J
                          IF(IPEV.GE.6)WRITE(6,*)
     *			  ' XKSAMP: NSS,NSV,NVS ',NSS,NSV,NVS
C------###-------correct vs chains to get minimum mass ------
                          AMVSQ1=XPVQ(IXVPR)*XTSAQ(J)*ECM**2
                          AMVSQ2=XPVD(IXVPR)*XTSQ(J)*ECM**2
                          JXTV=ITOVT(IITT)
                          IF(IPEV.GE.6)WRITE(6,'(A,5I5)')
     *' XKSAMP s-s loop rec vs IXVTA,JXPV,JJ',IXVTA,JXPV,JJ
                          IF(ITSQ(J).EQ.3)THEN
C                           IF(AMVSQ1.GT.AMIS)THEN
                            IF(AMVSQ1.LT.AMIS)THEN
		              IF(XPVQ(IXVPR)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XPVQ(IXVPR)=0 ',IXVPR
		                XPVQ(IXVPR)=0.1D0
		              ENDIF
                              XTSQW=AMIS/(XPVQ(IXVPR)*ECM**2)
                              DXTSQ=XTSQW-XTSAQ(J)
                              ISXPVQ(IXVPR)=1
                              IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                                XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                                XTSAQ(J)=XTSQW
                              ENDIF
                            ENDIF
                            IF(AMVSQ2.GT.AMAS)THEN
		              IF(XPVD(IXVPR)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XPVD(IXVPR)=0 ',IXVPR
		                XPVD(IXVPR)=0.1D0
		              ENDIF
                              XTSQTH=AMAS/(XPVD(IXVPR)*ECM**2)
                              XTSQXX=SAMPEX(XTSQTH,XTSQ(J))
                              DXTSQ=XTSQ(J)-XTSQXX
                              XTSQ(J)=XTSQ(J)-DXTSQ
                              XTVD(JXTV)=XTVD(JXTV)+DXTSQ
                            ELSEIF(AMVSQ2.LT.AMAS)THEN
		              IF(XPVD(IXVPR)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XPVD(IXVPR)=0 ',IXVPR
		                XPVD(IXVPR)=0.1D0
		              ENDIF
                              XTSQW=AMAS/(XPVD(IXVPR)*ECM**2)
                              ISXPVD(IXVPR)=1
                              DXTSQ=XTSQW-XTSQ(J)
                              IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                                XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                                XTSQ(J)=XTSQW
                              ENDIF
                            ENDIF
                          ELSE
C                           IF(AMVSQ1.GT.AMIU)THEN
                            IF(AMVSQ1.LT.AMIU)THEN
		              IF(XPVQ(IXVPR)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XPVQ(IXVPR)=0 ',IXVPR
		                XPVQ(IXVPR)=0.1D0
		              ENDIF
                              XTSQW=AMIU/(XPVQ(IXVPR)*ECM**2)
                              DXTSQ=XTSQW-XTSAQ(J)
                              ISXPVQ(IXVPR)=1
                              IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                                XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                                XTSAQ(J)=XTSQW
                              ENDIF
                            ENDIF
                            IF(AMVSQ2.GT.AMAU)THEN
		              IF(XPVD(IXVPR)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XPVD(IXVPR)=0 ',IXVPR
		                XPVD(IXVPR)=0.1D0
		              ENDIF
                              XTSQTH=AMAU/(XPVD(IXVPR)*ECM**2)
                              XTSQXX=SAMPEX(XTSQTH,XTSQ(J))
                              DXTSQ=XTSQ(J)-XTSQXX
                              XTSQ(J)=XTSQ(J)-DXTSQ
                              XTVD(JXTV)=XTVD(JXTV)+DXTSQ
                            ELSEIF(AMVSQ2.LT.AMAU)THEN
		              IF(XPVD(IXVPR)*ECM**2.LE.1.D-12)THEN
		                WRITE(6,*)
     *				' xksamp: XPVD(IXVPR)=0 ',IXVPR
		                XPVD(IXVPR)=0.1D0
		              ENDIF
                              XTSQW=AMAU/(XPVD(IXVPR)*ECM**2)
                              DXTSQ=XTSQW-XTSQ(J)
                              ISXPVD(IXVPR)=1
                              IF(XTVD(JXTV).GE.XDTHR+DXTSQ)THEN 
                                XTVD(JXTV)=XTVD(JXTV)-DXTSQ
                                XTSQ(J)=XTSQW
                              ENDIF
                            ENDIF
                          ENDIF
 4203                     CONTINUE
C-----------------------------------------------------------------
C
C                                 jump out of s-s chain loop
C
                          GO TO 420
                        ENDIF
                      ENDIF
 4201               CONTINUE
                  ENDIF
C     of loop recombination  IF(IRECOM.EQ.1)THEN
C**********************************************************************
C        we continue in s-s loop
C**********************************************************************
C
C                 IF(LSEADI.AND.RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
                  IF(RNDM(V).GT.2.D0*AMEDD-1.D0.AND.IDIQUA.EQ.1)THEN
C                               DEFINE D-S CHAINS (SEA-DIQUARK---SEA)
                    CALL DIQDSS(ECM,J,JJ,IREJ)
                    IF(IREJ.EQ.0) THEN
                      NCHSS1(NSS)=99
                      NCHSS2(NSS)=99
                      IF(IPEV.GE.6)WRITE(6,*)
     *                ' XKSAMP AFTER DIQDSS IREJ=0',
     *                ',NCHSS1(NSS),NCHSS2(NSS),NSS ',
     *                NCHSS1(NSS),NCHSS2(NSS),NSS
                      GO TO 410
                    ENDIF
                  ENDIF
C                 IF(LSEADI.AND.RNDM(V).GT.AMEDD.AND.IDIQUA.EQ.1)THEN
                  IF(RNDM(V).GT.2.D0*AMEDD-1.D0.AND.IDIQUA.EQ.1)THEN
C                               DEFINE S-D CHAINS (SEA---SEA-DIQUARK)
                    CALL DIQSSD(ECM,J,JJ,IREJ)
                    IF(IREJ.EQ.0) THEN
                      NCHSS1(NSS)=99
                      NCHSS2(NSS)=99
                      IF(IPEV.GE.6)WRITE(6,*)
     *                ' XKSAMP AFTER DIQSSD IREJ=0',
     *                ',NCHSS1(NSS),NCHSS2(NSS),NSS ',
     *                NCHSS1(NSS),NCHSS2(NSS),NSS
                      GO TO 410
                    ENDIF
                  ENDIF
                  SSMA1Q=XPSQ(JJ)*XTSAQ(J)*ECM**2
                  SSMA2Q=XPSAQ(JJ)*XTSQ(J)*ECM**2
                  IF(SSMA1Q.LT.SSMIMQ.OR.SSMA2Q.LT.SSMIMQ) THEN
                    JXPV=ITOVP(IIPP)
                    JXTV=ITOVT(IITT)
                    IF((XTVD(JXTV).GT.XDTHR+3.5D0*XSSTHR)
     *		    .AND.(XPVD(JXPV)
     +              .GT.XDTHR+3.5D0*XSSTHR)) THEN
*  maximum allowed x values for sea quarks
                      XSPMAX=1.0 - XPVQ(JXPV) - XDTHR - 1.2*XSSTHR
                      XSTMAX=1.0 - XTVQ(JXTV) - XDTHR - 1.2*XSSTHR
*  resampling of x values not possible / discard s-s interaction
                      IF((XSPMAX.LE.XSSTHR+0.05D0) .OR.(XSTMAX.LE.XSSTHR
     +                +0.05D0))                                 GOTO 380
*  resampling for projectile sea quark pair
                      ICOUS=0
  310                 CONTINUE
                      ICOUS=ICOUS + 1
                      IF(XSSTHR.GT.0.05D0) THEN
                        XPSQI=BETREJ(XSEACU,UNOSEA,XSSTHR,XSPMAX)
                        XPSAQI=BETREJ(XSEACU,UNOSEA,XSSTHR,XSPMAX)
                      ELSE
  320                   CONTINUE
                        XPSQI=DBETAR(XSEACU,UNOSEA)
                        IF(XPSQI.LT.XSSTHR.OR.XPSQI.GT.XSPMAX)  GOTO 320
  330                   CONTINUE
                        XPSAQI=DBETAR(XSEACU,UNOSEA)
                        IF(XPSAQI.LT.XSSTHR.OR.XPSAQI.GT.XSPMAX)
     +                                                          GOTO 330
                      ENDIF
*  final test of remaining x for projectile diquark
                      XPVDCO=XPVD(JXPV) - XPSQI - XPSAQI + XPSQ(JJ) +
     +                XPSAQ(JJ)
                      IF(XPVDCO.GT.XDTHR) THEN
*  projectile x sampling ok / continue with target sea
                        GOTO 340
                      ELSEIF(ICOUS.LT.5) THEN
                        GOTO 310
                      ELSE
*  too many unsuccessful attempts / discard s-s interaction
                        GOTO 380
                      ENDIF
*  resampling for target sea quark pair
  340                 CONTINUE
                      ICOUS=0
  350                 CONTINUE
                      ICOUS=ICOUS + 1
                      IF(XSSTHR.GT.0.05D0)THEN
                        XTSQI=BETREJ(XSEACU,UNOSEA,XSSTHR,XSTMAX)
                        XTSAQI=BETREJ(XSEACU,UNOSEA,XSSTHR,XSTMAX)
                      ELSE
  360                   CONTINUE
                        XTSQI=DBETAR(XSEACU,UNOSEA)
                        IF(XTSQI.LT.XSSTHR.OR.XTSQI.GT.XSTMAX)  GOTO 360
  370                   CONTINUE
                        XTSAQI=DBETAR(XSEACU,UNOSEA)
                        IF(XTSAQI.LT.XSSTHR.OR.XTSAQI.GT.XSTMAX)
     +                                                          GOTO 370
                      ENDIF
*   final test of remaining x for target diquark
                      XTVDCO=XTVD(JXTV) - XTSQI - XTSAQI + XTSQ(J) +
     +                XTSAQ(J)
                      IF(XTVDCO.LT.XDTHR) THEN
*   repeat x sampling for target sea quarks
                        IF(ICOUS.LT.5)                          GOTO 350
*   discard s-s interaction / too many unsuccessful trials
                                                                GOTO 380
                      ENDIF
*   modification of x values acceptable
                      XPVD(JXPV)=XPVDCO
                      XTVD(JXTV)=XTVDCO
                      XPSQ(JJ)=XPSQI
                      XPSAQ(JJ)=XPSAQI
                      XTSQ(J)=XTSQI
                      XTSAQ(J)=XTSAQI
                                                                GOTO 410
*   consider next s-s interaction
                    ENDIF
*   discard s-s interaction
*   resampling of x values not allowed or unsuccessful
  380               CONTINUE
                    INTLO(I)=.FALSE.
                    ZUOST(J)=.TRUE.
                    ZUOSP(JJ)=.TRUE.
                    NSS=NSS - 1
                  ENDIF
*   consider next s-s interaction
                                                                GOTO 410
                ENDIF
  390         CONTINUE
            ENDIF
  400     CONTINUE
        ENDIF
  410   CONTINUE
  420 CONTINUE
C
C                        CORRECT X-VALUES OF VALENCE QUARKS
C                        FOR NON-MATCHING SEA QUARKS
      DO 430 I=1,IXPS
        IF(ZUOSP(I)) THEN
          IIFROP=IFROSP(I)
          IITOP=ITOVP(IIFROP)
          XPVQ(IITOP)=XPVQ(IITOP) + XPSQ(I) + XPSAQ(I)
          ZUOSP(I)=.FALSE.
        ENDIF
  430 CONTINUE
      DO 440 I=1,IXTS
        IF(ZUOST(I)) THEN
          IIFROT=IFROST(I)
          IITOT=ITOVT(IIFROT)
          XTVQ(IITOT)=XTVQ(IITOT) + XTSQ(I) + XTSAQ(I)
          ZUOST(I)=.FALSE.
        ENDIF
  440 CONTINUE
C
      DO 450 I=1,IXPV
        IF(ZUOVP(I)) THEN
          IPIP=IFROVP(I)
          ISTHKK(IPIP)=13
        ENDIF
  450 CONTINUE
      DO 460 I=1,IXTV
        IF(ZUOVT(I)) THEN
          ITIT=IFROVT(I)
          ISTHKK(ITIT+IP)=14
        ENDIF
  460 CONTINUE
C
      IF(IPEV.GE.6) THEN
        WRITE(6,'(A)') ' XKSAMP: I,INTVV1,INTVV2,IFROVP,IFROVT'
        DO 470 I=1,NVV
          INUP=INTVV1(I)
          INUT=INTVV2(I)
          WRITE(6,'(5I5)') I,INUP,INUT,IFROVP(INUP),IFROVT(INUT)
  470   CONTINUE
       WRITE(6,'(A)')'XKSAMP:I(NSV),INTSV1,INTSV2,IFROSP,IFROVT'
        DO 480 I=1,NSV
          INUP=INTSV1(I)
          INUT=INTSV2(I)
          WRITE(6,'(5I5)') I,INUP,INUT,IFROSP(INUP),IFROVT(INUT)
  480   CONTINUE
        WRITE(6,'(A)') ' XKSAMP: I,INTVS1,INTVS2,IFROVP,IFROST'
        DO 490 I=1,NVS
          INUP=INTVS1(I)
          INUT=INTVS2(I)
          WRITE(6,'(5I5)') I,INUP,INUT,IFROVP(INUP),IFROST(INUT)
  490   CONTINUE
        WRITE(6,'(A)') ' XKSAMP: I,INTSS1,INTSS2,IFROSP,IFROST'
        DO 500 I=1,NSS
          INUP=INTSS1(I)
          INUT=INTSS2(I)
          WRITE(6,'(5I5)') I,INUP,INUT,IFROSP(INUP),IFROST(INUT)
  500   CONTINUE
C
        WRITE(6,'(A)')
     +  ' XKSAMP :  FINAL X-VALUES AFTER POTENTIAL CORRECTION'
        WRITE(6,1010)
        DO 510 I=1,IXPV
          WRITE(6,1020) I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I)
          WRITE(6,*)' I(1-IXPV),IPVQ(I),IPPV1(I),IPPV2(I) ',
     *    I,IPVQ(I),IPPV1(I),IPPV2(I)
  510   CONTINUE
        WRITE(6,1030)
        DO 520 I=1,IXPS
          WRITE(6,1040) I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)
          WRITE(6,*)' I(1-IXPS),IPSQ(I),IPSAQ(I) ',
     *    I,IPSQ(I),IPSAQ(I)
  520   CONTINUE
        WRITE(6,1050)
        DO 530 I=1,IXTV
          WRITE(6,1020) I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I)
          WRITE(6,*)' I(1-IXTV),ITVQ(I),ITTV1(I),ITTV2(I) ',
     *    I,ITVQ(I),ITTV1(I),ITTV2(I)
  530   CONTINUE
        WRITE(6,1060)
        DO 540 I=1,IXTS
          WRITE(6,1040) I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)
          WRITE(6,*)' I(1-IXTS),ITSQ(I),ITSAQ(I) ',
     *    I,ITSQ(I),ITSAQ(I)
  540   CONTINUE
      ENDIF
      IF(IPEV.GE.6)WRITE(6,'(A,6I5)')
     *' XKSAMP NSV,NDV,NVS,NVD',
     +    NSV,NDV,NVS,NVD
*  store properties of interacting partons into /HKKEVT/
      CALL PARHKK
      RETURN
      END
*-- Author :
*
*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*
      SUBROUTINE PARHKK
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C                         STORE INTERACTING PARTONS IN /HKKEVT/
C                         X-VALUES STORED IN PHKK(3,...) AND PHKK(4,...)
C                         POSITIONS OF NUCLEONS STORED IN VHKK
C                         FLAG FOR PROJECTILE VALENCE: ISTHKK=21
C                                  PROJECTILE SEA    : ISTHKK=31
C                         FLAG FOR TARGET VALENCE    : ISTHKK=22
C                                  TARGET SEA        : ISTHKK=32
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
C----------------------------------
      DO 10 I=1,IXPV
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=21
        KKKHKK=IFROVP(I)
        KKK=JHKKNP(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XPVQ(I)
        PHKK(4,NHKK)=XPVQ(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
C
        IF (IPHKK.GE.3) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=21
C         KKKHKK=IFROVP(I)
        KKK=JHKKNP(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XPVD(I)
        PHKK(4,NHKK)=XPVD(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
        JHKKPV(I)=NHKK
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1000 FORMAT (I6,I4,5I6,9E10.2)
   10 CONTINUE
C                                             ****  PROJECTILE SEA
      DO 20 I=1,IXPS
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=31
        KKKHKK=IFROSP(I)
        KKK=JHKKNP(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XPSQ(I)
        PHKK(4,NHKK)=XPSQ(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=31
        KKKHKK=IFROSP(I)
        KKK=JHKKNP(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XPSAQ(I)
        PHKK(4,NHKK)=XPSAQ(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
        JHKKPS(I)=NHKK
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20 CONTINUE
C                                             *****  TARGET VALENCE
      DO 30 I=1,IXTV
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=22
        KKKHKK=IFROVT(I)
        KKK=JHKKNT(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XTVQ(I)
        PHKK(4,NHKK)=XTVQ(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=22
        KKKHKK=IFROVT(I)
        KKK=JHKKNT(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XTVD(I)
        PHKK(4,NHKK)=XTVD(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
        JHKKTV(I)=NHKK
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   30 CONTINUE
C                                              *****  TARGET SEA
      DO 40 I=1,IXTS
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=32
        KKKHKK=IFROST(I)
        KKK=JHKKNT(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XTSQ(I)
        PHKK(4,NHKK)=XTSQ(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK)THEN
          IF (IPHKK.GE.1)
     &    WRITE (6,'(A,2I5)') ' XKSAMP: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
          RETURN
        ENDIF
        ISTHKK(NHKK)=32
        KKKHKK=IFROST(I)
        KKK=JHKKNT(KKKHKK)
        JMOHKK(1,NHKK)=KKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=0.
        PHKK(2,NHKK)=0.
        PHKK(3,NHKK)=XTSAQ(I)
        PHKK(4,NHKK)=XTSAQ(I)
        PHKK(5,NHKK)=0.
C           Add here position of parton in hadron
        VHKK(1,NHKK)=VHKK(1,KKK)
        VHKK(2,NHKK)=VHKK(2,KKK)
        VHKK(3,NHKK)=VHKK(3,KKK)
        VHKK(4,NHKK)=0.
        JHKKTS(I)=NHKK
C
        IF (IPHKK.GE.7) WRITE(6,1000) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40 CONTINUE
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRKK(NHKKH1,PPN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  HADRKK CONSTRUCTS ONE HADRONIZED EVENT FOR KK-COLLISIONS
C     ALL TYPES OF CHAINS ARE CONSIDERED
C     OPTONALLY GIVEN TYPES ARE SELECTED ACCORDING TO /DROPPT/
C
C--------------------------------------------------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,CMHICO.
      COMMON /CMHICO/ CMHIS
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BEGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEND.
C                                   modified DPMJET
       COMMON /BUFUES/ BNNVV,BNNSS,BNNSV,BNNVS,BNNCC,
     *                 BNNDV,BNNVD,BNNDS,BNNSD,
     *                 BNNHH,BNNZZ,
     *                 BPTVV,BPTSS,BPTSV,BPTVS,BPTCC,BPTDV,
     *                 BPTVD,BPTDS,BPTSD,
     *                 BPTHH,BPTZZ,
     *                 BEEVV,BEESS,BEESV,BEEVS,BEECC,BEEDV,
     *                 BEEVD,BEEDS,BEESD,
     *                 BEEHH,BEEZZ
     *                ,BNNDI,BPTDI,BEEDI
     *                ,BNNZD,BNNDZ,BPTZD,BPTDZ,BEEZD,BEEDZ
       COMMON /NCOUCS/ BCOUVV,BCOUSS,BCOUSV,BCOUVS,
     *                 BCOUZZ,BCOUHH,BCOUDS,BCOUSD,
     *                 BCOUDZ,BCOUZD,BCOUDI,
     *                 BCOUDV,BCOUVD,BCOUCC
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /JSPA/PXS(40000),PYS(40000),PZS(40000),HES(40000),NNNPS
C---------------------
      COMMON /BAMCO/  NVDD
      LOGICAL LSEADI
      COMMON /SEADIQ/ LSEADI
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON/DIQUAX/AMEDD,IDIQUA,IDIQUU
      COMMON /SECINT/ISECIN
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      DATA IEVCOU/0/
C-------------
      NNNPS=0
      IEVCOU=IEVCOU+1
      NHKKH1=NHKK
      IF (IPCO.GE.1) WRITE(6,1000) NVV,NVS,NSV,NSS
 1000 FORMAT (' ENTERING HADRKK NVV,NVS,NSV,NSS '/5I5)
C----------------------------------------------------------------------
C++++++++++++++  HADRONIZE SOFT SEA-SEA CHAINS   ++++++++++++++++++++++
C---
C                                   INITIALIZE COUNTERS
      ANNVV=0.001
      ANNSS=0.001
      ANNSV=0.001
      ANNVS=0.001
      ANNCC=0.001
      ANNDV=0.001
      ANNVD=0.001
      ANNDS=0.001
      ANNSD=0.001
      ANNHH=0.001
      ANNZZ=0.001
      ANNDI=0.001
      ANNZD=0.001
      ANNDZ=0.001
      PTVV=0.
      PTSS=0.
      PTSV=0.
      PTVS=0.
      PTCC=0.
      PTDV=0.
      PTVD=0.
      PTDS=0.
      PTSD=0.
      PTHH=0.
      PTZZ=0.
      PTDI=0.
      PTZD=0.
      PTDZ=0.
      EEVV=0.
      EESS=0.
      EESV=0.
      EEVS=0.
      EECC=0.
      EEDV=0.
      EEVD=0.
      EEDS=0.
      EESD=0.
      EEHH=0.
      EEZZ=0.
      EEDI=0.
      EEZD=0.
      EEDZ=0.
C      COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
C    *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
C    *                 ACOUDZ,ACOUZD,ACOUDI
       ACOUVV=0.
       ACOUSS=0.
       ACOUSV=0.
       ACOUVS=0.
       ACOUZZ=0.
       ACOUHH=0.
       ACOUDS=0.
       ACOUSD=0.
       ACOUDZ=0.
       ACOUZD=0.
       ACOUDI=0.
       ACOUDV=0.
       ACOUVD=0.
       ACOUCC=0.
*
      IF(IHADA.OR.IHADSS) THEN
        NVDD=0
        CALL HADRSS
      ENDIF
      IF(IHADA.OR.IHADSV) THEN
C                j.r.30.8.01
C       IF(IBPROJ.NE.0)CALL CASASV
        CALL CASASV
      ENDIF
      IF(IHADA.OR.IHADVS) THEN
C                j.r.30.8.01
C       IF(IBPROJ.NE.0)CALL CASAVS
        CALL CASAVS
      ENDIF
        IF (IMINIJ.EQ.1) CALL HADRHH
        CALL HADRZZ
      IF(IDIQUU.EQ.1)  CALL HADRDZ
      IF(IDIQUU.EQ.1)  CALL HADRZD
C
C
C---------------------------------------------------------------
C+++++++++++++++++++    HADRONIZE sea diquark - sea CHAINS  +++++++
C
C     IF(IHADA.OR.LSEADI) THEN
      IF(IHADA) THEN
        NVDD=0
      IF(IDIQUA.EQ.1)  CALL HADRDS
      ENDIF
C
C+++++++++++++++++++    HADRONIZE sea  - sea diquark CHAINS  +++++++
C
C     IF(IHADA.OR.LSEADI) THEN
      IF(IHADA) THEN
        NVDD=0
      IF(IDIQUA.EQ.1)  CALL HADRSD
      ENDIF
C
C
C---------------------------------------------------------------
C+++++++++++++++++++    HADRONIZE SEA-VALENCE CHAINS  +++++++++++++++++
C
      IF(IHADA.OR.IHADSV) THEN
        NVDD=0
        CALL HADRSV
      ENDIF
C
C---------------------------------------------------------------
C+++++++++++++++++++    HADRONIZE sea diquark - VALENCE CHAINS  +++++++
C
C     IF(IHADA.OR.LSEADI) THEN
      IF(IHADA) THEN
        NVDD=0
      IF(IDIQUA.EQ.1)  CALL HADRDV
      ENDIF
C
C----------------------------------------------------------------------
C+++++++++++++++++++    HADRONIZE VALENCE-SEA CHAINS  +++++++++++++++++
C
      IF(IHADA.OR.IHADVS) THEN
        NVDD=0
        CALL HADRVS
      ENDIF
C
C+++++++++++++++++++    HADRONIZE valence - sea diquark CHAINS  +++++++
C
C     IF(IHADA.OR.LSEADI) THEN
      IF(IHADA) THEN
        NVDD=0
      IF(IDIQUA.EQ.1)  CALL HADRVD
      ENDIF
C
C----------------------------------------------------------------------
C                       HADRONIZE VALENCE-VALENCE CHAINS
C---
      IF(IHADA.OR.IHADVV) THEN
        NVDD=0
        CALL HADRVV
      ENDIF
C
C----------------------------------------------------------------------
C                       HADRONIZE combined (qq)-(aqaq) chains
C---
C     IF(IHADA.AND.LCOMBI) THEN
C       NVDD=15
C       CALL HADRCC
C     ENDIF
C
C---------------------------------------------------------------
C                           OPTIONAL TEST OF
C                           ENERGY-MOMENTUM CONSERVATION
C                           IN NUCLEON-NUCLEON CMS
      IF (IPCO.GE.1)THEN
        PXSU=0.
        PYSU=0.
        PZSU=0.
        ESUM=0.
        ICHSU=0
        IBASU=0
        WRITE(6,'(A)') ' HADRONS FROM HADRKK / NUCLEON-NUCLEON CMS'
        DO 10 I=NHKKH1+1,NHKK
	IF(ISTHKK(I).EQ.1)THEN
          PXSU=PXSU + PHKK(1,I)
          PYSU=PYSU + PHKK(2,I)
          PZSU=PZSU + PHKK(3,I)
          ESUM=ESUM + PHKK(4,I)
          NREF=MCIHAD(IDHKK(I))
          ICHSU=ICHSU + IICH(NREF)
          IBASU=IBASU + IIBAR(NREF)
      IF (IPCO.GE.7)
     *    WRITE(6,1010)I,(PHKK(J,I),J=1,5), IICH(NREF),IIBAR(NREF),NREF,
     +    ANAME(NREF)
 1010 FORMAT(5X,I4,5(1PE11.3),2I2,I5,A10)
	ENDIF
   10   CONTINUE
        WRITE(6,1020) PXSU,PYSU,PZSU,ESUM,ICHSU,IBASU
 1020 FORMAT(' PXSU,PYSU,PZSU,ESUM,ICHSU,IBASU'/4F10.3,2I5)
      ENDIF
C
       CALL DECHKK(NHKKH1)
C
C----------------------------------------------------------------------
C                                 LT FROM NUCLEON-NUCLEON CMS INTO LAB
C                                 PUT LAB SYSTEM PARTICLES INTO /HKKEVT/
      CMHISS=1.D0
      DO 20 I=NHKKH1+1,NHKK
        PZNN=PHKK(3,I)
        ENN =PHKK(4,I)
        IF (CMHISS.EQ.0.D0)THEN
C         PHKK(3,I) = GAMCM*PZNN + BGCM*ENN
C         PHKK(4,I) = GAMCM*ENN  + BGCM*PZNN
          PHKK(3,I) = GAMCM*PZNN + BGCM*ENN
          PHKK(4,I) = GAMCM*ENN  + BGCM*PZNN
        ENDIF
        EHECC=SQRT(PHKK(1,I)** 2+ PHKK(2,I)** 2+ PHKK(3,I)** 2+ PHKK
     +  (5,I)**2)
        IF (ABS(EHECC-PHKK(4,I)).GT.0.001D0) THEN
C            WRITE(6,'(2A/3I5,3E16.6)')
C    &         ' HADRKK: CORRECT INCONSISTENT ENERGY ',
C    *         '  IEVCOU, I,IDHKK(I), PHKK(4,I),EHECC, PHKK(5,I)',
C    *            IEVCOU, I,IDHKK(I), PHKK(4,I),EHECC, PHKK(5,I)
          PHKK(4,I)=EHECC
        ENDIF
   20 CONTINUE
C                    Secondary Interactions
      IF(ISECIN.EQ.1)CALL SEWEW(1,NHKKH1)
      KTAUAC=99
C	 IF (CMHIS.EQ.0.D0) CALL DISTR(2,NHKKH1,PPN,KTAUAC)
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C                           OPTIONAL TEST OF
C                           ENERGY-MOMENTUM CONSERVATION IN LAB SYSTEM
      IF (IPCO.GE.2)THEN
        PXSU=0.
        PYSU=0.
        PZSU=0.
        ESUM=0.
        ICHSU=0
        IBASU=0
        WRITE(6,'(A)') ' HADRONS FROM HADRKK / CMS SYSTEM'
        DO 30 I=NHKKH1+1,NHKK
	  IF(ISTHKK(I).EQ.1)THEN
          PXSU=PXSU + PHKK(1,I)
          PYSU=PYSU + PHKK(2,I)
          PZSU=PZSU + PHKK(3,I)
          ESUM=ESUM + PHKK(4,I)
          NREF=MCIHAD(IDHKK(I))
          ICHSU=ICHSU + IICH(NREF)
          IBASU=IBASU + IIBAR(NREF)
      IF (IPCO.GE.7)
     *    WRITE(6,1010) I, (PHKK(J,I),J=1,5), IICH(NREF),IIBAR(NREF),
     +    NREF,ANAME(NREF)
	ENDIF
   30   CONTINUE
        WRITE(6,1020) PXSU,PYSU,PZSU,ESUM,ICHSU,IBASU
      ENDIF
C
C------------------------------------------------------------------
C
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRVV
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C-------------------------
C
C                       HADRONIZE VALENCE-VALENCE CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C-------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,ABRVV.
      COMMON /ABRVV/ AMCVV1(248),AMCVV2(248),GACVV1(248),GACVV2(248),
     +BGXVV1(248),BGYVV1(248),BGZVV1(248), BGXVV2(248),BGYVV2(248),
     +BGZVV2(248), NCHVV1(248),NCHVV2(248),IJCVV1(248),IJCVV2(248),
     +PQVVA1(248,4),PQVVA2(248,4), PQVVB1(248,4),PQVVB2(248,4)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
C---------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALVV /0/
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' hadrVV'
C-----------------------------------------------------------------
      NCALVV=NCALVV+1
      DO 50 I=1,NVV
C-----------------------drop recombined chain pairs
        IF(NCHVV1(I).EQ.99.AND.NCHVV2(I).EQ.99) GO TO 50
        IS1=INTVV1(I)
        IS2=INTVV2(I)
C
        IF (IPCO.GE.1) WRITE (6,1000) IPVQ(IS1),IPPV1(IS1),IPPV2(IS1),
     +  ITVQ(IS2),ITTV1(IS2),ITTV2(IS2), AMCVV1(I),AMCVV2(I),GACVV1(I),
     +  GACVV2(I), BGXVV1(I),BGYVV1(I),BGZVV1(I), BGXVV2(I),BGYVV2(I),
     +  BGZVV2(I), NCHVV1(I),NCHVV2(I),IJCVV1(I),IJCVV2(I), PQVVA1(I,4),
     +  PQVVA2(I,4),PQVVB1(I,4),PQVVB2(I,4)
 
 
 
 1000 FORMAT(6I5,10F9.2/10X,4I5,4F12.4)
C
C------------------------------  CHAIN 1:
C                            INCIDENT BARYONS/MESONS: QUARK-DIQUARK
C                            INCIDENT ANTIBARYONS   : AQUARK-QUARK
        IF(IBPROJ.GE.0) THEN
          IFB1=IPVQ(IS1)
          IFB2=ITTV1(IS2)
          IFB3=ITTV2(IS2)
          NOBAM=4
        ELSE
          IFB1=IPVQ(IS1)
          IFB2=ITVQ(IS2)
          IFB1=IABS(IFB1) + 6
          NOBAM=3
        ENDIF
C
        DO 10 J=1,4
          POJ(J)=PQVVA1(I,J)
          PAT(J)=PQVVA2(I,J)
   10   CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,1,NEVT)
C------------------------------------------------------------------
C------------------------------------------------------------------
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain     
C               Projectile Nr ipp = IFROVP(INTVV1(I))
C               Target     Nr itt = IFROVT(INTVV2(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
       IPPP = IFROVP(INTVV1(I))
       ITTT = IFROVT(INTVV2(I))
       JIPP=JSSHS(IPPP)
       JITT=JTSHS(ITTT)
C	IF(NCHVV1(I).EQ.0)THEN
C      WRITE(6,'(A,5I5)')'HADRVV: I,IPPP,ITTT,JIPP,JITT ',
C    *                     I,IPPP,ITTT,JIPP,JITT
C	ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' VV q-qq ,IFB1,IFB2,IFB3,',
     *	'INTVV1=IS1,INTVV2=IS2,JIPP,JITT',
     *	IFB1,IFB2,IFB3,INTVV1(I),INTVV2(I),JIPP,JITT
      ENDIF
	IF(NOBAM.EQ.3.OR.NCHVV1(I).NE.0)THEN
C       CALL HADJET(NHAD,AMCVV1(I),PAT,POJ,GACVV1(I),BGXVV1(I), BGYVV1
        CALL HADJET(NHAD,AMCVV1(I),POJ,PAT,GACVV1(I),BGXVV1(I), BGYVV1
     +  (I),BGZVV1(I),IFB1,IFB2,IFB3,IFB4, IJCVV1(I),IJCVV1(I),NOBAM,
     +  NCHVV1(I),7)
        ENDIF
	AACK=FLOAT(ICK4)/FLOAT(ICK4+IHAD4+1)
	IF((NCHVV1(I).EQ.0).AND.
     *      (NOBAM.EQ.4))THEN
        ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE+ ZSEAWU*PDBSEU
 	IF(IPCO.GE.1)WRITE(6,*)'HADJSE JITT,RSEACK,PDBSE 1 dpmnuc3',
     +	JITT,RSEACK,PDBSE
        IREJSS=5
        IF(RNDM(V).LE.RSEACK)THEN
	IREJSS=2
	IF(AMCVV1(I).GT.2.3D0)THEN
	  IREJSS=0
          CALL HADJSE(NHAD,AMCVV1(I),POJ,PAT,GACVV1(I),BGXVV1(I), BGYVV1
     +    (I),BGZVV1(I),IFB1,IFB2,IFB3,IFB4, IJCVV1(I),IJCVV1(I),NOBAM,
     +    NCHVV1(I),7,IREJSS,IISSQQ)
 	  IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *	  'RSEACK,IREJSS 1 dpmnuc3 ',
     +	  JITT,RSEACK,IREJSS
        ENDIF
	IF(IREJSS.GE.1)THEN
	IF(IREJSS.EQ.1)IREJSE=IREJSE+1
	IF(IREJSS.EQ.3)IREJS3=IREJS3+1
	IF(IREJSS.EQ.2)IREJS0=IREJS0+1
        CALL HADJET(NHAD,AMCVV1(I),POJ,PAT,GACVV1(I),BGXVV1(I), BGYVV1
     +  (I),BGZVV1(I),IFB1,IFB2,IFB3,IFB4, IJCVV1(I),IJCVV1(I),NOBAM,
     +  NCHVV1(I),7)
	IHAD4=IHAD4+1
	ENDIF
	IF(IREJSS.EQ.0)THEN
	  IF(IISSQQ.EQ.3)THEN
	    ISE43=ISE43+1
	  ELSE
	    ISE4=ISE4+1
	  ENDIF
	ENDIF
        ELSEIF((IJPOCK.EQ.1).AND.
     *      (AACK.LE.PDBCK))THEN
	IREJ=0
        CALL HADJCK(NHAD,AMCVV1(I),POJ,PAT,GACVV1(I),BGXVV1(I), BGYVV1
     +  (I),BGZVV1(I),IFB1,IFB2,IFB3,IFB4, IJCVV1(I),IJCVV1(I),NOBAM,
     +  NCHVV1(I),7,IREJ)
	IF(IREJ.EQ.1)THEN
	IREJCK=IREJCK+1
        CALL HADJET(NHAD,AMCVV1(I),POJ,PAT,GACVV1(I),BGXVV1(I), BGYVV1
     +  (I),BGZVV1(I),IFB1,IFB2,IFB3,IFB4, IJCVV1(I),IJCVV1(I),NOBAM,
     +  NCHVV1(I),7)
	IHAD4=IHAD4+1
	ENDIF
	IF(IREJ.EQ.0)ICK4=ICK4+1
	ELSE
        CALL HADJET(NHAD,AMCVV1(I),POJ,PAT,GACVV1(I),BGXVV1(I), BGYVV1
     +  (I),BGZVV1(I),IFB1,IFB2,IFB3,IFB4, IJCVV1(I),IJCVV1(I),NOBAM,
     +  NCHVV1(I),7)
	IHAD4=IHAD4+1
	ENDIF
	ENDIF
C------------------------------------------------------------------
C------------------------------------------------------------------
        ACOUVV=ACOUVV+1
C*** REMOVED *** 31/07/90 ***      ADD HADRONS/RESONANCES INTO
C***                               COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
C
C         NHKK=NHKK+1
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRVV: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001D0) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRVV / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALVV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALVV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNVV=ANNVV+1
          EEVV=EEVV+HEF(J)
C                              PUT NN-CMS HADRONS INTO /HKKEVT/
          PTVV=PTVV+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKVV(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
C         WRITE(6,*)' HKKFIL: NHKKAU,IORMO(J) ',ISTIST, NHKKAU,IORMO(J)
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1010) NHKK,NREF(J),IDHKK
     +    (NHKK)
 1010 FORMAT (' NHKK,NREF(J),  ',3I10)
          IMOHKK=JMOHKK(1,NHKK)
          IF(IMOHKK.LE.0.OR.IMOHKK.GT.NMXHKK)THEN
            WRITE(6,'(A,I10)')' HADRVV out of range IMOHKK= ',I10
            GO TO 2020
          ENDIF
	  IF(IREJSS.LT.0)THEN
 	  WRITE(6,*)' From HADRVV 1 first chain after HKKFIL'
          IF (IPHKK.GE.0) WRITE(6,1020) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
          ENDIF
 1020 FORMAT (I6,I4,5I6,9E10.2)
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
 2020   CONTINUE
C
C------------------------------    CHAIN 2
C                        INCIDENT BARYONS    :  DIQUARK-QUARK
C                        INCIDENT MESONS     :  AQUARK-QUARKC
C                        INCIDENT ANTIBARYONS:  ADIQUARK-DIQUARK
C
        IF(IBPROJ.GT.0) THEN
          IFB1=IPPV1(IS1)
          IFB2=IPPV2(IS1)
          IFB3=ITVQ(IS2)
          NOBAM=6
        ELSEIF(IBPROJ.EQ.0) THEN
          IFB1=IPPV1(IS1)
          IFB2=ITVQ(IS2)
          IFB1=IABS(IFB1) + 6
          NOBAM=3
        ELSE
          IFB1=IPPV1(IS1)
          IFB2=IPPV2(IS1)
          IFB1=IABS(IFB1) + 6
          IFB2=IABS(IFB2) + 6
          IFB3=ITTV1(IS2)
          IFB4=ITTV2(IS2)
          NOBAM=5
        ENDIF
C
        DO 30 J=1,4
          POJ(J)=PQVVB2(I,J)
          PAT(J)=PQVVB1(I,J)
   30   CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,1,NEVT)
C***                                       POJ,PAT EXCHANGED J.R.15.2.90
C***                                       RECHANGED 19/09/90  HJM
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain     
C               Projectile Nr ipp = IFROVP(INTVV1(I))
C               Target     Nr itt = IFROVT(INTVV2(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
       IPPP = IFROVP(INTVV1(I))
       ITTT = IFROVT(INTVV2(I))
       JIPP=JSSHS(IPPP)
       JITT=JTSHS(ITTT)
C	IF(NCHVV2(I).EQ.0)THEN
C      WRITE(6,'(A,5I5)')'HadrVV: I,IPPP,ITTT,JIPP,JITT ',
C    *                     I,IPPP,ITTT,JIPP,JITT
C	ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' VV qq-q ,IFB1,IFB2,IFB3,',
     *	'INTVV1=IS1,INTVV2=IS2,JIPP,JITT',
     *	IFB1,IFB2,IFB3,INTVV1(I),INTVV2(I),JIPP,JITT
      ENDIF
	IF(NOBAM.EQ.5.OR.NOBAM.EQ.3.OR.NCHVV2(I).NE.0)THEN
C       CALL HADJET(NHAD,AMCVV2(I),PAT,POJ,GACVV2(I),BGXVV2(I), BGYVV2
        CALL HADJET(NHAD,AMCVV2(I),POJ,PAT,GACVV2(I),BGXVV2(I), BGYVV2
     +  (I),BGZVV2(I),IFB1,IFB2,IFB3,IFB4, IJCVV2(I),IJCVV2(I),NOBAM,
     +  NCHVV2(I),8)
	ENDIF
	AACK=FLOAT(ICK6)/FLOAT(ICK6+IHAD6+1)
	IF((NCHVV2(I).EQ.0).AND.
     *      (NOBAM.EQ.6))THEN
        ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JIPP)*PDBSE+ ZSEAWU*PDBSEU
 	IF(IPCO.GE.1)WRITE(6,*)'HADJSE JIPP,RSEACK,PDBSE 2 dpmnuc3',
     +	JIPP,RSEACK,PDBSE
        IREJSS=5
	IF(RNDM(V).LE.RSEACK)THEN
	IREJSS=2
	IF(AMCVV2(I).GT.2.3D0)THEN
	  IREJSS=0
          CALL HADJSE(NHAD,AMCVV2(I),POJ,PAT,GACVV2(I),BGXVV2(I), BGYVV2
     +    (I),BGZVV2(I),IFB1,IFB2,IFB3,IFB4, IJCVV2(I),IJCVV2(I),NOBAM,
     +    NCHVV2(I),8,IREJSS,IISSQQ)
 	  IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *	  'RSEACK,IREJSS 2 dpmnux3 ',
     +	  JIPP,RSEACK,IREJSS
        ENDIF
	IF(IREJSS.GE.1)THEN
	IF(IREJSS.EQ.1)IREJSE=IREJSE+1
	IF(IREJSS.EQ.3)IREJS3=IREJS3+1
	IF(IREJSS.EQ.2)IREJS0=IREJS0+1
        CALL HADJET(NHAD,AMCVV2(I),POJ,PAT,GACVV2(I),BGXVV2(I), BGYVV2
     +  (I),BGZVV2(I),IFB1,IFB2,IFB3,IFB4, IJCVV2(I),IJCVV2(I),NOBAM,
     +  NCHVV2(I),8)
	IHAD6=IHAD6+1
	ENDIF
	IF(IREJSS.EQ.0)THEN
	  IF(IISSQQ.EQ.3)THEN
	    ISE63=ISE63+1
	  ELSE
	    ISE6=ISE6+1
	  ENDIF
	ENDIF
        ELSEIF((IJPOCK.EQ.1).AND.
     *      (AACK.LE.PDBCK))THEN
	IREJ=0
        CALL HADJCK(NHAD,AMCVV2(I),POJ,PAT,GACVV2(I),BGXVV2(I), BGYVV2
     +  (I),BGZVV2(I),IFB1,IFB2,IFB3,IFB4, IJCVV2(I),IJCVV2(I),NOBAM,
     +  NCHVV2(I),8,IREJ)
	IF(IREJ.EQ.1)THEN
	IREJCK=IREJCK+1
        CALL HADJET(NHAD,AMCVV2(I),POJ,PAT,GACVV2(I),BGXVV2(I), BGYVV2
     +  (I),BGZVV2(I),IFB1,IFB2,IFB3,IFB4, IJCVV2(I),IJCVV2(I),NOBAM,
     +  NCHVV2(I),8)
	IHAD6=IHAD6+1
	ENDIF
	IF(IREJ.EQ.0)ICK6=ICK6+1
	ELSE
        CALL HADJET(NHAD,AMCVV2(I),POJ,PAT,GACVV2(I),BGXVV2(I), BGYVV2
     +  (I),BGZVV2(I),IFB1,IFB2,IFB3,IFB4, IJCVV2(I),IJCVV2(I),NOBAM,
     +  NCHVV2(I),8)
	IHAD6=IHAD6+1
	ENDIF
	ENDIF
C                                  ADD HADRONS/RESONANCES INTO
C                                  COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
C         NHKK=NHKK+1
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRVV: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001D0) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRVV / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALVV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALVV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
C                              PUT NN-CMS HADRONS INTO /HKKEVT/
          ANNVV=ANNVV+1
          EEVV=EEVV+HEF(J)
          PTVV=PTVV+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKVV(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
C         WRITE(6,*)' HKKFIL: NHKKAU,IORMO(J) ',ISTIST, NHKKAU,IORMO(J)
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1010)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IMOHKK=JMOHKK(1,NHKK)
          IF(IMOHKK.LE.0.OR.IMOHKK.GT.NMXHKK)THEN
            WRITE(6,'(A,I10)')' HADRVV out of range IMOHKK= ',I10
            GO TO 4040
          ENDIF
	  IF(IREJSS.LT.0)THEN
 	  WRITE(6,*)' From HADRVV second chain after HKKFIL'
          IF (IPHKK.GE.0) WRITE(6,1020) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
          ENDIF
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
 4040   CONTINUE
   50 CONTINUE
C
C------------------------------------------------------------------
C
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRSV
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       HADRONIZE SEA-VALENCE CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,ABRSV.
      COMMON /ABRSV/ AMCSV1(248),AMCSV2(248),GACSV1(248),GACSV2(248),
     +BGXSV1(248),BGYSV1(248),BGZSV1(248), BGXSV2(248),BGYSV2(248),
     +BGZSV2(248), NCHSV1(248),NCHSV2(248),IJCSV1(248),IJCSV2(248),
     +PQSVA1(248,4),PQSVA2(248,4), PQSVB1(248,4),PQSVB2(248,4)
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEND.
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      COMMON /CASADI/CASAXX,ICASAD
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALSV /0/
C-----------------------------------------------------------------------
      NCALSV=NCALSV+1
      DO 50 I=1,NSV
C-----------------------drop recombined chain pairs
        IF(NCHSV1(I).EQ.99.AND.NCHSV2(I).EQ.99) GO TO 50
        IS1=INTSV1(I)
        IS2=INTSV2(I)
C
        IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITVQ(IS2),
     +  ITTV1(IS2),ITTV2(IS2), AMCSV1(I),AMCSV2(I),GACSV1(I),GACSV2(I),
     +  BGXSV1(I),BGYSV1(I),BGZSV1(I), BGXSV2(I),BGYSV2(I),BGZSV2(I),
     +  NCHSV1(I),NCHSV2(I),IJCSV1(I),IJCSV2(I), PQSVA1(I,4),PQSVA2
     +  (I,4),PQSVB1(I,4),PQSVB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  QUARK-DIQUARK   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=ITTV1(IS2)
        IFB3=ITTV2(IS2)
        DO 10 J=1,4
          POJ(J)=PQSVA1(I,J)
          PAT(J)=PQSVA2(I,J)
   10   CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,3,NEVT)
C       IF((NCHSV1(I).NE.0.OR.NCHSV2(I).NE.0).AND.IP.NE.1)
C    &  CALL SAPTRE(AMCSV1(I),GACSV1(I),BGXSV1(I),BGYSV1(I),BGZSV1(I),
C    &              AMCSV2(I),GACSV2(I),BGXSV2(I),BGYSV2(I),BGZSV2(I))
C----------------------------------------------------------------
        IF (IPCO.GE.6)WRITE (6,1244) POJ,PAT
 1244   FORMAT ('  S-V QUARK-DIQUARK POJ,PAT ',8E12.3)
C------------------------------------------------------------------
C------------------------------------------------------------------
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain     
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
       ITTT = IFROVT(INTSV2(I))
       JITT=JTSHS(ITTT)
C	IF(NCHSV1(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRSV: I,ITTT,JITT ',
C    *                     I,ITTT,JITT
C	ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' SV q-qq ,IFB1,IFB2,IFB3,',
     *	'INTSV1=IS1,INTSV2=IS2,JIPPX,JITT',
     *	IFB1,IFB2,IFB3,INTSV1(I),INTSV2(I),JIPPX,JITT
       ENDIF
C------------------------------------------------------------------- 
C-------------------------------------------------------------------    
	IF((NCHSV1(I).NE.0))THEN
        CALL HADJET(NHAD,AMCSV1(I),POJ,PAT,GACSV1(I),BGXSV1(I), BGYSV1
     +  (I),BGZSV1(I),IFB1,IFB2,IFB3,IFB4, IJCSV1(I),IJCSV1(I),4,NCHSV1
     +  (I),3)
	ENDIF
	AACK=FLOAT(ICK4)/FLOAT(ICK4+IHAD4+1)
	IF((NCHSV1(I).EQ.0))THEN
        ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE+ ZSEAWU*PDBSEU
 	IF(IPCO.GE.1)WRITE(6,*)'HADJSE JITT,RSEACK,PDBSE 3 dpmnuc3',
     +	JITT,RSEACK,PDBSE
        IREJSS=5
        IF(RNDM(V).LE.RSEACK)THEN
	IREJSS=2
	IF(AMCSV1(I).GT.2.3D0)THEN
          IREJSS=0
          CALL HADJSE(NHAD,AMCSV1(I),POJ,PAT,GACSV1(I),BGXSV1(I),
     *	  BGYSV1
     +    (I),BGZSV1(I),IFB1,IFB2,IFB3,IFB4, IJCSV1(I),IJCSV1(I),4,
     *    NCHSV1
     +    (I),3,IREJSS,IISSQQ)
 	  IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *	  'RSEACK,IREJSS 3 dpmnuc3 ',
     +	  JITT,RSEACK,IREJSS
        ENDIF
	IF(IREJSS.GE.1)THEN
	IF(IREJSS.EQ.1)IREJSE=IREJSE+1
	IF(IREJSS.EQ.3)IREJS3=IREJS3+1
	IF(IREJSS.EQ.2)IREJS0=IREJS0+1
        CALL HADJET(NHAD,AMCSV1(I),POJ,PAT,GACSV1(I),BGXSV1(I), BGYSV1
     +  (I),BGZSV1(I),IFB1,IFB2,IFB3,IFB4, IJCSV1(I),IJCSV1(I),4,NCHSV1
     +  (I),3)
	IHAD4=IHAD4+1
	ENDIF
        IF(IREJSS.EQ.0)THEN
	  IF(IISSQQ.EQ.3)THEN
	    ISE43=ISE43+1
	  ELSE
	    ISE4=ISE4+1
	  ENDIF  
	ENDIF    
        ELSEIF((IJPOCK.EQ.1).AND.
     *      (AACK.LE.PDBCK))THEN
	IREJ=0
        CALL HADJCK(NHAD,AMCSV1(I),POJ,PAT,GACSV1(I),BGXSV1(I), BGYSV1
     +  (I),BGZSV1(I),IFB1,IFB2,IFB3,IFB4, IJCSV1(I),IJCSV1(I),4,NCHSV1
     +  (I),3,IREJ)
	IF(IREJ.EQ.1)THEN
	IREJCK=IREJCK+1
        CALL HADJET(NHAD,AMCSV1(I),POJ,PAT,GACSV1(I),BGXSV1(I), BGYSV1
     +  (I),BGZSV1(I),IFB1,IFB2,IFB3,IFB4, IJCSV1(I),IJCSV1(I),4,NCHSV1
     +  (I),3)
	IHAD4=IHAD4+1
	ENDIF
        IF(IREJ.EQ.0)ICK4=ICK4+1
	ELSE
        CALL HADJET(NHAD,AMCSV1(I),POJ,PAT,GACSV1(I),BGXSV1(I), BGYSV1
     +  (I),BGZSV1(I),IFB1,IFB2,IFB3,IFB4, IJCSV1(I),IJCSV1(I),4,NCHSV1
     +  (I),3)
	IHAD4=IHAD4+1
	ENDIF
	ENDIF
C------------------------------------------------------------------
C------------------------------------------------------------------
        ACOUSV=ACOUSV+1
C*** REMOVED 31/07/90 HJM ***      ADD HADRONS/RESONANCES INTO
C                                  COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        PIXU=0.
        PIYU=0.
        PIZU=0.
        PIEU=0.
        DO 20 J=1,NHAD
C         NHKK=NHKK+1
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRSV: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001D0.AND.IBARF(J).NE.500) THEN
            WRITE(6,'(2A/3I5,3E15.6)')
     &            ' HADRSV / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
     *            '  NCALSV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
     *            NCALSV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNSV=ANNSV+1
          EESV=EESV+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTSV=PTSV+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKSV(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
C         WRITE(6,*)' HKKFIL: NHKKAU,IORMO(J) ',ISTIST, NHKKAU,IORMO(J)
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          PIXU=PIXU+PXF(J)
          PIYU=PIYU+PYF(J)
          PIZU=PIZU+PZF(J)
          PIEU=PIEU+HEF(J)
	  IF(IREJSS.LT.0)THEN
	  WRITE(6,*)' HADRSV / CHAIN 1'
          IF (IPHKK.GE.0) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
          ENDIF
   20   CONTINUE
        IF(IPCO.GE.6)WRITE(6,1644)PIXU,PIYU,PIZU,PIEU
 1644   FORMAT(' HADRSV,ch1 PIXU,PIYU,PIZU,PIEU ',4F12.5)
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2:  AQUARK-QUARK  ++++++++++++++
        IFB1=IPSAQ(IS1)
        IFB2=ITVQ(IS2)
        IFB1=IABS(IFB1)+6
        DO 30 J=1,4
          POJ(J)=PQSVB2(I,J)
          PAT(J)=PQSVB1(I,J)
   30   CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,3,NEVT)
C
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' SV aq-q ,IFB1,IFB2,',
     *	'INTSV1=IS1,INTSV2=IS2,JIPPX,JITTX',
     *	IFB1,IFB2,INTSV1(I),INTSV2(I),JIPPX,JITTX
      ENDIF
C------------------------------------------------------------------- 
C-------------------------------------------------------------------    
        IF (IPCO.GE.6)WRITE (6,1244) POJ,PAT
        CALL HADJET(NHAD,AMCSV2(I),POJ,PAT,GACSV2(I),BGXSV2(I), BGYSV2
     +  (I),BGZSV2(I),IFB1,IFB2,IFB3,IFB4, IJCSV2(I),IJCSV2(I),3,NCHSV2
     +  (I),4)
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        PIXU=0.
        PIYU=0.
        PIZU=0.
        PIEU=0.
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRSV: NHKK.EQ.NMXHKK ', NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001D0.AND.IBARF(J).NE.500) THEN
              WRITE(6,'(2A/3I5,3E15.6)')
     &            ' HADRSV / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
     *            '  NCALSV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
     *            NCALSV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNSV=ANNSV+1
          EESV=EESV+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTSV=PTSV+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKSV(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          PIXU=PIXU+PXF(J)
          PIYU=PIYU+PYF(J)
          PIZU=PIZU+PZF(J)
          PIEU=PIEU+HEF(J)
          IF (IPHKK.GE.7) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
        IF(IPCO.GE.6)WRITE(6,1644)PIXU,PIYU,PIZU,PIEU
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRSS
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,ABRSS.
C     INCLUDE (ABRSS)
      COMMON /ABRSS/ AMCSS1(INTMX),AMCSS2(INTMX), GACSS1(INTMX),GACSS2
     +(INTMX), BGXSS1(INTMX),BGYSS1(INTMX),BGZSS1(INTMX), BGXSS2(INTMX),
     +BGYSS2(INTMX),BGZSS2(INTMX), NCHSS1(INTMX),NCHSS2(INTMX), IJCSS1
     +(INTMX),IJCSS2(INTMX), PQSSA1(INTMX,4),PQSSA2(INTMX,4), PQSSB1
     +(INTMX,4),PQSSB2(INTMX,4)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      DIMENSION POJ(4),PAT(4)
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /PSHOW/ IPSHOW
C     COMMON /HARLUN/ IHARLU,QLUN
      COMMON /HARLUN/ QLUN,IHARLU
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
      COMMON /JSPA/PXS(40000),PYS(40000),PZS(40000),HES(40000),NNNPS
      COMMON /NOMIJE/ PTMIJE(10),NNMIJE(10)
      COMMON /CASADI/CASAXX,ICASAD
C-----------------------------------------------------------------------
      DO 60 I=1,NSS
C-----------------------drop recombined chain pairs
        IF(NCHSS1(I).EQ.99.AND.NCHSS2(I).EQ.99) GO TO 60
        IF (INLOSS(I)) THEN
          IS1=INTSS1(I)
          IS2=INTSS2(I)
C
          IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITSQ(IS2),
     +    ITSAQ(IS2), AMCSS1(I),AMCSS2(I),GACSS1(I),GACSS2(I), BGXSS1
     +    (I),BGYSS1(I),BGZSS1(I), BGXSS2(I),BGYSS2(I),BGZSS2(I), NCHSS1
     +    (I),NCHSS2(I),IJCSS1(I),IJCSS2(I), PQSSA1(I,4),PQSSA2(I,4),
     +    PQSSB1(I,4),PQSSB2(I,4)
 1000 FORMAT(10X,4I5,10F9.2/10X,4I5,4F12.4)
C
C+++++++++++++++++++++++++++++     CHAIN 1:  QUARK-AQUARK    ++++++++++
          IFB1=IPSQ(IS1)
          IFB2=ITSAQ(IS2)
          IFB2=IABS(IFB2)+6
          DO 10 J=1,4
            POJ(J)=PQSSA1(I,J)
            PAT(J)=PQSSA2(I,J)
   10     CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,4,NEVT)
C--------------------------------------------------------------
            IHARLU=0
            QLUN=0.
            IF(IPSHOW.EQ.1)THEN
              POJPT=SQRT(POJ(2)**2+POJ(1)**2)
              PATPT=SQRT(PAT(1)**2+PAT(2)**2)
	      DO IIII=1,10
              IF(POJPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
              IF(PATPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
	      ENDDO
              QLUN=MIN(POJPT,PATPT)
              IF((QLUN.LT.2.5D0).OR.(AMCSS1(I).LT.5.D0))THEN
                QLUN=0.
                IHARLU=0
              ELSE 
                IHARLU=1
              ENDIF   
            ENDIF
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' SS q-aq ,IFB1,IFB2,',
     *	'INTSS1=IS1,INTSS2=IS2',
     *	IFB1,IFB2,INTSS1(I),INTSS2(I)
        WRITE (6,*)' projectile sea quark IFB1=',IFB1,
     *	' from IS1=',INTSS1(I)
        WRITE(6,*)' with IPSQ(IS1),XPSQ(IS1),IFROSP(IS1)',
     *	IPSQ(IS1),XPSQ(IS1),IFROSP(IS1)
      ENDIF
        DO 798 II=1,IXPV
	  IF(IFROSP(IS1).EQ.IFROVP(II))III=II
  798   CONTINUE	
      IF(IPCO.GE.1)THEN
        WRITE (6,*)' projectile III=',III
        WRITE(6,*)' corresp. XPVQ(i),XPVD(i),IPVQ(I),IPPV1(I),IPPV2(I)',
     *   XPVQ(III),XPVD(III),IPVQ(III),IPPV1(III),IPPV2(III)
      ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C+++++++++++++++++++++++++++ SS    CHAIN 1:  QUARK-AQUARK    ++++++++++
C-------------------------------------------------------------------    
C      IF(ICASAD.EQ.1.AND.IBPROJ.NE.0)THEN
       IF(ICASAD.EQ.1)THEN
         IF(RNDM(VV).LE.CASAXX)THEN
	   IF(RNDM(VVV).LE.0.5D0)THEN
	     ISCASA=IPSQ(IS1) 
	     IPVCAS=IPPV1(III)
	     IPSQ(IS1)=IPVCAS
	     IPPV1(III)=ISCASA
	     IFB1=IPSQ(IS1)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas SS1 q-aq 1 ,IFB1,IFB2,',
     *           'INTSS1=IS1,INTSS2=IS2,III',
     *           IFB1,IFB2,INTSS1(I),INTSS2(I),III
     *         ,'-----------------------------------------------------'
             ENDIF
	   ELSE
	     ISCASA=IPSQ(IS1) 
	     IPVCAS=IPPV2(III)
	     IPSQ(IS1)=IPVCAS
	     IPPV2(III)=ISCASA
	     IFB1=IPSQ(IS1)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas SS1 q-aq 2 ,IFB1,IFB2,',
     *           'INTSS1=IS1,INTSS2=IS2,III',
     *           IFB1,IFB2,INTSS1(I),INTSS2(I),III
     *         ,'-----------------------------------------------------'
             ENDIF
	   ENDIF
	 ENDIF
       ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C-------------------------------------------------------------------    
          CALL HADJET(NHAD,AMCSS1(I),POJ,PAT,GACSS1(I),BGXSS1(I), BGYSS1
     +    (I),BGZSS1(I),IFB1,IFB2,IFB3,IFB4, IJCSS1(I),IJCSS1(I),3,
     +    NCHSS1(I),1)
          ACOUSS=ACOUSS+1
            IHARLU=0
            QLUN=0.
C                                  ADD HADRONS/RESONANCES INTO
C                                  COMMON /ALLPAR/ STARTING AT NAUX
          NHKKAU=NHKK+1
          DO 20 J=1,NHAD
            EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
          IF (ABS(EHECC-HEF(J)).GT.0.001D0.AND.IBARF(J).NE.500) THEN
              WRITE(6,'(A,2I5,2E16.6)')
     +        ' HADRSS: CORRECT INCONSISTENT PARTICLE ENERGY ', NHKK,
     +        NREF(J), HEF(J),EHECC
            HEF(J)=EHECC
            ENDIF
          ANNSS=ANNSS+1
          EESS=EESS+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
C           NHKK=NHKK+1
          PTSS=PTSS+SQRT(PXF(J)**2+PYF(J)**2)
            IF (NHKK.EQ.NMXHKK) THEN
              WRITE (6,'(A,2I5)') ' HADRSS: NHKK.EQ NMXHKK',NHKK,NMXHKK
              RETURN
            ENDIF
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKSS(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
            IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030) NHKK,NREF(J), IDHKK
     +      (NHKK)
C	    WRITE(6,*)' First chain HADRSS'
            IF (IPHKK.GE.7) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK
     +      (NHKK),JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK
     +      (2,NHKK),(PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK
     +      =1,4)
   20     CONTINUE
   30     CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
          IF(NNNPJ.GE.1)THEN
            NNNPSO=NNNPS
            NNNPS=NNNPS+1
            NNNPSU=NNNPSO+NNNPJ
            DO 137 J=NNNPS,NNNPSU
              JJ=J-NNNPS+1
              IF(J.GT.40000.OR.JJ.GT.1000)THEN
C               WRITE(6,'(A,2I10)')' J.gt.40000.or.jj.gt.1000 ',J,JJ
                GO TO 137
              ENDIF
	      PXS(J)=PXJ(JJ)
	      PYS(J)=PYJ(JJ)
	      PZS(J)=PZJ(JJ)
	      HES(J)=HEJ(JJ)
  137      CONTINUE
            NNNPS=NNNPS+NNNPJ-1
          ENDIF
C
C++++++++++++++++++++++++++++++++   CHAIN 2:  AQUARK-QUARK   +++++++++
          IFB1=IPSAQ(IS1)
          IFB2=ITSQ(IS2)
          IFB1=IABS(IFB1)+6
          DO 40 J=1,4
            POJ(J)=PQSSB2(I,J)
            PAT(J)=PQSSB1(I,J)
   40     CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,4,NEVT)
            IHARLU=0
            QLUN=0.
            IF(IPSHOW.EQ.1)THEN
              POJPT=SQRT(POJ(2)**2+POJ(1)**2)
              PATPT=SQRT(PAT(1)**2+PAT(2)**2)
	      DO IIII=1,10
              IF(POJPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
              IF(PATPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
	      ENDDO
              QLUN=MIN(POJPT,PATPT)
              IF((QLUN.LT.2.5D0).OR.(AMCSS2(I).LT.5.D0))THEN
                QLUN=0.
                IHARLU=0
              ELSE 
                IHARLU=1
              ENDIF   
            ENDIF
C,,
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' SS aq-q ,IFB1,IFB2,',
     *	'INTSS1=IS1,INTSS2=IS2',
     *	IFB1,IFB2,INTSS1(I),INTSS2(I)
        WRITE (6,*)' target sea quark IFB2=',IFB2,
     *	' from IS2=',INTSS2(I)
        WRITE(6,*)' with ITSQ(IS2),XTSQ(IS2),IFROST(IS2)',
     *	ITSQ(IS2),XTSQ(IS2),IFROST(IS2)
      ENDIF
        DO 797 II=1,IXTV
	  IF(IFROST(IS2).EQ.IFROVT(II))III=II
  797   CONTINUE	
      IF(IPCO.GE.1)THEN
        WRITE (6,*)' projectile III=',III
        WRITE(6,*)' corresp. XTVQ(i),XTVD(i),ITVQ(I),ITTV1(I),ITTV2(I)',
     *   XTVQ(III),XTVD(III),ITVQ(III),ITTV1(III),ITTV2(III)
      ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C+++++++++++++++++++++++++++++ SS   CHAIN 2:  AQUARK-QUARK   +++++++++
C-------------------------------------------------------------------    
C      IF(ICASAD.EQ.1.AND.IBPROJ.NE.0)THEN
       IF(ICASAD.EQ.1)THEN
         IF(RNDM(VV).LE.CASAXX)THEN
	   IF(RNDM(VVV).LE.0.5D0)THEN
	     ISCASA=ITSQ(IS2) 
	     ITVCAS=ITTV1(III)
	     ITSQ(IS2)=ITVCAS
	     ITTV1(III)=ISCASA
	     IFB2=ITSQ(IS2)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas SS2 aq-q 1 ,IFB1,IFB2,',
     *           'INTSS1=IS1,INTSS2=IS2,III',
     *           IFB1,IFB2,INTSS1(I),INTSS2(I),III
     *          ,'-----------------------------------------------------'
             ENDIF
	   ELSE
	     ISCASA=ITSQ(IS2) 
	     ITVCAS=ITTV2(III)
	     ITSQ(IS2)=ITVCAS
	     ITTV2(III)=ISCASA
	     IFB2=ITSQ(IS2)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas SS2 aq-q 2 ,IFB1,IFB2,',
     *           'INTSS1=IS1,INTSS2=IS2,III',
     *           IFB1,IFB2,INTSS1(I),INTSS2(I),III
     *          ,'-----------------------------------------------------'
             ENDIF
	   ENDIF
	 ENDIF
       ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C-------------------------------------------------------------------    
          CALL HADJET(NHAD,AMCSS2(I),POJ,PAT,GACSS2(I),BGXSS2(I), BGYSS2
     +    (I),BGZSS2(I),IFB1,IFB2,IFB3,IFB4, IJCSS2(I),IJCSS2(I),3,
     +    NCHSS2(I),2)
            IHARLU=0
            QLUN=0.
C                                    ADD HADRONS/RESONANCES INTO
C                                    COMMON /ALLPAR/ STARTING AT NAUX
          NHKKAU=NHKK+1
          DO 50 J=1,NHAD
            EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
          IF (ABS(EHECC-HEF(J)).GT.0.001D0.AND.IBARF(J).NE.500) THEN
              WRITE(6,'(A,2I5,2E16.6)')
     +        ' HADRSS: CORRECT INCONSISTENT PARTICLE ENERGY ', NHKK,
     +        NREF(J), HEF(J),EHECC
            HEF(J)=EHECC
            ENDIF
          ANNSS=ANNSS+1
          EESS=EESS+HEF(J)
C                              PUT NN-CMS HADRONS INTO /HKKEVT/
C           NHKK=NHKK+1
          PTSS=PTSS+SQRT(PXF(J)**2+PYF(J)**2)
            IF (NHKK.EQ.NMXHKK) THEN
              WRITE (6,'(A,2I5)') ' HADRSS: NHKK.EQ NMXHKK',NHKK,NMXHKK
              RETURN
            ENDIF
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKSS(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
            IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030) NHKK,NREF(J), IDHKK
     +      (NHKK)
C	    WRITE(6,*)' Second chain HADRSS'
            IF (IPHKK.GE.7) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK
     +      (NHKK),JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK
     +      (2,NHKK),(PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK
     +      =1,4)
   50     CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
          IF(NNNPJ.GE.1)THEN
            NNNPSO=NNNPS
            NNNPS=NNNPS+1
            NNNPSU=NNNPSO+NNNPJ
            DO 187 J=NNNPS,NNNPSU
              JJ=J-NNNPS+1
              IF(J.GT.40000.OR.JJ.GT.1000)THEN
C               WRITE(6,'(A,2I10)')' J.gt.40000.or.jj.gt.1000 ',J,JJ
                GO TO 187
              ENDIF
	      PXS(J)=PXJ(JJ)
	      PYS(J)=PYJ(JJ)
	      PZS(J)=PZJ(JJ)
	      HES(J)=HEJ(JJ)
  187      CONTINUE
            NNNPS=NNNPS+NNNPJ-1
          ENDIF
        ENDIF
   60 CONTINUE
C
C--------------------------------------------------------------
C
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRVS J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,NREF(J),IDHKK(NHKK)  ',3I10)
 1040 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRVS
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C-------------------------
C
C                       HADRONIZE VALENCE-SEA CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C-------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,ABRVS.
      COMMON /ABRVS/ AMCVS1(248),AMCVS2(248),GACVS1(248),GACVS2(248),
     +BGXVS1(248),BGYVS1(248),BGZVS1(248), BGXVS2(248),BGYVS2(248),
     +BGZVS2(248), NCHVS1(248),NCHVS2(248),IJCVS1(248),IJCVS2(248),
     +PQVSA1(248,4),PQVSA2(248,4), PQVSB1(248,4),PQVSB2(248,4)
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEND.
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      COMMON /CASADI/CASAXX,ICASAD
C---------------------
      DIMENSION POJ(4),PAT(4)
C-----------------------------------------------------------------------
      DO 50 I=1,NVS
C-----------------------drop recombined chain pairs
        IF(NCHVS1(I).EQ.99.AND.NCHVS2(I).EQ.99) GO TO 50
        IS1=INTVS1(I)
        IS2=INTVS2(I)
C
        IF (IPCO.GE.6) WRITE (6,1010) IPVQ(IS1),IPPV1(IS1),IPPV2(IS1),
     +  ITSQ(IS2),ITSAQ(IS2), AMCVS1(I),AMCVS2(I),GACVS1(I),GACVS2(I),
     +  BGXVS1(I),BGYVS1(I),BGZVS1(I), BGXVS2(I),BGYVS2(I),BGZVS2(I),
     +  NCHVS1(I),NCHVS2(I),IJCVS1(I),IJCVS2(I), PQVSA1(I,4),PQVSA2
     +  (I,4),PQVSB1(I,4),PQVSB2(I,4)
C
C+++++++++++++++++++++++++++++     CHAIN 1:  QUARK-AQUARK    ++++++++++
        IFB1=IPVQ(IS1)
        IFB2=ITSAQ(IS2)
        IFB2=IABS(IFB2)+6
        DO 10 J=1,4
          POJ(J)=PQVSA1(I,J)
          PAT(J)=PQVSA2(I,J)
   10   CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,2,NEVT)
C       IF((NCHVS1(I).NE.0.OR.NCHVS2(I).NE.0).AND.IP.NE.1)
C    &  CALL SAPTRE(AMCVS2(I),GACVS2(I),BGXVS2(I),BGYVS2(I),BGZVS2(I),
C    &              AMCVS1(I),GACVS1(I),BGXVS1(I),BGYVS1(I),BGZVS1(I))
C-----------------------------------------------------------------
C                                    POJ,PAT EXCHANGED J.R.15.2.90
C                                            RECHANGED HJM 13/2/91
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' VS q-aq ,IFB1,IFB2,',
     *	'INTVS1=IS1,INTVS2=IS2,JIPPX,JITTX',
     *	IFB1,IFB2,INTVS1(I),INTVS2(I),JIPPX,JITTX
      ENDIF
        CALL HADJET(NHAD,AMCVS1(I),POJ,PAT,GACVS1(I),BGXVS1(I), BGYVS1
     +  (I),BGZVS1(I),IFB1,IFB2,IFB3,IFB4, IJCVS1(I),IJCVS1(I),3,NCHVS1
     +  (I),5)
        ACOUVS=ACOUVS+1
C                                  ADD HADRONS/RESONANCES INTO
C                                  COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001D0.AND.IBARF(J).NE.500)THEN
            WRITE(6,'(A,2I5,2E16.6)')
     +      ' HADRVS: CORRECT INCONSISTENT PARTICLE ENERGY ', NHKK,NREF
     +      (J), HEF(J),EHECC
          HEF(J)=EHECC
          ENDIF
          ANNVS=ANNVS+1
          EEVS=EEVS+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
C         NHKK=NHKK+1
          PTVS=PTVS+SQRT(PXF(J)**2+PYF(J)**2)
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5)') ' HADRVS: NHKK.EQ.NMXHKK',NHKK,NMXHKK
            RETURN
          ENDIF
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKVS(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030) NHKK, IDHKK(NHKK)
C	  WRITE(6,*)' Firt chain HADRVS'
          IF (IPHKK.GE.7) WRITE(6,1000)NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C
C++++++++++++++++++++++++++++++    CHAIN 2:  DIQUARK-QUARK   +++++++++++
        IFB1=IPPV1(IS1)
        IFB2=IPPV2(IS1)
        IFB3=ITSQ(IS2)
        DO 30 J=1,4
          POJ(J)=PQVSB2(I,J)
          PAT(J)=PQVSB1(I,J)
   30   CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,2,NEVT)
C                                    POJ,PAT EXCHANGED J.R.15.2.90
C                                            RECHANGED HJM 21/2/91
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain     
C               Projectile Nr ippp= IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
       IPPP = IFROVP(INTVS1(I))
       JIPP=JSSHS(IPPP)
C	IF(NCHVS2(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRVS: I,IPPP,JIPP ',
C    *                     I,IPPP,JIPP
C	ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' VS qq-q ,IFB1,IFB2,IFB3,',
     *	'INTVS1=IS1,INTVS2=IS2,JIPP,JITTX',
     *	IFB1,IFB2,IFB3,INTVS1(I),INTVS2(I),JIPP,JITTX
      ENDIF
C------------------------------------------------------------------- 
C-------------------------------------------------------------------    
	IF((NCHVS2(I).NE.0))THEN
        CALL HADJET(NHAD,AMCVS2(I),POJ,PAT,GACVS2(I),BGXVS2(I), BGYVS2
     +  (I),BGZVS2(I),IFB1,IFB2,IFB3,IFB4, IJCVS2(I),IJCVS2(I),6,NCHVS2
     +  (I),6)
	ENDIF
	AACK=FLOAT(ICK6)/FLOAT(ICK6+IHAD6+1)
 	IF((NCHVS2(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JIPP)*PDBSE+ ZSEAWU*PDBSEU
 	  IF(IPCO.GE.1)WRITE(6,*)'HADJSE JIPP,RSEACK,PDBSE 4 dpmnuc3',
     +    JIPP,RSEACK,PDBSE
          IREJSS=5
	  IF(RNDM(V).LE.RSEACK)THEN
	  IREJSS=2
	  IF(AMCVS2(I).GT.2.3D0)THEN
	    IREJSS=0
            CALL HADJSE(NHAD,AMCVS2(I),POJ,PAT,GACVS2(I),BGXVS2(I),
     *	    BGYVS2
     +      (I),BGZVS2(I),IFB1,IFB2,IFB3,IFB4, IJCVS2(I),IJCVS2(I),6,
     *      NCHVS2
     +      (I),6,IREJSS,IISSQQ)
 	    IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *	    'RSEACK,IREJSS 4 dpmnuc3',
     +      JIPP,RSEACK,IREJSS
          ENDIF
	  IF(IREJSS.GE.1)THEN
	    IF(IREJSS.EQ.1)IREJSE=IREJSE+1
	    IF(IREJSS.EQ.3)IREJS3=IREJS3+1
	    IF(IREJSS.EQ.2)IREJS0=IREJS0+1
            CALL HADJET(NHAD,AMCVS2(I),POJ,PAT,GACVS2(I),
     *      BGXVS2(I), BGYVS2
     +      (I),BGZVS2(I),IFB1,IFB2,IFB3,IFB4, IJCVS2(I),
     *      IJCVS2(I),6,NCHVS2
     +      (I),6)
	    IHAD6=IHAD6+1
	  ENDIF
	  IF(IREJSS.EQ.0)THEN
	    IF(IISSQQ.EQ.3)THEN
	      ISE63=ISE63+1
	    ELSE
	      ISE6=ISE6+1
	    ENDIF
	  ENDIF  
        ELSEIF((IJPOCK.EQ.1).AND.
     *      (AACK.LE.PDBCK))THEN
	IREJ=0
        CALL HADJCK(NHAD,AMCVS2(I),POJ,PAT,GACVS2(I),BGXVS2(I), BGYVS2
     +  (I),BGZVS2(I),IFB1,IFB2,IFB3,IFB4, IJCVS2(I),IJCVS2(I),6,NCHVS2
     +  (I),6,IREJ)
	IF(IREJ.EQ.1)THEN
	IREJCK=IREJCK+1
        CALL HADJET(NHAD,AMCVS2(I),POJ,PAT,GACVS2(I),BGXVS2(I), BGYVS2
     +  (I),BGZVS2(I),IFB1,IFB2,IFB3,IFB4, IJCVS2(I),IJCVS2(I),6,NCHVS2
     +  (I),6)
	IHAD6=IHAD6+1
	ENDIF
	IF(IREJ.EQ.0)ICK6=ICK6+1
	ELSE
        CALL HADJET(NHAD,AMCVS2(I),POJ,PAT,GACVS2(I),BGXVS2(I), BGYVS2
     +  (I),BGZVS2(I),IFB1,IFB2,IFB3,IFB4, IJCVS2(I),IJCVS2(I),6,NCHVS2
     +  (I),6)
	IHAD6=IHAD6+1
	ENDIF
	ENDIF
C------------------------------------------------------------------
C------------------------------------------------------------------
C                                  ADD HADRONS/RESONANCES INTO
C                                  COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001D0.AND.IBARF(J).NE.500) THEN
            WRITE(6,'(A,2I5,2E16.6)')
     +      ' HADRVS: CORRECT INCONSISTENT PARTICLE ENERGY ', NHKK,NREF
     +      (J), HEF(J),EHECC
          HEF(J)=EHECC
          ENDIF
          ANNVS=ANNVS+1
          EEVS=EEVS+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
C         NHKK=NHKK+1
          PTVS=PTVS+SQRT(PXF(J)**2+PYF(J)**2)
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5)') ' HADRVS: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKVS(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
C         WRITE(6,*)' HKKFIL: NHKKAU,IORMO(J) ',ISTIST, NHKKAU,IORMO(J)
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF(IREJSS.LT.0)THEN 
 	  WRITE(6,*)' Second chain HADRVS'
          IF (IPHKK.GE.0) WRITE(6,1000) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
          ENDIF
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C
      RETURN
 1000 FORMAT (I6,I4,5I6,9E10.2)
 1010 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
 1020 FORMAT (' HADRVS J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADJET(NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,
     +IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  HADJET DOES ALL THE NECESSARY ROTATIONS AND LORENTZ TRANSFORMS AND
C                                               CALL CALBAM (BAMJET)
C
C         NHAD = NUMBER OF HADRONS CREATED (OUTPUT) = IHAD (CALBAM)
C******** PRODUCED PARTICLES IN COMMON /CMSRES/
C NOTE:  NOW IN /FINPAR/      HJM 21/06/90
C         AMCH = INVARIANT MASS OF JET (INPUT)
C         PPR  = 4-MOMENTUM OF FORWARD GOING PARTON (PROJECTILE)(INPUT)
C         PTA  = 4-MOMENTUM OF BACKWARD GOING PARTON (TARGET)(INPUT)
C         GAM,BGX,BGY,BGZ = LORENTZ PARAMETERS OF JET CMS RELATIVE TO
C                                              COLLISION CMS (INPUT)
C
C--------------------------------------------------------------------
C    CALBAM(NNCH,I1,I2,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM,IHAD)
C    SAMPLING OF Q-AQ, Q-QQ, QQ-AQQ CHAINS
C       USING BAMJET(IHAD,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM)-----FOR NNCH=0
C       OR    PARJET(IHAD,ICH1=I1 OR I2)------FOR NNCH=-1 OR +1
C-------------------------------------------------------------------
C   IHAD  :  NUMBER OF PRODUCED PARTICLES
C   NNCH  :  CALL BAMJET FOR NNCH=0
C            CALL PARJET FOR NNCH=+1 ICH1=I1
C                        FOR NNCH=-1 ICH1=I2
C            jet not existing for NNCH=+/-99, i.e. IHAD=0
C   PRODUCED PARTICLES IN CHAIN REST FRAME ARE IN COMMON /FINPAR/
C   AMCH  :  INVARIANT MASS OF CHAIN (BAMJET)
C
C   NOBAM :  = 3  QUARK-ANTIQUARK JET   QUARK FLAVORS : IFB1,IFB2
C                 OR ANTIQUARK-QUARK JET                  IN ANY ORDER
C
C            = 4  QUARK-DIQUARK JET, FLAVORS : QU : IFB1, DIQU :IFB2,IFB
C                 OR ANTIQUARK-ANTIDIQUARK JET
C
C
C            = 5  DIQUARK-ANTIDIQUARK JET
C                 OR ANTIDIQUARK-DIQUARK JET
C                     FLAVORS :  DIQU : IFB1,IFB2, ANTIDIQU : IFB3,IFB4
C                                IN ANY ORDER
C
C            = 6  DIQUARK-QUARK JET, FLAVORS : DIQU  : IFB1,IFB2 QU: IFB
C                 OR ANTIDIQUARK-ANTIQUARK JET
C
C   IFBI  : FLAVORS : 1,2,3,4 = U,D,S,C    7,8,9,10 = AU,AD,AS,AC
C
C   I1,I2 : NUMBER LABEL OF A HADRON CREATED BY PARJET
C
C   NORMALLY IN BAMJET THE QUARKS MOVE FORWARD  (POSITIVE Z-DIRECTION)
C                      THE QUARK FLAVORS ARE FIRST GIVEN
C   CALBAM ALLOWS EITHER THE QUARK OR ANTIQUARK (DIQU) TO MOVE FORWARD
C                      THE FORWARD GOING FLAVORS ARE GIVEN FIRST
C
C =====================================================================
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
*--------------------------------------------------------------------
*-------------------------------------------------------------------
      COMMON /JSPART/PXP(1000),PYP(1000),PZP(1000),HEPP(1000),NNNP
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
************************************************************************
************************************************************************
      COMMON/IFRAGM/IFRAG
      DIMENSION PPR(4),PTA(4),PPRJ(4),PTAJ(4)
      LOGICAL LTESHA
      PARAMETER (TINY=1.D-10)
      DATA ICHECO/0/
      DATA ICHECA/0/
C     IPCO=6
C----------------------------------------------------------------------
C
C  CHECK HADJET ENERGY CONSERVATION PPR(4)+PTA(4)  EQ  EHAD
C                            TRANSFORM PROJECTILE INTO JET REST FRAME
C     IF(NOBAM.EQ.4.OR.NOBAM.EQ.6) IPCO=6
      IF(IPCO.GE.6) THEN
        WRITE(6,1010) GAM,BGX,BGY,BGZ,PPR,PPRJ
        WRITE(6,1000) NHAD,AMCH,PTA, IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,
     +  NNCH,NORIG
 1000 FORMAT(10X,I10,5F10.3/10X,9I10)
      ENDIF
      IF(ABS(NNCH).EQ.99) THEN
        NHAD=0
C       IPCO=0
        RETURN
      ENDIF
C
      CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PPR(1),PPR(2),PPR(3),PPR(4),PPRTOT,
     +PPRJ(1),PPRJ(2),PPRJ(3),PPRJ(4))
      CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PTA(1),PTA(2),PTA(3),PTA(4),PTATOT,
     +PTAJ(1),PTAJ(2),PTAJ(3),PTAJ(4))
C
      IF(IPCO.GE.3) WRITE(6,1010)GAM,BGX,BGY,BGZ,PPR,PPRJ,PTA,PTAJ
 1010 FORMAT(' HADJET: GAM,BGX,BGY,BGZ,PPR(4),PPRJ(4) ',4F15.5/8F15.5/ 8
     +F15.5)
C                            WORK OUT COD,SID,COF,SIF OF PROJECTILE
C                                                     IN JET FRAME
      IF(PPRTOT.LT.TINY)PPRTOT=TINY
      COD= PPRJ(3)/PPRTOT
      IF(COD.GE.1.D0)COD=0.999999999999
      IF(COD.LE.-1.D0)COD=-0.999999999999
      SID=SQRT(ABS((1.D0-COD)*(1.D0+COD)))
      COF=1.
      SIF=0.
      IF((ABS(PPRJ(1)).GT.0.D0).OR.(ABS(PPRJ(2)).GT.0.D0))THEN
      IF(PPRTOT*SID.GT.1.D-9) THEN
        COF=PPRJ(1)/(SID*PPRTOT)
        SIF=PPRJ(2)/(SID*PPRTOT)
        ANORF=SQRT(ABS(COF*COF+SIF*SIF))
        COF=COF/ANORF
        SIF=SIF/ANORF
      ENDIF
      ENDIF
      IF (IPCO.GE.6) WRITE(6,1020)COD,SID,COF,SIF
 1020 FORMAT(' COD,SID,COF,SIF ',4F15.8)
C                            SAMPLE JET IN JET CMS
      CALL CALBAM(NNCH,I1,I2,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM,IHAD)
C     IF(IHAD.EQ.1)THEN
C      IPRI=1
C      IPCO=3
C     ELSE
C      IPRI=0
C      IPCO=-1
C     ENDIF
C                            NOW WE HAVE IHAD PARTICLES/RESONANCES
C                                             IN COMMON /FINPAR/
C CHECK CALBAM ENERGY CONSERVATION / jet cms
      ECAL=0.
      PXCAL=0.
      PYCAL=0.
      PZCAL=0.
      LTESHA=.FALSE.
      DO 10 I=1,IHAD
        IF(IBARF(I).EQ.500)GO TO 1011
        PXCAL=PXCAL + PXF(I)
        PYCAL=PYCAL + PYF(I)
        PZCAL=PZCAL + PZF(I)
        IF(IFRAG.EQ.0)THEN
        EHECC=SQRT(ABS(PXF(I)**2+PYF(I)**2+PZF(I)**2+AMF(I)**2))
      IF (ABS(EHECC-HEF(I)).GT.0.0001D0) THEN
        IF(IPRI.GE.1) WRITE(6,'(2A/A/3I5,3E16.6)')
     +     ' HADJET / AFTER CALBAM:',
     +     '  CORRECT INCONSISTENT ENERGY IN JET CMS',
     +            '  I, IHAD,NREF(I), HEF(I),EHECC, AMF(I)',
     *            I,IHAD,NREF(I), HEF(I),EHECC, AMF(I)
        HEF(I)=EHECC
        LTESHA=.TRUE.
        ENDIF
        ENDIF
      ECAL=ECAL + HEF(I)
 1011 CONTINUE
   10 CONTINUE
      IF (ABS(ECAL-AMCH).GT.0.005D0) LTESHA=.TRUE.
      IF (LTESHA) THEN
        ICHECA=ICHECA+1
      IF (ABS(ECAL-AMCH).GT.0.005D0) THEN
        IF(ICHECA.LE.-10)WRITE(6,'(A/10I4)')
     +  ' HADJET/1:ICHECA,IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG',
     +     ICHECA,IFB1,
     +  IFB2,IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG
        IF(ICHECA.LE.-10)WRITE(6,1030) AMCH,ECAL,PXCAL,PYCAL,PZCAL
 1030 FORMAT(' CALBAM E. CHECK (5 MeV) AMCH,ECAL,PXCAL,PYCAL,PZCAL=',
     +    /5E20.8)
      LTESHA=.FALSE.
      ENDIF
      ENDIF
      IF (IPCO.GE.3)THEN
        DO 20 I=1,IHAD
        WRITE(6,1040)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
     +    IBARF(I),NREF(I),ANF(I)
 1040 FORMAT(' JET SYSTEM ',I5,5F12.4,3I5,A10)
   20   CONTINUE
      ENDIF
C     CALL DECAY(IHAD,2)
C     NHAD=IHAD
C CHECK CALBAM+DECAY ENERGY CONSERVATION
C     ECAL=0.
C     PXCAL=0.
C     PYCAL=0.
C     PZCAL=0.
C     DO 1204 I=1,IHAD
C       ECAL=ECAL+HEF(I)
C       PXCAL=PXCAL+PXF(I)
C       PYCAL=PYCAL+PYF(I)
C       PZCAL=PZCAL+PZF(I)
C1204 CONTINUE
C     IOUCHA=3
C     IF (ABS(ECAL-AMCH)/AMCH.GT.0.00001D0)IOUCHA=1
C     IF (IPCO.GE.IOUCHA)WRITE(6,1203)AMCH,ECAL,PXCAL,PYCAL,PZCAL
C1203 FORMAT(' CALBAM+DECAY ENERGY CHECK  AMCH,ECAL,PXCAL,PYCAL,PZCAL '
C    *                                       /5E20.8)
C     IF (IPCO.GE.3)THEN
C       DO 143 I=1,IHAD
C         WRITE(6,144)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I),
C    *                  ICHF(I),IBARF(I),NREF(I),ANF(I)
C 144     FORMAT(' JET SYSTEM DECAY ',I5,5F12.4,3I5,A10)
C 143   CONTINUE
C     ENDIF
C                            ROTATE JET BY COD,SID,COF,SIF
      PXCAL=0.
      PYCAL=0.
      PZCAL=0.
      LTESHA=.FALSE.
      DO 30 I=1,IHAD
      PHEC2=PXF(I)**2+PYF(I)**2+PZF(I)**2
        CALL DTRANS(PXF(I),PYF(I),PZF(I),COD,SID,COF,SIF,XX,YY,ZZ)
      PROTA2=XX**2 + YY**2 + ZZ**2
        PXF(I)=XX
        PYF(I)=YY
        PZF(I)=ZZ
      PXCAL=PXCAL + PXF(I)
      PYCAL=PYCAL + PYF(I)
      PZCAL=PZCAL + PZF(I)
C       EHECC=SQRT(ABS(PXF(I)**2+PYF(I)**2+PZF(I)**2+AMF(I)**2))
      IF(ABS(PHEC2-PROTA2).GT.0.0001D0) THEN
        WRITE(6,'(2A/3I5,3E16.6)')
     &            ' HADJET: INCONSISTENT MOMENTUM AFTER TRANS',
     *            '  I, IHAD,NREF(I), PHEC2,PROTA2, AMF(I)',
     *            I,IHAD,NREF(I), PHEC2,PROTA2, AMF(I)
C         HEF(I)=EHECC
        LTESHA=.TRUE.
        ENDIF
   30 CONTINUE
      IF (LTESHA) THEN
      WRITE(6,'(A/9I4)')
     +  ' HADJET/2: IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG', IFB1,
     +  IFB2,IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG
      WRITE(6,1031) PXCAL,PYCAL,PZCAL
 1031   FORMAT(' CALBAM ENERGY CHECK/2:  PXCAL,PYCAL,PZCAL='/3E20.8)
      LTESHA=.FALSE.
      ENDIF
      IF (IPCO.GE.3)THEN
        DO 40 I=1,IHAD
        WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
     +    IBARF(I),NREF(I),ANF(I)
 1050 FORMAT(' ROTATET JET SYSTEM ',I5,5F12.4,3I5,A10)
   40   CONTINUE
      ENDIF
************************************************************************
************************************************************************
C                           Rotate partons
      NNNNP=NNNP
      IF(NNNP.GT.1000)NNNNP=1000
      DO 1105 I=1,NNNNP
        CALL DTRANS(PXP(I),PYP(I),PZP(I),COD,SID,COF,SIF,XX,YY,ZZ)
        PXP(I)=XX
        PYP(I)=YY
        PZP(I)=ZZ
 1105 CONTINUE
************************************************************************
************************************************************************
C                           TRANSFORM THIS JET BACK INTO CMS
C************************                  IN COMMON BLOCK/CMSRES/
C                             LORTMO USES /FINPAR/ ONLY !!!!!
C     CALL LORTRA(IHAD,1,GAM,BGX,BGY,BGZ)
      CALL LORTMO(IHAD,GAM,BGX,BGY,BGZ)
      NHAD=IHAD
C
      IF (IPCO.GE.3)THEN
        DO 50 I=1,IHAD
        WRITE(6,1060) I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
     +    IBARF(I),NREF(I),ANF(I)
 1060 FORMAT(' CMS SYSTEM ',I5,5F12.4,3I5,A10)
   50   CONTINUE
      ENDIF
C  HADJET ENERGY CONSERVATION TEST
C  AND CONSISTENCY TEST OF PARTICLE 4-MOMENTUM
      LTESHA=.FALSE.
      EHAD=0.
      DO 60 I=1,IHAD
      IF(IBARF(I).EQ.500)GO TO 6060
      EHAD=EHAD+HEF(I)
        EHECC=SQRT(ABS(PXF(I)**2+PYF(I)**2+PZF(I)**2+AMF(I)**2))
      IF (ABS(EHECC-HEF(I)).GT.0.001D0) THEN
        IF(ABS(EHECC-HEF(I)).GT.0.1D0)WRITE(6,'(2A/4I5,3E16.6)')
     &            ' HADJET: CORRECT INCONSISTENT ENERGY AFTER LORTRA',
     *            '  NORIG, I, IHAD,NREF(I), HEF(I),EHECC, AMF(I)',
     *            NORIG, I,IHAD,NREF(I), HEF(I),EHECC, AMF(I)
        HEF(I)=EHECC
C         LTESHA=.TRUE.
        ENDIF
 6060 CONTINUE
   60 CONTINUE
************************************************************************
************************************************************************
C                           Transform partons
      NNNNP=NNNP
      IF(NNNP.GT.1000)NNNNP=1000
      NNNPJ=NNNNP
      CALL LORTRP(NNNNP,1,GAM,BGX,BGY,BGZ)
************************************************************************
************************************************************************
C     IOUCHA=3
c     EEIN=PPR(4)+PTA(4)
c     PXIN=PPR(1)+PTA(1)
c     PYIN=PPR(2)+PTA(2)
c     PZIN=PPR(3)+PTA(3)
C     PXIN=BGX*AMCH
C     PYIN=BGY*AMCH
C     PZIN=BGZ*AMCH
      EEIN=GAM*AMCH
      IF (ABS(EEIN-EHAD).GT.0.005D0) THEN
        ICHECO=ICHECO+1
      IF (ABS(EEIN-EHAD).GT.0.005D0) THEN
	IF(ICHECO.LT.-10)THEN
        WRITE(6,'(A/10I5)')
     +  ' HADJET/3:ICHECO,IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG', 
     +    ICHECO,IFB1,
     +  IFB2,IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG
      WRITE (6,1070) EEIN,EHAD,AMCH,GAM,BGX,BGY,BGZ
 1070 FORMAT(' HADJET ENERGY CHECK (5 MeV) EEIN,EHAD,AMCH',3E20.8/
     +  20X,' GAM,BGX,BGY,BGZ ',4E20.8)
c       WRITE(6,1010)GAM,BGX,BGY,BGZ,PPR,PPRJ
	ENDIF
      ENDIF
      ENDIF
C     IPCO=0
      RETURN
      END

************************************************************************
************************************************************************
*
      SUBROUTINE LORTRP(N,NAUX,GAM,BGX,BGY,BGZ)
*
*     LORENTZ TRANSFORMATION OF  N PARTICLES IN  JSPART  TO BE
*     STORED IN  JSPAR  STARTING AT NAUX
*
*********************************************************************
*
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C     impl. mxnupa after KNO cut solved 3.92
      PARAMETER (MXNUPA=2500)
      COMMON /JSPART/PXP(1000),PYP(1000),PZP(1000),HEPP(1000),NNNP
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
*          CHANGED JUNE 1,1987
       PARAMETER (ONE=1.D0)
       DATA IFIRST/0/
       DATA NUM/0/
       IFIRST=IFIRST+1
       NUM=NUM+1
      PXSM=0.0
      PYSM=0.0
      PZSM=0.0
      ESUM=0.
      PXSC=0.0
      PYSC=0.0
      PZSC=0.0
      ESMC=0.0
*           END OF CHANGE
      DO 1  I=1,N
      J = NAUX + I - 1
      PXSM=PXSM+PXP(I)
      PYSM=PYSM+PYP(I)
      PZSM=PZSM+PZP(I)
      ESUM=ESUM+HEPP(I)
      CALL DALTRA(GAM,BGX,BGY,BGZ,PXP(I),PYP(I),PZP(I),HEPP(I),
     *PPA,PXJ(J),PYJ(J),PZJ(J),HEJ(J))
      PXSC=PXSC+PXJ(J)
      PYSC=PYSC+PYJ(J)
      PZSC=PZSC+PZJ(J)
      ESMC=ESMC+HEJ(J)
1     CONTINUE
*     PXSM,ETC,ARE SUMS FOR BAMJET FRAGMENTS IN JET CMS
      CALL DALTRA(GAM,BGX,BGY,BGZ,PXSM,PYSM,PZSM,ESUM,
     *PPA,PXSM,PYSM,PZSM,ESUM)
*     PXSC,ETC,ARE SUMS FOR BAMJET FRAGMENTS IN PROJ,TARGET CMS
 
      PXDIF=PXSM-PXSC
      PYDIF=PYSM-PYSC
      PZDIF=PZSM-PZSC
      EDIF=ESUM-ESMC
      DIFFL=PXDIF+PYDIF+PZDIF+EDIF
      IF(DIFFL.GE.1.D-2*ONE)
     1WRITE(6,2)NUM,PXDIF,PYDIF,PZDIF,EDIF,PXSM,PXSC,
C     WRITE(6,2)NUM,PXDIF,PYDIF,PZDIF,EDIF,PXSM,PXSC,
     1PYSM,PYSC,PZSM,PZSC,ESUM,ESMC
 2    FORMAT(' ',2X,'LORTRA:NUM=',I5,2X,'PXDIF=',1PE15.6,2X,'PYDIF=',
     21PE15.6,2X,'PZDIF=',1PE15.6,2X,'EDIF=',1PE15.6/2X,'PXSM=',1PE15.6,
     32X,'PXSC=',1PE15.6,2X,'PYSM=',1PE15.6,2X,'PYSC=',1PE15.6/2X,'PZSM'
     4,1PE15.6,2X,'PZSC=',1PE15.6,2X,'ESUM=',1PE15.6,2X,'ESMC=',1PE15.6/
     52X,'LORTRA DIFFERENCES DUE TO ALTRA'/)
      RETURN
      END
*
************************************************************************
************************************************************************
*-- Author :
      SUBROUTINE COBCMA(IF1,IF2,IF3,IJNCH,NNCH,IREJ,AMCH,AMCHN,IKET)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  REPLACE SMALL MASS BARYON CHAINS (AMCH)
C  BY OCTETT OR DECUPLETT BARYONS
C
C                       HERE ONLY THE CHAIN MASS IS CHANGED
C                      (AMCHN) BUT NO CORRECTION OF KINEMATICS!
C
C  MASS CORRECTED FOR NNCH.NE.0
C
C  IREJ=1: CHAIN GENERATION NOT ALLOWED BECAUSE OF TOO SMALL MASS
C          START FROM THE BEGINNING IN HAEVT
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEND.
C----------------
      CALL DBKLAS(IF1,IF2,IF3,IB8,IBB10)
C
      IF (IPEV.GE.2)WRITE(6,1000)IF1,IF2,IF3,IB8,IBB10
 1000 FORMAT (' COBCMA: IPQ,ITTQ1,ITTQ2,IB8,IBB10 ',5I5)
C
      AM81=AAM(IB8)
      AM101=AAM(IBB10)
      AM8(IKET)=AM81
      AM10(IKET)=AM101
      IB88(IKET)=IB8
      IB1010(IKET)=IBB10
      NNCH=0
      IJNCH=0
      IREJ=0
      AMFF1=AM101+0.3
C
C                                    j.r.10.5.93
C     IF(AMCH.LT.AMFF1) THEN
C       IREJ=1
C       RETURN
C     ENDIF
C                                     -------------
      IF(AMCH.LT.AM81) THEN
        IREJ=1
      ELSEIF (AMCH.LT.AM101)THEN
C                                PRODUCE OKTETT BARYON
C                                 CORRECT KINEMATICS
        IJNCH=IB8
        NNCH=-1
        AMCHN=AM81
      ELSEIF(AMCH.LT.AMFF1) THEN
C                                 PRODUCE DECUPLETT BARYON
C                                 CORRECT KINEMATICS
        AMCHN=AM101
        IJNCH=IBB10
        NNCH=1
      ELSE
        AMCHN=AMCH
      ENDIF
C                                 NO CORRECTIONS BUT DO  CHAIN 2
      IF(IPEV.GE.2) THEN
        WRITE(6,1010) AMCH,AMCHN,AM81,AM101
        WRITE(6,1020) IF1,IF2,IF3,IB8,IBB10,IJNCH,NNCH,IREJ
 1010 FORMAT(' COBCMA: AMCH,AMCHN,AM81,AM101', 4F13.4)
 1020 FORMAT(' COBCMA: IF1,IF2,IF3,IB8,IBB10,IJNCH,NNCH,IREJ',8I4)
      ENDIF
      RETURN
      END
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE COMCMA(IFQ,IFAQ,IJNCH,NNCH,IREJ,AMCH,AMCHN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  REPLACE SMALL MASS MESON CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C
C                       HERE ONLY THE CHAIN MASS IS CHANGED
C                      (AMCHN) BUT NO CORRECTION OF KINEMATICS!
C
C
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
C------------------------
      IIFAQ=IABS(IFAQ)
      IFPS=IMPS(IIFAQ,IFQ)
      IFV=IMVE(IIFAQ,IFQ)
      IF (IPEV.GE.2)WRITE (6,1000)IIFAQ,IFQ,IFPS,IFV
 1000 FORMAT (' COMCMA',5X,' IIPPAQ,ITQ,IFPS,IFV ',4I5)
      AMPS=AAM(IFPS)
      AMV=AAM(IFV)
      NNCH=0
      IJNCH=0
      IREJ=0
      AMFF=AMV+0.3
      IF(IPEV.GE.2) WRITE(6,1010) AMCH,AMPS,AMV,IFPS,IFV
 1010 FORMAT(' AMCH,AMPS,AMV,IFPS,IFV ',3F12.4,2I10)
C                                          j.r.10.5.93
C     IF(AMCH.LT.AMFF) THEN
C       IREJ=1
C       RETURN
C     ENDIF
C                                          ------------
C
      IF(AMCH.LT.AMPS) THEN
        IREJ=1
        RETURN
      ENDIF
C
      IF (AMCH.LT.AMV) THEN
C                                PRODUCE PSEUDO SCALAR
        IJNCH=IFPS
        NNCH=-1
        AMCHN=AMPS
      ELSEIF(AMCH.LT.AMFF) THEN
C                                 PRODUCE VECTOR MESON
        IJNCH=IFV
        NNCH=1
        AMCHN=AMV
      ELSE
        AMCHN=AMCH
      ENDIF
      IF(IPEV.GE.2) THEN
        WRITE(6,1030) AMCH,AMCHN,AMPS,AMV
        WRITE(6,1020) IFQ,IFAQ,IFPS,IFV,IJNCH,NNCH,IREJ
 1030 FORMAT(' COMCMA: AMCH,AMCHN,AMPS,AMV', 4F13.4)
 1020 FORMAT(' COMCMA: IFQ,IFAQ,IFPS,IFV,IJNCH,NNCH,IREJ',8I4)
      ENDIF
C
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C   17/10/89 910191458  MEMBER NAME  MCOMCM2  (KK89.S)      F77
      SUBROUTINE COMCM2(IQ1,IQ2,IAQ1,IAQ2,NNCH,IREJ,AMCH)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
 
C--------------------------------------------------------------------
C  (QQ)-(AQ AQ) CHAIN:
C                      CHECK QUANTUM NUMBERS AND
C                      CORRECT MASS IF NECESSARY
C             REJECT IF THERE IS NO CORRESPONDING PARTICLE
C                    OR TOO LOW MASS
C--------------------------------------------------------------------
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEND.
C--------------------------
      IREJ=0
      IIAQ1=-IAQ1
      IIAQ2=-IAQ2
      IF (IIAQ1.EQ.IQ1)                                         GO TO 10
      IF (IIAQ1.EQ.IQ2)                                         GO TO 20
      IF (IIAQ2.EQ.IQ1)                                         GO TO 30
      IF (IIAQ2.EQ.IQ2)                                         GO TO 40
C                                  REJECTION: NO CANCELLATION OF
C                                             ANY (Q-AQ) PAIR
      IREJ=1
      IF(IPEV.GE.3) THEN
        WRITE(6,'(A/5X,4I5,1PE13.5)')
     +  ' KKEVVV/COMCM2 (QU. NUMBERS): IQ1, IQ2, IAQ1, IAQ2, AMCH', IQ1,
     +  IQ2, IAQ1, IAQ2, AMCH
      ENDIF
      RETURN
C
   10 CONTINUE
C     IFPS=IMPS(IIAQ2,IQ2)
C     IFV =IMVE(IIAQ2,IQ2)
                                                                GO TO 50
   20 CONTINUE
C     IFPS=IMPS(IIAQ2,IQ1)
C     IFV =IMVE(IIAQ2,IQ1)
                                                                GO TO 50
   30 CONTINUE
C     IFPS=IMPS(IIAQ1,IQ2)
C     IFV =IMVE(IIAQ1,IQ2)
                                                                GO TO 50
   40 CONTINUE
C     IFPS=IMPS(IIAQ1,IQ1)
C     IFV =IMVE(IIAQ1,IQ1)
C
   50 CONTINUE
C     AMFPS=AAM(IFPS)
C     AMFV =AAM(IFV)
C     AMFF=AMFV+0.3
C                     EMPIRICAL DEFINITION OF AMFF
C                     TO ALLOW FOR (B-ANTIB) PAIR PRODUCTION
      AMFF=2.5
      NNCH=0
      IF (AMCH.LT.AMFF) THEN
        IREJ=1
        IF(IPEV.GE.3) THEN
          WRITE(6,'(A/5X,4I5,1PE13.5)')
     +    ' KKEVVV/COMCM2 (MASS!): IQ1, IQ2, IAQ1, IAQ2, AMCH', IQ1,
     +    IQ2, IAQ1, IAQ2, AMCH
        ENDIF
      ENDIF
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N, 
     +PQ1X,PQ1Y,PQ1Z,PQ1E,PA1X,PA1Y,PA1Z,PA1E, PQ2X,PQ2Y,PQ2Z,PQ2E,PA2X,
     +PA2Y,PA2Z,PA2E, PXCH1,PYCH1,PZCH1,ECH1, PXCH2,PYCH2,PZCH2,ECH2,
     +IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C   CORRECT KINEMATICS IF MASS OF THE FIRST CHAIN HAS BEEN CHANGED
C                              FROM AMCH1 TO AMCH1N
C   CHAIN 1:  (XP,XTVD)
C   AMMM   :  TOTAL MASS OF TWO CHAIN SYSTEM
C   AMCH2N :  RESULTING NEW MASS FOR CHAIN 2 (OUTPUT ONLY)
C
C---                        RESCALING OF X-VALUES
C                           ACCORDING TO THE MODIFIED MASS OF CHAIN 1
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
C------------------------------------
C     WRITE(6,'(A,4(7E15.5/))')' CORMOM IN',AMCH1,AMCH2,AMCH1N,AMCH2N, 
C    +PQ1X,PQ1Y,PQ1Z,PQ1E,PA1X,PA1Y,PA1Z,PA1E, PQ2X,PQ2Y,PQ2Z,PQ2E,PA2X,
C    +PA2Y,PA2Z,PA2E, PXCH1,PYCH1,PZCH1,ECH1, PXCH2,PYCH2,PZCH2,ECH2
C
      IF(AMCH1.EQ.0.D0)THEN
        IREJ=1
        WRITE(6,*) 'Error in CORMOM : AMCH1=0. Event rejected'
        RETURN
      ENDIF
      FAK=AMCH1N/AMCH1
C     WRITE(6,'(A,F10.5)')' FAK ',FAK
      AMCH1=AMCH1N
C
      PQ1XOL=PQ1X
      PQ1YOL=PQ1Y
      PQ1ZOL=PQ1Z
      PQ1EOL=PQ1E
      PA1XOL=PA1X
      PA1YOL=PA1Y
      PA1ZOL=PA1Z
      PA1EOL=PA1E
      PQ2XOL=PQ2X
      PQ2YOL=PQ2Y
      PQ2ZOL=PQ2Z
      PQ2EOL=PQ2E
      PA2XOL=PA2X
      PA2YOL=PA2Y
      PA2ZOL=PA2Z
      PA2EOL=PA2E
C
      PXCH1O=PXCH1
      PYCH1O=PYCH1
      PZCH1O=PZCH1
      ECH10=ECH1
      PXCH2O=PXCH2
      PYCH2O=PYCH2
      PZCH2O=PZCH2
      ECH20=ECH2
C
C
C---                        RESCALING OF MOMENTA FOR PARTONS OF CHAIN 1
      PQ1X=PQ1X*FAK
      PQ1Y=PQ1Y*FAK
      PQ1Z=PQ1Z*FAK
      PQ1E=PQ1E*FAK
      PA2X=PA2X*FAK
      PA2Y=PA2Y*FAK
      PA2Z=PA2Z*FAK
      PA2E=PA2E*FAK
C                          NEW MOMENTA OF PARTONS OF CHAIN 2
C                          FROM MOMENTUM CONSERVATION
      PA1X=PA1XOL+PQ1XOL-PQ1X   
      PA1Y=PA1YOL+PQ1YOL-PQ1Y   
      PA1Z=PA1ZOL+PQ1ZOL-PQ1Z   
      PA1E=PA1EOL+PQ1EOL-PQ1E   
      PQ2X=PQ2XOL+PA2XOL-PA2X   
      PQ2Y=PQ2YOL+PA2YOL-PA2Y   
      PQ2Z=PQ2ZOL+PA2ZOL-PA2Z   
      PQ2E=PQ2EOL+PA2EOL-PA2E   
C---                        NEW MOMENTUM OF CHAIN 1
      PXCH1=PQ1X+PA2X
      PYCH1=PQ1Y+PA2Y
      PZCH1=PQ1Z+PA2Z
      ECH1 =PQ1E+PA2E
C
C     WRITE(6,'(A,4(7E15.5/))')' CORMOM MOD',AMCH1,AMCH2,AMCH1N,AMCH2N, 
C    +PQ1X,PQ1Y,PQ1Z,PQ1E,PA1X,PA1Y,PA1Z,PA1E, PQ2X,PQ2Y,PQ2Z,PQ2E,PA2X,
C    +PA2Y,PA2Z,PA2E, PXCH1,PYCH1,PZCH1,ECH1, PXCH2,PYCH2,PZCH2,ECH2
C
      ROOT =(ECH1-AMCH1)*(ECH1+AMCH1)
      IF(ROOT.LT.0.D0)THEN
        IREJ=1
        WRITE(6,*)'Error in CORMOM : ROOT<0. Event rejected'
        WRITE(6,*)'ECH1=',ECH1,'   AMCH1=',AMCH1,'   ROOT=',ROOT
        RETURN
      ENDIF
C
C---                        NEW 4-MOMENTUM OF CHAIN 2
      PCH1 = SQRT(ROOT) + 0.000001
      PXCH2=PA1X+PQ2X
      PYCH2=PA1Y+PQ2Y
      PZCH2=PA1Z+PQ2Z
      ECH2 =PA1E+PQ2E
      PCH2 =SQRT(PXCH2**2+PYCH2**2+PZCH2**2)
      AMCH22=ECH2**2-PXCH2**2-PYCH2**2-PZCH2**2
C
      IF(AMCH22.LT.0.D0)THEN
        IREJ=1
        WRITE(6,*)'Error in CORMOM : AMCH22<0. Event rejected'
C        WRITE(6,*)'ECH2=',ECH2,'   PXCH2=',PXCH2,'   PYCH2=',PYCH2,
C     *            '   PZCH2=',PZCH2
        RETURN
      ENDIF
C---
      AMCH2N=SQRT(AMCH22)
      IF(IPRI.GT.1) THEN
        PXSUM=PQ1X+PA1X+PQ2X+PA2X
        PYSUM=PQ1Y+PA1Y+PQ2Y+PA2Y
        PZSUM=PQ1Z+PA1Z+PQ2Z+PA2Z
        PESUM=PQ1E+PA1E+PQ2E+PA2E
        WRITE(6,'(A)') ' CORMOM: KINEMATIC TEST FOR PARTONS'
        WRITE(6,'(A,4(1PE12.5))') ' PXSUM,PYSUM,PZSUM,PESUM', PXSUM,
     +  PYSUM,PZSUM,PESUM
      ENDIF
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      SUBROUTINE SELPT4( PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,NSELPT)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C  SELECT PT VALUES FOR A TWO CHAIN SYSTEM
C                            SELECT SEA QUARK AND ANTIQUARK PT-VALUES
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C--------------------------------
C                                        change j.r.6.5.93
      QTXSQ1=PTXSQ1
      QTXSA1=PTXSA1
      QTXSQ2=PTXSQ2
      QTXSA2=PTXSA2
      QTYSQ1=PTYSQ1
      QTYSA1=PTYSA1
      QTYSQ2=PTYSQ2
      QTYSA2=PTYSA2
      QLQ1=PLQ1
      QLAQ1=PLAQ1
      QLQ2=PLQ2
      QLAQ2=PLAQ2
      QEQ1=EQ1
      QEAQ1=EAQ1
      QEQ2=EQ2
      QEAQ2=EAQ2
C                                        ----------------
      IANFA=0
      ITAGPT=0
C                           changed from 3.  j.r.21.8.93
      B33=16.00
      IF (IKVALA.EQ.1)B33=16.0
      ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
      HPS=SQRT(ES*ES+2.*ES*0.94)
      IF (.NOT.INTPT) HPS=0.0000001
      ICOUNT=0
      IREJ=0
   10 CONTINUE
      ICOUNT=ICOUNT+1
      IF (ICOUNT.EQ.48)THEN
	HPS=0.D0
      ENDIF
      IF (ICOUNT.EQ.50)THEN
C                            REJECT EVENT
        IREJ=1
        RETURN
      ENDIF
      IF (ICOUNT.GE.1)THEN
        HPS=HPS*0.8
        CALL DSFECF(SFE,CFE)
        PTXSQ1=QTXSQ1+HPS*CFE
        PTYSQ1=QTYSQ1+HPS*SFE
        PTXSA1=QTXSA1-HPS*CFE
        PTYSA1=QTYSA1-HPS*SFE
        GO TO 111       
      ENDIF
      B33=2.*B33
      ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
      HPS=SQRT(ES*ES+2.*ES*0.94)
  110 CONTINUE
      IF (.NOT.INTPT) HPS=0.0000001
C.............................................................
      CALL DSFECF(SFE,CFE)
C                                       change j.r.6.5.93
      PTXSQ1=QTXSQ1+HPS*CFE
      PTYSQ1=QTYSQ1+HPS*SFE
      PTXSA1=QTXSA1-HPS*CFE
      PTYSA1=QTYSA1-HPS*SFE
  111 CONTINUE
C                                      -----------------
      IF (IPEV.GE.7)WRITE(6,1000)PTXSQ1,PTYSQ1,PTXSA1,PTYSA1 ,PTXSQ2,
     +PTYSQ2,PTXSA2,PTYSA2
 1000 FORMAT (' PT S  ',8F12.6)
C                           KINEMATICS OF THE TWO CHAINS Q1-AQ2,AQ1-Q2
      PTTQ1=PTXSQ1**2+PTYSQ1**2
      PTTA1=PTXSA1**2+PTYSA1**2
      IF((EQ1**2.LE.PTTQ1).OR. (EAQ1**2.LE.PTTA1))            GO TO 10
C                                      
      IANFA2=0
      ITAGP2=0
      B33=16.00
      IF (IKVALA.EQ.1)B33=16.0
      ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
      HPS=SQRT(ES*ES+2.*ES*0.94)
      IF (.NOT.INTPT) HPS=0.0000001
      ICOUN2=0
      IREJ=0
   12 CONTINUE
      ICOUN2=ICOUN2+1
      IF (ICOUN2.EQ.48)THEN
	HPS=0.D0
      ENDIF
      IF (ICOUN2.EQ.50)THEN
        IREJ=1
C                            REJECT EVENT
        RETURN
      ENDIF
      IF(ICOUN2.GE.1)THEN
        HPS=HPS*0.8
        CALL DSFECF(SFE,CFE)
        PTXSQ2=QTXSQ2+HPS*CFE
        PTYSQ2=QTYSQ2+HPS*SFE
        PTXSA2=QTXSA2-HPS*CFE
        PTYSA2=QTYSA2-HPS*SFE
        GO TO 113
      ENDIF
      B33=2.*B33
C
      ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
      HPS=SQRT(ES*ES+2.*ES*0.94D0)
  112 CONTINUE
      IF (.NOT.INTPT) HPS=0.0000001
C.............................................................
      CALL DSFECF(SFE,CFE)
C                                       change j.r.6.5.93
      PTXSQ2=QTXSQ2+HPS*CFE
      PTYSQ2=QTYSQ2+HPS*SFE
      PTXSA2=QTXSA2-HPS*CFE
      PTYSA2=QTYSA2-HPS*SFE
  113 CONTINUE     
C                                      -----------------
C
      IF (IPEV.GE.7)WRITE(6,1000)PTXSQ1,PTYSQ1,PTXSA1,PTYSA1 ,PTXSQ2,
     +PTYSQ2,PTXSA2,PTYSA2
C                           KINEMATICS OF THE TWO CHAINS Q1-AQ2,AQ1-Q2
      PTTQ2=PTXSQ2**2+PTYSQ2**2
      PTTA2=PTXSA2**2+PTYSA2**2
      IF((EQ2**2.LE.PTTQ2).OR. (EAQ2**2.LE.PTTA2))            GO TO 12
C
C     IF(IP.GE.1)GO TO 1779
        PLQ1=SQRT(EQ1**2-PTTQ1)
        PLAQ1=SQRT(EAQ1**2-PTTA1)
        PLQ2=-SQRT(EQ2**2-PTTQ2)
        PLAQ2=-SQRT(EAQ2**2-PTTA2)
 1779 CONTINUE
C-----------
C                          CHAIN 1: Q1-AQ2     CHAIN2:  AQ1-Q2
      AMCH1Q=(EQ1+EAQ2)**2-(PTXSQ1+PTXSA2)** 2-(PTYSQ1+PTYSA2)**2-(PLQ1
     ++PLAQ2)**2
      IF (AMCH1Q.LE.0.D0)THEN
        WRITE(6,301)AMCH1Q
  301   FORMAT(' inconsistent Kinematics in SELPT AMCH1Q=',E12.3)
       WRITE(6,305) QTXSQ1,QTYSQ1,
     +QLQ1,QEQ1,QTXSA1,QTYSA1,QLAQ1,QEAQ1, QTXSQ2,QTYSQ2,QLQ2,QEQ2,
     +QTXSA2,
     +QTYSA2,QLAQ2,QEAQ2, AMCH1,AMCH2
  305 FORMAT( 'PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2',5(4E15.5/))
        IREJ=1
        RETURN
      ENDIF
C
C                          CHAIN 1: Q1-AQ2     CHAIN2:  AQ1-Q2
      AMCH1=SQRT(AMCH1Q)
      AMCH2Q=(EQ2+EAQ1)**2-(PTXSQ2+PTXSA1)** 2-(PTYSQ2+PTYSA1)**2-(PLQ2
     ++PLAQ1)**2
      IF (AMCH2Q.LE.0.D0)THEN
        WRITE(6,302)AMCH2Q
  302   FORMAT(' inconsistent Kinematics in SELPT AMCH2Q=',E12.3)
       WRITE(6,305) QTXSQ1,QTYSQ1,
     +QLQ1,QEQ1,QTXSA1,QTYSA1,QLAQ1,QEAQ1, QTXSQ2,QTYSQ2,QLQ2,QEQ2,
     +QTXSA2,
     +QTYSA2,QLAQ2,QEAQ2, AMCH1,AMCH2
C        IF(ITAGPT.EQ.0)GO TO !33
        IREJ=1
        RETURN
      ENDIF
      AMCH2=SQRT(AMCH2Q)
      RETURN
      END
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

      SUBROUTINE SELPT( PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     * PTTQ2,PTTA2, NSELPT)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C  SELECT PT VALUES FOR A TWO CHAIN SYSTEM  DPMJET (combined
C                                           DTUNUC/TUJET method)
C                            SELECT SEA QUARK AND ANTIQUARK PT-VALUES
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEND.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C     data NUSEPT /0/
C     data MUSEPT /0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
      IF(IPEV.GE.4)WRITE(6,6633) PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *                 NSELPT
 6633 FORMAT(' selpt input: ',
     + ' PTXSQ1,PTYSQ1, +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,
     + PTYSQ2,PLQ2,EQ2,PTXSA2, PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,
     +IKVALA, NSELPT ', 2(8E12.4/),2E12.4,2I5,2E12.4,I5)
C--------------------------------
C                                        change j.r.6.5.93
      QTXSQ1=PTXSQ1
      QTXSA1=PTXSA1
      QTXSQ2=PTXSQ2
      QTXSA2=PTXSA2
      QTYSQ1=PTYSQ1
      QTYSA1=PTYSA1
      QTYSQ2=PTYSQ2
      QTYSA2=PTYSA2
      QLQ1=PLQ1
      QLAQ1=PLAQ1
      QLQ2=PLQ2
      QLAQ2=PLAQ2
      QEQ1=EQ1
      QEAQ1=EAQ1
      QEQ2=EQ2
      QEAQ2=EAQ2
C                                        ----------------
      IANFA=0
      ITAGPT=0
      IANFA2=0
      ITAGP2=0
      IREJ=0
      ICOUNT=0
      ICOUN2=0
    1 CONTINUE
      IF ( NSELPT.EQ.0 .OR.UMO.LE.20.D0) THEN
C                           changed from 3.  j.r.21.8.93
        B33=16.0
C       IF (IKVALA.EQ.1)B33=3.7
C                                Test 12.2.96
C       IF (IKVALA.EQ.1)B33=(3.0+6.0/LOG10(UMO+10.))/2.
        IF (IKVALA.EQ.1)B33=3.0+6.0/LOG10(UMO+10.)
        IF (IKVALA.EQ.2)B33=4.0+3.0/LOG10(UMO+10.)
        ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
        HPS=SQRT(ES*ES+2.*ES*0.94)
  110   CONTINUE
        IF (.NOT.INTPT) HPS=0.0000001
C.............................................................
   10   CONTINUE
        ICOUNT=ICOUNT+1
        IF (ICOUNT.EQ.48)THEN
	  HPS=0.D0
        ENDIF
        IF (ICOUNT.EQ.50)THEN
C                            REJECT EVENT
          IREJ=1
          RETURN
        ENDIF
        IF (ICOUNT.GE.2)THEN
          HPS=HPS*0.8
          PTXSQ1=PTXSQ1*0.8
          PTYSQ1=PTYSQ1*0.8
          PTXSA1=PTXSA1*0.8
          PTYSA1=PTYSA1*0.8
          CALL DSFECF(SFE,CFE)
C         PTXSQ1=QTXSQ1+HPS*CFE
C         PTYSQ1=QTYSQ1+HPS*SFE
C         PTXSA1=QTXSA1-HPS*CFE
C         PTYSA1=QTYSA1-HPS*SFE
          GO TO 111       
        ENDIF
        B33=2.*B33
        ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
        HPS=SQRT(ES*ES+2.*ES*0.94)
        IF (.NOT.INTPT) HPS=0.0000001
C
      ELSEIF(NSELPT.EQ.1)THEN
          CALL SAMPPT(0,HPS)
          CALL SAMPPT(1,HPS)
          IF(IPEV.GE.4)WRITE(6,6638)HPS
      ELSEIF(NSELPT.EQ.2)THEN
        IF (NUSEPT.EQ.0)THEN
          CALL SAMPPT(0,HPS)
          CALL SAMPPT(1,HPS)
          IF(IPEV.GE.4)WRITE(6,6638)HPS
          NUSEPT=1
          USEPT=HPS
        ELSEIF(NUSEPT.EQ.1)THEN
          HPS=USEPT
        ENDIF
      ENDIF
      CALL DSFECF(SFE,CFE)
C                                       change j.r.6.5.93
      PTXSQ1=QTXSQ1+HPS*CFE
      PTYSQ1=QTYSQ1+HPS*SFE
      PTXSA1=QTXSA1-HPS*CFE
      PTYSA1=QTYSA1-HPS*SFE
      QTXSQ1=QTXSQ1*0.8
      QTYSQ1=QTYSQ1*0.8
      QTXSA1=QTXSA1*0.8
      QTYSA1=QTYSA1*0.8
  111 CONTINUE
C                                      -----------------
C
      IF (IPEV.GE.7)WRITE(6,1000)PTXSQ1,PTYSQ1,PTXSA1,PTYSA1 ,PTXSQ2,
     +PTYSQ2,PTXSA2,PTYSA2
 1000 FORMAT (' PT S  ',8F12.6)
C                           KINEMATICS OF THE TWO CHAINS Q1-AQ2,AQ1-Q2
      PTTQ1=PTXSQ1**2+PTYSQ1**2
      PTTA1=PTXSA1**2+PTYSA1**2
C                                      
      IF ( NSELPT.EQ.0.OR.UMO.LE.20.D0 ) THEN
        B33=16.0
C       IF (IKVALA.EQ.1)B33=3.7
        IF (IKVALA.EQ.1)B33=3.0+6.0/LOG10(UMO+10.)
        IF (IKVALA.EQ.2)B33=4.0+3.0/LOG10(UMO+10.)
        IREJ=0
   12   CONTINUE
        ICOUN2=ICOUN2+1
        IF (ICOUN2.EQ.48)THEN
	  HPS=0.D0
        ENDIF
        IF (ICOUN2.EQ.50)THEN
C                            REJECT EVENT
          IREJ=1
          RETURN
        ENDIF
        IF(ICOUN2.GE.2)THEN
          HPS=HPS*0.8
          PTXSQ2=PTXSQ2*0.8
          PTYSQ2=PTYSQ2*0.8
          PTXSA2=PTXSA2*0.8
          PTYSA2=PTYSA2*0.8
          CALL DSFECF(SFE,CFE)
C         PTXSQ2=QTXSQ2+HPS*CFE
C         PTYSQ2=QTYSQ2+HPS*SFE
C         PTXSA2=QTXSA2-HPS*CFE
C         PTYSA2=QTYSA2-HPS*SFE
          GO TO 113
        ENDIF
        B33=2.*B33
C
        ES=-2./(B33**2)*LOG(ABS(RNDM(V)*RNDM(U))+0.00000001)
C............................................................
        HPS=SQRT(ES*ES+2.*ES*0.94)
  112   CONTINUE
        IF (.NOT.INTPT) HPS=0.0000001
C.............................................................
      ELSEIF(NSELPT.EQ.1)THEN
        IF (MUSEPT.EQ.0)THEN
          CALL SAMPPT(0,HPS)
          CALL SAMPPT(1,HPS)
          IF(IPEV.GE.4)WRITE(6,6638)HPS
 6638     FORMAT (' SELPT:SAMPPT: HPS= ',E12.4)
          MUSEPT=1
          USEPTM=HPS
        ELSEIF(MUSEPT.EQ.1)THEN
          HPS=USEPTM
        ENDIF
      ENDIF
      CALL DSFECF(SFE,CFE)
C                                       change j.r.6.5.93
      PTXSQ2=QTXSQ2+HPS*CFE
      PTYSQ2=QTYSQ2+HPS*SFE
      PTXSA2=QTXSA2-HPS*CFE
      PTYSA2=QTYSA2-HPS*SFE
      QTXSQ2=QTXSQ2*0.8
      QTYSQ2=QTYSQ2*0.8
      QTXSA2=QTXSA2*0.8
      QTYSA2=QTYSA2*0.8
  113 CONTINUE     
C                                      -----------------
C
      IF (IPEV.GE.7)WRITE(6,1000)PTXSQ1,PTYSQ1,PTXSA1,PTYSA1 ,PTXSQ2,
     +PTYSQ2,PTXSA2,PTYSA2
C                           KINEMATICS OF THE TWO CHAINS Q1-AQ2,AQ1-Q2
      PTTQ1=PTXSQ1**2+PTYSQ1**2
      PTTA1=PTXSA1**2+PTYSA1**2
      PTTQ2=PTXSQ2**2+PTYSQ2**2
      PTTA2=PTXSA2**2+PTYSA2**2
      PTWQ1=SQRT(PTTQ1)
      PTWA1=SQRT(PTTA1)
      PTWQ2=SQRT(PTTQ2)
      PTWA2=SQRT(PTTA2)
      IF(PLQ1.GT.PTWQ1.AND.ABS(PLAQ2).GT.PTWQ1)THEN
	PLQ1=QLQ1-PTWQ1
	PLAQ2=QLAQ2+PTWQ1
      ELSEIF(PLQ1.GT.PTWA2.AND.ABS(PLAQ2).GT.PTWA2)THEN
	PLQ1=QLQ1-PTWA2
	PLAQ2=QLAQ2+PTWA2
      ENDIF
      IF(PLAQ1.GT.PTWA1.AND.ABS(PLQ2).GT.PTWA1)THEN
	PLAQ1=QLAQ1-PTWA1
	PLQ2=QLQ2+PTWA1
      ELSEIF(PLAQ1.GT.PTWQ2.AND.ABS(PLQ2).GT.PTWQ2)THEN
	PLAQ1=QLAQ1-PTWQ2
	PLQ2=QLQ2+PTWQ2
      ENDIF
      QLQ1=PLQ1
      QLAQ1=PLAQ1
      QLQ2=PLQ2
      QLAQ2=PLAQ2
      PTTQ1=PTTQ1+PLQ1**2
      PTTA1=PTTA1+PLAQ1**2
      PTTQ2=PTTQ2+PLQ2**2
      PTTA2=PTTA2+PLAQ2**2
        IF (INTPT) THEN
      AMTE1=0.2
      IF(AMTE1.GE.EQ1**2)AMTE1=EQ1**2/2.
      AMTE2=0.2
      IF(AMTE2.GE.EQ2**2)AMTE2=EQ2**2/2.
      AMTE3=0.2
      IF(AMTE1.GE.EAQ1**2)AMTE1=EAQ1**2/2.
      AMTE4=0.2
      IF(AMTE2.GE.EAQ2**2)AMTE2=EAQ2**2/2.
        IF((EQ1**2-AMTE1.LE.PTTQ1).OR.
     *	(EQ2**2-AMTE1.LE.PTTQ2)
     *  .OR.(EAQ1**2-AMTE3.LE.PTTA1).OR.
     *  (EAQ2**2-AMTE4.LE.PTTA2))THEN
          IF ( NSELPT.EQ.0.OR.UMO.LE.20.D0 ) THEN
            GO TO 1
          ELSE
            USEPT  = USEPT  * 0.7
            USEPTM = USEPTM * 0.7
            IF( USEPT.GT.0.01D0 .OR. USEPTM.GT.0.01D0 ) THEN
              IF (IPEV.GE.6)THEN
                WRITE(6,*)'  SELPT: JUMP AFTER REDUCTION OF USEPT'
                WRITE(6,*)'  SELPT: USEPT,USEPTM,HPS',USEPT,USEPTM,HPS
              ENDIF
              GO TO 1
            ELSE
              IREJ = 1
      IF(IPEV.GE.4)WRITE(6,6634) PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *                 NSELPT
 6634 FORMAT(' selpt rejec: ',
     + ' PTXSQ1,PTYSQ1, +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,
     + PTYSQ2,PLQ2,EQ2,PTXSA2, PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,
     +IKVALA, NSELPT ', 2(8E12.4/),2E12.4,3I5)
              RETURN
            ENDIF
          ENDIF
        ENDIF
        ENDIF
        NUSEPT=0
        MUSEPT=0
C
      IF(IP.GE.1)GO TO 1779
        QQQ1=QTXSQ1**2+QTYSQ1**2+QLQ1**2-PTTQ1
        IF(QQQ1.GT.0.D0)THEN
          PLQ1=SQRT(QQQ1)
        ELSE
          PLQ1=SQRT(EQ1**2-PTTQ1)
        ENDIF
        QQA1=QTXSA1**2+QTYSA1**2+QLAQ1**2-PTTA1
        IF(QQA1.GT.0.D0)THEN
          PLAQ1=SQRT(QQA1)
        ELSE
          PLAQ1=SQRT(EAQ1**2-PTTA1)
        ENDIF
        QQQ2=QTXSQ2**2+QTYSQ2**2+QLQ2**2-PTTQ2
        IF(QQQ2.GT.0.D0)THEN
          PLQ2=-SQRT(QQQ2)
        ELSE
          PLQ2=-SQRT(EQ2**2-PTTQ2)
        ENDIF
        QQA2=QTXSA2**2+QTYSA2**2+QLAQ2**2-PTTA2
        IF(QQA2.GT.0.D0)THEN
          PLAQ2=-SQRT(QQA2)
        ELSE
          PLAQ2=-SQRT(EAQ2**2-PTTA2)
        ENDIF
 1779 CONTINUE
C-----------
C-----------
C                          CHAIN 1: Q1-AQ2     CHAIN2:  AQ1-Q2
      AMCH1Q=(EQ1+EAQ2)**2-(PTXSQ1+PTXSA2)** 2-(PTYSQ1+PTYSA2)**2-(PLQ1
     ++PLAQ2)**2
      IF (AMCH1Q.LE.0.D0)THEN
C       IF(IANFA.EQ.0)THEN
C         IANFA=1
C         ITAGPT=1
C         GO TO 110
C       ENDIF
C       GO TO 10
        WRITE(6,301)AMCH1Q
  301   FORMAT(' inconsistent Kinematics in SELPT AMCH1Q=',E12.3)
       WRITE(6,305) QTXSQ1,QTYSQ1,
     +QLQ1,QEQ1,QTXSA1,QTYSA1,QLAQ1,QEAQ1, QTXSQ2,QTYSQ2,QLQ2,QEQ2,
     +QTXSA2,
     +QTYSA2,QLAQ2,QEAQ2, AMCH1,AMCH2
  305 FORMAT( 'PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2',5(4E15.5/))
C       IF(ITAGPT.EQ.0)GO TO !33
        IREJ=1
      IF(IPEV.GE.4)WRITE(6,6635) PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *                 NSELPT
 6635 FORMAT(' selpt rejec: ',
     + ' PTXSQ1,PTYSQ1, +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,
     + PTYSQ2,PLQ2,EQ2,PTXSA2, PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,
     +IKVALA, NSELPT ', 2(8E12.4/),2E12.4,3I5)
        RETURN
      ENDIF
C
C                          CHAIN 1: Q1-AQ2     CHAIN2:  AQ1-Q2
      AMCH1=SQRT(AMCH1Q)
      AMCH2Q=(EQ2+EAQ1)**2-(PTXSQ2+PTXSA1)** 2-(PTYSQ2+PTYSA1)**2-(PLQ2
     ++PLAQ1)**2
      IF (AMCH2Q.LE.0.D0)THEN
C       IF(IANFA.EQ.0)THEN
C         IANFA=1
C         ITAGPT=1
C         GO TO 110
C       ENDIF
C       GO TO 10
        WRITE(6,302)AMCH2Q
  302   FORMAT(' inconsistent Kinematics in SELPT AMCH2Q=',E12.3)
       WRITE(6,305) QTXSQ1,QTYSQ1,
     +QLQ1,QEQ1,QTXSA1,QTYSA1,QLAQ1,QEAQ1, QTXSQ2,QTYSQ2,QLQ2,QEQ2,
     +QTXSA2,
     +QTYSA2,QLAQ2,QEAQ2, AMCH1,AMCH2
C        IF(ITAGPT.EQ.0)GO TO !33
        IREJ=1
      IF(IPEV.GE.4)WRITE(6,6636) PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *                 NSELPT
 6636 FORMAT(' selpt rejec: ',
     + ' PTXSQ1,PTYSQ1, +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,
     + PTYSQ2,PLQ2,EQ2,PTXSA2, PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,
     +IKVALA, NSELPT ', 2(8E12.4/),2E12.4,3I5)
        RETURN
      ENDIF
      AMCH2=SQRT(AMCH2Q)
      IF(IPEV.GE.4)WRITE(6,6637) PTXSQ1,PTYSQ1,
     +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,
     +PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     *                 NSELPT
 6637 FORMAT(' selpt exit : ',
     + ' PTXSQ1,PTYSQ1, +PLQ1,EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1, PTXSQ2,
     + PTYSQ2,PLQ2,EQ2,PTXSA2, PTYSA2,PLAQ2,EAQ2, AMCH1,AMCH2,IREJ,
     +IKVALA, NSELPT ', 2(8E12.4/),2E12.4,2I5,2E12.4,I5)
      RETURN
      END
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE DECHKK(NHKKH1)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DDECAC.
      PARAMETER (IDMAX9=602)
      CHARACTER*8  ZKNAME
      COMMON /DDECAC/ ZKNAME(IDMAX9),WT(IDMAX9),NZK(IDMAX9,3)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEND.
      DIMENSION ECMF(3),PCMF(3),CODF(3),COFF(3),SIFF(3),ITF(3)
      DIMENSION ECMFF(3),PCMFF(3)
      DIMENSION CXF(3),CYF(3),CZF(3)
      DATA ISTAB /2/
C-----------------------------------------------------
      IHKK=NHKKH1
C     IPHKK=2
      IF (IPHKK.GE.2) WRITE(6,1000) IHKK,NHKK
 1000 FORMAT(' DECHKK IHKK,NHKK= ',2I5)
C
C***                    LOOP OVER ALL PARTICLES FROM THE STACK
   10 CONTINUE
      IHKK=IHKK+1
      IF (IHKK.GT.NHKK)THEN
C       IPHKK=0
        RETURN
      ENDIF
C
      IF(ABS(ISTHKK(IHKK)).NE.1)       GOTO 10
      IQQQQ=ISTHKK(IHKK)
C
      IT=MCIHAD(IDHKK(IHKK))
C
      IF (IT.LT.1.OR.IT.GT.210) THEN
        WRITE (6,1003)IT
 1003   FORMAT (' DECHKK IT ',I10)
      ENDIF
C
C*****TEST STABLE OR UNSTABLE
C     ISTAB=2
C   ISTAB=1/2/3 MEANS  STRONG + WEAK DECAYS / ONLY STRONG DECAYS /
C   STRONG DECAYS + WEAK DECAYS FOR CHARMED PARTICLES AND TAU LEPTONS
C
C   GOTO 51 :             THERE WAS NO DECAY RETURN TO STACK
C
      IF(ISTAB.EQ.1) THEN
c  muonic neutrinos
        IF(IT.EQ.135.OR.IT.EQ.136)                               GOTO 10
c  ordinary lepton
        IF(IT.GE.1.AND.IT.LE.7)                                  GOTO 10
      ELSEIF(ISTAB.EQ.2) THEN
c  lepton and meson (incl strangenes)
        IF(IT.GE. 1.AND.IT.LE. 30)                               GOTO 10
c  baryons with 2 strange quarks
        IF(IT.GE. 97.AND.IT.LE.103)                              GOTO 10
c  charmed mesons 
        IF(IT.GE.115.AND.IT.LE.122)                              GOTO 10
c  leptons with tau
        IF(IT.GE.131.AND.IT.LE.136)                              GOTO 10
c  baryon with 3 strange quarks
        IF(IT.EQ.109)                                            GOTO 10
c  charmed baryons
        IF(IT.GE.137.AND.IT.LE.160)                              GOTO 10
      ELSEIF(ISTAB.EQ.3) THEN
c  lepton and meson (without strangenes)
        IF(IT.GE.1.AND.IT.LE.23)                                 GOTO 10
c  baryons with 2 strange quarks
        IF(IT.GE. 97.AND.IT.LE.103)                              GOTO 10
c  baryon resonances with strangenes
        IF(IT.EQ.109.AND.IT.EQ.115)                              GOTO 10
c  neutrinos (muonic ant tau)
        IF(IT.GE.133.AND.IT.LE.136)                              GOTO 10
      ENDIF
C***                               DECAY TO BE HANDLED
C
C
C                    Consistency check of decaying hadron
C
      PLS=SQRT(ABS(PHKK(1,IHKK)**2+PHKK(2,IHKK)**2+PHKK(3,IHKK)**2))
      AMTEST=SQRT(ABS(PHKK(4,IHKK)**2-PLS**2))
      IF(ABS(AMTEST-PHKK(5,IHKK)).GE.1.D-3)THEN
C	WRITE(6,'(A,2E15.5,I10)')' DECHKK inconsistent resonance',
C    *   AMTEST,PHKK(5,IHKK),IHKK
	PLSS=(PHKK(4,IHKK)**2-PHKK(5,IHKK))
	IF(PLSS.LE.0.D0)THEN
	  WRITE(6,'(A)')' negative momentum square!'
	  PLSS=0.D0
	ENDIF
	PLSN=SQRT(PLSS)
	AMODP=PLSN/PLS
	PHKK(1,IHKK)=PHKK(1,IHKK)*AMODP
	PHKK(2,IHKK)=PHKK(2,IHKK)*AMODP
	PHKK(3,IHKK)=PHKK(3,IHKK)*AMODP
	PLS=PLS*AMODP
      ENDIF
C
      IF(PLS.NE.0.D0) THEN
        CXS=PHKK(1,IHKK)/PLS
        CYS=PHKK(2,IHKK)/PLS
        CZS=PHKK(3,IHKK)/PLS
      ENDIF
      ELS=PHKK(4,IHKK)
      ECO=AAM(IT)
      GAM=ELS/ECO
      BGAM=PLS/ECO
C
      KZ1=K1(IT)
      VV=RNDM(V) - 1.E-17
      IIK=KZ1-1
   20 IIK=IIK+1
      IF (VV.GT.WT(IIK))                                        GO TO 20
C
C                                          IIK IS THE DECAY CHANNEL
      ITF(1)=NZK(IIK,1)
      ITF(2)=NZK(IIK,2)
C******************************   ?????????????????????
C??   IF (ITF(2)-1.LT.0) GO TO 110
C??   IF (IT2-1.LT.0) GO TO 305
      IF (ITF(2).LT.1)                                          GO TO 10
C******************************   ????????????????????
      ITF(3)=NZK(IIK,3)
C
      IF(IPHKK.GE.1) WRITE(6,1010)IT,IIK,ITF(1),ITF(2),ITF(3)
 1010 FORMAT(' DECHKK IT,IIK,IT1,IT2,IT3 ',5I5)
C  IT1,IT2, IT3 ARE THE PRODUCED PARTICLES FROM  IT
C
      IF(ITF(3).EQ.0) THEN
        NDECPR=2
        CALL DTWOPD(ECO,ECMF(1),ECMF(2),PCMF(1),PCMF(2), CODF(1),COFF
     +  (1),SIFF(1),CODF(2),COFF(2),SIFF(2), AAM(ITF(1)),AAM(ITF(2)))
        SID1=SQRT(ABS((1.-CODF(1))*(1.+CODF(1))))
        SID2=SQRT(ABS((1.-CODF(2))*(1.+CODF(2))))
        PIX1=PCMF(1)*SID1*COFF(1)
        PIY1=PCMF(1)*SID1*SIFF(1)
        PIZ1=PCMF(1)*CODF(1)
        PIX2=PCMF(2)*SID2*COFF(2)
        PIY2=PCMF(2)*SID2*SIFF(2)
        PIZ2=PCMF(2)*CODF(2)
        PIX12=PIX1+PIX2
        PIY12=PIY1+PIY2
        PIZ12=PIZ1+PIZ2
        ECM12=ECMF(1)+ECMF(2)-ECO
        IF((ABS(PIX12).GT.0.000001D0).OR.
     +     (ABS(PIY12).GT.0.000001D0).OR.
     +     (ABS(PIZ12).GT.0.000001D0).OR. 
     +     (ABS(ECM12).GT.0.000001D0))THEN
           WRITE(6,778)PIX12,PIY12,PIZ12,ECM12
  778      FORMAT(' DWOPD px,py,pz,e',4F10.6)
        ENDIF
 
      ELSE
        NDECPR=3
       CALL DTHREP(ECO,ECMF(1),ECMF(2),ECMF(3),PCMF(1),PCMF(2),PCMF(3),
     +  CODF(1),COFF(1),SIFF(1),CODF(2),COFF(2),SIFF(2), CODF(3),COFF
     +  (3),SIFF(3), AAM(ITF(1)),AAM(ITF(2)),AAM(ITF(3)))
        SID1=SQRT((1.-CODF(1))*(1.+CODF(1)))
        SID2=SQRT((1.-CODF(2))*(1.+CODF(2)))
        SID3=SQRT((1.-CODF(3))*(1.+CODF(3)))
        PIX1=PCMF(1)*SID1*COFF(1)
        PIY1=PCMF(1)*SID1*SIFF(1)
        PIZ1=PCMF(1)*CODF(1)
        PIX2=PCMF(2)*SID2*COFF(2)
        PIY2=PCMF(2)*SID2*SIFF(2)
        PIZ2=PCMF(2)*CODF(2)
        PIX3=PCMF(3)*SID3*COFF(3)
        PIY3=PCMF(3)*SID3*SIFF(3)
        PIZ3=PCMF(3)*CODF(3)
        PIX12=PIX1+PIX2+PIX3
        PIY12=PIY1+PIY2+PIY3
        PIZ12=PIZ1+PIZ2+PIZ3
        ECM12=ECMF(1)+ECMF(2)+ECMF(3)-ECO
        IF((ABS(PIX12).GT.0.000001D0).OR.
     +     (ABS(PIY12).GT.0.000001D0).OR.
     +     (ABS(PIZ12).GT.0.000001D0).OR. 
     +     (ABS(ECM12).GT.0.000001D0))THEN
           WRITE(6,779)PIX12,PIY12,PIZ12,ECM12
  779      FORMAT(' DTHEPD px,py,pz,e',4F10.6)
        ENDIF
 
      ENDIF
C
      JDAHKK(1,IHKK)=NHKK + 1
      JDAHKK(2,IHKK)=NHKK + NDECPR
      DO 30 ID=1,NDECPR
      EHECC=SQRT(ABS(PCMF(ID)** 2+ AAM(ITF(ID))**2))
        IF (ABS(EHECC-ECMF(ID)).GT.0.0001D0) THEN
             WRITE(6,'(2A/3I5,3E15.6)')
     &            ' DECHKK: CORRECT INCONSISTENT ENERGY ',
     *            '  IHKK,NHKK,ITF(ID), ECMF(ID),EHECC, AAM(ITF(ID))',
     *            IHKK,NHKK,ITF(ID), ECMF(ID),EHECC, AAM(ITF(ID))
        ENDIF
C      CALL DTRAFO(GAM,BGAM,CXS,CYS,CZS, CODF(ID),COFF(ID),
C    *SIFF(ID),PCMF
       CALL DTRAFO(GAM,BGAM,CXS,CYS,CZS, CODF(ID),COFF(ID),
     * SIFF(ID),PCMF(ID),ECMF(ID), PCMFF(ID),CXF(ID),
     *CYF(ID),CZF(ID),ECMFF(ID))
        IF (IPHKK.GE.2) WRITE(6,'(A,7E15.5/8E15.5)')' DTRAFO ',
     * GAM,BGAM,CXS,CYS,CZS, CODF(ID),COFF(ID),
     * SIFF(ID),PCMF(ID),ECMF(ID), PCMFF(ID),CXF(ID),
     *CYF(ID),CZF(ID),ECMFF(ID)
 
C*******************
C                                  THERE WAS A DECAY, DROP MOTHER IHKK
C                                  AND PUT PARTICLE INTO HKK STACK
        ISTHKK(IHKK)=2
        IF (NHKK.EQ.NMXHKK)THEN
          WRITE (6,1020)NHKK,NMXHKK
 1020 FORMAT (' NHKK.GT.NMXHKK IN DECHKK RETURN ',2I10)
C      	  IPHKK=0
          RETURN
        ENDIF
C
        NHKK=NHKK+1
        IF (NHKK.EQ.NMXHKK) THEN
          WRITE (6,'(A,2I5)') ' DECHKK: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
C      	  IPHKK=0
          RETURN
        ENDIF
	IDBAM(NHKK)=ITF(ID)
        ISTHKK(NHKK)=IQQQQ
        IDHKK(NHKK)=MPDGHA(ITF(ID))
        JMOHKK(1,NHKK)=IHKK
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        PHKK(1,NHKK)=CXF(ID)*PCMFF(ID)
        PHKK(2,NHKK)=CYF(ID)*PCMFF(ID)
        PHKK(3,NHKK)=CZF(ID)*PCMFF(ID)
      EHECC=SQRT(ABS(PCMFF(ID)** 2+ AAM(ITF(ID))**2))
        IF (ABS(EHECC-ECMFF(ID)).GT.0.003D0) THEN
             WRITE(6,'(2A/3I5,3E15.6)')
     &            ' DECHKK: CORRECT INCONSISTENT ENERGY ',
     *            '  IHKK,NHKK,ITF(ID), ECMF(ID),EHECC, AAM(ITF(ID))',
     *            IHKK,NHKK,ITF(ID), ECMFF(ID),EHECC, AAM(ITF(ID))
          ECMFF(ID)=EHECC
        ENDIF
        PHKK(4,NHKK)=ECMFF(ID)
      PHKK(5,NHKK)=AAM(ITF(ID))
        VHKK(1,NHKK)=VHKK(1,IHKK)
        VHKK(2,NHKK)=VHKK(2,IHKK)
        VHKK(3,NHKK)=VHKK(3,IHKK)
        VHKK(4,NHKK)=VHKK(4,IHKK)
C
        IF (IPHKK.GE.7) WRITE(6,1030)NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1030 FORMAT (I6,I4,5I6,9E10.2)
C
   30 CONTINUE
C
                                                                 GOTO 10
C
C     RETURN
      END
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

*=== trafo ============================================================*        
*                                                                               
      SUBROUTINE DTRAFO(GAM,BGAM,CX,CY,CZ,COD,COF,SIF,P,ECM,                     
     1PL,CXL,CYL,CZL,EL)                                                        
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C     LORENTZ TRANSFORMATION INTO THE LAB - SYSTEM                              
      SID=SQRT(1.D0-COD*COD)                                                    
      PLX=P*SID*COF                                                             
      PLY=P*SID*SIF   
      PPPT=SQRT(PLX**2+PLY**2)
      PCMZ=P*COD                                                                
      PLZ=GAM*PCMZ+BGAM*ECM                                                     
      PL=SQRT(PLX*PLX+PLY*PLY+PLZ*PLZ)                                          
      EL=GAM*ECM+BGAM*PCMZ                                                      
C     ROTATION INTO THE ORIGINAL DIRECTION                                      
      COZ=PLZ/PL                                                                
C     SIZ=SQRT((1.D0-COZ)*(1.D0+COZ))   
      SIZ=PPPT/PL
C     WRITE(6,'(A,2E25.16)')' COZ,SIZ ',COZ,SIZ
      CALL STTRAN(CX,CY,CZ,COZ,SIZ,SIF,COF,CXL,CYL,CZL)                         
      RETURN                                                                    
      END        
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                                                               
      SUBROUTINE STTRAN(XO,YO,ZO,CDE,SDE,SFE,CFE,X,Y,Z)                         
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      DATA ANGLSQ/1.D-14/                                                        
C********************************************************************           
C     VERSION BY                     J. RANFT                                   
C                                    LEIPZIG                                    
C                                                                               
C     THIS IS A SUBROUTINE OF FLUKA TO GIVE NEW DIRECTION COSINES               
C                                                                               
C     INPUT VARIABLES:                                                          
C        XO,YO,ZO = ORIGINAL DIRECTION COSINES                                  
C        CDE,SDE  = COSINE AND SINE OF THE POLAR (THETA)                        
C                   ANGLE OF "SCATTERING"                                       
C        SDE      = SINE OF THE POLAR (THETA) ANGLE OF "SCATTERING"             
C        SFE,CFE  = SINE AND COSINE OF THE AZIMUTHAL (PHI) ANGLE                
C                   OF "SCATTERING"                                             
C                                                                               
C     OUTPUT VARIABLES:                                                         
C        X,Y,Z     = NEW DIRECTION COSINES                                      
C                                                                               
C     ROTATION OF COORDINATE SYSTEM (SEE CERN 64-47 )                           
C********************************************************************           
C                                                                               
*                                                                               
*  Changed by A. Ferrari                                                        
*                                                                               
*     IF (ABS(XO)-0.0001D0) 1,1,2                                               
*   1 IF (ABS(YO)-0.0001D0) 3,3,2                                               
*   3 CONTINUE                                                                  
      A = XO**2 + YO**2                                                         
      IF ( A .LT. ANGLSQ ) THEN                                                 
         X=SDE*CFE                                                              
         Y=SDE*SFE                                                              
C     Z=CDE CORRECTED AUGUST 88 PA                                              
         Z=CDE*ZO                                                               
      ELSE                                                                      
         XI=SDE*CFE                                                             
         YI=SDE*SFE                                                             
         ZI=CDE                                                                 
         A=SQRT(A)                                                              
         X=-YO*XI/A-ZO*XO*YI/A+XO*ZI                                            
         Y=XO*XI/A-ZO*YO*YI/A+YO*ZI                                             
         Z=A*YI+ZO*ZI                                                           
      END IF                                                                    
      RETURN                                                                    
      END                                                                       
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE LORTMO(N,GAM,BGX,BGY,BGZ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C*** LORENTZ TRANSFORMATION OF THE N PARTICLES IN  FINPAR
C
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEND.
C-------------------
      PARAMETER (TINY=1.D-10)
      DATA IFIRST/0/
      DATA NUM/0/
C
      IFIRST=IFIRST+1
      NUM=NUM+1
      PXSM=0.0
      PYSM=0.0
      PZSM=0.0
      ESUM=0.
      PXSC=0.0
      PYSC=0.0
      PZSC=0.0
      ESMC=0.0
C           END OF CHANGE
      DO 10 I=1,N
        PXI=PXF(I)
        PYI=PYF(I)
        PZI=PZF(I)
      EEI=HEF(I)
        PXSM=PXSM + PXI
        PYSM=PYSM + PYI
        PZSM=PZSM + PZI
        ESUM=ESUM + EEI
        CALL DALTRA(GAM,BGX,BGY,BGZ,PXI,PYI,PZI,EEI, PPA,PXF(I),PYF(I),
     +  PZF(I),HEF(I))
        PXSC=PXSC + PXF(I)
        PYSC=PYSC + PYF(I)
        PZSC=PZSC + PZF(I)
      ESMC=ESMC + HEF(I)
   10 CONTINUE
C
C     PXSM,ETC,ARE SUMS FOR BAMJET FRAGMENTS IN JET CMS
      CALL DALTRA(GAM,BGX,BGY,BGZ,PXSM,PYSM,PZSM,ESUM, PPA,PXSM,PYSM,
     +PZSM,ESUM)
C
C     PXSC,ETC,ARE SUMS FOR BAMJET FRAGMENTS IN PROJ,TARGET CMS
 
      PXDIF=PXSM-PXSC
      PYDIF=PYSM-PYSC
      PZDIF=PZSM-PZSC
      EDIF=ESUM-ESMC
      DIFFL=PXDIF+PYDIF+PZDIF+EDIF
      IF(ESUM.LT.TINY)ESUM=TINY
      DIFFL=DIFFL/ESUM
      IF(DIFFL.GE.1.D-4)WRITE(6,1000)NUM,PXDIF,PYDIF,PZDIF,EDIF,PXSM,
     +PXSC, PYSM,PYSC,PZSM,PZSC,ESUM,ESMC
 1000 FORMAT(' ',2X,'LORTRA:NUM=',I5,2X,'PXDIF=',1PE15.6,2X,'PYDIF=', 1
     +PE15.6,2X,'PZDIF=',1PE15.6,2X,'EDIF=',1PE15.6/2X,'PXSM=',1PE15.6,2
     +X,'PXSC=',1PE15.6,2X,'PYSM=',1PE15.6,2X,'PYSC=',1PE15.6/2X,'PZSM',
     +1PE15.6,2X,'PZSC=',1PE15.6,2X,'ESUM=',1PE15.6,2X,'ESMC=',1PE15.6/2
     +X,'LORTRA DIFFERENCES DUE TO ALTRA'/)
      RETURN
      END
*-- Author :
C-------------------------------------------------------------------
C
C                              FILE DMNUC3.FOR
C
C-------------------------------------------------------------------
C
      SUBROUTINE EVTEST(IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C            TEST OF ENERGY MOMENTUM CONSERVATION ON NIVEAU OF CHAINS
C                                      AND ON NIVEAU OF CHAIN  ENDS
C
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
C
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
      COMMON /INTNEZ/ NDZ,NZD
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,ABRSS.
C     INCLUDE (ABRSS)
      COMMON /ABRSS/ AMCSS1(INTMX),AMCSS2(INTMX), GACSS1(INTMX),GACSS2
     +(INTMX), BGXSS1(INTMX),BGYSS1(INTMX),BGZSS1(INTMX), BGXSS2(INTMX),
     +BGYSS2(INTMX),BGZSS2(INTMX), NCHSS1(INTMX),NCHSS2(INTMX), IJCSS1
     +(INTMX),IJCSS2(INTMX), PQSSA1(INTMX,4),PQSSA2(INTMX,4), PQSSB1
     +(INTMX,4),PQSSB2(INTMX,4)
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,ABRSV.
      COMMON /ABRSV/ AMCSV1(248),AMCSV2(248),GACSV1(248),GACSV2(248),
     +BGXSV1(248),BGYSV1(248),BGZSV1(248), BGXSV2(248),BGYSV2(248),
     +BGZSV2(248), NCHSV1(248),NCHSV2(248),IJCSV1(248),IJCSV2(248),
     +PQSVA1(248,4),PQSVA2(248,4), PQSVB1(248,4),PQSVB2(248,4)
*KEEP,ABRVS.
      COMMON /ABRVS/ AMCVS1(248),AMCVS2(248),GACVS1(248),GACVS2(248),
     +BGXVS1(248),BGYVS1(248),BGZVS1(248), BGXVS2(248),BGYVS2(248),
     +BGZVS2(248), NCHVS1(248),NCHVS2(248),IJCVS1(248),IJCVS2(248),
     +PQVSA1(248,4),PQVSA2(248,4), PQVSB1(248,4),PQVSB2(248,4)
*KEEP,ABRVV.
      COMMON /ABRVV/ AMCVV1(248),AMCVV2(248),GACVV1(248),GACVV2(248),
     +BGXVV1(248),BGYVV1(248),BGZVV1(248), BGXVV2(248),BGYVV2(248),
     +BGZVV2(248), NCHVV1(248),NCHVV2(248),IJCVV1(248),IJCVV2(248),
     +PQVVA1(248,4),PQVVA2(248,4), PQVVB1(248,4),PQVVB2(248,4)
*KEEP,ABRDV.
      COMMON /ABRDV/ AMCDV1(248),AMCDV2(248),GACDV1(248),GACDV2(248),
     +BGXDV1(248),BGYDV1(248),BGZDV1(248), BGXDV2(248),BGYDV2(248),
     +BGZDV2(248), NCHDV1(248),NCHDV2(248),IJCDV1(248),IJCDV2(248),
     +PQDVA1(248,4),PQDVA2(248,4), PQDVB1(248,4),PQDVB2(248,4)
C-------------------
*KEEP,ABRVD.
      COMMON /ABRVD/ AMCVD1(248),AMCVD2(248),GACVD1(248),GACVD2(248),
     +BGXVD1(248),BGYVD1(248),BGZVD1(248), BGXVD2(248),BGYVD2(248),
     +BGZVD2(248), NCHVD1(248),NCHVD2(248),IJCVD1(248),IJCVD2(248),
     +PQVDA1(248,4),PQVDA2(248,4), PQVDB1(248,4),PQVDB2(248,4)
*KEEP,ABRDS.
      COMMON /ABRDS/ AMCDS1(248),AMCDS2(248),GACDS1(248),GACDS2(248),
     +BGXDS1(248),BGYDS1(248),BGZDS1(248), BGXDS2(248),BGYDS2(248),
     +BGZDS2(248), NCHDS1(248),NCHDS2(248),IJCDS1(248),IJCDS2(248),
     +PQDSA1(248,4),PQDSA2(248,4), PQDSB1(248,4),PQDSB2(248,4)
C-------------------
*KEEP,ABRDS.
       COMMON /ABRDZ/ AMCDZ1(INTMD),AMCDZ2(INTMD),
     +GACDZ1(INTMD),GACDZ2(INTMD),
     +BGXDZ1(INTMD),BGYDZ1(INTMD),BGZDZ1(INTMD),
     +BGXDZ2(INTMD),BGYDZ2(INTMD),
     +BGZDZ2(INTMD), NCHDZ1(INTMD),NCHDZ2(INTMD),
     +IJCDZ1(INTMD),IJCDZ2(INTMD),
     +PQDZA1(INTMD,4),PQDZA2(INTMD,4),
     +PQDZB1(INTMD,4),PQDZB2(INTMD,4),
     +IPZQ(INTMD),IPZQQ2(INTMD),ITZQ(INTMD),
     +IPZAQ(INTMD),IZAQQ2(INTMD),ITZAQ(INTMD)
     +,IDZZZ(INTMD)
C-------------------
*KEEP,ABRSD.
      COMMON /ABRSD/ AMCSD1(248),AMCSD2(248),GACSD1(248),GACSD2(248),
     +BGXSD1(248),BGYSD1(248),BGZSD1(248), BGXSD2(248),BGYSD2(248),
     +BGZSD2(248), NCHSD1(248),NCHSD2(248),IJCSD1(248),IJCSD2(248),
     +PQSDA1(248,4),PQSDA2(248,4), PQSDB1(248,4),PQSDB2(248,4)
C-------------------
*KEEP,ABRSD.
      COMMON /ABRZD/ AMCZD1(INTMD),AMCZD2(INTMD),
     +GACZD1(INTMD),GACZD2(INTMD),
     +BGXZD1(INTMD),BGYZD1(INTMD),BGZZD1(INTMD),
     +BGXZD2(INTMD),BGYZD2(INTMD),
     +BGZZD2(INTMD), NCHZD1(INTMD),NCHZD2(INTMD),
     +IJCZD1(INTMD),IJCZD2(INTMD),
     +PQZDA1(INTMD,4),PQZDA2(INTMD,4),
     +PQZDB1(INTMD,4),PQZDB2(INTMD,4),
     +IPYQ(INTMD),ITYQ(INTMD),ITYQ2(INTMD),
     +IPYAQ(INTMD),ITYAQ(INTMD),ITYAQ2(INTMD)
     +,IZDYY(INTMD)
C-------------------
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /ABRZZ/ AMCZZ1(INTMX),AMCZZ2(INTMX),
     *               GACZZ1(INTMX),GACZZ2(INTMX),
     *               BGXZZ1(INTMX),BGYZZ1(INTMX),BGZZZ1(INTMX),
     *               BGXZZ2(INTMX),BGYZZ2(INTMX),BGZZZ2(INTMX),
     *               NCHZZ1(INTMX),NCHZZ2(INTMX),
     *               IJCZZ1(INTMX),IJCZZ2(INTMX),
     *               PQZZA1(INTMX,4),PQZZA2(INTMX,4),
     *               PQZZB1(INTMX,4),PQZZB2(INTMX,4)
      COMMON /ABRHH/ AMCHH1(INTMX),AMCHH2(INTMX),
     *               GACHH1(INTMX),GACHH2(INTMX),
     *               BGXHH1(INTMX),BGYHH1(INTMX),BGZHH1(INTMX),
     *               BGXHH2(INTMX),BGYHH2(INTMX),BGZHH2(INTMX),
     *               NCHHH1(INTMX),NCHHH2(INTMX),
     *               IJCHH1(INTMX),IJCHH2(INTMX),
     *               PQHHA1(INTMX,4),PQHHA2(INTMX,4),
     *               PQHHB1(INTMX,4),PQHHB2(INTMX,4)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
C------------------------
C      WRITE(6,1298)NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,NOCC,NONUST,
C    *                                                   NONUJT
C1298 FORMAT(' NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,NOCC,NONUST,NONUJT'
C    */11I8)
      IREJ=0
      PXBAL=0.
      PYBAL=0.
      PZBAL=0.
      PEBAL=0.
      PXSS=0.
      PYSS=0.
      PZSS=0.
      PESS=0.
      PXSV=0.
      PYSV=0.
      PZSV=0.
      PESV=0.
      PXVS=0.
      PYVS=0.
      PZVS=0.
      PEVS=0.
      PXVV=0.
      PYVV=0.
      PZVV=0.
      PEVV=0.
      PXDS=0.
      PYDS=0.
      PZDS=0.
      PEDS=0.
      PXSD=0.
      PYSD=0.
      PZSD=0.
      PESD=0.
      PXDZ=0.
      PYDZ=0.
      PZDZ=0.
      PEDZ=0.
      PXZD=0.
      PYZD=0.
      PZZD=0.
      PEZD=0.
      PXDV=0.
      PYDV=0.
      PZDV=0.
      PEDV=0.
      PXVD=0.
      PYVD=0.
      PZVD=0.
      PEVD=0.
      PXCC=0.
      PYCC=0.
      PZCC=0.
      PECC=0.
      PXZZ=0.
      PYZZ=0.
      PZZZ=0.
      PEZZ=0.
      PXHH=0.
      PYHH=0.
      PZHH=0.
      PEHH=0.
C     IF(IP.EQ.1)GAMCM=GAMCM+(NSV+NDV)*AAM(IJPROJ)/UMO
C
C     IF(IHADA.OR.IHADSS) THEN
        DO 10 N=1,NSS
          IF (INLOSS(N))THEN
            IF(ABS(NCHSS1(N)).NE.99) THEN
              PXSS=PXSS + PQSSA1(N,1) + PQSSA2(N,1)
              PYSS=PYSS + PQSSA1(N,2) + PQSSA2(N,2)
              PZSS=PZSS + PQSSA1(N,3) + PQSSA2(N,3)
              PESS=PESS + PQSSA1(N,4) + PQSSA2(N,4)
            ENDIF
            IF(ABS(NCHSS2(N)).NE.99) THEN
              PXSS=PXSS + PQSSB1(N,1) + PQSSB2(N,1)
              PYSS=PYSS + PQSSB1(N,2) + PQSSB2(N,2)
              PZSS=PZSS + PQSSB1(N,3) + PQSSB2(N,3)
              PESS=PESS + PQSSB1(N,4) + PQSSB2(N,4)
            ENDIF
          ENDIF
   10   CONTINUE
        PZBSS=GAMCM*PZSS + BGCM*PESS
        PEBSS=GAMCM*PESS + BGCM*PZSS
        PXBAL=PXSS
        PYBAL=PYSS
        PZBAL=PZBSS
        PEBAL=PEBSS
C     ENDIF
C     IF(IHADA.OR.IHADSV) THEN
        DO 20 N=1,NSV
          IF(ABS(NCHSV1(N)).NE.99) THEN
            PXSV=PXSV +PQSVA1(N,1)+PQSVA2(N,1)
            PYSV=PYSV +PQSVA1(N,2)+PQSVA2(N,2)
            PZSV=PZSV +PQSVA1(N,3)+PQSVA2(N,3)
            PESV=PESV +PQSVA1(N,4)+PQSVA2(N,4)
      IF (IPEV.GE.1)THEN
        WRITE(6,2001)
     +  PXSV,PYSV,PZSV,PESV
      ENDIF
 2001 FORMAT (
     +' SV ',4E15.5)
C
          ENDIF
          IF(ABS(NCHSV2(N)).NE.99) THEN
            PXSV=PXSV + PQSVB1(N,1)+PQSVB2(N,1)
            PYSV=PYSV + PQSVB1(N,2)+PQSVB2(N,2)
            PZSV=PZSV + PQSVB1(N,3)+PQSVB2(N,3)
            PESV=PESV + PQSVB1(N,4)+PQSVB2(N,4)
      IF (IPEV.GE.1)THEN
        WRITE(6,2001)
     +  PXSV,PYSV,PZSV,PESV
      ENDIF
          ENDIF
   20   CONTINUE
        PZBSV=GAMCM*PZSV + BGCM*PESV
        PEBSV=GAMCM*PESV + BGCM*PZSV
      IF (IPEV.GE.1)THEN
        WRITE(6,2001)
     +  PXSV,PYSV,PZBSV,PEBSV
      ENDIF
        PXBAL=PXBAL + PXSV
        PYBAL=PYBAL + PYSV
        PZBAL=PZBAL + PZBSV
        PEBAL=PEBAL + PEBSV
C     ENDIF
C     IF(IHADA.OR.IHADVS) THEN
        DO 30 N=1,NVS
          IF(ABS(NCHVS1(N)).NE.99) THEN
            PXVS=PXVS + PQVSA1(N,1) + PQVSA2(N,1)
            PYVS=PYVS + PQVSA1(N,2) + PQVSA2(N,2)
            PZVS=PZVS + PQVSA1(N,3) + PQVSA2(N,3)
            PEVS=PEVS + PQVSA1(N,4) + PQVSA2(N,4)
          ENDIF
          IF(ABS(NCHVS2(N)).NE.99) THEN
            PXVS=PXVS + PQVSB1(N,1) + PQVSB2(N,1)
            PYVS=PYVS + PQVSB1(N,2) + PQVSB2(N,2)
            PZVS=PZVS + PQVSB1(N,3) + PQVSB2(N,3)
            PEVS=PEVS + PQVSB1(N,4) + PQVSB2(N,4)
          ENDIF
   30   CONTINUE
        PZBVS=GAMCM*PZVS + BGCM*PEVS
        PEBVS=GAMCM*PEVS + BGCM*PZVS
        PXBAL=PXBAL + PXVS
        PYBAL=PYBAL + PYVS
        PZBAL=PZBAL + PZBVS
        PEBAL=PEBAL + PEBVS
        DO 31 N=1,NDS
          IF(ABS(NCHDS1(N)).NE.99) THEN
            PXDS=PXDS + PQDSA1(N,1) + PQDSA2(N,1)
            PYDS=PYDS + PQDSA1(N,2) + PQDSA2(N,2)
            PZDS=PZDS + PQDSA1(N,3) + PQDSA2(N,3)
            PEDS=PEDS + PQDSA1(N,4) + PQDSA2(N,4)
          ENDIF
          IF(ABS(NCHDS2(N)).NE.99) THEN
            PXDS=PXDS + PQDSB1(N,1) + PQDSB2(N,1)
            PYDS=PYDS + PQDSB1(N,2) + PQDSB2(N,2)
            PZDS=PZDS + PQDSB1(N,3) + PQDSB2(N,3)
            PEDS=PEDS + PQDSB1(N,4) + PQDSB2(N,4)
          ENDIF
   31   CONTINUE
        PZBDS=GAMCM*PZDS + BGCM*PEDS
        PEBDS=GAMCM*PEDS + BGCM*PZDS
        PXBAL=PXBAL + PXDS
        PYBAL=PYBAL + PYDS
        PZBAL=PZBAL + PZBDS
        PEBAL=PEBAL + PEBDS
        DO 371 N=1,NDZ
          IF(ABS(NCHDZ1(N)).NE.99) THEN
            PXDZ=PXDZ + PQDZA1(N,1) + PQDZA2(N,1)
            PYDZ=PYDZ + PQDZA1(N,2) + PQDZA2(N,2)
            PZDZ=PZDZ + PQDZA1(N,3) + PQDZA2(N,3)
            PEDZ=PEDZ + PQDZA1(N,4) + PQDZA2(N,4)
          ENDIF
          IF(ABS(NCHDZ2(N)).NE.99) THEN
            PXDZ=PXDZ + PQDZB1(N,1) + PQDZB2(N,1)
            PYDZ=PYDZ + PQDZB1(N,2) + PQDZB2(N,2)
            PZDZ=PZDZ + PQDZB1(N,3) + PQDZB2(N,3)
            PEDZ=PEDZ + PQDZB1(N,4) + PQDZB2(N,4)
          ENDIF
  371   CONTINUE
        PZBDZ=GAMCM*PZDZ + BGCM*PEDZ
        PEBDZ=GAMCM*PEDZ + BGCM*PZDZ
        PXBAL=PXBAL + PXDZ
        PYBAL=PYBAL + PYDZ
        PZBAL=PZBAL + PZBDZ
        PEBAL=PEBAL + PEBDZ
        DO 32 N=1,NSD
          IF(ABS(NCHSD1(N)).NE.99) THEN
            PXSD=PXSD + PQSDA1(N,1) + PQSDA2(N,1)
            PYSD=PYSD + PQSDA1(N,2) + PQSDA2(N,2)
            PZSD=PZSD + PQSDA1(N,3) + PQSDA2(N,3)
            PESD=PESD + PQSDA1(N,4) + PQSDA2(N,4)
          ENDIF
          IF(ABS(NCHSD2(N)).NE.99) THEN
            PXSD=PXSD + PQSDB1(N,1) + PQSDB2(N,1)
            PYSD=PYSD + PQSDB1(N,2) + PQSDB2(N,2)
            PZSD=PZSD + PQSDB1(N,3) + PQSDB2(N,3)
            PESD=PESD + PQSDB1(N,4) + PQSDB2(N,4)
          ENDIF
   32   CONTINUE
        PZBSD=GAMCM*PZSD + BGCM*PESD
        PEBSD=GAMCM*PESD + BGCM*PZSD
        PXBAL=PXBAL + PXSD
        PYBAL=PYBAL + PYSD
        PZBAL=PZBAL + PZBSD
        PEBAL=PEBAL + PEBSD
        DO 372 N=1,NZD
          IF(ABS(NCHZD1(N)).NE.99) THEN
            PXZD=PXZD + PQZDA1(N,1) + PQZDA2(N,1)
            PYZD=PYZD + PQZDA1(N,2) + PQZDA2(N,2)
            PZZD=PZZD + PQZDA1(N,3) + PQZDA2(N,3)
            PEZD=PEZD + PQZDA1(N,4) + PQZDA2(N,4)
          ENDIF
          IF(ABS(NCHZD2(N)).NE.99) THEN
            PXZD=PXZD + PQZDB1(N,1) + PQZDB2(N,1)
            PYZD=PYZD + PQZDB1(N,2) + PQZDB2(N,2)
            PZZD=PZZD + PQZDB1(N,3) + PQZDB2(N,3)
            PEZD=PEZD + PQZDB1(N,4) + PQZDB2(N,4)
          ENDIF
  372    CONTINUE
        PZBZD=GAMCM*PZZD + BGCM*PEZD
        PEBZD=GAMCM*PEZD + BGCM*PZZD
        PXBAL=PXBAL + PXZD
        PYBAL=PYBAL + PYZD
        PZBAL=PZBAL + PZBZD
        PEBAL=PEBAL + PEBZD
        DO 33 N=1,NDV
          IF(ABS(NCHDV1(N)).NE.99) THEN
            PXDV=PXDV + PQDVA1(N,1) + PQDVA2(N,1)
            PYDV=PYDV + PQDVA1(N,2) + PQDVA2(N,2)
            PZDV=PZDV + PQDVA1(N,3) + PQDVA2(N,3)
            PEDV=PEDV + PQDVA1(N,4) + PQDVA2(N,4)
          ENDIF
          IF(ABS(NCHDV2(N)).NE.99) THEN
            PXDV=PXDV + PQDVB1(N,1) + PQDVB2(N,1)
            PYDV=PYDV + PQDVB1(N,2) + PQDVB2(N,2)
            PZDV=PZDV + PQDVB1(N,3) + PQDVB2(N,3)
            PEDV=PEDV + PQDVB1(N,4) + PQDVB2(N,4)
          ENDIF
   33   CONTINUE
        PZBDV=GAMCM*PZDV + BGCM*PEDV
        PEBDV=GAMCM*PEDV + BGCM*PZDV
        PXBAL=PXBAL + PXDV
        PYBAL=PYBAL + PYDV
        PZBAL=PZBAL + PZBDV
        PEBAL=PEBAL + PEBDV
        DO 34 N=1,NVD
          IF(ABS(NCHVD1(N)).NE.99) THEN
            PXVD=PXVD + PQVDA1(N,1) + PQVDA2(N,1)
            PYVD=PYVD + PQVDA1(N,2) + PQVDA2(N,2)
            PZVD=PZVD + PQVDA1(N,3) + PQVDA2(N,3)
            PEVD=PEVD + PQVDA1(N,4) + PQVDA2(N,4)
          ENDIF
          IF(ABS(NCHVD2(N)).NE.99) THEN
            PXVD=PXVD + PQVDB1(N,1) + PQVDB2(N,1)
            PYVD=PYVD + PQVDB1(N,2) + PQVDB2(N,2)
            PZVD=PZVD + PQVDB1(N,3) + PQVDB2(N,3)
            PEVD=PEVD + PQVDB1(N,4) + PQVDB2(N,4)
          ENDIF
   34   CONTINUE
        PZBVD=GAMCM*PZVD + BGCM*PEVD
        PEBVD=GAMCM*PEVD + BGCM*PZVD
        PXBAL=PXBAL + PXVD
        PYBAL=PYBAL + PYVD
        PZBAL=PZBAL + PZBVD
        PEBAL=PEBAL + PEBVD
C     ENDIF
C     IF(IHADA.OR.IHADVV) THEN
        DO 40 N=1,NVV
          IF((NCHVV1(N).NE.99).AND.(NCHVV2(N).NE.99)) THEN
          PXVV=PXVV+PQVVA1(N,1)+PQVVA2(N,1)+PQVVB1(N,1)+PQVVB2(N,1)
          PYVV=PYVV+PQVVA1(N,2)+PQVVA2(N,2)+PQVVB1(N,2)+PQVVB2(N,2)
          PZVV=PZVV+PQVVA1(N,3)+PQVVA2(N,3)+PQVVB1(N,3)+PQVVB2(N,3)
          PEVV=PEVV+PQVVA1(N,4)+PQVVA2(N,4)+PQVVB1(N,4)+PQVVB2(N,4)
          ENDIF
   40   CONTINUE
        PZBVV=GAMCM*PZVV + BGCM*PEVV
        PEBVV=GAMCM*PEVV + BGCM*PZVV
        PXBAL=PXBAL + PXVV
        PYBAL=PYBAL + PYVV
        PZBAL=PZBAL + PZBVV
        PEBAL=PEBAL + PEBVV
C     ENDIF
C     IF(IHADA.OR.IHADSS) THEN
C	WRITE(6,*)' evtest nocc ',NOCC
C       DO 120 N=1,NOCC
C         PXCC=PXCC + POJCC(1,N) + PATCC(1,N)
C         PYCC=PYCC + POJCC(2,N) + PATCC(2,N)
C         PZCC=PZCC + POJCC(3,N) + PATCC(3,N)
C         PECC=PECC + POJCC(4,N) + PATCC(4,N)
C120    CONTINUE
C       PZBCC=GAMCM*PZCC + BGCM*PECC
C       PEBCC=GAMCM*PECC + BGCM*PZCC
C       PXBAL=PXBAL + PXCC
C       PYBAL=PYBAL + PYCC
C       PZBAL=PZBAL + PZBCC
C       PEBAL=PEBAL + PEBCC
C     ENDIF
C	WRITE(6,*)' evtest nonust ',NONUST
        DO 210 N=1,NONUST
            IF(ABS(NCHZZ1(N)).NE.99.AND.JHKKSX(N).EQ.1) THEN
            IF(ABS(NCHZZ1(N)).NE.88) THEN
              PXZZ=PXZZ + PQZZA1(N,1) + PQZZA2(N,1)
              PYZZ=PYZZ + PQZZA1(N,2) + PQZZA2(N,2)
              PZZZ=PZZZ + PQZZA1(N,3) + PQZZA2(N,3)
              PEZZ=PEZZ + PQZZA1(N,4) + PQZZA2(N,4)
            ENDIF
            ENDIF
            IF(ABS(NCHZZ2(N)).NE.99.AND.JHKKSX(N).EQ.1) THEN
            IF(ABS(NCHZZ2(N)).NE.88) THEN
              PXZZ=PXZZ + PQZZB1(N,1) + PQZZB2(N,1)
              PYZZ=PYZZ + PQZZB1(N,2) + PQZZB2(N,2)
              PZZZ=PZZZ + PQZZB1(N,3) + PQZZB2(N,3)
              PEZZ=PEZZ + PQZZB1(N,4) + PQZZB2(N,4)
            ENDIF
            ENDIF
  210   CONTINUE
        PZBZZ=GAMCM*PZZZ + BGCM*PEZZ
        PEBZZ=GAMCM*PEZZ + BGCM*PZZZ
        PXBAL=PXBAL + PXZZ
        PYBAL=PYBAL + PYZZ
        PZBAL=PZBAL + PZBZZ
        PEBAL=PEBAL + PEBZZ
C	WRITE(6,*)' evtest nonujt ',NONUJT
        DO 220 N=1,NONUJT
            IF(ABS(NCHHH1(N)).NE.99.AND.JHKKEX(N).EQ.1) THEN
              PXHH=PXHH + PQHHA1(N,1) + PQHHA2(N,1)
              PYHH=PYHH + PQHHA1(N,2) + PQHHA2(N,2)
              PZHH=PZHH + PQHHA1(N,3) + PQHHA2(N,3)
              PEHH=PEHH + PQHHA1(N,4) + PQHHA2(N,4)
            ENDIF
            IF(ABS(NCHHH2(N)).NE.99.AND.JHKKEX(N).EQ.1) THEN
              PXHH=PXHH + PQHHB1(N,1) + PQHHB2(N,1)
              PYHH=PYHH + PQHHB1(N,2) + PQHHB2(N,2)
              PZHH=PZHH + PQHHB1(N,3) + PQHHB2(N,3)
              PEHH=PEHH + PQHHB1(N,4) + PQHHB2(N,4)
            ENDIF
  220   CONTINUE
        PZBHH=GAMCM*PZHH + BGCM*PEHH
        PEBHH=GAMCM*PEHH + BGCM*PZHH
        PXBAL=PXBAL + PXHH
        PYBAL=PYBAL + PYHH
        PZBAL=PZBAL + PZBHH
        PEBAL=PEBAL + PEBHH
C
      E0000=0.D0
      P0000=0.D0
C	WRITE(6,*)' evtest ip ',IP
      DO 7767 I=1,IP
        IF(ISTHKK(I).EQ.11)E0000=E0000+PRMOM(4,I)
        IF(ISTHKK(I).EQ.11)P0000=P0000+PRMOM(3,I)
 7767 CONTINUE
C	WRITE(6,*)' evtest it ',IT
      DO 7768 II=1,IT
        I=II+IP
        IF(ISTHKK(I).EQ.12)E0000=E0000+TAMOM(4,II)
        IF(ISTHKK(I).EQ.12)P0000=P0000+TAMOM(3,II)
 7768 CONTINUE
      P000=GAMCM*P0000+BGCM*E0000
      E000=GAMCM*E0000+BGCM*P0000
      IPROJO=(PZBAL*1.001)/PPROJ
      RESIDU=ABS(E000-PEBAL)/(E000)
      IF (IPEV.GE.1)THEN
 	WRITE(6,'(A,2E15.5)')' E000,PEBAL', E000,PEBAL
        WRITE(6,1000)PXBAL,PYBAL,PZBAL,PEBAL, PXSS,PYSS,PZBSS,PEBSS,
     +  PXSV,PYSV,PZBSV,PEBSV, PXVS,PYVS,PZBVS,PEBVS, PXVV,PYVV,PZBVV,
     +  PEBVV,PXCC,PYCC,PZBCC,PEBCC,
     +  PXZZ,PYZZ,PZBZZ,PEBZZ,
     +  PXHH,PYHH,PZBHH,PEBHH,
     +  PXDS,PYDS,PZBDS,PEBDS,
     +  PXSD,PYSD,PZBSD,PEBSD,
     +  PXDZ,PYDZ,PZBDZ,PEBDZ,
     +  PXZD,PYZD,PZBZD,PEBZD,
     +  PXDV,PYDV,PZBDV,PEBDV,
     +  PXVD,PYVD,PZBVD,PEBVD
      ENDIF
      IF (RESIDU.GT.0.02D0)THEN
	IREJ=1
      ENDIF
      IF (RESIDU.GT.0.02D0.AND.IPHKK.GE.2)THEN
	IREJ=1
	WRITE(6,'(A,2E15.5)')' E000,PEBAL', E000,PEBAL
        WRITE(6,1000)PXBAL,PYBAL,PZBAL,PEBAL, PXSS,PYSS,PZBSS,PEBSS,
     +  PXSV,PYSV,PZBSV,PEBSV, PXVS,PYVS,PZBVS,PEBVS, PXVV,PYVV,PZBVV,
     +  PEBVV,PXCC,PYCC,PZBCC,PEBCC,
     +  PXZZ,PYZZ,PZBZZ,PEBZZ,
     +  PXHH,PYHH,PZBHH,PEBHH,
     +  PXDS,PYDS,PZBDS,PEBDS,
     +  PXSD,PYSD,PZBSD,PEBSD,
     +  PXDZ,PYDZ,PZBDZ,PEBDZ,
     +  PXZD,PYZD,PZBZD,PEBZD,
     +  PXDV,PYDV,PZBDV,PEBDV,
     +  PXVD,PYVD,PZBVD,PEBVD
      ENDIF
 1000 FORMAT (' 4 MOMENTUM CONS.IN EVENT LEVEL OF PARTONS',/ ' ALL',4E15
     +.5/,' SS ',4E15.5/,' SV ',4E15.5/ ' VS ',4E15.5/,' VV ',4E15.5/,
     + ' CC ',4E15.5/
     + ' ZZ ',4E15.5/
     + ' HH ',4E15.5/
     + ' DS ',4E15.5/
     + ' SD ',4E15.5/
     + ' DZ ',4E15.5/
     + ' ZD ',4E15.5/
     + ' DV ',4E15.5/
     + ' VD ',4E15.5)
C
      PXBAL=0.
      PYBAL=0.
      PZBAL=0.
      PEBAL=0.
      PXSS=0.
      PYSS=0.
      PZSS=0.
      PESS=0.
      PXSV=0.
      PYSV=0.
      PZSV=0.
      PESV=0.
      PXVS=0.
      PYVS=0.
      PZVS=0.
      PEVS=0.
      PXVV=0.
      PYVV=0.
      PZVV=0.
      PEVV=0.
      PXCC=0.
      PYCC=0.
      PZCC=0.
      PECC=0.
      PXDS=0.
      PYDS=0.
      PZDS=0.
      PEDS=0.
      PXSD=0.
      PYSD=0.
      PZSD=0.
      PESD=0.
      PXDV=0.
      PYDV=0.
      PZDV=0.
      PEDV=0.
      PXVD=0.
      PYVD=0.
      PZVD=0.
      PEVD=0.
      PXZZ=0.
      PYZZ=0.
      PZZZ=0.
      PEZZ=0.
      PXHH=0.
      PYHH=0.
      PZHH=0.
      PEHH=0.
C
C     IF(IHADA.OR.IHADSS) THEN
        DO 50 N=1,NSS
          IF (INLOSS(N))THEN
          IF(ABS(NCHSS1(N)).NE.99) THEN
            PXSS=PXSS+BGXSS1(N)*AMCSS1(N)
            PYSS=PYSS+BGYSS1(N)*AMCSS1(N)
            PZSS=PZSS+BGZSS1(N)*AMCSS1(N)
            PESS=PESS+GACSS1(N)*AMCSS1(N)
          ENDIF
          IF(ABS(NCHSS2(N)).NE.99) THEN
            PXSS=PXSS+BGXSS2(N)*AMCSS2(N)
            PYSS=PYSS+BGYSS2(N)*AMCSS2(N)
            PZSS=PZSS+BGZSS2(N)*AMCSS2(N)
            PESS=PESS+GACSS2(N)*AMCSS2(N)
          ENDIF
          ENDIF
   50   CONTINUE
        PZBSS=GAMCM*PZSS + BGCM*PESS
        PEBSS=GAMCM*PESS + BGCM*PZSS
C       DO 130 N=1,NOCC
C         PXCC=PXCC + BGXCC(N)*AMCC(N)
C         PYCC=PYCC + BGYCC(N)*AMCC(N)
C         PZCC=PZCC + BGZCC(N)*AMCC(N)
C         PECC=PECC + GACC(N)*AMCC(N)
C130    CONTINUE
        PXBAL=PXSS
        PYBAL=PYSS
        PZBAL=PZBSS
        PEBAL=PEBSS
C       PZBCC=GAMCM*PZCC + BGCM*PECC
C       PEBCC=GAMCM*PECC + BGCM*PZCC
C       PXBAL=PXBAL + PXCC
C       PYBAL=PYBAL + PYCC
C       PZBAL=PZBAL + PZBCC
C       PEBAL=PEBAL + PEBCC
C     ENDIF
C     IF(IHADA.OR.IHADSV) THEN
        DO 60 N=1,NSV
          IF(ABS(NCHSV1(N)).NE.99) THEN
          PXSV=PXSV+BGXSV1(N)*AMCSV1(N)
          PYSV=PYSV+BGYSV1(N)*AMCSV1(N)
          PZSV=PZSV+BGZSV1(N)*AMCSV1(N)
          PESV=PESV+GACSV1(N)*AMCSV1(N)
          ENDIF
          IF(ABS(NCHSV2(N)).NE.99) THEN
          PXSV=PXSV+BGXSV2(N)*AMCSV2(N)
          PYSV=PYSV+BGYSV2(N)*AMCSV2(N)
          PZSV=PZSV+BGZSV2(N)*AMCSV2(N)
          PESV=PESV+GACSV2(N)*AMCSV2(N)
          ENDIF
   60   CONTINUE
        PZBSV=GAMCM*PZSV + BGCM*PESV
        PEBSV=GAMCM*PESV + BGCM*PZSV
        PXBAL=PXBAL + PXSV
        PYBAL=PYBAL + PYSV
        PZBAL=PZBAL + PZBSV
        PEBAL=PEBAL + PEBSV
        DO 61 N=1,NDS
          IF(ABS(NCHDS1(N)).NE.99) THEN
          PXDS=PXDS+BGXDS1(N)*AMCDS1(N)
          PYDS=PYDS+BGYDS1(N)*AMCDS1(N)
          PZDS=PZDS+BGZDS1(N)*AMCDS1(N)
          PEDS=PEDS+GACDS1(N)*AMCDS1(N)
          ENDIF
          IF(ABS(NCHDS2(N)).NE.99) THEN
          PXDS=PXDS+BGXDS2(N)*AMCDS2(N)
          PYDS=PYDS+BGYDS2(N)*AMCDS2(N)
          PZDS=PZDS+BGZDS2(N)*AMCDS2(N)
          PEDS=PEDS+GACDS2(N)*AMCDS2(N)
          ENDIF
   61   CONTINUE
        PZBDS=GAMCM*PZDS + BGCM*PEDS
        PEBDS=GAMCM*PEDS + BGCM*PZDS
        PXBAL=PXBAL + PXDS
        PYBAL=PYBAL + PYDS
        PZBAL=PZBAL + PZBDS
        PEBAL=PEBAL + PEBDS
        DO 62 N=1,NSD
          IF(ABS(NCHSD1(N)).NE.99) THEN
          PXSD=PXSD+BGXSD1(N)*AMCSD1(N)
          PYSD=PYSD+BGYSD1(N)*AMCSD1(N)
          PZSD=PZSD+BGZSD1(N)*AMCSD1(N)
          PESD=PESD+GACSD1(N)*AMCSD1(N)
          ENDIF
          IF(ABS(NCHSD2(N)).NE.99) THEN
          PXSD=PXSD+BGXSD2(N)*AMCSD2(N)
          PYSD=PYSD+BGYSD2(N)*AMCSD2(N)
          PZSD=PZSD+BGZSD2(N)*AMCSD2(N)
          PESD=PESD+GACSD2(N)*AMCSD2(N)
          ENDIF
   62   CONTINUE
        PZBSD=GAMCM*PZSD + BGCM*PESD
        PEBSD=GAMCM*PESD + BGCM*PZSD
        PXBAL=PXBAL + PXSD
        PYBAL=PYBAL + PYSD
        PZBAL=PZBAL + PZBSD
        PEBAL=PEBAL + PEBSD
        DO 63 N=1,NDV
          IF(ABS(NCHDV1(N)).NE.99) THEN
          PXDV=PXDV+BGXDV1(N)*AMCDV1(N)
          PYDV=PYDV+BGYDV1(N)*AMCDV1(N)
          PZDV=PZDV+BGZDV1(N)*AMCDV1(N)
          PEDV=PEDV+GACDV1(N)*AMCDV1(N)
          ENDIF
          IF(ABS(NCHDV2(N)).NE.99) THEN
          PXDV=PXDV+BGXDV2(N)*AMCDV2(N)
          PYDV=PYDV+BGYDV2(N)*AMCDV2(N)
          PZDV=PZDV+BGZDV2(N)*AMCDV2(N)
          PEDV=PEDV+GACDV2(N)*AMCDV2(N)
          ENDIF
   63   CONTINUE
        PZBDV=GAMCM*PZDV + BGCM*PEDV
        PEBDV=GAMCM*PEDV + BGCM*PZDV
        PXBAL=PXBAL + PXDV
        PYBAL=PYBAL + PYDV
        PZBAL=PZBAL + PZBDV
        PEBAL=PEBAL + PEBDV
        DO 64 N=1,NVD
          IF(ABS(NCHVD1(N)).NE.99) THEN
          PXVD=PXVD+BGXVD1(N)*AMCVD1(N)
          PYVD=PYVD+BGYVD1(N)*AMCVD1(N)
          PZVD=PZVD+BGZVD1(N)*AMCVD1(N)
          PEVD=PEVD+GACVD1(N)*AMCVD1(N)
          ENDIF
          IF(ABS(NCHVD2(N)).NE.99) THEN
          PXVD=PXVD+BGXVD2(N)*AMCVD2(N)
          PYVD=PYVD+BGYVD2(N)*AMCVD2(N)
          PZVD=PZVD+BGZVD2(N)*AMCVD2(N)
          PEVD=PEVD+GACVD2(N)*AMCVD2(N)
          ENDIF
   64   CONTINUE
        PZBVD=GAMCM*PZVD + BGCM*PEVD
        PEBVD=GAMCM*PEVD + BGCM*PZVD
        PXBAL=PXBAL + PXVD
        PYBAL=PYBAL + PYVD
        PZBAL=PZBAL + PZBVD
        PEBAL=PEBAL + PEBVD
C     ENDIF
C     IF(IHADA.OR.IHADVS) THEN
        DO 70 N=1,NVS
          IF(ABS(NCHVS1(N)).NE.99) THEN
          PXVS=PXVS+BGXVS1(N)*AMCVS1(N)
          PYVS=PYVS+BGYVS1(N)*AMCVS1(N)
          PZVS=PZVS+BGZVS1(N)*AMCVS1(N)
          PEVS=PEVS+GACVS1(N)*AMCVS1(N)
          ENDIF
          IF(ABS(NCHVS2(N)).NE.99) THEN
          PXVS=PXVS+BGXVS2(N)*AMCVS2(N)
          PYVS=PYVS+BGYVS2(N)*AMCVS2(N)
          PZVS=PZVS+BGZVS2(N)*AMCVS2(N)
          PEVS=PEVS+GACVS2(N)*AMCVS2(N)
          ENDIF
   70   CONTINUE
        PZBVS=GAMCM*PZVS + BGCM*PEVS
        PEBVS=GAMCM*PEVS + BGCM*PZVS
        PXBAL=PXBAL + PXVS
        PYBAL=PYBAL + PYVS
        PZBAL=PZBAL + PZBVS
        PEBAL=PEBAL + PEBVS
C     ENDIF
        DO 250 N=1,NONUST
          IF(ABS(NCHZZ1(N)).NE.99.AND.JHKKSX(N).EQ.1) THEN
            PXZZ=PXZZ+BGXZZ1(N)*AMCZZ1(N)
            PYZZ=PYZZ+BGYZZ1(N)*AMCZZ1(N)
            PZZZ=PZZZ+BGZZZ1(N)*AMCZZ1(N)
            PEZZ=PEZZ+GACZZ1(N)*AMCZZ1(N)
          ENDIF
          IF(ABS(NCHZZ2(N)).NE.99.AND.JHKKSX(N).EQ.1) THEN
            PXZZ=PXZZ+BGXZZ2(N)*AMCZZ2(N)
            PYZZ=PYZZ+BGYZZ2(N)*AMCZZ2(N)
            PZZZ=PZZZ+BGZZZ2(N)*AMCZZ2(N)
            PEZZ=PEZZ+GACZZ2(N)*AMCZZ2(N)
          ENDIF
  250   CONTINUE
        PZBZZ=GAMCM*PZZZ + BGCM*PEZZ
        PEBZZ=GAMCM*PEZZ + BGCM*PZZZ
        PXBAL=PXBAL + PXZZ
        PYBAL=PYBAL + PYZZ
        PZBAL=PZBAL + PZBZZ
        PEBAL=PEBAL + PEBZZ
        DO 260 N=1,NONUJT
          IF(ABS(NCHHH1(N)).NE.99.AND.JHKKEX(N).EQ.1) THEN
            PXHH=PXHH+BGXHH1(N)*AMCHH1(N)
            PYHH=PYHH+BGYHH1(N)*AMCHH1(N)
            PZHH=PZHH+BGZHH1(N)*AMCHH1(N)
            PEHH=PEHH+GACHH1(N)*AMCHH1(N)
          ENDIF
          IF(ABS(NCHHH2(N)).NE.99.AND.JHKKEX(N).EQ.1) THEN
            PXHH=PXHH+BGXHH2(N)*AMCHH2(N)
            PYHH=PYHH+BGYHH2(N)*AMCHH2(N)
            PZHH=PZHH+BGZHH2(N)*AMCHH2(N)
            PEHH=PEHH+GACHH2(N)*AMCHH2(N)
          ENDIF
  260   CONTINUE
        PZBHH=GAMCM*PZHH + BGCM*PEHH
        PEBHH=GAMCM*PEHH + BGCM*PZHH
        PXBAL=PXBAL + PXHH
        PYBAL=PYBAL + PYHH
        PZBAL=PZBAL + PZBHH
        PEBAL=PEBAL + PEBHH
C     IF(IHADA.OR.IHADVV) THEN
        DO 80 N=1,NVV
          IF((NCHVV1(N).NE.99).AND.(NCHVV2(N).NE.99)) THEN
          PXVV=PXVV+BGXVV1(N)*AMCVV1(N)+BGXVV2(N)*AMCVV2(N)
          PYVV=PYVV+BGYVV1(N)*AMCVV1(N)+BGYVV2(N)*AMCVV2(N)
          PZVV=PZVV+BGZVV1(N)*AMCVV1(N)+BGZVV2(N)*AMCVV2(N)
          PEVV=PEVV+GACVV1(N)*AMCVV1(N)+GACVV2(N)*AMCVV2(N)
          ENDIF
   80   CONTINUE
        PZBVV=GAMCM*PZVV + BGCM*PEVV
        PEBVV=GAMCM*PEVV + BGCM*PZVV
        PXBAL=PXBAL + PXVV
        PYBAL=PYBAL + PYVV
        PZBAL=PZBAL + PZBVV
        PEBAL=PEBAL + PEBVV
C     ENDIF
C
      IF (IPEV.GE.1) WRITE(6,1010)PXBAL,PYBAL,PZBAL,
     +PEBAL, PXSS,PYSS,PZBSS,PEBSS, PXSV,PYSV,PZBSV,PEBSV, PXVS,PYVS,
     +PZBVS,PEBVS, PXVV,PYVV,PZBVV,PEBVV, PXCC,PYCC,PZBCC,PEBCC,
     +  PXDS,PYDS,PZBDS,PEBDS,
     +  PXZZ,PYZZ,PZBZZ,PEBZZ,
     +  PXHH,PYHH,PZBHH,PEBHH,
     +  PXSD,PYSD,PZBSD,PEBSD,
     +  PXDV,PYDV,PZBDV,PEBDV,
     +  PXVD,PYVD,PZBVD,PEBVD
 1010 FORMAT (' 4 MOMENTUM CONS.IN EVENT LEVEL OF CHAINS',/ ' ALL',4E15.
     +5/,' SS ',4E15.5/,' SV ',4E15.5/ ' VS ',4E15.5/,' VV ',4E15.5/,
     +  ' CC ',4E15.5/
     + ' DS ',4E15.5/
     + ' ZZ ',4E15.5/
     + ' HH ',4E15.5/
     + ' SD ',4E15.5/
     + ' DV ',4E15.5/
     + ' VD ',4E15.5)
C
      RETURN
      END
*-- Author :
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      SUBROUTINE CORVAL(AMMM,IREJ,AMCH1,AMCH2, QTX1,QTY1,QZ1,QE1,QTX2,
     +QTY2,QZ2,QE2,NORIG)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C KINEMATICAL CORRECTION OF TWO-VALENCE CHAIN SYSTEM
C ACCORDING TO 2-PARTICLE KINEMATICS WITH FIXED MASSES
C
C**** WIR BRAUCHEN AUCH NOCH DIE NEUEN 4-IMPULSE DER KETTENENDEN
C
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
C-----------------------------------------
      IREJ=0
      IF(AMMM.LE.AMCH1+AMCH2+0.4D0) THEN
        IREJ=1
        RETURN
      ENDIF
C
      EK1=(AMMM**2-AMCH2**2 + AMCH1**2)/(2.*AMMM)
      EK2=AMMM - EK1
C     PZK1=SIGN(PZK1,QZ1)
      PZK1=SQRT(EK1**2 - AMCH1**2)
              PZK1=DSIGN(PZK1,QZ1)
C     PZK2=SIGN(PZK2,QZ2)
      PZK2=SQRT(EK2**2 - AMCH2**2)
              PZK2=DSIGN(PZK2,QZ2)
      PXK1=0.
      PYK1=0.
      PXK2=0.
      PYK2=0.
      QTX2=PXK2
      QTY2=PYK2
      QZ2=PZK2
      QE2=EK2
      QTX1=PXK1
      QTY1=PYK1
      QZ1=PZK1
      QE1=EK1
C                      ROTATE NEW CHAIN MOMENTA
C                      INTO DIRECTION OF CHAINS BEFORE CORRECTION
C     GAM=(QE1+QE2)/AMMM
C     BGX=(QTX1+QTX2)/AMMM
C     BGY=(QTY1+QTY2)/AMMM
C     BGZ=(QZ1+QZ2)/AMMM
C
C     IF(ABS(GAM-1.D0).GT.1D-4) THEN
C       WRITE(6,'(A,I10,A/6(1PE15.5)/15X,5(1PE15.4))')
C    +  ' CORVAL: INCONSISTENT KINEMATICS OF CHAINS NORIG= ',NORIG,
C    +  ' AMMM,AMCH1,QE1,QTX1,QTY1, QZ1,AMCH2,QE2,QTX2,QTY2,QZ2',
C    +    AMMM,
C    +    AMCH1, QE1,
C    +  QTX1, QTY1, QZ1, AMCH2,QE2, QTX2, QTY2, QZ2
C       IREJ=1
C     ENDIF
C
C     CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PXK1,PYK1,PZK1,EK1,PPPCH1, QTX1,
C    +QTY1,QZ1,QE1)
C     CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PXK2,PYK2,PZK2,EK2,PPPCH2, QTX2,
C    +QTY2,QZ2,QE2)
C     IF(IPRI.GT.1) THEN
CC       WRITE(6,'(2A)') ' CORVAL - CORRECTION OF CHAIN MOMENTA',
C   +  ' IF MASS OF CHAIN 2 HAD TO BE CHANGED'
C     ENDIF
      RETURN
      END
 
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRHH
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       HADRONIZE HARD CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      PARAMETER (INTMX=2488,INTMD=252)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX),
     *                IFROVT(248),ITOVT(248),IFROST(INTMX),
     *             JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),JHKKNT(248),
     *                JHKKPV(INTMX),JHKKPS(INTMX),
     *                JHKKTV(INTMX),JHKKTS(INTMX),
     *                MHKKVV(INTMX),MHKKSS(INTMX),
     &                MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
C-------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
C.....................................................................
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/  ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),
     *ZUOST(INTMX),
     *                INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C
      COMMON /ABRHH/ AMCHH1(INTMX),AMCHH2(INTMX),
     *               GACHH1(INTMX),GACHH2(INTMX),
     *               BGXHH1(INTMX),BGYHH1(INTMX),BGZHH1(INTMX),
     *               BGXHH2(INTMX),BGYHH2(INTMX),BGZHH2(INTMX),
     *               NCHHH1(INTMX),NCHHH2(INTMX),
     *               IJCHH1(INTMX),IJCHH2(INTMX),
     *               PQHHA1(INTMX,4),PQHHA2(INTMX,4),
     *               PQHHB1(INTMX,4),PQHHB2(INTMX,4)
      COMMON /HARDHA/NHARD1,NHKKHA
C
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /PSHOW/ IPSHOW
C     COMMON /HARLUN/ IHARLU,QLUN
      COMMON /HARLUN/ QLUN,IHARLU
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
      COMMON /JSPA/PXS(40000),PYS(40000),PZS(40000),HES(40000),NNNPS
C--------------------
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEP(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
C-------------------
      PARAMETER (NMXHKK=  49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &              JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),PHKK(5,NMXHKK),
     & VHKK(4,NMXHKK),WHKK(4,NMXHKK)
C
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON /PROJK/ IPROJK
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /GLUSPL/NUGLUU,NSGLUU
      COMMON /NOMIJE/ PTMIJE(10),NNMIJE(10)
C
      DIMENSION POJ(4),PAT(4)
      DATA NCALHH /0/
C-----------------------------------------------------------------------
        NHARD1=NHKK+1
        DO 20 I=1,NONUJT
          NCALHH=NCALHH+1
C
          IF (IPHKK.GE.2)WRITE(6,7789)NONUJT,NCALHH
 7789     FORMAT (' HADRHH NONUJT,NCALHH ',2I10)
          IF (JHKKEX(I).EQ.1)THEN
          IF (I.GT.INTMX)THEN
            WRITE (6,7744)I,INTMX
 7744       FORMAT ('  HADRHH I.GT.INTMX  ',2I10)
            RETURN
          ENDIF
C
C++++++++++++++++++++++++++++++    CHAIN 1:  QUARK-ANTIQUARK   +++++++
            IFB1=IJJQ1(I)
            IFB2=IJJAQ1(I)
            IFB2=IABS(IFB2)+6
            DO 21 J=1,4
              POJ(J)=PJETA1(I,J)
              PAT(J)=PJETA2(I,J)
  21        CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,6,NEVT)
            IHARLU=0
            QLUN=0.
            IF(IPSHOW.EQ.1)THEN
              POJPT=SQRT(POJ(2)**2+POJ(1)**2)
              PATPT=SQRT(PAT(1)**2+PAT(2)**2)
	      DO IIII=1,10
              IF(POJPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
              IF(PATPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
	      ENDDO
              QLUN=MIN(POJPT,PATPT)
              IF((QLUN.LT.2.5D0).OR.(AMJCH1(I).LT.5.D0))THEN
                QLUN=0.
                IHARLU=0
              ELSE 
                IHARLU=1
              ENDIF   
            ENDIF
C----------------------------------------------------------------
            IF (GAMJH1(I).LT.0.001D0.OR.AMJCH1(I).LT.2.D0)THEN
            WRITE (6,7788)
     *      I,NHAD,AMJCH1(I),POJ,PAT,GAMJH1(I),BGXJH1(I),
     *      BGYJH1(I),BGZJH1(I),IFB1,IFB2,IFB3,IFB4,JHKKEX(I)
 7788       FORMAT (' HADRHH ',2I5,8E12.2/5E12.2,5I5)
            GO TO 9977
            ENDIF
            CALL HADJET(NHAD,AMJCH1(I),POJ,PAT,GAMJH1(I),BGXJH1(I),
     *              BGYJH1(I),BGZJH1(I),IFB1,IFB2,IFB3,IFB4,
     *              13,13,3,0,13)
            ACOUHH=ACOUHH+1
            IHARLU=0
            QLUN=0.
            NHKKAU=NHKK+1
	    IF(IPHKK.GE.3)WRITE(6,*)' HADRHH:NHKK,NHKKAU ',NHKK,NHKKAU
            IF (NHAD.GT.NFIMAX) THEN
              WRITE (6,7755)NHAD,NFIMAX
 7755         FORMAT (' NHAD.GT.NFIMAX ',2I10)
              RETURN
            ENDIF
            DO 22 J=1,NHAD
C             NHKK=NHKK+1
              IF (NHKK.EQ.NMXHKK) THEN
                WRITE (*,'(A,2I5/A)') ' HADRHH: NHKK.EQ.NMXHKK ',
     *          NHKK,NMXHKK
                RETURN
              ENDIF
C
              EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
              IF (ABS(EHECC-HEP(J)).GT.0.001D0) THEN
C               WRITE(*,'(2A/3I5,3E15.6)')
C    &            ' HADRSV / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALHH, NHKK,NREF(J), HEP(J),EHECC, AMF(J)',
C    *            NCALHH, NHKK,NREF(J), HEP(J),EHECC, AMF(J)
                HEP(J)=EHECC
              ENDIF
              ANNHH=ANNHH+1.
              EEHH=EEHH+HEP(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
              PTHH=SQRT(PXF(J)**2+PYF(J)**2)+PTHH
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKHH(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEP(J),NHKKAU,IORMO(J))
              IF(IDHKK(NHKK).EQ.99999) WRITE (6,5009)NHKK,NREF(J),
     *                                               IDHKK(NHKK)
 	 IF(IPHKK.GE.3) WRITE(6,*)' First chain HADRHH'
              IF (IPHKK.GE.3) WRITE(6,5001) NHKK,
     *        ISTHKK(NHKK),IDHKK(NHKK),JMOHKK(1,NHKK),JMOHKK(2,NHKK),
     &        JDAHKK(1,NHKK),JDAHKK(2,NHKK),(PHKK(KHKK,NHKK),KHKK=1,5),
     &        (VHKK(KHKK,NHKK),KHKK=1,4)
   22       CONTINUE
C           JDAHKK(1,IMOHKK)=NHKKAU
C           JDAHKK(2,IMOHKK)=NHKK
          IF(NNNPJ.GE.1)THEN
            NNNPSO=NNNPS
            NNNPS=NNNPS+1
            NNNPSU=NNNPSO+NNNPJ
            DO 137 J=NNNPS,NNNPSU
              JJ=J-NNNPS+1
              IF(J.GT.40000.OR.JJ.GT.1000)THEN
C               WRITE(6,'(A,2I10)')' J.gt.40000.or.jj.gt.1000 ',J,JJ
                GO TO 137
              ENDIF
	      PXS(J)=PXJ(JJ)
	      PYS(J)=PYJ(JJ)
	      PZS(J)=PZJ(JJ)
	      HES(J)=HEJ(JJ)
  137      CONTINUE
            NNNPS=NNNPS+NNNPJ-1
          ENDIF
 9977       continue
C+++++++++++++++++++++++++++++   CHAIN 2:  AQUARK-QUARK  ++++++++++++++
            IF (NUGLUU.EQ.1) GO TO 5111
            IFB1=IJJAQ2(I)
            IFB2=IJJQ2(I)
            IFB1=IABS(IFB1)+6
            DO 23 J=1,4
              POJ(J)=PJETB1(I,J)
              PAT(J)=PJETB2(I,J)
  23        CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,6,NEVT)
            IHARLU=0
            QLUN=0.
            IF(IPSHOW.EQ.1)THEN
              POJPT=SQRT(POJ(2)**2+POJ(1)**2)
              PATPT=SQRT(PAT(1)**2+PAT(2)**2)
	      DO IIII=1,10
              IF(POJPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
              IF(PATPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
	      ENDDO
              QLUN=MIN(POJPT,PATPT)
              IF((QLUN.LT.2.5D0).OR.(AMJCH2(I).LT.5.D0))THEN
                QLUN=0.
                IHARLU=0
              ELSE 
                IHARLU=1
              ENDIF   
            ENDIF
C
            CALL HADJET(NHAD,AMJCH2(I),POJ,PAT,GAMJH2(I),BGXJH2(I),
     *                BGYJH2(I),BGZJH2(I),IFB1,IFB2,IFB3,IFB4,
     *                13,13,3,0,14)
            IHARLU=0
            QLUN=0.
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
            NHKKAU=NHKK+1
          DO 24 J=1,NHAD
C           NHKK=NHKK+1
            IF (NHKK.EQ.NMXHKK) THEN
              WRITE (*,'(A,2I5/A)') ' HADRHH: NHKK.EQ.NMXHKK ',
     &                               NHKK,NMXHKK
              RETURN
            ENDIF
C
            EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
            IF (ABS(EHECC-HEP(J)).GT.0.001D0) THEN
C             WRITE(*,'(2A/3I5,3E15.6)')
C    &            ' HADRHH / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALHH, NHKK,NREF(J), HEP(J),EHECC, AMF(J)',
C    *            NCALHH, NHKK,NREF(J), HEP(J),EHECC, AMF(J)
              HEP(J)=EHECC
            ENDIF
            ANNHH=ANNHH+1.
            EEHH=EEHH+HEP(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
            PTHH=SQRT(PXF(J)**2+PYF(J)**2)+PTHH
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKHH(I),0,
     *                PXF(J),PYF(J),PZF(J),HEP(J),NHKKAU,IORMO(J))
            IF(IDHKK(NHKK).EQ.99999) WRITE (6,5009)NHKK,NREF(J),
     *                                             IDHKK(NHKK)
C	  WRITE(6,*)' Second chain HADRHH'
            IF (IPHKK.GE.7) WRITE(6,5001) NHKK,
     *      ISTHKK(NHKK),IDHKK(NHKK),JMOHKK(1,NHKK),JMOHKK(2,NHKK),
     &      JDAHKK(1,NHKK),JDAHKK(2,NHKK),(PHKK(KHKK,NHKK),KHKK=1,5),
     &      (VHKK(KHKK,NHKK),KHKK=1,4)
   24     CONTINUE
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
          IF(NNNPJ.GE.1)THEN
            NNNPSO=NNNPS
            NNNPS=NNNPS+1
            NNNPSU=NNNPSO+NNNPJ
            DO 187 J=NNNPS,NNNPSU
              JJ=J-NNNPS+1
              IF(J.GT.40000.OR.JJ.GT.1000)THEN
C               WRITE(6,'(A,2I10)')' J.gt.40000.or.jj.gt.1000 ',J,JJ
                GO TO 187
              ENDIF
	      PXS(J)=PXJ(JJ)
	      PYS(J)=PYJ(JJ)
	      PZS(J)=PZJ(JJ)
	      HES(J)=HEJ(JJ)
  187      CONTINUE
            NNNPS=NNNPS+NNNPJ-1
          ENDIF
 5111   CONTINUE
        ENDIF
   20   CONTINUE
        CALL DECHKK(NHARD1)
        NHKKHA=NHKK
C----------------------------------------------------------------
C
      RETURN
 5001 FORMAT (I6,I4,5I6,9E10.2)
 5003 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 5009 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C
C********************************************************************
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRZZ
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       HADRONIZE HARD CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      PARAMETER (INTMX=2488,INTMD=252)
      COMMON /ABRZZ/ AMCZZ1(INTMX),AMCZZ2(INTMX),
     *               GACZZ1(INTMX),GACZZ2(INTMX),
     *               BGXZZ1(INTMX),BGYZZ1(INTMX),BGZZZ1(INTMX),
     *               BGXZZ2(INTMX),BGYZZ2(INTMX),BGZZZ2(INTMX),
     *               NCHZZ1(INTMX),NCHZZ2(INTMX),
     *               IJCZZ1(INTMX),IJCZZ2(INTMX),
     *               PQZZA1(INTMX,4),PQZZA2(INTMX,4),
     *               PQZZB1(INTMX,4),PQZZB2(INTMX,4)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX),
     *                IFROVT(248),ITOVT(248),IFROST(INTMX),
     *            JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),JHKKNT(248),
     *                JHKKPV(INTMX),JHKKPS(INTMX),
     *                JHKKTV(INTMX),JHKKTS(INTMX),
     *                MHKKVV(INTMX),MHKKSS(INTMX),
     &                MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
C-------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
C.....................................................................
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/  ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),
     *ZUOST(INTMX),
     *                INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C
C
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /PSHOW/ IPSHOW
C     COMMON /HARLUN/ IHARLU,QLUN
      COMMON /HARLUN/ QLUN,IHARLU
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
      COMMON /JSPA/PXS(40000),PYS(40000),PZS(40000),HES(40000),NNNPS
C--------------------
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEP(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
C-------------------
      PARAMETER (NMXHKK=  49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &             JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),PHKK(5,NMXHKK),
     & VHKK(4,NMXHKK),WHKK(4,NMXHKK)
C
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON /PROJK/ IPROJK
      COMMON /GLUSPL/NUGLUU,NSGLUU
      COMMON /NOMIJE/ PTMIJE(10),NNMIJE(10)
C
      DIMENSION POJ(4),PAT(4)
      DATA NCALZZ /0/
C-----------------------------------------------------------------------
        DO 20 I=1,NONUST
          IF(NCH1(I).EQ.99.OR.NCH1(I).EQ.88)GO TO 20
          IF(NCH2(I).EQ.99.OR.NCH2(I).EQ.88)GO TO 20
          NCALZZ=NCALZZ+1
C
          IF (IPHKK.GE.7)WRITE(6,7789)NONUST,NCALZZ,jhkksx(i)
 7789     FORMAT (' HADRZZ NONUST,NCALZZ,Jhkksx(i) ',3I10)
          IF (JHKKSX(I).EQ.1)THEN
          IF (I.GT.INTMX)THEN
            WRITE (6,7744)I,INTMX
 7744       FORMAT ('  HADRZZ I.GT.INTMX  ',2I10)
            RETURN
          ENDIF
C
C++++++++++++++++++++++++++++++    CHAIN 1:  QUARK-DIQUARK   +++++++++++
            IFB1=IJSQ1(I)
            IFB2=IJSAQ1(I)
            IFB2=IABS(IFB2)+6
            DO 21 J=1,4
              POJ(J)=PSOFA1(I,J)
              PAT(J)=PSOFA2(I,J)
  21        CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,5,NEVT)
            IHARLU=0
            QLUN=0.
            IF(IPSHOW.EQ.1)THEN
              POJPT=SQRT(POJ(2)**2+POJ(1)**2)
              PATPT=SQRT(PAT(1)**2+PAT(2)**2)
	      DO IIII=1,10
              IF(POJPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
              IF(PATPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
	      ENDDO
              QLUN=MIN(POJPT,PATPT)
              IF((QLUN.LT.2.5D0).OR.(AMCCH1(I).LT.5.D0))THEN
                QLUN=0.
                IHARLU=0
              ELSE 
                IHARLU=1
              ENDIF   
            ENDIF
C----------------------------------------------------------------
            IF (GAMCH1(I).LT.0.001D0)WRITE (6,7788)
     *      I,NHAD,AMCCH1(I),POJ,PAT,GAMCH1(I),BGXCH1(I),
     *      BGYCH1(I),BGZCH1(I),IFB1,IFB2,IFB3,IFB4,JHKKSX(I)
 7788       FORMAT (' HADRZZ ',2I5,10E12.2/3E12.2,5I5)
            CALL HADJET(NHAD,AMCCH1(I),POJ,PAT,GAMCH1(I),BGXCH1(I),
     *              BGYCH1(I),BGZCH1(I),IFB1,IFB2,IFB3,IFB4,
     *              IJCZZ1(i),IJCZZ1(i),3,NCHZZ1(i),23)
            ACOUZZ=ACOUZZ+1
            IHARLU=0
            QLUN=0.
            NHKKAU=NHKK+1
            IF (NHAD.GT.NFIMAX) THEN
              WRITE (6,7755)NHAD,NFIMAX
 7755         FORMAT (' NHAD.GT.NFIMAX ',2I10)
              RETURN
            ENDIF
            DO 22 J=1,NHAD
C             NHKK=NHKK+1
              IF (NHKK.EQ.NMXHKK) THEN
                WRITE (*,'(A,2I5/A)') ' HADRZZ: NHKK.EQ.NMXHKK ',
     *          NHKK,NMXHKK
                RETURN
              ENDIF
C
              EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
              IF (ABS(EHECC-HEP(J)).GT.0.001D0) THEN
C               WRITE(*,'(2A/3I5,3E15.6)')
C    &            ' HADRZZ / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALZZ, NHKK,NREF(J), HEP(J),EHECC, AMF(J)',
C    *            NCALHH, NHKK,NREF(J), HEP(J),EHECC, AMF(J)
                HEP(J)=EHECC
              ENDIF
              ANNZZ=ANNZZ+1.
              EEZZ=EEZZ+HEP(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
              PTZZ=SQRT(PXF(J)**2+PYF(J)**2)+PTZZ
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKHH(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEP(J),NHKKAU,IORMO(J))
              IF(IDHKK(NHKK).EQ.99999) WRITE (6,5009)NHKK,NREF(J),
     *                                               IDHKK(NHKK)
C	  WRITE(6,*)' First chain HADRZZ'
              IF (IPHKK.GE.7) WRITE(6,5001) NHKK,
     *        ISTHKK(NHKK),IDHKK(NHKK),JMOHKK(1,NHKK),JMOHKK(2,NHKK),
     &        JDAHKK(1,NHKK),JDAHKK(2,NHKK),(PHKK(KHKK,NHKK),KHKK=1,5),
     &        (VHKK(KHKK,NHKK),KHKK=1,4)
   22       CONTINUE
C           JDAHKK(1,IMOHKK)=NHKKAU
C           JDAHKK(2,IMOHKK)=NHKK
          IF(NNNPJ.GE.1)THEN
            NNNPSO=NNNPS
            NNNPS=NNNPS+1
            NNNPSU=NNNPSO+NNNPJ
            DO 137 J=NNNPS,NNNPSU
              JJ=J-NNNPS+1
              IF(J.GT.40000.OR.JJ.GT.1000)THEN
C               WRITE(6,'(A,2I10)')' J.gt.40000.or.jj.gt.1000 ',J,JJ
                GO TO 137
              ENDIF
	      PXS(J)=PXJ(JJ)
	      PYS(J)=PYJ(JJ)
	      PZS(J)=PZJ(JJ)
	      HES(J)=HEJ(JJ)
  137      CONTINUE
            NNNPS=NNNPS+NNNPJ-1
          ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2:  AQUARK-QUARK  ++++++++++++++
            IFB1=IJSAQ2(I)
            IFB2=IJSQ2(I)
            IFB1=IABS(IFB1)+6
            DO 23 J=1,4
              POJ(J)=PSOFB1(I,J)
              PAT(J)=PSOFB2(I,J)
  23        CONTINUE
        PT1=SQRT(POJ(1)**2+POJ(2)**2)
        PT2=SQRT(PAT(1)**2+PAT(2)**2)
        CALL PARPT(2,PT1,PT2,5,NEVT)
            IHARLU=0
            QLUN=0.
            IF(IPSHOW.EQ.1)THEN
              POJPT=SQRT(POJ(2)**2+POJ(1)**2)
              PATPT=SQRT(PAT(1)**2+PAT(2)**2)
	      DO IIII=1,10
              IF(POJPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
              IF(PATPT.GE.PTMIJE(IIII))NNMIJE(IIII)=
     *	      NNMIJE(IIII)+1
	      ENDDO
              QLUN=MIN(POJPT,PATPT)
              IF((QLUN.LT.2.5D0).OR.(AMCCH2(I).LT.5.D0))THEN
                QLUN=0.
                IHARLU=0
              ELSE 
                IHARLU=1
              ENDIF   
            ENDIF
C                                             TURN 20.8.91
            CALL HADJET(NHAD,AMCCH2(I),PAT,POJ,GAMCH2(I),BGXCH2(I),
     *                BGYCH2(I),BGZCH2(I),IFB1,IFB2,IFB3,IFB4,
     *              IJCZZ2(i),IJCZZ2(i),3,NCHZZ2(i),24)
            IHARLU=0
            QLUN=0.
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
            NHKKAU=NHKK+1
          DO 24 J=1,NHAD
C           NHKK=NHKK+1
            IF (NHKK.EQ.NMXHKK) THEN
              WRITE (*,'(A,2I5/A)') ' HADRZZ: NHKK.EQ.NMXHKK ',
     &                               NHKK,NMXHKK
              RETURN
            ENDIF
C
            EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
            IF (ABS(EHECC-HEP(J)).GT.0.001D0) THEN
C             WRITE(*,'(2A/3I5,3E15.6)')
C    &            ' HADRZZ / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALZZ, NHKK,NREF(J), HEP(J),EHECC, AMF(J)',
C    *            NCALZZ, NHKK,NREF(J), HEP(J),EHECC, AMF(J)
              HEP(J)=EHECC
            ENDIF
            ANNZZ=ANNZZ+1.
            EEZZ=EEZZ+HEP(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
            PTZZ=SQRT(PXF(J)**2+PYF(J)**2)+PTZZ
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKHH(I),0,
     *                PXF(J),PYF(J),PZF(J),HEP(J),NHKKAU,IORMO(J))
            IF(IDHKK(NHKK).EQ.99999) WRITE (6,5009)NHKK,NREF(J),
     *                                             IDHKK(NHKK)
C	  WRITE(6,*)' Second chain HADRZZ'
            IF (IPHKK.GE.7) WRITE(6,5001) NHKK,
     *      ISTHKK(NHKK),IDHKK(NHKK),JMOHKK(1,NHKK),JMOHKK(2,NHKK),
     &      JDAHKK(1,NHKK),JDAHKK(2,NHKK),(PHKK(KHKK,NHKK),KHKK=1,5),
     &      (VHKK(KHKK,NHKK),KHKK=1,4)
   24     CONTINUE
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
          IF(NNNPJ.GE.1)THEN
            NNNPSO=NNNPS
            NNNPS=NNNPS+1
            NNNPSU=NNNPSO+NNNPJ
            DO 187 J=NNNPS,NNNPSU
              JJ=J-NNNPS+1
              IF(J.GT.40000.OR.JJ.GT.1000)THEN
C               WRITE(6,'(A,2I10)')' J.gt.40000.or.jj.gt.1000 ',J,JJ
                GO TO 187
              ENDIF
	      PXS(J)=PXJ(JJ)
	      PYS(J)=PYJ(JJ)
	      PZS(J)=PZJ(JJ)
	      HES(J)=HEJ(JJ)
  187      CONTINUE
            NNNPS=NNNPS+NNNPJ-1
          ENDIF
 5111   CONTINUE
        ENDIF
   20   CONTINUE
C----------------------------------------------------------------
C
      RETURN
 5001 FORMAT (I6,I4,5I6,9E10.2)
 5003 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 5009 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      
      SUBROUTINE QINNUC(X,Y)

C  Este programa genera una distribucion de partones de tipo gaussiana
C  centrada en el centro del hadron. Distribucion: F(b)=A*(-b**2/c).
C  La distribucion la generamos en coordenadas polares porque asi
C  tenemos primitiva.
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      SAVE

      CHARACTER*80 TITLE
      CHARACTER*8 PROJTY,TARGTY
C     COMMON/USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    &           ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
                
      C=4.*(0.15D-24+0.01D-24*LOG(CMENER))
  10  P=RNDM(V1)
      IF ((P). EQ .(1.D0)) THEN
         GO TO 10
      END IF
      Z=RNDM(V2)
      T=2.*3.1416*Z
      R=DSQRT(-C*DLOG(1.D00-P))
      X=R*DCOS(T)
      Y=R*DSIN(T)

      RETURN
      END

C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE CASAVS
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C-------------------------
C
C                       Casado diquarks VS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C-------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,ABRVS.
      COMMON /ABRVS/ AMCVS1(248),AMCVS2(248),GACVS1(248),GACVS2(248),
     +BGXVS1(248),BGYVS1(248),BGZVS1(248), BGXVS2(248),BGYVS2(248),
     +BGZVS2(248), NCHVS1(248),NCHVS2(248),IJCVS1(248),IJCVS2(248),
     +PQVSA1(248,4),PQVSA2(248,4), PQVSB1(248,4),PQVSB2(248,4)
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEND.
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      COMMON /CASADI/CASAXX,ICASAD
C---------------------
C-----------------------------------------------------------------------
      DO 50 I=1,NVS
C-----------------------drop recombined chain pairs
        IF(NCHVS1(I).EQ.99.AND.NCHVS2(I).EQ.99) GO TO 50
        IS1=INTVS1(I)
        IS2=INTVS2(I)
C
        IF (IPCO.GE.6) WRITE (6,1010) IPVQ(IS1),IPPV1(IS1),IPPV2(IS1),
     +  ITSQ(IS2),ITSAQ(IS2), AMCVS1(I),AMCVS2(I),GACVS1(I),GACVS2(I),
     +  BGXVS1(I),BGYVS1(I),BGZVS1(I), BGXVS2(I),BGYVS2(I),BGZVS2(I),
     +  NCHVS1(I),NCHVS2(I),IJCVS1(I),IJCVS2(I), PQVSA1(I,4),PQVSA2
     +  (I,4),PQVSB1(I,4),PQVSB2(I,4)
C
C
C++++++++++++++++++++++++++++++    CHAIN 2:  DIQUARK-QUARK   +++++++++++
        IFB1=IPPV1(IS1)
        IFB2=IPPV2(IS1)
        IFB3=ITSQ(IS2)
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain     
C               Projectile Nr ippp= IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
       IPPP = IFROVP(INTVS1(I))
       JIPP=JSSHS(IPPP)
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' VS qq-q ,IFB1,IFB2,IFB3,',
     *	'INTVS1=IS1,INTVS2=IS2,JIPP,JITTX',
     *	IFB1,IFB2,IFB3,INTVS1(I),INTVS2(I),JIPP,JITTX
        WRITE (6,*)' target sea quark IFB3=',IFB3,
     *	' from IS2=',INTVS2(I)
        WRITE(6,*)' with ITSQ(IS2),XTSQ(IS2),IFROST(IS2)',
     *	ITSQ(IS2),XTSQ(IS2),IFROST(IS2)
       ENDIF
        DO 797 II=1,IXTV
	  IF(IFROST(IS2).EQ.IFROVT(II))III=II
  797   CONTINUE	
      IF(IPCO.GE.1)THEN
        WRITE (6,*)' projectile III=',III
        WRITE(6,*)' corresp. XTVQ(i),XTVD(i),ITVQ(I),ITTV1(I),ITTV2(I)',
     *   XTVQ(III),XTVD(III),ITVQ(III),ITTV1(III),ITTV2(III)
       ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C+++++++++++++++++++++++++++++ VS   CHAIN 2:  DIQUARK-QUARK   +++++++++
C-------------------------------------------------------------------    
C      IF(ICASAD.EQ.1.AND.IBPROJ.NE.0)THEN
       IF(ICASAD.EQ.1)THEN
         IF(RNDM(VV).LE.CASAXX)THEN
	   IF(RNDM(VVV).LE.0.5D0)THEN
	     ISCASA=ITSQ(IS2) 
	     ITVCAS=ITTV1(III)
	     ITSQ(IS2)=ITVCAS
	     ITTV1(III)=ISCASA
	     IFB3=ITSQ(IS2)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas VS2 qq-q 1 ,IFB1,IFB2,IFB3,',
     *         'INTVS1=IS1,INTVS2=IS2,III',
     *         IFB1,IFB2,IFB3,INTVS1(I),INTVS2(I),III
     *         ,'-----------------------------------------------------'
             ENDIF
	   ELSE
	     ISCASA=ITSQ(IS2) 
	     ITVCAS=ITTV2(III)
	     ITSQ(IS2)=ITVCAS
	     ITTV2(III)=ISCASA
	     IFB3=ITSQ(IS2)
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' Cas VS2 qq-q 2 ,IFB1,IFB2,IFB3,',
     *	'INTVS1=IS1,INTVS2=IS2,III',
     *	IFB1,IFB2,IFB3,INTVS1(I),INTVS2(I),III
     *  ,'-----------------------------------------------------'
       ENDIF
	   ENDIF
	 ENDIF
       ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C-------------------------------------------------------------------    
   50 CONTINUE
C
      RETURN
 1010 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
      END
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE CASASV
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       Casado diquarks SV
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,ABRSV.
      COMMON /ABRSV/ AMCSV1(248),AMCSV2(248),GACSV1(248),GACSV2(248),
     +BGXSV1(248),BGYSV1(248),BGZSV1(248), BGXSV2(248),BGYSV2(248),
     +BGZSV2(248), NCHSV1(248),NCHSV2(248),IJCSV1(248),IJCSV2(248),
     +PQSVA1(248,4),PQSVA2(248,4), PQSVB1(248,4),PQSVB2(248,4)
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEND.
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      COMMON /CASADI/CASAXX,ICASAD
C---------------------
      DATA NCALSV /0/
C-----------------------------------------------------------------------
      NCALSV=NCALSV+1
      DO 50 I=1,NSV
C-----------------------drop recombined chain pairs
        IF(NCHSV1(I).EQ.99.AND.NCHSV2(I).EQ.99) GO TO 50
        IS1=INTSV1(I)
        IS2=INTSV2(I)
C
        IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITVQ(IS2),
     +  ITTV1(IS2),ITTV2(IS2), AMCSV1(I),AMCSV2(I),GACSV1(I),GACSV2(I),
     +  BGXSV1(I),BGYSV1(I),BGZSV1(I), BGXSV2(I),BGYSV2(I),BGZSV2(I),
     +  NCHSV1(I),NCHSV2(I),IJCSV1(I),IJCSV2(I), PQSVA1(I,4),PQSVA2
     +  (I,4),PQSVB1(I,4),PQSVB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  QUARK-DIQUARK   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=ITTV1(IS2)
        IFB3=ITTV2(IS2)
C------------------------------------------------------------------
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain     
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
       ITTT = IFROVT(INTSV2(I))
       JITT=JTSHS(ITTT)
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
      IF(IPCO.GE.1)THEN
        WRITE(6,*)' SV q-qq ,IFB1,IFB2,IFB3,',
     *	'INTSV1=IS1,INTSV2=IS2,JIPPX,JITT',
     *	IFB1,IFB2,IFB3,INTSV1(I),INTSV2(I),JIPPX,JITT
        WRITE (6,*)' projectile sea quark IFB1=',IFB1,
     *	' from IS1=',INTSV1(I)
        WRITE(6,*)' with IPSQ(IS1),XPSQ(IS1),IFROSP(IS1)',
     *	IPSQ(IS1),XPSQ(IS1),IFROSP(IS1)
       ENDIF
        DO 798 II=1,IXPV
	  IF(IFROSP(IS1).EQ.IFROVP(II))III=II
  798   CONTINUE	
      IF(IPCO.GE.1)THEN
        WRITE (6,*)' projectile III=',III
        WRITE(6,*)' corresp. XPVQ(i),XPVD(i),IPVQ(I),IPPV1(I),IPPV2(I)',
     *   XPVQ(III),XPVD(III),IPVQ(III),IPPV1(III),IPPV2(III)
       ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C++++++++++++++++++++++++++++ SV   CHAIN 1:  QUARK-DIQUARK   +++++++++++
C-------------------------------------------------------------------    
C      IF(ICASAD.EQ.1.AND.IBPROJ.NE.0)THEN
       IF(ICASAD.EQ.1)THEN
         IF(RNDM(VV).LE.CASAXX)THEN
	   IF(RNDM(VVV).LE.0.5D0)THEN
	     ISCASA=IPSQ(IS1) 
	     IPVCAS=IPPV1(III)
	     IPSQ(IS1)=IPVCAS
	     IPPV1(III)=ISCASA
	     IFB1=IPSQ(IS1)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas SV1 q-qq 1 ,IFB1,IFB2,IFB3,',
     *           'INTSV1=IS1,INTSV2=IS2,JIPPX,JITT,III',
     *           IFB1,IFB2,IFB3,INTSV1(I),INTSV2(I),JIPPX,JITT,III
     *          ,'-----------------------------------------------------'
             ENDIF
	   ELSE
	     ISCASA=IPSQ(IS1) 
	     IPVCAS=IPPV2(III)
	     IPSQ(IS1)=IPVCAS
	     IPPV2(III)=ISCASA
	     IFB1=IPSQ(IS1)
             IF(IPCO.GE.1)THEN
               WRITE(6,*)' Cas SV1 q-qq 2 ,IFB1,IFB2,IFB3,',
     *           'INTSV1=IS1,INTSV2=IS2,JIPPX,JITT,III',
     *           IFB1,IFB2,IFB3,INTSV1(I),INTSV2(I),JIPPX,JITT,III
     *         ,'-----------------------------------------------------'
             ENDIF
	   ENDIF
	 ENDIF
       ENDIF
C------------------------------------------------------------------- 
C                         Casado diquark option
C-------------------------------------------------------------------    
   50 CONTINUE
C----------------------------------------------------------------
C
      RETURN
      END
*CMZ :  1.00/00 27/11/91  17.09.38  by  H.-J. Mhring
*-- Author :
C-------------------------------------------------------------------
C
C                              FILE DMNUC4.FOR
C
C-------------------------------------------------------------------
C
C                               Sample according to Poisson distribution
      FUNCTION NPOISS(AVN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      EXPAVN=EXP(-AVN)
      K=1
      A=1.
   10 CONTINUE
      U=RNDM(V)
      A=U*A
      IF(A.LT.EXPAVN)THEN
        NPOISS=K-1
        RETURN
      ELSE
        K=K+1
        GO TO 10
      ENDIF
      END
C
C--------------------------------------------------------------------
C------------------------------------------------------------------
C
C                 FILE DPMSEWEW FORTRAN
C
C------------------------------------------------------------------
      SUBROUTINE SEWEW(IOP,NHKKH1)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C*** 1=P,  2=N, 3=PI+, 4=PI-, 5=PIO, 6=GAM+HYP, 7=K, 8=ANUC, 9=CHARGED
C*** 10=TOT, 11=TOTHAD
C
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (TINY= 1.D-5)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      COMMON /WEWEVT/ IYWEW(NMXHKK),IRWEW(NMXHKK),IIYWEW(2600),
     &               IIRWEW(2600),WEWEW(2600),IDWEW1(2600),
     &               IDWEW2(2600),IDWEW(2600),IBLOCK(NMXHKK),
     &               IDWEWW(2600)
C
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,TNUCFI.
      COMMON /TNUCFI/ AMTFIN,AMFINO,EEXCTA,PTFINX,PTFINY,PTFINZ,PTFINE,
     +                ITFIN,ITZFIN,NNTAR,NPTAR,NHTAR,NQTAR,NPARF
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.

C                                   modified DPMJET
       COMMON /BUFUES/ BNNVV,BNNSS,BNNSV,BNNVS,BNNCC,
     *                 BNNDV,BNNVD,BNNDS,BNNSD,
     *                 BNNHH,BNNZZ,
     *                 BPTVV,BPTSS,BPTSV,BPTVS,BPTCC,BPTDV,
     *                 BPTVD,BPTDS,BPTSD,
     *                 BPTHH,BPTZZ,
     *                 BEEVV,BEESS,BEESV,BEEVS,BEECC,BEEDV,
     *                 BEEVD,BEEDS,BEESD,
     *                 BEEHH,BEEZZ
     *                ,BNNDI,BPTDI,BEEDI
     *                ,BNNZD,BNNDZ,BPTZD,BPTDZ,BEEZD,BEEDZ
       COMMON /NCOUCS/ BCOUVV,BCOUSS,BCOUSV,BCOUVS,
     *                 BCOUZZ,BCOUHH,BCOUDS,BCOUSD,
     *                 BCOUDZ,BCOUZD,BCOUDI,
     *                 BCOUDV,BCOUVD,BCOUCC
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /EVENTA/IDUMTP
      COMMON /HBOO/IHBOOK
C  1 2 Transverse rapidity  densities (rap, p,pi-, trans. dist. (fermi))
C  3 4 Transverse rapidity  densities (rap,ap,pi+, trans. dist. (fermi))
C  5 6 Transverse rapidity  densities (rap,La,aLa, trans. dist. (fermi))
C  7 8 Transverse rapidity  densities (rap,n ,an , trans. dist. (fermi))
C  9   Transverse rapidity  densities (rap,pi0   , trans. dist. (fermi))
      DIMENSION YYLTRA(40,9,41),TRANSA(40),DYYLAM(40),DYALAM(40),
     *XYLTRA(40,9,41)
C
      COMMON /SIGLA/SIGLAU
      DIMENSION INDX(28)

      DATA IPRIOP/0/
      DATA INDX/1,8,10,10,10,10,7,2,7,10,10,7,3,4,5,6,
     *          7,7,7,7,7,7,7,7,7,7,7,7/
C----------------------------------------------------------------------
      DATA KPL /1/
      DATA IEVL /0/
C----------------------------------------------------------------------
      ZERO=0
      ONEONE=1
      TWOTWO=2
      NIP=IP
      AIP=IP
C       Transverse Rapidity density
C          DRTRA in Fermi
      DRTRA=0.5D0
      DYTRA=2.65D0
      RDYTRA=RNDM(V)*DYTRA
      DO 1711 J=1,40
        DYYLAM(J)=1.D-18
        DYALAM(J)=1.D-18
        DO 1711 JJ=1,9
          DO 1711 JJJ=1,41
            YYLTRA(J,JJ,JJJ)=1.D-18
            XYLTRA(J,JJ,JJJ)=-12.00+RDYTRA+J*DYTRA
 1711 CONTINUE
      DO 1712 J=1,40
        AJ=J
        TRANSA(J)=3.14D0*(2.D0*AJ-1.D0)*DRTRA**2
 1712 CONTINUE 
C     COMMON /WEWEVT/ IYWEW(NMXHKK),IRWEW(NMXHKK),IIYWEW(500),
C    &               IIRWEW(500),WEWEW(500),IDWEW1(500),IDWEW2(500),
C    &               IDWEW(500)
      DO 1812 I=1,2600
	IIYWEW(I)=0
	IIRWEW(I)=0
	WEWEW(I)=0.D0
	IDWEW1(I)=0
	IDWEW2(I)=0
	IDWEW(I)=0
	IDWEWW(I)=0
 1812 CONTINUE
      DO 1813 I=NHKKH1,NHKK
	IYWEW(I)=0
	IRWEW(I)=0
	IBLOCK(I)=0
 1813 CONTINUE
C     RETURN
C
C-------------------------------------------------------------------
C
  2   CONTINUE
C
      DO 21 I=NHKKH1,NHKK
        IF (ISTHKK(I).EQ.1)THEN
C                                  j.r. temp for s-s
          PTT=PHKK(1,I)**2+PHKK(2,I)**2+0.00001
          PT=SQRT(PTT)+0.001
          NHAD=NHAD+1
          NRHKK=MCIHAD(IDHKK(I))
           IF (NRHKK.LE.0.OR.NRHKK.GT.210)THEN
             NRHKK=1
           ENDIF
          NRE=NRHKK
          ICHHKK=IICH(NRHKK)
          IF (NRE.GT.160) NRE=28
          IF (NRE.LT. 1) NRE=28
          NREX=NRE
          IF(NREX.GE.28)NREX=28
          NI=INDX(NREX)
          NIX=NI
          IF (NRHKK.EQ.9)NIX=12
          IF (NRHKK.EQ.17.OR.NRHKK.EQ.22)NIX=13
          IF (NRHKK.LE.22.AND.NRHKK.GE.20)NIX=14
          IF (NRHKK.EQ.18.OR.NRHKK.EQ.100)NIX=15
          IF (NRHKK.LE.101.AND.NRHKK.GE.99)NIX=16
          IF (NRHKK.EQ.98)NIX=17
          IF (NRHKK.EQ.103)NIX=18
          IF (NRHKK.EQ.12.OR.NRHKK.EQ.19)NIX=19
          IF (NRHKK.EQ.24.OR.NRHKK.EQ.25)NIX=19
          IF(NRE.EQ.28) NI=7
          PT=SQRT(PTT)+0.001
          AMT=SQRT(PTT+PHKK(5,I)**2)
          YL=LOG((ABS(PHKK(3,I)+SQRT(PHKK(3,I)**2+AMT**2)))/AMT+1.E-18)
C         Transverse rapidity Densities
          YLLPS=LOG((ABS(PHKK(3,I)+SQRT(PHKK(3,I)**2+PTT)))/PT
     *               +1.E-18)
          RTRA=SQRT(VHKK(1,I)**2+VHKK(2,I)**2)*1.D12
          IRTRA=RTRA/DRTRA+1.D0
          IF(IRTRA.LT.1)IRTRA=1
          IF(IRTRA.GT.40)IRTRA=40
          IYTRA=(YL+12.00-RDYTRA)/DYTRA+1.D0
          IF(IYTRA.LT.1)IYTRA=1
          IF(IYTRA.GT.40)IYTRA=40
	  IYWEW(I)=IYTRA
	  IRWEW(I)=IRTRA
          IF(NIX.EQ.4)THEN
            YYLTRA(IYTRA,2,IRTRA)=YYLTRA(IYTRA,2,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.3)THEN
            YYLTRA(IYTRA,4,IRTRA)=YYLTRA(IYTRA,4,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.1)THEN
            YYLTRA(IYTRA,1,IRTRA)=YYLTRA(IYTRA,1,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.8)THEN
            YYLTRA(IYTRA,3,IRTRA)=YYLTRA(IYTRA,3,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.13)THEN
            YYLTRA(IYTRA,5,IRTRA)=YYLTRA(IYTRA,5,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.12)THEN
            YYLTRA(IYTRA,8,IRTRA)=YYLTRA(IYTRA,8,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.2)THEN
            YYLTRA(IYTRA,7,IRTRA)=YYLTRA(IYTRA,7,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.15)THEN
            YYLTRA(IYTRA,6,IRTRA)=YYLTRA(IYTRA,6,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ELSEIF(NIX.EQ.23)THEN
            YYLTRA(IYTRA,9,IRTRA)=YYLTRA(IYTRA,9,IRTRA)+
     *                          1.D0/TRANSA(IRTRA)
          ENDIF
        ENDIF
   21 CONTINUE
C     RETURN
C
C--------------------------------------------------------------------
C
  3   CONTINUE
C          Normalization and Printing
C------------------------------------------------------------------
C------------------------------------------------------------------
C      Transverse Rapidity Densities
      DO 1133 I=1,40
        DO 1133 II=1,9
          DO 1133 III=1,40
            YYLTRA(I,II,III)=YYLTRA(I,II,III)/(DYTRA)
            YYLTRA(I,II,41) =YYLTRA(I,II,41) +
     *                       YYLTRA(I,II,III)*TRANSA(III)
 1133 CONTINUE
C      transverse Rapidity Densities
      IF(IPEV.GE.2)THEN
      WRITE(6,'(A)')' Transverse Rapidity Density of proton '
        WRITE(6,37)XYLTRA(1,1,1),(TRANSA(I),I=1,10)
   37   FORMAT(F10.2,10E11.3)
      DO 1136 J=1,40
        WRITE(6,37)XYLTRA(J,1,1),(YYLTRA(J,1,I),I=1,9),YYLTRA(J,1,41)
 1136 CONTINUE
      WRITE(6,'(A)')' Transverse Rapidity Density of pi- '
        WRITE(6,37)XYLTRA(1,1,1),(TRANSA(I),I=1,10)
      DO 1137 J=1,40
        WRITE(6,37)XYLTRA(J,1,1),(YYLTRA(J,2,I),I=1,9),YYLTRA(J,2,41)
 1137 CONTINUE
      WRITE(6,'(A)')' Transverse Rapidity Density of aproton '
        WRITE(6,37)XYLTRA(1,1,1),(TRANSA(I),I=1,10)
      DO 2236 J=1,40
        WRITE(6,37)XYLTRA(J,1,1),(YYLTRA(J,3,I),I=1,9),YYLTRA(J,3,41)
 2236 CONTINUE
      WRITE(6,'(A)')' Transverse Rapidity Density of pi+ '
        WRITE(6,37)XYLTRA(1,1,1),(TRANSA(I),I=1,10)
      DO 2237 J=1,40
        WRITE(6,37)XYLTRA(J,1,1),(YYLTRA(J,4,I),I=1,9),YYLTRA(J,4,41)
 2237 CONTINUE
      WRITE(6,'(A)')' Transverse Rapidity Density of pi0 '
        WRITE(6,37)XYLTRA(1,1,1),(TRANSA(I),I=1,10)
      DO 2238 J=1,40
        WRITE(6,37)XYLTRA(J,1,1),(YYLTRA(J,9,I),I=1,9),YYLTRA(J,9,41)
 2238 CONTINUE
      ENDIF
      IWEW=0
        DO 1134 III=1,40
      DO 1134 I=1,40
C                                   pi- + p --> Lam + K0
	  DELLLA=
     *	  (YYLTRA(I,1,III)-YYLTRA(I,5,III))*YYLTRA(I,2,III)*
     *              TRANSA(III)*0.53D0 
	  DELLLA=DELLLA*DYTRA
C                                   pi+ + n --> Lam + K+
	  DELLLB=
     *	  (YYLTRA(I,7,III)-YYLTRA(I,5,III))*YYLTRA(I,4,III)*
     *              TRANSA(III)*0.53D0 
	  DELLLB=DELLLB*DYTRA
C                                   pi0 + n --> Lam + K0
	  DELLLC=
     *	  (YYLTRA(I,7,III)-YYLTRA(I,5,III))*YYLTRA(I,9,III)*
     *              TRANSA(III)*0.53D0 
	  DELLLC=DELLLC*DYTRA
C                                   pi0 + p --> Lam + K+
	  DELLLD=
     *	  (YYLTRA(I,1,III)-YYLTRA(I,5,III))*YYLTRA(I,9,III)*
     *              TRANSA(III)*0.53D0 
	  DELLLD=DELLLD*DYTRA
C                              3.11.95 Add 0.15* to reduce Lambdas
C    *    0.15*
	  DELLLO=
     *	  (YYLTRA(I,1,III)+YYLTRA(I,7,III)-1.6*YYLTRA(I,5,III))*
     *              TRANSA(III)/3.2
	  DELLLO=DELLLO*DYTRA
	  IF(DELLLA.GT.DELLLO)DELLLA=DELLLO
	  IF(DELLLB.GT.DELLLO)DELLLB=DELLLO
	  IF(DELLLC.GT.DELLLO)DELLLC=DELLLO
	  IF(DELLLD.GT.DELLLO)DELLLD=DELLLO
	  IF(DELLLO.LE.0.D0)DELLLA=0.D0
	  IF(DELLLO.LE.0.D0)DELLLB=0.D0
	  IF(DELLLO.LE.0.D0)DELLLC=0.D0
	  IF(DELLLO.LE.0.D0)DELLLD=0.D0
	  IF(DELLLA.LE.0.D0)DELLLA=0.D0
	  IF(DELLLB.LE.0.D0)DELLLB=0.D0
	  IF(DELLLC.LE.0.D0)DELLLC=0.D0
	  IF(DELLLD.LE.0.D0)DELLLD=0.D0
C                                   pi- + p --> Lam + K0
	  IF(DELLLA.GT.TINY)THEN
	    IDELLL=DELLLA
	    TELLLA=DELLLA-IDELLL
	    IF(RNDM(V).LE.TELLLA)IDELLL=IDELLL+1
	    DELLLA=IDELLL
	    IF (DELLLA.LT.TINY)GO TO 2233
	    DO 556 KKK=1,IDELLL
	      IWEW=IWEW+1
	      WEWEW(IWEW)=DELLLA
	      IDWEW(IWEW)=17
	      IDWEWW(IWEW)=24
	      IDWEW1(IWEW)=1
	      IDWEW2(IWEW)=14
	      IF(IPEV.GE.2)THEN
      	      WRITE (6,'(A,3F10.3,7I5)')'  LAMBDA ',
     *        DELLLA,YYLTRA(I,1,III),YYLTRA(I,2,III),I,III, 
     *        IDWEW(IWEW),IDWEWW(IWEW),IDWEW1(IWEW),IDWEW2(IWEW),
     *        IWEW
	      ENDIF
              DYYLAM(I)=DYYLAM(I)+  DELLLA/DYTRA
  	      IIYWEW(IWEW)=I
 	      IIRWEW(IWEW)=III
  556       CONTINUE
C 	    IYWEW(IWEW)=I
C	    IRWEW(IWEW)=III
 2233       CONTINUE
	  ENDIF
C                                   pi+ + n --> Lam + K+
	  IF(DELLLB.GT.TINY)THEN
	    IDELLL=DELLLB
	    TELLLB=DELLLB-IDELLL
	    IF(RNDM(V).LE.TELLLB)IDELLL=IDELLL+1
	    DELLLB=IDELLL
	    IF (DELLLB.LT.TINY)GO TO 2243
	    DO 557 KKK=1,IDELLL
	      IWEW=IWEW+1
	      WEWEW(IWEW)=DELLLB
	      IDWEW(IWEW)=17
	      IDWEWW(IWEW)=15
	      IDWEW1(IWEW)=8
	      IDWEW2(IWEW)=13
	      IF(IPEV.GE.2)THEN
      	      WRITE (6,'(A,3F10.3,7I5)')'  LAMBDA ',
     *        DELLLB,YYLTRA(I,1,III),YYLTRA(I,2,III),I,III, 
     *        IDWEW(IWEW),IDWEWW(IWEW),IDWEW1(IWEW),IDWEW2(IWEW),
     *        IWEW
	      ENDIF
              DYYLAM(I)=DYYLAM(I)+  DELLLB/DYTRA
  	      IIYWEW(IWEW)=I
 	      IIRWEW(IWEW)=III
  557       CONTINUE
C 	    IYWEW(IWEW)=I
C	    IRWEW(IWEW)=III
 2243       CONTINUE
	  ENDIF
C                                   pi0 + n --> Lam + K0
	  IF(DELLLC.GT.TINY)THEN
	    IDELLL=DELLLC
	    TELLLC=DELLLC-IDELLL
	    IF(RNDM(V).LE.TELLLC)IDELLL=IDELLL+1
	    DELLLC=IDELLL
	    IF (DELLLC.LT.TINY)GO TO 2244
	    DO 558 KKK=1,IDELLL
	      IWEW=IWEW+1
	      WEWEW(IWEW)=DELLLC
	      IDWEW(IWEW)=17
	      IDWEWW(IWEW)=24
	      IDWEW1(IWEW)=8
	      IDWEW2(IWEW)=23
	      IF(IPEV.GE.2)THEN
      	      WRITE (6,'(A,3F10.3,7I5)')'  LAMBDA ',
     *        DELLLC,YYLTRA(I,1,III),YYLTRA(I,2,III),I,III, 
     *        IDWEW(IWEW),IDWEWW(IWEW),IDWEW1(IWEW),IDWEW2(IWEW),
     *        IWEW
	      ENDIF
              DYYLAM(I)=DYYLAM(I)+  DELLLC/DYTRA
  	      IIYWEW(IWEW)=I
 	      IIRWEW(IWEW)=III
  558       CONTINUE
C 	    IYWEW(IWEW)=I
C	    IRWEW(IWEW)=III
 2244       CONTINUE
	  ENDIF
C                                   pi0 + p --> Lam + K+
	  IF(DELLLD.GT.TINY)THEN
	    IDELLL=DELLLD
	    TELLLD=DELLLD-IDELLL
	    IF(RNDM(V).LE.TELLLD)IDELLL=IDELLL+1
	    DELLLD=IDELLL
	    IF (DELLLD.LT.TINY)GO TO 2245
	    DO 559 KKK=1,IDELLL
	      IWEW=IWEW+1
	      WEWEW(IWEW)=DELLLD
	      IDWEW(IWEW)=17
	      IDWEWW(IWEW)=15
	      IDWEW1(IWEW)=1
	      IDWEW2(IWEW)=23
	      IF(IPEV.GE.2)THEN
      	      WRITE (6,'(A,3F10.3,7I5)')'  LAMBDA ',
     *        DELLLD,YYLTRA(I,1,III),YYLTRA(I,2,III),I,III, 
     *        IDWEW(IWEW),IDWEWW(IWEW),IDWEW1(IWEW),IDWEW2(IWEW),
     *        IWEW
	      ENDIF
              DYYLAM(I)=DYYLAM(I)+  DELLLD/DYTRA
  	      IIYWEW(IWEW)=I
 	      IIRWEW(IWEW)=III
  559       CONTINUE
C 	    IYWEW(IWEW)=I
C	    IRWEW(IWEW)=III
 2245       CONTINUE
	  ENDIF
C     COMMON /WEWEVT/ IYWEW(NMXHKK),IRWEW(NMXHKK),IIYWEW(500),
C    &               IIRWEW(500),WEWEW(500),IDWEW1(500),IDWEW2(500),
C    &               IDWEW(500)
C                          pi+ + pb --> aLam + aK0
	  DELALA=
     *	  (YYLTRA(I,3,III)-YYLTRA(I,6,III))*YYLTRA(I,4,III)*
     *              TRANSA(III)*0.53D0 
	  DELALA=DELALA*DYTRA
C                          pi- + nb --> aLam + aK-
	  DELALB=
     *	  (YYLTRA(I,8,III)-YYLTRA(I,6,III))*YYLTRA(I,2,III)*
     *              TRANSA(III)*0.53D0 
	  DELALB=DELALB*DYTRA
C                              3.11.95 Add 0.15* to reduce Lambdas
C    *    0.15*
	  DELALO=
     *	  (YYLTRA(I,3,III)+YYLTRA(I,8,III)-1.6*YYLTRA(I,6,III))*
     *              TRANSA(III)/3.2 
	  DELALO=DELALO*DYTRA
	  IF(DELALA.GT.DELALO)DELALA=DELALO
	  IF(DELALB.GT.DELALO)DELALB=DELALO
	  IF(DELALO.LE.0.D0)DELALA=0.D0
	  IF(DELALO.LE.0.D0)DELALB=0.D0
	  IF(DELALA.LE.0.D0)DELALA=0.D0
	  IF(DELALB.LE.0.D0)DELALB=0.D0
C                          pi+ + pb --> aLam + aK0
	  IF(DELALA.GT.TINY)THEN
	    IDELAL=DELALA
	    TELALA=DELALA-IDELAL
	    IF(RNDM(V).LE.TELALA)IDELAL=IDELAL+1
	    DELALA=IDELAL
	    IF (DELALA.LT.TINY)GO TO 2234
	    DO 554 KKK=1,IDELAL
	      IWEW=IWEW+1
	      WEWEW(IWEW)=DELALA
	      IDWEW(IWEW)=18
	      IDWEWW(IWEW)=25
	      IDWEW1(IWEW)=2
	      IDWEW2(IWEW)=13
	      IF(IPEV.GE.2)THEN
	      WRITE (6,'(A,3F10.3,7I5)')' ALAMBDA ',
     *        DELALA,YYLTRA(I,3,III),YYLTRA(I,6,III),I,III,             
     *        IDWEW(IWEW),IDWEWW(IWEW),IDWEW1(IWEW),IDWEW2(IWEW),
     *        IWEW
	      ENDIF
              DYALAM(I)=DYALAM(I)+   DELALA/DYTRA
  	      IIYWEW(IWEW)=I
 	      IIRWEW(IWEW)=III
  554       CONTINUE
C 	    IYWEW(IWEW)=I
C	    IRWEW(IWEW)=III
 2234       CONTINUE
	  ENDIF
C                          pi- + nb --> aLam + aK-
	  IF(DELALB.GT.TINY)THEN
	    IDELAL=DELALB
	    TELALB=DELALB-IDELAL
	    IF(RNDM(V).LE.TELALB)IDELAL=IDELAL+1
	    DELALB=IDELAL
	    IF (DELALB.LT.TINY)GO TO 2247
	    DO 555 KKK=1,IDELAL
	      IWEW=IWEW+1
	      WEWEW(IWEW)=DELALB
	      IDWEW(IWEW)=18
	      IDWEWW(IWEW)=16
	      IDWEW1(IWEW)=9
	      IDWEW2(IWEW)=14
	      IF(IPEV.GE.2)THEN
	      WRITE (6,'(A,3F10.3,7I5)')' ALAMBDA ',
     *        DELALB,YYLTRA(I,3,III),YYLTRA(I,6,III),I,III,             
     *        IDWEW(IWEW),IDWEWW(IWEW),IDWEW1(IWEW),IDWEW2(IWEW),
     *        IWEW
	      ENDIF
              DYALAM(I)=DYALAM(I)+   DELALB/DYTRA
  	      IIYWEW(IWEW)=I
 	      IIRWEW(IWEW)=III
  555       CONTINUE
C 	    IYWEW(IWEW)=I
C	    IRWEW(IWEW)=III
 2247       CONTINUE
	  ENDIF
 1134 CONTINUE
      IWEWMA=IWEW
      DDLAMN=0.D0
      DALAMN=0.D0
      DO 1139 J=1,40
        DDLAMN=DDLAMN+DYYLAM(J)*DYTRA
        DALAMN=DALAMN+DYALAM(J)*DYTRA
 1139 CONTINUE
	      IF(IPEV.GE.2)THEN
      WRITE(6,'(A,I10,F10.3)')' IWEWMA,Extra Rap. Den. of Lam ,DLAM= '
     *                                            ,IWEWMA ,DDLAMN
      WRITE(6,'(A,I10,F10.3)')' IWEWMA,Extra Rap. Den. ofALam ,DLAM= '
     *                                           ,IWEWMA ,DALAMN
        WRITE(6,37)XYLTRA(1,1,1),(TRANSA(I),I=1,10)
      DO 1138 J=1,40
        WRITE(6,37)XYLTRA(J,1,1),DYYLAM(J),DYALAM(J)
 1138 CONTINUE
	      ENDIF
      I=0
C                               Reduce IWEWMA forPb-Pb runs
      IWEWMA=IWEWMA
      ILOMA=0
      ILOML=0
      ITOMA=0
      ITOML=0
      DO 20 II=1,IWEWMA
	ID1=MPDGHA(IDWEW1(II))
	ID2=MPDGHA(IDWEW2(II))
	ID3=MPDGHA(IDWEW(II))
	ID4=MPDGHA(IDWEWW(II))
C       WRITE(6,'(5I5)')II,ID1,ID2,ID3,ID4
	IHKK1=0
	IHKK2=0
        KK1=0
        KK2=0
        DO 211 JJ=NHKKH1,NHKK
	  IF(IBLOCK(JJ).EQ.0)THEN
            IF((IDHKK(JJ).EQ.ID1).AND.(IYWEW(JJ).EQ.IIYWEW(II))
     *      .AND.(IRWEW(JJ).EQ.IIRWEW(II)).AND.(KK1.EQ.0))THEN
	      IHKK1=JJ
              JJ1=JJ
              KK1=1
            ENDIF
	    IF((IDHKK(JJ).EQ.ID2).AND.(IYWEW(JJ).EQ.IIYWEW(II))
     *      .AND.(IRWEW(JJ).EQ.IIRWEW(II)).AND.(KK2.EQ.0))THEN
	      IHKK2=JJ
              JJ2=JJ
              KK2=1
            ENDIF
	    IF(IHKK1.EQ.0)GO TO 211
	    IF(IHKK2.EQ.0)GO TO 211
	    IF(JMOHKK(1,IHKK1).EQ.JMOHKK(1,IHKK2))THEN
	      IHKK2=0
	      JJ2=0
	      KK2=0
	      GO TO 211
	    ENDIF
            CALL PINKLA(IDWEW1(II),IDWEW2(II),IDWEW(II),IDWEWW(II),    
     &      IHKK1,IHKK2,ILOML,ILOMA,ITOML,ITOMA,IREJ)
            IF(IPEV.GE.2)
     *      WRITE(6,'(A,5I10)')' IWEWMA,ILOML,ILOMA,ITOML,ITOMA  '
     *             ,IWEWMA ,ILOML,ILOMA,ITOML,ITOMA
            IF(IREJ.EQ.0)THEN
	      IF(IPEV.GE.2)THEN
	        WRITE(6,'(A,3I7)')' Extra Positions ',IHKK1,IHKK2,II
              ENDIF
              IBLOCK(JJ1)=1
              IBLOCK(JJ2)=1
              KK1=0
              KK2=0
              JJ1=0
              JJ2=0
	      IHKK1=0
	      IHKK2=0
              GO TO 20
            ENDIF
	    IF(JJ1.GE.1)IBLOCK(JJ1)=1
 	    IHKK1=0
	    JJ1=0
	    KK1=0
	    IF(JJ2.GE.1)IBLOCK(JJ2)=1
	    IHKK2=0
	    JJ2=0
	    KK2=0
	  ENDIF
  211   CONTINUE
   20 CONTINUE
      IF(IPEV.GE.2)
     *WRITE(6,'(A,5I10)')' IWEWMA,ILOML,ILOMA,ITOML,ITOMA  '
     *             ,IWEWMA ,ILOML,ILOMA,ITOML,ITOMA
      
      RETURN
      END
      SUBROUTINE PINKLA(I1,I2,I3,I4,IHKK1,IHKK2,ILOML,ILOMA,
     *ITOML,ITOMA,IREJ)
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C--------------------------------------------------------------
C
C                 I1 + I2 ---> I3 + I4 final state interaction
C
C--------------------------------------------------------------
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (TINY= 1.D-5)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      COMMON /WEWEVT/ IYWEW(NMXHKK),IRWEW(NMXHKK),IIYWEW(2600),
     &               IIRWEW(2600),WEWEW(2600),IDWEW1(2600),
     &               IDWEW2(2600),IDWEW(2600),IBLOCK(NMXHKK),
     &               IDWEWW(2600)
C
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
      COMMON /DPRIN/IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
C------------------
      IF(I3.EQ.17)ITOML=ITOML+1
      IF(I3.EQ.18)ITOMA=ITOMA+1
C                            Check Inv Mass of two particle system
      AMA12=SQRT(MAX(0D0,((PHKK(4,IHKK1)+PHKK(4,IHKK2))+(PHKK(3,IH
     * KK1)+PHKK(3,IHKK2)))*((PHKK(4,IHKK1)+PHKK(4,IHKK2))-(PHKK(3,
     * IHKK1)+PHKK(3,IHKK2)))-(PHKK(2,IHKK1)+PHKK(2,IHKK2))**2-(PHK
     * K(1,IHKK1)+PHKK(1,IHKK2))**2))
      AMAMIN = AAM(I3)+AAM(I4)
      IREJ=1
      IF(AMA12.GE.AMAMIN+0.05D0)THEN
      IF(IPEV.GE.2)THEN
        WRITE(6,'(A,2F10.3)')' AMAMIN,AMA12 ',AMAMIN,AMA12
	WRITE(6,'(A,I5,A,I5,A,I5,A,I5)')' Reaction ',
     + I1,' + ',I2,' ---> ',I3,' + ',I4
      ENDIF
C                      Lorentz parameters of IHKK1,IHKK2 system
      E12  = PHKK(4,IHKK1)+PHKK(4,IHKK2)
      PX12 = PHKK(1,IHKK1)+PHKK(1,IHKK2)
      PY12 = PHKK(2,IHKK1)+PHKK(2,IHKK2)
      PZ12 = PHKK(3,IHKK1)+PHKK(3,IHKK2)
      G12   = E12/AMA12
      BGX12 = PX12/AMA12
      BGY12 = PY12/AMA12
      BGZ12 = PZ12/AMA12
      IF(IPEV.GE.2)
     +WRITE(6,'(A,4E12.3)')' G12,BGX12,BGY12,BGZ12 ',
     +G12,BGX12,BGY12,BGZ12
C                      Decay AMA12 into I3 + I4
      E3 = (AMA12**2-AAM(I4)**2+AAM(I3)**2)/(2.*AMA12)
      E4 = (AMA12**2-AAM(I3)**2+AAM(I4)**2)/(2.*AMA12)
      P3 = SQRT(E3**2-AAM(I3)**2)
      P4 = SQRT(E4**2-AAM(I4)**2)
      IF(IPEV.GE.2)
     +WRITE(6,'(A,4E12.3)')' E3,E4,P3,P4 ',
     +E3,E4,P3,P4
C                      Uniform rotation
      CALL DPOLI(POLC,POLS)
      CALL DSFECF(SFE,CFE)
      IF(PHKK(3,IHKK1).GE.0.D0)THEN
        POLS=0.D0
        POLC=1.D0
      ELSEIF(PHKK(3,IHKK1).LE.0.D0)THEN
        POLS=0.D0
        POLC=-1.D0
      ENDIF
C     WRITE(6,*)' POLS,POLC ',POLS,POLC
      CX=POLS*CFE
      CY=POLS*SFE
      CZ=POLC
      PX3=CX*P3
      PY3=CY*P3
      PZ3=CZ*P3
      PX4=-CX*P4
      PY4=-CY*P4
      PZ4=-CZ*P4
      IF(IPEV.GE.2)
C    +WRITE(6,'(A,8E12.3)')' 4 mom cms 3   4 ',
C    +PX3,PY3,PZ3,E3,PX4,PY4,PZ4,E4
     +WRITE(6,'(A,4E12.3)')' 4 mom cms 3   4 ',
     +PZ3,E3,PZ4,E4
C                        Lorentz transformation back
      CALL DALTRA(G12,BGX12,BGY12,BGZ12,PX3,PY3,PZ3,E3,PC3,PCX3,
     +                                   PCY3,PCZ3,EC3)
      CALL DALTRA(G12,BGX12,BGY12,BGZ12,PX4,PY4,PZ4,E4,PC4,PCX4,
     +                                   PCY4,PCZ4,EC4)
      IF(IPEV.GE.2)
C    +WRITE(6,'(A,8E12.3)')' 4 mom 1   2 ',
C    +PHKK(1,IHKK1),PHKK(2,IHKK1),PHKK(3,IHKK1),PHKK(4,IHKK1),
C    +PHKK(1,IHKK2),PHKK(2,IHKK2),PHKK(3,IHKK2),PHKK(4,IHKK2) 
     +WRITE(6,'(A,4E12.3)')' 4 mom 1   2 ',
     +PHKK(3,IHKK1),PHKK(4,IHKK1),
     +PHKK(3,IHKK2),PHKK(4,IHKK2) 
      IF(IPEV.GE.2)
C    +WRITE(6,'(A,8E12.3)')' 4 mom 3   4 ',
C    +PCX3,PCY3,PCZ3,EC3,PCX4,PCY4,PCZ4,EC4
     +WRITE(6,'(A,4E12.3)')' 4 mom 3   4 ',
     +PCZ3,EC3,PCZ4,EC4
C---------------------------------------------------      
	IREJ=0
C	WRITE(6,*)' I1+I2-->I3+I4 ',I1,I2,I3,I4
C                 Put particles I3 and I4 into COMMON Block
      ISTHKK(IHKK1)=512
      ISTHKK(IHKK2)=512
      NHKK=NHKK+1
      ISTHKK(NHKK)=1
      IF((I3.EQ.24).OR.(I3.EQ.25))THEN
	I3=12
        IF(RNDM(VV).LE.0.5D0)I3=19
      ENDIF
      IDHKK(NHKK)=MPDGHA(I3)
      JMOHKK(1,NHKK)=IHKK1
      JMOHKK(2,NHKK)=IHKK2
      JDAHKK(1,IHKK1)=NHKK
      JDAHKK(1,IHKK2)=NHKK
      PHKK(1,NHKK)=PCX3
      PHKK(2,NHKK)=PCY3
      PHKK(3,NHKK)=PCZ3
      PHKK(4,NHKK)=EC3
      PHKK(5,NHKK)=AAM(I3)
      DO 11 IIII=1,4
      VHKK(IIII,NHKK)=VHKK(IIII,IHKK1)
      WHKK(IIII,NHKK)=WHKK(IIII,IHKK1)
   11 CONTINUE
      NHKK=NHKK+1
      ISTHKK(NHKK)=1
      IF((I4.EQ.24).OR.(I4.EQ.25))THEN
	I4=12
        IF(RNDM(VV).LE.0.5D0)I4=19
      ENDIF
      IDHKK(NHKK)=MPDGHA(I4)
      JMOHKK(1,NHKK)=IHKK1
      JMOHKK(2,NHKK)=IHKK2
      JDAHKK(2,IHKK1)=NHKK
      JDAHKK(2,IHKK2)=NHKK
      PHKK(1,NHKK)=PCX4
      PHKK(2,NHKK)=PCY4
      PHKK(3,NHKK)=PCZ4
      PHKK(4,NHKK)=EC4
      PHKK(5,NHKK)=AAM(I4)
      DO 12 IIII=1,4
      VHKK(IIII,NHKK)=VHKK(IIII,IHKK2)
      WHKK(IIII,NHKK)=WHKK(IIII,IHKK2)
   12 CONTINUE
      ELSE
        IF(I3.EQ.17)ILOML=ILOML+1
        IF(I3.EQ.18)ILOMA=ILOMA+1
      ENDIF
      RETURN
      END

C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADJCK(NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,
     +IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C      HADJCK Fragmentation of vv,vs and sv chains CK method 
C                      j.r.6/96
C
C  HADJET DOES ALL THE NECESSARY ROTATIONS AND LORENTZ TRANSFORMS AND
C                                               CALL CALBAM (BAMJET)
C
C         NHAD = NUMBER OF HADRONS CREATED (OUTPUT) = IHAD (CALBAM)
C******** PRODUCED PARTICLES IN COMMON /CMSRES/
C NOTE:  NOW IN /FINPAR/      HJM 21/06/90
C         AMCH = INVARIANT MASS OF JET (INPUT)
C         PPR  = 4-MOMENTUM OF FORWARD GOING PARTON (PROJECTILE)(INPUT)
C         PTA  = 4-MOMENTUM OF BACKWARD GOING PARTON (TARGET)(INPUT)
C         GAM,BGX,BGY,BGZ = LORENTZ PARAMETERS OF JET CMS RELATIVE TO
C                                              COLLISION CMS (INPUT)
C
C--------------------------------------------------------------------
C    CALBAM(NNCH,I1,I2,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM,IHAD)
C    SAMPLING OF Q-AQ, Q-QQ, QQ-AQQ CHAINS
C       USING BAMJET(IHAD,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM)-----FOR NNCH=0
C       OR    PARJET(IHAD,ICH1=I1 OR I2)------FOR NNCH=-1 OR +1
C-------------------------------------------------------------------
C   IHAD  :  NUMBER OF PRODUCED PARTICLES
C   NNCH  :  CALL BAMJET FOR NNCH=0
C            CALL PARJET FOR NNCH=+1 ICH1=I1
C                        FOR NNCH=-1 ICH1=I2
C            jet not existing for NNCH=+/-99, i.e. IHAD=0
C   PRODUCED PARTICLES IN CHAIN REST FRAME ARE IN COMMON /FINPAR/
C   AMCH  :  INVARIANT MASS OF CHAIN (BAMJET)
C
C   NOBAM :  = 3  QUARK-ANTIQUARK JET   QUARK FLAVORS : IFB1,IFB2
C                 OR ANTIQUARK-QUARK JET                  IN ANY ORDER
C
C            = 4  QUARK-DIQUARK JET, FLAVORS : QU : IFB1, DIQU :IFB2,IFB
C                 OR ANTIQUARK-ANTIDIQUARK JET
C
C
C            = 5  DIQUARK-ANTIDIQUARK JET
C                 OR ANTIDIQUARK-DIQUARK JET
C                     FLAVORS :  DIQU : IFB1,IFB2, ANTIDIQU : IFB3,IFB4
C                                IN ANY ORDER
C
C            = 6  DIQUARK-QUARK JET, FLAVORS : DIQU  : IFB1,IFB2 QU: IFB
C                 OR ANTIDIQUARK-ANTIQUARK JET
C
C   IFBI  : FLAVORS : 1,2,3,4 = U,D,S,C    7,8,9,10 = AU,AD,AS,AC
C
C   I1,I2 : NUMBER LABEL OF A HADRON CREATED BY PARJET
C
C   NORMALLY IN BAMJET THE QUARKS MOVE FORWARD  (POSITIVE Z-DIRECTION)
C                      THE QUARK FLAVORS ARE FIRST GIVEN
C   CALBAM ALLOWS EITHER THE QUARK OR ANTIQUARK (DIQU) TO MOVE FORWARD
C                      THE FORWARD GOING FLAVORS ARE GIVEN FIRST
C
C =====================================================================
*KEEP,DFINPA.
      CHARACTER*8 ANF,ANFF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
      DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
     +HEFF(NFIMAX),AMFF(NFIMAX), 
     *ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
        CHARACTER*80 TITLE
        CHARACTER*8 PROJTY,TARGTY
C       COMMON /USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    & ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
*--------------------------------------------------------------------
*-------------------------------------------------------------------
      COMMON /JSPART/PXP(1000),PYP(1000),PZP(1000),HEPP(1000),NNNP
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
************************************************************************
************************************************************************
      COMMON/IFRAGM/IFRAG
      DIMENSION PPR(4),PTA(4)
*KEEP,XSEADI.
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA,CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      DIMENSION PPP1(4),PPP2(4),PPP3(4),PPP4(4)
C----------------------------------------------------------------------
C
C	WRITE(6,'(A,3I5)')' Jet0 IFB1,IFB2,IFB3 ',IFB1,IFB2,IFB3
      IREJ=0
      IF(IPCO.GE.3) THEN
        WRITE(6,'(4E12.4)') GAM,BGX,BGY,BGZ,PPR
        WRITE(6,1000) NHAD,AMCH,PTA, IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,
     +  NNCH,NORIG
 1000 FORMAT(10X,I10,5F10.3/10X,9I10)
      ENDIF
      IF(ABS(NNCH).EQ.99) THEN
        NHAD=0
C       IPCO=0
        RETURN
      ENDIF
C=================================================================
C=================================================================
C              Different options:
      IF(NOBAM.EQ.6)THEN
C              NOBAM=6:  Diquark--Quark Jet
C
C              Work out approximate x-Values of diquark and quark
	XDIQ=PPR(4)*2.D0/CMENER
	XQUA=PTA(4)*2.D0/CMENER
C	WRITE(6,'(A,2E12.4)')' HADJCK:XDIQ,XQUA ',XDIQ,XQUA
C              Select valence quark x for one of the diquark quarks
C              But only if XDIQ > 1.5*XQUA  drop this condition!
C	IF(XDIQ.LE.1.5D0*XQUA)THEN
C	  IREJ=1
C	  RETURN
C       ENDIF
C              Select x values of sea quark pair
	ICOU=0
 1234   CONTINUE
	ICOU=ICOU+1
	IF(ICOU.GE.100)THEN
	  IREJ=1
	  RETURN
	ENDIF
	CALL XSEAPA(CMENER,XQUA/2.D0,ISQ,ISAQ,XSQ,XSAQ,IREJ)
	IF(IREJ.GE.1)RETURN
	IF(XSAQ.GE.XQUA/2.D0)GO TO 1234
C       WRITE(6,'(A,2E12.4)')' HADJCK:XSQ,XSAQ ',XSQ,XSAQ
*  projectile valence quarks xpvqi
        XVTHRO=CVQ/CMENER
	IVTHR=0
 3465   CONTINUE
	IF(IVTHR.EQ.50)THEN
	  IREJ=1
      WRITE(6,*)' HADJSE 3465 reject IVTHR 50'
	  RETURN
        ENDIF
	IVTHR=IVTHR+1
        XVTHR=XVTHRO/(51-IVTHR)
        UNOPRV=UNON
   80   CONTINUE
        IF(XVTHR.GT.0.05)THEN
          IF(XVTHR.GT.0.66D0*XDIQ)THEN
            IREJ=1
	    RETURN
	  ENDIF
          XPVQI=BETREJ(0.5D0,UNOPRV,XVTHR,0.66D0*XDIQ)
        ELSE
          N90=0
   90     CONTINUE
          N90=N90+1
	  IF(N90.GE.20)THEN
	    IREJ=1
	    RETURN
	  ENDIF
          XPVQI=DBETAR(0.5D0,UNOPRV)
          IF ((XPVQI.LT.XVTHR).OR.(XPVQI.GT.0.66D0*XDIQ))
     *                                                          GOTO 90
        ENDIF
	XDIQQ=XDIQ-XPVQI
C	WRITE(6,'(A,2E12.4)')' HADJCK:XDIQQ,XPVQI ',XDIQQ,XPVQI
C
C               We form two strings(1-2) q-aq and (3-4) qq-q
C            1  q with XDIQ-XPVQI-XSQ
C            1  q with XDIQ-XPVQI   (j.r.5.5.96)
C            2  aq with XSAQ
C            3  qq with XPVQI+XSQ
C            3  qq with XPVQI       (j.r.5.5.96)
C            4  q with  XQUA-XSAQ
C            with 4-momenta PPP1,PPP2,PPP3,PPP4
      DO 2345 I=1,4
C       PPP1(I)=PPR(I)*(XDIQ-XPVQI-XSQ)/XDIQ
        PPP1(I)=PPR(I)*(XDIQ-XPVQI)/XDIQ
C	PPP3(I)=PPR(I)*(XPVQI+XSQ)/XDIQ
	PPP3(I)=PPR(I)*(XPVQI)/XDIQ
	PPP2(I)=PTA(I)*XSAQ/XQUA
	PPP4(I)=PTA(I)*(XQUA-XSAQ)/XQUA
 2345   CONTINUE
 2346   FORMAT(A,4E12.4)
C	WRITE(6,2346)' PPR ',PPR
C	WRITE(6,2346)' PPP1 ',PPP1
C	WRITE(6,2346)' PPP3 ',PPP3
C	WRITE(6,2346)' PTA ',PTA
C	WRITE(6,2346)' PPP2 ',PPP2
C	WRITE(6,2346)' PPP4 ',PPP4
C               Invariant Masses of chains
C               ORIGINAL CHAIN
      AMCHOR=SQRT(MAX(0D0,((PPR(4)+PTA(4))+(PPR(3)+PTA(3)))*((PPR(
     * 4)+PTA(4))-(PPR(3)+PTA(3)))-(PPR(2)+PTA(2))**2-(PPR(1)+PTA(1
     * ))**2))
C                    Chain 1 is q-aq restrict mass >1.5 GeV
      AMCHN1=SQRT(MAX(0D0,((PPP1(4)+PPP2(4))+(PPP1(3)+PPP2(3)))*((
     * PPP1(4)+PPP2(4))-(PPP1(3)+PPP2(3)))-(PPP1(2)+PPP2(2))**2-(PP
     * P1(1)+PPP2(1))**2))
	CHAMAL=1.D0
	IF(IFB1.GE.3.OR.ISAQ.GE.9)CHAMAL=1.5D0
	IF(AMCHN1.LE.CHAMAL)THEN
C	  IREJ=1
C	  RETURN
          GO TO 3465
	ENDIF
C                    Chain 2 is qq-q restrict mass >2.5 GeV
      AMCHN2=SQRT(MAX(0D0,((PPP3(4)+PPP4(4))+(PPP3(3)+PPP4(3)))*((
     * PPP3(4)+PPP4(4))-(PPP3(3)+PPP4(3)))-(PPP3(2)+PPP4(2))**2-(PP
     * P3(1)+PPP4(1))**2))
	CHAMAL=1.8D0
	IF(IFB2.GE.3.OR.IFB3.GE.3.OR.ISQ.GE.3)CHAMAL=2.5D0
	IF(AMCHN2.LE.CHAMAL)THEN
C	  IREJ=1
C 	  RETURN
	  GO TO 3465
	ENDIF
	PXCHK=PPR(1)+PTA(1)-PPP1(1)-PPP2(1)-PPP3(1)-PPP4(1)
	PYCHK=PPR(2)+PTA(2)-PPP1(2)-PPP2(2)-PPP3(2)-PPP4(2)
	PZCHK=PPR(3)+PTA(3)-PPP1(3)-PPP2(3)-PPP3(3)-PPP4(3)
	PECHK=PPR(4)+PTA(4)-PPP1(4)-PPP2(4)-PPP3(4)-PPP4(4)
	IF(IPCO.GE.1)THEN
        WRITE(6,'(A/8E12.4,I5)')
     *	' Chain masses AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,
     *   PXCHK,PYCHK,NOBAM ',
     *	 AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,PXCHK,PYCHK,NOBAM   
        ENDIF
C                 Lorentz parameters of chains
        GAMOR=(PPR(4)+PTA(4))/AMCH
	BGXOR=(PPR(1)+PTA(1))/AMCH
	BGYOR=(PPR(2)+PTA(2))/AMCH
	BGZOR=(PPR(3)+PTA(3))/AMCH
        GAMCH1=(PPP1(4)+PPP2(4))/AMCHN1
        BGXCH1=(PPP1(1)+PPP2(1))/AMCHN1
        BGYCH1=(PPP1(2)+PPP2(2))/AMCHN1
        BGZCH1=(PPP1(3)+PPP2(3))/AMCHN1
        GAMCH2=(PPP3(4)+PPP4(4))/AMCHN2
        BGXCH2=(PPP3(1)+PPP4(1))/AMCHN2
        BGYCH2=(PPP3(2)+PPP4(2))/AMCHN2
        BGZCH2=(PPP3(3)+PPP4(3))/AMCHN2
	IF(IPCO.GE.1)THEN
 	WRITE(6,2346)' L.Parm in ',GAM,BGX,BGY,BGZ
 	WRITE(6,2346)' L.Parm OR ',GAMOR,BGXOR,BGYOR,BGZOR
 	WRITE(6,2346)' L.Parm C1 ',GAMCH1,BGXCH1,BGYCH1,BGZCH1
 	WRITE(6,2346)' L.Parm C2 ',GAMCH2,BGXCH2,BGYCH2,BGZCH2
	ENDIF
	PEOR=AMCH*GAMOR
	PZOR=AMCH*BGZOR
	PECH1=AMCHN1*GAMCH1
	PZCH1=AMCHN1*BGZCH1
	PECH2=AMCHN2*GAMCH2
	PZCH2=AMCHN2*BGZCH2
	IF(IPCO.GE.1)THEN
	WRITE(6,'(A,6E12.4)')' PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2',
     *	 PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2
	ENDIF
	NOBA1=3
	NOBA2=6
C	WRITE(6,'(A,2I5)')' Jet1 IFB1,ISAQ ',IFB1,ISAQ
      CALL HADJET(NHAD1,AMCHN1,PPP1,PPP2,GAMCH1,BGXCH1,BGYCH1,
     * BGZCH1, IFB1,ISAQ,IFB3,IFB4,I1,I2,NOBA1,NNCH,NORIG)
C       DO 42 I=1,NHAD1
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C  42   CONTINUE
C     DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
C    +HEFF(NFIMAX),AMFF(NFIMAX), 
C    *ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
C                 Intermediate store of hadrons from jet 1
      DO 2348 I=1,NHAD1
	ANFF(I)=ANF(I)
	PXFF(I)=PXF(I)
	PYFF(I)=PYF(I)
	PZFF(I)=PZF(I)
	HEFF(I)=HEF(I)
	AMFF(I)=AMF(I)
	ICHFF(I)=ICHF(I)
	IBARFF(I)=IBARF(I)
	NREFF(I)=NREF(I)
 2348 CONTINUE
C	WRITE(6,'(A,3I5)')' Jet2 IFB2,ISQ,IFB3 ',IFB2,ISQ,IFB3
      CALL HADJET(NHAD2,AMCHN2,PPP3,PPP4,GAMCH2,BGXCH2,BGYCH2,
     * BGZCH2, IFB2,ISQ,IFB3,IFB4,I1,I2,NOBA2,NNCH,NORIG)
C       DO 41 I=1,NHAD2
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C  41   CONTINUE
      NHAD=NHAD1+NHAD2
      DO 2349 I=NHAD2+1,NHAD
	II=I-NHAD2
	ANF(I)=ANFF(II)
	PXF(I)=PXFF(II)
	PYF(I)=PYFF(II)
	PZF(I)=PZFF(II)
	HEF(I)=HEFF(II)
	AMF(I)=AMFF(II)
	ICHF(I)=ICHFF(II)
	IBARF(I)=IBARFF(II)
	NREF(I)=NREFF(II)
 2349 CONTINUE
      ENDIF
C==================================================================
C==================================================================
C              Different options:
      IF(NOBAM.EQ.4)THEN
C              NOBAM=4:  Quark-DIQUARK Jet
C
C              Work out approximate x-Values of quark and diquark
	XDIQ=PTA(4)*2.D0/CMENER
	XQUA=PPR(4)*2.D0/CMENER
C	WRITE(6,'(A,2E12.4)')' HADJCK:XDIQ,XQUA ',XDIQ,XQUA
C              Select valence quark x for one of the diquark quarks
C              But only if XDIQ > 1.5*XQUA
C	IF(XDIQ.LE.1.5D0*XQUA)THEN
C	  IREJ=1
C	  RETURN
C       ENDIF
C              Select x values of sea quark pair
	ICOU=0
 2234   CONTINUE
	ICOU=ICOU+1
	IF(ICOU.GE.100)THEN
	  IREJ=1
	  RETURN
	ENDIF
	CALL XSEAPA(CMENER,XQUA/2.D0,ISQ,ISAQ,XSQ,XSAQ,IREJ)
	IF(IREJ.GE.1)RETURN
	IF(XSAQ.GE.XQUA/2.D0)GO TO 2234
	IF(IPCO.GE.1)THEN
        WRITE(6,'(A,2E12.4)')' HADJCK:XSQ,XSAQ ',XSQ,XSAQ
        ENDIF
*  target valence quarks xtvqi
        XVTHRO=CVQ/CMENER
	IVTHR=0
 3466   CONTINUE
	IF(IVTHR.EQ.50)THEN
	  IREJ=1
      WRITE(6,*)' HADJSE 3466 reject IVTHR 50'
	  RETURN
        ENDIF
	IVTHR=IVTHR+1
        XVTHR=XVTHRO/(51-IVTHR)
        UNOPRV=UNON
  380   CONTINUE
        IF(XVTHR.GT.0.05)THEN
          IF(XVTHR.GT.0.66D0*XDIQ)THEN
            IREJ=1
	    RETURN
	  ENDIF
          XTVQI=BETREJ(0.5D0,UNOPRV,XVTHR,0.66D0*XDIQ)
        ELSE
          N90=0
  390     CONTINUE
          N90=N90+1
	  IF(N90.GE.20)THEN
	    IREJ=1
	    RETURN
	  ENDIF
          XTVQI=DBETAR(0.5D0,UNOPRV)
          IF ((XTVQI.LT.XVTHR).OR.(XTVQI.GT.0.66D0*XDIQ))
     *                                                         GOTO 390
        ENDIF
	XDIQQ=XDIQ-XTVQI
	IF(IPCO.GE.1)THEN
 	WRITE(6,'(A,2E12.4)')' HADJCK:XDIQQ,XTVQI ',XDIQQ,XTVQI
        ENDIF
C               We form two strings(2-1) aq-q and (4-3) q-qq
C            1  q with XDIQ-XTVQI-XSQ
C            1  q with XDIQ-XTVQI   (j.r.5.5.96)
C            2  aq with XSAQ
C            3  qq with XTVQI+XSQ
C            3  qq with XTVQI     (j.r.5.5.96)
C            4  q with  XQUA-XSAQ
C            with 4-momenta PPP1,PPP2,PPP3,PPP4
      DO 3345 I=1,4
C       PPP1(I)=PTA(I)*(XDIQ-XTVQI-XSQ)/XDIQ
        PPP1(I)=PTA(I)*(XDIQ-XTVQI)/XDIQ
C	PPP3(I)=PTA(I)*(XTVQI+XSQ)/XDIQ
	PPP3(I)=PTA(I)*(XTVQI)/XDIQ
	PPP2(I)=PPR(I)*XSAQ/XQUA
	PPP4(I)=PPR(I)*(XQUA-XSAQ)/XQUA
 3345   CONTINUE
 3346   FORMAT(A,4E12.4)
	IF(IPCO.GE.1)THEN
 	WRITE(6,3346)' PPR ',PPR
 	WRITE(6,3346)' PPP1 ',PPP1
 	WRITE(6,3346)' PPP3 ',PPP3
 	WRITE(6,3346)' PTA ',PTA
 	WRITE(6,3346)' PPP2 ',PPP2
 	WRITE(6,3346)' PPP4 ',PPP4
        ENDIF
C               Invariant Masses of chains
C               ORIGINAL CHAIN
      AMCHOR=SQRT(MAX(0D0,((PPR(4)+PTA(4))+(PPR(3)+PTA(3)))*((PPR(
     * 4)+PTA(4))-(PPR(3)+PTA(3)))-(PPR(2)+PTA(2))**2-(PPR(1)+PTA(1
     * ))**2))
C                    Chain 1 is q-aq restrict mass >1.5 GeV
      AMCHN1=SQRT(MAX(0D0,((PPP1(4)+PPP2(4))+(PPP1(3)+PPP2(3)))*((
     * PPP1(4)+PPP2(4))-(PPP1(3)+PPP2(3)))-(PPP1(2)+PPP2(2))**2-(PP
     * P1(1)+PPP2(1))**2))
	CHAMAL=1.D0
	IF(IFB3.GE.3.OR.ISAQ.GE.9)CHAMAL=1.5D0
	IF(AMCHN1.LE.CHAMAL)THEN
C	  IREJ=1
C	  RETURN
	  GO TO 3466
	ENDIF
C                    Chain 2 is qq-q restrict mass >2.5 GeV
      AMCHN2=SQRT(MAX(0D0,((PPP3(4)+PPP4(4))+(PPP3(3)+PPP4(3)))*((
     * PPP3(4)+PPP4(4))-(PPP3(3)+PPP4(3)))-(PPP3(2)+PPP4(2))**2-(PP
     * P3(1)+PPP4(1))**2))
	CHAMAL=1.8D0
	IF(IFB2.GE.3.OR.IFB1.GE.3.OR.ISQ.GE.3)CHAMAL=2.5D0
	IF(AMCHN2.LE.CHAMAL)THEN
C	  IREJ=1
C	  RETURN
	  GO TO 3466
	ENDIF
	PXCHK=PPR(1)+PTA(1)-PPP1(1)-PPP2(1)-PPP3(1)-PPP4(1)
	PYCHK=PPR(2)+PTA(2)-PPP1(2)-PPP2(2)-PPP3(2)-PPP4(2)
	PZCHK=PPR(3)+PTA(3)-PPP1(3)-PPP2(3)-PPP3(3)-PPP4(3)
	PECHK=PPR(4)+PTA(4)-PPP1(4)-PPP2(4)-PPP3(4)-PPP4(4)
	IF(IPCO.GE.1)THEN
        WRITE(6,'(A/8E12.4,I5)')
     *	' Chain masses AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,
     *   PXCHK,PYCHK,NOBAM ',
     *	 AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,PXCHK,PYCHK,NOBAM   
        ENDIF
C                 Lorentz parameters of chains
        GAMOR=(PPR(4)+PTA(4))/AMCH
	BGXOR=(PPR(1)+PTA(1))/AMCH
	BGYOR=(PPR(2)+PTA(2))/AMCH
	BGZOR=(PPR(3)+PTA(3))/AMCH
        GAMCH1=(PPP1(4)+PPP2(4))/AMCHN1
        BGXCH1=(PPP1(1)+PPP2(1))/AMCHN1
        BGYCH1=(PPP1(2)+PPP2(2))/AMCHN1
        BGZCH1=(PPP1(3)+PPP2(3))/AMCHN1
        GAMCH2=(PPP3(4)+PPP4(4))/AMCHN2
        BGXCH2=(PPP3(1)+PPP4(1))/AMCHN2
        BGYCH2=(PPP3(2)+PPP4(2))/AMCHN2
        BGZCH2=(PPP3(3)+PPP4(3))/AMCHN2
	IF(IPCO.GE.1)THEN
 	WRITE(6,3346)' L.Parm in ',GAM,BGX,BGY,BGZ
 	WRITE(6,3346)' L.Parm OR ',GAMOR,BGXOR,BGYOR,BGZOR
 	WRITE(6,3346)' L.Parm C1 ',GAMCH1,BGXCH1,BGYCH1,BGZCH1
 	WRITE(6,3346)' L.Parm C2 ',GAMCH2,BGXCH2,BGYCH2,BGZCH2
	ENDIF
	PEOR=AMCH*GAMOR
	PZOR=AMCH*BGZOR
	PECH1=AMCHN1*GAMCH1
	PZCH1=AMCHN1*BGZCH1
	PECH2=AMCHN2*GAMCH2
	PZCH2=AMCHN2*BGZCH2
	IF(IPCO.GE.1)THEN
	WRITE(6,'(A,6E12.4)')' PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2',
     *	 PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2
	ENDIF
	NOBA1=3
	NOBA2=4
C	WRITE(6,'(A,2I5)')' Jet1 ISAQ,IFB3 ',ISAQ,IFB3
      CALL HADJET(NHAD1,AMCHN1,PPP2,PPP1,GAMCH1,BGXCH1,BGYCH1,
     * BGZCH1, ISAQ,IFB3,IFB1,IFB4,I1,I2,NOBA1,NNCH,NORIG)
C       DO 342 I=1,NHAD1
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C 342   CONTINUE
C     DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
C    +HEFF(NFIMAX),AMFF(NFIMAX), 
C    *ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
C                 Intermediate store of hadrons from jet 1
      DO 3348 I=1,NHAD1
	ANFF(I)=ANF(I)
	PXFF(I)=PXF(I)
	PYFF(I)=PYF(I)
	PZFF(I)=PZF(I)
	HEFF(I)=HEF(I)
	AMFF(I)=AMF(I)
	ICHFF(I)=ICHF(I)
	IBARFF(I)=IBARF(I)
	NREFF(I)=NREF(I)
 3348 CONTINUE
C	WRITE(6,'(A,3I5)')' Jet2 IFB1,ISQ,IFB2 ',IFB1,ISQ,IFB2
      CALL HADJET(NHAD2,AMCHN2,PPP4,PPP3,GAMCH2,BGXCH2,BGYCH2,
     * BGZCH2, IFB1,ISQ,IFB2,IFB4,I1,I2,NOBA2,NNCH,NORIG)
C       DO 341 I=1,NHAD2
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C 341   CONTINUE
      NHAD=NHAD1+NHAD2
      DO 3349 I=NHAD2+1,NHAD
	II=I-NHAD2
	ANF(I)=ANFF(II)
	PXF(I)=PXFF(II)
	PYF(I)=PYFF(II)
	PZF(I)=PZFF(II)
	HEF(I)=HEFF(II)
	AMF(I)=AMFF(II)
	ICHF(I)=ICHFF(II)
	IBARF(I)=IBARFF(II)
	NREF(I)=NREFF(II)
 3349 CONTINUE
      ENDIF
C==================================================================
	HEFT=0.D0
	IF(IPCO.GE.1)THEN
        DO 40 I=1,NHAD
	  IF(IBARF(I).EQ.500)GO TO 4040
          HEFT=HEFT+HEF(I)
        WRITE(6,4050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
     +    IBARF(I),NREF(I),ANF(I)
 4050 FORMAT(' JET  ',I5,5F12.4,3I5,A10)
 4040   CONTINUE
   40   CONTINUE
	ENDIF
      HEFFF=AMCH*GAM
	IF(IPCO.GE.1)THEN
      WRITE(6,'(A,I5,2E12.4)')'1IREJ,HEFT,HEFFF ',
     * IREJ,HEFT,HEFFF
	ENDIF
C     IREJ=1
      IF(IREJ.EQ.1)RETURN
C
      RETURN
      END

************************************************************************
************************************************************************
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADJSE(NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,
     +IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ,IISSQQ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C   HADJSE Fragmentation of vv,vs and sv chains CK method 
C          using Glauber sea quarks
C                 j.r.7/96
C
C  HADJET DOES ALL THE NECESSARY ROTATIONS AND LORENTZ TRANSFORMS AND
C                                               CALL CALBAM (BAMJET)
C
C         NHAD = NUMBER OF HADRONS CREATED (OUTPUT) = IHAD (CALBAM)
C******** PRODUCED PARTICLES IN COMMON /CMSRES/
C NOTE:  NOW IN /FINPAR/      HJM 21/06/90
C         AMCH = INVARIANT MASS OF JET (INPUT)
C         PPR  = 4-MOMENTUM OF FORWARD GOING PARTON (PROJECTILE)(INPUT)
C         PTA  = 4-MOMENTUM OF BACKWARD GOING PARTON (TARGET)(INPUT)
C         GAM,BGX,BGY,BGZ = LORENTZ PARAMETERS OF JET CMS RELATIVE TO
C                                              COLLISION CMS (INPUT)
C
C--------------------------------------------------------------------
C    CALBAM(NNCH,I1,I2,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM,IHAD)
C    SAMPLING OF Q-AQ, Q-QQ, QQ-AQQ CHAINS
C       USING BAMJET(IHAD,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM)-----FOR NNCH=0
C       OR    PARJET(IHAD,ICH1=I1 OR I2)------FOR NNCH=-1 OR +1
C-------------------------------------------------------------------
C   IHAD  :  NUMBER OF PRODUCED PARTICLES
C   NNCH  :  CALL BAMJET FOR NNCH=0
C            CALL PARJET FOR NNCH=+1 ICH1=I1
C                        FOR NNCH=-1 ICH1=I2
C            jet not existing for NNCH=+/-99, i.e. IHAD=0
C   PRODUCED PARTICLES IN CHAIN REST FRAME ARE IN COMMON /FINPAR/
C   AMCH  :  INVARIANT MASS OF CHAIN (BAMJET)
C
C   NOBAM :  = 3  QUARK-ANTIQUARK JET   QUARK FLAVORS : IFB1,IFB2
C                 OR ANTIQUARK-QUARK JET                  IN ANY ORDER
C
C            = 4  QUARK-DIQUARK JET, FLAVORS : QU : IFB1, DIQU :IFB2,IFB
C                 OR ANTIQUARK-ANTIDIQUARK JET
C
C
C            = 5  DIQUARK-ANTIDIQUARK JET
C                 OR ANTIDIQUARK-DIQUARK JET
C                     FLAVORS :  DIQU : IFB1,IFB2, ANTIDIQU : IFB3,IFB4
C                                IN ANY ORDER
C
C            = 6  DIQUARK-QUARK JET, FLAVORS : DIQU  : IFB1,IFB2 QU: IFB
C                 OR ANTIDIQUARK-ANTIQUARK JET
C
C   IFBI  : FLAVORS : 1,2,3,4 = U,D,S,C    7,8,9,10 = AU,AD,AS,AC
C
C   I1,I2 : NUMBER LABEL OF A HADRON CREATED BY PARJET
C
C   NORMALLY IN BAMJET THE QUARKS MOVE FORWARD  (POSITIVE Z-DIRECTION)
C                      THE QUARK FLAVORS ARE FIRST GIVEN
C   CALBAM ALLOWS EITHER THE QUARK OR ANTIQUARK (DIQU) TO MOVE FORWARD
C                      THE FORWARD GOING FLAVORS ARE GIVEN FIRST
C
C =====================================================================
*KEEP,DFINPA.
      CHARACTER*8 ANF,ANFF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
      DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
     +HEFF(NFIMAX),AMFF(NFIMAX), 
     *ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX),IORMOO(NFIMAX)
        CHARACTER*80 TITLE
        CHARACTER*8 PROJTY,TARGTY
C       COMMON /USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    & ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
*--------------------------------------------------------------------
*-------------------------------------------------------------------
      COMMON /JSPART/PXP(1000),PYP(1000),PZP(1000),HEPP(1000),NNNP
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
************************************************************************
************************************************************************
      COMMON/IFRAGM/IFRAG
      DIMENSION PPR(4),PTA(4)
*KEEP,XSEADI.
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA,CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      COMMON /HDJASE/NHSE1,NHSE2,NHSE3,NHASE1,NHASE2,NHASE3
      DIMENSION PPP1(4),PPP2(4),PPP3(4),PPP4(4)
      DATA TINY/1.0D-3/
C----------------------------------------------------------------------
C
C	WRITE(6,'(A,3I5)')' Jet0 IFB1,IFB2,IFB3 ',IFB1,IFB2,IFB3
      IF(IPCO.GE.0)WRITE(6,*)
     *' HADJSE(NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,',
     +'IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ),IPCO',
     *NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,
     +IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ,IPCO
      IREJ=0
      IF(IPCO.GE.0) THEN
    	WRITE(6,'(A,3I5)')' HADJSE Jet0 IFB1,IFB2,IFB3',IFB1,IFB2,IFB3
        WRITE(6,'(4E12.4)') GAM,BGX,BGY,BGZ,PPR
        WRITE(6,1000) NHAD,AMCH,PTA, IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,
     +  NNCH,NORIG
 1000   FORMAT(10X,I10,5F10.3/10X,9I10)
      ENDIF
      IF(ABS(NNCH).EQ.99) THEN
        NHAD=0
C       IPCO=0
        RETURN
      ENDIF
C=================================================================
C=================================================================
C                   DIQUARK-QUARK NOBAM=6
C=================================================================
C=================================================================
C              Different options:
      IF(NOBAM.EQ.6)THEN
        IF(IPCO.GE.0)WRITE(6,*)' DIQUARK-QUARK NOBAM=6'
C              NOBAM=6:  Diquark--Quark Jet
C
C              Work out approximate x-Values of diquark and quark
	IF(CMENER.LT.1.D-3)THEN
	  WRITE(6,*)' CMENER=0. HADJSE',CMENER
	  STOP
	ENDIF
	XDIQ=PPR(4)*2.D0/CMENER
	XQUA=PTA(4)*2.D0/CMENER
        IF(IPCO.GE.0) THEN
          WRITE(6,'(A,2E12.4)')' HADJSE:XDIQ,XQUA ',XDIQ,XQUA
        ENDIF
C       Select sea quark x for one of the diquark quarks
C       Select x values of sea quark pair
	ICOU=0
 1234   CONTINUE
	ICOU=ICOU+1
	IF(ICOU.GE.200)THEN
	  IREJ=1
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE reject icou 100'
	  RETURN
	ENDIF
	CALL XSEAPA(CMENER,XQUA/2.D0,ISQ,ISAQ,XSQ,XSAQ,IREJ)
	IISSQQ=ISQ
	IF(IREJ.GE.1)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE reject XSEAPA'
	  RETURN
	ENDIF
	IF(XSAQ.GE.2.D0*XQUA/3.D0)GO TO 1234
        IF(IPCO.GE.0) THEN
          WRITE(6,*)' HADJSE,XSEAPA:XSQ,XSAQ,ISQ,ISAQ ',
     *	  XSQ,XSAQ,ISQ,ISAQ
        ENDIF
*       projectile valence quarks xpvqi
C       here selected as sea quark! from 1/x-sea
        XVTHRO=CVQ/CMENER
	IVTHR=0
 3465   CONTINUE
	IF(IVTHR.EQ.100)THEN
	  IREJ=1
	  IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE 3465 reject IVTHR 50'
	  RETURN
        ENDIF
	IVTHR=IVTHR+1
        XVTHR=XVTHRO/(101-IVTHR)
        UNOPRV=UNON
   80   CONTINUE
        IF(XVTHR.GT.0.66D0*XDIQ)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE 80 reject XVTHR too great',
     *	  XVTHR
          IREJ=1
	  IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        XPVQI=SAMPEY(XVTHR,0.66D0*XDIQ)
        XDIQQ=XDIQ-XPVQI
        IF(IPCO.GE.0) THEN
          WRITE(6,'(A,2E12.4)')' HADJSE:XDIQQ,XPVQI ',XDIQQ,XPVQI
        ENDIF
C
C       We form two strings(1-2) q-aq and (3-4) qq-q
C       1  q with XDIQ-XPVQI-XSQ
C       1  q with XDIQ-XPVQI   (j.r.5.5.96)
C       2  aq with XSAQ
C       3  qq with XPVQI+XSQ
C       3  qq with XPVQI       (j.r.5.5.96)
C       4  q with  XQUA-XSAQ
C       with 4-momenta PPP1,PPP2,PPP3,PPP4
        DO 2345 I=1,4
          IF(XDIQ.LE.1.D-15.OR.XQUA.LT.1.D-15)THEN
            IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
            IF(IPCO.GE.0)WRITE(6,*)' HADJSE reject 2345 XDIQ,',
     *	    'XQUA too small ',
     *	    XDIQ,XQUA
            RETURN
          ENDIF
C         PPP1(I)=PPR(I)*(XDIQ-XPVQI-XSQ)/XDIQ
          PPP1(I)=PPR(I)*(XDIQ-XPVQI)/XDIQ
C	  PPP3(I)=PPR(I)*(XPVQI+XSQ)/XDIQ
          PPP3(I)=PPR(I)*(XPVQI)/XDIQ
          PPP2(I)=PTA(I)*XSAQ/XQUA
          PPP4(I)=PTA(I)*(XQUA-XSAQ)/XQUA
 2345   CONTINUE
 2346   FORMAT(A,5E12.4)
        IF(IPCO.GE.0) THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 XSAQ',PPP2,XSAQ
          WRITE(6,2346)' PPP4 ',PPP4
        ENDIF
C       Invariant Masses of chains
C       ORIGINAL CHAIN
      AMCHOR=SQRT(MAX(0D0,((PPR(4)+PTA(4))+(PPR(3)+PTA(3)))*((PPR(
     * 4)+PTA(4))-(PPR(3)+PTA(3)))-(PPR(2)+PTA(2))**2-(PPR(1)+PTA(1
     * ))**2))
      AMCHN1=SQRT(MAX(0D0,((PPP1(4)+PPP2(4))+(PPP1(3)+PPP2(3)))*((
     * PPP1(4)+PPP2(4))-(PPP1(3)+PPP2(3)))-(PPP1(2)+PPP2(2))**2-(PP
     * P1(1)+PPP2(1))**2))
        IF(AMCHOR.LE.TINY)THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
        ENDIF
        IF(AMCHN1.LE.TINY)THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
        ENDIF
C       Chain 1 is q-aq restrict mass >1.5 GeV 
        CHAMAL=0.8D0
        IF(IFB1.GE.3.OR.ISAQ.GE.9)CHAMAL=1.2D0
        IF(AMCHN1.LE.CHAMAL)THEN
          IF(IPCO.GE.0)WRITE (6,*)'HADJSE jump1AMCHN1.LE.CHAMAL AMCHOR',
     *	  AMCHN1,CHAMAL,AMCHOR
          GO TO 3465
        ENDIF
C                    Chain 2 is qq-q restrict mass >2.5 GeV
      AMCHN2=SQRT(MAX(0D0,((PPP3(4)+PPP4(4))+(PPP3(3)+PPP4(3)))*((
     * PPP3(4)+PPP4(4))-(PPP3(3)+PPP4(3)))-(PPP3(2)+PPP4(2))**2-(PP
     * P3(1)+PPP4(1))**2))
	CHAMAL=1.5D0
	IF(IFB2.GE.3.OR.IFB3.GE.3.OR.ISQ.GE.3)CHAMAL=2.0D0
	IF(AMCHN2.LE.CHAMAL)THEN
C	  IREJ=1
C 	  RETURN
          IF(IPCO.GE.0)WRITE (6,*)'HADJSE jump AMCHN2.LE.CHAMAL ',
     *	  AMCHN2,CHAMAL
	  GO TO 3465
        ENDIF
        PXCHK=PPR(1)+PTA(1)-PPP1(1)-PPP2(1)-PPP3(1)-PPP4(1)
        PYCHK=PPR(2)+PTA(2)-PPP1(2)-PPP2(2)-PPP3(2)-PPP4(2)
        PZCHK=PPR(3)+PTA(3)-PPP1(3)-PPP2(3)-PPP3(3)-PPP4(3)
        PECHK=PPR(4)+PTA(4)-PPP1(4)-PPP2(4)-PPP3(4)-PPP4(4)
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A/8E12.4,I5)')
     *	  ' Chain masses AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,
     *    PXCHK,PYCHK,NOBAM ',
     *	  AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,PXCHK,PYCHK,NOBAM   
        ENDIF
C       Lorentz parameters of chains
        IF(AMCH.LE.1.D-15)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE rejection AMCH too small ',
     *	  AMCH
	  RETURN
        ENDIF
        GAMOR=(PPR(4)+PTA(4))/AMCH
        BGXOR=(PPR(1)+PTA(1))/AMCH
        BGYOR=(PPR(2)+PTA(2))/AMCH
        BGZOR=(PPR(3)+PTA(3))/AMCH
        IF(AMCHN1.LE.1.D-15)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE rejection AMCHN1 too small ',
     *	  AMCHN1
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        GAMCH1=(PPP1(4)+PPP2(4))/AMCHN1
        BGXCH1=(PPP1(1)+PPP2(1))/AMCHN1
        BGYCH1=(PPP1(2)+PPP2(2))/AMCHN1
        BGZCH1=(PPP1(3)+PPP2(3))/AMCHN1
        IF(AMCHN2.LE.1.D-15)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE rejection AMCHN2 too small ',
     *	  AMCHN2
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        GAMCH2=(PPP3(4)+PPP4(4))/AMCHN2
        BGXCH2=(PPP3(1)+PPP4(1))/AMCHN2
        BGYCH2=(PPP3(2)+PPP4(2))/AMCHN2
        BGZCH2=(PPP3(3)+PPP4(3))/AMCHN2
	IF(IPCO.GE.0)THEN
 	  WRITE(6,2346)' L.Parm in ',GAM,BGX,BGY,BGZ
 	  WRITE(6,2346)' L.Parm OR ',GAMOR,BGXOR,BGYOR,BGZOR
 	  WRITE(6,2346)' L.Parm C1 ',GAMCH1,BGXCH1,BGYCH1,BGZCH1
 	  WRITE(6,2346)' L.Parm C2 ',GAMCH2,BGXCH2,BGYCH2,BGZCH2
	ENDIF
	PEOR=AMCH*GAMOR
	PZOR=AMCH*BGZOR
	PECH1=AMCHN1*GAMCH1
	PZCH1=AMCHN1*BGZCH1
	PECH2=AMCHN2*GAMCH2
	PZCH2=AMCHN2*BGZCH2
	IF(IPCO.GE.0)THEN
	  WRITE(6,'(A,6E12.4)')' PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2',
     *	  PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2
	ENDIF
	NOBA1=3
	NOBA2=6
	IF(IPCO.GE.-1)THEN
C	  WRITE(6,'(A,2I5)')' Jet1 IFB1,ISAQ ',IFB1,ISAQ
	ENDIF
        CALL HADJET(NHAD1,AMCHN1,PPP1,PPP2,GAMCH1,BGXCH1,BGYCH1,
     *  BGZCH1, IFB1,ISAQ,IFB3,IFB4,I1,I2,NOBA1,NNCH,NORIG)
C       DO 42 I=1,NHAD1
C         WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C  42   CONTINUE
	IF(IPCO.GE.-1)THEN
C	  WRITE(6,'(A,2I5)')' Jet1 NHAD1 ',NHAD1
	ENDIF
C       DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
C    +  HEFF(NFIMAX),AMFF(NFIMAX), 
C    *  ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
C       Intermediate store of hadrons from jet 1
        DO 2348 I=1,NHAD1
          ANFF(I)=ANF(I)
          PXFF(I)=PXF(I)
          PYFF(I)=PYF(I)
          PZFF(I)=PZF(I)
          HEFF(I)=HEF(I)
          AMFF(I)=AMF(I)
          ICHFF(I)=ICHF(I)
          IBARFF(I)=IBARF(I)
          NREFF(I)=NREF(I)
	  IORMOO(I)=IORMO(I)
 2348   CONTINUE
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,3I5)')' Jet2 IFB2,ISQ,IFB3 ',IFB2,ISQ,IFB3
	ENDIF
        CALL HADJET(NHAD2,AMCHN2,PPP3,PPP4,GAMCH2,BGXCH2,BGYCH2,
     *  BGZCH2, IFB2,ISQ,IFB3,IFB4,I1,I2,NOBA2,NNCH,NORIG)
	IF(IPCO.GE.-1)THEN
C	  WRITE(6,'(A,2I5)')' Jet2 NHAD2 ',NHAD2
	ENDIF
C       DO 41 I=1,NHAD2
C         WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C        IF(IORMO(I).NE.999)IORMO(I+NHAD1)=IORMO(I)+NHAD1
C  41   CONTINUE
C       Intermediate store of hadrons from jet 2
        DO 2448 I=NHAD1+1,NHAD1+NHAD2
	  II=I-NHAD1
          ANFF(I)=ANF(II)
          PXFF(I)=PXF(II)
          PYFF(I)=PYF(II)
          PZFF(I)=PZF(II)
          HEFF(I)=HEF(II)
          AMFF(I)=AMF(II)
          ICHFF(I)=ICHF(II)
          IBARFF(I)=IBARF(II)
          NREFF(I)=NREF(II)
	  IORMOO(I)=IORMO(II)
	  IF(IORMOO(I).NE.999)IORMOO(I)=IORMOO(I)+NHAD1
 2448   CONTINUE
        NHAD=NHAD1+NHAD2
        DO 2349 I=1,NHAD
	  II=I
	  ANF(I)=ANFF(II)
	  PXF(I)=PXFF(II)
	  PYF(I)=PYFF(II)
	  PZF(I)=PZFF(II)
	  HEF(I)=HEFF(II)
	  AMF(I)=AMFF(II)
	  ICHF(I)=ICHFF(II)
	  IBARF(I)=IBARFF(II)
	  NREF(I)=NREFF(II)
	  IORMO(I)=IORMOO(II)
 2349   CONTINUE
      ENDIF
C=================================================================
C=================================================================
C                   QUARK-DIQUARK NOBAM=4
C=================================================================
C==================================================================
C     Different options:
      IF(NOBAM.EQ.4)THEN
        IF(IPCO.GE.0)WRITE(6,*)' QUARK-DIQUARK NOBAM=4'
C       NOBAM=4:  Quark-DIQUARK Jet
C
C       Work out approximate x-Values of quark and diquark
	IF(CMENER.LT.1.D-3)THEN
	  WRITE(6,*)' CMENER=0. HADJSE',CMENER
	  STOP
	ENDIF
	XDIQ=PTA(4)*2.D0/CMENER
	XQUA=PPR(4)*2.D0/CMENER
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2E12.4)')' HADJSE:XDIQ,XQUA ',XDIQ,XQUA
	ENDIF
C       Select valence quark x for one of the diquark quarks
C       Select x values of sea quark pair
	ICOU=0
 2234   CONTINUE
	ICOU=ICOU+1
	IF(ICOU.GE.200)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE Rejection 2234 ICOU. GT.100'
	  RETURN
	ENDIF
	IF(IPCO.GE.0)WRITE(6,*)' XSEAPA: CMENER,XQUA ',CMENER,XQUA
	CALL XSEAPA(CMENER,XQUA/2.D0,ISQ,ISAQ,XSQ,XSAQ,IREJ)
	IISSQQ=ISQ
	IF(IREJ.GE.1)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE reject XSEAPA'
	  RETURN
	ENDIF
	IF(XSAQ.GE.2.D0*XQUA/3.D0)GO TO 2234
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2E12.4)')' HADJSE:XSQ,XSAQ ',XSQ,XSAQ
        ENDIF
*       target valence quarks xtvqi
C       here selected as sea quark! from 1/x-sea
        XVTHRO=CVQ/CMENER
	IVTHR=0
 3466   CONTINUE
	IF(IVTHR.EQ.100)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE 3466 reject IVTHR 50'
	  RETURN
        ENDIF
	IVTHR=IVTHR+1
        XVTHR=XVTHRO/(101-IVTHR)
        UNOPRV=UNON
  380   CONTINUE
        IF(XVTHR.GT.0.66D0*XDIQ)THEN
          IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJSE Rejection 380 XVTHR  large ',
     *	  XVTHR
          RETURN
        ENDIF
        XTVQI=SAMPEY(XVTHR,0.66D0*XDIQ)
	XDIQQ=XDIQ-XTVQI
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2E12.4)')' HADJCK:XDIQQ,XTVQI ',XDIQQ,XTVQI
        ENDIF
C       We form two strings(2-1) aq-q and (4-3) q-qq
C       1  q with XDIQ-XTVQI-XSQ
C       1  q with XDIQ-XTVQI   (j.r.5.5.96)
C       2  aq with XSAQ
C       3  qq with XTVQI+XSQ
C       3  qq with XTVQI     (j.r.5.5.96)
C       4  q with  XQUA-XSAQ
C       with 4-momenta PPP1,PPP2,PPP3,PPP4
        DO 3345 I=1,4
          IF(XDIQ.LE.1.D-15.OR.XQUA.LT.1.D-15)THEN
	    IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
            IF(IPCO.GE.0)WRITE (6,*)' HSDJSE Rejection 3345 XDIQ,XQUA ',
     *	    XDIQ,XQUA
	    RETURN
        ENDIF
C       PPP1(I)=PTA(I)*(XDIQ-XTVQI-XSQ)/XDIQ
        PPP1(I)=PTA(I)*(XDIQ-XTVQI)/XDIQ
C	PPP3(I)=PTA(I)*(XTVQI+XSQ)/XDIQ
	PPP3(I)=PTA(I)*(XTVQI)/XDIQ
	PPP2(I)=PPR(I)*XSAQ/XQUA
	PPP4(I)=PPR(I)*(XQUA-XSAQ)/XQUA
 3345   CONTINUE
 3346   FORMAT(A,5E12.4)
	IF(IPCO.GE.0)THEN
          WRITE(6,3346)' PPR ',PPR
          WRITE(6,3346)' PPP1 ',PPP1
          WRITE(6,3346)' PPP3 ',PPP3
          WRITE(6,3346)' PTA ',PTA
          WRITE(6,3346)' PPP2 XSAQ',PPP2,XSAQ
          WRITE(6,3346)' PPP4 ',PPP4
        ENDIF
C       Invariant Masses of chains
C       ORIGINAL CHAIN
      AMCHOR=SQRT(MAX(0D0,((PPR(4)+PTA(4))+(PPR(3)+PTA(3)))*((PPR(
     * 4)+PTA(4))-(PPR(3)+PTA(3)))-(PPR(2)+PTA(2))**2-(PPR(1)+PTA(1
     * ))**2))
	IF(IPCO.GE.0)WRITE(6,2346)'AMCHOR ',AMCHOR
      AMCHN1=SQRT(MAX(0D0,((PPP1(4)+PPP2(4))+(PPP1(3)+PPP2(3)))*((
     * PPP1(4)+PPP2(4))-(PPP1(3)+PPP2(3)))-(PPP1(2)+PPP2(2))**2-(PP
     * P1(1)+PPP2(1))**2))
	IF(IPCO.GE.0)WRITE(6,2346)'AMCHN1 ',AMCHN1
C                    Chain 1 is q-aq restrict mass >1.5 GeV
        IF(AMCHOR.LE.TINY)THEN
          IF(IPCO.GE.0)WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
          WRITE(6,2346)'AMCHOR ',AMCHOR
        ENDIF
        IF(AMCHN1.LE.TINY)THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
          WRITE(6,2346)'AMCHOR ',AMCHOR
        ENDIF
	CHAMAL=0.8D0
	IF(IFB3.GE.3.OR.ISAQ.GE.9)CHAMAL=1.2D0
	IF(AMCHN1.LE.CHAMAL)THEN
          IF(IPCO.GE.0)WRITE(6 ,*)'HADJSE jump2AMCHN1.LE.CHAMAL AMCHOR',
     *	  AMCHN1,CHAMAL,AMCHOR
	  GO TO 3466
	ENDIF
C                    Chain 2 is qq-q restrict mass >2.5 GeV
      AMCHN2=SQRT(MAX(0D0,((PPP3(4)+PPP4(4))+(PPP3(3)+PPP4(3)))*((
     * PPP3(4)+PPP4(4))-(PPP3(3)+PPP4(3)))-(PPP3(2)+PPP4(2))**2-(PP
     * P3(1)+PPP4(1))**2))
	CHAMAL=1.5D0
	IF(IFB2.GE.3.OR.IFB1.GE.3.OR.ISQ.GE.3)CHAMAL=2.0D0
	IF(AMCHN2.LE.CHAMAL)THEN
C	  IREJ=1
C	  RETURN
          IF(IPCO.GE.0)WRITE(6 ,*)' HADJSE jump AMCHN2.LE.CHAMAL',
     *	  AMCHN2,CHAMAL
	  GO TO 3466
	ENDIF
	PXCHK=PPR(1)+PTA(1)-PPP1(1)-PPP2(1)-PPP3(1)-PPP4(1)
	PYCHK=PPR(2)+PTA(2)-PPP1(2)-PPP2(2)-PPP3(2)-PPP4(2)
	PZCHK=PPR(3)+PTA(3)-PPP1(3)-PPP2(3)-PPP3(3)-PPP4(3)
	PECHK=PPR(4)+PTA(4)-PPP1(4)-PPP2(4)-PPP3(4)-PPP4(4)
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A/8E12.4,I5)')
     *	  ' Chain masses AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,
     *     PXCHK,PYCHK,NOBAM ',
     *	   AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,PXCHK,PYCHK,NOBAM   
        ENDIF
C       Lorentz parameters of chains
        IF(AMCH.LE.1.D-15)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HSDJSE Rejection AMCH too small',AMCH
	  RETURN
	ENDIF
        GAMOR=(PPR(4)+PTA(4))/AMCH
	BGXOR=(PPR(1)+PTA(1))/AMCH
	BGYOR=(PPR(2)+PTA(2))/AMCH
	BGZOR=(PPR(3)+PTA(3))/AMCH
        IF(AMCHN1.LE.1.D-15)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HSDJSE Rejection AMCHN1 too small',
     *	  AMCHN1
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        GAMCH1=(PPP1(4)+PPP2(4))/AMCHN1
        BGXCH1=(PPP1(1)+PPP2(1))/AMCHN1
        BGYCH1=(PPP1(2)+PPP2(2))/AMCHN1
        BGZCH1=(PPP1(3)+PPP2(3))/AMCHN1
        IF(AMCHN2.LE.1.D-15)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HSDJSE Rejection AMCHN2 too small',
     *	  AMCHN2
	  RETURN
	ENDIF
        GAMCH2=(PPP3(4)+PPP4(4))/AMCHN2
        BGXCH2=(PPP3(1)+PPP4(1))/AMCHN2
        BGYCH2=(PPP3(2)+PPP4(2))/AMCHN2
        BGZCH2=(PPP3(3)+PPP4(3))/AMCHN2
	IF(IPCO.GE.0)THEN
          WRITE(6,3346)' L.Parm in ',GAM,BGX,BGY,BGZ
          WRITE(6,3346)' L.Parm OR ',GAMOR,BGXOR,BGYOR,BGZOR
          WRITE(6,3346)' L.Parm C1 ',GAMCH1,BGXCH1,BGYCH1,BGZCH1
          WRITE(6,3346)' L.Parm C2 ',GAMCH2,BGXCH2,BGYCH2,BGZCH2
	ENDIF
	PEOR=AMCH*GAMOR
	PZOR=AMCH*BGZOR
	PECH1=AMCHN1*GAMCH1
	PZCH1=AMCHN1*BGZCH1
	PECH2=AMCHN2*GAMCH2
	PZCH2=AMCHN2*BGZCH2
	IF(IPCO.GE.0)THEN
	  WRITE(6,'(A,6E12.4)')' PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2',
     *	  PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2
	ENDIF
	NOBA1=3
	NOBA2=4
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2I5)')' Jet1 ISAQ,IFB3 ',ISAQ,IFB3
	ENDIF
        CALL HADJET(NHAD1,AMCHN1,PPP2,PPP1,GAMCH1,BGXCH1,BGYCH1,
     *  BGZCH1, ISAQ,IFB3,IFB1,IFB4,I1,I2,NOBA1,NNCH,NORIG)
C       DO 342 I=1,NHAD1
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +  IBARF(I),NREF(I),ANF(I)
C 342   CONTINUE
C       DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
C    +  HEFF(NFIMAX),AMFF(NFIMAX), 
C    *  ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
C                 Intermediate store of hadrons from jet 1
        DO 3348 I=1,NHAD1
	  ANFF(I)=ANF(I)
          PXFF(I)=PXF(I)
          PYFF(I)=PYF(I)
          PZFF(I)=PZF(I)
          HEFF(I)=HEF(I)
          AMFF(I)=AMF(I)
          ICHFF(I)=ICHF(I)
          IBARFF(I)=IBARF(I)
          NREFF(I)=NREF(I)
	  IORMOO(I)=IORMO(I)
 3348   CONTINUE
	IF(IPCO.GE.0)THEN
 	  WRITE(6,'(A,3I5)')' Jet2 IFB1,ISQ,IFB2 ',IFB1,ISQ,IFB2
	ENDIF
        CALL HADJET(NHAD2,AMCHN2,PPP4,PPP3,GAMCH2,BGXCH2,BGYCH2,
     *  BGZCH2, IFB1,ISQ,IFB2,IFB4,I1,I2,NOBA2,NNCH,NORIG)
C       DO 341 I=1,NHAD2
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C       IF(IORMO(I).NE.999)IORMO(I+NHAD1)=IORMO(I)+NHAD1
C 341   CONTINUE
C       Intermediate store of hadrons from jet 2
        DO 3448 I=NHAD1+1,NHAD1+NHAD2
	  II=I-NHAD1
          ANFF(I)=ANF(II)
          PXFF(I)=PXF(II)
          PYFF(I)=PYF(II)
          PZFF(I)=PZF(II)
          HEFF(I)=HEF(II)
          AMFF(I)=AMF(II)
          ICHFF(I)=ICHF(II)
          IBARFF(I)=IBARF(II)
          NREFF(I)=NREF(II)
	  IORMOO(I)=IORMO(II)
	  IF(IORMOO(I).NE.999)IORMOO(I)=IORMOO(I)+NHAD1
 3448   CONTINUE
        NHAD=NHAD1+NHAD2
        DO 3349 I=1,NHAD
	  II=I
          ANF(I)=ANFF(II)
          PXF(I)=PXFF(II)
          PYF(I)=PYFF(II)
          PZF(I)=PZFF(II)
          HEF(I)=HEFF(II)
          AMF(I)=AMFF(II)
          ICHF(I)=ICHFF(II)
          IBARF(I)=IBARFF(II)
          NREF(I)=NREFF(II)
	  IORMO(I)=IORMOO(II)
 3349   CONTINUE
      ENDIF
C==================================================================
      HEFT=0.D0
      IF(IPCO.GE.0)THEN
        DO 40 I=1,NHAD
	  IF(IBARF(I).EQ.500)GO TO 4040
          HEFT=HEFT+HEF(I)
          WRITE(6,4050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
     +    IBARF(I),NREF(I),ANF(I)
 4050     FORMAT(' JET  ',I5,5F12.4,3I5,A10)
 4040     CONTINUE
   40   CONTINUE
      ENDIF
      HEFFF=AMCH*GAM
      IF(IPCO.GE.0)THEN
        WRITE(6,'(A,I5,2E12.4)')' HADJSE 2IREJ,HEFT,HEFFF ',
     *  IREJ,HEFT,HEFFF
      ENDIF
C     IREJ=1
      IF(IREJ.GE.1)RETURN
C
C     WRITE(6,*)' HADJSE: IREJ,ISQ ',IREJ,ISQ
      IF(ISQ.EQ.1)NHSE1=NHSE1+1
      IF(ISQ.EQ.2)NHSE2=NHSE2+1
      IF(ISQ.EQ.3)NHSE3=NHSE3+1
      RETURN
      END

************************************************************************
************************************************************************
************************************************************************
************************************************************************
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADJASE(NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,
     +IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ,IISSQQ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C   HADJASE Fragmentation of vv,vs and sv chains CK method 
C          using Glauber sea quarks
C      This times for aqaq--aq and aq--aqaq chains
C                 j.r.3/99
C
C  HADJET DOES ALL THE NECESSARY ROTATIONS AND LORENTZ TRANSFORMS AND
C                                               CALL CALBAM (BAMJET)
C
C         NHAD = NUMBER OF HADRONS CREATED (OUTPUT) = IHAD (CALBAM)
C******** PRODUCED PARTICLES IN COMMON /CMSRES/
C NOTE:  NOW IN /FINPAR/      HJM 21/06/90
C         AMCH = INVARIANT MASS OF JET (INPUT)
C         PPR  = 4-MOMENTUM OF FORWARD GOING PARTON (PROJECTILE)(INPUT)
C         PTA  = 4-MOMENTUM OF BACKWARD GOING PARTON (TARGET)(INPUT)
C         GAM,BGX,BGY,BGZ = LORENTZ PARAMETERS OF JET CMS RELATIVE TO
C                                              COLLISION CMS (INPUT)
C
C--------------------------------------------------------------------
C    CALBAM(NNCH,I1,I2,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM,IHAD)
C    SAMPLING OF Q-AQ, Q-QQ, QQ-AQQ CHAINS
C       USING BAMJET(IHAD,IFB1,IFB2,IFB3,IFB4,AMCH,NOBAM)-----FOR NNCH=0
C       OR    PARJET(IHAD,ICH1=I1 OR I2)------FOR NNCH=-1 OR +1
C-------------------------------------------------------------------
C   IHAD  :  NUMBER OF PRODUCED PARTICLES
C   NNCH  :  CALL BAMJET FOR NNCH=0
C            CALL PARJET FOR NNCH=+1 ICH1=I1
C                        FOR NNCH=-1 ICH1=I2
C            jet not existing for NNCH=+/-99, i.e. IHAD=0
C   PRODUCED PARTICLES IN CHAIN REST FRAME ARE IN COMMON /FINPAR/
C   AMCH  :  INVARIANT MASS OF CHAIN (BAMJET)
C
C   NOBAM :  = 3  QUARK-ANTIQUARK JET   QUARK FLAVORS : IFB1,IFB2
C                 OR ANTIQUARK-QUARK JET                  IN ANY ORDER
C
C            = 4  QUARK-DIQUARK JET, FLAVORS : aQU : IFB1, aDIQU :IFB2,IFB3
C                 OR ANTIQUARK-ANTIDIQUARK JET
C
C
C            = 5  DIQUARK-ANTIDIQUARK JET
C                 OR ANTIDIQUARK-DIQUARK JET
C                     FLAVORS :  DIQU : IFB1,IFB2, ANTIDIQU : IFB3,IFB4
C                                IN ANY ORDER
C
C            = 6  DIQUARK-QUARK JET, FLAVORS : DIQU  : IFB1,IFB2 QU: IFB3
C                 OR ANTIDIQUARK-ANTIQUARK JET
C
C   IFBI  : FLAVORS : 1,2,3,4 = U,D,S,C    7,8,9,10 = AU,AD,AS,AC
C
C   I1,I2 : NUMBER LABEL OF A HADRON CREATED BY PARJET
C
C   NORMALLY IN BAMJET THE QUARKS MOVE FORWARD  (POSITIVE Z-DIRECTION)
C                      THE QUARK FLAVORS ARE FIRST GIVEN
C   CALBAM ALLOWS EITHER THE QUARK OR ANTIQUARK (DIQU) TO MOVE FORWARD
C                      THE FORWARD GOING FLAVORS ARE GIVEN FIRST
C
C =====================================================================
*KEEP,DFINPA.
      CHARACTER*8 ANF,ANFF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
      DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
     +HEFF(NFIMAX),AMFF(NFIMAX), 
     *ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX),IORMOO(NFIMAX)
        CHARACTER*80 TITLE
        CHARACTER*8 PROJTY,TARGTY
C       COMMON /USER/TITLE,PROJTY,TARGTY,CMENER,ISTRUF
C    & ,ISINGD,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLE,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
*--------------------------------------------------------------------
*-------------------------------------------------------------------
      COMMON /JSPART/PXP(1000),PYP(1000),PZP(1000),HEPP(1000),NNNP
      COMMON /JSPAR/PXJ(1000),PYJ(1000),PZJ(1000),HEJ(1000),NNNPJ
************************************************************************
************************************************************************
      COMMON/IFRAGM/IFRAG
      DIMENSION PPR(4),PTA(4)
*KEEP,XSEADI.
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA,CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      COMMON /HDJASE/NHSE1,NHSE2,NHSE3,NHASE1,NHASE2,NHASE3
      DIMENSION PPP1(4),PPP2(4),PPP3(4),PPP4(4)
      DATA TINY/1.0D-3/
C----------------------------------------------------------------------
C
C	WRITE(6,'(A,3I5)')' Jet0 IFB1,IFB2,IFB3 ',IFB1,IFB2,IFB3
      IF(IPCO.GE.0)WRITE(6,*)
     *' HADJASE(NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,',
     +'IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ),IPCO',
     *NHAD,AMCH,PPR,PTA,GAM,BGX,BGY,BGZ, IFB1,IFB2,
     +IFB3,IFB4,I1,I2,NOBAM,NNCH,NORIG,IREJ,IPCO
      IREJ=0
      IF(IPCO.GE.0) THEN
    	WRITE(6,'(A,3I5)')' HADJASE Jet0 IFB1,IFB2,IFB3',IFB1,IFB2,IFB3
        WRITE(6,'(4E12.4)') GAM,BGX,BGY,BGZ,PPR
        WRITE(6,1000) NHAD,AMCH,PTA, IFB1,IFB2,IFB3,IFB4,I1,I2,NOBAM,
     +  NNCH,NORIG
 1000   FORMAT(10X,I10,5F10.3/10X,9I10)
      ENDIF
      IF(ABS(NNCH).EQ.99) THEN
        NHAD=0
C       IPCO=0
        RETURN
      ENDIF
C=================================================================
C=================================================================
C                   DIQUARK-QUARK NOBAM=6
C=================================================================
C=================================================================
C              Different options:
      IF(NOBAM.EQ.6)THEN
        IF(IPCO.GE.0)WRITE(6,*)' DIQUARK-QUARK NOBAM=6'
C              NOBAM=6:  Diquark--Quark Jet
C
C              Work out approximate x-Values of diquark and quark
	IF(CMENER.LT.1.D-3)THEN
	  WRITE(6,*)' CMENER=0. HADJASE',CMENER
	  STOP
	ENDIF
	XDIQ=PPR(4)*2.D0/CMENER
	XQUA=PTA(4)*2.D0/CMENER
        IF(IPCO.GE.0) THEN
          WRITE(6,'(A,2E12.4)')' HADJASE:XDIQ,XQUA ',XDIQ,XQUA
        ENDIF
C       Select sea quark x for one of the diquark quarks
C       Select x values of sea quark pair
	ICOU=0
 1234   CONTINUE
	ICOU=ICOU+1
	IF(ICOU.GE.500)THEN
	  IREJ=1
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE reject icou 100'
	  RETURN
	ENDIF
	CALL XSEAPA(CMENER,XQUA/2.D0,ISQ,ISAQ,XSQ,XSAQ,IREJ)
	IISSQQ=ISQ
	IF(IREJ.GE.1)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE reject XSEAPA'
	  RETURN
	ENDIF
	IF(XSAQ.GE.2.D0*XQUA/3.D0)GO TO 1234
        IF(IPCO.GE.0) THEN
          WRITE(6,*)' HADJASE,XSEAPA:XSQ,XSAQ,ISQ,ISAQ ',
     *	  XSQ,XSAQ,ISQ,ISAQ
        ENDIF
*       projectile valence quarks xpvqi
C       here selected as sea quark! from 1/x-sea
        XVTHRO=CVQ/CMENER
	IVTHR=0
 3465   CONTINUE
	IF(IVTHR.EQ.200)THEN
	  IREJ=1
	  IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE 3465 reject IVTHR 50'
	  RETURN
        ENDIF
	IVTHR=IVTHR+1
        XVTHR=XVTHRO/(201-IVTHR)
        UNOPRV=UNON
   80   CONTINUE
        IF(XVTHR.GT.0.66D0*XDIQ)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE 80 reject XVTHR too great',
     *	  XVTHR
          IREJ=1
	  IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        XPVQI=SAMPEY(XVTHR,0.66D0*XDIQ)
        XDIQQ=XDIQ-XPVQI
        IF(IPCO.GE.0) THEN
          WRITE(6,'(A,2E12.4)')' HADJASE:XDIQQ,XPVQI ',XDIQQ,XPVQI
        ENDIF
C
C       We form two strings(1-2) aq-q and (3-4) aqaq-aq
C       1  aq with XDIQ-XPVQI   (j.r.5.5.96)
C       2  q with XSAQ
C       3  aqaq with XPVQI       (j.r.5.5.96)
C       4  aq with  XQUA-XSAQ
C       with 4-momenta PPP1,PPP2,PPP3,PPP4
        DO 2345 I=1,4
          IF(XDIQ.LE.1.D-15.OR.XQUA.LT.1.D-15)THEN
            IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
            IF(IPCO.GE.0)WRITE(6,*)' HADJASE reject 2345 XDIQ,',
     *	    'XQUA too small ',
     *	    XDIQ,XQUA
            RETURN
          ENDIF
          PPP1(I)=PPR(I)*(XDIQ-XPVQI)/XDIQ
          PPP3(I)=PPR(I)*(XPVQI)/XDIQ
          PPP2(I)=PTA(I)*XSAQ/XQUA
          PPP4(I)=PTA(I)*(XQUA-XSAQ)/XQUA
 2345   CONTINUE
 2346   FORMAT(A,5E12.4)
        IF(IPCO.GE.0) THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 XSAQ',PPP2,XSAQ
          WRITE(6,2346)' PPP4 ',PPP4
        ENDIF
C       Invariant Masses of chains
C       ORIGINAL CHAIN
      AMCHOR=SQRT(MAX(0D0,((PPR(4)+PTA(4))+(PPR(3)+PTA(3)))*((PPR(
     * 4)+PTA(4))-(PPR(3)+PTA(3)))-(PPR(2)+PTA(2))**2-(PPR(1)+PTA(1
     * ))**2))
      AMCHN1=SQRT(MAX(0D0,((PPP1(4)+PPP2(4))+(PPP1(3)+PPP2(3)))*((
     * PPP1(4)+PPP2(4))-(PPP1(3)+PPP2(3)))-(PPP1(2)+PPP2(2))**2-(PP
     * P1(1)+PPP2(1))**2))
        IF(AMCHOR.LE.TINY)THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
        ENDIF
        IF(AMCHN1.LE.TINY)THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
        ENDIF
C       Chain 1 is q-aq restrict mass >1.5 GeV 
        CHAMAL=0.8D0
        IF(IFB1.GE.9.OR.ISQ.GE.3)CHAMAL=1.1D0
        IF(AMCHN1.LE.CHAMAL)THEN
          IF(IPCO.GE.0)WRITE (6,*)'HADJASE jump1AMCHN1.LE.CHAMAL AMCHOR'
     *	  ,AMCHN1,CHAMAL,AMCHOR
          GO TO 3465
        ENDIF
C                    Chain 2 is qq-q restrict mass >2.5 GeV
      AMCHN2=SQRT(MAX(0D0,((PPP3(4)+PPP4(4))+(PPP3(3)+PPP4(3)))*((
     * PPP3(4)+PPP4(4))-(PPP3(3)+PPP4(3)))-(PPP3(2)+PPP4(2))**2-(PP
     * P3(1)+PPP4(1))**2))
	CHAMAL=1.3D0
	IF(IFB2.GE.9.OR.IFB3.GE.9.OR.ISAQ.GE.9)CHAMAL=1.80D0
	IF(AMCHN2.LE.CHAMAL)THEN
C	  IREJ=1
C 	  RETURN
          IF(IPCO.GE.0)WRITE (6,*)'HADJASE jump AMCHN2.LE.CHAMAL ',
     *	  AMCHN2,CHAMAL
	  GO TO 3465
        ENDIF
        PXCHK=PPR(1)+PTA(1)-PPP1(1)-PPP2(1)-PPP3(1)-PPP4(1)
        PYCHK=PPR(2)+PTA(2)-PPP1(2)-PPP2(2)-PPP3(2)-PPP4(2)
        PZCHK=PPR(3)+PTA(3)-PPP1(3)-PPP2(3)-PPP3(3)-PPP4(3)
        PECHK=PPR(4)+PTA(4)-PPP1(4)-PPP2(4)-PPP3(4)-PPP4(4)
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A/8E12.4,I5)')
     *	  ' Chain masses AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,
     *    PXCHK,PYCHK,NOBAM ',
     *	  AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,PXCHK,PYCHK,NOBAM   
        ENDIF
C       Lorentz parameters of chains
        IF(AMCH.LE.1.D-15)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE rejection AMCH too small ',
     *	  AMCH
	  RETURN
        ENDIF
        GAMOR=(PPR(4)+PTA(4))/AMCH
        BGXOR=(PPR(1)+PTA(1))/AMCH
        BGYOR=(PPR(2)+PTA(2))/AMCH
        BGZOR=(PPR(3)+PTA(3))/AMCH
        IF(AMCHN1.LE.1.D-15)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE rejection AMCHN1 too small ',
     *	  AMCHN1
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        GAMCH1=(PPP1(4)+PPP2(4))/AMCHN1
        BGXCH1=(PPP1(1)+PPP2(1))/AMCHN1
        BGYCH1=(PPP1(2)+PPP2(2))/AMCHN1
        BGZCH1=(PPP1(3)+PPP2(3))/AMCHN1
        IF(AMCHN2.LE.1.D-15)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE rejection AMCHN2 too small ',
     *	  AMCHN2
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        GAMCH2=(PPP3(4)+PPP4(4))/AMCHN2
        BGXCH2=(PPP3(1)+PPP4(1))/AMCHN2
        BGYCH2=(PPP3(2)+PPP4(2))/AMCHN2
        BGZCH2=(PPP3(3)+PPP4(3))/AMCHN2
	IF(IPCO.GE.0)THEN
 	  WRITE(6,2346)' L.Parm in ',GAM,BGX,BGY,BGZ
 	  WRITE(6,2346)' L.Parm OR ',GAMOR,BGXOR,BGYOR,BGZOR
 	  WRITE(6,2346)' L.Parm C1 ',GAMCH1,BGXCH1,BGYCH1,BGZCH1
 	  WRITE(6,2346)' L.Parm C2 ',GAMCH2,BGXCH2,BGYCH2,BGZCH2
	ENDIF
	PEOR=AMCH*GAMOR
	PZOR=AMCH*BGZOR
	PECH1=AMCHN1*GAMCH1
	PZCH1=AMCHN1*BGZCH1
	PECH2=AMCHN2*GAMCH2
	PZCH2=AMCHN2*BGZCH2
	IF(IPCO.GE.0)THEN
	  WRITE(6,'(A,6E12.4)')' PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2',
     *	  PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2
	ENDIF
	NOBA1=3
	NOBA2=6
	IF(IPCO.GE.-1)THEN
C	  WRITE(6,'(A,2I5)')' Jet1 IFB1,ISQ ',IFB1,ISQ
	ENDIF
        CALL HADJET(NHAD1,AMCHN1,PPP1,PPP2,GAMCH1,BGXCH1,BGYCH1,
     *  BGZCH1, IFB1,ISQ,IFB3,IFB4,I1,I2,NOBA1,NNCH,NORIG)
C       DO 42 I=1,NHAD1
C         WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C  42   CONTINUE
	IF(IPCO.GE.-1)THEN
C	  WRITE(6,'(A,2I5)')' Jet1 NHAD1 ',NHAD1
	ENDIF
C       DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
C    +  HEFF(NFIMAX),AMFF(NFIMAX), 
C    *  ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
C       Intermediate store of hadrons from jet 1
        DO 2348 I=1,NHAD1
          ANFF(I)=ANF(I)
          PXFF(I)=PXF(I)
          PYFF(I)=PYF(I)
          PZFF(I)=PZF(I)
          HEFF(I)=HEF(I)
          AMFF(I)=AMF(I)
          ICHFF(I)=ICHF(I)
          IBARFF(I)=IBARF(I)
          NREFF(I)=NREF(I)
	  IORMOO(I)=IORMO(I)
 2348   CONTINUE
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,3I5)')' Jet2 IFB2,ISAQ,IFB3 ',IFB2,ISAQ,IFB3
	ENDIF
        CALL HADJET(NHAD2,AMCHN2,PPP3,PPP4,GAMCH2,BGXCH2,BGYCH2,
     *  BGZCH2, IFB2,ISAQ,IFB3,IFB4,I1,I2,NOBA2,NNCH,NORIG)
	IF(IPCO.GE.-1)THEN
C	  WRITE(6,'(A,2I5)')' Jet2 NHAD2 ',NHAD2
	ENDIF
C       DO 41 I=1,NHAD2
C         WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C        IF(IORMO(I).NE.999)IORMO(I+NHAD1)=IORMO(I)+NHAD1
C  41   CONTINUE
C       Intermediate store of hadrons from jet 2
        DO 2448 I=NHAD1+1,NHAD1+NHAD2
	  II=I-NHAD1
          ANFF(I)=ANF(II)
          PXFF(I)=PXF(II)
          PYFF(I)=PYF(II)
          PZFF(I)=PZF(II)
          HEFF(I)=HEF(II)
          AMFF(I)=AMF(II)
          ICHFF(I)=ICHF(II)
          IBARFF(I)=IBARF(II)
          NREFF(I)=NREF(II)
	  IORMOO(I)=IORMO(II)
	  IF(IORMOO(I).NE.999)IORMOO(I)=IORMOO(I)+NHAD1
 2448   CONTINUE
        NHAD=NHAD1+NHAD2
        DO 2349 I=1,NHAD
	  II=I
	  ANF(I)=ANFF(II)
	  PXF(I)=PXFF(II)
	  PYF(I)=PYFF(II)
	  PZF(I)=PZFF(II)
	  HEF(I)=HEFF(II)
	  AMF(I)=AMFF(II)
	  ICHF(I)=ICHFF(II)
	  IBARF(I)=IBARFF(II)
	  NREF(I)=NREFF(II)
	  IORMO(I)=IORMOO(II)
 2349   CONTINUE
      ENDIF
C=================================================================
C=================================================================
C                   QUARK-DIQUARK NOBAM=4
C=================================================================
C==================================================================
C     Different options:
      IF(NOBAM.EQ.4)THEN
        IF(IPCO.GE.0)WRITE(6,*)' AQUARK-ADIQUARK NOBAM=4'
C       NOBAM=4:  AQuark-ADIQUARK Jet
C
C       Work out approximate x-Values of quark and diquark
	IF(CMENER.LT.1.D-3)THEN
	  IF(IPCO.GE.0)WRITE(6,*)' CMENER=0. HADJASE',CMENER
	  STOP
	ENDIF
	XDIQ=PTA(4)*2.D0/CMENER
	XQUA=PPR(4)*2.D0/CMENER
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2E12.4)')' HADJASE:XDIQ,XQUA ',XDIQ,XQUA
	ENDIF
C       Select valence quark x for one of the diquark quarks
C       Select x values of sea quark pair
	ICOU=0
 2234   CONTINUE
	ICOU=ICOU+1
	IF(ICOU.GE.500)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE Rejection 2234 ICOU. GT.100'
	  RETURN
	ENDIF
	IF(IPCO.GE.0)WRITE(6,*)' XSEAPA: CMENER,XQUA ',CMENER,XQUA
	CALL XSEAPA(CMENER,XQUA/2.D0,ISQ,ISAQ,XSQ,XSAQ,IREJ)
	IISSQQ=ISQ
	IF(IREJ.GE.1)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE reject XSEAPA'
	  RETURN
	ENDIF
	IF(XSAQ.GE.2.D0*XQUA/3.D0)GO TO 2234
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2E12.4)')' HADJASE:XSQ,XSAQ ',XSQ,XSAQ
        ENDIF
*       target valence quarks xtvqi
C       here selected as sea quark! from 1/x-sea
        XVTHRO=CVQ/CMENER
	IVTHR=0
 3466   CONTINUE
	IF(IVTHR.EQ.200)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE 3466 reject IVTHR 50'
	  RETURN
        ENDIF
	IVTHR=IVTHR+1
        XVTHR=XVTHRO/(201-IVTHR)
        UNOPRV=UNON
  380   CONTINUE
        IF(XVTHR.GT.0.66D0*XDIQ)THEN
          IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HADJASE Rejection 380 XVTHR  large ',
     *	  XVTHR
          RETURN
        ENDIF
        XTVQI=SAMPEY(XVTHR,0.66D0*XDIQ)
	XDIQQ=XDIQ-XTVQI
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2E12.4)')' HADJCK:XDIQQ,XTVQI ',XDIQQ,XTVQI
        ENDIF
C       We form two strings(2-1) q-aq and (4-3) aq-aqaq
C       1  aq with XDIQ-XTVQI   (j.r.5.5.96)
C       2  q with XSAQ
C       3  aqaq with XTVQI     (j.r.5.5.96)
C       4  aq with  XQUA-XSAQ
C       with 4-momenta PPP1,PPP2,PPP3,PPP4
        DO 3345 I=1,4
          IF(XDIQ.LE.1.D-15.OR.XQUA.LT.1.D-15)THEN
	    IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
            IF(IPCO.GE.0)WRITE (6,*)' HSDJSE Rejection 3345 XDIQ,XQUA ',
     *	    XDIQ,XQUA
	    RETURN
        ENDIF
        PPP1(I)=PTA(I)*(XDIQ-XTVQI)/XDIQ
	PPP3(I)=PTA(I)*(XTVQI)/XDIQ
	PPP2(I)=PPR(I)*XSAQ/XQUA
	PPP4(I)=PPR(I)*(XQUA-XSAQ)/XQUA
 3345   CONTINUE
 3346   FORMAT(A,5E12.4)
	IF(IPCO.GE.0)THEN
          WRITE(6,3346)' PPR ',PPR
          WRITE(6,3346)' PPP1 ',PPP1
          WRITE(6,3346)' PPP3 ',PPP3
          WRITE(6,3346)' PTA ',PTA
          WRITE(6,3346)' PPP2 XSAQ',PPP2,XSAQ
          WRITE(6,3346)' PPP4 ',PPP4
        ENDIF
C       Invariant Masses of chains
C       ORIGINAL CHAIN
      AMCHOR=SQRT(MAX(0D0,((PPR(4)+PTA(4))+(PPR(3)+PTA(3)))*((PPR(
     * 4)+PTA(4))-(PPR(3)+PTA(3)))-(PPR(2)+PTA(2))**2-(PPR(1)+PTA(1
     * ))**2))
	IF(IPCO.GE.0)WRITE(6,2346)'AMCHOR ',AMCHOR
      AMCHN1=SQRT(MAX(0D0,((PPP1(4)+PPP2(4))+(PPP1(3)+PPP2(3)))*((
     * PPP1(4)+PPP2(4))-(PPP1(3)+PPP2(3)))-(PPP1(2)+PPP2(2))**2-(PP
     * P1(1)+PPP2(1))**2))
	IF(IPCO.GE.0)WRITE(6,2346)'AMCHN1 ',AMCHN1
C                    Chain 1 is q-aq restrict mass >1.5 GeV
        IF(AMCHOR.LE.TINY)THEN
          IF(IPCO.GE.0)WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
          WRITE(6,2346)'AMCHOR ',AMCHOR
        ENDIF
        IF(AMCHN1.LE.TINY)THEN
          WRITE(6,2346)' PPR ',PPR
          WRITE(6,2346)' PPP1 ',PPP1
          WRITE(6,2346)' PPP3 ',PPP3
          WRITE(6,2346)' PTA ',PTA
          WRITE(6,2346)' PPP2 ',PPP2
          WRITE(6,2346)' PPP4 ',PPP4
          WRITE(6,2346)'AMCHOR ',AMCHOR
        ENDIF
	CHAMAL=0.8D0
	IF(IFB3.GE.9.OR.ISQ.GE.3)CHAMAL=1.2D0
	IF(AMCHN1.LE.CHAMAL)THEN
          IF(IPCO.GE.0)WRITE(6 ,*)'HADJASE jump2AMCHN1.LE.CHAMAL AMCHOR'
     *	  ,AMCHN1,CHAMAL,AMCHOR
	  GO TO 3466
	ENDIF
C                    Chain 2 is qq-q restrict mass >2.5 GeV
      AMCHN2=SQRT(MAX(0D0,((PPP3(4)+PPP4(4))+(PPP3(3)+PPP4(3)))*((
     * PPP3(4)+PPP4(4))-(PPP3(3)+PPP4(3)))-(PPP3(2)+PPP4(2))**2-(PP
     * P3(1)+PPP4(1))**2))
	CHAMAL=1.4D0
	IF(IFB2.GE.9.OR.IFB1.GE.9.OR.ISAQ.GE.9)CHAMAL=1.8D0
	IF(AMCHN2.LE.CHAMAL)THEN
C	  IREJ=1
C	  RETURN
          IF(IPCO.GE.0)WRITE(6 ,*)' HADJASE jump AMCHN2.LE.CHAMAL',
     *	  AMCHN2,CHAMAL
	  GO TO 3466
	ENDIF
	PXCHK=PPR(1)+PTA(1)-PPP1(1)-PPP2(1)-PPP3(1)-PPP4(1)
	PYCHK=PPR(2)+PTA(2)-PPP1(2)-PPP2(2)-PPP3(2)-PPP4(2)
	PZCHK=PPR(3)+PTA(3)-PPP1(3)-PPP2(3)-PPP3(3)-PPP4(3)
	PECHK=PPR(4)+PTA(4)-PPP1(4)-PPP2(4)-PPP3(4)-PPP4(4)
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A/8E12.4,I5)')
     *	  ' Chain masses AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,
     *     PXCHK,PYCHK,NOBAM ',
     *	   AMCH,AMCHOR,AMCHN1,AMCHN2,PZCHK,PECHK,PXCHK,PYCHK,NOBAM   
        ENDIF
C       Lorentz parameters of chains
        IF(AMCH.LE.1.D-15)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HSDJSE Rejection AMCH too small',AMCH
	  RETURN
	ENDIF
        GAMOR=(PPR(4)+PTA(4))/AMCH
	BGXOR=(PPR(1)+PTA(1))/AMCH
	BGYOR=(PPR(2)+PTA(2))/AMCH
	BGZOR=(PPR(3)+PTA(3))/AMCH
        IF(AMCHN1.LE.1.D-15)THEN
          IF(IPCO.GE.0)WRITE(6,*)' HSDJSE Rejection AMCHN1 too small',
     *	  AMCHN1
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
	  RETURN
	ENDIF
        GAMCH1=(PPP1(4)+PPP2(4))/AMCHN1
        BGXCH1=(PPP1(1)+PPP2(1))/AMCHN1
        BGYCH1=(PPP1(2)+PPP2(2))/AMCHN1
        BGZCH1=(PPP1(3)+PPP2(3))/AMCHN1
        IF(AMCHN2.LE.1.D-15)THEN
	  IREJ=1
	    IF(ISQ.EQ.3)IREJ=3
          IF(IPCO.GE.0)WRITE(6,*)' HSDJSE Rejection AMCHN2 too small',
     *	  AMCHN2
	  RETURN
	ENDIF
        GAMCH2=(PPP3(4)+PPP4(4))/AMCHN2
        BGXCH2=(PPP3(1)+PPP4(1))/AMCHN2
        BGYCH2=(PPP3(2)+PPP4(2))/AMCHN2
        BGZCH2=(PPP3(3)+PPP4(3))/AMCHN2
	IF(IPCO.GE.0)THEN
          WRITE(6,3346)' L.Parm in ',GAM,BGX,BGY,BGZ
          WRITE(6,3346)' L.Parm OR ',GAMOR,BGXOR,BGYOR,BGZOR
          WRITE(6,3346)' L.Parm C1 ',GAMCH1,BGXCH1,BGYCH1,BGZCH1
          WRITE(6,3346)' L.Parm C2 ',GAMCH2,BGXCH2,BGYCH2,BGZCH2
	ENDIF
	PEOR=AMCH*GAMOR
	PZOR=AMCH*BGZOR
	PECH1=AMCHN1*GAMCH1
	PZCH1=AMCHN1*BGZCH1
	PECH2=AMCHN2*GAMCH2
	PZCH2=AMCHN2*BGZCH2
	IF(IPCO.GE.0)THEN
	  WRITE(6,'(A,6E12.4)')' PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2',
     *	  PEOR,PECH1,PECH2,PZOR,PZCH1,PZCH2
	ENDIF
	NOBA1=3
	NOBA2=4
	IF(IPCO.GE.0)THEN
          WRITE(6,'(A,2I5)')' Jet1 ISQ,IFB3 ',ISQ,IFB3
	ENDIF
        CALL HADJET(NHAD1,AMCHN1,PPP2,PPP1,GAMCH1,BGXCH1,BGYCH1,
     *  BGZCH1, ISQ,IFB3,IFB1,IFB4,I1,I2,NOBA1,NNCH,NORIG)
C       DO 342 I=1,NHAD1
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +  IBARF(I),NREF(I),ANF(I)
C 342   CONTINUE
C       DIMENSION ANFF(NFIMAX),PXFF(NFIMAX),PYFF(NFIMAX),PZFF(NFIMAX),
C    +  HEFF(NFIMAX),AMFF(NFIMAX), 
C    *  ICHFF(NFIMAX),IBARFF(NFIMAX),NREFF(NFIMAX)
C                 Intermediate store of hadrons from jet 1
        DO 3348 I=1,NHAD1
	  ANFF(I)=ANF(I)
          PXFF(I)=PXF(I)
          PYFF(I)=PYF(I)
          PZFF(I)=PZF(I)
          HEFF(I)=HEF(I)
          AMFF(I)=AMF(I)
          ICHFF(I)=ICHF(I)
          IBARFF(I)=IBARF(I)
          NREFF(I)=NREF(I)
	  IORMOO(I)=IORMO(I)
 3348   CONTINUE
	IF(IPCO.GE.0)THEN
 	  WRITE(6,'(A,3I5)')' Jet2 IFB1,ISAQ,IFB2 ',IFB1,ISAQ,IFB2
	ENDIF
        CALL HADJET(NHAD2,AMCHN2,PPP4,PPP3,GAMCH2,BGXCH2,BGYCH2,
     *  BGZCH2, IFB1,ISAQ,IFB2,IFB4,I1,I2,NOBA2,NNCH,NORIG)
C       DO 341 I=1,NHAD2
C       WRITE(6,1050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
C    +    IBARF(I),NREF(I),ANF(I)
C       IF(IORMO(I).NE.999)IORMO(I+NHAD1)=IORMO(I)+NHAD1
C 341   CONTINUE
C       Intermediate store of hadrons from jet 2
        DO 3448 I=NHAD1+1,NHAD1+NHAD2
	  II=I-NHAD1
          ANFF(I)=ANF(II)
          PXFF(I)=PXF(II)
          PYFF(I)=PYF(II)
          PZFF(I)=PZF(II)
          HEFF(I)=HEF(II)
          AMFF(I)=AMF(II)
          ICHFF(I)=ICHF(II)
          IBARFF(I)=IBARF(II)
          NREFF(I)=NREF(II)
	  IORMOO(I)=IORMO(II)
	  IF(IORMOO(I).NE.999)IORMOO(I)=IORMOO(I)+NHAD1
 3448   CONTINUE
        NHAD=NHAD1+NHAD2
        DO 3349 I=1,NHAD
	  II=I
          ANF(I)=ANFF(II)
          PXF(I)=PXFF(II)
          PYF(I)=PYFF(II)
          PZF(I)=PZFF(II)
          HEF(I)=HEFF(II)
          AMF(I)=AMFF(II)
          ICHF(I)=ICHFF(II)
          IBARF(I)=IBARFF(II)
          NREF(I)=NREFF(II)
	  IORMO(I)=IORMOO(II)
 3349   CONTINUE
      ENDIF
C==================================================================
      HEFT=0.D0
      IF(IPCO.GE.0)THEN
        DO 40 I=1,NHAD
	  IF(IBARF(I).EQ.500)GO TO 4040
          HEFT=HEFT+HEF(I)
          WRITE(6,4050)I,PXF(I),PYF(I),PZF(I),HEF(I),AMF(I), ICHF(I),
     +    IBARF(I),NREF(I),ANF(I)
 4050     FORMAT(' JET  ',I5,5F12.4,3I5,A10)
 4040     CONTINUE
   40   CONTINUE
      ENDIF
      HEFFF=AMCH*GAM
      IF(IPCO.GE.0)THEN
        WRITE(6,'(A,I5,2E12.4)')'3IREJ,HEFT,HEFFF ',
     *  IREJ,HEFT,HEFFF
      ENDIF
C     IREJ=1
      IF(IREJ.GE.1)RETURN
C
C     WRITE(6,*)' HADJASE: IREJ,ISQ ',IREJ,ISQ
      IF(ISQ.EQ.1)NHASE1=NHASE1+1
      IF(ISQ.EQ.2)NHASE2=NHASE2+1
      IF(ISQ.EQ.3)NHASE3=NHASE3+1
      RETURN
      END

************************************************************************
************************************************************************
      SUBROUTINE DIQSV(ECM,ITV,J,IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*  define d-v chains (sea diquark - valence chains)
*   sq-q and saqsaq-qq chains instead of sq-qq and saq-q chains
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRDV.
      COMMON /ABRDV/ AMCDV1(248),AMCDV2(248),GACDV1(248),GACDV2(248),
     +BGXDV1(248),BGYDV1(248),BGZDV1(248), BGXDV2(248),BGYDV2(248),
     +BGZDV2(248), NCHDV1(248),NCHDV2(248),IJCDV1(248),IJCDV2(248),
     +PQDVA1(248,4),PQDVA2(248,4), PQDVB1(248,4),PQDVB2(248,4)
*KEND.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON /SEASU3/SEASQ
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA, CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C------------------------------------------------------------------
C     COMMON /PCHARM/PCCCC
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH4.EQ.0)THEN
        SEASQ=0.5D0
        RX=8.D0
        X1=RX
        GM=2.140D0
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.D0
      X1=RX
      BETCHA=BETOO+1.3D0-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
C     PC=PC1/2.9
C                       changed j.r.14.12.94
C     PC=PC1/5.0
C     PC=PC1/10.0
      PCC1=PC1/4.0D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
      PU1=PU/(2*PU+PS+PC)
      PS1=PS/(2*PU+PS+PC)
      IF(INICH4.EQ.0)THEN
        INICH4=1
        IF(IPHKK.GE.1)WRITE(6,4567)PC,BETCHA,PU1,PS1,SEASQ
 4567   FORMAT(' Charm chain ends DIQSV: PC,BETCHA,PU,PS,SEASQ ',5F10.5)
      ENDIF
C----------------------------------------------------------------------
      IREJ=0
*  kinematics: is the mass of the adiquark-diquark chain big enough
*              to allow for fragmentation
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' diqsv'
      IPSQ2(J)=1.D0+RNDM(v1)*(2.D0+2.D0*SEASQ)
        RR=RNDM(V)
	IF(RR.LT.PC)IPSQ2(J)=4
C------------------------------------------------------------------
      IPSAQ2(J)=-IPSQ2(J)
C---------------------------------------------------j.r.29.4.94
C                                   x**1.5 distr for sea diquarks
C                         number of projectile nucleon
      INUCPR=IFROSP(J)
C                          number of projectile diquark
      IITOP=ITOVP(INUCPR)
C                          diquark x
      XPDIQU=XPVD(IITOP)
C                          minimal value of diquark x
      XDTHR=CDQ/ECM
C
      XDFREE=XPDIQU-XDTHR
      XALL=XDFREE+XPSQ(J)+XPSAQ(J)-2.*XDTHR
      XDALT=XPVD(IITOP)
      XSALT=XPSQ(J)
      XAALT=XPSAQ(J) 
      IF(XALL.GE.0.)THEN
        RR1=RNDM(V1)
        RR2=RNDM(V2)
        RR3=RNDM(V3)
        SR123=RR1+RR2+RR3
        DX1=RR1*XALL/SR123
        DX2=RR2*XALL/SR123
        DX3=RR3*XALL/SR123
        XPVD(IITOP)=XDTHR+DX1
        XPSQ(J)=XDTHR+DX2
        XPSAQ(J)=XDTHR+DX3
      ENDIF
C--------------------------------------------------------------
      AMDVQ1=XPSQ(J)*XTVQ(ITV)*ECM**2
      AMDVQ2=XPSAQ(J)*XTVD(ITV)*ECM**2
      IDIQRE(1)=IDIQRE(1)+1
      IF(IPSQ(J).GE.3.AND.IPSQ2(J).GE.3)THEN
        IDIQRE(2)=IDIQRE(2)+1
C       IF(AMDVQ2.LE.9.0.OR.AMDVQ1.LE.2.30) THEN
        IF(AMDVQ2.LE.17.0D0.OR.AMDVQ1.LE.6.60D0) THEN
          IREJ=1
           IDIQRE(3)=IDIQRE(3)+1
           IDIQRE(2)=IDIQRE(2)-1
           IDIQRE(1)=IDIQRE(1)-1
          XPVD(IITOP)=XDALT
          XPSQ(J)=XSALT
          XPSAQ(J)=XAALT
          RETURN
        ENDIF
      ELSEIF(IPSQ(J).GE.3.OR.IPSQ2(J).GE.3)THEN
      IDIQRE(4)=IDIQRE(4)+1
C       IF(AMDVQ2.LE.7.3.OR.AMDVQ1.LE.1.90) THEN
        IF(AMDVQ2.LE.13.6D0.OR.AMDVQ1.LE.5.80D0) THEN
          IREJ=1
           IDIQRE(5)=IDIQRE(5)+1
           IDIQRE(4)=IDIQRE(4)-1
           IDIQRE(1)=IDIQRE(1)-1
          XPVD(IITOP)=XDALT
          XPSQ(J)=XSALT
          XPSAQ(J)=XAALT
          RETURN
        ENDIF
      ELSE
      IDIQRE(6)=IDIQRE(6)+1
C       IF(AMDVQ2.LE.6.70.OR.AMDVQ1.LE.1.50) THEN
        IF(AMDVQ2.LE.12.40D0.OR.AMDVQ1.LE.3.9D0) THEN
          IREJ=1
           IDIQRE(7)=IDIQRE(7)+1
           IDIQRE(6)=IDIQRE(6)-1
           IDIQRE(1)=IDIQRE(1)-1
          XPVD(IITOP)=XDALT
          XPSQ(J)=XSALT
          XPSAQ(J)=XAALT
          RETURN
        ENDIF
      ENDIF
      NDV=NDV+1
      NCHDV1(NDV)=0
      NCHDV2(NDV)=0
      INTDV1(NDV)=J
      INTDV2(NDV)=ITV
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C      DEBUG SUBCHK
C      END DEBUG
      SUBROUTINE KKEVDV(IREJDV)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C------------------ treatment of sea diquark - valence CHAIN SYSTEMS
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
C
*KEEP,INTMX.

      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRDV.
      COMMON /ABRDV/ AMCDV1(248),AMCDV2(248),GACDV1(248),GACDV2(248),
     +BGXDV1(248),BGYDV1(248),BGZDV1(248), BGXDV2(248),BGYDV2(248),
     +BGZDV2(248), NCHDV1(248),NCHDV2(248),IJCDV1(248),IJCDV2(248),
     +PQDVA1(248,4),PQDVA2(248,4), PQDVB1(248,4),PQDVB2(248,4)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
*KEND.
C-------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' kkevdv'
      IREJDV=0
      DO 10 N=1,NDV
C---------------------------drop recombined chain pairs
        IF(NCHDV1(N).EQ.99.AND.NCHDV2(N).EQ.99)GO TO 10
C
C***                 4-MOMENTA OF PROJECTILE SEA-QUARK PAIRS IN NN-CMS
        IXSPR=INTDV1(N)
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
C
        PSQPX=XPSQ(IXSPR)*PRMOM(1,INUCPR)
        PSQPY=XPSQ(IXSPR)*PRMOM(2,INUCPR)
        PSQPZ=XPSQ(IXSPR)*PRMOM(3,INUCPR)
        PSQE=XPSQ(IXSPR)*PRMOM(4,INUCPR)
        PSAQPX=XPSAQ(IXSPR)*PRMOM(1,INUCPR)
        PSAQPY=XPSAQ(IXSPR)*PRMOM(2,INUCPR)
        PSAQPZ=XPSAQ(IXSPR)*PRMOM(3,INUCPR)
        PSAQE=XPSAQ(IXSPR)*PRMOM(4,INUCPR)
C
C***                 4-MOMENTA OF TARGET QUARK-DIQUARK PAIRS IN NN-CMS
        IXVTA=INTDV2(N)
        INUCTA=IFROVT(IXVTA)
        JNUCTA=ITOVT(INUCTA)
C
        TVQPX=XTVQ(IXVTA)*TAMOM(1,INUCTA)
        TVQPY=XTVQ(IXVTA)*TAMOM(2,INUCTA)
        TVQPZ=XTVQ(IXVTA)*TAMOM(3,INUCTA)
        TVQE=XTVQ(IXVTA)*TAMOM(4,INUCTA)
        TVDQPX=XTVD(IXVTA)*TAMOM(1,INUCTA)
        TVDQPY=XTVD(IXVTA)*TAMOM(2,INUCTA)
        TVDQPZ=XTVD(IXVTA)*TAMOM(3,INUCTA)
        TVDQE=XTVD(IXVTA)*TAMOM(4,INUCTA)
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PSQPX,PSQPY,PSQPZ,PSQE,RTIX,RTIY,RTIZ,
     *            PSQNX,PSQNY,PSQNZ,PSQNE,51)
      PSQPX=PSQNX
      PSQPY=PSQNY
      PSQPZ=PSQNZ
      PSQE=PSQNE      
      CALL CROMSC(PSAQPX,PSAQPY,PSAQPZ,PSAQE,RTIX,RTIY,RTIZ,
     *            PSAQNX,PSAQNY,PSAQNZ,PSAQNE,52)
      PSAQPX=PSAQNX
      PSAQPY=PSAQNY
      PSAQPZ=PSAQNZ
      PSAQE=PSAQNE      
C                                                ---------
C                                               j.r.6.5.93
C
C                     multiple scattering of VALENCE quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TVQPX,TVQPY,TVQPZ,TVQE,RTIX,RTIY,RTIZ,
     *            TVQNX,TVQNY,TVQNZ,TVQNE,53)
      TVQPX=TVQNX
      TVQPY=TVQNY
      TVQPZ=TVQNZ
      TVQE=TVQNE      
      CALL CROMSC(TVDQPX,TVDQPY,TVDQPZ,TVDQE,RTIX,RTIY,RTIZ,
     *            TVDQNX,TVDQNY,TVDQNZ,TVDQNE,54)
      TVDQPX=TVDQNX
      TVDQPY=TVDQNY
      TVDQPZ=TVDQNZ
      TVDQE=TVDQNE     
      ENDIF 
C                                                ---------

C
C                                                j.r.10.5.93
       IF(IP.GE.0)GO TO 1779
        PSQPZ2=PSQE**2-PSQPX**2-PSQPY**2
        IF(PSQPZ2.GE.0.)THEN
          PSQPZ=SQRT(PSQPZ2)
        ELSE
          PSQPX=0.
          PSQPY=0.
          PSQPZ=PSQE
        ENDIF
C
        PSAQP2=PSAQE**2-PSAQPX**2-PSAQPY**2
        IF(PSAQP2.GE.0.)THEN
          PSAQPZ=SQRT(PSAQP2)
        ELSE
          PSAQPX=0.
          PSAQPY=0.
          PSAQPZ=PSAQE
        ENDIF
C
        TVQPZ2=TVQE**2-TVQPX**2-TVQPY**2
        IF(TVQPZ2.GE.0.)THEN
          TVQPZ=-SQRT(TVQPZ2)
        ELSE
          TVQPX=0.
          TVQPY=0.
          TVQPZ=TVQE
        ENDIF
C
        TDQPZ2=TVDQE**2-TVDQPX**2-TVDQPY**2
        IF(TDQPZ2.GE.0.)THEN
          TVDQPZ=-SQRT(TDQPZ2)
        ELSE
          TVDQPX=0.
          TVDQPY=0.
          TVDQPZ=TVDQE
        ENDIF
 1779  CONTINUE
C                                            ----------------

C                                                ---------
C                                      changej.r.6.5.93
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PSQPX
        PTXSA1=PSAQPX
        PTXSQ2=TVQPX
        PTXSA2=TVDQPX
        PTYSQ1=PSQPY
        PTYSA1=PSAQPY
        PTYSQ2=TVQPY
        PTYSA2=TVDQPY
        PLQ1=PSQPZ
        PLAQ1=PSAQPZ
        PLQ2=TVQPZ
        PLAQ2=TVDQPZ
        EQ1=PSQE
        EAQ1=PSAQE
        EQ2=TVQE
        EAQ2=TVDQE
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
C                                                change j.r.6.5.93
C                                               _________________
        IKVALA=0
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDV - IRDV13=',IRDV13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DV:  ...', PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
         ENDIF
        IKVALA=0
        NSELPT=1
        NSELPT=0
	IF(IP.EQ.1)NSELPT=1
        IF(NSELPT.EQ.1)CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     * PTTQ2,PTTA2,
     * NSELPT)
        IF(NSELPT.EQ.0)CALL SELPT4( PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,NSELPT)
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDV - IRDV13=',IRDV13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DV:  ...', PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
        IF (IPEV.GE.7) WRITE(6,'(A,I10)')
     +  'DV  IREJ ', IREJ
        IF (IREJ.EQ.1) THEN
          IRDV13=IRDV13 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' KKEVDV - IRDV13=',IRDV13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DV:  ...', PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
                                                              GO TO 20
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSQ2
        PTYCH1=PTYSQ1 + PTYSQ2
        PTZCH1=PLQ1 + PLQ2
        ECH1=EQ1 + EQ2
        PTXCH2=PTXSA2 + PTXSA1
        PTYCH2=PTYSA2 + PTYSA1
        PTZCH2=PLAQ2 + PLAQ1
        ECH2=EAQ2 + EAQ1
C
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' DV: IREJ ',IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ SEA-diquark - TAR QUARK)
C
        CALL COBCMA(IPSQ(IXSPR),IPSQ2(IXSPR),ITVQ(IXVTA), IJNCH1,NNCH1,
     +  IREJ,AMCH1,AMCH1N,1)
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJ.EQ.1) THEN
          IRDV11=IRDV11 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' KKEVDV - IRDV11=',IRDV11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' DV:', IPSQ(IXSPR),ITTV1
     +      (IXVTA),ITTV2(IXVTA),IJNCH1,NNCH1,IREJ, XPSQ(IXSPR),XPSAQ
     +      (IXSPR),XPSQCM,XPSACM, XTVQ(IXVTA),XTVD(IXVTA),AMCH1,AMCH1N
 
          ENDIF
                                                                 GOTO 20
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)THEN
           CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N,
     +         PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +         PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +         PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +         PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +         PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,ECH2,
     +         IREJ) 
        AMCH2=AMCH2N 
        ENDIF
C
        IF (IPEV.GE.2) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' DV(2): IREJ ',IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
        IF(IREJ.EQ.1)THEN
	  IF(IPEV.GE.1)WRITE(6,'(A)')' dv cormom rej.'
	  GO TO 20
	ENDIF
        IF (AMCH2 .LT.3.)THEN
	  IF(IPEV.GE.1)WRITE(6,'(A,F10.2)')' dv amch2',AMCH2
	  GO TO 20
        ENDIF
C
C
C  no test for chain 2 / mass constraint from DIQVS
        IJNCH2=0
        NNCH2=0
       QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQDVA1(N,1)=PTXSQ1
       PQDVA1(N,2)=PTYSQ1
       PQDVA1(N,3)=PLQ1
       PQDVA1(N,4)=EQ1
       PQDVA2(N,1)=PTXSQ2
       PQDVA2(N,2)=PTYSQ2
       PQDVA2(N,3)=PLQ2
       PQDVA2(N,4)=EQ2
       PQDVB1(N,1)=PTXSA2
       PQDVB1(N,2)=PTYSA2
       PQDVB1(N,3)=PLAQ2
       PQDVB1(N,4)=EAQ2
       PQDVB2(N,1)=PTXSA1
       PQDVB2(N,2)=PTYSA1
       PQDVB2(N,3)=PLAQ1
       PQDVB2(N,4)=EAQ1
C-------------------

C
C                                      PUT D-V CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
****  keep for the moment the old s-v notations
C                                 FLAG FOR DV-CHAIN ENDS
C                                            PROJECTILE: ISTHKK=131
C                                            TARGET:     ISTHKK=122
C                                      FOR DV-CHAINS     ISTHKK=4
C
        IHKKPD=JHKKPS(IXSPR )
        IHKKPO=JHKKPS(IXSPR )-1
        IHKKTD=JHKKTV(IXVTA )
        IHKKTO=JHKKTV(IXVTA )-1
        IF (IPEV.GT.3)WRITE(6,1000)IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1010)IXVTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXVTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
         IF (IPEV.GE.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQDVA1(N,1)
        PHKK(2,IHKK)=PQDVA1(N,2)
        PHKK(3,IHKK)=PQDVA1(N,3)
        PHKK(4,IHKK)=PQDVA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
         IF (IPEV.GE.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=122
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQDVA2(N,1)
        PHKK(2,IHKK)=PQDVA2(N,2)
        PHKK(3,IHKK)=PQDVA2(N,3)
        PHKK(4,IHKK)=PQDVA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
         IF (IPEV.GE.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=4
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKDV(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C                                   CHAIN 2 projectile sea antidiquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
         IF (IPEV.GE.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQDVB1(N,1)
        PHKK(2,IHKK)=PQDVB1(N,2)
        PHKK(3,IHKK)=PQDVB1(N,3)
        PHKK(4,IHKK)=PQDVB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
         IF (IPEV.GE.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=122
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQDVB2(N,1)
        PHKK(2,IHKK)=PQDVB2(N,2)
        PHKK(3,IHKK)=PQDVB2(N,3)
        PHKK(4,IHKK)=PQDVB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
         IF (IPEV.GE.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=4
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKDV(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
*     sea diquark pair!
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCDV1(N)=AMCH1
        AMCDV2(N)=AMCH2
        GACDV1(N)=QECH1/AMCH1
        BGXDV1(N)=QTXCH1/AMCH1
        BGYDV1(N)=QTYCH1/AMCH1
        BGZDV1(N)=QTZCH1/AMCH1
        GACDV2(N)=QECH2/AMCH2
        BGXDV2(N)=QTXCH2/AMCH2
        BGYDV2(N)=QTYCH2/AMCH2
        BGZDV2(N)=QTZCH2/AMCH2
        NCHDV1(N)=NNCH1
        NCHDV2(N)=NNCH2
        IJCDV1(N)=IJNCH1
        IJCDV2(N)=IJNCH2
        IF (IPEV.GE.6) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/                8F15.5)') ' DV / FINAL PRINT',N
C    +, XPSQ
C    +  (IXSPR),XPSAQ(IXSPR),XTVQ(IXVTA),XTVD(IXVTA), IPSQ(IXSPR),IPSAQ
C    +  (IXSPR), ITVQ(IXVTA),ITTV1(IXVTA),ITTV2(IXVTA), AMCDV1(N),AMCDV2
C    +  (N),GACDV1(N),GACDV2(N), BGXDV1(N),BGYDV1(N),BGZDV1(N), BGXDV2
C    +  (N),BGYDV2(N),BGZDV2(N), NCHDV1(N),NCHDV2(N),IJCDV1(N),IJCDV2
C    +  (N), (PQDVA1(N,JU),PQDVA2(N,JU),PQDVB1(N,JU), PQDVB2(N,JU),JU=1,
C    +  4)
   10 CONTINUE
      RETURN
C
   20 CONTINUE
C                                     EVENT REJECTED
C                                     START A NEW ONE
      IREJDV=1
      ISSQQ=IPSQ(IXSPR)
      JSSQQ=IPSQ2(IXSPR)
      IF(ISSQQ.EQ.3.AND.JSSQQ.EQ.3)THEN
        IDVRE(3)=IDVRE(3)+1
      ELSEIF(ISSQQ.EQ.3.OR.JSSQQ.EQ.3)THEN
        IDVRE(2)=IDVRE(2)+1
      ELSE
        IDVRE(1)=IDVRE(1)+1
      ENDIF
      RETURN
      END
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C     DEBUG SUBCHK
C     END DEBUG
      SUBROUTINE HADRDV
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       hadronize sea diquark - valence CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRDV.
      COMMON /ABRDV/ AMCDV1(248),AMCDV2(248),GACDV1(248),GACDV2(248),
     +BGXDV1(248),BGYDV1(248),BGZDV1(248), BGXDV2(248),BGYDV2(248),
     +BGZDV2(248), NCHDV1(248),NCHDV2(248),IJCDV1(248),IJCDV2(248),
     +PQDVA1(248,4),PQDVA2(248,4), PQDVB1(248,4),PQDVB2(248,4)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALDV /0/
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' hadrdv'
C-----------------------------------------------------------------------
      NCALDV=NCALDV+1
      DO 50 I=1,NDV
C-----------------------drop recombined chain pairs
        IF(NCHDV1(I).EQ.99.AND.NCHDV2(I).EQ.99) GO TO 50
        IS1=INTDV1(I)
        IS2=INTDV2(I)
	IF(IPCO.GE.3)WRITE(6,*)' hadrdv I IS1,IS2 ',I,IS1,IS2
C
        IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITVQ(IS2),
     +  ITTV1(IS2),ITTV2(IS2), AMCDV1(I),AMCDV2(I),GACDV1(I),GACDV2(I),
     +  BGXDV1(I),BGYDV1(I),BGZDV1(I), BGXDV2(I),BGYDV2(I),BGZDV2(I),
     +  NCHDV1(I),NCHDV2(I),IJCDV1(I),IJCDV2(I), PQDVA1(I,4),PQDVA2
     +  (I,4),PQDVB1(I,4),PQDVB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  diquark-quark   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=IPSQ2(IS1)
        IFB3=ITVQ(IS2)
        DO 10 J=1,4
          POJ(J)=PQDVA1(I,J)
          PAT(J)=PQDVA2(I,J)
   10   CONTINUE
        IF((NCHDV1(I).NE.0.OR.NCHDV2(I).NE.0).AND.IP.NE.1)
     &  CALL SAPTRE(AMCDV1(I),GACDV1(I),BGXDV1(I),BGYDV1(I),BGZDV1(I),
     &              AMCDV2(I),GACDV2(I),BGXDV2(I),BGYDV2(I),BGZDV2(I))
C----------------------------------------------------------------
C       WRITE (6,1244) POJ,PAT
C1244   FORMAT ('  D-V QUARK-DIQUARK POJ,PAT ',8E12.3)
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Projectile Nr ippp= IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
       IF(IPCO.GE.3)WRITE(6,*)' INTDV1(I) ',INTDV1(I)
C      IPPP = IFROVP(INTVS1(I))
C      IPPP = IFROVP(INTDV1(I))
       IF(INTDV1(I).GE.1)THEN
       IPPPP = IFROSP(INTDV1(I))
       ELSE
       IPPPP=0
       ENDIF
       IF(IPCO.GE.3)WRITE(6,*)' IPPP,IPPPP ',IPPP,IPPPP
       IF(IPPPP.GE.1)THEN
       JIPP=JSSHS(IPPPP)
       ELSE
       JIPP=0
       ENDIF
C      JIPP=1
       IF(IPCO.GE.3)WRITE(6,*)' JIPP ',JIPP
C       IF(NCHVS2(I).EQ.0)THEN
       IF(IPCO.GE.3)WRITE(6,'(A,3I5)')'HADRVS: I,IPPP,JIPP ',
     *                     I,IPPP,JIPP
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB1.LE.2.AND.IFB2.LE.2)THEN
	   NDVUU=NDVUU+1
	 ELSEIF((IFB1.EQ.3.AND.IFB2.LE.2).OR.
     *  	 (IFB2.EQ.3.AND.IFB1.LE.2))THEN
	   NDVUS=NDVUS+1
	 ELSEIF(IFB1.EQ.3.AND.IFB2.EQ.3)THEN
	   NDVSS=NDVSS+1
	 ENDIF  
         IF (NCHDV1(I).NE.0)
     *   CALL HADJET(NHAD,AMCDV1(I),POJ,PAT,GACDV1(I),
     *  BGXDV1(I), BGYDV1
     +  (I),BGZDV1(I),IFB1,IFB2,IFB3,IFB4, IJCDV1(I),
     *  IJCDV1(I),6,NCHDV1
     +  (I),11)
C--------------------------------------------------------------------
        ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JIPP)*PDBSE +ZSEAWU*PDBSEU
        IF(IPCO.GE.1)WRITE(6,*)'HADJSE JIPP,RSEACK,PDBSE 1 dpmnuc5',
     +  JIPP,RSEACK,PDBSE
C--------------------------------------------------------------------
        IF(NCHDV1(I).EQ.0)THEN
C---------------------------------------------------------------------
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCDV1(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJSE(NHAD,AMCDV1(I),POJ,PAT,GACDV1(I),BGXDV1(I),
     *        BGYDV1
     +        (I),BGZDV1(I),IFB1,IFB2,IFB3,IFB4, IJCDV1(I),IJCDV1(I),6,
     *        NCHDV1
     +        (I),6,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *        'RSEACK,IREJSS 1 dpmnuc5  ',
     +        JIPP,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSE=IREJSE+1
              IF(IREJSS.EQ.3)IREJS3=IREJS3+1
              IF(IREJSS.EQ.2)IREJS0=IREJS0+1
              CALL HADJET(NHAD,AMCDV1(I),POJ,PAT,GACDV1(I),
     *        BGXDV1(I), BGYDV1
     +        (I),BGZDV1(I),IFB1,IFB2,IFB3,IFB4, IJCDV1(I),
     *        IJCDV1(I),6,NCHDV1
     +        (I),11)
              IHAD6=IHAD6+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISE63=ISE63+1
              ELSE
                ISE6=ISE6+1
              ENDIF
            ENDIF 
          ELSE
            CALL HADJET(NHAD,AMCDV1(I),POJ,PAT,GACDV1(I),
     *      BGXDV1(I), BGYDV1
     +      (I),BGZDV1(I),IFB1,IFB2,IFB3,IFB4, IJCDV1(I),
     *      IJCDV1(I),6,NCHDV1
     +      (I),11)
            IHAD6=IHAD6+1
          ENDIF
        ENDIF
C--------------------------------------------------------------------
          ACOUDV=ACOUDV+1
          NHKKAU=NHKK+1
        DO 20 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRDV: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
          IF (NHKK.EQ.NMXHKK)THEN
            WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
          IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &      ' HADRDV / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *      '  NCALDV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *      NCALDV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
            HEF(J)=EHECC
          ENDIF
          ANNDV=ANNDV+1
          EEDV=EEDV+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTDV=PTDV+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKDV(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2: adiquark - diquark  +++++++++
        IFB1=IPSAQ(IS1)
        IFB2=IPSAQ2(IS1)
        IFB3=ITTV1(IS2)
        IFB4=ITTV2(IS2)
        IFB1=IABS(IFB1)+6
        IFB2=IABS(IFB2)+6
        DO 30 J=1,4
          POJ(J)=PQDVB2(I,J)
          PAT(J)=PQDVB1(I,J)
   30   CONTINUE
C
         IF(IFB1.LE.8.AND.IFB2.LE.8)THEN
	   NADVUU=NADVUU+1
	 ELSEIF((IFB1.EQ.9.AND.IFB2.LE.8).OR.
     *  	 (IFB2.EQ.9.AND.IFB1.LE.8))THEN
	   NADVUS=NADVUS+1
	 ELSEIF(IFB1.EQ.9.AND.IFB2.EQ.9)THEN
	   NADVSS=NADVSS+1
	 ENDIF  
        CALL HADJET(NHAD,AMCDV2(I),POJ,PAT,GACDV2(I),
     *  BGXDV2(I), BGYDV2
     +  (I),BGZDV2(I),IFB1,IFB2,IFB3,IFB4, IJCDV2(I),
     *  IJCDV2(I),5,NCHDV2
     +  (I),12)
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRDV: NHKK.EQ.NMXHKK ', NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C             WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRDV / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALDV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALDV, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNDV=ANNDV+1
          EEDV=EEDV+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTDV=PTDV+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKDV(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE DIQVS(ECM,IPV,J,IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*  define v-d chains (valence - sea diquark chains)
*  q-sqsq and qq-saqsaq chains instead of qq-sq and q-saq chains
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRVD.
      COMMON /ABRVD/ AMCVD1(248),AMCVD2(248),GACVD1(248),GACVD2(248),
     +BGXVD1(248),BGYVD1(248),BGZVD1(248), BGXVD2(248),BGYVD2(248),
     +BGZVD2(248), NCHVD1(248),NCHVD2(248),IJCVD1(248),IJCVD2(248),
     +PQVDA1(248,4),PQVDA2(248,4), PQVDB1(248,4),PQVDB2(248,4)
*KEND.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON/SEASU3/SEASQ
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA, CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C-----------------------------------------------------------------------
C     COMMON /PCHARM/PCCCC
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH5.EQ.0)THEN
        SEASQ=0.5D0
        RX=8.D0
        X1=RX
        GM=2.140D0
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.D0
      X1=RX
      BETCHA=BETOO+1.3D0-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
C     PC=PC1/2.9
C                       changed j.r.14.12.94
C     PC=PC1/5.0
C     PC=PC1/10.0
      PCC1=PC1/4.0D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
      PU1=PU/(2*PU+PS+PC)
      PS1=PS/(2*PU+PS+PC)
      IF(INICH5.EQ.0)THEN
        INICH5=1
        IF(IPHKK.GE.1) WRITE(6,4567)PC,BETCHA,PU1,PS1,SEASQ
 4567   FORMAT(' Charm chain ends DIQVS: PC,BETCHA,PU,PS,SEASQ ',5F10.5)
      ENDIF
C----------------------------------------------------------------------
      IF(IPHKK.GE.6)WRITE (6,'( A,2I10)') ' diqvs IPV,J ',IPV,J
      IREJ=0
*  kinematics: is the mass of both chains big enough
*              to allow for fragmentation
      ITSQ2(J)=1.D0+RNDM(v1)*(2.D0+2.D0*SEASQ)
        RR=RNDM(V)
	IF(RR.LT.PC)ITSQ2(J)=4
C-----------------------------------------------------------------------
      ITSAQ2(J)=-ITSQ2(J)
C---------------------------------------------------j.r.29.4.94
C                                   x**1.5 distr for sea diquarks
C                         number of target nucleon
      INUCTA=IFROST(J)
C                          number of target diquark
      IITOT=ITOVT(INUCTA)
C                          diquark x
      XTDIQU=XTVD(IITOT)
C                          minimal value of diquark x
      XDTHR=CDQ/ECM
C
      XDFREE=XTDIQU-XDTHR
      XALL=XDFREE+XTSQ(J)+XTSAQ(J)-2.*XDTHR
      XDALT=XTVD(IITOT)
      XSALT=XTSQ(J)
      XAALT=XTSAQ(J)
      IF(XALL.GE.0.)THEN
        RR1=RNDM(V1)
        RR2=RNDM(V2)
        RR3=RNDM(V3)
        SR123=RR1+RR2+RR3
        DX1=RR1*XALL/SR123
        DX2=RR2*XALL/SR123
        DX3=RR3*XALL/SR123
        XTVD(IITOT)=XDTHR+DX1
        XTSQ(J)=XDTHR+DX2
        XTSAQ(J)=XDTHR+DX3
      ENDIF
C--------------------------------------------------------------

      AMVDQ1=XTSQ(J)*XPVQ(IPV)*ECM**2
      AMVDQ2=XTSAQ(J)*XPVD(IPV)*ECM**2
      IDIQRE(1)=IDIQRE(1)+1
      IF(ITSQ(J).GE.3.AND.ITSQ2(J).GE.3)THEN
      IDIQRE(2)=IDIQRE(2)+1
C       IF(AMVDQ2.LE.9.0.OR.AMVDQ1.LE.2.30) THEN
        IF(AMVDQ2.LE.17.0D0.OR.AMVDQ1.LE.6.60D0) THEN
          IREJ=1
           IDIQRE(3)=IDIQRE(3)+1
           IDIQRE(2)=IDIQRE(2)-1
           IDIQRE(1)=IDIQRE(1)-1
          XTVD(IITOT)=XDALT
          XTSQ(J)=XSALT
          XTSAQ(J)=XAALT
          RETURN
        ENDIF
      ELSEIF(ITSQ(J).GE.3.OR.ITSQ2(J).GE.3)THEN
      IDIQRE(4)=IDIQRE(4)+1
C       IF(AMVDQ2.LE.7.3D0.OR.AMVDQ1.LE.1.90D0) THEN
        IF(AMVDQ2.LE.13.6.OR.AMVDQ1.LE.5.80) THEN
          IREJ=1
           IDIQRE(5)=IDIQRE(5)+1
           IDIQRE(4)=IDIQRE(4)-1
           IDIQRE(1)=IDIQRE(1)-1
          XTVD(IITOT)=XDALT
          XTSQ(J)=XSALT
          XTSAQ(J)=XAALT
          RETURN
        ENDIF
      ELSE
      IDIQRE(6)=IDIQRE(6)+1
C       IF(AMVDQ2.LE.6.70.OR.AMVDQ1.LE.1.50) THEN
        IF(AMVDQ2.LE.12.40D0.OR.AMVDQ1.LE.3.9D0) THEN
          IREJ=1
           IDIQRE(7)=IDIQRE(7)+1
           IDIQRE(6)=IDIQRE(6)-1
           IDIQRE(1)=IDIQRE(1)-1
          XTVD(IITOT)=XDALT
          XTSQ(J)=XSALT
          XTSAQ(J)=XAALT
          RETURN
        ENDIF
      ENDIF
      NVD=NVD+1
c     WRITE(6,'(A/5X,3F10.3,3I5/5X,3F10.3)')
c    +    ' DIQVS: AMVDQ1, XTSQ, XPVQ, IPV,J, NVD/ AMVDQ2, XTSAQ, XPVD',
c    +  AMVDQ1,XTSQ(J),XPVQ(IPV),IPV,J, NVD, AMVDQ2,XTSAQ(J),XPVD(IPV)
      NCHVD1(NVD)=0
      NCHVD2(NVD)=0
      INTVD1(NVD)=IPV
      INTVD2(NVD)=J
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C      DEBUG SUBCHK
C      END DEBUG
      SUBROUTINE KKEVVD(IREJVD)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C------------------ treatment of valence - sea diquark CHAIN SYSTEMS
C
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRVD.
      COMMON /ABRVD/ AMCVD1(248),AMCVD2(248),GACVD1(248),GACVD2(248),
     +BGXVD1(248),BGYVD1(248),BGZVD1(248), BGXVD2(248),BGYVD2(248),
     +BGZVD2(248), NCHVD1(248),NCHVD2(248),IJCVD1(248),IJCVD2(248),
     +PQVDA1(248,4),PQVDA2(248,4), PQVDB1(248,4),PQVDB2(248,4)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
*KEND.
C-------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' kkevvd'
      IREJVD=0
      DO 10 N=1,NVD
C---------------------------drop recombined chain pairs
        IF(NCHVD1(N).EQ.99.AND.NCHVD2(N).EQ.99)GO TO 10
C
C***            4-MOMENTA OF projectile QUARK-DIQUARK PAIRS IN NN-CMS
        IXVPR=INTVD1(N)
        INUCPR=IFROVP(IXVPR)
        JNUCPR=ITOVP(INUCPR)
C
        PVQPX=XPVQ(IXVPR)*PRMOM(1,INUCPR)
        PVQPY=XPVQ(IXVPR)*PRMOM(2,INUCPR)
        PVQPZ=XPVQ(IXVPR)*PRMOM(3,INUCPR)
        PVQE=XPVQ(IXVPR)*PRMOM(4,INUCPR)
        PVDQPX=XPVD(IXVPR)*PRMOM(1,INUCPR)
        PVDQPY=XPVD(IXVPR)*PRMOM(2,INUCPR)
        PVDQPZ=XPVD(IXVPR)*PRMOM(3,INUCPR)
        PVDQE=XPVD(IXVPR)*PRMOM(4,INUCPR)
C
C***                 4-MOMENTA OF TARGET QUARK-DIQUARK PAIRS IN NN-CMS
        IXSTA=INTVD2(N)
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
*
        TSQPX=XTSQ(IXSTA)*TAMOM(1,INUCTA)
        TSQPY=XTSQ(IXSTA)*TAMOM(2,INUCTA)
        TSQPZ=XTSQ(IXSTA)*TAMOM(3,INUCTA)
        TSQE=XTSQ(IXSTA)*TAMOM(4,INUCTA)
        TSAQPX=XTSAQ(IXSTA)*TAMOM(1,INUCTA)
        TSAQPY=XTSAQ(IXSTA)*TAMOM(2,INUCTA)
        TSAQPZ=XTSAQ(IXSTA)*TAMOM(3,INUCTA)
        TSAQE=XTSAQ(IXSTA)*TAMOM(4,INUCTA)
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C                                               j.r.6.5.93
C
C                     multiple scattering of VALENCE quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PVQPX,PVQPY,PVQPZ,PVQE,RTIX,RTIY,RTIZ,
     *            PVQNX,PVQNY,PVQNZ,PVQNE,55)
      PVQPX=PVQNX
      PVQPY=PVQNY
      PVQPZ=PVQNZ
      PVQE=PVQNE      
      CALL CROMSC(PVDQPX,PVDQPY,PVDQPZ,PVDQE,RTIX,RTIY,RTIZ,
     *            PVDQNX,PVDQNY,PVDQNZ,PVDQNE,56)
      PVDQPX=PVDQNX
      PVDQPY=PVDQNY
      PVDQPZ=PVDQNZ
      PVDQE=PVDQNE      
C                                                ---------
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TSQPX,TSQPY,TSQPZ,TSQE,RTIX,RTIY,RTIZ,
     *            TSQNX,TSQNY,TSQNZ,TSQNE,57)
      TSQPX=TSQNX
      TSQPY=TSQNY
      TSQPZ=TSQNZ
      TSQE=TSQNE      
      CALL CROMSC(TSAQPX,TSAQPY,TSAQPZ,TSAQE,RTIX,RTIY,RTIZ,
     *            TSAQNX,TSAQNY,TSAQNZ,TSAQNE,58)
      TSAQPX=TSAQNX
      TSAQPY=TSAQNY
      TSAQPZ=TSAQNZ
      TSAQE=TSAQNE  
      ENDIF    
C                                                ---------
C                                                ---------
C                                                j.r.10.5.93
       IF(IP.GE.0)GO TO 1779
        PVQPZ2=PVQE**2-PVQPX**2-PVQPY**2
        IF(PVQPZ2.GE.0.)THEN
          PVQPZ=SQRT(PVQPZ2)
        ELSE
          PVQPX=0.
          PVQPY=0.
          PVQPZ=PVQE
        ENDIF
C
        PDQPZ2=PVDQE**2-PVDQPX**2-PVDQPY**2
        IF(PDQPZ2.GE.0.)THEN
          PVDQPZ=SQRT(PDQPZ2)
        ELSE
          PVDQPX=0.
          PVDQPY=0.
          PVDQPZ=PVDQE
        ENDIF
C
        TSQPZ2=TSQE**2-TSQPX**2-TSQPY**2
        IF(TSQPZ2.GE.0.)THEN
          TSQPZ=-SQRT(TSQPZ2)
        ELSE
          TSQPX=0.
          TSQPY=0.
          TSQPZ=TSQE
        ENDIF
C
        TAQPZ2=TSAQE**2-TSAQPX**2-TSAQPY**2
        IF(TAQPZ2.GE.0.)THEN
          TSAQPZ=-SQRT(TAQPZ2)
        ELSE
          TSAQPX=0.
          TSAQPY=0.
          TSAQPZ=TSAQE
        ENDIF
 1779  CONTINUE 
C                                            ----------------
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PVQPX
        PTXSA1=PVDQPX
        PTXSQ2=TSQPX
        PTXSA2=TSAQPX
        PTYSQ1=PVQPY
        PTYSA1=PVDQPY
        PTYSQ2=TSQPY
        PTYSA2=TSAQPY
        PLQ1=PVQPZ
        PLAQ1=PVDQPZ
        PLQ2=TSQPZ
        PLAQ2=TSAQPZ
        EQ1=PVQE
        EAQ1=PVDQE
        EQ2=TSQE
        EAQ2=TSAQE
C                                       ---------------
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
        IKVALA=0
         IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVVD - IRVD13=',IRVD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:   ...', PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
        IKVALA=0
        NSELPT=1
        NSELPT=0
	IF(IP.EQ.1)NSELPT=1
        IF(NSELPT.EQ.1)CALL SELPT(PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     * PTTQ2,PTTA2,
     * NSELPT)
        IF(NSELPT.EQ.0)CALL SELPT4(PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,NSELPT)
         IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVVD - IRVD13=',IRVD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:   ...', PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
             WRITE(6,'(A,I5)') ' KKEVVD - IRVD13=',IRVD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:  amch1,amch2 ',
     +          AMCH1,AMCH2
          ENDIF

        IF (IPEV.GE.7) WRITE(6,'(A/5X,I10)')
     +  'VD   IREJ ', IREJ
        IF (IREJ.EQ.1) THEN
          IRVD13=IRVD13 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' KKEVVD - IRVD13=',IRVD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:   ...', PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
 
          ENDIF
                                                                GO TO 20
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSQ2
        PTYCH1=PTYSQ1 + PTYSQ2
        PTZCH1=PLQ1 + PLQ2
        ECH1=EQ1 + EQ2
        PTXCH2=PTXSA2 + PTXSA1
        PTYCH2=PTYSA2 + PTYSA1
        PTZCH2=PLAQ2 + PLAQ1
        ECH2=EAQ2 + EAQ1
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' VD: IREJ ', IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ quark - tar sea-diquark)
C
        CALL COBCMA(ITSQ(IXSTA),ITSQ2(IXSTA),IPVQ(IXVPR), IJNCH1,NNCH1,
     +  IREJ,AMCH1,AMCH1N,1)
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJ.EQ.1) THEN
          IRVD11=IRVD11 + 1
          IF(IPEV.GE.1) THEN
            WRITE(6,'(A,I5)') ' KKEVVD - IRVD11=',IRVD11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' VD:', IPVQ(IXVPR),ITSQ
     +      (IXSTA),ITSQ2(IXSTA),IJNCH1,NNCH1,IREJ, XPVQ(IXVPR),XPVD
     +      (IXVPR),XPVQCM,XPVDCM,
     + XTSQ(IXSTA),XTSAQ(IXSTA),AMCH1,AMCH1N
 
          ENDIF
                                                              GOTO 20
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)THEN
           CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N,
     +         PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +         PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +         PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +         PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +         PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,ECH2,
     +         IREJ)
        AMCH2=AMCH2N
        ENDIF
        IF(IREJ.EQ.1)THEN
	  IF(IPEV.GE.1)WRITE(6,'(A)')' vd CORMOM rej.'
	  GO TO 20
        ENDIF
C
        IF (IPEV.GE.6) WRITE(6,'(A,5F12.5,I10/A,5F12.5/A,5F12.5)')
     +  ' VD(2): AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJ ', AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
C
C  no test for chain 2 / mass constraint from DIQVS
        IJNCH2=0
        NNCH2=0
        QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQVDA1(N,1)=PTXSQ1
       PQVDA1(N,2)=PTYSQ1
       PQVDA1(N,3)=PLQ1
       PQVDA1(N,4)=EQ1
       PQVDA2(N,1)=PTXSQ2
       PQVDA2(N,2)=PTYSQ2
       PQVDA2(N,3)=PLQ2
       PQVDA2(N,4)=EQ2
       PQVDB1(N,1)=PTXSA2
       PQVDB1(N,2)=PTYSA2
       PQVDB1(N,3)=PLAQ2
       PQVDB1(N,4)=EAQ2
       PQVDB2(N,1)=PTXSA1
       PQVDB2(N,2)=PTYSA1
       PQVDB2(N,3)=PLAQ1
       PQVDB2(N,4)=EAQ1
C
C
C
C                                      PUT D-V CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
****  keep for the moment the old v-s notations
C                                 FLAG FOR VD-CHAIN ENDS
C                                            PROJECTILE: ISTHKK=121
C                                            TARGET:     ISTHKK=132
C                                      FOR VD-CHAINS     ISTHKK=5
C
        IHKKPD=JHKKPV(IXVPR )
        IHKKPO=JHKKPV(IXVPR )-1
        IHKKTD=JHKKTS(IXSTA )
        IHKKTO=JHKKTS(IXSTA )-1
        IF (IPEV.GT.3)WRITE(6,1000)IXVPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXVPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1010)IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=121
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQVDA1(N,1)
        PHKK(2,IHKK)=PQVDA1(N,2)
        PHKK(3,IHKK)=PQVDA1(N,3)
        PHKK(4,IHKK)=PQVDA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQVDA2(N,1)
        PHKK(2,IHKK)=PQVDA2(N,2)
        PHKK(3,IHKK)=PQVDA2(N,3)
        PHKK(4,IHKK)=PQVDA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=5
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKVD(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C                                   CHAIN 2 projectile sea antidiquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=121
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQVDB1(N,1)
        PHKK(2,IHKK)=PQVDB1(N,2)
        PHKK(3,IHKK)=PQVDB1(N,3)
        PHKK(4,IHKK)=PQVDB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQVDB2(N,1)
        PHKK(2,IHKK)=PQVDB2(N,2)
        PHKK(3,IHKK)=PQVDB2(N,3)
        PHKK(4,IHKK)=PQVDB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=5
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKVD(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
*     sea diquark pair!
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCVD1(N)=AMCH1
        AMCVD2(N)=AMCH2
        GACVD1(N)=QECH1/AMCH1
        BGXVD1(N)=QTXCH1/AMCH1
        BGYVD1(N)=QTYCH1/AMCH1
        BGZVD1(N)=QTZCH1/AMCH1
        GACVD2(N)=QECH2/AMCH2
        BGXVD2(N)=QTXCH2/AMCH2
        BGYVD2(N)=QTYCH2/AMCH2
        BGZVD2(N)=QTZCH2/AMCH2
        NCHVD1(N)=NNCH1
        NCHVD2(N)=NNCH2
        IJCVD1(N)=IJNCH1
        IJCVD2(N)=IJNCH2
        IF (IPEV.GE.2) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/8F15.5/2I5)') ' VD / FINAL PRINT',N
C    +, XPVQ
C    +  (IXVPR),XPVD(IXVPR),XTSQ(IXSTA),XTSAQ(IXSTA), IPVQ(IXVPR),IPPV1
C    +  (IXVPR),IPPV2(IXVPR),ITSQ(IXSTA),ITSAQ(IXSTA), AMCVD1(N),AMCVD2
C    +  (N),GACVD1(N),GACVD2(N), BGXVD1(N),BGYVD1(N),BGZVD1(N), BGXVD2
C    +  (N),BGYVD2(N),BGZVD2(N), NCHVD1(N),NCHVD2(N),IJCVD1(N),IJCVD2
C    +  (N), (PQVDA1(N,JU),PQVDA2(N,JU),PQVDB1(N,JU), PQVDB2(N,JU),JU=1,
C    +  4),
C    +  IXVPR,IXSTA
   10 CONTINUE
      RETURN
C
   20 CONTINUE
C                                     EVENT REJECTED
C                                     START A NEW ONE
      IREJVD=1
      ISSQQ=ITSQ(IXSTA)
      JSSQQ=ITSQ2(IXSTA)
      IF(ISSQQ.EQ.3.AND.JSSQQ.EQ.3)THEN
        IVDRE(3)=IVDRE(3)+1
      ELSEIF(ISSQQ.EQ.3.OR.JSSQQ.EQ.3)THEN
        IVDRE(2)=IVDRE(2)+1
      ELSE
        IVDRE(1)=IVDRE(1)+1
      ENDIF
      RETURN
      END
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C     DEBUG SUBCHK
C     END DEBUG
      SUBROUTINE HADRVD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       hadronize sea diquark - valence CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRVD.
      COMMON /ABRVD/ AMCVD1(248),AMCVD2(248),GACVD1(248),GACVD2(248),
     +BGXVD1(248),BGYVD1(248),BGZVD1(248), BGXVD2(248),BGYVD2(248),
     +BGZVD2(248), NCHVD1(248),NCHVD2(248),IJCVD1(248),IJCVD2(248),
     +PQVDA1(248,4),PQVDA2(248,4), PQVDB1(248,4),PQVDB2(248,4)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALVD /0/
C-----------------------------------------------------------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' hadrvd'
      NCALVD=NCALVD+1
      DO 50 I=1,NVD
C-----------------------drop recombined chain pairs
        IF(NCHVD1(I).EQ.99.AND.NCHVD2(I).EQ.99) GO TO 50
        IS1=INTVD1(I)
        IS2=INTVD2(I)
C
        IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITVQ(IS2),
     +  ITTV1(IS2),ITTV2(IS2), AMCVD1(I),AMCVD2(I),GACVD1(I),GACVD2(I),
     +  BGXVD1(I),BGYVD1(I),BGZVD1(I), BGXVD2(I),BGYVD2(I),BGZVD2(I),
     +  NCHVD1(I),NCHVD2(I),IJCVD1(I),IJCVD2(I), PQVDA1(I,4),PQVDA2
     +  (I,4),PQVDB1(I,4),PQVDB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  quark-diquark   +++++++++++
        IFB1=IPVQ(IS1)
        IFB2=ITSQ(IS2)
        IFB3=ITSQ2(IS2)
        DO 10 J=1,4
          POJ(J)=PQVDA1(I,J)
          PAT(J)=PQVDA2(I,J)
   10   CONTINUE
        IF((NCHVD1(I).NE.0.OR.NCHVD2(I).NE.0).AND.IP.NE.1)
     &  CALL SAPTRE(AMCVD1(I),GACVD1(I),BGXVD1(I),
     *  BGYVD1(I),BGZVD1(I),
     &              AMCVD2(I),GACVD2(I),BGXVD2(I),
     *  BGYVD2(I),BGZVD2(I))
C----------------------------------------------------------------
C----------------------------------------------------------------
C       WRITE (6,1244) POJ,PAT
C1244   FORMAT ('  V-D QUARK-DIQUARK POJ,PAT ',8E12.3)
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
C      ITTT = IFROVT(INTSV2(I))
C      IF(INTVD2(I).GE.1)THEN
C      ITTT = IFROVT(INTVD2(I))
C      ELSE
       ITTT=0
C      ENDIF
C      IF(ITTT.GE.1)THEN
C     JITT=JTSHS(ITTT)
C      ELSE
       JITT=0
C      ENDIF
C       IF(NCHSV1(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRSV: I,ITTT,JITT ',
C    *                     I,ITTT,JITT
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB2.LE.2.AND.IFB3.LE.2)THEN
	   NVDUU=NVDUU+1
	 ELSEIF((IFB2.EQ.3.AND.IFB3.LE.2).OR.
     *  	 (IFB3.EQ.3.AND.IFB2.LE.2))THEN
	   NVDUS=NVDUS+1
	 ELSEIF(IFB2.EQ.3.AND.IFB3.EQ.3)THEN
	   NVDSS=NVDSS+1
	 ENDIF  
        IF((NCHVD1(I).NE.0))THEN
          CALL HADJET(NHAD,AMCVD1(I),POJ,PAT,GACVD1(I),
     *    BGXVD1(I), BGYVD1
     +    (I),BGZVD1(I),IFB1,IFB2,IFB3,IFB4, IJCVD1(I),
     *    IJCVD1(I),4,NCHVD1
     +    (I),13)
        ENDIF
C-----------------------------------------------------------------
        AACK=FLOAT(ICK4)/FLOAT(ICK4+IHAD4+1)
        IF((NCHVD1(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JITT,',
     *    'RSEACK,PDBSE 2 dpmnuc5 ',
     +    JITT,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCVD1(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJSE(NHAD,AMCVD1(I),POJ,PAT,GACVD1(I),
     *        BGXVD1(I),
     *        BGYVD1
     +        (I),BGZVD1(I),IFB1,IFB2,IFB3,IFB4, IJCVD1(I),
     *        IJCVD1(I),4,
     *        NCHVD1
     +        (I),3,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *        'RSEACK,IREJSS 2 dpmnuc5 ',
     +        JITT,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSE=IREJSE+1
              IF(IREJSS.EQ.3)IREJS3=IREJS3+1
              IF(IREJSS.EQ.2)IREJS0=IREJS0+1
              CALL HADJET(NHAD,AMCVD1(I),POJ,PAT,GACVD1(I),
     *        BGXVD1(I), BGYVD1
     +        (I),BGZVD1(I),IFB1,IFB2,IFB3,IFB4,
     *        IJCVD1(I),IJCVD1(I),4,NCHVD1
     +        (I),13)
              IHAD4=IHAD4+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISE43=ISE43+1
              ELSE
                ISE4=ISE4+1
              ENDIF
            ENDIF
          ELSE
            CALL HADJET(NHAD,AMCVD1(I),POJ,PAT,GACVD1(I),
     *      BGXVD1(I), BGYVD1
     +      (I),BGZVD1(I),IFB1,IFB2,IFB3,IFB4,
     *      IJCVD1(I),IJCVD1(I),4,NCHVD1
     +      (I),13)
            IHAD4=IHAD4+1
          ENDIF
        ENDIF

C-----------------------------------------------------------------
        ACOUVD=ACOUVD+1
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
            IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRVD: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
          IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRVD / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALVD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALVD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNVD=ANNVD+1
          EEVD=EEVD+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTVD=PTVD+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKVD(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2: diquark - adiquark  +++++++++
        IFB1=IPPV1(IS1)
        IFB2=IPPV2(IS1)
        IFB3=ITSAQ(IS2)
        IFB4=ITSAQ2(IS2)
        IFB3=IABS(IFB3)+6
        IFB4=IABS(IFB4)+6
        DO 30 J=1,4
          POJ(J)=PQVDB2(I,J)
          PAT(J)=PQVDB1(I,J)
   30   CONTINUE
C
        IF(AMCVD2(I).LT.2.3)THEN
          WRITE(6,'(A,F10.2,I5)')' HADRVD AMCVD2(I), I ',
     *    AMCVD2(I),I
          RETURN
        ENDIF
         IF(IFB3.LE.8.AND.IFB4.LE.8)THEN
	   NAVDUU=NAVDUU+1
	 ELSEIF((IFB3.EQ.9.AND.IFB4.LE.8).OR.
     *  	 (IFB4.EQ.9.AND.IFB3.LE.8))THEN
	   NAVDUS=NAVDUS+1
	 ELSEIF(IFB3.EQ.9.AND.IFB4.EQ.9)THEN
	   NAVDSS=NAVDSS+1
	 ENDIF  
        CALL HADJET(NHAD,AMCVD2(I),POJ,PAT,GACVD2(I),
     *  BGXVD2(I), BGYVD2
     +  (I),BGZVD2(I),IFB1,IFB2,IFB3,IFB4, IJCVD2(I),
     *  IJCVD2(I),5,NCHVD2
     +  (I),14)
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRVD: NHKK.EQ.NMXHKK ',
     *      NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C             WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRVD / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALVD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALVD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNVD=ANNVD+1
          EEVD=EEVD+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTVD=PTVD+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKVD(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C
C ---------------------------------------------------------------
C
      SUBROUTINE DIQDSS(ECM,ITS,IPS,IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*  define d-s chains (sea diquark - sea chains)
*  sqsq-sq and saqsaq-saq chains instead of q-aq and aq-q chains
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRDS.
      COMMON /ABRDS/ AMCDS1(248),AMCDS2(248),GACDS1(248),GACDS2(248),
     +BGXDS1(248),BGYDS1(248),BGZDS1(248), BGXDS2(248),BGYDS2(248),
     +BGZDS2(248), NCHDS1(248),NCHDS2(248),IJCDS1(248),IJCDS2(248),
     +PQDSA1(248,4),PQDSA2(248,4), PQDSB1(248,4),PQDSB2(248,4)
*KEND.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON/SEASU3/SEASQ
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA, CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C-----------------------------------------------------------------
C     COMMON /PCHARM/PCCCC
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH6.EQ.0)THEN
        SEASQ=0.5D0
        RX=8.D0
        X1=RX
        GM=2.140D0
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.D0
      X1=RX
      BETCHA=BETOO+1.3D0-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
C     PC=PC1/2.9
C                       changed j.r.14.12.94
C     PC=PC1/5.0
C     PC=PC1/10.0
      PCC1=PC1/7.0D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
      PU1=PU/(2*PU+PS+PC)
      PS1=PS/(2*PU+PS+PC)
      IF(INICH6.EQ.0)THEN
        INICH6=1
        IF(IPHKK.GE.1)WRITE(6,4567)PC,BETCHA,PU1,PS1,SEASQ
 4567   FORMAT(' Charm chain ends DIQDSS: PC,BETCHA,PU,PS,SEASQ',5F10.5)
      ENDIF
C----------------------------------------------------------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' diqdss'
      IREJ=0
*  kinematics: is the mass of the adiquark-diquark chain big enough
*              to allow for fragmentation
      IPSQ2(IPS)=1.D0+RNDM(v1)*(2.D0+2.D0*SEASQ)
      RR=RNDM(V)
      IF(RR.LT.PC)IPSQ2(IPS)=4
C-----------------------------------------------------------------
      IPSAQ2(IPS)=-IPSQ2(IPS)
C---------------------------------------------------j.r.29.4.94
C                                   x**1.5 distr for sea diquarks
C                         number of projectile nucleon
      INUCPR=IFROSP(IPS)
C                          number of projectile diquark
      IITOP=ITOVP(INUCPR)
C                          diquark x
      XPDIQU=XPVD(IITOP)
C                          minimal value of diquark x
      XDTHR=CDQ/ECM
C
      XDFREE=XPDIQU-XDTHR
      XALL=XDFREE+XPSQ(IPS)+XPSAQ(IPS)-2.*XDTHR
      XDALT=XPVD(IITOP)
      XSALT=XPSQ(IPS)
      XAALT=XPSAQ(IPS) 
      IF(XALL.GE.0.)THEN
        RR1=RNDM(V1)
        RR2=RNDM(V2)
        RR3=RNDM(V3)
        SR123=RR1+RR2+RR3
        DX1=RR1*XALL/SR123
        DX2=RR2*XALL/SR123
        DX3=RR3*XALL/SR123
        XPVD(IITOP)=XDTHR+DX1
        XPSQ(IPS)=XDTHR+DX2
        XPSAQ(IPS)=XDTHR+DX3
      ENDIF
C--------------------------------------------------------------
      AMDSQ1=XPSQ(IPS)*XTSQ(ITS)*ECM**2
      AMDSQ2=XPSAQ(IPS)*XTSAQ(ITS)*ECM**2
      IDIQRE(1)=IDIQRE(1)+1
      IF(IPSQ(IPS).GE.3.AND.IPSQ2(IPS).GE.3)THEN
        IDIQRE(2)=IDIQRE(2)+1
C       IF(AMDSQ2.LE.2.3.OR.AMDSQ1.LE.2.30) THEN
        IF(AMDSQ2.LE.6.6D0.OR.AMDSQ1.LE.6.60D0) THEN
          IREJ=1
          IDIQRE(3)=IDIQRE(3)+1
          IDIQRE(2)=IDIQRE(2)-1
          IDIQRE(1)=IDIQRE(1)-1
          XPVD(IITOP)=XDALT
          XPSQ(IPS)=XSALT
          XPSAQ(IPS)=XAALT
          RETURN
        ENDIF
      ELSEIF(IPSQ(IPS).GE.3.OR.IPSQ2(IPS).GE.3)THEN
        IDIQRE(4)=IDIQRE(4)+1
C       IF(AMDSQ2.LE.1.9.OR.AMDSQ1.LE.1.90) THEN
        IF(AMDSQ2.LE.5.8D0.OR.AMDSQ1.LE.5.80D0) THEN
          IREJ=1
          IDIQRE(5)=IDIQRE(5)+1
          IDIQRE(4)=IDIQRE(4)-1
          IDIQRE(1)=IDIQRE(1)-1
          XPVD(IITOP)=XDALT
          XPSQ(IPS)=XSALT
          XPSAQ(IPS)=XAALT
          RETURN
        ENDIF
      ELSE
        IDIQRE(6)=IDIQRE(6)+1
C       IF(AMDSQ2.LE.1.50.OR.AMDSQ1.LE.1.50) THEN
        IF(AMDSQ2.LE.3.9D0.OR.AMDSQ1.LE.3.9D0) THEN
          IREJ=1
          IDIQRE(7)=IDIQRE(7)+1
          IDIQRE(6)=IDIQRE(6)-1
          IDIQRE(1)=IDIQRE(1)-1
          XPVD(IITOP)=XDALT
          XPSQ(IPS)=XSALT
          XPSAQ(IPS)=XAALT
          RETURN
        ENDIF
      ENDIF
      NDS=NDS+1
      NCHDS1(NDS)=0
      NCHDS2(NDS)=0
      INTDS1(NDS)=IPS
      INTDS2(NDS)=ITS
C     WRITE(6,'(A/5X,3F10.3,3I5/5X,3F10.3)')
C    +' DIQDSS: AMDSQ1, XTSQ, XPSQ, ITS,IPS, NDS/ AMDSQ2, XTSAQ, XPSAQ',
C    +  AMDSQ1,XTSQ(ITS),XPSQ(IPS),ITS,IPS, NDS, AMDSQ2,
C    +XTSAQ(ITS),XPSAQ(IPS)
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C      DEBUG SUBCHK
C      END DEBUG
      SUBROUTINE KKEVDS(IREJDS)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C------------------ treatment of sea diquark - sea CHAIN SYSTEMS
C
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRDS.
      COMMON /ABRDS/ AMCDS1(248),AMCDS2(248),GACDS1(248),GACDS2(248),
     +BGXDS1(248),BGYDS1(248),BGZDS1(248), BGXDS2(248),BGYDS2(248),
     +BGZDS2(248), NCHDS1(248),NCHDS2(248),IJCDS1(248),IJCDS2(248),
     +PQDSA1(248,4),PQDSA2(248,4), PQDSB1(248,4),PQDSB2(248,4)
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
*KEND.
C-------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' kkevds'
      IREJDS=0
      DO 10 N=1,NDS
C---------------------------drop recombined chain pairs
        IF(NCHDS1(N).EQ.99.AND.NCHDS2(N).EQ.99)GO TO 10
C
C***                 4-MOMENTA OF PROJECTILE SEA-QUARK PAIRS IN NN-CMS
        IF(IPHKK.GE.7)WRITE(6,'(A,2I10)')' KKEVDS N,NDS',N,NDS
        IXSPR=INTDS1(N)
        IF(IPHKK.GE.7)WRITE(6,'(A,2I10)')' KKEVDS N,IXSPR',N,IXSPR
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
        IF(IPHKK.GE.7)WRITE(6,'(A,2I10)')' KKEVDS INUCPR,JNUCPR',
     + INUCPR,JNUCPR
C
        PSQPX=XPSQ(IXSPR)*PRMOM(1,INUCPR)
        PSQPY=XPSQ(IXSPR)*PRMOM(2,INUCPR)
        PSQPZ=XPSQ(IXSPR)*PRMOM(3,INUCPR)
        PSQE=XPSQ(IXSPR)*PRMOM(4,INUCPR)
        PSAQPX=XPSAQ(IXSPR)*PRMOM(1,INUCPR)
        PSAQPY=XPSAQ(IXSPR)*PRMOM(2,INUCPR)
        PSAQPZ=XPSAQ(IXSPR)*PRMOM(3,INUCPR)
        PSAQE=XPSAQ(IXSPR)*PRMOM(4,INUCPR)
C
C***                 4-MOMENTA OF TARGET QUARK-AQUARK PAIRS IN NN-CMS
        IXSTA=INTDS2(N)
        IF(IPHKK.GE.7)WRITE(6,'(A,2I10)')' KKEVDS N,IXSTA',N,IXSTA
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
        IF(IPHKK.GE.7)WRITE(6,'(A,2I10)')' KKEVDS INUCTA,JNUCTA',
     + INUCTA,JNUCTA
C
        TSQPX=XTSQ(IXSTA)*TAMOM(1,INUCTA)
        TSQPY=XTSQ(IXSTA)*TAMOM(2,INUCTA)
        TSQPZ=XTSQ(IXSTA)*TAMOM(3,INUCTA)
        TSQE=XTSQ(IXSTA)*TAMOM(4,INUCTA)
        TSDQPX=XTSAQ(IXSTA)*TAMOM(1,INUCTA)
        TSDQPY=XTSAQ(IXSTA)*TAMOM(2,INUCTA)
        TSDQPZ=XTSAQ(IXSTA)*TAMOM(3,INUCTA)
        TSDQE=XTSAQ(IXSTA)*TAMOM(4,INUCTA)
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PSQPX,PSQPY,PSQPZ,PSQE,RTIX,RTIY,RTIZ,
     *            PSQNX,PSQNY,PSQNZ,PSQNE,59)
      PSQPX=PSQNX
      PSQPY=PSQNY
      PSQPZ=PSQNZ
      PSQE=PSQNE      
      CALL CROMSC(PSAQPX,PSAQPY,PSAQPZ,PSAQE,RTIX,RTIY,RTIZ,
     *            PSAQNX,PSAQNY,PSAQNZ,PSAQNE,60)
      PSAQPX=PSAQNX
      PSAQPY=PSAQNY
      PSAQPZ=PSAQNZ
      PSAQE=PSAQNE      
C                                                ---------
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TSQPX,TSQPY,TSQPZ,TSQE,RTIX,RTIY,RTIZ,
     *            TSQNX,TSQNY,TSQNZ,TSQNE,61)
      TSQPX=TSQNX
      TSQPY=TSQNY
      TSQPZ=TSQNZ
      TSQE=TSQNE      
      CALL CROMSC(TSDQPX,TSDQPY,TSDQPZ,TSDQE,RTIX,RTIY,RTIZ,
     *            TSDQNX,TSDQNY,TSDQNZ,TSDQNE,62)
      TSDQPX=TSDQNX
      TSDQPY=TSDQNY
      TSDQPZ=TSDQNZ
      TSDQE=TSDQNE   
      ENDIF    
C                                                ---------
C                                                j.r.10.5.93
       IF(IP.GE.0)GO TO 1779
        PSQPZ2=PSQE**2-PSQPX**2-PSQPY**2
        IF(PSQPZ2.GE.0.)THEN
          PSQPZ=SQRT(PSQPZ2)
        ELSE
          PSQPX=0.
          PSQPY=0.
          PSQPZ=PSQE
        ENDIF
C
        PAQPZ2=PSAQE**2-PSAQPX**2-PSAQPY**2
        IF(PAQPZ2.GE.0.)THEN
          PSAQPZ=SQRT(PAQPZ2)
        ELSE
          PSAQPX=0.
          PSAQPY=0.
          PSAQPZ=PSAQE
        ENDIF
C
        TSQPZ2=TSQE**2-TSQPX**2-TSQPY**2
        IF(TSQPZ2.GE.0.)THEN
          TSQPZ=-SQRT(TSQPZ2)
        ELSE
          TSQPX=0.
          TSQPY=0.
          TSQPZ=TSQE
        ENDIF
C
        TDQPZ2=TSDQE**2-TSDQPX**2-TSDQPY**2
        IF(TDQPZ2.GE.0.)THEN
          TSDQPZ=-SQRT(TDQPZ2)
        ELSE
          TSDQPX=0.
          TSDQPY=0.
          TSDQPZ=TSDQE
        ENDIF
 1779  CONTINUE
C                                                ---------
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PSQPX
        PTXSA1=PSAQPX
        PTXSQ2=TSQPX
        PTXSA2=TSDQPX
        PTYSQ1=PSQPY
        PTYSA1=PSAQPY
        PTYSQ2=TSQPY
        PTYSA2=TSDQPY
        PLQ1=PSQPZ
        PLAQ1=PSAQPZ
        PLQ2=TSQPZ
        PLAQ2=TSDQPZ
        EQ1=PSQE
        EAQ1=PSAQE
        EQ2=TSQE
        EAQ2=TSDQE
C                                       ---------------
C
        IKVALA=0 
         IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDS - IRDS13=',IRDS13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DS:  ...',  PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
        IKVALA=0
        NSELPT=1
        CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     * PTTQ2,PTTA2,
     * NSELPT) 
         IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDS - IRDS13=',IRDS13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DS:  ...',  PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF

        IF (IPEV.GE.7) WRITE(6,'(A/5X,I10)')
     +  'DS   IREJ ', IREJ
        IF (IREJ.EQ.1) THEN
          IRDS13=IRDS13 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDS - IRDS13=',IRDS13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DS:  ...',  PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
                                                                GO TO 11
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSQ2
        PTYCH1=PTYSQ1 + PTYSQ2
        PTZCH1=PLQ1 + PLQ2
        ECH1=EQ1 + EQ2
        PTXCH2=PTXSA2 + PTXSA1
        PTYCH2=PTYSA2 + PTYSA1
        PTZCH2=PLAQ2 + PLAQ1
        ECH2=EAQ2 + EAQ1
C
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' DS: IREJ ',IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ SEA-diquark - TAR QUARK)
C
        CALL COBCMA(IPSQ(IXSPR),IPSQ2(IXSPR),ITSQ(IXSTA), IJNCH1,NNCH1,
     +  IREJ,AMCH1,AMCH1N,1)
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJ.EQ.1) THEN
          IRDS11=IRDS11 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDS - IRDS11=',IRDS11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' DS:', IPSQ(IXSPR),ITTV1
     +      (IXSTA),ITTV2(IXSTA),IJNCH1,NNCH1,IREJ, XPSQ(IXSPR),XPSAQ
     +      (IXSPR),XPSQCM,XPSACM, XTVQ(IXSTA),XTVD(IXSTA),AMCH1,AMCH1N
          ENDIF
                                                                 GOTO 11
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)THEN
           CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N,
     +         PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +         PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +         PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +         PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +         PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,ECH2,
     +         IREJ)
        AMCH2=AMCH2N
        ENDIF
        IF(IREJ.EQ.1)GO TO 11
C
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' DS(2): IREJ ',IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
C
C  REPLACE SMALL MASS CHAINS BY octet or decuplet baryons
C       SECOND FOR CHAIN 2 (proj sadiquark - tar saquark)
C
        CALL COBCMA(IPSAQ(IXSPR),IPSAQ2(IXSPR),ITSAQ(IXSTA),
     +              IJNCH2,NNCH2,IREJ,AMCH2,AMCH2N,2)
c  rejection of both s-s chains if mass of chain 2 too low
        IF(IREJ.EQ.1) THEN
          IRDS12=IRDS12 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,1090) IRDS12
            WRITE(6,1100) IPSAQ(IXSPR),IPSAQ2(IXSPR),ITSAQ(IXSTA),
     +                    IJNCH2,NNCH2,IREJ,
     +      XPSQ(IXSPR),XPSAQ(IXSPR),XPSQCM,XPSACM, XTSQ(IXSTA),XTSAQ
     +      (IXSTA),XTSQCM,XTSACM, AMCH2,AMCH2N
 1090       FORMAT(' KKEVDS - IRDS12=',I5)
 1100       FORMAT(' DS - 1100', 6I5/2(4E12.4/),2E12.4)
          ENDIF
                                                                 GOTO 11
        ENDIF
C                                if AMCH2 changed in COBCMA/COMCMA
C                                CORVAL corrects chain kinematics
C                                according to 2-body kinem.
C                                with fixed masses
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        EEE=ECH1+ECH2
        PXXX=PTXCH1+PTXCH2
        PYYY=PTYCH1+PTYCH2
        PZZZ=PTZCH1+PTZCH2
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4) 
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ, 
     +  PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  PPPCH1, QTXCH1,QTYCH1,QTZCH1,QECH1)
C
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH2,PTYCH2,PTZCH2,ECH2,
     +  PPPCH2, QTXCH2,QTYCH2,QTZCH2,QECH2)
C
          NORIG=51
          CALL CORVAL(AMMM,IREJ,AMCH1,AMCH2, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +    QTXCH2,QTYCH2,QTZCH2,QECH2,NORIG)
C
C                                   4-MOMENTA OF CHAINS

        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +  PPPCH1, PTXCH1,PTYCH1,PTZCH1,ECH1)
C
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH2,QTYCH2,QTZCH2,QECH2,
     +  PPPCH2, PTXCH2,PTYCH2,PTZCH2,ECH2)
C

C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' DS - CALL CORVAL: AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ
            WRITE(6,1050) IREJ, AMCH1,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 1050 FORMAT (' DS: IREJ || ',I10/
     +        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
          ENDIF
          IF(IREJ.EQ.1) THEN
*                           AMCH1N + AMCH2N > AMMM - 0.2
*                           reject event
            IRDS14=IRDS14+1
                                                                 GOTO 11
          ENDIF
        ENDIF
C
       QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQDSA1(N,1)=PTXSQ1
       PQDSA1(N,2)=PTYSQ1
       PQDSA1(N,3)=PLQ1
       PQDSA1(N,4)=EQ1
       PQDSA2(N,1)=PTXSQ2
       PQDSA2(N,2)=PTYSQ2
       PQDSA2(N,3)=PLQ2
       PQDSA2(N,4)=EQ2
       PQDSB1(N,1)=PTXSA2
       PQDSB1(N,2)=PTYSA2
       PQDSB1(N,3)=PLAQ2
       PQDSB1(N,4)=EAQ2
       PQDSB2(N,1)=PTXSA1
       PQDSB2(N,2)=PTYSA1
       PQDSB2(N,3)=PLAQ1
       PQDSB2(N,4)=EAQ1
C-------------------
C
C                                      PUT D-S CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
****  keep for the moment the old s-v notations
C                                 FLAG FOR DS-CHAIN ENDS
C                                            PROJECTILE: ISTHKK=131
C                                            TARGET:     ISTHKK=122
C                                      FOR DS-CHAINS     ISTHKK=4
C
        IHKKPD=JHKKPS(IXSPR )
        IHKKPO=JHKKPS(IXSPR )-1
        IHKKTD=JHKKTS(IXSTA )
        IHKKTO=JHKKTS(IXSTA )-1
        IF (IPEV.GT.3)WRITE(6,1000)IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1010)IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQDSA1(N,1)
        PHKK(2,IHKK)=PQDSA1(N,2)
        PHKK(3,IHKK)=PQDSA1(N,3)
        PHKK(4,IHKK)=PQDSA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=122
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQDSA2(N,1)
        PHKK(2,IHKK)=PQDSA2(N,2)
        PHKK(3,IHKK)=PQDSA2(N,3)
        PHKK(4,IHKK)=PQDSA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=4
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKDS(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C                                   CHAIN 2 projectile sea antidiquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=131
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQDSB1(N,1)
        PHKK(2,IHKK)=PQDSB1(N,2)
        PHKK(3,IHKK)=PQDSB1(N,3)
        PHKK(4,IHKK)=PQDSB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=122
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQDSB2(N,1)
        PHKK(2,IHKK)=PQDSB2(N,2)
        PHKK(3,IHKK)=PQDSB2(N,3)
        PHKK(4,IHKK)=PQDSB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=4
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKDS(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
*     sea diquark pair!
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCDS1(N)=AMCH1
        AMCDS2(N)=AMCH2
        GACDS1(N)=QECH1/AMCH1
        BGXDS1(N)=QTXCH1/AMCH1
        BGYDS1(N)=QTYCH1/AMCH1
        BGZDS1(N)=QTZCH1/AMCH1
        GACDS2(N)=QECH2/AMCH2
        BGXDS2(N)=QTXCH2/AMCH2
        BGYDS2(N)=QTYCH2/AMCH2
        BGZDS2(N)=QTZCH2/AMCH2
        NCHDS1(N)=NNCH1
        NCHDS2(N)=NNCH2
        IJCDS1(N)=IJNCH1
        IJCDS2(N)=IJNCH2
        IF (IPEV.GE.6) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/                8F15.5)') ' DS / FINAL PRINT',N
C    +, XPSQ
C    +  (IXSPR),XPSAQ(IXSPR),XTSQ(IXSTA),XTSAQ(IXSTA), IPSQ(IXSPR),IPSAQ
C    +  (IXSPR), ITSQ(IXSTA),ITTV1(IXSTA),ITTV2(IXSTA), AMCDS1(N),AMCDS2
C    +  (N),GACDS1(N),GACDS2(N), BGXDS1(N),BGYDS1(N),BGZDS1(N), BGXDS2
C    +  (N),BGYDS2(N),BGZDS2(N), NCHDS1(N),NCHDS2(N),IJCDS1(N),IJCDS2
C    +  (N), (PQDSA1(N,JU),PQDSA2(N,JU),PQDSB1(N,JU), PQDSB2(N,JU),JU=1,
C    +  4)
                                                                GO TO 20
C***                     TREATMENT OF REJECTED SEA-SEA INTERACTIONS
   11   CONTINUE
        NCHDS1(N)=99
        NCHDS2(N)=99
        XPVD(JNUCPR)=XPVD(JNUCPR) + XPSQ(IXSPR) + XPSAQ(IXSPR)
        XTVD(JNUCTA)=XTVD(JNUCTA) + XTSAQ(IXSTA) + XTSQ(IXSTA)
      ISSQQ=ABS(IPSAQ(IXSPR))
      JSSQQ=ABS(IPSAQ2(IXSPR))
      IF(ISSQQ.EQ.3.AND.JSSQQ.EQ.3)THEN
        IDSRE(3)=IDSRE(3)+1
      ELSEIF(ISSQQ.EQ.3.OR.JSSQQ.EQ.3)THEN
        IDSRE(2)=IDSRE(2)+1
      ELSE
        IDSRE(1)=IDSRE(1)+1
      ENDIF
   20   CONTINUE
   10 CONTINUE
      RETURN
      END
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C     DEBUG SUBCHK
C     END DEBUG
      SUBROUTINE HADRDS
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       hadronize sea diquark - valence CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRDS.
      COMMON /ABRDS/ AMCDS1(248),AMCDS2(248),GACDS1(248),GACDS2(248),
     +BGXDS1(248),BGYDS1(248),BGZDS1(248), BGXDS2(248),BGYDS2(248),
     +BGZDS2(248), NCHDS1(248),NCHDS2(248),IJCDS1(248),IJCDS2(248),
     +PQDSA1(248,4),PQDSA2(248,4), PQDSB1(248,4),PQDSB2(248,4)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALDS /0/
C-----------------------------------------------------------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' hadrds'
      NCALDS=NCALDS+1
      DO 50 I=1,NDS
C-----------------------drop recombined chain pairs
        IF(NCHDS1(I).EQ.99.AND.NCHDS2(I).EQ.99) GO TO 50
        IS1=INTDS1(I)
        IS2=INTDS2(I)
C
        IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITSQ(IS2),
     +  ITSAQ(IS2),ITTV2(IS2), AMCDS1(I),AMCDS2(I),GACDS1(I),GACDS2(I),
     +  BGXDS1(I),BGYDS1(I),BGZDS1(I), BGXDS2(I),BGYDS2(I),BGZDS2(I),
     +  NCHDS1(I),NCHDS2(I),IJCDS1(I),IJCDS2(I), PQDSA1(I,4),PQDSA2
     +  (I,4),PQDSB1(I,4),PQDSB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  diquark-quark   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=IPSQ2(IS1)
        IFB3=ITSQ(IS2)
        DO 10 J=1,4
          POJ(J)=PQDSA1(I,J)
          PAT(J)=PQDSA2(I,J)
   10   CONTINUE
        IF((NCHDS1(I).NE.0.OR.NCHDS2(I).NE.0).AND.IP.NE.1)
     &  CALL SAPTRE(AMCDS1(I),GACDS1(I),BGXDS1(I),BGYDS1(I),BGZDS1(I),
     &              AMCDS2(I),GACDS2(I),BGXDS2(I),BGYDS2(I),BGZDS2(I))
C----------------------------------------------------------------
C----------------------------------------------------------------
        IF(IPCO.GE.3)WRITE (6,1244) POJ,PAT
 1244   FORMAT ('  D-S QUARK-DIQUARK POJ,PAT ',8E12.3)
*       IF(AMCDS1(I).LT.1.6)THEN
*         IF(NCHDS1(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRDS AMCDS1(I),NCHDS1(I),I ',
*    +                AMCDS1(I),NCHDS1(I),IJCDS1(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Projectile Nr ipp = IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
C      IPPP = IFROVP(INTVS1(I))
C      WRITE(6,*)' INTVS1(I) INTDS1(I)',INTVS1(I),INTDS1(I)
C      IF(INTDS1(I).GE.1.AND.INTDS1(I).LE.INTMD)THEN
C      IPPP = IFROVP(INTDS1(I))
C      ELSE
C      WRITE(6,*)' HADRDS: INTDS1(I) ',INTDS1(I)
       IPPP=0
C      ENDIF
C      WRITE(6,*)' IPPP ',IPPP
C      IF(IPPP.GT.0)THEN 
C        JIPP=JSSHS(IPPP)
C      ELSEIF(IPPP.EQ.0)THEN
	 JIPP=1
C      ENDIF
C      WRITE(6,*)' JIPP ',JIPP
C       IF(NCHVS2(I).EQ.0)THEN
       IF(IPCO.GE.3)WRITE(6,'(A,3I5)')'HADRDS: I,IPPP,JIPP ',
     *                     I,IPPP,JIPP
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB1.LE.2.AND.IFB2.LE.2)THEN
	   NDSUU=NDSUU+1
	 ELSEIF((IFB1.EQ.3.AND.IFB2.LE.2).OR.
     *  	 (IFB2.EQ.3.AND.IFB1.LE.2))THEN
	   NDSUS=NDSUS+1
	 ELSEIF(IFB1.EQ.3.AND.IFB2.EQ.3)THEN
	   NDSSS=NDSSS+1
	 ENDIF  
       IF((NCHDS1(I).NE.0))
     *  CALL HADJET(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),
     *  BGXDS1(I), BGYDS1
     +  (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),
     *  IJCDS1(I),6,NCHDS1
     +  (I),15)
C---------------------------------------------------------------
        AACK=FLOAT(ICK6)/FLOAT(ICK6+IHAD6+1)
        IF((NCHDS1(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JIPP,',
     *    'RSEACK,PDBSE 3 dpmnuc5',
     +    JIPP,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCDS1(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJSE(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),BGXDS1(I),
     *        BGYDS1
     +        (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),IJCDS1(I),6,
     *        NCHDS1
     +        (I),6,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *        'RSEACK,IREJSS 3 dpmnuc5 ',
     +        JIPP,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSE=IREJSE+1
              IF(IREJSS.EQ.3)IREJS3=IREJS3+1
              IF(IREJSS.EQ.2)IREJS0=IREJS0+1
              CALL HADJET(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),
     *        BGXDS1(I), BGYDS1
     +        (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),
     *        IJCDS1(I),6,NCHDS1
     +        (I),15)
              IHAD6=IHAD6+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISE63=ISE63+1
              ELSE
                ISE6=ISE6+1
              ENDIF
            ENDIF
          ELSE
            CALL HADJET(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),
     *      BGXDS1(I), BGYDS1
     +      (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),
     *      IJCDS1(I),6,NCHDS1
     +      (I),15)
            IHAD6=IHAD6+1
          ENDIF
        ENDIF

C---------------------------------------------------------------
        ACOUDS=ACOUDS+1
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRDS: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
          IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C 
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRDS / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNDS=ANNDS+1
          EEDS=EEDS+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTDS=PTDS+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
	  IF(IPCO.GE.3)WRITE(6,*)' HADRDS before HKKFIL'
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKDS(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2: adiquark - aquark  +++++++++
        IFB1=IPSAQ(IS1)
        IFB2=IPSAQ2(IS1)
        IFB3=ITSAQ(IS2)
        IFB1=IABS(IFB1)+6
        IFB2=IABS(IFB2)+6
        IFB3=IABS(IFB3)+6
        DO 30 J=1,4
          POJ(J)=PQDSB2(I,J)
          PAT(J)=PQDSB1(I,J)
   30   CONTINUE
*       IF(AMCDS2(I).LT.1.6)THEN
*         IF(NCHDS2(I).EQ.0)THEN
C           WRITE(6,'(A,F10.2,5I5)')' HADRDS AMCDS2(I),NCHDS2(I),I ',
C    +                AMCDS2(I),NCHDS2(I),IJCDS2(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Projectile Nr ipp = IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
C      WRITE(6,*)'HADRDS INTDS2(I) ',INTDS2(I)
C      IPPP = IFROVP(INTVS1(I))
C      IF(INTDS2(I).GE.1)THEN
C      ITTT = IFROVP(INTDS2(I))
C      ELSE
       ITTT=0
C      ENDIF
C      WRITE(6,*)' HADRDS 2 IPPP', IPPP
C      IF(ITTT.GT.0)THEN
C      JITT=JSSHS(ITTT)
C      ELSE
       JITT=0
C      ENDIF
C       IF(NCHVS2(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRDS: I,IPPP,JIPP ',
C    *                     I,IPPP,JIPP
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB1.LE.8.AND.IFB2.LE.8)THEN
	   NADSUU=NADSUU+1
	 ELSEIF((IFB1.EQ.9.AND.IFB2.LE.8).OR.
     *  	 (IFB2.EQ.9.AND.IFB1.LE.8))THEN
	   NADSUS=NADSUS+1
	 ELSEIF(IFB1.EQ.9.AND.IFB2.EQ.9)THEN
	   NADSSS=NADSSS+1
	 ENDIF  
C	 WRITE(6,*)'NCHDS2(I)',NCHDS2(I)
C	WRITE(6,*)' before HADJET:AMCDS2(I),GACDS2(I),BGXDS2(I),',
C    *  AMCDS2(I),GACDS2(I),BGXDS2(I)
        IF((NCHDS2(I).NE.0))
     *  CALL HADJET(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),
     *  BGXDS2(I), BGYDS2
     +  (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),
     *  IJCDS2(I),6,NCHDS2
     +  (I),16)
C      WRITE(6,*)' after HADJET '
C-----------------------------------------------------------------
        AACK=FLOAT(ICK6)/FLOAT(ICK6+IHAD6+1)
        IF((NCHDS2(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JIPP,',
     *    'RSEACK,PDBSE ',
     +    JIPP,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCDS2(I).GT.2.3D0)THEN
              IREJSS=0
C	      WRITE(6,*)' before HADJASE '
              CALL HADJASE(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),BGXDS2(I),
     *        BGYDS2
     +        (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),IJCDS2(I),6,
     *        NCHDS2
     +        (I),6,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *        'RSEACK,IREJSS ',
     +        JIPP,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSA=IREJSA+1
              IF(IREJSS.EQ.3)IREJA3=IREJA3+1
              IF(IREJSS.EQ.2)IREJA0=IREJA0+1
C	      WRITE(6,*)' before HADJET2 '
        CALL HADJET(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),
     *  BGXDS2(I), BGYDS2
     +  (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),
     *  IJCDS2(I),6,NCHDS2
     +  (I),16)
              IHADA6=IHADA6+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISEA63=ISEA63+1
              ELSE
                ISEA6=ISEA6+1
              ENDIF
            ENDIF
          ELSE
C	      WRITE(6,*)' before HADJET3 '
        CALL HADJET(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),
     *  BGXDS2(I), BGYDS2
     +  (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),
     *  IJCDS2(I),6,NCHDS2
     +  (I),16)
            IHADA6=IHADA6+1
          ENDIF
        ENDIF
C--------------------------------------------------------------------
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRDS: NHKK.EQ.NMXHKK ', NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C             WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRDS / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNDS=ANNDS+1
          EEDS=EEDS+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTDS=PTDS+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
	  IF(IPCO.GE.3)WRITE(6,*)' HADRDS before  2 HKKFIL'
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKDS(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE DIQSSD(ECM,ITS,IPS,IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*  define s-d chains (sea - sea diquark chains)
*  sq-sqsq and saq-saqsaq chains instead of q-aq and aq-q chains
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRSD.
      COMMON /ABRSD/ AMCSD1(248),AMCSD2(248),GACSD1(248),GACSD2(248),
     +BGXSD1(248),BGYSD1(248),BGZSD1(248), BGXSD2(248),BGYSD2(248),
     +BGZSD2(248), NCHSD1(248),NCHSD2(248),IJCSD1(248),IJCSD2(248),
     +PQSDA1(248,4),PQSDA2(248,4), PQSDB1(248,4),PQSDB2(248,4)
*KEND.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
       COMMON/SEASU3/SEASQ
      COMMON /XSEADI/ XSEACU,UNON,UNOM,UNOSEA, CVQ,CDQ,CSEA,SSMIMA,
     +SSMIMQ,VVMTHR
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C----------------------------------------------------------------------
C     COMMON /PCHARM/PCCCC
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH7.EQ.0)THEN
        SEASQ=0.5D0
        RX=8.D0
        X1=RX
        GM=2.140D0
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.D0
      X1=RX
      BETCHA=BETOO+1.3D0-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
C     PC=PC1/2.9
C                       changed j.r.14.12.94
C     PC=PC1/5.0
C     PC=PC1/10.0
      PCC1=PC1/7.0D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
      PU1=PU/(2*PU+PS+PC)
      PS1=PS/(2*PU+PS+PC)
      IF(INICH7.EQ.0)THEN
        INICH7=1
        IF(IPHKK.GE.1) WRITE(6,4567)PC,BETCHA,PU1,PS1,SEASQ
 4567   FORMAT(' Charm chain ends DIQSSD: PC,BETCHA,PU,PS,SEASQ',4F10.5)
      ENDIF
C----------------------------------------------------------------------
        RR=RNDM(V)
        IS=1.D0+RNDM(V1)*(2.D0+2.D0*SEASQ)
	IF(RR.LT.PC)IS=4
C----------------------------------------------------------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' diqssd'
      IREJ=0
*  kinematics: is the mass of both chains big enough
*              to allow for fragmentation
      ITSQ2(ITS)=1.D0+RNDM(v1)*(2.D0+2.D0*SEASQ)
        RR=RNDM(V)
	IF(RR.LT.PC)ITSQ2(ITS)=4
C----------------------------------------------------------------------
      ITSAQ2(ITS)=-ITSQ2(ITS)
C---------------------------------------------------j.r.29.4.94
C                                   x**1.5 distr for sea diquarks
C                         number of target nucleon
      INUCTA=IFROST(ITS)
C                          number of target diquark
      IITOT=ITOVT(INUCTA)
C                          diquark x
      XTDIQU=XTVD(IITOT)
C                          minimal value of diquark x
      XDTHR=CDQ/ECM
C
      XDFREE=XTDIQU-XDTHR
      XALL=XDFREE+XTSQ(ITS)+XTSAQ(ITS)-2.*XDTHR
      XDALT=XTVD(IITOT)
      XSALT=XTSQ(ITS)
      XAALT=XTSAQ(ITS)
      IF(XALL.GE.0.)THEN
        RR1=RNDM(V1)
        RR2=RNDM(V2)
        RR3=RNDM(V3)
        SR123=RR1+RR2+RR3
        DX1=RR1*XALL/SR123
        DX2=RR2*XALL/SR123
        DX3=RR3*XALL/SR123
        XTVD(IITOT)=XDTHR+DX1
        XTSQ(ITS)=XDTHR+DX2
        XTSAQ(ITS)=XDTHR+DX3
      ENDIF
C--------------------------------------------------------------
      AMSDQ1=XTSQ(ITS)*XPSQ(IPS)*ECM**2
      AMSDQ2=XTSAQ(ITS)*XPSAQ(IPS)*ECM**2
      IDIQRE(1)=IDIQRE(1)+1
      IF(ITSQ(ITS).GE.3.AND.ITSQ2(ITS).GE.3)THEN
      IDIQRE(2)=IDIQRE(2)+1
C       IF(AMSDQ2.LE.2.30.OR.AMSDQ1.LE.2.30) THEN
        IF(AMSDQ2.LE.6.60D0.OR.AMSDQ1.LE.6.60D0) THEN
          IREJ=1
           IDIQRE(3)=IDIQRE(3)+1
           IDIQRE(2)=IDIQRE(2)-1
           IDIQRE(1)=IDIQRE(1)-1
          XTVD(IITOT)=XDALT
          XTSQ(ITS)=XSALT
          XTSAQ(ITS)=XAALT
          RETURN
        ENDIF
      ELSEIF(ITSQ(ITS).GE.3.OR.ITSQ2(ITS).GE.3)THEN
      IDIQRE(4)=IDIQRE(4)+1
C        IF(AMSDQ2.LE.1.9.OR.AMSDQ1.LE.1.90) THEN
        IF(AMSDQ2.LE.5.8D0.OR.AMSDQ1.LE.5.80D0) THEN
          IREJ=1
           IDIQRE(5)=IDIQRE(5)+1
           IDIQRE(4)=IDIQRE(4)-1
           IDIQRE(1)=IDIQRE(1)-1
          XTVD(IITOT)=XDALT
          XTSQ(ITS)=XSALT
          XTSAQ(ITS)=XAALT
          RETURN
        ENDIF
      ELSE
      IDIQRE(6)=IDIQRE(6)+1
C        IF(AMSDQ2.LE.1.50.OR.AMSDQ1.LE.1.50) THEN
        IF(AMSDQ2.LE.3.9D0.OR.AMSDQ1.LE.3.9D0) THEN
          IREJ=1
           IDIQRE(7)=IDIQRE(7)+1
           IDIQRE(6)=IDIQRE(6)-1
           IDIQRE(1)=IDIQRE(1)-1
          XTVD(IITOT)=XDALT
          XTSQ(ITS)=XSALT
          XTSAQ(ITS)=XAALT
          RETURN
        ENDIF
      ENDIF
      NSD=NSD+1
c     WRITE(6,'(A/5X,3F10.3,3I5/5X,3F10.3)')
c    +' DIQVS: AMSDQ1, XTSQ, XPVQ, IPS,ITS, NSD/ AMSDQ2, XTSAQ, XPVD',
c    +AMSDQ1,XTSQ(ITS),XPVQ(IPS),IPS,ITS,NSD,AMSDQ2,XTSAQ(ITS),XPVD(IPS)
      NCHSD1(NSD)=0
      NCHSD2(NSD)=0
      INTSD1(NSD)=IPS
      INTSD2(NSD)=ITS
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C      DEBUG SUBCHK
C      END DEBUG
      SUBROUTINE KKEVSD(IREJSD)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C------------------ treatment of sea - sea diquark CHAIN SYSTEMS
C
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRSD.
      COMMON /ABRSD/ AMCSD1(248),AMCSD2(248),GACSD1(248),GACSD2(248),
     +BGXSD1(248),BGYSD1(248),BGZSD1(248), BGXSD2(248),BGYSD2(248),
     +BGZSD2(248), NCHSD1(248),NCHSD2(248),IJCSD1(248),IJCSD2(248),
     +PQSDA1(248,4),PQSDA2(248,4), PQSDB1(248,4),PQSDB2(248,4)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
      COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7) 
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,TRAFOP.
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON/RPTSHM/RPROJ,RTARG,BIMPAC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
*KEND.
C-------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' kkevsd'
      IREJSD=0
      DO 10 N=1,NSD
C---------------------------drop recombined chain pairs
        IF(NCHSD1(N).EQ.99.AND.NCHSD2(N).EQ.99)GO TO 10
C
C***            4-MOMENTA OF projectile QUARK-DIQUARK PAIRS IN NN-CMS
        IXSPR=INTSD1(N)
        INUCPR=IFROSP(IXSPR)
        JNUCPR=ITOVP(INUCPR)
C
        PSQPX=XPSQ(IXSPR)*PRMOM(1,INUCPR)
        PSQPY=XPSQ(IXSPR)*PRMOM(2,INUCPR)
        PSQPZ=XPSQ(IXSPR)*PRMOM(3,INUCPR)
        PSQE=XPSQ(IXSPR)*PRMOM(4,INUCPR)
        PSDQPX=XPSAQ(IXSPR)*PRMOM(1,INUCPR)
        PSDQPY=XPSAQ(IXSPR)*PRMOM(2,INUCPR)
        PSDQPZ=XPSAQ(IXSPR)*PRMOM(3,INUCPR)
        PSDQE=XPSAQ(IXSPR)*PRMOM(4,INUCPR)
C
C***                 4-MOMENTA OF TARGET QUARK-DIQUARK PAIRS IN NN-CMS
        IXSTA=INTSD2(N)
        INUCTA=IFROST(IXSTA)
        JNUCTA=ITOVT(INUCTA)
*
        TSQPX=XTSQ(IXSTA)*TAMOM(1,INUCTA)
        TSQPY=XTSQ(IXSTA)*TAMOM(2,INUCTA)
        TSQPZ=XTSQ(IXSTA)*TAMOM(3,INUCTA)
        TSQE=XTSQ(IXSTA)*TAMOM(4,INUCTA)
        TSAQPX=XTSAQ(IXSTA)*TAMOM(1,INUCTA)
        TSAQPY=XTSAQ(IXSTA)*TAMOM(2,INUCTA)
        TSAQPZ=XTSAQ(IXSTA)*TAMOM(3,INUCTA)
        TSAQE=XTSAQ(IXSTA)*TAMOM(4,INUCTA)
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      IF(IT.GT.1)THEN
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(PSQPX,PSQPY,PSQPZ,PSQE,RTIX,RTIY,RTIZ,
     *            PSQNX,PSQNY,PSQNZ,PSQNE,63)
      PSQPX=PSQNX
      PSQPY=PSQNY
      PSQPZ=PSQNZ
      PSQE=PSQNE      
      CALL CROMSC(PSDQPX,PSDQPY,PSDQPZ,PSDQE,RTIX,RTIY,RTIZ,
     *            PSDQNX,PSDQNY,PSDQNZ,PSDQNE,64)
      PSDQPX=PSDQNX
      PSDQPY=PSDQNY
      PSDQPZ=PSDQNZ
      PSDQE=PSDQNE      
C                                                ---------

C                                               j.r.6.5.93
C
C                     multiple scattering of sea quark chain ends
C
      ITNU=IP+INUCTA
      RTIX=(VHKK(1,ITNU))*1.E12-BIMPAC*0.1
      RTIY=VHKK(2,ITNU)*1.E12
      RTIZ=VHKK(3,ITNU)*1.E12
      CALL CROMSC(TSQPX,TSQPY,TSQPZ,TSQE,RTIX,RTIY,RTIZ,
     *            TSQNX,TSQNY,TSQNZ,TSQNE,65)
      TSQPX=TSQNX
      TSQPY=TSQNY
      TSQPZ=TSQNZ
      TSQE=TSQNE      
      CALL CROMSC(TSAQPX,TSAQPY,TSAQPZ,TSAQE,RTIX,RTIY,RTIZ,
     *            TSAQNX,TSAQNY,TSAQNZ,TSAQNE,66)
      TSAQPX=TSAQNX
      TSAQPY=TSAQNY
      TSAQPZ=TSAQNZ
      TSAQE=TSAQNE  
      ENDIF    
C                                                ---------
C                                                j.r.10.5.93
       IF(IP.GE.0)GO TO 1779
        PSQPZ2=PSQE**2-PSQPX**2-PSQPY**2
        IF(PSQPZ2.GE.0.)THEN
          PSQPZ=SQRT(PSQPZ2)
        ELSE
          PSQPX=0.
          PSQPY=0.
          PSQPZ=PSQE
        ENDIF
C
        PDQPZ2=PSDQE**2-PSDQPX**2-PSDQPY**2
        IF(PDQPZ2.GE.0.)THEN
          PSDQPZ=SQRT(PDQPZ2)
        ELSE
          PSDQPX=0.
          PSDQPY=0.
          PSDQPZ=PSDQE
        ENDIF
C
        TSQPZ2=TSQE**2-TSQPX**2-TSQPY**2
        IF(TSQPZ2.GE.0.)THEN
          TSQPZ=-SQRT(TSQPZ2)
        ELSE
          TSQPX=0.
          TSQPY=0.
          TSQPZ=TSQE
        ENDIF
C
        TAQPZ2=TSAQE**2-TSAQPX**2-TSAQPY**2
        IF(TAQPZ2.GE.0.)THEN
          TSAQPZ=-SQRT(TAQPZ2)
        ELSE
          TSAQPX=0.
          TSAQPY=0.
          TSAQPZ=TSAQE
        ENDIF
 1779  CONTINUE
C                                                ---------
C                                      changej.r.6.5.93
        PTXSQ1=0.
        PTXSA1=0.
        PTXSQ2=0.
        PTXSA2=0.
        PTYSQ1=0.
        PTYSA1=0.
        PTYSQ2=0.
        PTYSA2=0.
        PTXSQ1=PSQPX
        PTXSA1=PSDQPX
        PTXSQ2=TSQPX
        PTXSA2=TSAQPX
        PTYSQ1=PSQPY
        PTYSA1=PSDQPY
        PTYSQ2=TSQPY
        PTYSA2=TSAQPY
        PLQ1=PSQPZ
        PLAQ1=PSDQPZ
        PLQ2=TSQPZ
        PLAQ2=TSAQPZ
        EQ1=PSQE
        EAQ1=PSDQE
        EQ2=TSQE
        EAQ2=TSAQE
C                                       ---------------
C
C                                               _________________
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVSD - IRSD13=',IRSD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:  ...',  PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
        IKVALA=0
        NSELPT=1
        CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1,
     * PTTQ2,PTTA2,
     * NSELPT)
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVSD - IRSD13=',IRSD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:  ...',  PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
          ENDIF
        IF (IPEV.GE.7) WRITE(6,'(A/5X,I10)')
     +  'SD   IREJ ', IREJ
        IF (IREJ.EQ.1) THEN
          IRSD13=IRSD13 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVSD - IRSD13=',IRSD13
            WRITE(6,'(A/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:  ...',  PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJ,IKVALA,PTTQ1,PTTA1
 
          ENDIF
                                                                GO TO 11
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSQ2
        PTYCH1=PTYSQ1 + PTYSQ2
        PTZCH1=PLQ1 + PLQ2
        ECH1=EQ1 + EQ2
        PTXCH2=PTXSA2 + PTXSA1
        PTYCH2=PTYSA2 + PTYSA1
        PTZCH2=PLAQ2 + PLAQ1
        ECH2=EAQ2 + EAQ1
C
C
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' SD: IREJ ',IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
 
C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ quark - tar sea-diquark)
C
        CALL COBCMA(ITSQ(IXSTA),ITSQ2(IXSTA),IPSQ(IXSPR), IJNCH1,NNCH1,
     +  IREJ,AMCH1,AMCH1N,1)
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJ.EQ.1) THEN
          IRSD11=IRSD11 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVSD - IRSD11=',IRSD11
            WRITE(6,'(A,6I5/6E12.4/2E12.4)') ' SD:', IPVQ(IXSPR),ITSQ
     +      (IXSTA),ITSQ2(IXSTA),IJNCH1,NNCH1,IREJ, XPVQ(IXSPR),XPVD
     +      (IXSPR),XPSQCM,XPSDCM, XTSQ(IXSTA),XTSAQ(IXSTA),AMCH1,AMCH1N
          ENDIF
                                                                 GOTO 11
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)THEN
           CALL CORMOM(AMCH1,AMCH2,AMCH1N,AMCH2N,
     +         PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +         PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +         PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +         PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +         PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,ECH2,
     +         IREJ)
        AMCH2=AMCH2N
        ENDIF
        IF (IREJ.EQ.1)GO TO 11
C
        IF (IPEV.GE.6) WRITE(6,'(A,I10/A,5F12.5/A,5F12.5)')
     +  ' SD(2): IREJ ',IREJ, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
C
C  REPLACE SMALL MASS CHAINS BY octet or decuplet baryons
C       SECOND FOR CHAIN 2 (proj saquark - tar sadiquark)
C
        CALL COBCMA(IPSAQ(IXSPR),ITSAQ(IXSTA),ITSAQ2(IXSTA),
     +              IJNCH2,NNCH2,IREJ,AMCH2,AMCH2N,2)
c  rejection of both s-s chains if mass of chain 2 too low
        IF(IREJ.EQ.1) THEN
          IRSD12=IRSD12 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,1090) IRSD12
            WRITE(6,1100) IPSAQ(IXSPR),ITSAQ(IXSTA),ITSAQ2(IXSTA),
     +                    IJNCH2,NNCH2,IREJ,
     +      XPSQ(IXSPR),XPSAQ(IXSPR),XPSQCM,XTSACM, XTSQ(IXSTA),XTSAQ
     +      (IXSTA),XTSQCM,XTSACM, AMCH2,AMCH2N
 1090       FORMAT(' KKEVSD - IRSD12=',I5)
 1100       FORMAT(' SD - 1100', 6I5/2(4E12.4/),2E12.4)
          ENDIF
                                                                 GOTO 11
        ENDIF
C                                if AMCH2 changed in COBCMA/COMCMA
C                                CORVAL corrects chain kinematics
C                                according to 2-body kinem.
C                                with fixed masses
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
      AMMM=SQRT(MAX(0D0,((ECH1+ECH2)+(PTZCH1+PTZCH2))*((ECH1+ECH2)
     * -(PTZCH1+PTZCH2))-(PTYCH1+PTYCH2)**2-(PTXCH1+PTXCH2)**2))
        EEE=ECH1+ECH2
        PXXX=PTXCH1+PTXCH2
        PYYY=PTYCH1+PTYCH2
        PZZZ=PTZCH1+PTZCH2
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4) 
C-------------------
C                                   4-MOMENTA OF CHAINS
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ, 
     +  PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  PPPCH1, QTXCH1,QTYCH1,QTZCH1,QECH1)
C
        CALL DALTRA(GAMMM,-BGGGX,-BGGGY,-BGGGZ,
     +  PTXCH2,PTYCH2,PTZCH2,ECH2,
     +  PPPCH2, QTXCH2,QTYCH2,QTZCH2,QECH2)
C
          NORIG=52
          CALL CORVAL(AMMM,IREJ,AMCH1,AMCH2, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +    QTXCH2,QTYCH2,QTZCH2,QECH2,NORIG)
C                        TRANSFORM BOTH CHAINS  INTO TWO CHAIN-CMS
C
C                                   4-MOMENTA OF CHAINS

        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH1,QTYCH1,QTZCH1,QECH1,
     +  PPPCH1, PTXCH1,PTYCH1,PTZCH1,ECH1)
C
        CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, QTXCH2,QTYCH2,QTZCH2,QECH2,
     +  PPPCH2, PTXCH2,PTYCH2,PTZCH2,ECH2)
C

C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' SD - CALL CORVAL: AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJ
            WRITE(6,1050) IREJ, AMCH1,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 1050 FORMAT (' SD: IREJ || ',I10/
     +        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
          ENDIF
          IF(IREJ.EQ.1) THEN
*                           AMCH1N + AMCH2N > AMMM - 0.2
*                           reject event
            IRSD14=IRSD14+1
                                                                 GOTO 11
          ENDIF
        ENDIF
C
       QTXCH1=PTXCH1
       QTYCH1=PTYCH1
       QTZCH1=PTZCH1
       QECH1=ECH1
       QTXCH2=PTXCH2
       QTYCH2=PTYCH2
       QTZCH2=PTZCH2
       QECH2=ECH2
       PQSDA1(N,1)=PTXSQ1
       PQSDA1(N,2)=PTYSQ1
       PQSDA1(N,3)=PLQ1
       PQSDA1(N,4)=EQ1
       PQSDA2(N,1)=PTXSA2
       PQSDA2(N,2)=PTYSA2
       PQSDA2(N,3)=PLAQ2
       PQSDA2(N,4)=EAQ2
       PQSDB1(N,1)=PTXSQ2
       PQSDB1(N,2)=PTYSQ2
       PQSDB1(N,3)=PLQ2
       PQSDB1(N,4)=EQ2
       PQSDB2(N,1)=PTXSA1
       PQSDB2(N,2)=PTYSA1
       PQSDB2(N,3)=PLAQ1
       PQSDB2(N,4)=EAQ1
C-------------------
C
C                                      PUT D-S CHAIN ENDS INTO /HKKEVT/
C                                      MOMENTA IN NN-CMS
C                                      POSITION OF ORIGINAL NUCLEONS
C
****  keep for the moment the old v-s notations
C                                 FLAG FOR SD-CHAIN ENDS
C                                            PROJECTILE: ISTHKK=121
C                                            TARGET:     ISTHKK=132
C                                      FOR SD-CHAINS     ISTHKK=5
C
        IHKKPD=JHKKPS(IXSPR )
        IHKKPO=JHKKPS(IXSPR )-1
        IHKKTD=JHKKTS(IXSTA )
        IHKKTO=JHKKTS(IXSTA )-1
        IF (IPEV.GT.3)WRITE(6,1000)IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD
 1000 FORMAT (' IXSPR,INUCPR,JNUCPR,IHKKPO,IHKKPD ',5I5)
        IF (IPEV.GT.3)WRITE(6,1010)IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD
 1010 FORMAT (' IXSTA,INUCTA,JNUCTA,IHKKTO,IHKKTD ',5I5)
C                                     CHAIN 1 PROJECTILE SEA-diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=121
        IDHKK(IHKK)=IDHKK(IHKKPO)
        JMOHKK(1,IHKK)=IHKKPO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPO)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQSDA1(N,1)
        PHKK(2,IHKK)=PQSDA1(N,2)
        PHKK(3,IHKK)=PQSDA1(N,3)
        PHKK(4,IHKK)=PQSDA1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPO)
        VHKK(4,IHKK)=VHKK(4,IHKKPO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
 1020 FORMAT (I6,I4,5I6,9E10.2)
C                                     CHAIN 1 TARGET QUARK
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTD)
        JMOHKK(1,IHKK)=IHKKTD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTD)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQSDA2(N,1)
        PHKK(2,IHKK)=PQSDA2(N,2)
        PHKK(3,IHKK)=PQSDA2(N,3)
        PHKK(4,IHKK)=PQSDA2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTD)
        VHKK(4,IHKK)=VHKK(4,IHKKTD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 1 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=5
        IDHKK(IHKK)=88888+NNCH1
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH1
        PHKK(2,IHKK)=QTYCH1
        PHKK(3,IHKK)=QTZCH1
        PHKK(4,IHKK)=QECH1
        PHKK(5,IHKK)=AMCH1
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKSD(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C                                   CHAIN 2 projectile sea antidiquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=121
        IDHKK(IHKK)=IDHKK(IHKKPD)
        JMOHKK(1,IHKK)=IHKKPD
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKPD)
        JDAHKK(1,IHKK)=IHKK+2
        JDAHKK(2,IHKK)=IHKK+2
        PHKK(1,IHKK)=PQSDB1(N,1)
        PHKK(2,IHKK)=PQSDB1(N,2)
        PHKK(3,IHKK)=PQSDB1(N,3)
        PHKK(4,IHKK)=PQSDB1(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKPD)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKPD)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKPD)
        VHKK(4,IHKK)=VHKK(4,IHKKPD)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C                                     CHAIN 2 TARGET diquark
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=132
        IDHKK(IHKK)=IDHKK(IHKKTO)
        JMOHKK(1,IHKK)=IHKKTO
        JMOHKK(2,IHKK)=JMOHKK(1,IHKKTO)
        JDAHKK(1,IHKK)=IHKK+1
        JDAHKK(2,IHKK)=IHKK+1
        PHKK(1,IHKK)=PQSDB2(N,1)
        PHKK(2,IHKK)=PQSDB2(N,2)
        PHKK(3,IHKK)=PQSDB2(N,3)
        PHKK(4,IHKK)=PQSDB2(N,4)
        PHKK(5,IHKK)=0.
C               Add position of parton in hadron
       CALL QINNUC(XXPP,YYPP)
        VHKK(1,IHKK)=VHKK(1,IHKKTO)+XXPP
        VHKK(2,IHKK)=VHKK(2,IHKKTO)+YYPP
        VHKK(3,IHKK)=VHKK(3,IHKKTO)
        VHKK(4,IHKK)=VHKK(4,IHKKTO)
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C                                     CHAIN 2 BEFORE FRAGMENTATION
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IHKK=NHKK
        ISTHKK(IHKK)=5
        IDHKK(IHKK)=88888+NNCH2
        JMOHKK(1,IHKK)=IHKK-2
        JMOHKK(2,IHKK)=IHKK-1
        PHKK(1,IHKK)=QTXCH2
        PHKK(2,IHKK)=QTYCH2
        PHKK(3,IHKK)=QTZCH2
        PHKK(4,IHKK)=QECH2
        PHKK(5,IHKK)=AMCH2
C                             POSITION OF CREATED CHAIN IN LAB
C                             =POSITION OF TARGET NUCLEON
C                             TIME OF CHAIN CREATION IN LAB
C                             =TIME OF PASSAGE OF PROJECTILE
C                              NUCLEUS AT POSITION OF TAR. NUCLEUS
        VHKK(1,NHKK)= VHKK(1,NHKK-1)
        VHKK(2,NHKK)= VHKK(2,NHKK-1)
        VHKK(3,NHKK)= VHKK(3,NHKK-1)
        VHKK(4,NHKK)=VHKK(3,NHKK)/BETP-VHKK(3,NHKK-2)/BGAMP
        MHKKSD(N)=IHKK
        IF (IPROJK.EQ.1)THEN
          WHKK(1,NHKK)= VHKK(1,NHKK-2)
          WHKK(2,NHKK)= VHKK(2,NHKK-2)
          WHKK(3,NHKK)= VHKK(3,NHKK-2)
          WHKK(4,NHKK)=VHKK(4,NHKK)*GAMP-VHKK(3,NHKK)*BGAMP
          IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +    JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +    (PHKK(KHKK,IHKK),KHKK=1,5), (WHKK(KHKK,IHKK),KHKK=1,4)
 
        ENDIF
        IF (IPHKK.GE.2) WRITE(6,1020) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
*     sea diquark pair!
C  AND PUT IT INTO THE HISTOGRAM
C
        AMCSD1(N)=AMCH1
        AMCSD2(N)=AMCH2
        GACSD1(N)=QECH1/AMCH1
        BGXSD1(N)=QTXCH1/AMCH1
        BGYSD1(N)=QTYCH1/AMCH1
        BGZSD1(N)=QTZCH1/AMCH1
        GACSD2(N)=QECH2/AMCH2
        BGXSD2(N)=QTXCH2/AMCH2
        BGYSD2(N)=QTYCH2/AMCH2
        BGZSD2(N)=QTZCH2/AMCH2
        NCHSD1(N)=NNCH1
        NCHSD2(N)=NNCH2
        IJCSD1(N)=IJNCH1
        IJCSD2(N)=IJNCH2
        IF (IPEV.GE.2) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/8F15.5/2I5)') ' SD / FINAL PRINT',N
C    +, XPSQ
C    + (IXSPR),XPSAQ(IXSPR),XTSQ(IXSTA),XTSAQ(IXSTA), IPSQ(IXSPR),IPPV1
C    +  (IXSPR),IPPV2(IXSPR),ITSQ(IXSTA),ITSAQ(IXSTA), AMCSD1(N),AMCSD2
C    +  (N),GACSD1(N),GACSD2(N), BGXSD1(N),BGYSD1(N),BGZSD1(N), BGXSD2
C    +  (N),BGYSD2(N),BGZSD2(N), NCHSD1(N),NCHSD2(N),IJCSD1(N),IJCSD2
C    +  (N), (PQSDA1(N,JU),PQSDA2(N,JU),PQSDB1(N,JU), PQSDB2(N,JU),JU=1,
C    +  4),
C    +  IXSPR,IXSTA
                                                                GO TO 20
C***                     TREATMENT OF REJECTED SEA-SEA INTERACTIONS
   11   CONTINUE
        NCHSD1(N)=99
        NCHSD2(N)=99
        XPVD(JNUCPR)=XPVD(JNUCPR) + XPSQ(IXSPR) + XPSAQ(IXSPR)
        XTVD(JNUCTA)=XTVD(JNUCTA) + XTSAQ(IXSTA) + XTSQ(IXSTA)
      ISSQQ=ABS(ITSAQ(IXSTA))
      JSSQQ=ABS(ITSAQ2(IXSTA))
      IF(ISSQQ.EQ.3.AND.JSSQQ.EQ.3)THEN
        ISDRE(3)=ISDRE(3)+1
      ELSEIF(ISSQQ.EQ.3.OR.JSSQQ.EQ.3)THEN
        ISDRE(2)=ISDRE(2)+1
      ELSE
        ISDRE(1)=ISDRE(1)+1
      ENDIF
   20   CONTINUE
   10 CONTINUE
      RETURN
      END
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C     DEBUG SUBCHK
C     END DEBUG
      SUBROUTINE HADRSD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       hadronize sea diquark - valence CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,ABRSD.
      COMMON /ABRSD/ AMCSD1(248),AMCSD2(248),GACSD1(248),GACSD2(248),
     +BGXSD1(248),BGYSD1(248),BGZSD1(248), BGXSD2(248),BGYSD2(248),
     +BGZSD2(248), NCHSD1(248),NCHSD2(248),IJCSD1(248),IJCSD2(248),
     +PQSDA1(248,4),PQSDA2(248,4), PQSDB1(248,4),PQSDB2(248,4)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALSD /0/
C-----------------------------------------------------------------------
      IF(IPHKK.GE.6)WRITE (6,'( A)') ' hadrsd'
      NCALSD=NCALSD+1
      DO 50 I=1,NSD
C-----------------------drop recombined chain pairs
        IF(NCHSD1(I).EQ.99.AND.NCHSD2(I).EQ.99) GO TO 50
        IS1=INTSD1(I)
        IS2=INTSD2(I)
C
        IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITVQ(IS2),
     +  ITTV1(IS2),ITTV2(IS2), AMCSD1(I),AMCSD2(I),GACSD1(I),GACSD2(I),
     +  BGXSD1(I),BGYSD1(I),BGZSD1(I), BGXSD2(I),BGYSD2(I),BGZSD2(I),
     +  NCHSD1(I),NCHSD2(I),IJCSD1(I),IJCSD2(I), PQSDA1(I,4),PQSDA2
     +  (I,4),PQSDB1(I,4),PQSDB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  quark-diquark   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=ITSQ(IS2)
        IFB3=ITSQ2(IS2)
        DO 10 J=1,4
          POJ(J)=PQSDA1(I,J)
          PAT(J)=PQSDA2(I,J)
   10   CONTINUE
        IF((NCHSD1(I).NE.0.OR.NCHSD2(I).NE.0).AND.IP.NE.1)
     &  CALL SAPTRE(AMCSD1(I),GACSD1(I),BGXSD1(I),BGYSD1(I),BGZSD1(I),
     &              AMCSD2(I),GACSD2(I),BGXSD2(I),BGYSD2(I),BGZSD2(I))
C----------------------------------------------------------------
C----------------------------------------------------------------
C       WRITE (6,1244) POJ,PAT
C1244   FORMAT ('  V-D QUARK-DIQUARK POJ,PAT ',8E12.3)
*       IF(AMCSD1(I).LT.1.6)THEN
*         IF(NCHSD1(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRSD AMCDS1(I),NCHSD1(I),I ',
*    +                AMCSD1(I),NCHSD1(I),IJCSD1(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
C      ITTT = IFROVT(INTSV2(I))
C      IF(INTSD2(I).GE.1)THEN
C      ITTT = IFROVT(INTSD2(I))
C      ELSE
       ITTT=0
C      ENDIF
C      IF(ITTT.GE.1)THEN
C      JITT=JTSHS(ITTT)
C      ELSE
       JITT=0
C      ENDIF
C       IF(NCHSV1(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRSV: I,ITTT,JITT ',
C    *                     I,ITTT,JITT
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB2.LE.2.AND.IFB3.LE.2)THEN
	   NSDUU=NSDUU+1
	 ELSEIF((IFB2.EQ.3.AND.IFB3.LE.2).OR.
     *  	 (IFB3.EQ.3.AND.IFB2.LE.2))THEN
	   NSDUS=NSDUS+1
	 ELSEIF(IFB2.EQ.3.AND.IFB3.EQ.3)THEN
	   NSDSS=NSDSS+1
	 ENDIF  
        IF((NCHSD1(I).NE.0))
     *  CALL HADJET(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),
     *  BGXSD1(I), BGYSD1
     +  (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),
     *  IJCSD1(I),4,NCHSD1
     +  (I),17)
C---------------------------------------------------------------
        AACK=FLOAT(ICK4)/FLOAT(ICK4+IHAD4+1)
        IF((NCHSD1(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JITT,',
     *    'RSEACK,PDBSE 4 dpmnuc5 ',
     +    JITT,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCSD1(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJSE(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),BGXSD1(I),
     *        BGYSD1
     +        (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),IJCSD1(I),4,
     *        NCHSD1
     +        (I),3,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *        'RSEACK,IREJSS 4 dpmnuc5 NHAD',
     +        JITT,RSEACK,IREJSS,NHAD
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSE=IREJSE+1
              IF(IREJSS.EQ.3)IREJS3=IREJS3+1
              IF(IREJSS.EQ.2)IREJS0=IREJS0+1
              CALL HADJET(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),
     *        BGXSD1(I), BGYSD1
     +        (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),
     *        IJCSD1(I),4,NCHSD1
     +        (I),17)
              IHAD4=IHAD4+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISE43=ISE43+1
              ELSE
                ISE4=ISE4+1
              ENDIF
            ENDIF
          ELSE
            CALL HADJET(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),
     *      BGXSD1(I), BGYSD1
     +      (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),
     *      IJCSD1(I),4,NCHSD1
     +      (I),17)
            IHAD4=IHAD4+1
          ENDIF
        ENDIF
C---------------------------------------------------------------
        ACOUSD=ACOUSD+1
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRSD: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
          IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRSD / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNSD=ANNSD+1
          EESD=EESD+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTSD=PTSD+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
	  IF(IPCO.GE.3)WRITE(6,*)' HADRSD before HKKFIL J,NHAD',J,NHAD
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKSD(I)-3,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C	WRITE(6,*)' after 20 CONTINUE'
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2: aquark - adiquark  +++++++++
        IFB1=IPSAQ(IS1)
        IFB2=ITSAQ(IS2)
        IFB3=ITSAQ2(IS2)
        IFB1=IABS(IFB1)+6
        IFB2=IABS(IFB2)+6
        IFB3=IABS(IFB3)+6
        DO 30 J=1,4
          POJ(J)=PQSDB2(I,J)
          PAT(J)=PQSDB1(I,J)
   30   CONTINUE
C
*       IF(AMCSD2(I).LT.1.6)THEN
*         IF(NCHSD2(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRSD AMCSD2(I),NCHSD2(I),I ',
*    +                AMCSD2(I),NCHSD2(I),IJCSD2(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
C      ITTT = IFROVT(INTSV2(I))
C      WRITE(6,*)' INTSD2(I),I',INTSD2(I),I
C      IF(INTSD2(I).GE.1)THEN
C      ITTT = IFROVT(INTSD2(I))
C      ELSE
       ITTT=0
C      ENDIF
C      WRITE(6,*)' ITTT',ITTT
C      IF(ITTT.GE.1)THEN
C        JITT=JTSHS(ITTT)
C      ELSEIF(ITTT.EQ.0)THEN
	 JITT=0
C      ENDIF
C      WRITE(6,*)' JITT',JITT
C       IF(NCHSV1(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRSD: I,ITTT,JITT ',
C    *                     I,ITTT,JITT
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB2.LE.8.AND.IFB3.LE.8)THEN
	   NASDUU=NASDUU+1
	 ELSEIF((IFB2.EQ.9.AND.IFB3.LE.8).OR.
     *  	 (IFB3.EQ.9.AND.IFB2.LE.8))THEN
	   NASDUS=NASDUS+1
	 ELSEIF(IFB2.EQ.9.AND.IFB3.EQ.9)THEN
	   NASDSS=NASDSS+1
	 ENDIF  
        IF((NCHSD2(I).NE.0))
     *  CALL HADJET(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),
     *  BGXSD2(I), BGYSD2
     +  (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),
     *  IJCSD2(I),4,NCHSD2
     +  (I),18)
C----------------------------------------------------------------
        AACK=FLOAT(ICK4)/FLOAT(ICK4+IHAD4+1)
        IF((NCHSD2(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
        RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJASE JITT,',
     *    'RSEACK,PDBSE ',
     +    JITT,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCSD2(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJASE(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),BGXSD2(I),
     *        BGYSD2
     +        (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),IJCSD2(I),4,
     *        NCHSD2
     +        (I),3,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *        'RSEACK,IREJSS ',
     +        JITT,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSA=IREJSA+1
              IF(IREJSS.EQ.3)IREJA3=IREJA3+1
              IF(IREJSS.EQ.2)IREJA0=IREJA0+1
        CALL HADJET(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),
     *  BGXSD2(I), BGYSD2
     +  (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),
     *  IJCSD2(I),4,NCHSD2
     +  (I),18)
              IHADA4=IHADA4+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISEA43=ISEA43+1
              ELSE
                ISEA4=ISEA4+1
              ENDIF
            ENDIF
          ELSE
        CALL HADJET(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),
     *  BGXSD2(I), BGYSD2
     +  (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),
     *  IJCSD2(I),4,NCHSD2
     +  (I),18)
            IHADA4=IHADA4+1
          ENDIF
        ENDIF
C----------------------------------------------------------------
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRSD: NHKK.EQ.NMXHKK ', NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C             WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRSD / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNSD=ANNSD+1
          EESD=EESD+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTSD=PTSD+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),MHKKSD(I),0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C----------------------------------------------------------------
C       formerly dpmdiqqq.f
C----------------------------------------------------------------
      SUBROUTINE DIQDZZ(ECM,XPSQ1,XPSAQ1,XPSQ2,XPSAQ2,
     *                  IPSQ1,IPSAQ1,IPSQ2,IPSAQ2,IREJDS)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*  define d-s chains (sea diquark - sea chains)
*  sqsq-sq and saqsaq-saq chains instead of q-aq and aq-q chains
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      PARAMETER (INTMD=252)
      COMMON /INTNEZ/NDZ,NZD
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C-------------------
*KEEP,ABRDS.
      COMMON /ABRDZ/ AMCDS1(INTMD),AMCDS2(INTMD),
     +GACDS1(INTMD),GACDS2(INTMD),
     +BGXDS1(INTMD),BGYDS1(INTMD),BGZDS1(INTMD), 
     +BGXDS2(INTMD),BGYDS2(INTMD),
     +BGZDS2(INTMD), NCHDS1(INTMD),NCHDS2(INTMD),
     +IJCDS1(INTMD),IJCDS2(INTMD),
     +PQDSA1(INTMD,4),PQDSA2(INTMD,4), 
     +PQDSB1(INTMD,4),PQDSB2(INTMD,4),
     +IPSQ(INTMD),IPSQQ2(INTMD),ITSQ(INTMD),
     +IPSAQ(INTMD),ISAQQ2(INTMD),ITSAQ(INTMD)
     +,IDZSS(INTMD)
C-------------------
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,KPROJ,IBPROJ,IJTARG,IBTARG
*KEND.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AM(210),GA(210),TAU(210),ICH(210),
     +IBAR(210),K1(210),K2(210)
C     COMMON /PCHARM/PCCCC
      COMMON/SEASU3/SEASQ
       COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7)
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH8.EQ.0)THEN
        SEASQ=0.5D0
        RX=8.
        X1=RX
        GM=2.140
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.
      X1=RX
      BETCHA=BETOO+1.3-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
      PCC1=PC1*1.5D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
      PU1=PU/(2*PU+PS+PC)
      PS1=PS/(2*PU+PS+PC)
      IF(INICH8.EQ.0)THEN
        INICH8=1
C       IPHKK=3
        IF(IPHKK.GE.3) WRITE(6,4567)PC,BETCHA,PU1,PS1,SEASQ
 4567   FORMAT(' Charm chain ends DIQDZZ: PC,BETCHA,PU,PS,SEASQ',5F10.5)
      ENDIF
C----------------------------------------------------------------------
      IF(IPHKK.GE.3)WRITE (6,'( A)') ' diqdss'
      IREJDS=0
*  kinematics: is the mass of the adiquark-diquark chain big enough
*              to allow for fragmentation
      IPSQQ1=1.D0+RNDM(V1)*(2.D0+2.D0*SEASQ)
        RR=RNDM(V)
	IF(RR.LT.PC)IPSQQ1=4
C------------------
      ISAQQ1=-IPSQQ1
      AMDSQ1=XPSQ1*XPSQ2*ECM**2
      AMDSQ2=XPSAQ1*XPSAQ2*ECM**2
       IDIQRZ(1)=IDIQRZ(1)+1  
      IF(IPSQ1.EQ.3.AND.IPSQQ1.EQ.3)THEN
       IDIQRZ(2)=IDIQRZ(2)+1  
C       IF(AMDSQ2.LE.2.3.OR.AMDSQ1.LE.2.30) THEN
        IF(AMDSQ2.LE.6.6D0.OR.AMDSQ1.LE.6.60D0) THEN
       IDIQRZ(3)=IDIQRZ(3)+1  
       IDIQRZ(2)=IDIQRZ(2)-1  
       IDIQRZ(1)=IDIQRZ(1)-1  
          IREJDS=1
          RETURN
        ENDIF
      ELSEIF(IPSQ1.EQ.3.OR.IPSQQ1.EQ.3)THEN
       IDIQRZ(4)=IDIQRZ(4)+1  
C       IF(AMDSQ2.LE.1.9.OR.AMDSQ1.LE.1.90) THEN
        IF(AMDSQ2.LE.5.8D0.OR.AMDSQ1.LE.5.80D0) THEN
       IDIQRZ(5)=IDIQRZ(5)+1  
       IDIQRZ(4)=IDIQRZ(4)-1  
       IDIQRZ(1)=IDIQRZ(1)-1  
          IREJDS=1
          RETURN
        ENDIF
      ELSEIF(((IPSQ1.EQ.4).OR.(IPSQQ1.EQ.4)).AND.
     *       ((IPSQ1.EQ.3).OR.(IPSQQ1.EQ.3)))THEN
C       IF(AMDSQ2.LE.1.9.OR.AMDSQ1.LE.1.90) THEN
        IF(AMDSQ2.LE.30.8D0.OR.AMDSQ1.LE.30.80D0) THEN
          IREJDS=1
          RETURN
        ENDIF
      ELSEIF(IPSQ1.EQ.4.OR.IPSQQ1.EQ.4)THEN
C       IF(AMDSQ2.LE.1.9.OR.AMDSQ1.LE.1.90) THEN
        IF(AMDSQ2.LE.25.8.OR.AMDSQ1.LE.25.80) THEN
          IREJDS=1
          RETURN
        ENDIF
      ELSE
       IDIQRZ(6)=IDIQRZ(6)+1  
C        IF(AMDSQ2.LE.1.50.OR.AMDSQ1.LE.1.50) THEN
        IF(AMDSQ2.LE.3.9.OR.AMDSQ1.LE.3.9) THEN
       IDIQRZ(7)=IDIQRZ(7)+1  
       IDIQRZ(6)=IDIQRZ(6)-1  
       IDIQRZ(1)=IDIQRZ(1)-1  
          IREJDS=1
          RETURN
        ENDIF
      ENDIF
      NDZ=NDZ+1
      IF(NDZ.GE.INTMD)THEN
	IREJDS=1
	NDZ=NDZ-1
	RETURN
      ENDIF
C     WRITE(6,*)' DIQDZZ:IDIQRZ(1-7),NDZ ',(IDIQRZ(II),II=1,7),NDZ
      NCHDS1(NDZ)=0
      NCHDS2(NDZ)=0
C     WRITE(6,*)' DIQDZZ:NDZ,NCHDS1(NDZ),NCHDS2(NDZ) ',
C    * NDZ,NCHDS1(NDZ),NCHDS2(NDZ)
      IDZSS(NDZ)=0
C-------------------
C                                        KKEVDZ part
C-------------------
      IF(IPHKK.GE.3)WRITE (6,'( A,I10)') ' kkevdz',NDZ
      N=NDZ
C      DO 10 N=1,NDZ
C
C***                 4-MOMENTA OF PROJECTILE SEA-QUARK PAIRS IN NN-CMS
        IF(IPHKK.GE.7)WRITE(6,'(A,2I10)')' KKEVDZ N,NDZ',N,NDZ
C
        PRMOMZ=SQRT(ECM**2/4.-AM(1)**2)
        PSQPX=0.
        PSQPY=0.
        PSQPZ=XPSQ1*PRMOMZ
        PSQE=XPSQ1*ECM/2.
        PSAQPX=0.
        PSAQPY=0.
        PSAQPZ=XPSAQ1*PRMOMZ
        PSAQE=XPSAQ1*ECM/2.
C
C***                 4-MOMENTA OF TARGET QUARK-AQUARK PAIRS IN NN-CMS
C
        TSQPX=0.
        TSQPY=0.
        TSQPZ=-XPSQ2*PRMOMZ
        TSQE=XPSQ2*ECM/2.
        TSDQPX=0.
        TSDQPY=0.
        TSDQPZ=-XPSAQ2*PRMOMZ
        TSDQE=XPSAQ2*ECM/2.
C
C***           LORENTZ PARAMETER FOR CMS OF BOTH (sqsq-q) and
C              (saqsaq-diq)-SYSTEM
C              FROM PROJECTILE AND TARGET, RESP.
C
        PXXX=PSQPX + PSAQPX + TSQPX + TSDQPX
        PYYY=PSQPY + PSAQPY + TSQPY + TSDQPY
        PZZZ=PSQPZ + PSAQPZ + TSQPZ + TSDQPZ
        EEE =PSQE + PSAQE + TSQE + TSDQE
        PPTOTO=SQRT(PXXX**2+PYYY**2+PZZZ**2)
        AMMM=SQRT(ABS((EEE+PPTOTO)*(EEE-PPTOTO)))
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4)
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
C       XPSQCM=XPSQ1/(XPSQ1+XPSAQ1)
C       XPSACM=1.0 - XPSQCM
C       XTSQCM=XPSQ2/(XPSQ2+XPSAQ2)
C       XTSACM=1.0 - XTSQCM
        XPSQCM=XPSQ1
        XPSACM=XPSAQ1
        XTSQCM=XPSQ2
        XTSACM=XPSAQ2
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
       PTXSQ1=0  
       PTYSQ1=0
       PTXSA1=0
       PTYSA1=0 
       PTXSQ2=0  
       PTYSQ2=0
       PTXSA2=0
       PTYSA2=0 
       PLQ1 = XPSQ1 *ECM/2.
       EQ1  = XPSQ1 *ECM/2. 
       PLAQ1= XPSAQ1*ECM/2.
       EAQ1 = XPSAQ1*ECM/2.
       PLQ2 =-XPSQ2 *ECM/2.
       EQ2  = XPSQ2 *ECM/2. 
       PLAQ2=-XPSAQ2*ECM/2.
       EAQ2 = XPSAQ2*ECM/2.
        IKVALA=0
        NSELPT=1
	IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVDZ call selpt'
        CALL SELPT(
     +             PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +             PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJDS,IKVALA,PTTQ1,PTTA1,
     +             PTTQ2,PTTA2,NSELPT)
C
        IF (IPEV.GE.7) WRITE(6,'(A/5X,5F12.5,I10)')
     +  'DS   AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJ ', AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJ
        IF (IREJDS.EQ.1) THEN
C         NDZ=NDZ-1
          IRDS13=IRDS13 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVDZ - IRDS13=',IRDS13
            WRITE(6,'(A/5E12.4/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' DS:  XPSQCM,XPSACM,XTSQCM,XTSACM,AMMM ...', XPSQCM,XPSACM,
     +      XTSQCM,XTSACM,AMMM, PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJDS,IKVALA,PTTQ1,PTTA1
          ENDIF
                                                                GO TO 11
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSQ2
        PTYCH1=PTYSQ1 + PTYSQ2
        PTZCH1=PLQ1 + PLQ2
        ECH1=EQ1 + EQ2
        PTXCH2=PTXSA2 + PTXSA1
        PTYCH2=PTYSA2 + PTYSA1
        PTZCH2=PLAQ2 + PLAQ1
        ECH2=EAQ2 + EAQ1
C       WRITE(6,667)ECH1,ECH2,PTZCH1,PTZCH2
C 667 FORMAT(' DS ECH1,ECH2,PTZCH1,PTZCH2: ',4F10.3)
C
        IF (IPEV.GE.6) WRITE(6,'(A,5F12.5,I10/A,5F12.5/A,5F12.5)')
     +  ' DS: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJDS ', AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJDS, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2

C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ SEA-diquark - TAR QUARK)
C
        CALL ZOBCMA(IPSQ1,IPSQQ1,IPSQ2, IJNCH1,NNCH1,
     +  IREJDS,AMCH1,AMCH1N,1)
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJDS.EQ.1) THEN
C         NDZ=NDZ-1
          IRDS11=IRDS11 + 1
                                                                 GOTO 11
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)
     +     CALL ZORMOM(AMMM,AMCH1,AMCH1N,AMCH2,
     +         XPSQ1,XPSAQ1,XPSAQ2,XPSQ2,
     +         PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +         PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +         PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +         PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +         PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,ECH2,
     +                                                      IREJDS)
       IF(IREJDS.EQ.1)THEN
          GO TO 11
       ENDIF
C
        IF (IPEV.GE.6) WRITE(6,'(A,5F12.5,I10/A,5F12.5/A,5F12.5)')
     +  ' DS(2): AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJDS',AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJDS, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
C
C  REPLACE SMALL MASS CHAINS BY octet or decuplet baryons
C       SECOND FOR CHAIN 2 (proj sadiquark - tar saquark)
C
        CALL ZOBCMA(IPSAQ1,ISAQQ1,IPSAQ2,
     +              IJNCH2,NNCH2,IREJDS,AMCH2,AMCH2N,2)
c  rejection of both s-s chains if mass of chain 2 too low
        IF(IREJDS.EQ.1) THEN
          IRDS12=IRDS12 + 1
C         NDZ=NDZ-1
          IF(IPEV.GE.2) THEN
            WRITE(6,1090) IRDS12
 1090       FORMAT(' KKEVDZ - IRDS12=',I5)
 1100       FORMAT(' DS - 1100', 6I5/2(4E12.4/),2E12.4)
          ENDIF
                                                                 GOTO 11
        ENDIF
C                                if AMCH2 changed in COBCMA/COMCMA
C                                ZORVAL corrects chain kinematics
C                                according to 2-body kinem.
C                                with fixed masses
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
	  IORI=2
        CALL ZORVAL(AMMM,IREJDS,AMCH1,AMCH2, PTXCH1,PTYCH1,PTZCH1,ECH1,
     +    PTXCH2,PTYCH2,PTZCH2,ECH2,IORI)
          IF(IREJDS.EQ.1) THEN
*                           AMCH1N + AMCH2N > AMMM - 0.2
*                           reject event
C           NDZ=NDZ-1
            IRDS14=IRDS14+1
                                                                 GOTO 11
          ENDIF
C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' DS - CALL ZORVAL: AMMM,AMCH1,AMCH2,NNCH1,NNCH2,IREJDS',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJDS
            WRITE(6,1050) AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJDS, AMCH1,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 1050 FORMAT (' DS: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJDS ',5F12.5,I10/
     +        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
          ENDIF
          IF(IREJDS.EQ.1) THEN
*                           AMCH1N + AMCH2N > AMMM - 0.2
*                           reject event
C           NDZ=NDZ-1
            IRDS14=IRDS14+1
                                                                 GOTO 11
          ENDIF
        ENDIF
C
C                           TRANSFORM BOTH CHAINS BACK INTO NN CMS
C
C                                   4-MOMENTA OF CHAINS
        QTXCH1=PTXCH1
        QTYCH1=PTYCH1
        QTZCH1=PTZCH1
        QECH1=ECH1
        QTXCH2=PTXCH2
        QTYCH2=PTYCH2
        QTZCH2=PTZCH2
        QECH2=ECH2
C       WRITE(6,887)QECH1,QECH2,QTZCH1,QTZCH2,AMCH1,AMCH2
  887 FORMAT( ' DS: QECH1,QECH2,QTZCH1,QTZCH2,AMCH1,AMCH2  ',6F10.2)

C                                   PARTONS AT ENDS OF CHAIN 1
C       CALL DALTRA(GAMMM,BGGGX,BGGGY,BGGGZ, PTXSQ1,PTYSQ1,PLQ1,EQ1,
C    +  PPPQ1, PQDSA1(N,1),PQDSA1(N,2),PQDSA1(N,3),PQDSA1(N,4) )
        PQDSA1(N,1)=PTXSQ1
        PQDSA1(N,2)=PTYSQ1
        PQDSA1(N,3)=PLQ1
        PQDSA1(N,4)=EQ1
        PQDSA2(N,1)=PTXSQ2
        PQDSA2(N,2)=PTYSQ2
        PQDSA2(N,3)=PLQ2
        PQDSA2(N,4)=EQ2

C                                   PARTONS AT ENDS OF CHAIN 2
        PQDSB2(N,1)=PTXSA2
        PQDSB2(N,2)=PTYSA2
        PQDSB2(N,3)=PLAQ2
        PQDSB2(N,4)=EAQ2

        PQDSB1(N,1)=PTXSA1
        PQDSB1(N,2)=PTYSA1
        PQDSB1(N,3)=PLAQ1
        PQDSB1(N,4)=EAQ1

C
C
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
*     sea diquark pair!
C  AND PUT IT INTO THE HISTOGRAM
C
        IPSQ(N)=IPSQ1
        IPSQQ2(N)=IPSQQ1
        ITSQ(N)=IPSQ2
        IPSAQ(N)=IPSAQ1
        ISAQQ2(N)=ISAQQ1
        ITSAQ(N)=IPSAQ2
        AMCDS1(N)=AMCH1
        AMCDS2(N)=AMCH2
        GACDS1(N)=QECH1/AMCH1
        BGXDS1(N)=QTXCH1/AMCH1
        BGYDS1(N)=QTYCH1/AMCH1
        BGZDS1(N)=QTZCH1/AMCH1
        GACDS2(N)=QECH2/AMCH2
        BGXDS2(N)=QTXCH2/AMCH2
        BGYDS2(N)=QTYCH2/AMCH2
        BGZDS2(N)=QTZCH2/AMCH2
        NCHDS1(N)=NNCH1
        NCHDS2(N)=NNCH2
        IJCDS1(N)=IJNCH1
        IJCDS2(N)=IJNCH2
        IF (IPEV.GE.3) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/                8F15.5)') ' DS / FINAL PRINT',N
                                                                GO TO 20
C***                     TREATMENT OF REJECTED SEA-SEA INTERACTIONS
   11   CONTINUE
        NCHDS1(N)=99
        NCHDS2(N)=99
C                               28.10.96
	NDZ=NDZ-1
	IF(NDZ.LT.0)THEN
	  NDZ=NDZ+1
	ENDIF
      ISSQQ=IPSQ1
      JSSQQ=IPSQQ1
      IF(ISSQQ.EQ.3.AND.JSSQQ.EQ.3)THEN
        IDZRE(3)=IDZRE(3)+1
      ELSEIF(ISSQQ.EQ.3.OR.JSSQQ.EQ.3)THEN
        IDZRE(2)=IDZRE(2)+1
      ELSE
        IDZRE(1)=IDZRE(1)+1
      ENDIF
   20   CONTINUE
   10 CONTINUE
C     WRITE(6,*)' DIQDZZ: IDZRE(1-3),NDZ ',(IDZRE(II),II=1,3),NDZ
C     WRITE(6,*)' DIQDZZ:NDZ,NCHDS1(NDZ),NCHDS2(NDZ) ',
C    * NDZ,NCHDS1(NDZ),NCHDS2(NDZ)
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRDZ
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       hadronize sea diquark - valence CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      PARAMETER (INTMD=252) 
      COMMON /INTNEZ/ NDZ,NZD
C-------------------
*KEEP,ABRDS.
      COMMON /ABRDZ/ AMCDS1(INTMD),AMCDS2(INTMD),
     +GACDS1(INTMD),GACDS2(INTMD),
     +BGXDS1(INTMD),BGYDS1(INTMD),BGZDS1(INTMD), 
     +BGXDS2(INTMD),BGYDS2(INTMD),
     +BGZDS2(INTMD), NCHDS1(INTMD),NCHDS2(INTMD),
     +IJCDS1(INTMD),IJCDS2(INTMD),
     +PQDSA1(INTMD,4),PQDSA2(INTMD,4), 
     +PQDSB1(INTMD,4),PQDSB2(INTMD,4),
     +IPSQ(INTMD),IPSQQ2(INTMD),ITSQ(INTMD),
     +IPSAQ(INTMD),ISAQQ2(INTMD),ITSAQ(INTMD)
     +,IDZSS(INTMD)
*KEEP,INTMX.
      PARAMETER (INTMX=2488)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
C     COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
C    +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
C    +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
C    +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
 
C-------------------
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,HKKEVT.
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
C---------------------
      DIMENSION POJ(4),PAT(4)
      DATA NCALDS /0/
C     IPHKK=3
C-----------------------------------------------------------------------
      IF(IPHKK.GE.3)WRITE (6,'( A,4I10)') ' hadrdz',NDZ,NZD,
     *         NCHDS1(1),NCHDS2(1)
      NCALDS=NCALDS+1
      DO 50 I=1,NDZ
C-----------------------drop recombined chain pairs
        IF(NCHDS1(I).EQ.99.AND.NCHDS2(I).EQ.99) GO TO 50
        IS1=I
        IS2=I
C
        IF (IPCO.GE.6) WRITE (6,*)'IPSQ(IS1),IPSAQ(IS1),ITSQ(IS2)',
     +  'ITSAQ(IS2), AMCDS1(I),AMCDS2(I),GACDS1(I),GACDS2(I)',
     +  'BGXDS1(I),BGYDS1(I),BGZDS1(I), BGXDS2(I),BGYDS2(I),BGZDS2(I)',
     +  'NCHDS1(I),NCHDS2(I),IJCDS1(I),IJCDS2(I), PQDSA1(I,4),PQDSA2',
     +  '(I,4),PQDSB1(I,4),PQDSB2(I,4)',
     *  IPSQ(IS1),IPSAQ(IS1),ITSQ(IS2),
     +  ITSAQ(IS2), AMCDS1(I),AMCDS2(I),GACDS1(I),GACDS2(I),
     +  BGXDS1(I),BGYDS1(I),BGZDS1(I), BGXDS2(I),BGYDS2(I),BGZDS2(I),
     +  NCHDS1(I),NCHDS2(I),IJCDS1(I),IJCDS2(I), PQDSA1(I,4),PQDSA2
     +  (I,4),PQDSB1(I,4),PQDSB2(I,4)
 1000 FORMAT(10X,4I5,10F9.2/10X,4I5,4F12.4)
C
C
C++++++++++++++++++++++++++++++    CHAIN 1:  diquark-quark   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=IPSQQ2(IS1)
        IFB3=ITSQ(IS2)
        DO 10 J=1,4
          POJ(J)=PQDSA1(I,J)
          PAT(J)=PQDSA2(I,J)
   10   CONTINUE
        IF((NCHDS1(I).NE.0.OR.NCHDS2(I).NE.0).AND.IP.NE.1)
     &  CALL SAPTRE(AMCDS1(I),GACDS1(I),BGXDS1(I),BGYDS1(I),BGZDS1(I),
     &              AMCDS2(I),GACDS2(I),BGXDS2(I),BGYDS2(I),BGZDS2(I))
C----------------------------------------------------------------
C----------------------------------------------------------------
        IF (IPCO.GE.6)WRITE (6,1244) POJ,PAT
 1244   FORMAT ('  D-V QUARK-DIQUARK POJ,PAT ',8E12.3)
*       IF(AMCDS1(I).LT.1.6)THEN
*         IF(NCHDS1(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRDZ AMCDS1(I),NCHDS1(I),I ',
*    +                AMCDS1(I),NCHDS1(I),IJCDS1(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Projectile Nr ipp = IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
       IF(IPCO.GE.4)WRITE(6,*)' IPPP,INTVS1(I)',IPPP,INTVS1(I)
       IF(INTVS1(I).GT.0)THEN
         IPPP = IFROVP(INTVS1(I))
         IF(IPCO.GE.4)WRITE(6,*)' IPPP,INTVS1(I)',IPPP,INTVS1(I)
         JIPP=JSSHS(IPPP)
       ELSEIF(INTVS1(I).EQ.0)THEN
         JIPP=0
       ENDIF
       IF(IPCO.GE.4)WRITE(6,*)' JIPP,INTVS1(I)',JIPP,INTVS1(I)
C       IF(NCHVS2(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRVS: I,IPPP,JIPP ',
C    *                     I,IPPP,JIPP
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB1.LE.2.AND.IFB2.LE.2)THEN
	   NDZUU=NDZUU+1
	 ELSEIF((IFB1.EQ.3.AND.IFB2.LE.2).OR.
     *  	 (IFB2.EQ.3.AND.IFB1.LE.2))THEN
	   NDZUS=NDZUS+1
	 ELSEIF(IFB1.EQ.3.AND.IFB2.EQ.3)THEN
	   NDZSS=NDZSS+1
	 ENDIF  
        IF((NCHDS1(I).NE.0))
     *  CALL HADJET(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),BGXDS1(I), BGYDS1
     +  (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),IJCDS1(I),6,NCHDS1
     +  (I),15)
C---------------------------------------------------------------------
        AACK=FLOAT(ICK6)/FLOAT(ICK6+IHAD6+1)
        IF((NCHDS1(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
          RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JIPP,',
     *    'RSEACK,PDBSE 1 dpmdiqqq',
     +    JIPP,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCDS1(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJSE(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),BGXDS1(I),
     *        BGYDS1
     +        (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),IJCDS1(I),6,
     *        NCHDS1
     +        (I),6,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *        'RSEACK,IREJSS 1 dpmdiqqq ',
     +        JIPP,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSE=IREJSE+1
              IF(IREJSS.EQ.3)IREJS3=IREJS3+1
              IF(IREJSS.EQ.2)IREJS0=IREJS0+1
        CALL HADJET(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),BGXDS1(I), BGYDS1
     +  (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),IJCDS1(I),6,NCHDS1
     +  (I),15)
              IHAD6=IHAD6+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISE63=ISE63+1
              ELSE
                ISE6=ISE6+1
              ENDIF
            ENDIF
          ELSE
        CALL HADJET(NHAD,AMCDS1(I),POJ,PAT,GACDS1(I),BGXDS1(I), BGYDS1
     +  (I),BGZDS1(I),IFB1,IFB2,IFB3,IFB4, IJCDS1(I),IJCDS1(I),6,NCHDS1
     +  (I),15)
            IHAD6=IHAD6+1
          ENDIF
        ENDIF
C---------------------------------------------------------------------
        ACOUDZ=ACOUDZ+1
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRDZ: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRDZ / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNDZ=ANNDZ+1
          EEDZ=EEDZ+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTDZ=PTDZ+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),1,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
C         JMOHKK(1,NHKK)=MHKKSS(I)-3
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2: adiquark - aquark  +++++++++
        IFB1=IPSAQ(IS1)
        IFB2=ISAQQ2(IS1)
        IFB3=ITSAQ(IS2)
        IFB1=IABS(IFB1)+6
        IFB2=IABS(IFB2)+6
        IFB3=IABS(IFB3)+6
        DO 30 J=1,4
          POJ(J)=PQDSB2(I,J)
          PAT(J)=PQDSB1(I,J)
   30   CONTINUE
*       IF(AMCDS2(I).LT.1.6)THEN
*         IF(NCHDS2(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRDZ AMCDS2(I),NCHDS2(I),I ',
*    +                AMCDS2(I),NCHDS2(I),IJCDS2(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Projectile Nr ipp = IFROVP(INTVS1(I))
C          No of Glauber sea q at Projectile JIPP=JSSHS(IPP)
       IF(INTVS1(I).GT.0)THEN
         IPPP = IFROVP(INTVS1(I))
         JITT=JSSHS(IPPP)
       ELSEIF(INTVS1(I).EQ.0)THEN
         JITT=0
       ENDIF
C       IF(NCHVS2(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRVS: I,IPPP,JIPP ',
C    *                     I,IPPP,JIPP
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB1.LE.8.AND.IFB2.LE.8)THEN
	   NADZUU=NADZUU+1
	 ELSEIF((IFB1.EQ.9.AND.IFB2.LE.8).OR.
     *  	 (IFB2.EQ.9.AND.IFB1.LE.8))THEN
	   NADZUS=NADZUS+1
	 ELSEIF(IFB1.EQ.9.AND.IFB2.EQ.9)THEN
	   NADZSS=NADZSS+1
	 ENDIF  
        IF((NCHDS2(I).NE.0))
     *  CALL HADJET(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),BGXDS2(I), BGYDS2
     +  (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),IJCDS2(I),6,NCHDS2
     +  (I),16)
C-----------------------------------------------------------------------
        IF((NCHDS2(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
          RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JIPP,',
     *    'RSEACK,PDBSE ',
     +    JIPP,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCDS2(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJASE(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),BGXDS2(I),
     *        BGYDS2
     +        (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),IJCDS2(I),6,
     *        NCHDS2
     +        (I),6,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JIPP,',
     *        'RSEACK,IREJSS ',
     +        JIPP,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSA=IREJSA+1
              IF(IREJSS.EQ.3)IREJA3=IREJA3+1
              IF(IREJSS.EQ.2)IREJA0=IREJA0+1
        CALL HADJET(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),BGXDS2(I), BGYDS2
     +  (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),IJCDS2(I),6,NCHDS2
     +  (I),16)
              IHADA6=IHADA6+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISEA63=ISEA63+1
              ELSE
                ISEA6=ISEA6+1
              ENDIF
            ENDIF
          ELSE
        CALL HADJET(NHAD,AMCDS2(I),POJ,PAT,GACDS2(I),BGXDS2(I), BGYDS2
     +  (I),BGZDS2(I),IFB1,IFB2,IFB3,IFB4, IJCDS2(I),IJCDS2(I),6,NCHDS2
     +  (I),16)
            IHADA6=IHADA6+1
          ENDIF
        ENDIF
C-----------------------------------------------------------------------
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRDZ: NHKK.EQ.NMXHKK ', NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C             WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRDZ / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALDS, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
C
          ANNDZ=ANNDZ+1
          EEDZ=EEDZ+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTDZ=PTDZ+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),1,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
C         JMOHKK(1,NHKK)=MHKKSS(I)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
C     IPHKK=0
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C
C*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE DIQZZD(ECM,XPSQ1,XPSAQ1,XPSQ2,XPSAQ2,
     *                  IPSQ1,IPSAQ1,IPSQ2,IPSAQ2,IREJSD)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*  define s-d chains (sea - sea diquark chains)
*  sq-sqsq and saq-saqsaq chains instead of q-aq and aq-q chains
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
*KEEP,INTNEW.
      PARAMETER (INTMD=252) 
      COMMON /INTNEZ/ NDZ,NZD
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C-------------------
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AM(210),GA(210),TAU(210),ICH(210),
     +IBAR(210),K1(210),K2(210)
C------------------
*KEEP,ABRSD.
      COMMON /ABRZD/ AMCSD1(INTMD),AMCSD2(INTMD),
     +GACSD1(INTMD),GACSD2(INTMD),
     +BGXSD1(INTMD),BGYSD1(INTMD),BGZSD1(INTMD), 
     +BGXSD2(INTMD),BGYSD2(INTMD),
     +BGZSD2(INTMD), NCHSD1(INTMD),NCHSD2(INTMD),
     +IJCSD1(INTMD),IJCSD2(INTMD),
     +PQSDA1(INTMD,4),PQSDA2(INTMD,4), 
     +PQSDB1(INTMD,4),PQSDB2(INTMD,4),
     +IPSQ(INTMD),ITSQ(INTMD),ITSQ2(INTMD),
     +IPSAQ(INTMD),ITSAQ(INTMD),ITSAQ2(INTMD)
     +,IZDSS(INTMD)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEND.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON/SEASU3/SEASQ
       COMMON /DIQREJ/IDIQRE(7),IDVRE(3),IVDRE(3),IDSRE(3),ISDRE(3),
     *IDZRE(3),IZDRE(3),IDIQRZ(7)
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C     COMMON /PCHARM/PCCCC
      PARAMETER (UMMM=0.3D0)
      PARAMETER (SMMM=0.5D0)
      PARAMETER (CMMM=1.3D0)
      DATA PC/0.0001D0/
*KEND.
C----------
C
C     DATA INICHA/0/
      COMMON /KAINIT/  UMODA,INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT,ISTART
      DOUBLE PRECISION UMODA
      INTEGER          INICH1,INICH2,INICH3,INICH4,INICH5,
     *                 INICH6,INICH7,INICH8,INICH9,IRETUR,KAIS,INIPRI,
     *                 NUSEPT,MUSEPT
      LOGICAL          ISTART
C----------------------------------------------------------------------
C                     Initialize Charm selection at soft chain ends
C
      IF(INICH9.EQ.0)THEN
        SEASQ=0.5D0
        RX=8.
        X1=RX
        GM=2.140
        X2=UMMM
	BETOO=7.5D0
      ENDIF
      RX=8.
      X1=RX
      BETCHA=BETOO+1.3-LOG10(ECM)
      PU=DBETA(X1,X2,BETCHA)
      X2=SMMM
      PS=DBETA(X1,X2,BETCHA)
      X2=CMMM
      PC=DBETA(X1,X2,BETCHA)
C     PU1=PU/(2*PU+PS+PC)
C     PS1=PS/(2*PU+PS+PC)
      PC1=PC/(2*PU+PS+PC)
C                       changed j.r.7.12.94
      PCC1=PC1*1.5D0
C        J.R. 2.9.07      
       IF(ECM.GE.75.D0)CHAFAC=1.D0
       IF(ECM.LE.25.D0)CHAFAC=0.333D0
       IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
      IF(IT.GE.2)THEN
        AAIT=IT
        CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
      ENDIF
       PC=PCC1*CHAFAC
C        J.R. 2.9.07      
      PU1=PU/(2*PU+PS+PC)
      PS1=PS/(2*PU+PS+PC)
      IF(INICH9.EQ.0)THEN
        INICH9=1
C       IPHKK=3
        IF(IPHKK.GE.3)WRITE(6,4567)PC,BETCHA,PU1,PS1,SEASQ
 4567   FORMAT(' Charm chain ends DIQZZD: PC,BETCHA,PU,PS,SEASQ',5F10.5)
      ENDIF
C----------------------------------------------------------------------
      IF(IPHKK.GE.3)WRITE (6,'( A)') ' diqssd'
      IREJSD=0
*  kinematics: is the mass of both chains big enough
*              to allow for fragmentation
C     IPSQQ2=1
C     RND=RNDM(V)
C     IF(RND.GT.0.62) IPSQQ2=2
C     IF(RND.LT.0.24) IPSQQ2=3
      IPSQQ2=1.D0+RNDM(V1)*(2.D0+2.D0*SEASQ)
        RR=RNDM(V)
	IF(RR.LT.PC)IPSQQ2=4
      ISAQQ2=-IPSQQ2
      AMSDQ1=XPSQ2*XPSQ1*ECM**2
      AMSDQ2=XPSAQ2*XPSAQ1*ECM**2
       IDIQRZ(1)=IDIQRZ(1)+1  
C
      IF(IPSQ2.EQ.3.AND.IPSQQ2.EQ.3)THEN
       IDIQRZ(2)=IDIQRZ(2)+1  
C       IF(AMSDQ2.LE.2.30.OR.AMSDQ1.LE.2.30) THEN
        IF(AMSDQ2.LE.6.6D0.OR.AMSDQ1.LE.6.6D0) THEN
       IDIQRZ(3)=IDIQRZ(3)+1  
       IDIQRZ(2)=IDIQRZ(2)-1  
       IDIQRZ(1)=IDIQRZ(1)-1  
          IREJSD=1
          RETURN
        ENDIF
      ELSEIF(IPSQ2.EQ.3.OR.IPSQQ2.EQ.3)THEN
       IDIQRZ(4)=IDIQRZ(4)+1  
C        IF(AMSDQ2.LE.1.9.OR.AMSDQ1.LE.1.90) THEN
        IF(AMSDQ2.LE.5.8D0.OR.AMSDQ1.LE.5.80D0) THEN
       IDIQRZ(5)=IDIQRZ(5)+1  
       IDIQRZ(4)=IDIQRZ(4)-1  
       IDIQRZ(1)=IDIQRZ(1)-1  
          IREJSD=1
          RETURN
        ENDIF
      ELSEIF(((IPSQ2.EQ.4).OR.(IPSQQ2.EQ.4)).AND.
     *       ((IPSQ2.EQ.3).OR.(IPSQQ2.EQ.3)))THEN
C       IF(AMDSQ2.LE.1.9.OR.AMDSQ1.LE.1.90) THEN
        IF(AMSDQ2.LE.30.8D0.OR.AMSDQ1.LE.30.80D0) THEN
          IREJSD=1
          RETURN
        ENDIF
      ELSEIF(IPSQ2.EQ.4.OR.IPSQQ2.EQ.4)THEN
C        IF(AMSDQ2.LE.1.9.OR.AMSDQ1.LE.1.90) THEN
        IF(AMSDQ2.LE.25.8D0.OR.AMSDQ1.LE.25.80D0) THEN
          IREJSD=1
          RETURN
        ENDIF
      ELSE
       IDIQRZ(6)=IDIQRZ(6)+1  
C        IF(AMSDQ2.LE.1.50.OR.AMSDQ1.LE.1.50) THEN
        IF(AMSDQ2.LE.3.9D0.OR.AMSDQ1.LE.3.9D0) THEN
       IDIQRZ(7)=IDIQRZ(7)+1  
       IDIQRZ(6)=IDIQRZ(6)-1  
       IDIQRZ(1)=IDIQRZ(1)-1  
          IREJSD=1
          RETURN
        ENDIF
      ENDIF
      NZD=NZD+1
      IF(NZD.GE.INTMD)THEN
	IREJSD=1
	NZD=NZD-1
	RETURN
      ENDIF
C     WRITE(6,*)' DIQZZD:IDIQRZ(1-7),NZD ',(IDIQRZ(II),II=1,7),NZD
      NCHSD1(NZD)=0
      NCHSD2(NZD)=0
      IZDSS(NZD)=0
C-------------------
C                                 kkevzd part
C-------------------
      IF(IPHKK.GE.3)WRITE (6,'( A,3I10)') ' kkevzd',NZD,
     *            NCHSD1(1),NCHSD2(1)
      N=NZD
C      DO 10 N=1,NZD
C---------------------------drop recombined chain pairs
        IF(NCHSD1(N).EQ.99.AND.NCHSD2(N).EQ.99)GO TO 10
C
C***            4-MOMENTA OF projectile QUARK-DIQUARK PAIRS IN NN-CMS
C
        PRMOMZ=SQRT(ECM**2/4.-AM(1)**2)
        PSQPX=0.
        PSQPY=0.
        PSQPZ=XPSQ1*PRMOMZ
        PSQE=XPSQ1*ECM/2.
        PSDQPX=0.
        PSDQPY=0.
        PSDQPZ=XPSAQ1*PRMOMZ
        PSDQE=XPSAQ1*ECM/2.
C
C***                 4-MOMENTA OF TARGET QUARK-DIQUARK PAIRS IN NN-CMS
*
        TSQPX=0.
        TSQPY=0.
        TSQPZ=-XPSQ2*PRMOMZ
        TSQE=XPSQ2*ECM/2.
        TSAQPX=0.
        TSAQPY=0.
        TSAQPZ=-XPSAQ2*PRMOMZ
        TSAQE=XPSAQ2*ECM/2.
C
C***           LORENTZ PARAMETER FOR CMS OF BOTH (q-sqsq) and
C              (diq-saqsaq)-SYSTEM
C              FROM PROJECTILE AND TARGET, RESP.
C
        PXXX=TSQPX + TSAQPX + PSQPX + PSDQPX
        PYYY=TSQPY + TSAQPY + PSQPY + PSDQPY
        PZZZ=TSQPZ + TSAQPZ + PSQPZ + PSDQPZ
        EEE =TSQE + TSAQE + PSQE + PSDQE
        PPTOTO=SQRT(PXXX**2+PYYY**2+PZZZ**2)
        AMMM=SQRT(ABS((EEE+PPTOTO)*(EEE-PPTOTO)))
        GAMMM=EEE/(AMMM+1.E-4)
        BGGGX=PXXX/(AMMM+1.E-4)
        BGGGY=PYYY/(AMMM+1.E-4)
        BGGGZ=PZZZ/(AMMM+1.E-4)
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
        XTSQCM=XPSQ2
        XTSACM=XPSAQ2
        XPSQCM=XPSQ1
        XPSACM=XPSAQ1
C
C***  SAMPLE PARTON-PT VALUES / DETERMINE PARTON 4-MOMENTA AND CHAIN MAS
C***                            IN THE REST FRAME DEFINED ABOVE
C
       PTXSQ1=0  
       PTYSQ1=0
       PTXSA1=0
       PTYSA1=0 
       PTXSQ2=0  
       PTYSQ2=0
       PTXSA2=0
       PTYSA2=0 
       PLQ1 = XPSQ1 *ECM/2.
       EQ1  = XPSQ1 *ECM/2. 
       PLAQ1= XPSAQ1*ECM/2.
       EAQ1 = XPSAQ1*ECM/2.
       PLQ2 =-XPSQ2 *ECM/2.
       EQ2  = XPSQ2 *ECM/2. 
       PLAQ2=-XPSAQ2*ECM/2.
       EAQ2 = XPSAQ2*ECM/2.
        NSELPT=1
        IKVALA=0
	IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVZD call selpt'
        CALL SELPT( PTXSQ1,PTYSQ1,PLQ1,
     +             EQ1,PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +             PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +             PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +             AMCH1,AMCH2,IREJSD,IKVALA,PTTQ1,PTTA1,
     +             PTTQ2,PTTA2,NSELPT)
c           WRITE(6,'(A,I5)') ' KKEVZD - IRSD13=',IRSD13
c           WRITE(6,'(A/5E12.4/4(4E12.4/),2E12.4/2I5/4E12.4)')
c    +      ' SD:  XPSQCM,XPSDCM,XTSQCM,XTSACM,AMMM,amch1,amch2 ',
c    +          XPVQCM,XPVDCM,
c    +      XTSQCM,XTSACM,AMMM, AMCH1,AMCH2
        IF (IPEV.GE.6) WRITE(6,'(A/5X,5F12.5,I10)')
     +  'SD   AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJSD ', AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJSD
        IF (IREJSD.EQ.1) THEN
          IRSD13=IRSD13 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,'(A,I5)') ' KKEVZD - IRSD13=',IRSD13
            WRITE(6,'(A/5E12.4/4(4E12.4/),2E12.4/2I5/4E12.4)')
     +      ' VD:  XPVQCM,XPVDCM,XTSQCM,XTSACM,AMMM ...', XPSQCM,XPSDCM,
     +      XTSQCM,XTSACM,AMMM, PTXSQ1,PTYSQ1,PLQ1,EQ1,PTXSA1,PTYSA1,
     +      PLAQ1,EAQ1, PTXSQ2,PTYSQ2,PLQ2,EQ2,PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +      AMCH1,AMCH2,IREJSD,IKVALA,PTTQ1,PTTA1

          ENDIF
                                                                GO TO 11
        ENDIF
C
C***  4-MOMENTA OF CHAINS IN THIS FRAME
C
        PTXCH1=PTXSQ1 + PTXSQ2
        PTYCH1=PTYSQ1 + PTYSQ2
        PTZCH1=PLQ1 + PLQ2
        ECH1=EQ1 + EQ2
        PTXCH2=PTXSA2 + PTXSA1
        PTYCH2=PTYSA2 + PTYSA1
        PTZCH2=PLAQ2 + PLAQ1
        ECH2=EAQ2 + EAQ1
C       WRITE(6,667)ECH1,ECH2,PTZCH1,PTZCH2
C 667 FORMAT(' SD ECH1,ECH2,PTZCH1,PTZCH2: ',4F10.3)
C
        IF (IPEV.GE.6) WRITE(6,'(A,5F12.5,I10/A,5F12.5/A,5F12.5)')
     +  ' SD: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJSD ', AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJSD, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2

C
C  REPLACE SMALL MASS CHAINS BY PSEUDOSCALAR OR VECTOR MESONS OR OCTETT
C                                              OR DECUPLETT BARYONS
C  FIRST FOR CHAIN 1  (PROJ quark - tar sea-diquark)
C
        CALL ZOBCMA(IPSQ2,IPSQQ2,IPSQ1, IJNCH1,NNCH1,
     +  IREJSD,AMCH1,AMCH1N,1)
C***                            MASS BELOW OCTETT BARYON MASS
        IF(IREJSD.EQ.1) THEN
          IRSD11=IRSD11 + 1
                                                                 GOTO 11
        ENDIF
C                                 CORRECT KINEMATICS FOR CHAIN 1
C***                MOMENTUM CORRECTION FOR CHANGED MASS OF CHAIN 1
        IF(NNCH1.NE.0)
     +     CALL ZORMOM(AMMM,AMCH1,AMCH1N,AMCH2,
     +         XPSQ1,XPSAQ1,XPSAQ2,XPSQ2,
     +         PTXSQ1,PTYSQ1,PLQ1,EQ1,
     +         PTXSA1,PTYSA1,PLAQ1,EAQ1,
     +         PTXSA2,PTYSA2,PLAQ2,EAQ2,
     +         PTXSQ2,PTYSQ2,PLQ2,EQ2,
     +         PTXCH1,PTYCH1,PTZCH1,ECH1, PTXCH2,PTYCH2,PTZCH2,ECH2,
     +                                                      IREJSD)
       IF(IREJSD.EQ.1)THEN
          GO TO 11
       ENDIF
C
        IF (IPEV.GE.6) WRITE(6,'(A,5F12.5,I10/A,5F12.5/A,5F12.5)')
     +  ' SD(2): AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJSD',AMMM,GAMMM,BGGGX,
     +  BGGGY,BGGGZ,IREJSD, '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',
     +  AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1,
     +  '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ', AMCH2,PTXCH2,PTYCH2,
     +  PTZCH2,ECH2
C
C  REPLACE SMALL MASS CHAINS BY octet or decuplet baryons
C       SECOND FOR CHAIN 2 (proj saquark - tar sadiquark)
C
        CALL ZOBCMA(IPSAQ1,IPSAQ2,ISAQQ2,
     +              IJNCH2,NNCH2,IREJSD,AMCH2,AMCH2N,2)
c  rejection of both s-s chains if mass of chain 2 too low
        IF(IREJSD.EQ.1) THEN
          IRSD12=IRSD12 + 1
          IF(IPEV.GE.2) THEN
            WRITE(6,1090) IRSD12
            WRITE(6,1100) IPSAQ1,IPSAQ2,ISAQQ2,
     +                    IJNCH2,NNCH2,IREJSD,
     +      XPSQ1,XPSAQ1,XPSQCM,XTSACM, XPSQ2,XPSAQ2
     +      ,XTSQCM,XTSACM, AMCH2,AMCH2N
 1090       FORMAT(' KKEVZD - IRSD12=',I5)
 1100       FORMAT(' SD - 1100', 6I5/2(4E12.4/),2E12.4)
          ENDIF
                                                                 GOTO 11
        ENDIF
C                                if AMCH2 changed in COBCMA/COMCMA
C                                ZORVAL corrects chain kinematics
C                                according to 2-body kinem.
C                                with fixed masses
        IF(NNCH2.NE.0) THEN
          AMCH2=AMCH2N
	  IORI=1
        CALL ZORVAL(AMMM,IREJSD,AMCH1,AMCH2, PTXCH1,PTYCH1,PTZCH1,ECH1,
     +    PTXCH2,PTYCH2,PTZCH2,ECH2,IORI)
C
          IF(IPEV.GE.6) THEN
            WRITE(6,'(A/3(1PE15.4),3I5)')
     +      ' SD - CALL ZORVAL: AMMM,AMCH1,AMCH2,NNCH1,NNCH2,IREJSD',
     +      AMMM, AMCH1, AMCH2, NNCH1, NNCH2, IREJSD
            WRITE(6,1050) AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJSD, AMCH1,
     +      PTXCH1,PTYCH1,PTZCH1,ECH1, AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2
 1050 FORMAT (' SD: AMMM,GAMMM,BGGGX,BGGGY,BGGGZ,IREJSD ',5F12.5,I10/
     +        '     AMCH1,PTXCH1,PTYCH1,PTZCH1,ECH1 ',5F12.5/
     +        '     AMCH2,PTXCH2,PTYCH2,PTZCH2,ECH2 ',5F12.5)
          ENDIF
          IF(IREJSD.EQ.1) THEN
*                           AMCH1N + AMCH2N > AMMM - 0.2
*                           reject event
            IRSD14=IRSD14+1
                                                                 GOTO 11
          ENDIF
        ENDIF
C
C                           TRANSFORM BOTH CHAINS BACK INTO NN CMS
C
C                                   4-MOMENTA OF CHAINS
        QTXCH1=PTXCH1
        QTYCH1=PTYCH1
        QTZCH1=PTZCH1
        QECH1=ECH1

        QTXCH2=PTXCH2
        QTYCH2=PTYCH2
        QTZCH2=PTZCH2
        QECH2=ECH2
C       WRITE(6,887)QECH1,QECH2,QTZCH1,QTZCH2,AMCH1,AMCH2
C 887 FORMAT( ' SD: QECH1,QECH2,QTZCH1,QTZCH2,AMCH1,AMCH2  ',6F10.2)

C                                   PARTONS AT ENDS OF CHAIN 1
        PQSDA1(N,1)=PTXSQ1
        PQSDA1(N,2)=PTYSQ1
        PQSDA1(N,3)=PLQ1
        PQSDA1(N,4)=EQ1

        PQSDA2(N,1)=PTXSQ2
        PQSDA2(N,2)=PTYSQ2
        PQSDA2(N,3)=PLQ2
        PQSDA2(N,4)=EQ2

C                                   PARTONS AT ENDS OF CHAIN 2
        PQSDB2(N,1)=PTXSA2
        PQSDB2(N,2)=PTYSA2
        PQSDB2(N,3)=PLAQ2
        PQSDB2(N,4)=EAQ2

        PQSDB1(N,1)=PTXSA1
        PQSDB1(N,2)=PTYSA1
        PQSDB1(N,3)=PLAQ1
        PQSDB1(N,4)=EAQ1

C

C
C
C  NOW WE HAVE AN ACCEPTABLE SEA--VALENCE  EVENT
*     sea diquark pair!
C  AND PUT IT INTO THE HISTOGRAM
C
        IPSQ(N)=IPSQ1
        ITSQ(N)=IPSQ2
        ITSQ2(N)=IPSQQ2
        IPSAQ(N)=IPSAQ1
        ITSAQ(N)=IPSAQ2
        ITSAQ2(N)=ISAQQ2
        AMCSD1(N)=AMCH1
        AMCSD2(N)=AMCH2
        GACSD1(N)=QECH1/AMCH1
        BGXSD1(N)=QTXCH1/AMCH1
        BGYSD1(N)=QTYCH1/AMCH1
        BGZSD1(N)=QTZCH1/AMCH1
        GACSD2(N)=QECH2/AMCH2
        BGXSD2(N)=QTXCH2/AMCH2
        BGYSD2(N)=QTYCH2/AMCH2
        BGZSD2(N)=QTZCH2/AMCH2
        NCHSD1(N)=NNCH1
        NCHSD2(N)=NNCH2
        IJCSD1(N)=IJNCH1
        IJCSD2(N)=IJNCH2
        IF (IPEV.GE.2) WRITE(6,'(A/I10,4F12.7,5I5/10X,4F12.6/10X,6F12.6,
     +4I5/8F15.5/8F15.5/2I5)') ' SD / FINAL PRINT',N
                                                                GO TO 20
C***                     TREATMENT OF REJECTED SEA-SEA INTERACTIONS
   11   CONTINUE
        NCHSD1(N)=99
        NCHSD2(N)=99
C                                     28.10.96
	NZD=NZD-1
	IF(NZD.LT.0)THEN
	  NZD=NZD+1
	ENDIF
      ISSQQ=IPSQ2
      JSSQQ=IPSQQ2
      IF(ISSQQ.EQ.3.AND.JSSQQ.EQ.3)THEN
        IZDRE(3)=IZDRE(3)+1
      ELSEIF(ISSQQ.EQ.3.OR.JSSQQ.EQ.3)THEN
        IZDRE(2)=IZDRE(2)+1
      ELSE
        IZDRE(1)=IZDRE(1)+1
      ENDIF
   20   CONTINUE
   10 CONTINUE
C     WRITE(6,*)' DIQZZD: IZDRE(1-3),NZD ',(IZDRE(II),II=1,3),NZD
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C ---------------------------------------------------------------
C ---------------------------------------------------------------
C ---------------------------------------------------------------

C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE HADRZD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C-------------------------
C
C                       hadronize sea diquark - valence CHAINS
C
C                       ADD GENERATED HADRONS TO /ALLPAR/
C                          STARTING AT (NAUX + 1)
C                       AND TO /HKKEVT/ STARTING AT (NHKK + 1)
C
C---------------------------------------------------------
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
       COMMON/POPCCK/PDBCK,PDBSE,PDBSEU,
     *  IJPOCK,IREJCK,ICK4,IHAD4,ICK6,IHAD6
     *,IREJSE,ISE4,ISE6,IREJS3,ISE43,ISE63,IREJS0
     *,IHADA4,IHADA6,IREJSA,ISEA4,ISEA6,IREJA3,
     *ISEA43,ISEA63,IREJAO
      PARAMETER (INTMD=252)
      COMMON /INTNEZ/ NDZ,NZD
C-------------------
*KEEP,ABRSD.
      COMMON /ABRZD/ AMCSD1(INTMD),AMCSD2(INTMD),
     +GACSD1(INTMD),GACSD2(INTMD),
     +BGXSD1(INTMD),BGYSD1(INTMD),BGZSD1(INTMD), 
     +BGXSD2(INTMD),BGYSD2(INTMD),
     +BGZSD2(INTMD), NCHSD1(INTMD),NCHSD2(INTMD),
     +IJCSD1(INTMD),IJCSD2(INTMD),
     +PQSDA1(INTMD,4),PQSDA2(INTMD,4), 
     +PQSDB1(INTMD,4),PQSDB2(INTMD,4),
     +IPSQ(INTMD),ITSQ(INTMD),ITSQ2(INTMD),
     +IPSAQ(INTMD),ITSAQ(INTMD),ITSAQ2(INTMD)
     +,IZDSS(INTMD)
*KEEP,INTMX.
      PARAMETER (INTMX=2488)
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,DIQI.
C     COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
C    +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
C    +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
C    +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
C     COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
C    +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
C    +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
C    +INTSS1(INTMX),INTSS2(INTMX),
C    +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
C    +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,DFINPA.
      CHARACTER*8 ANF
      PARAMETER (NFIMAX=249)
      COMMON /DFINPA/ ANF(NFIMAX),PXF(NFIMAX),PYF(NFIMAX),PZF(NFIMAX),
     +HEF(NFIMAX),AMF(NFIMAX), ICHF(NFIMAX),IBARF(NFIMAX),NREF(NFIMAX)
      COMMON /DFINPZ/IORMO(NFIMAX),IDAUG1(NFIMAX),IDAUG2(NFIMAX),
     * ISTATH(NFIMAX)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEND.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
C                                   modified DPMJET
       COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
     *                 ANNDV,ANNVD,ANNDS,ANNSD,
     *                 ANNHH,ANNZZ,
     *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
     *                 PTHH,PTZZ,
     *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
     *                 EEHH,EEZZ
     *                ,ANNDI,PTDI,EEDI
     *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
       COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
     *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
     *                 ACOUDZ,ACOUZD,ACOUDI,
     *                 ACOUDV,ACOUVD,ACOUCC
      COMMON /DIQSUM/NDVUU,NDVUS,NDVSS,NVDUU,NVDUS,NVDSS,
     *               NDSUU,NDSUS,NDSSS,NSDUU,NSDUS,NSDSS,
     *               NDZUU,NDZUS,NDZSS,NZDUU,NZDUS,NZDSS 
     *              ,NADVUU,NADVUS,NADVSS,NAVDUU,NAVDUS,NAVDSS,
     *               NADSUU,NADSUS,NADSSS,NASDUU,NASDUS,NASDSS,
     *               NADZUU,NADZUS,NADZSS,NAZDUU,NAZDUS,NAZDSS 
C---------------------
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)

      DIMENSION POJ(4),PAT(4)
      DATA NCALSD /0/
C     IPHKK=3
C-----------------------------------------------------------------------
      IF(IPHKK.GE.3)WRITE (6,'( A,4I10)') ' hadrzd',NDZ,NZD,
     *           NCHSD1(1),NCHSD2(1)
      NCALSD=NCALSD+1
      DO 50 I=1,NZD
C-----------------------drop recombined chain pairs
        IF(NCHSD1(I).EQ.99.AND.NCHSD2(I).EQ.99) GO TO 50
        IS1=I
        IS2=I
C
C       IF (IPCO.GE.6) WRITE (6,1000) IPSQ(IS1),IPSAQ(IS1),ITVQ(IS2),
C    +  ITTV1(IS2),ITTV2(IS2), AMCSD1(I),AMCSD2(I),GACSD1(I),GACSD2(I),
C    +  BGXSD1(I),BGYSD1(I),BGZSD1(I), BGXSD2(I),BGYSD2(I),BGZSD2(I),
C    +  NCHSD1(I),NCHSD2(I),IJCSD1(I),IJCSD2(I), PQSDA1(I,4),PQSDA2
C    +  (I,4),PQSDB1(I,4),PQSDB2(I,4)
 1000 FORMAT(10X,5I5,10F9.2/10X,4I5,4F12.4)
C
C++++++++++++++++++++++++++++++    CHAIN 1:  quark-diquark   +++++++++++
        IFB1=IPSQ(IS1)
        IFB2=ITSQ(IS2)
        IFB3=ITSQ2(IS2)
        DO 10 J=1,4
          POJ(J)=PQSDA1(I,J)
          PAT(J)=PQSDA2(I,J)
   10   CONTINUE
        IF((NCHSD1(I).NE.0.OR.NCHSD2(I).NE.0).AND.IP.NE.1)
     &  CALL SAPTRE(AMCSD1(I),GACSD1(I),BGXSD1(I),BGYSD1(I),BGZSD1(I),
     &              AMCSD2(I),GACSD2(I),BGXSD2(I),BGYSD2(I),BGZSD2(I))
C----------------------------------------------------------------
C----------------------------------------------------------------
C       WRITE (6,1244) POJ,PAT
C1244   FORMAT ('  V-D QUARK-DIQUARK POJ,PAT ',8E12.3)
*       IF(AMCSD1(I).LT.1.6)THEN
*         IF(NCHSD1(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRZD AMCDS1(I),NCHSD1(I),I ',
*    +                AMCSD1(I),NCHSD1(I),IJCSD1(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
       IF(INTSV2(I).GT.0)THEN
         ITTT = IFROVT(INTSV2(I))
         JITT=JTSHS(ITTT)
       ELSEIF(INTSV2(I).EQ.0)THEN
         JITT=0
       ENDIF
C       IF(NCHSV1(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRSV: I,ITTT,JITT ',
C    *                     I,ITTT,JITT
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB2.LE.2.AND.IFB3.LE.2)THEN
	   NZDUU=NZDUU+1
	 ELSEIF((IFB2.EQ.3.AND.IFB3.LE.2).OR.
     *  	 (IFB3.EQ.3.AND.IFB2.LE.2))THEN
	   NZDUS=NZDUS+1
	 ELSEIF(IFB2.EQ.3.AND.IFB3.EQ.3)THEN
	   NZDSS=NZDSS+1
	 ENDIF  
        IF((NCHSD1(I).NE.0))
     *  CALL HADJET(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),BGXSD1(I), BGYSD1
     +  (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),IJCSD1(I),4,NCHSD1
     +  (I),17)
C-------------------------------------------------------------------
        AACK=FLOAT(ICK4)/FLOAT(ICK4+IHAD4+1)
        IF((NCHSD1(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
          RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JITT,',
     *    'RSEACK,PDBSE 2 dpmdiqqq ',
     +    JITT,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCSD1(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJSE(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),BGXSD1(I),
     *        BGYSD1
     +        (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),IJCSD1(I),4,
     *        NCHSD1
     +        (I),3,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *        'RSEACK,IREJSS 2 dpmdiqqq ',
     +        JITT,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSE=IREJSE+1
              IF(IREJSS.EQ.3)IREJS3=IREJS3+1
              IF(IREJSS.EQ.2)IREJS0=IREJS0+1
        CALL HADJET(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),BGXSD1(I), BGYSD1
     +  (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),IJCSD1(I),4,NCHSD1
     +  (I),17)
              IHAD4=IHAD4+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISE43=ISE43+1
              ELSE
                ISE4=ISE4+1
              ENDIF
            ENDIF
          ELSE
        CALL HADJET(NHAD,AMCSD1(I),POJ,PAT,GACSD1(I),BGXSD1(I), BGYSD1
     +  (I),BGZSD1(I),IFB1,IFB2,IFB3,IFB4, IJCSD1(I),IJCSD1(I),4,NCHSD1
     +  (I),17)
            IHAD4=IHAD4+1
          ENDIF
        ENDIF
C-------------------------------------------------------------------
        ACOUZD=ACOUZD+1
        NHKKAU=NHKK+1
        DO 20 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRZD: NHKK.EQ.NMXHKK ',NHKK,NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
          IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C           WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRZD / CHAIN 1 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNZD=ANNZD+1
          EEZD=EEZD+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTZD=PTZD+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),1,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
C         JMOHKK(1,NHKK)=MHKKSS(I)-3
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   20   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
C+++++++++++++++++++++++++++++   CHAIN 2: aquark - adiquark  +++++++++
        IFB1=IPSAQ(IS1)
        IFB2=ITSAQ(IS2)
        IFB3=ITSAQ2(IS2)
        IFB1=IABS(IFB1)+6
        IFB2=IABS(IFB2)+6
        IFB3=IABS(IFB3)+6
        DO 30 J=1,4
          POJ(J)=PQSDB2(I,J)
          PAT(J)=PQSDB1(I,J)
   30   CONTINUE
C
*       IF(AMCSD2(I).LT.1.6)THEN
*         IF(NCHSD2(I).EQ.0)THEN
*           WRITE(6,'(A,F10.2,5I5)')' HADRZD AMCSD2(I),NCHSD2(I),I ',
*    +                AMCSD2(I),NCHSD2(I),IJCSD2(I),I,IS1,IS2
*           RETURN
*         ENDIF
*       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
C               I= number of valence chain
C               Target     Nr itt = IFROVT(INTSV2(I))
C          No of Glauber sea q at Target     JITT=JTSHS(ITT)
       IF(INTSV2(I).GT.0)THEN
         ITTT = IFROVT(INTSV2(I))
         JITT=JTSHS(ITTT)
       ELSEIF(INTSV2(I).EQ.0)THEN
         JITT=0
       ENDIF
C       IF(NCHSV1(I).EQ.0)THEN
C      WRITE(6,'(A,3I5)')'HADRSV: I,ITTT,JITT ',
C    *                     I,ITTT,JITT
C       ENDIF
C------------------------------------------------------------------
C                                   check bookkeeping
C-----------------------------------------------------------------
         IF(IFB2.LE.8.AND.IFB3.LE.8)THEN
	   NAZDUU=NAZDUU+1
	 ELSEIF((IFB2.EQ.9.AND.IFB3.LE.8).OR.
     *  	 (IFB3.EQ.9.AND.IFB2.LE.8))THEN
	   NAZDUS=NAZDUS+1
	 ELSEIF(IFB2.EQ.9.AND.IFB3.EQ.9)THEN
	   NAZDSS=NAZDSS+1
	 ENDIF  
        IF((NCHSD2(I).NE.0))
     *  CALL HADJET(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),BGXSD2(I), BGYSD2
     +  (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),IJCSD2(I),4,NCHSD2
     +  (I),18)
C----------------------------------------------------------------------
        IF((NCHSD1(I).EQ.0))THEN
          ZSEAWU=RNDM(BB)*2.D0*ZSEAAV
          RSEACK=FLOAT(JITT)*PDBSE +ZSEAWU*PDBSEU
          IF(IPCO.GE.1)WRITE(6,'(2A,I5,2F10.3)')'HADJSE JITT,',
     *    'RSEACK,PDBSE ',
     +    JITT,RSEACK,PDBSE
          IREJSS=5
          IF(RNDM(V).LE.RSEACK)THEN
            IREJSS=2
            IF(AMCSD2(I).GT.2.3D0)THEN
              IREJSS=0
              CALL HADJASE(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),BGXSD2(I),
     *        BGYSD2
     +        (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),IJCSD2(I),4,
     *        NCHSD2
     +        (I),3,IREJSS,IISSQQ)
              IF(IPCO.GE.1)WRITE(6,'(2A,I5,F10.3,I5)')'HADJSE JITT,',
     *        'RSEACK,IREJSS ',
     +        JITT,RSEACK,IREJSS
            ENDIF
            IF(IREJSS.GE.1)THEN
              IF(IREJSS.EQ.1)IREJSA=IREJSA+1
              IF(IREJSS.EQ.3)IREJA3=IREJA3+1
              IF(IREJSS.EQ.2)IREJA0=IREJA0+1
        CALL HADJET(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),BGXSD2(I), BGYSD2
     +  (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),IJCSD2(I),4,NCHSD2
     +  (I),18)
              IHADA4=IHADA4+1
            ENDIF
            IF(IREJSS.EQ.0)THEN
              IF(IISSQQ.EQ.3)THEN
                ISEA43=ISEA43+1
              ELSE
                ISEA4=ISEA4+1
              ENDIF
            ENDIF
          ELSE
        CALL HADJET(NHAD,AMCSD2(I),POJ,PAT,GACSD2(I),BGXSD2(I), BGYSD2
     +  (I),BGZSD2(I),IFB1,IFB2,IFB3,IFB4, IJCSD2(I),IJCSD2(I),4,NCHSD2
     +  (I),18)
            IHADA4=IHADA4+1
          ENDIF
        ENDIF
C----------------------------------------------------------------------
C                                   ADD HADRONS/RESONANCES INTO
C                                   COMMON /ALLPAR/ STARTING AT NAUX
        NHKKAU=NHKK+1
        DO 40 J=1,NHAD
          IF (NHKK.EQ.NMXHKK) THEN
            WRITE (6,'(A,2I5/A)') ' HADRZD: NHKK.EQ.NMXHKK ', NHKK,
     +      NMXHKK
            RETURN
          ENDIF
C         NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
        IF (IPEV.GT.1)
     &     WRITE (6,'(A,2I5)')' XKSAMP:NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
C
          EHECC=SQRT(PXF(J)**2+PYF(J)**2+PZF(J)**2+AMF(J)**2)
        IF (ABS(EHECC-HEF(J)).GT.0.001) THEN
C             WRITE(6,'(2A/3I5,3E15.6)')
C    &            ' HADRZD / CHAIN 2 : CORRECT INCONSISTENT ENERGY ',
C    *            '  NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)',
C    *            NCALSD, NHKK,NREF(J), HEF(J),EHECC, AMF(J)
          HEF(J)=EHECC
          ENDIF
          ANNZD=ANNZD+1
          EEZD=EEZD+HEF(J)
C                               PUT NN-CMS HADRONS INTO /HKKEVT/
          PTZD=PTZD+SQRT(PXF(J)**2+PYF(J)**2)
          ISTIST=1
          IF(IBARF(J).EQ.500)ISTIST=2
          CALL HKKFIL(ISTIST,MPDGHA(NREF(J)),1,0,
     *                PXF(J),PYF(J),PZF(J),HEF(J),NHKKAU,IORMO(J))
          IF(IDHKK(NHKK).EQ.99999) WRITE (6,1030)NHKK,NREF(J), IDHKK
     +    (NHKK)
C         JMOHKK(1,NHKK)=MHKKSS(I)
          IF (IPHKK.GE.2) WRITE(6,1010) NHKK, ISTHKK(NHKK),IDHKK(NHKK),
     +    JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +    (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
   40   CONTINUE
C       IF(NHAD.GT.0) THEN
C         JDAHKK(1,IMOHKK)=NHKKAU
C         JDAHKK(2,IMOHKK)=NHKK
C       ENDIF
   50 CONTINUE
C----------------------------------------------------------------
C
C     IPHKK=0
      RETURN
 1010 FORMAT (I6,I4,5I6,9E10.2)
 1020 FORMAT (' HADRKK J.GT.NAUMAX SKIP NEXT PARTICLES ',3I10)
 1030 FORMAT (' NHKK,IDHKK(NHKK)  ',3I10)
      END
C ---------------------------------------------------------------
C ---------------------------------------------------------------
C ---------------------------------------------------------------
C
      SUBROUTINE ZOBCMA(IF1,IF2,IF3,IJNCH,NNCH,IREJ,AMCH,AMCHN,IKET)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  REPLACE SMALL MASS BARYON CHAINS (AMCH)
C  BY OCTETT OR DECUPLETT BARYONS
C
C  MASS CORRECTED FOR NNCH.NE.0
C
C  IREJ=1: CHAIN GENERATION NOT ALLOWED BECAUSE OF TOO SMALL MASS
C          START FROM THE BEGINNING IN HAEVT
C
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEND.
C----------------
      CALL DBKLAS(IF1,IF2,IF3,IB8,IBB10)
C
      IF (IPEV.GE.6)WRITE(6,1000)IF1,IF2,IF3,IB8,IBB10
 1000 FORMAT (' COBCMA: IPQ,ITTQ1,ITTQ2,IB8,IBB10 ',5I5)
C
      AM81=AAM(IB8)
      AM101=AAM(IBB10)
      AM8(IKET)=AM81
      AM10(IKET)=AM101
      IB88(IKET)=IB8
      IB1010(IKET)=IBB10
      NNCH=0
      IJNCH=0
      IREJ=0
      AMFF1=AM101+0.3
C
      IF(AMCH.LT.AM81) THEN
        IREJ=1
      ELSEIF (AMCH.LT.AM101)THEN
C                                PRODUCE OKTETT BARYON
C                                 CORRECT KINEMATICS
        IJNCH=IB8
        NNCH=-1
        AMCHN=AM81
      ELSEIF(AMCH.LT.AMFF1) THEN
C                                 PRODUCE DECUPLETT BARYON
C                                 CORRECT KINEMATICS
        AMCHN=AM101
        IJNCH=IBB10
        NNCH=1
      ELSE
        AMCHN=AMCH
      ENDIF
C                                 NO CORRECTIONS BUT DO  CHAIN 2
      IF(IPEV.GE.6) THEN
        WRITE(6,1010) AMCH,AMCHN,AM81,AM101
        WRITE(6,1020) IF1,IF2,IF3,IB8,IBB10,IJNCH,NNCH,IREJ
 1010 FORMAT(' COBCMA: AMCH,AMCHN,AM81,AM101', 4F13.4)
 1020 FORMAT(' COBCMA: IF1,IF2,IF3,IB8,IBB10,IJNCH,NNCH,IREJ',8I4)
      ENDIF
      RETURN
      END
*CMZ :  1.00/00 27/11/91  17.09.37  by  H.-J. Mhring
*-- Author :
C
C++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE ZOMCMA(IFQ,IFAQ,IJNCH,NNCH,IREJ,AMCH,AMCHN)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  REPLACE SMALL MASS MESON CHAINS BY PSEUDOSCALAR OR VECTOR MESONS
C
C
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
C------------------
*KEEP,INPDAT.
      COMMON /INPDAT/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C------------------------
      IIFAQ=IABS(IFAQ)
      IFPS=IMPS(IIFAQ,IFQ)
      IFV=IMVE(IIFAQ,IFQ)
      IF (IPEV.GE.6)WRITE (6,1000)IIFAQ,IFQ,IFPS,IFV
 1000 FORMAT (' COMCMA',5X,' IIPPAQ,ITQ,IFPS,IFV ',4I5)
      AMPS=AAM(IFPS)
      AMV=AAM(IFV)
      NNCH=0
      IJNCH=0
      IREJ=0
      AMFF=AMV+0.3
      IF(IPEV.GE.6) WRITE(6,1010) AMCH,AMPS,AMV,IFPS,IFV
 1010 FORMAT(' AMCH,AMPS,AMV,IFPS,IFV ',3F12.4,2I10)
C
      IF(AMCH.LT.AMPS) THEN
        IREJ=1
        RETURN
      ENDIF
C
      IF (AMCH.LT.AMV) THEN
C                                PRODUCE PSEUDO SCALAR
        IJNCH=IFPS
        NNCH=-1
        AMCHN=AMPS
      ELSEIF(AMCH.LT.AMFF) THEN
C                                 PRODUCE VECTOR MESON
        IJNCH=IFV
        NNCH=1
        AMCHN=AMV
      ELSE
        AMCHN=AMCH
      ENDIF
C
      RETURN
      END
*CMZ :  1.00/00 27/11/91  17.09.38  by  H.-J. Mhring
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C   17/10/89 910191458  MEMBER NAME  MCOMCM2  (KK89.S)      F77
      SUBROUTINE ZOMCM2(IQ1,IQ2,IAQ1,IAQ2,NNCH,IREJ,AMCH)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE

C--------------------------------------------------------------------
C  (QQ)-(AQ AQ) CHAIN:
C                      CHECK QUANTUM NUMBERS AND
C                      CORRECT MASS IF NECESSARY
C             REJECT IF THERE IS NO CORRESPONDING PARTICLE
C                    OR TOO LOW MASS
C--------------------------------------------------------------------
C
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,INPDAT.
      COMMON /INPDAT/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEND.
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C--------------------------
      IREJ=0
      IIAQ1=-IAQ1
      IIAQ2=-IAQ2
      IF (IIAQ1.EQ.IQ1)                                         GO TO 10
      IF (IIAQ1.EQ.IQ2)                                         GO TO 20
      IF (IIAQ2.EQ.IQ1)                                         GO TO 30
      IF (IIAQ2.EQ.IQ2)                                         GO TO 40
C                                  REJECTION: NO CANCELLATION OF
C                                             ANY (Q-AQ) PAIR
      IREJ=1
      IF(IPEV.GE.3) THEN
        WRITE(6,'(A/5X,4I5,1PE13.5)')
     +  ' KKEVVV/COMCM2 (QU. NUMBERS): IQ1, IQ2, IAQ1, IAQ2, AMCH', IQ1,
     +  IQ2, IAQ1, IAQ2, AMCH
      ENDIF
      RETURN
C
   10 CONTINUE
C     IFPS=IMPS(IIAQ2,IQ2)
C     IFV =IMVE(IIAQ2,IQ2)
                                                                GO TO 50
   20 CONTINUE
C     IFPS=IMPS(IIAQ2,IQ1)
C     IFV =IMVE(IIAQ2,IQ1)
                                                                GO TO 50
   30 CONTINUE
C     IFPS=IMPS(IIAQ1,IQ2)
C     IFV =IMVE(IIAQ1,IQ2)
                                                                GO TO 50
   40 CONTINUE
C     IFPS=IMPS(IIAQ1,IQ1)
C     IFV =IMVE(IIAQ1,IQ1)
C
   50 CONTINUE
C     AMFPS=AAM(IFPS)
C     AMFV =AAM(IFV)
C     AMFF=AMFV+0.3
C                     EMPIRICAL DEFINITION OF AMFF
C                     TO ALLOW FOR (B-ANTIB) PAIR PRODUCTION
      AMFF=2.5
      NNCH=0
      IF (AMCH.LT.AMFF) THEN
        IREJ=1
        IF(IPEV.GE.3) THEN
          WRITE(6,'(A/5X,4I5,1PE13.5)')
     +    ' KKEVVV/COMCM2 (MASS!): IQ1, IQ2, IAQ1, IAQ2, AMCH', IQ1,
     +    IQ2, IAQ1, IAQ2, AMCH
        ENDIF
      ENDIF
      RETURN
      END
*CMZ :  1.00/00 27/11/91  17.09.38  by  H.-J. Mhring
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE ZORMOM(AMMM,AMCH1,AMCH1N,AMCH2N, XP,XPP,XTVQ,XTVD,
     +PQ1X,PQ1Y,PQ1Z,PQ1E,PA1X,PA1Y,PA1Z,PA1E, PQ2X,PQ2Y,PQ2Z,PQ2E,PA2X,
     +PA2Y,PA2Z,PA2E, PXCH1,PYCH1,PZCH1,ECH1, PXCH2,PYCH2,PZCH2,ECH2,
     +                                                         IREJ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C   CORRECT KINEMATICS IF MASS OF THE FIRST CHAIN HAS BEEN CHANGED
C                              FROM AMCH1 TO AMCH1N
C   CHAIN 1:  (XP,XTVD)
C   AMMM   :  TOTAL MASS OF TWO CHAIN SYSTEM
C   AMCH2N :  RESULTING NEW MASS FOR CHAIN 2 (OUTPUT ONLY)
C
C---                        RESCALING OF X-VALUES
C                           ACCORDING TO THE MODIFIED MASS OF CHAIN 1
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
C------------------------------------
       IREJ=0
      FAK=AMCH1N/AMCH1
      AMCH1=AMCH1N
      XPSQOL=XP
      XP=XP*FAK
      XPP=XPP + XPSQOL - XP
      XTVDOL=XTVD
      XTVD=XTVD*FAK
      XTVQ=XTVQ + XTVDOL - XTVD
      XPPCM=XPP/(XP+XPP)
      XTVQCM=XTVQ/(XTVQ+XTVD)
C
C---                        RESCALING OF MOMENTA FOR PARTONS OF CHAIN 1
      PQ1X=PQ1X*FAK
      PQ1Y=PQ1Y*FAK
      PQ1Z=PQ1Z*FAK
      PQ1E=PQ1E*FAK
      PA2X=PA2X*FAK
      PA2Y=PA2Y*FAK
      PA2Z=PA2Z*FAK
      PA2E=PA2E*FAK
C---                        NEW MOMENTUM OF CHAIN 1
C                           TO BE COMPENSATED BY CHAIN 2
      PXCH1=PQ1X+PA2X
      PYCH1=PQ1Y+PA2Y
      PZCH1=PQ1Z+PA2Z
      ECH1 =PQ1E+PA2E
      IF(ECH1.LE.AMCH1)THEN
        IREJ=1
C       WRITE(6,'(A)') ' ZORMOM: INCONSISTENT KINEMATICS'
        RETURN
      ENDIF
      PCH1 =SQRT(ABS((ECH1-AMCH1)*(ECH1+AMCH1)))+0.000001
      CXCH1=PXCH1/PCH1
      CYCH1=PYCH1/PCH1
      CZCH1=PZCH1/PCH1
C---                        NEW 4-MOMENTUM OF CHAIN 2
      PXCH2=-PXCH1
      PYCH2=-PYCH1
      PZCH2=-PZCH1
      ECH2 =AMMM - ECH1
      IF(ECH2.LE.PCH1)THEN
        IREJ=1
C       WRITE(6,'(A)') ' ZORMOM: INCONSISTENT KINEMATICS'
        RETURN
      ENDIF
C---                        ENERGIES OF PARTONS FROM CHAIN 2
      AMCH2N=SQRT(ABS((ECH2-PCH1)*(ECH2+PCH1)))
      PA1E=XPPCM*AMMM/2.
      PQ2E=XTVQCM*AMMM/2.
      IF(PCH1.GT.(PA1E+PQ2E)) THEN
        IREJ=1
C       WRITE(6,'(A)') ' ZORMOM: INCONSISTENT KINEMATICS'
        RETURN
      ENDIF
C---                         MOMENTUM COMPONENTS OF PARTONS FROM CHAIN 2
C                            WITH RESPECT TO THE MOMENTUM OF CHAIN 1 (Z)
      CT1=-(PCH1**2 + (PA1E-PQ2E)*(PA1E+PQ2E))/(2.0*PCH1*PA1E)
      if(abs(ct1).gt.1.0) then
C       write(6,'(5x,A/5x,4(1PE15.7))')
C    &        ' ZORMOM: PCH1,PA1E,PQ2E, CT1', PCH1,PA1E,PQ2E, CT1
C     CT1=SIGN(0.999999999,CT1)
             CT1=DSIGN(0.999999999D0,CT1)
C       WRITE(6,'(A)') ' ZORMOM: INCONSISTENT KINEMATICS'
	IREJ=1
	RETURN
      endif
      ST1=SQRT(ABS((1.0+CT1)*(1.0-CT1)))
      CALL DSFECF(SFE,CFE)
      CALL DRTRAN(CXCH1,CYCH1,CZCH1,CT1,ST1,SFE,CFE,CXA1,CYA1,CZA1)
      PA1X=CXA1*PA1E
      PA1Y=CYA1*PA1E
      PA1Z=CZA1*PA1E
      PQ2X=PXCH2 - PA1X
      PQ2Y=PYCH2 - PA1Y
      PQ2Z=PZCH2 - PA1Z
C---
      IF(IPRI.GT.1) THEN
        PXSUM=PQ1X+PA1X+PQ2X+PA2X
        PYSUM=PQ1Y+PA1Y+PQ2Y+PA2Y
        PZSUM=PQ1Z+PA1Z+PQ2Z+PA2Z
        PESUM=PQ1E+PA1E+PQ2E+PA2E
        WRITE(6,'(A)') ' ZORMOM: KINEMATIC TEST FOR PARTONS'
        WRITE(6,'(A,1PE12.5)') ' AMMM',AMMM
        WRITE(6,'(A,4(1PE12.5))') ' PXSUM,PYSUM,PZSUM,PESUM', PXSUM,
     +  PYSUM,PZSUM,PESUM
      ENDIF
      RETURN
      END
*CMZ :  1.00/00 27/11/91  17.09.38  by  H.-J. Mhring
*-- Author :
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C     DEBUG SUBCHK
C     END DEBUG
      SUBROUTINE ZORVAL(AMMM,IREJ,AMCH1,AMCH2, QTX1,QTY1,QZ1,QE1,QTX2,
     +QTY2,QZ2,QE2,IORI)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C KINEMATICAL CORRECTION OF TWO-VALENCE CHAIN SYSTEM
C ACCORDING TO 2-PARTICLE KINEMATICS WITH FIXED MASSES
C
C**** WIR BRAUCHEN AUCH NOCH DIE NEUEN 4-IMPULSE DER KETTENENDEN
C
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEND.
C-----------------------------------------
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      IREJ=0
      IF(AMMM.LE.AMCH1+AMCH2+0.4) THEN
        IREJ=1
        RETURN
      ENDIF
C
      EK1=(AMMM**2-AMCH2**2 + AMCH1**2)/(2.*AMMM)
      EK2=AMMM - EK1
C     PZK1=SIGN(PZK1,QZ1)
      PZK1=SQRT(EK1**2 - AMCH1**2)
              PZK1=DSIGN(PZK1,QZ1)
C     PZK2=SIGN(PZK2,QZ2)
      PZK2=SQRT(EK2**2 - AMCH2**2)
                  PZK2=DSIGN(PZK2,QZ2)
      PXK1=0.
      PYK1=0.
      PXK2=0.
      PYK2=0.
C                      ROTATE NEW CHAIN MOMENTA
C                      INTO DIRECTION OF CHAINS BEFORE CORRECTION
      GAM=(QE1+QE2)/AMMM
      BGX=(QTX1+QTX2)/AMMM
      BGY=(QTY1+QTY2)/AMMM
      BGZ=(QZ1+QZ2)/AMMM
C
      IF(ABS(GAM-1.).GT.1E-4) THEN
C       WRITE(6,'(A/5(1PE15.5)/15X,4(1PE15.4),I5)')
C    +  ' ZORVAL: INCONSISTENT KINEMATICS OF CHAINS 
C    +   AMMM, QE1, QTX1, QTY1, QZ1, QE2, QTX2, QTY2, QZ2', AMMM, QE1,
C    +  QTX1, QTY1, QZ1, QE2, QTX2, QTY2, QZ2,IORI
         IREJ=1
          RETURN
      ENDIF
C
      CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PXK1,PYK1,PZK1,EK1,PPPCH1, QTX1,
     +QTY1,QZ1,QE1)
      CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PXK2,PYK2,PZK2,EK2,PPPCH2, QTX2,
     +QTY2,QZ2,QE2)
      IF(IPRI.GT.1) THEN
        WRITE(6,'(2A)') ' ZORVAL - CORRECTION OF CHAIN MOMENTA',
     +  ' IF MASS OF CHAIN 2 HAD TO BE CHANGED'
      ENDIF
      RETURN
      END
*
*===kkinc==============================================================*
*

**sr mod. for DPMJET: parameter list
      SUBROUTINE KKINC(EPN,NTMASS,NTCHAR,NPMASS,NPCHAR,IDP,KKMAT,
     *IDT, NHKKH1,IREJ)

************************************************************************
* Treatment of complete nucleus-nucleus or hadron-nucleus scattering   *
* This subroutine is an update of the previous version written         *
* by J. Ranft/ H.-J. Moehring.                                         *
* This version dated 19.11.95 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0,ONE=1.0D0,TINY5=1.0D-5,
     &           TINY2=1.0D-2,TINY3=1.0D-3)

      LOGICAL LFZC

      PARAMETER (NMXHKK=49998) 
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
**sr mod. for DPMJET: EPROJ needed
      COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
**sr mod. for DPMJET: commons added
      COMMON /FINAL/  IFINAL
      COMMON /CMHICO/ CMHIS
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      COMMON /CHABAI/CHARGI,BARNUI
      COMMON /NOMIJE/ PTMIJE(10),NNMIJE(10)
      COMMON /NNCMS/  GAMCM,BGCM,UMOL,PCML,EPROJL,PPROJL
      COMMON /EDENS/IEDEN
      COMMON /XDIDID/XDIDI
      COMMON /NSTARI/NSTART
      COMMON/PYJETS/NLU,NPAD,KLU(4000,5),PLU(4000,5),VLU(4000,5)
      COMMON /FELIRE/AMRECD,KJPRO
      COMMON /NEUTYY/NEUTYP,NEUDEC
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
**
**sr mod. for DPMJET: set output flags
      DATA KKCOUN /0/
      DATA CHCOUN /0/
      DATA FICOUN /0/
      DATA TAUCOU /0/

C      IPEV=1

      IF((TAUCOU.EQ.0).AND.((IT.EQ.1).AND.(IP.EQ.1)))THEN
        TAUCOU=TAUCOU+1
	KTAUGE=0
      ENDIF
      IF(IPEV.GE.1)THEN
         WRITE(6,*)'kkinc EPN,NTMASS,NTCHAR,NPMASS,NPCHAR,IDP,KKMAT',
     *        'IDT, NHKKH1,IREJ',
     *        EPN,NTMASS,NTCHAR,NPMASS,NPCHAR,IDP,KKMAT,
     *        IDT, NHKKH1,IREJ
      ENDIF
      IPRI=0
      IREJ=0
C--------------------------------------------------------------------
 1889 CONTINUE
      KKCOUN=KKCOUN+1
      NEVHKK=KKCOUN
C     DO 5371 IOK=1,200
      IF(IPRI.GE.1)WRITE(6,'(A,I5)') ' KKINC: KKCOUN=',KKCOUN
C     WRITE(6,'(A,I5)') ' KKINC: KKCOUN=',KKCOUN
      IF(IPRI.GE.1)WRITE(6,'(A,E20.8)') ' KKINC: EPN=',EPN
C5371 CONTINUE
*---redefine characteristics of the actual interaction
      IF(KKCOUN.EQ.-721.OR.KKCOUN.EQ.-821)THEN
        IOUXVO=IOUXEV
        IOUXEV=6
        IPEVO=IPEV
        IPEV=6
        IPPAO=IPPA
        IPPA=2
        IPCOO=IPCO
        IPCO=6
        INITO=INIT
C       INIT=2
        IPRIO=IPRI
        IPRI=6
        IPHKKO=IPHKK
C       IPHKK=6
      ENDIF
      IF(KKCOUN.EQ.-39.OR.KKCOUN.EQ.-822)THEN
        IOUXEV=IOUXVO
        IPEV=IPEVO
        IPPA=IPPAO
        IPCO=IPCOO
        INIT=INITO
        IPRI=IPRIO
        IPHKK=IPHKKO
      ENDIF
**
**sr mod. for DPMJET: minijet-statist. added
C                        NUMBER of JETS in event
      DO IIII=1,10
        NNMIJE(IIII)=0
      ENDDO
**
      ILOOP = 0
  100 CONTINUE
      IREJ=0
      IREJ1=0
      IF (ILOOP.EQ.40)THEN
	if(ipev.ge.1)WRITE(6,'(A)')'  Rejection after 40 trials'
	IREJ=1
        RETURN
      ENDIF
      ILOOP = ILOOP+1

* re-initialize /NUCC/
      IP  = NPMASS
      IPZ = NPCHAR
      IT  = NTMASS
      ITZ = NTCHAR
      IJPROJ = IDP
      IF(NEUDEC.GE.10)IJPROJ=5
      IF(NSTART.EQ.4.OR.NSTART.EQ.2)IJPROJ=5
      IJTARG = IDT
C     WRITE(6,*)'KKINC IJPROJ,IJTARG ',IJPROJ,IJTARG
      IJTARG=NTMASS
      IBPROJ = IIBAR(IJPROJ)
      IBTARG = IIBAR(IJTARG)

*     *sr mod. for DPMJET: quantum number check added
C     Event Charge and Baryon number
      CHARGI=ITZ
      BARNUI=IT
      IF(IP.GT.1)THEN
         CHARGI=CHARGI+IPZ
         BARNUI=BARNUI+IP
      ELSE
         CHARGI=CHARGI+IICH(IJPROJ)
         BARNUI=BARNUI+IBPROJ
      ENDIF
*     *sr mod. for DPMJET: initialize /EXTEVT/ and /NUCCMS/
      IF(IPEV.GE.1)WRITE(6,*)' before EVTINI call'
      CALL EVTINI(IJPROJ,IP,IT,EPN,PPN,ECM,NHKKH1,1)
      IF(IPEV.GE.1)WRITE(6,*)' after EVTINI call EPN',EPN
*     *

*     calculate nuclear potentials (common /NUCLEA/)
      IF(IPEV.GE.1)WRITE(6,*)' before NCLPOT call'
      IF(IP.GT.1.OR.IT.GT.1)THEN      
         CALL NCLPOT(IPZ,IP,ITZ,IT,ZERO,ZERO,0)
      ENDIF
      IF(IPEV.GE.1)WRITE(6,*)' after NCLPOT call'

*     initialize treatment for residual nuclei
      IF(NSTART.NE.2)THEN
         IF(IPEV.GE.1)WRITE(6,*)' before RESNCL call'
         IF(IP.GT.1.OR.IT.GT.1)THEN      
            CALL RESNCL(EPN,1)
         ENDIF
         IF(IPEV.GE.1)WRITE(6,*)' after RESNCL call EPN',EPN
      ENDIF

*     sample hadron/nucleus-nucleus interaction
*     *sr mod. for DPMJET: parameter list
      IF(IPRI.GE.1)WRITE(6,'(A,2E20.8,2I5)') ' KKINC call KKEVT: ',
     *     EPROJ,PPROJ,KKMAT,IREJ1
C     
      IF(NSTART.EQ.1)THEN
C     h-h, h-A, A-A Collisions
         CALL KKEVT(NHKKH1,EPROJ,PPROJ,KKMAT,IREJ1)
      ELSEIF(NSTART.EQ.2)THEN
C     Neutrino-A Collisions (qeld code)
         CALL KKEVNU(NHKKH1,EPROJ,PPROJ,KKMAT,IREJ1,ECM)
      ELSEIF(NSTART.EQ.3)THEN
C     Diffr Interactions with nuclei
         CALL KKEVDI(NHKKH1,EPROJ,PPROJ,KKMAT,IREJ1)
      ELSEIF(NSTART.EQ.4)THEN
C     Neutrino-A Collisions (lepto code)
         CALL KKEVLE(NHKKH1,EPROJ,PPROJ,KKMAT,IREJ1)
      ENDIF
C     
      IF(IPRI.GE.1)WRITE(6,'(A,2E20.8,2I5)') ' KKINC after KKEVT: ',
     *     EPROJ,PPROJ,KKMAT,IREJ1
C      WRITE(6,'(A)')' KKEVT '
      IF (IREJ1.GT.0)THEN
         WRITE(6,'(A,I5)')' KKEVT Rejection KKCOUN ',KKCOUN
         RETURN
      ENDIF
*     initialize treatment for residual nuclei
      IF(NSTART.EQ.2)THEN
         IF(IPEV.GE.1)WRITE(6,*)' before RESNCL call'
         IF(IP .GT.1.OR.IT.GT.1)THEN      
            CALL RESNCL(EPN,1)
         ENDIF
         IF(IPEV.GE.1)WRITE(6,*)' after RESNCL call EPN',EPN
      ENDIF


*     *sr mod. for DPMJET: special ststistics
C     IF(IPRI.GE.1)THEN
C     DO 7735 IHKK=1,NHKK
C     WRITE(6,1000) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C     +      JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
C     +      (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
C77   35     CONTINUE
C     ENDIF
C     IREJ=0
C     GOTO 100
C     ENDIF
C     IF (IPRI.GE.1.OR.IP.EQ.1)IREJ=0
C     IF (IRESO.EQ.1) CALL DISRES(2,NHKKH1,PPN)
      IF(IEDEN.EQ.0)CALL DECHKK(NHKKH1)
      IF(IPRI.GE.7)THEN
         WRITE(6,'(A)')' from KKINC after DECHKK'
         DO 7835 IHKK=1,NHKK
            WRITE(6,1000) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +           JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +           (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 7835    CONTINUE
      ENDIF
*     *
*     *sr mod. for DPMJET: get some information for fzc
      IF(IPEV.GE.1)WRITE(6,*)' before EVTINI call'
      CALL EVTINI(IJPROJ,IP,IT,EPN,PPN,ECM,NHKKH1,2)
      IF(IPEV.GE.1)WRITE(6,*)' after EVTINI call'
*     *
*     intranuclear cascade of final state particles for KTAUGE generations
*     of secondaries
C     IPEV=1
      IF(IPEV.GE.1)WRITE(6,*)' before FOZOCA call'
      IF(IP .GT.1.OR.IT.GT.1)THEN      
         CALL FOZOCA(LFZC,IREJ1)
      ENDIF
      IF(IPEV.GE.1)WRITE(6,*)' after fozoca LFZC,IREJ1',LFZC,IREJ1
      IF(IPEV.GE.1)WRITE(6,*)' after FOZOCA call'
      IF (IREJ1.GT.0)THEN
         WRITE(6,'(A)')' FOZOCA Rejection'
         RETURN
      ENDIF

*     baryons unable to escape the nuclear potential are treated as
*     excited nucleons (ISTHKK=15,16)
      IF(IPEV.GE.1)WRITE(6,*)' before SCN4BA call'
      IF(IP .GT.1.OR.IT.GT.1)THEN      
         CALL SCN4BA
      ENDIF
      IF(IPEV.GE.1)WRITE(6,*)' after SCN4BA call'

*     decay of resonances produced in intranuclear cascade processes
*     *sr 15-11-95 should be obsolete
      IF (LFZC) CALL DECAY11

*     treatment of residual nuclei
      IF(IPEV.GE.1)WRITE(6,*)' before RESNCL call'
      IF(IP .GT.1.OR.IT.GT.1)THEN      
         CALL RESNCL(EPN,2)
      ENDIF
      IF(IPEV.GE.1)WRITE(6,*)' after RESNCL call'

*     evaporation / fission / fragmentation
*     (if intranuclear cascade was sampled only)
*     *sr mod. for DPMJET: check for IFINAL-flag
      IF ((LFZC).AND.(IFINAL.EQ.0)) THEN
         IF(IPRI.GE.1)THEN
            WRITE(6,'(A)')' from KKINC before FICONF'
            DO 7935 IHKK=1,NHKK
            WRITE(6,1005) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +              JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +              (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
     +              ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
     &              IDBAM(IHKK),IDCH(IHKK)
 1005          FORMAT (I6,I4,5I6,9(1PE10.2)/5I6)
 7935       CONTINUE
         ENDIF
         IF(IPEV.GE.1)WRITE(6,*)' before FICONF call'
         IF(IP .GT.1.OR.IT.GT.1)THEN      
            CALL FICONF(IJPROJ,IP,IPZ,IT,ITZ,IREJ1)
         ENDIF
         IF(IPEV.GE.1)WRITE(6,*)' after FICONF call IREJ1',IREJ1
C-----------------------------------------------------------
C     Write events to file qeld.evt
C-----------------------------------------------------------
         IF (IREJ1.EQ.0.AND.NSTART.EQ.2) THEN
            IIII=0
            IIIMAX = 5
            IF(NEUDEC.EQ.10.OR.NEUDEC.EQ.11)THEN
	       IIIMAX = 7
            ENDIF
            IF(KLU(1,2).EQ.16.OR.KLU(1,2).EQ.-16)THEN 
               IF(NEUDEC.EQ.1.OR.NEUDEC.EQ.2)THEN
                  IIIMAX = 6
               ENDIF
            ENDIF
            DO 266 III=1,IIIMAX
               IF(KLU(III,1).EQ.1.OR.III.LE.2) THEN
                  IIII=IIII+1
                  WRITE(29,'(3I6,5F10.3)')IIII,KLU(III,1),KLU(III,2),
     *                 (PLU(III,KK),KK=1,5)
               ENDIF
 266        CONTINUE
            IIII=-1
            WRITE(29,'(I6)')IIII
	 ENDIF
C-----------------------------------------------------------
         IF (IREJ1.EQ.1) THEN
            FICOUN=FICOUN+1
            IF(FICOUN.LE.20)WRITE(6,'(A)')' FICONF Rejection'
C&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
            IF(NSTART.EQ.3)THEN
               KFORM=2
               IF(KFORM.EQ.1)THEN
                  AABBCC=0.
               ELSEIF(KFORM.EQ.2)THEN
C     the following 3 lines only for 6 (J/psi)
                  READ(29,'(1X,I5)')KREPA
                  READ(29,'(1X,I5)')KREPA
                  READ(29,'(1X,I5)')KREPA
C     
                  READ(29,'(1X,I5)')KREPA
                  DO 1975 KRE=1,KREPA
                     READ(29,'(1X,A)')A109
 1975             CONTINUE
               ENDIF
            ENDIF
C&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&

C     GOTO 100
	 ENDIF
      ENDIF

*     *sr mod. for DPMJET: checks, histograms, ...
      IPHIHI=0
      DO 7501 IHKK=1,NHKKH1
         IF(IDHKK(IHKK).EQ.88888)THEN
C     PPTT=PHKK(1,IHKK)**2+PHKK(2,IHKK)**2
C     IF(PPTT.LE.1.D-12)THEN
C     IPHIHI=1
C     WRITE(6,*)'pt=0 IHKK,IDHKK(IHKK),PHKK(1,IHKK),PHKK(2,IHKK) ',
C     *         IHKK,ISTHKK(IHKK),IDHKK(IHKK),PHKK(1,IHKK),PHKK(2,IHKK)  
C     ENDIF  
            IF(PHKK(5,IHKK).LE.1.D-10)THEN
C     IPHIHI=1
C     WRITE(6,*)'M=0 IHKK,IDHKK(IHKK),PHKK(4,IHKK),PHKK(5,IHKK) ',
C     *          IHKK,ISTHKK(IHKK),IDHKK(IHKK),PHKK(4,IHKK),PHKK(5,IHKK) 
	    ENDIF  
            IF(JMOHKK(1,IHKK).GE.IHKK)THEN
C     IPHIHI=1
C     WRITE(6,*)'MO=0 IHKK,IDHKK(IHKK),PHKK(4,IHKK),PHKK(5,IHKK) ',
C     *  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C     *   PHKK(4,IHKK),PHKK(5,IHKK) 
	    ENDIF  
         ENDIF
 7501 CONTINUE
      DO 501 IHKK=NHKKH1,NHKK
         IF(ISTHKK(IHKK).EQ.1)THEN
            PPTT=PHKK(1,IHKK)**2+PHKK(2,IHKK)**2
            IF(PPTT.LE.1.D-12)THEN
C     IPHIHI=1
C     WRITE(6,*)' pt=0 IHKK,PHKK(1,IHKK),PHKK(2,IHKK) ',
C     *                  IHKK,PHKK(1,IHKK),PHKK(2,IHKK)	      
	    ENDIF  
            IF(JMOHKK(1,IHKK).GE.IHKK)THEN
C     IPHIHI=1
C     WRITE(6,*)'MO=0 IHKK,IDHKK(IHKK),PHKK(4,IHKK),PHKK(5,IHKK) ',
C     *  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C     *   PHKK(4,IHKK),PHKK(5,IHKK) 
	    ENDIF  
            IF(IDHKK(IHKK).EQ.14.OR.IDHKK(IHKK).EQ.-14)THEN
C     IPHIHI=1
C     WRITE(6,*)'14-14IHKK,IDHKK(IHKK),PHKK(4,IHKK),PHKK(5,IHKK) ',
C     *  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C     *   PHKK(4,IHKK),PHKK(5,IHKK) 
	    ENDIF  
         ENDIF
 501  CONTINUE
      IF (IPHIHI.GE.1) THEN
         WRITE(6,'(/A/)') ' KKINC: One particle with pt=0. !!!!'
         IF (IPHKK.GE.-1) THEN
            DO 502 IHKK=1,NHKK
             WRITE(6,1000) IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +              JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +              (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 502        CONTINUE
         ENDIF
      ENDIF
      IF (IPHKK.GE.1) THEN
         WRITE(6,'(/A/)') ' KKINC: FINAL LIST OF ENTRIES TO /HKKEVT/'
         DO 50 IHKK=1,NHKK
            WRITE(6,1000) IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +           JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +           (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 1000       FORMAT (I6,I4,5I6,9(1PE10.2))
 50      CONTINUE
      ENDIF
C     
C     fix KTAUAC later
      KTAUAC=99
      
      IF(IPEV.GE.1)THEN
         WRITE(6,'(A,2F15.5)')' GACMS,BGCMS',GACMS,BGCMS
      ENDIF
C------------------------------------------------------------------
C     Up to here the events (PHKK(J,I)) are in cms
C     transform back to lab for cmhis=0 (lab histograms)
C     
C     But VHKK(J,I) is in Lab frame
C     transform into cms for CMHIS >= 1
C------------------------------------------------------------------
      IF(KKCOUN.LE.-50)THEN
         WRITE(6,*)' Event from dpmjet (only final particles):'
         WRITE(6,*)' before transf. into lab frame '
         DO 7737 IHKK=1,NHKK
            IF((ISTHKK(IHKK).EQ.-1).OR.
     *           (ISTHKK(IHKK).EQ.1).OR.
     *           (ISTHKK(IHKK).EQ.1001))THEN
            WRITE(6,1055) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +              JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +              (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
     +              , (WHKK(KHKK,IHKK),KHKK=1,4)
     +              ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
     &              IDBAM(IHKK),IDCH(IHKK)
            ENDIF
 7737    CONTINUE
      ENDIF
      IF(IPEV.GE.1)WRITE(6,*)' before transf. into lab frame '
      DO 20 I=NHKKH1+1,NHKK
         PZNN=PHKK(3,I)
         ENN =PHKK(4,I)
         ZZZZ=VHKK(3,I)
         TTTT=VHKK(4,I)
         IF (CMHIS.EQ.0.D0)THEN
            IF(ISTHKK(I).NE.16.AND.ISTHKK(I).NE.15)THEN 
               PHKK(3,I) = GACMS*PZNN + BGCMS*ENN
               PHKK(4,I) = GACMS*ENN  + BGCMS*PZNN
C     PHKK(3,I) = GAMCM*PZNN + BGCM*ENN
C     PHKK(4,I) = GAMCM*ENN  + BGCM*PZNN
            ENDIF
         ENDIF
         IF(CMHIS.GE.1.D0)THEN
            VHKK(3,I) = GACMS*ZZZZ - BGCMS*TTTT
            VHKK(4,I) = GACMS*TTTT - BGCMS*ZZZZ
C     VHKK(3,I) = GAMCM*ZZZZ - BGCM*TTTT
C     VHKK(4,I) = GAMCM*TTTT - BGCM*ZZZZ
         ENDIF
         EHECC=SQRT(PHKK(1,I)** 2+ PHKK(2,I)** 2+ PHKK(3,I)** 2+ PHKK
     +        (5,I)**2)
         IF (ABS(EHECC-PHKK(4,I)).GT.0.001) THEN
C     WRITE(6,'(2A/3I5,3E16.6)')
C     &         ' KKINC: CORRECT INCONSISTENT ENERGY ',
C     *         '  IEVCOU, I,IDHKK(I), PHKK(4,I),EHECC, PHKK(5,I)',
C     *            IEVCOU, I,IDHKK(I), PHKK(4,I),EHECC, PHKK(5,I)
            PHKK(4,I)=EHECC
         ENDIF
 20   CONTINUE
      IF(IPEV.GE.1)WRITE(6,*)' after transf. into lab frame '
      IF(IPEV.GE.1)THEN
C     IF ((LFZC).AND.(IFINAL.EQ.0)) THEN
	 IF(IPEV.GE.1) WRITE(6,'(A)')'  before CHECKF'
         DO 7135 IHKK=1,NHKK
            WRITE(6,1055) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +           JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +           (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
     +           , (WHKK(KHKK,IHKK),KHKK=1,4)
     +           ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
     &           IDBAM(IHKK),IDCH(IHKK)
 1055       FORMAT (I6,I4,5I6/7(1PE11.3)/6(1PE11.3)/5I6)
 7135    CONTINUE
C     ENDIF
      ENDIF
      IF(IP.LE.208.AND.NSTART.EQ.1)THEN
         IF ((LFZC).AND.(IFINAL.EQ.0)) THEN
            IF(IPEV.GE.1) WRITE(6,'(A)')'  before CHECKF'
            IF ((CMHIS.EQ.0.D0))
     +           CALL CHECKF(EPROJ,PPROJ,IREJ,1)
         ELSE
            IF ((CMHIS.EQ.0.D0))
     +           CALL CHECKO(EPROJ,PPROJ,IREJ,1)
         ENDIF
      ENDIF
      IF(IREJ.EQ.1)THEN
C     WRITE(6,'(A,I5)')' CHECKF/O IREJ ',IREJ
C     DO 4135 IHKK=1,NHKK
C     WRITE(6,1055) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C     +      JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
C     +      (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
C     +      ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
C     &                IDBAM(IHKK),IDCH(IHKK)
C     4135     CONTINUE
         IF(KKCOUN.LE.1000)THEN
            IF(IPEV.GE.1) WRITE(6,7734)KKCOUN
 7734       FORMAT(' KKCOUN=',I10)
         ENDIF
         IF(IPEV.GE.1)  WRITE(6,'(A)')'  after CHECKF'
         IF(IPRI.GE.1)THEN
            DO 7735 IHKK=1,NHKK
            WRITE(6,1055) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +              JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +              (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
     +              , (WHKK(KHKK,IHKK),KHKK=1,4)
     +              ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
     &              IDBAM(IHKK),IDCH(IHKK)
 7735       CONTINUE
         ENDIF
         IREJ=0
         IF(KKCOUN.LE.500)THEN
            IF(IPRI.GE.1)THEN
               IF ((LFZC).AND.(IFINAL.EQ.0)) THEN
                  WRITE(6,'(A)')' CHECKF Rejection'
               ELSE
                  WRITE(6,'(A)')' CHECKO Rejection'
               ENDIF
            ENDIF
         ENDIF
         GOTO 100
      ENDIF
      IF(NSTART.EQ.4.OR.NSTART.EQ.2)THEN
	 IF(IPEV.GE.1) WRITE(6,'(A)')'  before CHECKN'
         IF ((CMHIS.EQ.0.D0).AND.NEUDEC.NE.20)
     +        CALL CHECKN(EPROJ,PPROJ,IREJ,1)
         IF(KKCOUN.LE.500)THEN
 	    IF(IREJ.EQ.1)WRITE(6,'(A)')' CHECKN Rejection'
C     IREJ=0
         ENDIF
      ENDIF

C&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
C     &                      Writing file diffnuc2.evt for NSTART=3
C     
      IF(NSTART.EQ.3.AND.IREJ.EQ.0)THEN
         KFORM=2
         IF(KFORM.EQ.1)THEN
            AABBCC=0.
         ELSEIF(KFORM.EQ.2.AND.IREJ.EQ.0)THEN
            WRITE(33,'(I6,E12.4)')KJPRO,AMRECD
C     The following only for 6 (J/psi)
            READ(29,'(1X,I5,4E18.10)')IMIST,XXX1,XXX2,XXX3,XXX4
            WRITE(33,'(1X,I5,4E18.10)')IMIST,XXX1,XXX2,XXX3,XXX4
            READ(29,'(1X,I5,4E18.10)')IMIST,XXX1,XXX2,XXX3,XXX4
            READ(29,'(1X,I5,4E18.10)')IMIST,XXX1,XXX2,XXX3,XXX4
C     
            READ(29,'(1X,I5)')KREPA
            WRITE(33,'(1X,I5)')KREPA
            DO 1977 KRE=1,KREPA
               READ(29,'(1X,A)')A109
               WRITE(33,'(1X,A)')A109
 1977       CONTINUE
         ENDIF
         WRITE(33,*)' Event from dpmjet (only final particles):',
     *        'in Nucleus rest frame' 
         DO 1976 IHKK=1,NHKK
            IF((ISTHKK(IHKK).EQ.-1).OR.
     *           (ISTHKK(IHKK).EQ.1).OR.
     *           (ISTHKK(IHKK).EQ.1001))THEN
               WRITE(33,'(2I6,5E18.10,2I6)')  ISTHKK(IHKK),IDHKK(IHKK),
     +              (PHKK(KHKK,IHKK),KHKK=1,5)
     +              ,IDRES(IHKK),IDXRES(IHKK)
            ENDIF
 1976    CONTINUE
      ENDIF
C&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      IF(NSTART.EQ.1)THEN
         IF(IPEV.GE.1)  WRITE(6,'(A)')'  before CHEBCH '
         IF ((CMHIS.EQ.0.D0))THEN
            IF(IP.NE.IT.AND.IT.GT.1)   CALL CHEBCH(IREJ,NHKKH1)
            IF((IREJ.EQ.1))THEN
               CHCOUN=CHCOUN+1
               IF(CHCOUN.LE.-50)THEN
                  WRITE(6,'(A)')' CHEBCH Rejection'
                  WRITE(6,'(A,I5)') ' KKINC: KKCOUN=',KKCOUN
               ENDIF
               GOTO 100
            ENDIF
         ENDIF
         IF(IPEV.GE.1)WRITE(6,'(A)')'after CHEBCH before histograms'
      ENDIF
      IF(NEUDEC.EQ.20)CALL BACKDPM
      SUPX=0.D0
      SUPY=0.D0
      SUPZ=0.D0
      IF(KKCOUN.LE.50.AND.NSTART.GE.2)THEN
         WRITE(6,*)' Event from dpmjet (only final particles):'
         DO 7736 IHKK=1,NHKK
            IF((ISTHKK(IHKK).EQ.-1).OR.
     *           (ISTHKK(IHKK).EQ.1).OR.
     *           (ISTHKK(IHKK).EQ.1001))THEN
               SUPX=SUPX+PHKK(1,IHKK)
               SUPY=SUPY+PHKK(2,IHKK)
               SUPZ=SUPZ+PHKK(3,IHKK)
            WRITE(6,1055) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +              JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +              (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
     +              , (WHKK(KHKK,IHKK),KHKK=1,4)
     +              ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
     &              IDBAM(IHKK),IDCH(IHKK)
            ENDIF
 7736    CONTINUE
         WRITE(6,*)' SUPX,SUPY,SUPZ ',SUPX,SUPY,SUPZ
      ENDIF
C     GB
C     GB     Output from G. Battistoni
C     GB
      IF(NHKK.LE.0) THEN
         WRITE(6,*)' KKINC ', NHKK
         DO JGB = 1,NHKK
            IF(ISTHKK(JGB).EQ.1001)THEN 
               WRITE(6,*)JGB, ISTHKK(JGB),IDHKK(JGB),
     *          JMOHKK(1,JGB),JMOHKK(2,JGB),JDAHKK(1,JGB),JDAHKK(2,JGB),
     *              PHKK(1,JGB),PHKK(2,JGB)
     *              ,PHKK(3,JGB),PHKK(4,JGB),PHKK(5,JGB)
     +          ,IDRES(JGB),IDXRES(JGB),NOBAM(JGB),IDBAM(JGB),IDCH(JGB)
            ENDIF
         END DO
      ENDIF
C     GB
C     
      IF(NSTART.EQ.1)THEN
C     Random azimuthal rotation
C     WRITE(6,*)'      Random azimuthal rotation'
	 CALL DSFECF(SFEE,CFEE)
         DO JGB = 1,NHKK
            XXEE=PHKK(1,JGB)
            YYEE=PHKK(2,JGB)
            PHKK(1,JGB)=XXEE*CFEE-YYEE*SFEE
            PHKK(2,JGB)=XXEE*SFEE+YYEE*CFEE
         END DO
C     WRITE(6,*)' afterRandom azimuthal rotation'
      ENDIF
C     WRITE(6,*)' kkinc ',CMHIS
C     IF(XDIDI.GT.0.1D0)THEN
      IF (CMHIS.EQ.0.D0) CALL DISTR(2,NHKKH1,PPN,KTAUAC)
C     DH   IF (CMHIS.EQ.1.D0) CALL DISTRC(2,NHKKH1,PPN,KTAUAC)
C     DH   IF (CMHIS.EQ.2.D0) CALL DISTCO(2,NHKKH1,PPN,KTAUAC)
C     IF (IPRI.GE.2) CALL CHECKE(EPN,PPN)
C     ENDIF
C-----------
*     *
C     WRITE(6,*)'return KKINC'
      RETURN
      END

**sr mod. for DPMJET: short version of the original DTUNUC-routine
*
*===defaux=============================================================*
*
      SUBROUTINE DEFAUX(EPN,PPN)

************************************************************************
* Variables are set to default values.                                 *
* This version dated 19.11.95 is written by S. Roesler.                *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (ZERO=0.0D0,ONE=1.0D0)

      COMMON /NUCLEA/ PFERMP(2),PFERMN(2),FERMOD,
     &                EBINDP(2),EBINDN(2),EPOT(2,210),
     &                ETACOU(2),ICOUL
      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI

      DATA POTMES /0.002D0/

* common /NUCLEA/
      DO 10 I=1,2
         PFERMP(I) = ZERO
         PFERMN(I) = ZERO
         EBINDP(I) = ZERO
         EBINDN(I) = ZERO
         DO 11 J=1,210
            EPOT(I,J) = ZERO
   11    CONTINUE
* nucleus independent meson potential
         EPOT(I,13) = POTMES
         EPOT(I,14) = POTMES
         EPOT(I,15) = POTMES
         EPOT(I,16) = POTMES
         EPOT(I,23) = POTMES
         EPOT(I,24) = POTMES
         EPOT(I,25) = POTMES
   10 CONTINUE
      FERMOD    = 0.95D0
      ETACOU(1) = ZERO
      ETACOU(2) = ZERO
      ICOUL     = 1

* common /FLAGS/
      IFRAG(1) = 2
      IFRAG(2) = 1
      IRESCO   = 1
      IMSHL    = 1
      IRESRJ   = 0
      LEMCCK   = .TRUE.
      LHADRO(0) = .FALSE.
      DO 13 I=1,9
         LHADRO(I) = .TRUE.
   13 CONTINUE
      LSEADI = .TRUE.

      RETURN
      END
*
*===nclpot=============================================================*
*
      SUBROUTINE NCLPOT(IPZ,IP,ITZ,IT,AFERP,AFERT,MODE)

************************************************************************
* Calculation of Coulomb and nuclear potential for a given configurat. *
*               IPZ, IP       charge/mass number of proj.              *
*               ITZ, IT       charge/mass number of targ.              *
*               AFERP,AFERT   factors modifying proj./target pot.      *
*                             if =0, FERMOD is used                    *
*               MODE = 0      calculation of binding energy            *
*                    = 1      pre-calculated binding energy is used    *
* This version dated 16.11.95  is written by S. Roesler.               *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0,ONE=1.0D0,TINY3=1.0D-3,TINY2=1.0D-2,
     &           TINY10=1.0D-10)

      LOGICAL LSTART

      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR

**sr mod. for DPMJET: use the longer DPMJET one
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     &        ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     &                IPADIS,ISHMAL,LPAULI
**
      COMMON /NUCLEA/ PFERMP(2),PFERMN(2),FERMOD,
     &                EBINDP(2),EBINDN(2),EPOT(2,210),
     &                ETACOU(2),ICOUL
**sr mod. for DPMJET: the corresponding common in DPMJET
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERFAC,ECOU
**

      DIMENSION IDXPOT(14)
*                   ap   an  lam  alam sig- sig+ sig0 tet0 tet- asig-
      DATA IDXPOT /   2,   9,  17,  18,  20,  21,  22,  97,  98,  99,
*                 asig0 asig+ atet0 atet+
     &              100, 101, 102, 103/

      DATA AN     /0.4D0/
      DATA LSTART /.TRUE./

      IF (MODE.EQ.0) THEN
         EBINDP(1) = ZERO
         EBINDN(1) = ZERO
         EBINDP(2) = ZERO
         EBINDN(2) = ZERO
      ENDIF
      AIP  = DBLE(IP)
      AIPZ = DBLE(IPZ)
      AIT  = DBLE(IT)
      AITZ = DBLE(ITZ)

      FERMIP = AFERP
      IF (AFERP.LE.ZERO) FERMIP = FERMOD
      FERMIT = AFERT
      IF (AFERT.LE.ZERO) FERMIT = FERMOD

* Fermi momenta and binding energy for projectile
      IF ((IP.GT.1).AND.(FERMP)) THEN
         IF (MODE.EQ.0) THEN
C           EBINDP(1) = EBIND(IP,IPZ)-EBIND(IP-1,IPZ-1)
C           EBINDN(1) = EBIND(IP,IPZ)-EBIND(IP-1,IPZ)
            BIP  = AIP -ONE
            BIPZ = AIPZ-ONE
            EBINDP(1) = 1.0D-3*ABS(ENERGY(AIP,AIPZ)-ENERGY(BIP,BIPZ))
            EBINDN(1) = 1.0D-3*ABS(ENERGY(AIP,AIPZ)-ENERGY(BIP,AIPZ))
         ENDIF
         PFERMP(1) = FERMIP*AN*(AIPZ/AIP)**0.333333D0
         PFERMN(1) = FERMIP*AN*((AIP-AIPZ)/AIP)**0.33333D0
      ELSE
         PFERMP(1) = ZERO
         PFERMN(1) = ZERO
      ENDIF
* effective nuclear potential for projectile
C     EPOT(1,1) = PFERMP(1)**2/(2.0D0*AAM(1)) + EBINDP(1)
C     EPOT(1,8) = PFERMN(1)**2/(2.0D0*AAM(8)) + EBINDN(1)
      EPOT(1,1) = SQRT(PFERMP(1)**2+AAM(1)**2) -AAM(1) + EBINDP(1)
      EPOT(1,8) = SQRT(PFERMN(1)**2+AAM(8)**2) -AAM(8) + EBINDN(1)

* Fermi momenta and binding energy for target
      IF ((IT.GT.1).AND.(FERMP)) THEN
         IF (MODE.EQ.0) THEN
C           EBINDP(2) = EBIND(IT,ITZ)-EBIND(IT-1,ITZ-1)
C           EBINDN(2) = EBIND(IT,ITZ)-EBIND(IT-1,ITZ)
            BIT  = AIT -ONE
            BITZ = AITZ-ONE
            EBINDP(2) = 1.0D-3*ABS(ENERGY(AIT,AITZ)-ENERGY(BIT,BITZ))
            EBINDN(2) = 1.0D-3*ABS(ENERGY(AIT,AITZ)-ENERGY(BIT,AITZ))
         ENDIF
         PFERMP(2) = FERMIT*AN*(AITZ/AIT)**0.333333D0
         PFERMN(2) = FERMIT*AN*((AIT-AITZ)/AIT)**0.33333D0
      ELSE
         PFERMP(2) = ZERO
         PFERMN(2) = ZERO
      ENDIF
* effective nuclear potential for target
C     EPOT(2,1) = PFERMP(2)**2/(2.0D0*AAM(1)) + EBINDP(2)
C     EPOT(2,8) = PFERMN(2)**2/(2.0D0*AAM(8)) + EBINDN(2)
      EPOT(2,1) = SQRT(PFERMP(2)**2+AAM(1)**2) -AAM(1) + EBINDP(2)
      EPOT(2,8) = SQRT(PFERMN(2)**2+AAM(8)**2) -AAM(8) + EBINDN(2)

      DO 2 I=1,14
         EPOT(1,IDXPOT(I)) = EPOT(1,8)
         EPOT(2,IDXPOT(I)) = EPOT(2,8)
    2 CONTINUE

* Coulomb energy
      ETACOU(1) = ZERO
      ETACOU(2) = ZERO
      IF (ICOUL.EQ.1) THEN
         IF (IP.GT.1)
     &   ETACOU(1) = 0.001116D0*AIPZ/(1.0D0+AIP**0.333D0)
         IF (IT.GT.1)
     &   ETACOU(2) = 0.001116D0*AITZ/(1.0D0+AIT**0.333D0)
      ENDIF

      IF (LSTART) THEN
         IF(IPRI.GE.1)
     *   WRITE(LOUT,1000) IP,IPZ,IT,ITZ,EBINDP,EBINDN,
     &                    EPOT(1,1)-EBINDP(1),EPOT(2,1)-EBINDP(2),
     &                    EPOT(1,8)-EBINDN(1),EPOT(2,8)-EBINDN(2),
     &                    FERMOD,ETACOU
 1000    FORMAT(/,/,1X,'NCLPOT:    quantities for inclusion of nuclear'
     &           ,' effects',/,12X,'---------------------------',
     &           '----------------',/,/,38X,'projectile',
     &           '      target',/,/,1X,'Mass number / charge',
     &           17X,I3,' /',I3,6X,I3,' /',I3,/,1X,'Binding energy  -',
     &           ' proton   (GeV) ',2E14.4,/,17X,'- neutron  (GeV)'
     &          ,1X,2E14.4,/,1X,'Fermi-potential - proton   (GeV)',
     &           1X,2E14.4,/,17X,'- neutron  (GeV) ',2E14.4,/,/,
     &           1X,'Scale factor for Fermi-momentum    ',F4.2,/,
     &           /,1X,'Coulomb-energy ',2(E14.4,' GeV  '),/,/)
         LSTART = .FALSE.
      ENDIF

**sr mod. for DPMJET: fill /NUCIMP/
      PREBNN = ZERO
      PREBPN = ZERO
      PRMFEP = ZERO
      PRMFEN = ZERO
      IF ((IP.GT.1).AND.(FERMP)) THEN
         PREBNN = EBINDN(1)
         PREBPN = EBINDP(1)
         PRMFEP = PFERMP(1)
         PRMFEN = PFERMN(1)
      ENDIF
      PREFEN = PRMFEN**2/(2.*AAM(8))
      PREFEP = PRMFEP**2/(2.*AAM(1))
      PREPOT(1) = PREFEP + PREBPN
      PREPOT(8) = PREFEN + PREBNN
      TAEBNN = ZERO
      TAEBPN = ZERO
      TAMFEP = ZERO
      TAMFEN = ZERO
      IF ((IT.GT.1).AND.(FERMP)) THEN
         TAEBNN = EBINDN(2)
         TAEBPN = EBINDP(2)
         TAMFEP = PFERMP(2)
         TAMFEN = PFERMN(2)
      ENDIF
      TAEFEP = TAMFEP**2/(2.*AAM(1))
      TAEFEN = TAMFEN**2/(2.*AAM(8))
      TAEPOT(1) = TAEFEP + TAEBPN
      TAEPOT(8) = TAEFEN + TAEBNN
      DO 3 I=1,14
         TAEPOT(IDXPOT(I)) = TAEPOT(8)
    3 CONTINUE
      ECOU   = ETACOU(2)
      FERFAC = FERMOD
**

      RETURN
      END
*
*===resncl=============================================================*
*
      SUBROUTINE RESNCL(EPN,MODE)

************************************************************************
* Treatment of residual nuclei and nuclear effects.                    *
*         MODE = 1     initializations                                 *
*              = 2     treatment of final state                        *
* This version dated 16.11.95 is written by S. Roesler.                *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0,ONE=1.0D0,TINY3=1.0D-3,TINY2=1.0D-2,
     &           TINY1=1.0D-1,TINY4=1.0D-4,TINY10=1.0D-10)
      PARAMETER (AMUAMU=0.93149432D0)


      PARAMETER (NMXHKK=49998) 
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      COMMON /NUCLEA/ PFERMP(2),PFERMN(2),FERMOD,
     &                EBINDP(2),EBINDN(2),EPOT(2,210),
     &                ETACOU(2),ICOUL
**sr mod. for DPMJET: use the longer DPMJET one
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     &        ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     &                IPADIS,ISHMAL,LPAULI
**
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
      COMMON /WNDNCL/ NPW,NPW0,NPCW,NTW,NTW0,NTCW
      LOGICAL LRCLPR,LRCLTA
      COMMON /FINSTA/ PINIPR(5),PINITA(5),PRCLPR(5),PRCLTA(5)
     &, LRCLPR,LRCLTA
       COMMON /NSTARI/NSTART
      COMMON /NEUTYY/NEUTYP,NEUDEC
      DIMENSION PFSP(4),PSEC(4),PSEC0(4)

      GOTO (1,2) MODE

*------- initializations
    1 CONTINUE

* initialize arrays for residual nuclei
      DO 10 K=1,5
         IF (K.LE.4) THEN
            PFSP(K)     = ZERO
         ENDIF
         PINIPR(K) = ZERO
         PINITA(K) = ZERO
         PRCLPR(K) = ZERO
         PRCLTA(K) = ZERO
   10 CONTINUE

* projectile in n-n cms
      AIP  = DBLE(IP)
      AIPZ = DBLE(IPZ)
      PINIPR(4) = AIP*UMO/2.0D0
      PINIPR(5) = AIP*AMUAMU+1.0D-3*ENERGY(AIP,AIPZ)
      IF (IP.LE.1) PINIPR(5) = AAM(IJPROJ)
C     WRITE(6,*)PINIPR,'PINIPR,1'
      PINIPR(3) = SQRT((PINIPR(4)-PINIPR(5))*(PINIPR(4)+PINIPR(5)))
* target in n-n cms
      AIT  = DBLE(IT)
      AITZ = DBLE(ITZ)
      PINITA(4) = AIT*UMO/2.0D0
      PINITA(5) = AIT*AMUAMU+1.0D-3*ENERGY(AIT,AITZ)
C     WRITE(6,*)'UMO,PINITA(4),GACMS',UMO,PINITA(4),GACMS
      IF(PINITA(4).LE.PINITA(5))THEN
	PINITA(4)=GACMS*PINITA(5)
C	WRITE(6,*)'UMO,PINITA(4),GACMS',UMO,PINITA(4),GACMS
      ENDIF
      IF(NSTART.EQ.2)THEN
	PINITA(4)=GACMS*PINITA(5)
C	WRITE(6,*)'UMO,PINITA(4),GACMS',UMO,PINITA(4),GACMS
      ENDIF
      IF (IT.LE.1) PINITA(5) = AAM(IJTARG)
C     WRITE(6,*)PINITA,'PINITA,1'
      PINITA(3) = -SQRT((PINITA(4)-PINITA(5))*(PINITA(4)+PINITA(5)))

* correction of projectile 4-momentum for effective target pot.
* and Coulomb-energy (in case of hadron-nucleus interaction only)
      IF ((IP.EQ.1).AND.(IT.GT.1).AND.(FERMP)) THEN
         EPNI = EPN
*   Coulomb-energy:
*     positively charged hadron - check energy for Coloumb pot.
         IF (IICH(IJPROJ).EQ.1) THEN
            THRESH = ETACOU(2)+AAM(IJPROJ)
            IF (EPNI.LE.THRESH) THEN
C              WRITE(LOUT,1000)
 1000          FORMAT(/,1X,'KKINC:  WARNING!  projectile energy',
     &                ' below Coulomb threshold - event rejected',/)
               ISTHKK(1) = 1
               RETURN
            ENDIF
*     negatively charged hadron - increase energy by Coulomb energy
         ELSEIF (IICH(IJPROJ).EQ.-1) THEN
            EPNI = EPNI+ETACOU(2)
         ENDIF
*   Effective target potential
C        EPNI = EPNI+EPOT(2,IJPROJ)
         EBIPOT = EBINDP(2)
         IF ((IJPROJ.NE.1).AND.(ABS(EPOT(2,IJPROJ)).GT.5.0D-3))
     &      EBIPOT = EBINDN(2)
         EPNI = EPNI+ABS(EBIPOT)
* re-initialization of NUCCMS
         DUM1 = ZERO
         DUM2 = ZERO
         IF(NSTART.NE.2.AND.NEUDEC.GE.20)
     &	 CALL LTINI(IJPROJ,EPNI,DUM1,DUM2)
C     COMMON /NEUTYY/NEUTYP,NEUDEC
      ENDIF

      RETURN

*------- treatment of final state
    2 CONTINUE

      JPW  = NPW
      JPCW = NPCW
      JTW  = NTW
      JTCW = NTCW

      DO 20 I=NPOINT(4),NHKK

         IDSEC  = IDBAM(I)

* reduction of particle momentum by corresponding nuclear potential
* (this applies only if Fermi-momenta are requested)

         IF (ISTHKK(I).EQ.1) THEN

C                           skip Photons
	 IF(IDSEC.EQ.7) GO TO 23

            IF (FERMP) THEN

*   select the nucleus which is most likely to be influenced by potential
*   corrections
               IPOT   = 0
               IOTHER = 0
               IF (PHKK(3,I).GE.ZERO) THEN
                  IPOT = 1
                  IF ((IP.LE.1).OR.((IP-NPW).LE.1)) THEN
                     IPOT   = 2
                     IF (IP.GT.1) IOTHER = 1
                     IF ((IT.LE.1).OR.((IT-NTW).LE.1)) GOTO 23
                  ENDIF
               ELSE
                  IPOT = 2
                  IF ((IT.LE.1).OR.((IT-NTW).LE.1)) THEN
                     IPOT   = 1
                     IF (IT.GT.1) IOTHER = 1
                     IF ((IP.LE.1).OR.((IP-NPW).LE.1)) GOTO 23
                  ENDIF
               ENDIF

*   Lorentz-transformation into the rest system of the selected nucleus
               IMODE = -IPOT-1
               CALL LTRANS(PHKK(1,I),PHKK(2,I),PHKK(3,I),PHKK(4,I),
     &                     PSEC(1),PSEC(2),PSEC(3),PSEC(4),IDSEC,IMODE)
               PSECO  = SQRT(PSEC(1)**2+PSEC(2)**2+PSEC(3)**2)
               AMSEC  = SQRT(ABS((PSEC(4)-PSECO)*(PSEC(4)+PSECO)))

               CHKLEV = TINY2
               IF ((EPROJ.GE.1.0D4).AND.(IDSEC.EQ.7)) CHKLEV = TINY1
               IF (EPROJ.GE.2.0D6) CHKLEV = 1.0D0
               IF (ABS(AMSEC-AAM(IDSEC)).GT.CHKLEV) THEN
C                 WRITE(LOUT,2000) I,NEVHKK,IDSEC,AMSEC,AAM(IDSEC)
 2000             FORMAT(1X,'RESNCL: inconsistent mass of particle',
     &                   ' at entry ',I5,' (evt.',I8,')',/,' IDSEC: ',
     &                   I4,'   AMSEC: ',E12.3,'  AAM(IDSEC): ',E12.3,/)
               ENDIF

               DO 21 K=1,4
                  PSEC0(K) = PSEC(K)
   21          CONTINUE

*   the correction for nuclear potential effects is applied to as many  
*   p/n as many nucleons were wounded; the momenta of other final state
*   particles are corrected only if they materialize inside the corresp.
*   nucleus (here: NOBAM = 1 part. outside proj., = 2 part. outside targ
*   = 3 part. outside proj. and targ., >=10 in overlapping region)
               IF ((IDSEC.EQ.1).OR.(IDSEC.EQ.8)) THEN
                  IF (IPOT.EQ.1) THEN
                     IF ((JPW.GT.0).AND.(IOTHER.EQ.0)) THEN
*      this is most likely a wounded nucleon
                        PSEC(4) = PSEC(4)-EPOT(IPOT,IDSEC)
                        JPW = JPW-1
                     ELSE
*      correct only if part. was materialized inside nucleus
*      and if it is ouside the overlapping region
                        IF ((NOBAM(I).NE.1).AND.(NOBAM(I).LT.3))
     &                     PSEC(4) = PSEC(4)-EPOT(IPOT,IDSEC)
                     ENDIF
                  ELSEIF (IPOT.EQ.2) THEN
                     IF ((JTW.GT.0).AND.(IOTHER.EQ.0)) THEN
*      this is most likely a wounded nucleon
                        PSEC(4) = PSEC(4)-EPOT(IPOT,IDSEC)
                        JTW = JTW-1
                     ELSE
*      correct only if part. was materialized inside nucleus
                        IF ((NOBAM(I).NE.2).AND.(NOBAM(I).LT.3))
     &                     PSEC(4) = PSEC(4)-EPOT(IPOT,IDSEC)
                     ENDIF
                  ENDIF
               ELSE
                  IF ((NOBAM(I).NE.IPOT).AND.(NOBAM(I).LT.3))
     &               PSEC(4) = PSEC(4)-EPOT(IPOT,IDSEC)
               ENDIF

* Coulomb energy correction:
* the treatment of Coulomb potential correction is similar to the
* one for nuclear potential
               IF (IDSEC.EQ.1) THEN
                  IF ((IPOT.EQ.1).AND.(JPCW.GT.0)) THEN
                     JPCW = JPCW-1
                  ELSEIF ((IPOT.EQ.2).AND.(JTCW.GT.0)) THEN
                     JTCW = JTCW-1
                  ELSE
                     IF ((NOBAM(I).EQ.IPOT).OR.(NOBAM(I).EQ.3)) GOTO 25
                  ENDIF
               ELSE
                  IF ((NOBAM(I).EQ.IPOT).OR.(NOBAM(I).EQ.3)) GOTO 25
               ENDIF
               IF (IICH(IDSEC).EQ.1) THEN
*    pos. particles: check if they are able to escape Coulomb potential
                  IF (PSEC(4).LT.AMSEC+ETACOU(IPOT)) THEN
                     ISTHKK(I) = 14+IPOT
                     IF (ISTHKK(I).EQ.15) THEN
                        DO 26 K=1,4
                           PHKK(K,I) = PSEC0(K)
                           PRCLPR(K) = PRCLPR(K)+PSEC0(K)
   26                   CONTINUE
                        IF ((IDSEC.EQ.1).OR.(IDSEC.EQ.8)) NPW = NPW-1
                        IF (IDSEC.EQ.1) NPCW = NPCW-1
                     ELSEIF (ISTHKK(I).EQ.16) THEN
                        DO 27 K=1,4
                           PHKK(K,I) = PSEC0(K)
                           PRCLTA(K) = PRCLTA(K)+PSEC0(K)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA16+'
   27                   CONTINUE
                        IF ((IDSEC.EQ.1).OR.(IDSEC.EQ.8)) NTW = NTW-1
                        IF (IDSEC.EQ.1) NTCW = NTCW-1
                     ENDIF
                     GOTO 20
                  ENDIF
               ELSEIF (IICH(IDSEC).EQ.-1) THEN
*    neg. particles: decrease energy by Coulomb-potential
                  PSEC(4) = PSEC(4)-ETACOU(IPOT)
               ENDIF

   25          CONTINUE

               IF (PSEC(4).LT.AMSEC) THEN
C                 WRITE(LOUT,2001) I,IDSEC,PSEC(4),AMSEC
 2001             FORMAT(1X,'KKINC: particle at HKKEVT-pos. ',I5,
     &                   ' is not allowed to escape nucleus',/,
     &                   8X,'id : ',I3,'   reduced energy: ',E15.4,
     &                   '   mass: ',E12.3)
                  ISTHKK(I) = 14+IPOT
                  IF (ISTHKK(I).EQ.15) THEN
                     DO 28 K=1,4
                        PHKK(K,I) = PSEC0(K)
                        PRCLPR(K) = PRCLPR(K)+PSEC0(K)
   28                CONTINUE
                     IF ((IDSEC.EQ.1).OR.(IDSEC.EQ.8)) NPW = NPW-1
                     IF (IDSEC.EQ.1) NPCW = NPCW-1
                  ELSEIF (ISTHKK(I).EQ.16) THEN
                     DO 29 K=1,4
                        PHKK(K,I) = PSEC0(K)
                        PRCLTA(K) = PRCLTA(K)+PSEC0(K)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA16+'
   29                CONTINUE
                     IF ((IDSEC.EQ.1).OR.(IDSEC.EQ.8)) NTW = NTW-1
                     IF (IDSEC.EQ.1) NTCW = NTCW-1
                  ENDIF
                  GOTO 20
               ENDIF

               PSECN  = SQRT( (PSEC(4)-AMSEC)*(PSEC(4)+AMSEC) )
* 4-momentum after correction for nuclear potential
               DO 22 K=1,3
                  PSEC(K) = PSEC(K)*PSECN/PSECO
   22          CONTINUE

* store recoil momentum from particles escaping the nuclear potentials
               DO 30 K=1,4
                  IF (IPOT.EQ.1) THEN
                     PRCLPR(K) = PRCLPR(K)+PSEC0(K)-PSEC(K)
                  ELSEIF (IPOT.EQ.2) THEN
                     PRCLTA(K) = PRCLTA(K)+PSEC0(K)-PSEC(K)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA000'
                  ENDIF
   30          CONTINUE

* transform momentum back into n-n cms
               IMODE = IPOT+1
               CALL LTRANS(PSEC(1),PSEC(2),PSEC(3),PSEC(4),
     &                     PHKK(1,I),PHKK(2,I),PHKK(3,I),PHKK(4,I),
     &                     IDSEC,IMODE)

            ENDIF

   23       CONTINUE
            DO 31 K=1,4
               PFSP(K) = PFSP(K)+PHKK(K,I)
C	       WRITE(6,*)I,K,PHKK(K,I),PFSP(K),'PFSP,2'
   31       CONTINUE

         ENDIF
   20 CONTINUE
C           j.r.4.2.97
C     IF ((IP.EQ.1).AND.(IT.GT.1).AND.(FERMP)) THEN
      IF ((IP.EQ.10001).AND.(IT.GT.1).AND.(FERMP)) THEN
* hadron-nucleus interactions: get residual momentum from energy-
* momentum conservation
         DO 32 K=1,4
            PRCLPR(K) = ZERO
            PRCLTA(K) = PINIPR(K)+PINITA(K)-PFSP(K)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA111'
C	WRITE(6,*)K,PINIPR(K),PINITA(K),PFSP(K),PRCLTA(K),'PRCLTA222'
   32    CONTINUE
      ELSE
* nucleus-hadron, nucleus-nucleus: get residual momentum from 
* accumulated recoil momenta of particles leaving the spectators
*   transform accumulated recoil momenta of residual nuclei into 
*   n-n cms
         PZI = PRCLPR(3)
         PEI = PRCLPR(4)
         CALL LTNUC(PZI,PEI,PRCLPR(3),PRCLPR(4),2)
         PZI = PRCLTA(3)
         PEI = PRCLTA(4)
         CALL LTNUC(PZI,PEI,PRCLTA(3),PRCLTA(4),3)
C        IF (IP.GT.1) THEN
            PRCLPR(3) = PRCLPR(3)+PINIPR(3)
            PRCLPR(4) = PRCLPR(4)+PINIPR(4)
C        ENDIF
         IF (IT.GT.1) THEN
	    KKK=3
C	 WRITE(6,*)KKK,PINITA(3),PRCLTA(KKK),'PRCLTAkkk'
	    KKK=4
C	 WRITE(6,*)KKK,PINITA(4),PRCLTA(KKK),'PRCLTAkkk'
            PRCLTA(3) = PRCLTA(3)+PINITA(3)
	    KKK=3
C       	WRITE(6,*)KKK,PINITA(3),PRCLTA(KKK),'PRCLTAkkk'
            PRCLTA(4) = PRCLTA(4)+PINITA(4)
	    KKK=4
C       	WRITE(6,*)KKK,PINITA(4),PRCLTA(KKK),'PRCLTAkkk'
         ENDIF
      ENDIF

* check momenta of residual nuclei
      IF (LEMCCK) THEN
         CALL EVTEMC(-PINIPR(1),-PINIPR(2),-PINIPR(3),-PINIPR(4),
     &               1,IDUM,IDUM)
         CALL EVTEMC(-PINITA(1),-PINITA(2),-PINITA(3),-PINITA(4),
     &               2,IDUM,IDUM)
         CALL EVTEMC(PRCLPR(1),PRCLPR(2),PRCLPR(3),PRCLPR(4),
     &               2,IDUM,IDUM)
         CALL EVTEMC(PRCLTA(1),PRCLTA(2),PRCLTA(3),PRCLTA(4),
     &               2,IDUM,IDUM)
         CALL EVTEMC(PFSP(1),PFSP(2),PFSP(3),PFSP(4),2,IDUM,IDUM)
         CHKLEV = TINY3
         CALL EVTEMC(DUM,DUM,DUM,CHKLEV,-1,501,IREJ1)
         IF (IREJ1.GT.0) RETURN
      ENDIF

      RETURN
      END
*
*
*===scn4ba=============================================================*
*
      SUBROUTINE SCN4BA

************************************************************************
* SCan /HKKEVT/ 4 BAryons which are not able to escape nuclear pot.    *
* This version dated 12.12.95 is written by S. Roesler.                *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0,ONE=1.0D0,TINY3=1.0D-3,TINY2=1.0D-2,
     &           TINY10=1.0D-10)

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /NUCLEA/ PFERMP(2),PFERMN(2),FERMOD,
     &                EBINDP(2),EBINDN(2),EPOT(2,210),
     &                ETACOU(2),ICOUL
      COMMON /WNDNCL/ NPW,NPW0,NPCW,NTW,NTW0,NTCW
      LOGICAL LRCLPR,LRCLTA
      COMMON /FINSTA/ PINIPR(5),PINITA(5),PRCLPR(5),PRCLTA(5),
     &                LRCLPR,LRCLTA

      DIMENSION PLAB(2,5),PCMS(4)

      IREJ = 0

* get number of wounded nucleons
      NPW    = 0
      NPW0   = 0
      NPCW   = 0
      NPSTCK = 0
      NTW    = 0
      NTW0   = 0
      NTCW   = 0
      NTSTCK = 0

      ISGLPR = 0
      ISGLTA = 0
      LRCLPR = .FALSE.
      LRCLTA = .FALSE.

C     DO 2 I=1,NHKK
      DO 2 I=1,NPOINT(1)
* projectile nucleons wounded in primary interaction and in fzc
         IF ((ISTHKK(I).EQ.11).OR.(ISTHKK(I).EQ.17)) THEN
            NPW    = NPW+1
            NPSTCK = NPSTCK+1
            IF (IDHKK(I).EQ.2212) NPCW = NPCW+1
            IF (ISTHKK(I).EQ.11)  NPW0 = NPW0+1
C           IF (IP.GT.1) THEN
               DO 5 K=1,4
                  PRCLPR(K) = PRCLPR(K)-PHKK(K,I)
    5          CONTINUE
C           ENDIF
* target nucleons wounded in primary interaction and in fzc
         ELSEIF ((ISTHKK(I).EQ.12).OR.(ISTHKK(I).EQ.18)) THEN
            NTW    = NTW+1
            NTSTCK = NTSTCK+1
            IF (IDHKK(I).EQ.2212) NTCW = NTCW+1
            IF (ISTHKK(I).EQ.12)  NTW0 = NTW0+1
            IF (IT.GT.1) THEN
               DO 6 K=1,4
                  PRCLTA(K) = PRCLTA(K)-PHKK(K,I)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA12-'
    6          CONTINUE
            ENDIF
         ELSEIF (ISTHKK(I).EQ.13) THEN
            ISGLPR = I
         ELSEIF (ISTHKK(I).EQ.14) THEN
            ISGLTA = I
         ENDIF
    2 CONTINUE

      DO 11 I=NPOINT(4),NHKK
* baryons which are unable to escape the nuclear potential of proj.
         IF (ISTHKK(I).EQ.15) THEN
            ISGLPR = I
            NPSTCK = NPSTCK-1
            IF (IIBAR(IDBAM(I)).NE.0) THEN
               NPW    = NPW-1
               IF (IICH(IDBAM(I)).GT.0) NPCW = NPCW-1
            ENDIF
            DO 7 K=1,4
               PRCLPR(K) = PRCLPR(K)+PHKK(K,I)
    7       CONTINUE
* baryons which are unable to escape the nuclear potential of targ.
         ELSEIF (ISTHKK(I).EQ.16) THEN
            ISGLTA = I
            NTSTCK = NTSTCK-1
            IF (IIBAR(IDBAM(I)).NE.0) THEN
               NTW    = NTW-1
               IF (IICH(IDBAM(I)).GT.0) NTCW = NTCW-1
            ENDIF
            DO 8 K=1,4
               PRCLTA(K) = PRCLTA(K)+PHKK(K,I)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA16+'
    8       CONTINUE
         ENDIF
   11 CONTINUE

* residual nuclei so far
      IRESP = IP-NPSTCK
      IREST = IT-NTSTCK

* ckeck for "residual nuclei" consisting of one nucleon only
* treat it as final state particle
      IF (IRESP.EQ.1) THEN
         ID  = IDBAM(ISGLPR)
         IST = ISTHKK(ISGLPR)
         CALL LTRANS(PHKK(1,ISGLPR),PHKK(2,ISGLPR),
     &               PHKK(3,ISGLPR),PHKK(4,ISGLPR),
     &               PCMS(1),PCMS(2),PCMS(3),PCMS(4),ID,2)
         IF (IST.EQ.13) THEN
            ISTHKK(ISGLPR) = 11
         ELSE
            ISTHKK(ISGLPR) = 2
         ENDIF
         CALL EVTPUT(1,IDHKK(ISGLPR),ISGLPR,0,
     &               PCMS(1),PCMS(2),PCMS(3),PCMS(4),
     &               IDRES(ISGLPR),IDXRES(ISGLPR),IDCH(ISGLPR))
         NOBAM(NHKK)      = NOBAM(ISGLPR)
         JDAHKK(1,ISGLPR) = NHKK
         DO 21 K=1,4
            PRCLPR(K) = PRCLPR(K)-PHKK(K,ISGLPR)
   21    CONTINUE
      ENDIF
      IF (IREST.EQ.1) THEN
         ID  = IDBAM(ISGLTA)
         IST = ISTHKK(ISGLTA)
         CALL LTRANS(PHKK(1,ISGLTA),PHKK(2,ISGLTA),
     &               PHKK(3,ISGLTA),PHKK(4,ISGLTA),
     &               PCMS(1),PCMS(2),PCMS(3),PCMS(4),ID,3)
         IF (IST.EQ.14) THEN
            ISTHKK(ISGLTA) = 12
         ELSE
            ISTHKK(ISGLTA) = 2
         ENDIF
         CALL EVTPUT(1,IDHKK(ISGLTA),ISGLTA,0,
     &               PCMS(1),PCMS(2),PCMS(3),PCMS(4),
     &               IDRES(ISGLTA),IDXRES(ISGLTA),IDCH(ISGLTA))
         NOBAM(NHKK)      = NOBAM(ISGLTA)
         JDAHKK(1,ISGLTA) = NHKK
         DO 22 K=1,4
            PRCLTA(K) = PRCLTA(K)-PHKK(K,ISGLTA)
C		WRITE(6,*)ISGLTA,K,PHKK(K,ISGLTA),PRCLTA(K),'PRCLTA12-'
   22    CONTINUE
      ENDIF

* get nuclear potential corresp. to the residual nucleus
      IPRCL  = IP -NPW
      IPZRCL = IPZ-NPCW
      ITRCL  = IT -NTW
      ITZRCL = ITZ-NTCW
      CALL NCLPOT(IPZRCL,IPRCL,ITZRCL,ITRCL,ZERO,ZERO,1)

* baryons unable to escape the nuclear potential are treated as
* excited nucleons (ISTHKK=15,16)
      DO 3 I=NPOINT(4),NHKK
         IF (ISTHKK(I).EQ.1) THEN
            ID  = IDBAM(I)
            IF ( ((ID.EQ.1).OR.(ID.EQ.8)).AND.(NOBAM(I).NE.3) ) THEN
*   final state n and p not being outside of both nuclei are considered
               NPOTP = 1
               NPOTT = 1
               IF ( (IP.GT.1)      .AND.(IRESP.GT.1).AND.
     &              (NOBAM(I).NE.1).AND.(NPW.GT.0)        ) THEN
*     Lorentz-trsf. into proj. rest sys. for those being inside proj.
                  CALL LTRANS(PHKK(1,I),PHKK(2,I),PHKK(3,I),PHKK(4,I),
     &                        PLAB(1,1),PLAB(1,2),PLAB(1,3),PLAB(1,4),
     &                                                          ID,-2)
                  PLABT = SQRT(PLAB(1,1)**2+PLAB(1,2)**2+PLAB(1,3)**2)
                  PLAB(1,5) = SQRT(ABS( (PLAB(1,4)-PLABT)*
     &                                  (PLAB(1,4)+PLABT) ))
                  EKIN = PLAB(1,4)-PLAB(1,5)
                  IF (EKIN.LE.EPOT(1,ID)) NPOTP = 15
                  IF ((ID.EQ.1).AND.(NPCW.LE.0)) NPOTP = 1
               ENDIF
               IF ( (IT.GT.1)      .AND.(IREST.GT.1).AND.
     &              (NOBAM(I).NE.2).AND.(NTW.GT.0)        ) THEN
*     Lorentz-trsf. into targ. rest sys. for those being inside targ.
                  CALL LTRANS(PHKK(1,I),PHKK(2,I),PHKK(3,I),PHKK(4,I),
     &                        PLAB(2,1),PLAB(2,2),PLAB(2,3),PLAB(2,4),
     &                                                          ID,-3)
                  PLABT = SQRT(PLAB(2,1)**2+PLAB(2,2)**2+PLAB(2,3)**2)
                  PLAB(2,5) = SQRT(ABS( (PLAB(2,4)-PLABT)*
     &                                  (PLAB(2,4)+PLABT) ))
                  EKIN = PLAB(2,4)-PLAB(2,5)
                  IF (EKIN.LE.EPOT(2,ID)) NPOTT = 16
                  IF ((ID.EQ.1).AND.(NTCW.LE.0)) NPOTT = 1
               ENDIF
               IF (PHKK(3,I).GE.ZERO) THEN
                  ISTHKK(I) = NPOTT
                  IF (NPOTP.NE.1) ISTHKK(I) = NPOTP
               ELSE
                  ISTHKK(I) = NPOTP
                  IF (NPOTT.NE.1) ISTHKK(I) = NPOTT
               ENDIF
               IF (ISTHKK(I).NE.1) THEN
                  J = ISTHKK(I)-14
                  DO 4 K=1,5
                     PHKK(K,I) = PLAB(J,K)
    4             CONTINUE
                  IF (ISTHKK(I).EQ.15) THEN
                     NPW = NPW-1
                     IF (ID.EQ.1) NPCW = NPCW-1
                     DO 9 K=1,4
                        PRCLPR(K) = PRCLPR(K)+PHKK(K,I)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLPR(K),'PRCLPR'
    9                CONTINUE
                  ELSEIF (ISTHKK(I).EQ.16) THEN
                     NTW = NTW-1
                     IF (ID.EQ.1) NTCW = NTCW-1
                     DO 10 K=1,4
                        PRCLTA(K) = PRCLTA(K)+PHKK(K,I)
C			WRITE(6,*)I,K,PHKK(K,I),PRCLTA(K),'PRCLTA16+'
   10                CONTINUE
                  ENDIF
               ENDIF
            ENDIF
         ENDIF
    3 CONTINUE

* again: get nuclear potential corresp. to the residual nucleus
      IPRCL  = IP -NPW
      IPZRCL = IPZ-NPCW
      ITRCL  = IT -NTW
      ITZRCL = ITZ-NTCW
      AFERP  = FERMOD+0.1D0
      AFERT  = FERMOD+0.1D0
      CALL NCLPOT(IPZRCL,IPRCL,ITZRCL,ITRCL,AFERP,AFERT,1)


      RETURN
      END
*
*
*===ficonf=============================================================*
*
      SUBROUTINE FICONF(IJPROJ,IP,IPZ,IT,ITZ,IREJ)

************************************************************************
* Treatment of FInal CONFiguration including evaporation, fission and  *
* Fermi-break-up (for light nuclei only).                              *
* Adopted from the original routine FINALE and extended to residual    *
* projectile nuclei.                                                   *
* This version dated 12.12.95 is written by S. Roesler.                *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0,ONE=1.0D0,TINY3=1.0D-3,TINY10=1.0D-10)

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      COMMON /RJCOUN/ IRPT,IRHHA,IRRES(2),LOMRES,LOBRES,
     &                IRCHKI(2),IRFRAG,IRCRON(3),IREVT,
     &                IREXCI(3),IRDIFF(2),IRINC
      COMMON /ZENTRA/ ICENTR
      COMMON /OUTLEV/IOUTPO,IOUTPA,IOUXEV,IOUCOL
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)
      LOGICAL LRCLPR,LRCLTA
      COMMON /FINSTA/ PINIPR(5),PINITA(5),PRCLPR(5),PRCLTA(5),
     &                LRCLPR,LRCLTA
      COMMON /EXCITA/ AMRCL0(2),EEXC(2),EEXCFI(2),
     &                NTOT(2),NPRO(2),NN(2),NH(2),NHPOS(2),NQ(2),
     &                NTOTFI(2),NPROFI(2)
      COMMON /STFICO/ EXCDPM(4),EXCEVA(2),
     &                NINCGE,NINCCO(2,3),NINCHR(2,2),NINCWO(2),
     &                NINCST(2,4),NINCEV(2),
     &                NRESTO(2),NRESPR(2),NRESNU(2),NRESBA(2),
     &                NRESPB(2),NRESCH(2),NRESEV(4),
     &                NEVA(2,6),NEVAGA(2),NEVAHT(2),NEVAHY(2,2,240),
     &                NEVAFI(2,2)
* evaporation interface
      PARAMETER (ANGLGB=5.0D-16)
      PARAMETER (AMUAMU=0.93149432D0,AMELEC=0.51099906D-3)
      PARAMETER (MXP=999)
      COMMON /FINUC/  CXR (MXP), CYR (MXP), CZR (MXP), TKI (MXP),
     &                PLR (MXP), WEI (MXP), TV, TVCMS, TVRECL, TVHEAV,
     &                TVBIND, NP0, NP, KPART (MXP)
      LOGICAL LRNFSS, LFRAGM
      COMMON /RESNUC/  AMNTAR, AMMTAR, AMNZM1, AMMZM1, AMNNM1, AMMNM1,
     &                   ANOW,   ZNOW, ANCOLL, ZNCOLL, AMMLFT, AMNLFT,
     &                   ERES,  EKRES, AMNRES, AMMRES,  PTRES,  PXRES,
     &                  PYRES,  PZRES, PTRES2,  KTARP,  KTARN, IGREYP,
     &                 IGREYN,  ICRES,  IBRES, ISTRES, IEVAPL, IEVAPH,
     &                 IEVNEU, IEVPRO, IEVDEU, IEVTRI, IEV3HE, IEV4HE,
     &                 IDEEXG,  IBTAR, ICHTAR, IBLEFT, ICLEFT, IOTHER,
     &                 LRNFSS, LFRAGM
      COMMON /NUCDAT/ AV0WEL,     APFRMX,     AEFRMX,     AEFRMA,
     &                RDSNUC,     V0WELL (2), PFRMMX (2), EFRMMX (2),
     &                EFRMAV (2), AMNUCL (2), AMNUSQ (2), EBNDNG (2),
     &                VEFFNU (2), ESLOPE (2), PKMNNU (2), EKMNNU (2),
     &                PKMXNU (2), EKMXNU (2), EKMNAV (2), EKINAV (2),
     &                EXMNAV (2), EKUPNU (2), EXMNNU (2), EXUPNU (2),
     &                ERCLAV (2), ESWELL (2), FINCUP (2), AMRCAV    ,
     &                AMRCSQ    , ATO1O3    , ZTO1O3    , ELBNDE (0:100)
      LOGICAL LDIFFR, LINCTV, LEVPRT, LHEAVY, LDEEXG, LGDHPR, LPREEX,
     &        LHLFIX, LPRFIX, LPARWV, LPOWER, LSNGCH, LLVMOD, LSCHDF
      PARAMETER ( NALLWP = 39   )
      COMMON / PAREVT / DPOWER, FSPRD0, FSHPFN, RN1GSC, RN2GSC,
     &                  LDIFFR (NALLWP),LPOWER, LINCTV, LEVPRT, LHEAVY,
     &                  LDEEXG, LGDHPR, LPREEX, LHLFIX, LPRFIX, LPARWV,
     &                  ILVMOD, JLVMOD, LLVMOD, LSNGCH, LSCHDF

      DIMENSION INUC(2),IDXPAR(2),IDPAR(2),AIF(2),AIZF(2),AMRCL(2),
     &          PRCL(2,4),MO1(2),MO2(2),VRCL(2,4),WRCL(2,4),
     &          P1IN(4),P2IN(4),P1OUT(4),P2OUT(4)
      COMMON/REJFBK/IREJFR
      COMMON /NEUTYY/NEUTYP,NEUDEC

      DIMENSION EXPNUC(2),EXC(2,210),NEXC(2,210)
      DATA EXC,NEXC /420*ZERO,420*0/
      DATA EXPNUC /4.0D-3,4.0D-3/
      DATA INIEX/0/
      DATA INIWA/0/

      IREJ   = 0
      LRCLPR = .FALSE.
      LRCLTA = .FALSE.

* skip residual nucleus treatment if not requested or in case
* of central collisions
      IF(IPEV.GE.1)WRITE(6,*)' FICONF: LEVPRT ICENTR',LEVPRT,ICENTR
C     IF ((.NOT.LEVPRT).OR.(ICENTR.NE.0)) RETURN
C                          jr.19.5.96 also for central coll.
      IF ((.NOT.LEVPRT)) RETURN

      DO 1 K=1,2
         IDPAR(K) = 0
         IDXPAR(K)= 0
         NTOT(K)  = 0
         NTOTFI(K)= 0
         NPRO(K)  = 0
         NPROFI(K)= 0
         NN(K)    = 0
         NH(K)    = 0
         NHPOS(K) = 0
         NQ(K)    = 0
         EEXC(K)  = ZERO
         MO1(K)   = 0
         MO2(K)   = 0
         DO 2 I=1,4
            VRCL(K,I) = ZERO
            WRCL(K,I) = ZERO
    2    CONTINUE
    1 CONTINUE
      NFSP = 0
      INUC(1) = IP
      INUC(2) = IT

      DO 3 I=1,NHKK

* number of final state particles
         IF (ABS(ISTHKK(I)).EQ.1) THEN
            NFSP  = NFSP+1
            IDFSP = IDBAM(I)
         ENDIF

* properties of remaining nucleon configurations
         KF = 0
         IF ((ISTHKK(I).EQ.13).OR.(ISTHKK(I).EQ.15)) KF = 1
         IF ((ISTHKK(I).EQ.14).OR.(ISTHKK(I).EQ.16)) KF = 2
         IF (KF.GT.0) THEN
            IF (MO1(KF).EQ.0) MO1(KF) = I
            MO2(KF)  = I
*   position of residual nucleus = average position of nucleons
            DO 4 K=1,4
               VRCL(KF,K) = VRCL(KF,K)+VHKK(K,I)
               WRCL(KF,K) = WRCL(KF,K)+WHKK(K,I)
    4       CONTINUE
*   total number of particles contributing to each residual nucleus
            NTOT(KF)  = NTOT(KF)+1
            IDTMP     = IDBAM(I)
            IDXTMP    = I
*   total charge of residual nuclei
            NQ(KF) = NQ(KF)+IICH(IDTMP)
*   number of protons
            IF (IDHKK(I).EQ.2212) THEN
               NPRO(KF) = NPRO(KF)+1
*   number of neutrons
            ELSEIF (IDHKK(I).EQ.2112) THEN
               NN(KF) = NN(KF)+1
            ELSE
*   number of baryons other than n, p
               IF (IIBAR(IDTMP).EQ.1) THEN
                  NH(KF) = NH(KF)+1
                  IF (IICH(IDTMP).EQ.1) NHPOS(KF) = NHPOS(KF)+1
               ELSE
*   any other mesons (status set to 1)
                  INIWA=INIWA+1
                  IF(INIWA.LE.-20)WRITE(LOUT,1002) KF,IDTMP
 1002             FORMAT(1X,'FICONF:   residual nucleus ',I2,
     &                   ' containing meson ',I4,', status set to 1')
                  ISTHKK(I) = 1
                  IDTMP     = IDPAR(KF)
                  IDXTMP    = IDXPAR(KF)
                  NTOT(KF)  = NTOT(KF)-1
               ENDIF
            ENDIF
            IDPAR(KF)  = IDTMP
            IDXPAR(KF) = IDXTMP
         ENDIF
    3 CONTINUE

* reject elastic events (def: one final state particle = projectile)
      IF ((IP.EQ.1).AND.(NFSP.EQ.1).AND.(IDFSP.EQ.IJPROJ)) THEN
                  WRITE(LOUT,1009) 
 1009             FORMAT(1X,'FICONF: ct elastic events ')
         IREXCI(3) = IREXCI(3)+1
	 IREJ=1
         RETURN
      ENDIF

* check if one nucleus disappeared..
C     IF ((IP.GT.1).AND.(NTOT(1).EQ.0).AND.(NTOT(2).NE.0)) THEN
C        DO 5 K=1,4
C           PRCLTA(K) = PRCLTA(K)+PRCLPR(K)
C           PRCLPR(K) = ZERO
C   5    CONTINUE
C     ELSEIF ((IT.GT.1).AND.(NTOT(2).EQ.0).AND.(NTOT(1).NE.0)) THEN
C        DO 6 K=1,4
C           PRCLPR(K) = PRCLPR(K)+PRCLTA(K)
C           PRCLTA(K) = ZERO
C   6    CONTINUE
C     ENDIF

      ICOR   = 0
      INORCL = 0
      DO 7 I=1,2
         DO 8 K=1,4
* get the average of the nucleon positions
            VRCL(I,K) = VRCL(I,K)/MAX(NTOT(I),1)
            WRCL(I,K) = WRCL(I,K)/MAX(NTOT(I),1)
            IF (I.EQ.1) PRCL(1,K) = PRCLPR(K)
            IF (I.EQ.2) PRCL(2,K) = PRCLTA(K)
    8    CONTINUE
       IF(IPEV.GE.1)WRITE(6,*)PRCL,'PRCL(2,4)'
       IF(IPEV.GE.1)WRITE(6,*)PRCLTA,'PRCLTA'
* mass number and charge of residual nuclei
         AIF(I)  = DBLE(NTOT(I))
         AIZF(I) = DBLE(NPRO(I)+NHPOS(I))
         IF(IPEV.GE.1)WRITE(6,*)'I,Ntot(i)',I,NTOT(I),AIF(I),AIZF(I)
         IF (NTOT(I).GT.1) THEN
* masses of residual nuclei in ground state
            AMRCL0(I) = AIF(I)*AMUAMU+1.0D-3*ENERGY(AIF(I),AIZF(I))
* masses of residual nuclei
            PTORCL   = SQRT(PRCL(I,1)**2+PRCL(I,2)**2+PRCL(I,3)**2)
            AMRCL(I) = (PRCL(I,4)-PTORCL)*(PRCL(I,4)+PTORCL)
            IF (AMRCL(I).GT.ZERO) AMRCL(I) = SQRT(AMRCL(I))
 	   IF(IPEV.GE.1) WRITE(6,*)AMRCL(I),'AMRCL(',I,')'
C                      Patch 5.2.98
            IF ((AMRCL(I).LT.AMRCL0(I)).AND.(NEUDEC.EQ.20))
     &	    AMRCL(I)=AMRCL0(I)+0.025D0
            IF (AMRCL(I).LE.ZERO) THEN
	       INIEX=INIEX+1
	       IF(INIEX.LE.-50)
     &         WRITE(LOUT,1000) I,PRCL(I,1),PRCL(I,2),PRCL(I,3),
     &                          PRCL(I,4),AMRCL(I),NTOT
 1000          FORMAT(1X,'warning! negative excitation energy',/,
     &                I4,5E15.4,2I4)
               AMRCL(I) = ZERO
               EEXC(I)  = ZERO
               GOTO 9999
            ELSEIF ((AMRCL(I).GT.ZERO).AND.(AMRCL(I).LT.AMRCL0(I)))
     &                                                         THEN
               EEXC(I)  = AMRCL(I)-AMRCL0(I)
C	       WRITE(6,*)I,EEXC(I),AMRCL(I),AMRCL0(I),'EEXC(I)0'
**sr 11.6.96
C              AMRCL(I) = AMRCL0(I)+EXPNUC(I)*DBLE(NTOT(I))
               M = MIN(NTOT(I),210)
               IF (NEXC(I,M).GT.0) THEN
                  AMRCL(I) = AMRCL0(I)+EXC(I,M)/DBLE(NEXC(I,M))
               ELSE
   70             CONTINUE
                  M = M+1
                  IF (M.GE.INUC(I)) THEN
                     AMRCL(I) = AMRCL0(I)+EXPNUC(I)*DBLE(NTOT(I))
                  ELSE
                     IF (NEXC(I,M).GT.0) THEN
                        AMRCL(I) = AMRCL0(I)+EXC(I,M)/DBLE(NEXC(I,M))
                     ELSE
                        GOTO 70
                     ENDIF
                  ENDIF
               ENDIF
**
               EEXC(I)  = AMRCL(I)-AMRCL0(I)
	       IF(IPEV.GE.1)THEN
 	       WRITE(6,*)I,EEXC(I),AMRCL(I),AMRCL0(I),'EEXC(I)1'
	       ENDIF
               IF ((AMRCL(I).GT.ZERO).AND.(AMRCL(I).LT.AMRCL0(I)))
     &                                                         THEN
                 ICOR     = ICOR+I
               ENDIF
C                  insert 4.2.98
               EXPNUC(I) = EEXC(I)/MAX(1,INUC(I)-NTOT(I))
**sr 11.6.96
               M = MIN(NTOT(I),210)
               EXC(I,M)  = EXC(I,M)+EEXC(I)
               NEXC(I,M) = NEXC(I,M)+1
C                  insert 4.2.98
            ELSE
* excitation energies of residual nuclei
               EEXC(I)   = AMRCL(I)-AMRCL0(I)
	       IF(IPEV.GE.1)THEN
 	       WRITE(6,*)I,EEXC(I),AMRCL(I),AMRCL0(I),'EEXC(I)2'
	       ENDIF
               EXPNUC(I) = EEXC(I)/MAX(1,INUC(I)-NTOT(I))
**sr 11.6.96
               M = MIN(NTOT(I),210)
               EXC(I,M)  = EXC(I,M)+EEXC(I)
               NEXC(I,M) = NEXC(I,M)+1
**
            ENDIF
         ELSEIF (NTOT(I).EQ.1) THEN
            WRITE(LOUT,1003) I
 1003       FORMAT(1X,'FICONF:   warning! NTOT(I)=1? (I=',I3,')')
            GOTO 9999
         ELSE
            AMRCL0(I) = ZERO
            AMRCL(I)  = ZERO
            EEXC(I)   = ZERO
            INORCL    = INORCL+I
	    IF(IPEV.GE.1)WRITE(6,*)' INORCL,I',INORCL,I
         ENDIF
	       IF(IPEV.GE.1)THEN
 	 WRITE (6,'(A,I10,3F10.3)')' I,AIF,AIZF,EEXC:'
     *,I,AIF(I),AIZF(I),EEXC(I)
         ENDIF
    7 CONTINUE

      PRCLPR(5) = AMRCL(1)
      PRCLTA(5) = AMRCL(2)
      IF(IPEV.GE.1)WRITE(6,*)' ICOR,INORCL ',ICOR,INORCL
      IF (ICOR.GT.0) THEN
        IF (INORCL.EQ.0) THEN
* one or both residual nuclei consist of one nucleon only, transform
* this nucleon on mass shell
          DO 9 K=1,4
            P1IN(K) = PRCL(1,K)
            P2IN(K) = PRCL(2,K)
    9     CONTINUE
          XM1 = AMRCL(1)
          XM2 = AMRCL(2)
          CALL MASHEL(P1IN,P2IN,XM1,XM2,P1OUT,P2OUT,IREJ1)
          IF (IREJ1.GT.0)THEN 
            WRITE(6,'(A)')' FICONF MASHEL rejection'
	    GOTO 9999
          ENDIF
          DO 10 K=1,4
            PRCL(1,K) = P1OUT(K)
            PRCL(2,K) = P2OUT(K)
            PRCLPR(K) = P1OUT(K)
            PRCLTA(K) = P2OUT(K)
   10     CONTINUE
          PRCLPR(5) = AMRCL(1)
          PRCLTA(5) = AMRCL(2)
        ELSE
**sr mod. for DPMJET: IOULEV not available here
          IF(IPEV.GE.1)THEN
	    WRITE(6,'(A)')' from  FICONF'
            DO 7935 IHKK=1,NHKK
            WRITE(6,1005) IHKK, ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +      JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +      (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
     +      ,IDRES(IHKK),IDXRES(IHKK),NOBAM(IHKK),
     &      IDBAM(IHKK),IDCH(IHKK)
 1005       FORMAT (I6,I4,5I6,9(1PE10.2)/5I6)
 7935       CONTINUE
          ENDIF
          IF(IPEV.GE.1)THEN
            WRITE(LOUT,1001) NEVHKK,INT(AIF(1)),INT(AIZF(1)),
     &                       INT(AIF(2)),INT(AIZF(2)),AMRCL0(1),
     &                       AMRCL(1),AMRCL(1)-AMRCL0(1),AMRCL0(2),
     &                       AMRCL(2),AMRCL(2)-AMRCL0(2)
 1001       FORMAT(1X,'FICONF:   warning! no residual nucleus for',
     &             ' correction',/,11X,'at event',I6,
     &             ',  nucleon config. 1:',2I4,' 2:',2I4,
     &             2(/,11X,3E12.3))
          ENDIF
          GOTO 9998
        ENDIF
      ENDIF

* update counter
      IF (NRESEV(1).NE.NEVHKK) THEN
         NRESEV(1) = NEVHKK
         NRESEV(2) = NRESEV(2)+1
      ENDIF
      DO 15 I=1,2
         EXCDPM(I)   = EXCDPM(I)+EEXC(I)
         EXCDPM(I+2) = EXCDPM(I+2)+(EEXC(I)/MAX(NTOT(I),1))
         NRESTO(I) = NRESTO(I)+NTOT(I)
         NRESPR(I) = NRESPR(I)+NPRO(I)
         NRESNU(I) = NRESNU(I)+NN(I)
         NRESBA(I) = NRESBA(I)+NH(I)
         NRESPB(I) = NRESPB(I)+NHPOS(I)
         NRESCH(I) = NRESCH(I)+NQ(I)
   15 CONTINUE

* evaporation
      IF (LEVPRT) THEN
         DO 13 I=1,2
* initialize evaporation counter
            NP = 0
            EEXCFI(I) = ZERO
            IF ((INUC(I).GT.1).AND.(AIF(I).GT.ONE).AND.
     &          (EEXC(I).GT.ZERO)) THEN
* put residual nuclei into HKKEVT
               IDRCL = 80000
               JMASS = INT( AIF(I))
               JCHAR = INT(AIZF(I))
               CALL EVTPUT(1000,IDRCL,MO1(I),MO2(I),PRCL(I,1),
     &              PRCL(I,2),PRCL(I,3),PRCL(I,4),JMASS,JCHAR,0)
       IF(IPEV.GE.1)WRITE(6,*)PRCL,'PRCL(2,4),EVTPUT'
               DO 14 J=1,4
                  VHKK(J,NHKK) = VRCL(I,J)
                  WHKK(J,NHKK) = WRCL(I,J)
   14          CONTINUE
*  interface to evaporation module - fill final residual nucleus into
*  common RESNUC
               PXRES  = PRCL(I,1)
               PYRES  = PRCL(I,2)
               PZRES  = PRCL(I,3)
C                                              j.r.4.2.97
	       ERES   = PRCL(I,4)
C                                              j.r.4.2.97
               IBRES  = NPRO(I)+NN(I)+NH(I)
               ICRES  = NPRO(I)+NHPOS(I)
               ANOW   = DBLE(IBRES)
               ZNOW   = DBLE(ICRES)
               PTRES  = SQRT(PXRES**2+PYRES**2+PZRES**2)
      IF(IPEV.GE.1)WRITE(6,*)PXRES,PYRES,PZRES,ERES,'FICONF1'
*   ground state mass of the residual nucleus (should be equal to AM0T)
               AMMRES = AMRCL0(I)
               AMNRES = AMMRES-ZNOW*AMELEC+ELBNDE(ICRES)
*  common FINUC
               TV = ZERO
*   kinetic energy of residual nucleus
               TVRECL = PRCL(I,4)-AMRCL(I)
C	       WRITE(6,*)TVRECL, PRCL(I,4),AMRCL(I),'TVRECL'
*   excitation energy of residual nucleus
C                                j.r.16.1.96
               DPMEXM=0.5 
C              TVCMS  = EEXC(I)*DPMEXM
               TVCMS  = EEXC(I)
C	       WRITE(6,*)TVCMS,'TVCMS'
               PTOLD  = PTRES
C                           4.2.98
               PTRES  = SQRT(TVRECL*(TVRECL+2.0D0*(AMMRES+TVCMS)))
               IF (PTOLD.LT.ANGLGB) THEN
                  CALL RACO (PXRES,PYRES,PZRES)
      IF(IPEV.GE.1)WRITE(6,*)PXRES,PYRES,PZRES,ERES,'FICONF2'
                  PTOLD = ONE
               ENDIF
               PXRES = PXRES*PTRES/PTOLD
               PYRES = PYRES*PTRES/PTOLD
               PZRES = PZRES*PTRES/PTOLD
      IF(IPEV.GE.1)WRITE(6,*)PTRES,PTOLD,'FICONF3'
      IF(IPEV.GE.1)WRITE(6,*)PXRES,PYRES,PZRES,ERES,'FICONF3'
* evaporation
	       WE = ONE
C		 WRITE(6,'(A,2F10.2,2I5)')' FRMBRK bef. EVEVAP',
C    *		 ANOW,ZNOW,IBRES,ICRES
		 ANOWW=ANOW
		 ZNOWW=ZNOW
		 IBRESS=IBRES
		 ICRESS=ICRES
		 IREJFR=0
C		 WRITE(6,*)' before EVEVAP, WE',WE
               CALL EVEVAP (WE)
C		 WRITE(6,*)' after EVEVAP , WE',WE
	       IF(IREJFR.EQ.1)THEN
		 WRITE(6,'(A,2F10.2,2I5)')' FRMBRK rej.',
     *		 ANOWW,ZNOWW,IBRESS,ICRESS
		 GO TO 9998
	       ENDIF
* put evaporated particles and residual nuclei to HKKEVT
               MO = NHKK
 	       IF(IPEV.GE.1)WRITE(6,*)EXCITF,'EXITF before EVA2HE'
               CALL EVA2HE(MO,EXCITF,I,IREJ1)
 	       IF(IPEV.GE.1)WRITE(6,*)EXCITF,'EXITF after EVA2HE'
	       IF(IREJ1.GE.1)WRITE(6,'(A)')' FICONF EVA2HE '
               EEXCFI(I) = EXCITF
               EXCEVA(I) = EXCEVA(I)+EXCITF
            ENDIF
   13    CONTINUE
      ENDIF
      IF(IPEV.GE.1)WRITE(6,'(A,I5)')' FICONF RETURN IREJ ',IREJ

      RETURN

 9998 IREXCI(1) = IREXCI(1)+1
 9999 CONTINUE
      LRCLPR = .TRUE.
      LRCLTA = .TRUE.
      IREJ   = IREJ+1
      IF(IPEV.GE.1)WRITE(6,'(A,I5)')' FICONF rej. IREJ ',IREJ
      RETURN
      END
*
*====eva2he============================================================*        
*                                                                      *        
      SUBROUTINE EVA2HE(MO,EEXCF,IRCL,IREJ)

************************************************************************
* Interface between common's of evaporation module (FINUC,FHEAVY)      *
* and HKKEVT.                                                          *
*    MO    HKKEVT-index of "mother" (residual) nucleus before evap.    *
*    EEXCF exitation energy of residual nucleus after evaporation      *
*    IRCL  = 1 projectile residual nucleus                             *
*          = 2 target     residual nucleus                             *
* This version dated 19.04.95 is written by S. Roesler.                *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY10=1.0D-10,TINY3=1.0D-3)

      PARAMETER (NMXHKK=49998) 
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
* special use for heavy fragments !
*   IDRES(I) = mass number, IDXRES(I) = charge
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)
      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      COMMON /STFICO/ EXCDPM(4),EXCEVA(2),
     &                NINCGE,NINCCO(2,3),NINCHR(2,2),NINCWO(2),
     &                NINCST(2,4),NINCEV(2),
     &                NRESTO(2),NRESPR(2),NRESNU(2),NRESBA(2),
     &                NRESPB(2),NRESCH(2),NRESEV(4),
     &                NEVA(2,6),NEVAGA(2),NEVAHT(2),NEVAHY(2,2,240),
     &                NEVAFI(2,2)
      COMMON /EXCITA/ AMRCL0(2),EEXC(2),EEXCFI(2),
     &                NTOT(2),NPRO(2),NN(2),NH(2),NHPOS(2),NQ(2),
     &                NTOTFI(2),NPROFI(2)

      PARAMETER (MXP=999)                                                       
      COMMON / FINUC / CXR (MXP), CYR (MXP), CZR (MXP), TKI (MXP),              
     &                 PLR (MXP), WEI (MXP), TV, TVCMS, TVRECL, TVHEAV,         
     &                 TVBIND, NP0, NP, KPART (MXP)                             

* evaporation interface
      PARAMETER ( MXHEAV = 100 )
      CHARACTER*8 ANHEAV
      COMMON / FHEAVY / CXHEAV (MXHEAV), CYHEAV (MXHEAV),
     &                  CZHEAV (MXHEAV), TKHEAV (MXHEAV),
     &                  PHEAVY (MXHEAV), WHEAVY (MXHEAV),
     &                  AMHEAV  ( 12 ) , AMNHEA  ( 12 ) ,
     &                  KHEAVY (MXHEAV), ICHEAV  ( 12 ) ,
     &                  IBHEAV  ( 12 ) , NPHEAV
      COMMON / FHEAVC / ANHEAV  ( 12 )
      LOGICAL LRNFSS, LFRAGM
      COMMON /RESNUC/  AMNTAR, AMMTAR, AMNZM1, AMMZM1, AMNNM1, AMMNM1,
     &                   ANOW,   ZNOW, ANCOLL, ZNCOLL, AMMLFT, AMNLFT,
     &                   ERES,  EKRES, AMNRES, AMMRES,  PTRES,  PXRES,
     &                  PYRES,  PZRES, PTRES2,  KTARP,  KTARN, IGREYP,
     &                 IGREYN,  ICRES,  IBRES, ISTRES, IEVAPL, IEVAPH,
     &                 IEVNEU, IEVPRO, IEVDEU, IEVTRI, IEV3HE, IEV4HE,
     &                 IDEEXG,  IBTAR, ICHTAR, IBLEFT, ICLEFT, IOTHER,
     &                 LRNFSS, LFRAGM

      DIMENSION IPTOKP(39)
      DATA IPTOKP / 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
     & 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 99,
     & 100, 101, 97, 102, 98, 103, 109, 115 /

      IREJ = 0

* update counter
      IF (NRESEV(3).NE.NEVHKK) THEN
         NRESEV(3) = NEVHKK
         NRESEV(4) = NRESEV(4)+1
      ENDIF

      IF (LEMCCK) 
     &   CALL EVTEMC(PHKK(1,MO),PHKK(2,MO),PHKK(3,MO),PHKK(4,MO),1,
     &                                                   IDUM,IDUM)
* mass number/charge of residual nucleus before evaporation
      IBTOT = IDRES(MO)
      IZTOT = IDXRES(MO)
      IF(IPRI.GE.1)WRITE(6,*)' resnuc IBTOT,IZTOT ',IBTOT,IZTOT
* protons/neutrons/gammas
      DO 1 I=1,NP
         PX    = CXR(I)*PLR(I)
         PY    = CYR(I)*PLR(I)
         PZ    = CZR(I)*PLR(I)
         ID    = IPTOKP(KPART(I))
         IDPDG = IPDGHA(ID)
         AM    = ((PLR(I)+TKI(I))*(PLR(I)-TKI(I)))/
     &           (2.0D0*MAX(TKI(I),TINY10))
         IF (ABS(AM-AAM(ID)).GT.TINY3) THEN
            WRITE(LOUT,1000) ID,AM,AAM(ID)
 1000       FORMAT(1X,'EVA2HE:  inconsistent mass of evap. ',
     &             'particle',I3,2E10.3)
         ENDIF
         PE = TKI(I)+AM
         CALL EVTPUT(-1,IDPDG,MO,0,PX,PY,PZ,PE,0,0,0)
         NOBAM(NHKK) = IRCL
         IF (LEMCCK) CALL EVTEMC(-PX,-PY,-PZ,-PE,2,IDUM,IDUM)
         IBTOT = IBTOT-IIBAR(ID)
         IZTOT = IZTOT-IICH(ID)
    1 CONTINUE

* heavy fragments
      DO 2 I=1,NPHEAV
         PX     = CXHEAV(I)*PHEAVY(I)
         PY     = CYHEAV(I)*PHEAVY(I)
         PZ     = CZHEAV(I)*PHEAVY(I)
         IDHEAV = 80000
         AM     = ((PHEAVY(I)+TKHEAV(I))*(PHEAVY(I)-TKHEAV(I)))/
     &            (2.0D0*MAX(TKHEAV(I),TINY10))
         PE     = TKHEAV(I)+AM
         CALL EVTPUT(-1,IDHEAV,MO,0,PX,PY,PZ,PE,
     &                  IBHEAV(KHEAVY(I)),ICHEAV(KHEAVY(I)),0)
         NOBAM(NHKK) = IRCL
         IF (LEMCCK) CALL EVTEMC(-PX,-PY,-PZ,-PE,2,IDUM,IDUM)
         IBTOT = IBTOT-IBHEAV(KHEAVY(I))
         IZTOT = IZTOT-ICHEAV(KHEAVY(I))
    2 CONTINUE

      IF (IBRES.GT.0) THEN
* residual nucleus after evaporation
         IDNUC = 80000
         CALL EVTPUT(1001,IDNUC,MO,0,PXRES,PYRES,PZRES,ERES,
     &                                        IBRES,ICRES,0)
C     WRITE(6,*)PXRES,PYRES,PZRES,ERES,'EVTPUT1001'
         NOBAM(NHKK) = IRCL
      ENDIF
      EEXCF = TVCMS 
      NTOTFI(IRCL) = IBRES
      NPROFI(IRCL) = ICRES
      IF (LEMCCK) CALL EVTEMC(-PXRES,-PYRES,-PZRES,-ERES,2,IDUM,IDUM)
      IBTOT = IBTOT-IBRES
      IZTOT = IZTOT-ICRES

* count events with fission
      NEVAFI(1,IRCL) = NEVAFI(1,IRCL)+1
      IF (LRNFSS) NEVAFI(2,IRCL) = NEVAFI(2,IRCL)+1

* energy-momentum conservation check
      IF (LEMCCK) CALL EVTEMC(DUM,DUM,DUM,DUM,4,40,IREJ)
* baryon-number/charge conservation check
      IF (IBTOT+IZTOT.NE.0) THEN
         WRITE(LOUT,1001) NEVHKK,IBTOT,IZTOT
 1001    FORMAT(1X,'EVA2HE:   baryon-number/charge conservation ',
     &          'failure at event ',I6,' :  IBTOT,IZTOT = ',2I3)
      ENDIF

      RETURN
      END
*
*===fozoca=============================================================*
*
      SUBROUTINE FOZOCA(LFZC,IREJ)

************************************************************************
* This subroutine treats the complete FOrmation ZOne supressed intra-  *
* nuclear CAscade.                                                     *
*               LFZC = .true.  cascade has been treated                *
*                    = .false. cascade skipped                         *
* This is a completely revised version of the original FOZOKL.         *
* This version dated 18.11.95 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (DLARGE=1.0D10,OHALF=0.5D0,ZERO=0.0D0)
      PARAMETER (FM2MM=1.0D-12,RNUCLE = 1.12D0)

      LOGICAL LSTART,LCAS,LFZC

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      COMMON /RJCOUN/ IRPT,IRHHA,IRRES(2),LOMRES,LOBRES,
     &                IRCHKI(2),IRFRAG,IRCRON(3),IREVT,
     &                IREXCI(3),IRDIFF(2),IRINC

      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      COMMON /PAULI/  EWOUND(2,300),NWOUND(2),IDXINC(2000),NOINC

      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
**sr mod. for DPMJET: use the longer DPMJET one
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     &        ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     &                IPADIS,ISHMAL,LPAULI
**

      DATA LSTART /.TRUE./

      DIMENSION NCWOUN(2)

C     WRITE(6,*)' beginn FOZOCA'
      LFZC = .TRUE.
      IREJ = 0

* skip cascade if hadron-hadron interaction or if supressed by user
      IF (((IP.EQ.1).AND.(IT.EQ.1)).OR.(KTAUGE.LT.1)) GOTO 9999
* skip cascade if not all possible chains systems are hadronized
      IF(IPEV.GE.1)WRITE(6,*)LHADRO
      DO 1 I=1,8
         IF (.NOT.(LHADRO(I))) GOTO 9999
    1 CONTINUE

      IF (IPEV.GE.1) THEN
         WRITE(6,1000) KTAUGE,TAUFOR,INCMOD
      ENDIF
      IF (LSTART) THEN
         WRITE(LOUT,1000) KTAUGE,TAUFOR,INCMOD
 1000    FORMAT(/,1X,'FOZOCA:  intranuclear cascade treated for a ',
     &          'maximum of',I4,' generations',/,10X,'formation time ',
     &          'parameter:',F5.1,'  fm/c',9X,'modus:',I2)
         IF (ITAUVE.EQ.1) WRITE(LOUT,1001)
         IF (ITAUVE.EQ.2) WRITE(LOUT,1002)
 1001    FORMAT(10X,'p_t dependent formation zone',/)
 1002    FORMAT(10X,'constant formation zone',/)
         LSTART = .FALSE.
      ENDIF

* in order to avoid wasting of cpu-time the HKKEVT-indices of nucleons
* which may interact with final state particles are stored in a seperate
* array - here all proj./target nucleon-indices (just for simplicity)
      NOINC = 0
      DO 9 I=1,NPOINT(1)-1
         NOINC = NOINC+1
         IDXINC(NOINC) = I
    9 CONTINUE

* initialize Pauli-principle treatment (find wounded nucleons)
      NWOUND(1) = 0
      NWOUND(2) = 0
      NCWOUN(1) = 0
      NCWOUN(2) = 0
      DO 2 J=1,NPOINT(1)
         DO 3 I=1,2
            IF (ISTHKK(J).EQ.10+I) THEN
               NWOUND(I) = NWOUND(I)+1
               EWOUND(I,NWOUND(I)) = PHKK(4,J)
               IF (IDHKK(J).EQ.2212) NCWOUN(I) = NCWOUN(I)+1
            ENDIF
    3    CONTINUE
    2 CONTINUE

* modify nuclear potential for wounded nucleons
      IPRCL  = IP -NWOUND(1)
      IPZRCL = IPZ-NCWOUN(1)
      ITRCL  = IT -NWOUND(2)
      ITZRCL = ITZ-NCWOUN(2)
      CALL NCLPOT(IPZRCL,IPRCL,ITZRCL,ITRCL,ZERO,ZERO,1)

      NSTART = NPOINT(4)
      NEND   = NHKK

    7 CONTINUE
      DO 8 I=NSTART,NEND

         IF ((ABS(ISTHKK(I)).EQ.1).AND.(IDCH(I).LT.KTAUGE)) THEN

* select nucleus the cascade starts first (proj. - 1, target - -1)
            NCAS   = 1
*   projectile/target with probab. 1/2
            IF ((INCMOD.EQ.1).OR.(IDCH(I).GT.0)) THEN
               IF (RNDM(V).GT.OHALF) NCAS = -NCAS
*   in the nucleus with highest mass
            ELSEIF (INCMOD.EQ.2) THEN
               IF (IP.GT.IT) THEN
                  NCAS = -NCAS
               ELSEIF (IP.EQ.IT) THEN
                  IF (RNDM(V).GT.OHALF) NCAS = -NCAS
               ENDIF
* the nucleus the cascade starts first is requested to be the one
* moving in the direction of the secondary
            ELSEIF (INCMOD.EQ.3) THEN
C              NCAS = INT(SIGN(1.0D0,PHKK(3,I)))
                    NCAS = INT(DSIGN(1.0D0,PHKK(3,I)))
            ENDIF
* check that the selected "nucleus" is not a hadron
            IF (((NCAS.EQ. 1).AND.(IP.LE.1)).OR.
     &          ((NCAS.EQ.-1).AND.(IT.LE.1)))    NCAS = -NCAS

* treat intranuclear cascade in the nucleus selected first
            LCAS = .FALSE.
            CALL INUCAS(IT,IP,I,LCAS,NCAS,IREJ1)
            IF (IREJ1.NE.0)THEN 
C	      WRITE(6,'(A)')' INUCAS Rejection'
	      GOTO 9998
            ENDIF
* treat intranuclear cascade in the other nucleus if this isn't a had.
            NCAS = -NCAS
            IF (((NCAS.EQ. 1).AND.(IP.GT.1)).OR.
     &          ((NCAS.EQ.-1).AND.(IT.GT.1)))    THEN
               IF (LCAS) CALL INUCAS(IT,IP,I,LCAS,NCAS,IREJ1)
               IF (IREJ1.NE.0)THEN
C	         WRITE(6,'(A)')' INUCAS Rejection2'
	         GOTO 9998
               ENDIF
            ENDIF

         ENDIF

    8 CONTINUE
      NSTART = NEND+1
      NEND   = NHKK
      IF (NSTART.LE.NEND) GOTO 7

C     WRITE(6,*)' end FOZOCA'
      RETURN

 9998 CONTINUE
* reject this event
      IRINC = IRINC+1
      IREJ = 1

 9999 CONTINUE
* intranucl. cascade not treated because of interaction properties or
* it is supressed by user or it was rejected or...
      LFZC = .FALSE.
* reset flag characterizing direction of motion in n-n-cms
**sr14-11-95
C     DO 9990 I=NPOINT(5),NHKK
C        IF (ISTHKK(I).EQ.-1) ISTHKK(I)=1
C9990 CONTINUE

C     WRITE(6,*)' end FOZOCA'
      RETURN
      END
*
*
*===inucas=============================================================*
*
      SUBROUTINE INUCAS(IT,IP,IDXCAS,LCAS,NCAS,IREJ)

************************************************************************
* Formation zone supressed IntraNUclear CAScade for one final state    *
* particle.                                                            *
*           IT, IP    mass numbers of target, projectile nuclei        *
*           IDXCAS    index of final state particle in HKKEVT          *
*           NCAS =  1 intranuclear cascade in projectile               *
*                = -1 intranuclear cascade in target                   *
* This version dated 11.06.96 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)

      PARAMETER (TINY10=1.0D-10,TINY2=1.0D-2,ZERO=0.0D0,DLARGE=1.0D10,
     &           OHALF=0.5D0,ONE=1.0D0)
      PARAMETER (FM2MM=1.0D-12,RNUCLE = 1.12D0)
      PARAMETER (TWOPI=6.283185307179586454D+00)
      PARAMETER (ELOWH=0.01D0,EHIH=9.0D0)

      LOGICAL LABSOR,LCAS

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      PARAMETER (MAXFSP=10)
      COMMON /FISTAT/ PFSP(5,MAXFSP),IDFSP(MAXFSP),NFSP

**sr mod. for DPMJET: the old shorter version of /FLAGS/
      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      CHARACTER*8 ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
      COMMON /NUCLEA/ PFERMP(2),PFERMN(2),FERMOD,
     &                EBINDP(2),EBINDN(2),EPOT(2,210),
     &                ETACOU(2),ICOUL
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
      COMMON /PAULI/  EWOUND(2,300),NWOUND(2),IDXINC(2000),NOINC
**sr mod. for DPMJET: use the longer DPMJET one
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     &        ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     &                IPADIS,ISHMAL,LPAULI

      COMMON /STFICO/ EXCDPM(4),EXCEVA(2),
     &                NINCGE,NINCCO(2,3),NINCHR(2,2),NINCWO(2),
     &                NINCST(2,4),NINCEV(2),
     &                NRESTO(2),NRESPR(2),NRESNU(2),NRESBA(2),
     &                NRESPB(2),NRESCH(2),NRESEV(4),
     &                NEVA(2,6),NEVAGA(2),NEVAHT(2),NEVAHY(2,2,240),
     &                NEVAFI(2,2)

      DIMENSION PCAS(2,5),PTOCAS(2),COSCAS(2,3),VTXCAS(2,4),VTXCA1(2,4),
     &          PCAS1(5),PNUC(5),BGTA(4),
     &          BGCAS(2),GACAS(2),BECAS(2),
     &          RNUC(2),BIMPC(2),VTXDST(3),IDXSPE(2),IDSPE(2),NWTMP(2)

      DATA PDIF /0.545D0/

      IREJ = 0

* update counter
      IF (NINCEV(1).NE.NEVHKK) THEN
         NINCEV(1) = NEVHKK
         NINCEV(2) = NINCEV(2)+1
      ENDIF

* "BAMJET-index" of this hadron
      IDCAS = IDBAM(IDXCAS)
      IF (MCHAD(IDCAS).EQ.-1) RETURN

* skip gammas, electrons, etc..
      IF (AAM(IDCAS).LT.TINY2) RETURN

* Lorentz-trsf. into projectile rest system
      IF (IP.GT.1) THEN
         CALL LTRANS(PHKK(1,IDXCAS),PHKK(2,IDXCAS),PHKK(3,IDXCAS),
     &               PHKK(4,IDXCAS),PCAS(1,1),PCAS(1,2),PCAS(1,3),
     &               PCAS(1,4),IDCAS,-2)
         PTOCAS(1) = SQRT(PCAS(1,1)**2+PCAS(1,2)**2+PCAS(1,3)**2)
         PCAS(1,5) = (PCAS(1,4)-PTOCAS(1))*(PCAS(1,4)+PTOCAS(1))
         IF (PCAS(1,5).GT.ZERO) THEN
            PCAS(1,5) = SQRT(PCAS(1,5))
         ELSE
            PCAS(1,5) = AAM(IDCAS)
         ENDIF
         DO 20 K=1,3
            COSCAS(1,K) = PCAS(1,K)/MAX(PTOCAS(1),TINY10)
   20    CONTINUE
* Lorentz-parameters
*   particle rest system --> projectile rest system
         BGCAS(1) = PTOCAS(1)/MAX(PCAS(1,5),TINY10)
         GACAS(1) = PCAS(1,4)/MAX(PCAS(1,5),TINY10)
         BECAS(1) = BGCAS(1)/GACAS(1)
      ELSE
         DO 21 K=1,5
            PCAS(1,K) = ZERO
            IF (K.LE.3) COSCAS(1,K) = ZERO
   21    CONTINUE
         PTOCAS(1) = ZERO
         BGCAS(1)  = ZERO
         GACAS(1)  = ZERO
         BECAS(1)  = ZERO
      ENDIF
* Lorentz-trsf. into target rest system
      IF (IT.GT.1) THEN
         CALL LTRANS(PHKK(1,IDXCAS),PHKK(2,IDXCAS),PHKK(3,IDXCAS),
     &               PHKK(4,IDXCAS),PCAS(2,1),PCAS(2,2),PCAS(2,3),
     &               PCAS(2,4),IDCAS,-3)
         PTOCAS(2) = SQRT(PCAS(2,1)**2+PCAS(2,2)**2+PCAS(2,3)**2)
         PCAS(2,5) = (PCAS(2,4)-PTOCAS(2))*(PCAS(2,4)+PTOCAS(2))
         IF (PCAS(2,5).GT.ZERO) THEN
            PCAS(2,5) = SQRT(PCAS(2,5))
         ELSE
            PCAS(2,5) = AAM(IDCAS)
         ENDIF
         DO 22 K=1,3
            COSCAS(2,K) = PCAS(2,K)/MAX(PTOCAS(2),TINY10)
   22    CONTINUE
* Lorentz-parameters
*   particle rest system --> target rest system
         BGCAS(2) = PTOCAS(2)/MAX(PCAS(2,5),TINY10)
         GACAS(2) = PCAS(2,4)/MAX(PCAS(2,5),TINY10)
         BECAS(2) = BGCAS(2)/GACAS(2)
      ELSE
         DO 23 K=1,5
            PCAS(2,K) = ZERO
            IF (K.LE.3) COSCAS(2,K) = ZERO
   23    CONTINUE
         PTOCAS(2) = ZERO
         BGCAS(2)  = ZERO
         GACAS(2)  = ZERO
         BECAS(2)  = ZERO
      ENDIF

* radii of nuclei (mm) modified by the wall-depth of the Woods-Saxon-
* potential (see CONUCL)
      RNUC(1)  = (RPROJ+4.605D0*PDIF)*FM2MM
      RNUC(2)  = (RTARG+4.605D0*PDIF)*FM2MM
* impact parameter (the projectile moving along z)
      BIMPC(1) = ZERO
      BIMPC(2) = BIMPAC*FM2MM

* get position of initial hadron in projectile/target rest-syst.
      DO 3 K=1,4
         VTXCAS(1,K) = WHKK(K,IDXCAS)
         VTXCAS(2,K) = VHKK(K,IDXCAS)
    3 CONTINUE

      ICAS = 1
      I2   = 2
      IF (NCAS.EQ.-1) THEN
         ICAS = 2
         I2   = 1
      ENDIF

      IF (PTOCAS(ICAS).LT.TINY10) THEN
         WRITE(LOUT,1000) PTOCAS
 1000    FORMAT(1X,'INUCAS:   warning! zero momentum of initial',
     &          '  hadron ',/,20X,2E12.4)
         GOTO 9999
      ENDIF

* reset spectator flags
      NSPE = 0
      IDXSPE(1) = 0
      IDXSPE(2) = 0
      IDSPE(1)  = 0
      IDSPE(2)  = 0

* formation length (in fm)
C     IF (LCAS) THEN
C        DEL0 = ZERO
C     ELSE
         DEL0 = TAUFOR*BGCAS(ICAS)
         IF (ITAUVE.EQ.1) THEN
            AMT  = PCAS(ICAS,1)**2+PCAS(ICAS,2)**2+PCAS(ICAS,5)**2
            DEL0 = DEL0*PCAS(ICAS,5)**2/AMT
         ENDIF
C     ENDIF
*   sample from exp(-del/del0)
      DEL1   = -DEL0*LOG(MAX(RNDM(V),TINY10))
* save formation time
      TAUSA1 = DEL1/BGCAS(ICAS)
      REL1   = TAUSA1*BGCAS(I2)

      DEL    = DEL1
      TAUSAM = DEL/BGCAS(ICAS)
      REL    = TAUSAM*BGCAS(I2)

* special treatment for negative particles unable to escape
* nuclear potential (implemented for ap, pi-, K- only)
      LABSOR = .FALSE.
      IF ((IICH(IDCAS).EQ.-1).AND.(IDCAS.LT.20)) THEN
*   threshold energy = nuclear potential + Coulomb potential
*   (nuclear potential for hadron-nucleus interactions only)
         ETHR = AAM(IDCAS)+EPOT(ICAS,IDCAS)+ETACOU(ICAS)
         IF (PCAS(ICAS,4).LT.ETHR) THEN
            DO 4 K=1,5
               PCAS1(K) = PCAS(ICAS,K)
    4       CONTINUE
*   "absorb" negative particle in nucleus
            CALL ABSORP(IDCAS,PCAS1,NCAS,NSPE,IDSPE,IDXSPE,0,IREJ1)
            IF (IREJ1.NE.0) GOTO 9999
            IF (NSPE.GE.1) LABSOR = .TRUE.
         ENDIF
      ENDIF

* if the initial particle has not been absorbed proceed with
* "normal" cascade
      IF (.NOT.LABSOR) THEN

*   calculate coordinates of hadron at the end of the formation zone
*   transport-time and -step in the rest system where this step is
*   treated
         DSTEP  = DEL*FM2MM
         DTIME  = DSTEP/BECAS(ICAS)
         RSTEP  = REL*FM2MM
         IF ((IP.GT.1).AND.(IT.GT.1)) THEN
            RTIME = RSTEP/BECAS(I2)
         ELSE
            RTIME = ZERO
         ENDIF
*   save step whithout considering the overlapping region
         DSTEP1 = DEL1*FM2MM
         DTIME1 = DSTEP1/BECAS(ICAS)
         RSTEP1 = REL1*FM2MM
         IF ((IP.GT.1).AND.(IT.GT.1)) THEN
            RTIME1 = RSTEP1/BECAS(I2)
         ELSE
            RTIME1 = ZERO
         ENDIF
*   transport to the end of the formation zone in this system
         DO 5 K=1,3
            VTXCA1(ICAS,K) = VTXCAS(ICAS,K)+DSTEP1*COSCAS(ICAS,K)
            VTXCA1(I2,K)   = VTXCAS(I2,K)  +RSTEP1*COSCAS(I2,K)
            VTXCAS(ICAS,K) = VTXCAS(ICAS,K)+DSTEP*COSCAS(ICAS,K)
            VTXCAS(I2,K)   = VTXCAS(I2,K)  +RSTEP*COSCAS(I2,K)
    5    CONTINUE
         VTXCA1(ICAS,4) = VTXCAS(ICAS,4)+DTIME1
         VTXCA1(I2,4)   = VTXCAS(I2,4)  +RTIME1
         VTXCAS(ICAS,4) = VTXCAS(ICAS,4)+DTIME
         VTXCAS(I2,4)   = VTXCAS(I2,4)  +RTIME

         IF ((IP.GT.1).AND.(IT.GT.1)) THEN
            XCAS   = VTXCAS(ICAS,1)
            YCAS   = VTXCAS(ICAS,2)
            XNCLTA = BIMPAC*FM2MM
            RNCLPR = (RPROJ+RNUCLE)*FM2MM
            RNCLTA = (RTARG+RNUCLE)*FM2MM
            RCASPR = SQRT( XCAS**2        +YCAS**2)
            RCASTA = SQRT((XCAS-XNCLTA)**2+YCAS**2)
            IF ((RCASPR.LT.RNCLPR).AND.(RCASTA.LT.RNCLTA)) THEN
               IF (IDCH(IDXCAS).EQ.0) NOBAM(IDXCAS) = 3
            ENDIF
         ENDIF

*   check if particle is already outside of the corresp. nucleus
         RDIST = SQRT((VTXCAS(ICAS,1)-BIMPC(ICAS))**2+
     &                VTXCAS(ICAS,2)**2+VTXCAS(ICAS,3)**2)
         IF (RDIST.GE.RNUC(ICAS)) THEN
*   here: IDCH is the generation of the final state part. starting
*   with zero for hadronization products
*   flag particles of generation 0 being outside the nuclei after
*   formation time (to be used for excitation energy calculation)
            IF ((IDCH(IDXCAS).EQ.0).AND.(NOBAM(IDXCAS).LT.3))
     &         NOBAM(IDXCAS) = NOBAM(IDXCAS)+ICAS
            GOTO 9997
         ENDIF
         DIST   = DLARGE
         DISTP  = DLARGE
         DISTN  = DLARGE
         IDXP   = 0
         IDXN   = 0

*   already here: skip particles being outside HADRIN "energy-window"
*   to avoid wasting of time
         NINCHR(ICAS,1) = NINCHR(ICAS,1)+1
         IF ((PTOCAS(ICAS).LE.ELOWH).OR.(PTOCAS(ICAS).GE.EHIH)) THEN
            NINCHR(ICAS,2) = NINCHR(ICAS,2)+1
C           WRITE(LOUT,1002) IDXCAS,IDCAS,ICAS,PTOCAS(ICAS),NEVHKK
C1002       FORMAT(1X,'INUCAS:   warning! momentum of particle with ',
C    &             'index ',I5,' (id: ',I3,') ',I3,/,11X,'p_tot = ',
C    &             E12.4,', above or below HADRIN-thresholds',I6)
            NSPE = 0
            GOTO 9997
         ENDIF

         DO 7 IDXHKK=1,NOINC
            I = IDXINC(IDXHKK)
*   scan HKKEVT for unwounded or excited nucleons
            IF ((ISTHKK(I).EQ.12+ICAS).OR.(ISTHKK(I).EQ.14+ICAS)) THEN
               DO 8 K=1,3
                  IF (ICAS.EQ.1) THEN
                     VTXDST(K) = WHKK(K,I)-VTXCAS(1,K)
                  ELSEIF (ICAS.EQ.2) THEN
                     VTXDST(K) = VHKK(K,I)-VTXCAS(2,K)
                  ENDIF
    8          CONTINUE
               POSNUC = VTXDST(1)*COSCAS(ICAS,1)+
     &                  VTXDST(2)*COSCAS(ICAS,2)+
     &                  VTXDST(3)*COSCAS(ICAS,3)
*   check if nucleon is situated in forward direction
               IF (POSNUC.GT.ZERO) THEN
*   distance between hadron and this nucleon
                  DISTNU = SQRT(VTXDST(1)**2+VTXDST(2)**2+
     &                          VTXDST(3)**2)
*   impact parameter
                  BIMNU2 = DISTNU**2-POSNUC**2
                  IF (BIMNU2.LT.ZERO) THEN
                     WRITE(LOUT,1001) DISTNU,POSNUC,BIMNU2
 1001                FORMAT(1X,'INUCAS:   warning! inconsistent impact',
     &                      '  parameter ',/,20X,3E12.4)
                     GOTO 7
                  ENDIF
                  BIMNU  = SQRT(BIMNU2)
*   maximum impact parameter to have interaction
                  IDNUC  = ICIHAD(IDHKK(I))
                  IDNUC1 = MCHAD(IDNUC)
                  IDCAS1 = MCHAD(IDCAS)
                  DO 19 K=1,5
                     PCAS1(K) = PCAS(ICAS,K)
                     PNUC(K)  = PHKK(K,I)
   19             CONTINUE
* Lorentz-parameter for trafo into rest-system of target
                  DO 18 K=1,4
                     BGTA(K) = PNUC(K)/MAX(PNUC(5),TINY10)
   18             CONTINUE
* transformation of projectile into rest-system of target
                  CALL DALTRA(BGTA(4),-BGTA(1),-BGTA(2),-BGTA(3),
     &                        PCAS1(1),PCAS1(2),PCAS1(3),PCAS1(4),
     &                        PPTOT,PX,PY,PZ,PE)
                  CALL SIHNIN(IDCAS1,IDNUC1,PPTOT,SIGIN)
                  CALL SIHNEL(IDCAS1,IDNUC1,PPTOT,SIGEL)
                  CALL SIHNAB(IDCAS1,IDNUC1,PPTOT,SIGAB)
                  SIGTOT = SIGIN+SIGEL+SIGAB
                  BIMMAX = SQRT(SIGTOT/(5.0D0*TWOPI))*FM2MM
*   check if interaction is possible
                  IF (BIMNU.LE.BIMMAX) THEN
*   get nucleon with smallest distance and kind of interaction
*   (elastic/inelastic)
                     IF (DISTNU.LT.DIST) THEN
                        DIST      = DISTNU
                        BINT      = BIMNU
                        IF (IDNUC.NE.IDSPE(1)) THEN
                           IDSPE(2)  = IDSPE(1)
                           IDXSPE(2) = IDXSPE(1)
                           IDSPE(1)  = IDNUC
                        ENDIF
                        IDXSPE(1) = I
                        NSPE      = 1
**sr
                        SELA = SIGEL
                        SABS = SIGAB
                        STOT = SIGTOT
C                       IF ((IDCAS.EQ.2).OR.(IDCAS.EQ.9)) THEN
C                          SELA = SIGEL
C                          STOT = SIGIN+SIGEL
C                       ELSE
C                          SELA = SIGEL+0.75D0*SIGIN
C                          STOT = 0.25D0*SIGIN+SELA
C                       ENDIF
**
                     ENDIF
                  ENDIf
               ENDIF
               DISTNU = SQRT(VTXDST(1)**2+VTXDST(2)**2+
     &                       VTXDST(3)**2)
               IDNUC  = ICIHAD(IDHKK(I))
               IF (IDNUC.EQ.1) THEN
                  IF (DISTNU.LT.DISTP) THEN
                     DISTP = DISTNU
                     IDXP  = I
                     POSP  = POSNUC
                  ENDIF
               ELSEIF (IDNUC.EQ.8) THEN
                  IF (DISTNU.LT.DISTN) THEN
                     DISTN = DISTNU
                     IDXN  = I
                     POSN  = POSNUC
                  ENDIF
               ENDIF
            ENDIF
    7    CONTINUE

* there is no nucleon for a secondary interaction
         IF (NSPE.EQ.0) GOTO 9997

         IF (IDXSPE(2).EQ.0) THEN
            IF ((IDSPE(1).EQ.1).AND.(IDXN.GT.0)) THEN
               IDXSPE(2) = IDXN
               IDSPE(2)  = 8
            ELSEIF ((IDSPE(1).EQ.8).AND.(IDXP.GT.0)) THEN
               IDXSPE(2) = IDXP
               IDSPE(2)  = 1
            ELSE
               STOT = STOT-SABS
               SABS = ZERO
            ENDIF
         ENDIF
         RR = RNDM(V)
         IF (RR.LT.SELA/STOT) THEN
            IPROC = 2
         ELSEIF ((RR.GE.SELA/STOT).AND.(RR.LT.(SELA+SABS)/STOT)) THEN
            IPROC = 3
         ELSE
            IPROC = 1
         ENDIF

         DO 9 K=1,5
            PCAS1(K) = PCAS(ICAS,K)
            PNUC(K)  = PHKK(K,IDXSPE(1))
    9    CONTINUE
         IF (IPROC.EQ.3) THEN
* 2-nucleon absorption of pion
            NSPE = 2
            CALL ABSORP(IDCAS,PCAS1,NCAS,NSPE,IDSPE,IDXSPE,1,IREJ1)
            IF (IREJ1.NE.0) GOTO 9999
            IF (NSPE.GE.1) LABSOR = .TRUE.
         ELSE
* sample secondary interaction
            IDNUC = IDBAM(IDXSPE(1))
**sr mod. for DPMJET: HADRIN-->HADRI1
            CALL HADRI1(IDCAS,PCAS1,IDNUC,PNUC,IPROC,IREJ1)
**sr mod. for DPMJET: in case of rejections jump to 9998 rather than
*                     reject cascade completely (??)
C           IF (IREJ1.EQ.1) GOTO 9999
            IF (IREJ1.GE.1)THEN
C              WRITE(6,'(A)')' HADRI1 Rejection'
               GOTO 9998
            ENDIF
         ENDIF
      ENDIF

* update arrays to include Pauli-principle
      DO 10 I=1,NSPE
         IF (NWOUND(ICAS).LE.299) THEN
            NWOUND(ICAS) = NWOUND(ICAS)+1
            EWOUND(ICAS,NWOUND(ICAS)) = PHKK(4,IDXSPE(I))
         ENDIF
   10 CONTINUE

* dump initial hadron for energy-momentum conservation check
      IF (LEMCCK)
     &   CALL EVTEMC(PCAS(ICAS,1),PCAS(ICAS,2),PCAS(ICAS,3),
     &               PCAS(ICAS,4),1,IDUM,IDUM)

* dump final state particles into HKKEVT

*   check if Pauli-principle is fulfilled
      NPAULI = 0
      NWTMP(1) = NWOUND(1)
      NWTMP(2) = NWOUND(2)
      DO 111 I=1,NFSP
         NPAULI = 0
         J1 = 2
         IF (((NCAS.EQ. 1).AND.(IT.LE.1)).OR.
     &       ((NCAS.EQ.-1).AND.(IP.LE.1)))    J1 = 1
         DO 117 J=1,J1
            IF ((NPAULI.NE.0).AND.(J.EQ.2)) GOTO 117
            IF (J.EQ.1) THEN
               IDX = ICAS
               PE  = PFSP(4,I)
            ELSE
               IDX  = I2
               MODE = 1
               IF (IDX.EQ.1) MODE = -1
               CALL LTNUC(PFSP(3,I),PFSP(4,I),PZ,PE,MODE)
            ENDIF
* first check if cascade step is forbidden due to Pauli-principle
* (in case of absorpion this step is forced)
            IF ((.NOT.LABSOR).AND.LPAULI.AND.((IDFSP(I).EQ.1).OR.
     &          (IDFSP(I).EQ.8))) THEN
*   get nuclear potential barrier
               POT = EPOT(IDX,IDFSP(I))+AAM(IDFSP(I))
               IF (IDFSP(I).EQ.1) THEN
                  POTLOW = POT-EBINDP(IDX)
               ELSE
                  POTLOW = POT-EBINDN(IDX)
               ENDIF
*   final state particle not able to escape nucleus
               IF (PE.LE.POTLOW) THEN
*     check if there are wounded nucleons
                  IF ((NWOUND(IDX).GE.1).AND.(PE.GE.
     &                 EWOUND(IDX,NWOUND(IDX)))) THEN
                     NPAULI      = NPAULI+1
                     NWOUND(IDX) = NWOUND(IDX)-1
                  ELSE
*     interaction prohibited by Pauli-principle
                     NWOUND(1) = NWTMP(1)
                     NWOUND(2) = NWTMP(2)
                     GOTO 9997
                  ENDIF
               ENDIF
            ENDIF
  117    CONTINUE
  111 CONTINUE

      NPAULI = 0
      NWOUND(1) = NWTMP(1)
      NWOUND(2) = NWTMP(2)

      DO 11 I=1,NFSP

         IST = ISTHKK(IDXCAS)

         NPAULI = 0
         J1 = 2
         IF (((NCAS.EQ. 1).AND.(IT.LE.1)).OR.
     &       ((NCAS.EQ.-1).AND.(IP.LE.1)))    J1 = 1
         DO 17 J=1,J1
            IF ((NPAULI.NE.0).AND.(J.EQ.2)) GOTO 17
            IDX = ICAS
            PE  = PFSP(4,I)
            IF (J.EQ.2) THEN
               IDX = I2
               CALL LTNUC(PFSP(3,I),PFSP(4,I),PZ,PE,NCAS)
            ENDIF
* first check if cascade step is forbidden due to Pauli-principle
* (in case of absorpion this step is forced)
            IF ((.NOT.LABSOR).AND.LPAULI.AND.((IDFSP(I).EQ.1).OR.
     &          (IDFSP(I).EQ.8))) THEN
*   get nuclear potential barrier
               POT = EPOT(IDX,IDFSP(I))+AAM(IDFSP(I))
               IF (IDFSP(I).EQ.1) THEN
                  POTLOW = POT-EBINDP(IDX)
               ELSE
                  POTLOW = POT-EBINDN(IDX)
               ENDIF
*   final state particle not able to escape nucleus
               IF (PE.LE.POTLOW) THEN
*     check if there are wounded nucleons
                  IF ((NWOUND(IDX).GE.1).AND.(PE.GE.
     &                 EWOUND(IDX,NWOUND(IDX)))) THEN
                     NWOUND(IDX) = NWOUND(IDX)-1
                     NPAULI = NPAULI+1
                     IST    = 14+IDX
                  ELSE
*     interaction prohibited by Pauli-principle
                     NWOUND(1) = NWTMP(1)
                     NWOUND(2) = NWTMP(2)
                     GOTO 9997
                  ENDIF
**sr
c               ELSEIF (PE.LE.POT) THEN
cC              ELSEIF ((PE.LE.POT).AND.(NWOUND(IDX).GE.1)) THEN
cC                 NWOUND(IDX) = NWOUND(IDX)-1
c**
c                  NPAULI = NPAULI+1
c                  IST    = 14+IDX
               ENDIF
            ENDIF
   17    CONTINUE

* dump final state particles for energy-momentum conservation check
         IF (LEMCCK) CALL EVTEMC(-PFSP(1,I),-PFSP(2,I),-PFSP(3,I),
     &                           -PFSP(4,I),2,IDUM,IDUM)

         PX = PFSP(1,I)
         PY = PFSP(2,I)
         PZ = PFSP(3,I)
         PE = PFSP(4,I)
         IF (ABS(IST).EQ.1) THEN
* transform particles back into n-n cms
            IMODE = ICAS+1
            CALL LTRANS(PX,PY,PZ,PE,PFSP(1,I),PFSP(2,I),PFSP(3,I),
     &                  PFSP(4,I),IDFSP(I),IMODE)
         ELSEIF ((ICAS.EQ.2).AND.(IST.EQ.15)) THEN
* target cascade but fsp got stuck in proj. --> transform it into
* proj. rest system
            CALL LTRANS(PX,PY,PZ,PE,PFSP(1,I),PFSP(2,I),PFSP(3,I),
     &                  PFSP(4,I),IDFSP(I),-1)
         ELSEIF ((ICAS.EQ.1).AND.(IST.EQ.16)) THEN
* proj. cascade but fsp got stuck in target --> transform it into
* target rest system
            CALL LTRANS(PX,PY,PZ,PE,PFSP(1,I),PFSP(2,I),PFSP(3,I),
     &                  PFSP(4,I),IDFSP(I),1)
         ENDIF

* dump final state particles into HKKEVT
         IGEN = IDCH(IDXCAS)+1
         ID   = IPDGHA(IDFSP(I))
         IXR  = 0
         IF (LABSOR) IXR = 99
         CALL EVTPUT(IST,ID,IDXCAS,IDXSPE(1),PFSP(1,I),
     &               PFSP(2,I),PFSP(3,I),PFSP(4,I),0,IXR,IGEN)

* update the counter for particles which got stuck inside the nucleus
         IF ((IST.EQ.15).OR.(IST.EQ.16)) THEN
            NOINC = NOINC+1
            IDXINC(NOINC) = NHKK
         ENDIF
         IF (LABSOR) THEN
*   in case of absorption the spatial treatment is an approximate
*   solution anyway (the positions of the nucleons which "absorb" the
*   cascade particle are not taken into consideration) therefore the
*   particles are produced at the position of the cascade particle
            DO 12 K=1,4
               WHKK(K,NHKK) = WHKK(K,IDXCAS)
               VHKK(K,NHKK) = VHKK(K,IDXCAS)
   12       CONTINUE
         ELSE
*   DDISTL - distance the cascade particle moves to the intera. point
*   (the position where impact-parameter = distance to the interacting
*   nucleon), DIST - distance to the interacting nucleon at the time of
*   formation of the cascade particle, BINT - impact-parameter of this
*   cascade-interaction
            DDISTL = SQRT(DIST**2-BINT**2)
            DTIME  = DDISTL/BECAS(ICAS)
            DTIMEL = DDISTL/BGCAS(ICAS)
            RDISTL = DTIMEL*BGCAS(I2)
            IF ((IP.GT.1).AND.(IT.GT.1)) THEN
               RTIME = RDISTL/BECAS(I2)
            ELSE
               RTIME = ZERO
            ENDIF
*   RDISTL, RTIME are this step and time in the rest system of the other
*   nucleus
            DO 13 K=1,3
               VTXCA1(ICAS,K) = VTXCAS(ICAS,K)+COSCAS(ICAS,K)*DDISTL
               VTXCA1(I2,K)   = VTXCAS(I2,K)  +COSCAS(I2,K)  *RDISTL
   13       CONTINUE
            VTXCA1(ICAS,4) = VTXCAS(ICAS,4)+DTIME
            VTXCA1(I2,4)   = VTXCAS(I2,4)  +RTIME
*   position of particle production is half the impact-parameter to
*   the interacting nucleon
            DO 14 K=1,3
               WHKK(K,NHKK) = OHALF*(VTXCA1(1,K)+WHKK(K,IDXSPE(1)))
               VHKK(K,NHKK) = OHALF*(VTXCA1(2,K)+VHKK(K,IDXSPE(1)))
   14       CONTINUE
*   time of production of secondary = time of interaction
            WHKK(4,NHKK) = VTXCA1(1,4)
            VHKK(4,NHKK) = VTXCA1(2,4)
         ENDIF

   11 CONTINUE

* modify status and position of cascade particle (the latter for
* statistics reasons only)
      ISTHKK(IDXCAS) = 2
      IF (LABSOR) ISTHKK(IDXCAS) = 19
      IF (.NOT.LABSOR) THEN
         DO 15 K=1,4
            WHKK(K,IDXCAS) = VTXCA1(1,K)
            VHKK(K,IDXCAS) = VTXCA1(2,K)
   15    CONTINUE
      ENDIF

      DO 16 I=1,NSPE
         IS = IDXSPE(I)
* dump interacting nucleons for energy-momentum conservation check
         IF (LEMCCK)
     &      CALL EVTEMC(PHKK(1,IS),PHKK(2,IS),PHKK(3,IS),PHKK(4,IS),
     &                                                  2,IDUM,IDUM)
* modify entry for interacting nucleons
         IF (ISTHKK(IS).EQ.12+ICAS) ISTHKK(IS)=16+ICAS
         IF (ISTHKK(IS).EQ.14+ICAS) ISTHKK(IS)=2
         IF (I.GE.2) THEN
            JDAHKK(1,IS) = JDAHKK(1,IDXSPE(1))
            JDAHKK(2,IS) = JDAHKK(2,IDXSPE(1))
         ENDIF
   16 CONTINUE

* check energy-momentum conservation
      IF (LEMCCK) THEN
         CALL EVTEMC(DUM,DUM,DUM,DUM,4,500,IREJ1)
         IF (IREJ1.NE.0) GOTO 9999
      ENDIF

* update counter
      IF (LABSOR) THEN
         NINCCO(ICAS,1) = NINCCO(ICAS,1)+1
      ELSE
         IF (IPROC.EQ.1) NINCCO(ICAS,2) = NINCCO(ICAS,2)+1
         IF (IPROC.EQ.2) NINCCO(ICAS,3) = NINCCO(ICAS,3)+1
      ENDIF

      RETURN

 9997 CONTINUE
 9998 CONTINUE
* transport-step but no cascade step due to configuration (i.e. there
* is no nucleon for interaction etc.)
      IF (LCAS) THEN
         DO 100 K=1,4
C           WHKK(K,IDXCAS) = VTXCAS(1,K)
C           VHKK(K,IDXCAS) = VTXCAS(2,K)
            WHKK(K,IDXCAS) = VTXCA1(1,K)
            VHKK(K,IDXCAS) = VTXCA1(2,K)
  100    CONTINUE
      ENDIF

C9998 CONTINUE
* no cascade-step because of configuration
* (i.e. hadron outside nucleus etc.)
      LCAS = .TRUE.
      RETURN

 9999 CONTINUE
* rejection
      IREJ = 1
      RETURN
      END
*
*===absorp=============================================================*
*
      SUBROUTINE ABSORP(IDCAS,PCAS,NCAS,NSPE,IDSPE,IDXSPE,MODE,IREJ)

************************************************************************
* Two-nucleon absorption of antiprotons, pi-, and K-.                  *
* Antiproton absorption is handled by HADRIN.                          *
* The following channels for meson-absorption are considered:          *
*          pi- + p + p ---> n + p                                      *
*          pi- + p + n ---> n + n                                      *
*          K-  + p + p ---> sigma+ + n / Lam + p / sigma0 + p          *
*          K-  + p + n ---> sigma- + n / Lam + n / sigma0 + n          *
*          K-  + p + p ---> sigma- + n                                 *
*      IDCAS, PCAS   identity, momentum of particle to be absorbed     *
*      NCAS =  1     intranuclear cascade in projectile                *
*           = -1     intranuclear cascade in target                    *
*      NSPE          number of spectator nucleons involved             *
*      IDXSPE(2)     HKKEVT-indices of spectator nucleons involved     *
* Revised version of the original STOPIK written by HJM and J. Ranft.  *
* This version dated 11.06.96 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY10=1.0D-10,TINY5=1.0D-5,ONE=1.0D0,
     &           ONETHI=0.3333D0,TWOTHI=0.6666D0)

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      LOGICAL LEMCCK,LHADRO,LSEADI
C                        j.r.3.10.96
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      PARAMETER (MAXFSP=10)
      COMMON /FISTAT/ PFSP(5,MAXFSP),IDFSP(MAXFSP),NFSP

      CHARACTER*8 ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

      DIMENSION PCAS(5),IDXSPE(2),IDSPE(2),PSPE(2,5),PSPE1(5),
     &          PTOT3P(4),BG3P(4),
     &          ECMF(2),PCMF(2),CODF(2),COFF(2),SIFF(2)

      IREJ = 0
      NFSP = 0

* skip particles others than ap, pi-, K- for mode=0
      IF ((MODE.EQ.0).AND.
     &    (IDCAS.NE.2).AND.(IDCAS.NE.14).AND.(IDCAS.NE.16)) RETURN
* skip particles others than pions for mode=1
      IF ((MODE.EQ.1).AND.(IDCAS.NE.13).AND.
     &(IDCAS.NE.23).AND.(IDCAS.NE.14)) RETURN

      NUCAS = NCAS
      IF (NUCAS.EQ.-1) NUCAS = 2

      IF (MODE.EQ.0) THEN
* scan spectator nucleons for nucleons being able to "absorb"
         NSPE      = 0
         IDXSPE(1) = 0
         IDXSPE(2) = 0
         DO 1 I=1,NHKK
            IF ((ISTHKK(I).EQ.12+NUCAS).OR.(ISTHKK(I).EQ.14+NUCAS)) THEN
               NSPE         = NSPE+1
               IDXSPE(NSPE) = I
               IDSPE(NSPE)  = IDBAM(I)
               IF ((NSPE.EQ.1).AND.(IDCAS.EQ.2)) GOTO 2
               IF (NSPE.EQ.2) THEN
                  IF ((IDCAS.EQ.14).AND.(IDSPE(1).EQ.8).AND. 
     &                                  (IDSPE(2).EQ.8)) THEN
*    there is no pi-+n+n channel
                     NSPE = 1
                     GOTO 1
                  ELSE
                     GOTO 2
                  ENDIF
               ENDIF
            ENDIF
    1    CONTINUE

    2    CONTINUE
      ENDIF
* transform excited projectile nucleons (status=15) into proj. rest s.
      DO 3 I=1,NSPE
         DO 4 K=1,5
            PSPE(I,K) = PHKK(K,IDXSPE(I))
    4    CONTINUE
    3 CONTINUE

* antiproton absorption
      IF ((IDCAS.EQ.2).AND.(NSPE.GE.1)) THEN
         DO 5 K=1,5
            PSPE1(K) = PSPE(1,K)
    5    CONTINUE
**sr mod. for DPMJET: HADRIN-->HADRI1
         CALL HADRI1(IDCAS,PCAS,IDSPE(1),PSPE1,1,IREJ1)
         IF (IREJ1.NE.0) GOTO 9999

* meson absorption
      ELSEIF (((IDCAS.EQ.13).OR.(IDCAS.EQ.14).OR.
     &(IDCAS.EQ.23).OR.(IDCAS.EQ.16))
     &        .AND.(NSPE.GE.2)) THEN
         IF (IDCAS.EQ.14) THEN
*   pi- absorption
            IDFSP(1) = 8
            IDFSP(2) = 8
            IF ((IDSPE(1).EQ.1).AND.(IDSPE(2).EQ.1)) IDFSP(2) = 1
         ELSEIF (IDCAS.EQ.13) THEN
*   pi+ absorption
            IDFSP(1) = 1
            IDFSP(2) = 1
            IF ((IDSPE(1).EQ.8).AND.(IDSPE(2).EQ.8)) IDFSP(2) = 8
         ELSEIF (IDCAS.EQ.23) THEN
*   pi-0 absorption
            IDFSP(1) =IDSPE(1) 
            IDFSP(2) =IDSPE(2) 
         ELSEIF (IDCAS.EQ.16) THEN
*   K- absorption
            R = RNDM(V)
            IF ((IDSPE(1).EQ.1).AND.(IDSPE(2).EQ.1)) THEN
               IF (R.LT.ONETHI) THEN
                  IDFSP(1) = 21
                  IDFSP(2) = 8
               ELSEIF (R.LT.TWOTHI) THEN
                  IDFSP(1) = 17
                  IDFSP(2) = 1
               ELSE
                  IDFSP(1) = 22
                  IDFSP(2) = 1
               ENDIF
            ELSEIF ((IDSPE(1).EQ.8).AND.(IDSPE(2).EQ.8)) THEN
               IDFSP(1) = 20 
               IDFSP(2) = 8
            ELSE
               IF (R.LT.ONETHI) THEN
                  IDFSP(1) = 20
                  IDFSP(2) = 1
               ELSEIF (R.LT.TWOTHI) THEN
                  IDFSP(1) = 17
                  IDFSP(2) = 8
               ELSE
                  IDFSP(1) = 22
                  IDFSP(2) = 8
               ENDIF
            ENDIF
         ENDIF
*   dump initial particles for energy-momentum cons. check
         IF (LEMCCK) THEN
            CALL EVTEMC(PCAS(1),PCAS(2),PCAS(3),PCAS(4),1,IDUM,IDUM)
            CALL EVTEMC(PSPE(1,1),PSPE(1,2),PSPE(1,3),PSPE(1,4),2,  
     &                                                    IDUM,IDUM)
            CALL EVTEMC(PSPE(2,1),PSPE(2,2),PSPE(2,3),PSPE(2,4),2,  
     &                                                    IDUM,IDUM)
         ENDIF
*   get Lorentz-parameter of 3 particle initial state
         DO 6 K=1,4
            PTOT3P(K) = PCAS(K)+PSPE(1,K)+PSPE(2,K)
    6    CONTINUE
         P3P  = SQRT(PTOT3P(1)**2+PTOT3P(2)**2+PTOT3P(3)**2)
         AM3P = SQRT( (PTOT3P(4)-P3P)*(PTOT3P(4)+P3P) )
         DO 7 K=1,4
            BG3P(K) = PTOT3P(K)/MAX(AM3P,TINY10)
    7    CONTINUE
*   2-particle decay of the 3-particle compound system
         CALL DTWOPD(AM3P,ECMF(1),ECMF(2),PCMF(1),PCMF(2),
     &               CODF(1),COFF(1),SIFF(1),CODF(2),COFF(2),SIFF(2),
     &               AAM(IDFSP(1)),AAM(IDFSP(2)))
         DO 8 I=1,2
            SDF = SQRT((ONE-CODF(I))*(ONE+CODF(I)))
            PX  = PCMF(I)*COFF(I)*SDF
            PY  = PCMF(I)*SIFF(I)*SDF
            PZ  = PCMF(I)*CODF(I)
            CALL DALTRA(BG3P(4),BG3P(1),BG3P(2),BG3P(3),PX,PY,PZ,
     &                  ECMF(I),PTOFSP,PFSP(1,I),PFSP(2,I),PFSP(3,I),
     &                  PFSP(4,I))
            PFSP(5,I) = SQRT( (PFSP(4,I)-PTOFSP)*(PFSP(4,I)+PTOFSP) )
*   check consistency of kinematics
            IF (ABS(AAM(IDFSP(I))-PFSP(5,I)).GT.TINY5) THEN
               WRITE(LOUT,1001) IDFSP(I),AAM(IDFSP(I)),PFSP(5,I)
 1001          FORMAT(1X,'ABSORP:   warning! inconsistent',
     &                ' tree-particle kinematics',/,20X,'id: ',I3,
     &                ' AAM = ',E10.4,' MFSP = ',E10.4)
            ENDIF
*   dump final state particles for energy-momentum cons. check
            IF (LEMCCK) CALL EVTEMC(-PFSP(1,I),-PFSP(2,I),
     &                              -PFSP(3,I),-PFSP(4,I),2,IDUM,IDUM)
    8    CONTINUE
         NFSP = 2
         IF (LEMCCK) THEN
            CALL EVTEMC(DUM,DUM,DUM,DUM,3,100,IREJ1)
            IF (IREJ1.NE.0) THEN
               WRITE(LOUT,*)'ABSORB: EMC ',AAM(IDFSP(1)),AAM(IDFSP(2)),
     &                      AM3P
               GOTO 9999
            ENDIF
         ENDIF
      ELSE
C        IF (IOULEV(3).GT.0) WRITE(LOUT,1000) IDCAS,NSPE
 1000    FORMAT(1X,'ABSORP:   warning! absorption for particle ',I3,
     &          ' impossible',/,20X,'too few spectators (',I2,')')
         NSPE = 0
      ENDIF

      RETURN

 9999 CONTINUE
C     IF (IOULEV(1).GT.0) WRITE(LOUT,*) 'rejected 1 in ABSORP'
      IREJ = 1
      RETURN
      END
*
*===hadri1=============================================================*
*
**sr mod. for DPMJET: HADRIN-->HADRI1
      SUBROUTINE HADRI1(IDPR,PPR,IDTA,PTA,MODE,IREJ)

************************************************************************
* Interface to the HADRIN-routines for inelastic and elastic           *
* scattering.                                                          *
*      IDPR,PPR(5)   identity, momentum of projectile                  *
*      IDTA,PTA(5)   identity, momentum of target                      *
*      MODE  = 1     inelastic interaction                             *
*            = 2     elastic   interaction                             *
* Revised version of the original FHAD.                                *
* This version dated 27.10.95 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0,TINY10=1.0D-10,TINY5=1.0D-5,TINY3=1.0D-3,
     &           TINY2=1.0D-2,TINY1=1.0D-1,ONE=1.0D0)

      LOGICAL LCORR,LMSSG
      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      PARAMETER (MAXFSP=10)
      COMMON /FISTAT/ PFSP(5,MAXFSP),IDFSP(MAXFSP),NFSP

      CHARACTER*8 ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

* output-common for DHADRI/ELHAIN
      PARAMETER (MAXFIN=10)
      COMMON /DFINLS/ ITRH(MAXFIN),CXRH(MAXFIN),CYRH(MAXFIN),
     &                CZRH(MAXFIN),ELRH(MAXFIN),PLRH(MAXFIN),IRH

      DIMENSION PPR(5),PPR1(5),PTA(5),BGTA(4),
     &          P1IN(4),P2IN(4),P1OUT(4),P2OUT(4),IMCORR(2)

      DATA LMSSG /.TRUE./

      IREJ  = 0
      NFSP  = 0
      KCORR = 0
      IMCORR(1) = 0
      IMCORR(2) = 0
      LCORR = .FALSE.

*   dump initial particles for energy-momentum cons. check
      IF (LEMCCK) THEN
         CALL EVTEMC(PPR(1),PPR(2),PPR(3),PPR(4),1,IDUM,IDUM)
         CALL EVTEMC(PTA(1),PTA(2),PTA(3),PTA(4),2,IDUM,IDUM)
      ENDIF

      AMP2 = PPR(4)**2-PPR(1)**2-PPR(2)**2-PPR(3)**2
      AMT2 = PTA(4)**2-PTA(1)**2-PTA(2)**2-PTA(3)**2
      IF ((AMP2.LT.ZERO).OR.(AMT2.LT.ZERO).OR.
     &    (ABS(AMP2-AAM(IDPR)**2).GT.TINY5).OR.
     &    (ABS(AMT2-AAM(IDTA)**2).GT.TINY5)) THEN
C        IF (LMSSG)
C    &   WRITE(LOUT,1000) AMP2,AAM(IDPR)**2,AMT2,AAM(IDTA)**2
 1000    FORMAT(1X,'HADRIN:   warning! inconsistent projectile/target',
     &          ' mass',/,20X,'AMP2 = ',E12.4,', AAM(IDPR)**2 = ',
     &          E12.4,/,20X,'AMT2 = ',E12.4,', AAM(IDTA)**2 = ',E12.4)
         LMSSG = .FALSE.
         LCORR = .TRUE.
      ENDIF

* convert initial state particles into particles which can be
* handled by HADRIN
      IDHPR = IDPR
      IDHTA = IDTA
      IF ((IDHPR.LE.0).OR.(IDHPR.GE.111).OR.(LCORR)) THEN
         IF ((IDHPR.LE.0).OR.(IDHPR.GE.111)) IDHPR = 1
         DO 1 K=1,4
            P1IN(K) = PPR(K)
            P2IN(K) = PTA(K)
    1    CONTINUE
         XM1 = AAM(IDHPR)
         XM2 = AAM(IDHTA)
         CALL MASHEL(P1IN,P2IN,XM1,XM2,P1OUT,P2OUT,IREJ1)
         IF (IREJ1.GT.0) THEN
C           WRITE(LOUT,'(1X,A)') 'HADRIN:   inconsistent mass trsf.'
            GOTO 9999
         ENDIF
         DO 2 K=1,4
            PPR(K) = P1OUT(K)
            PTA(K) = P2OUT(K)
    2    CONTINUE
      PPR(5)=SQRT(MAX(0D0,(PPR(4)+PPR(3))*(PPR(4)-PPR(3))-PPR(2)**
     * 2-PPR(1)**2))
      PTA(5)=SQRT(MAX(0D0,(PTA(4)+PTA(3))*(PTA(4)-PTA(3))-PTA(2)**
     * 2-PTA(1)**2))
      ENDIF

* Lorentz-parameter for trafo into rest-system of target
      DO 3 K=1,4
         BGTA(K) = PTA(K)/PTA(5)
    3 CONTINUE
* transformation of projectile into rest-system of target
      CALL DALTRA(BGTA(4),-BGTA(1),-BGTA(2),-BGTA(3),PPR(1),PPR(2),
     &            PPR(3),PPR(4),PPRTO1,PPR1(1),PPR1(2),PPR1(3),
     &            PPR1(4))

* direction cosines of projectile in target rest system
      CX = PPR1(1)/PPRTO1
      CY = PPR1(2)/PPRTO1
      CZ = PPR1(3)/PPRTO1

* sample inelastic interaction
      IF (MODE.EQ.1) THEN
         CALL DHADRI(IDHPR,PPRTO1,PPR1(4),CX,CY,CZ,IDHTA)
         IF (IRH.EQ.1)THEN
C	   WRITE(6,'(A)')' DHADRI Rej'
	   GOTO 9998
	 ENDIF
* sample elastic interaction
      ELSEIF (MODE.EQ.2) THEN
         CALL ELHAIN(IDHPR,PPRTO1,PPR1(4),CX,CY,CZ,IDHTA,IREJ1)
         IF (IREJ1.NE.0) THEN
C           WRITE(LOUT,*) 'rejected 1 in HADRIN'
            GOTO 9999
         ENDIF
         IF (IRH.EQ.1) GOTO 9998
      ELSE
C        WRITE(LOUT,1001) MODE,INTHAD
 1001    FORMAT(1X,'HADRIN:   warning! inconsistent interaction mode',
     &          I4,' (INTHAD =',I4,')')
         GOTO 9999
      ENDIF

* transform final state particles back into Lab.
      DO 4 I=1,IRH
         NFSP = NFSP+1
         PX   = CXRH(I)*PLRH(I)
         PY   = CYRH(I)*PLRH(I)
         PZ   = CZRH(I)*PLRH(I)
         CALL DALTRA(BGTA(4),BGTA(1),BGTA(2),BGTA(3),PX,PY,PZ,ELRH(I),
     &               PTOFSP,PFSP(1,NFSP),PFSP(2,NFSP),PFSP(3,NFSP),
     &               PFSP(4,NFSP))
         IDFSP(NFSP) = ITRH(I)
         AMFSP2 = PFSP(4,NFSP)**2-PFSP(1,NFSP)**2-PFSP(2,NFSP)**2-
     &                                            PFSP(3,NFSP)**2
         IF (AMFSP2.LT.-TINY3) THEN
C           WRITE(LOUT,1002) IDFSP(NFSP),PFSP(1,NFSP),PFSP(2,NFSP),
C    &                       PFSP(3,NFSP),PFSP(4,NFSP),AMFSP2
 1002       FORMAT(1X,'HADRIN:   warning! final state particle (id = ',
     &             I2,') with negative mass^2',/,1X,5E12.4)
            GOTO 9999
         ELSE
            PFSP(5,NFSP) = SQRT(ABS(AMFSP2))
            IF (ABS(PFSP(5,NFSP)-AAM(IDFSP(NFSP))).GT.TINY1) THEN
C              WRITE(LOUT,1003) IDFSP(NFSP),AAM(IDFSP(NFSP)),
C    &                          PFSP(5,NFSP)
 1003          FORMAT(1X,'HADRIN:   warning! final state particle',
     &                ' (id = ',I2,') with inconsistent mass',/,1X,
     &                2E12.4)
               KCORR         = KCORR+1
               IF (KCORR.GT.2) GOTO 9999
               IMCORR(KCORR) = NFSP
            ENDIF
         ENDIF
*   dump final state particles for energy-momentum cons. check
         IF (LEMCCK) CALL EVTEMC(-PFSP(1,I),-PFSP(2,I),
     &                           -PFSP(3,I),-PFSP(4,I),2,IDUM,IDUM)
    4 CONTINUE

* transform momenta on mass shell in case of inconsistencies in
* HADRIN
      IF (KCORR.GT.0) THEN
         IF (KCORR.EQ.2) THEN
            I1 = IMCORR(1)
            I2 = IMCORR(2)
         ELSE
            IF (IMCORR(1).EQ.1) THEN
               I1 = 1
               I2 = 2
            ELSE
               I1 = 1
               I2 = IMCORR(1)
            ENDIF
         ENDIF
         IF (LEMCCK) CALL EVTEMC(PFSP(1,I1),PFSP(2,I1),
     &                           PFSP(3,I1),PFSP(4,I1),2,IDUM,IDUM)
         IF (LEMCCK) CALL EVTEMC(PFSP(1,I2),PFSP(2,I2),
     &                           PFSP(3,I2),PFSP(4,I2),2,IDUM,IDUM)
         DO 5 K=1,4
            P1IN(K) = PFSP(K,I1)
            P2IN(K) = PFSP(K,I2)
    5    CONTINUE
         XM1 = AAM(IDFSP(I1))
         XM2 = AAM(IDFSP(I2))
         CALL MASHEL(P1IN,P2IN,XM1,XM2,P1OUT,P2OUT,IREJ1)
         IF (IREJ1.GT.0) THEN
C           WRITE(LOUT,'(1X,A)') 'HADRIN:   inconsistent mass trsf.'
            GOTO 9999
         ENDIF
         DO 6 K=1,4
            PFSP(K,I1) = P1OUT(K)
            PFSP(K,I2) = P2OUT(K)
    6    CONTINUE
         PFSP(5,I1) = SQRT(PFSP(4,I1)**2-PFSP(1,I1)**2
     &                    -PFSP(2,I1)**2-PFSP(3,I1)**2)
         PFSP(5,I2) = SQRT(PFSP(4,I2)**2-PFSP(1,I2)**2
     &                    -PFSP(2,I2)**2-PFSP(3,I2)**2)
*   dump final state particles for energy-momentum cons. check
         IF (LEMCCK) CALL EVTEMC(-PFSP(1,I1),-PFSP(2,I1),
     &                           -PFSP(3,I1),-PFSP(4,I1),2,IDUM,IDUM)
         IF (LEMCCK) CALL EVTEMC(-PFSP(1,I2),-PFSP(2,I2),
     &                           -PFSP(3,I2),-PFSP(4,I2),2,IDUM,IDUM)
      ENDIF

* check energy-momentum conservation
      IF (LEMCCK) THEN
         CALL EVTEMC(DUM,DUM,DUM,DUM,4,102,IREJ1)
         IF (IREJ1.NE.0)THEN 
C	   WRITE(6,'(A)')' EVTEMC-HADRIN Rej'
	   GOTO 9999
         ENDIF
      ENDIF

      RETURN

 9998 CONTINUE
      IREJ = 2
      RETURN

 9999 CONTINUE
      IREJ = 1
      RETURN
      END
*
*===evtput=============================================================*
*
      SUBROUTINE EVTPUT(IST,ID,M1,M2,PX,PY,PZ,E,IDR,IDXR,IDC)

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY10=1.0D-10,TINY4=1.0D-4,TINY3=1.0D-3,
     &           TINY2=1.0D-2,SQTINF=1.0D+15,ZERO=0.D0)

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)

      COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)
C     WRITE(6,'(A,4I5,4F10.3,3I5)')
C    &' EVTPUT, IST,ID,M1,M2,PX,PY,PZ,E,IDR,IDXR,IDC',
C    & IST,ID,M1,M2,PX,PY,PZ,E,IDR,IDXR,IDC

C     IF (MODE.GT.100) THEN
C        WRITE(LOUT,'(1X,A,I5,A,I5)')
C    &        'EVTPUT: reset NHKK = ',NHKK,' to NHKK =',NHKK-MODE+100
C        NHKK = NHKK-MODE+100
C        RETURN
C     ENDIF
      MO1  = M1
      MO2  = M2
      NHKK = NHKK+1

      IF (NHKK.GT.NMXHKK) THEN
         WRITE(LOUT,1000) NHKK
 1000    FORMAT(1X,'EVTPUT: NHKK exeeds NMXHKK = ',I7,
     &             '! program execution stopped..')
         STOP
      ENDIF
      IF (M1.LT.0) MO1 = NHKK+M1
      IF (M2.LT.0) MO2 = NHKK+M2
      ISTHKK(NHKK)   = IST
      IDHKK(NHKK)    = ID      
      JMOHKK(1,NHKK) = MO1
      JMOHKK(2,NHKK) = MO2
      JDAHKK(1,NHKK) = 0
      JDAHKK(2,NHKK) = 0
      IDRES(NHKK)    = IDR
      IDXRES(NHKK)   = IDXR
      IDCH(NHKK)     = IDC
      IF (ID.EQ.88888.OR.ID.EQ.88887.OR.ID.EQ.88889) THEN
         IDMO1 = ABS(IDHKK(MO1))
         IDMO2 = ABS(IDHKK(MO2))
         IF ((IDMO1.LT.100).AND.(IDMO2.LT.100)) NOBAM(NHKK) = 3
         IF ((IDMO1.LT.100).AND.(IDMO2.GT.100)) NOBAM(NHKK) = 4
         IF ((IDMO1.GT.100).AND.(IDMO2.GT.100)) NOBAM(NHKK) = 5
         IF ((IDMO1.GT.100).AND.(IDMO2.LT.100)) NOBAM(NHKK) = 6
      ELSE
         NOBAM(NHKK) = 0
      ENDIF
      IDBAM(NHKK) = ICIHAD(ID)
      IF (MO1.GT.0) THEN
         IF (JDAHKK(1,MO1).NE.0) THEN
            JDAHKK(2,MO1) = NHKK
         ELSE
            JDAHKK(1,MO1) = NHKK
         ENDIF
      ENDIF
      IF (MO2.GT.0) THEN
         IF (JDAHKK(1,MO2).NE.0) THEN
            JDAHKK(2,MO2) = NHKK
         ELSE
            JDAHKK(1,MO2) = NHKK
         ENDIF
      ENDIF
C     WRITE(6,'(A,2I10)')' EVTPUT:NHKK,IDBAM(NHKK)',NHKK,IDBAM(NHKK)
      IF(IDBAM(NHKK).EQ.410)IDBAM(NHKK)=210
      IF (IDBAM(NHKK).GT.0) THEN
         PTOT   = SQRT(PX**2+PY**2+PZ**2)
         AM0    = SQRT(ABS( (E-PTOT)*(E+PTOT) ))
         AMRQ   = AAM(IDBAM(NHKK))
         AMDIF2 = (AM0-AMRQ)*(AM0+AMRQ)
         IF ((ABS(AMDIF2).GT.TINY3).AND.(E.LT.SQTINF).AND.
     &       (PTOT.GT.ZERO)) THEN
            DELTA = -AMDIF2/(2.0D0*(E+PTOT))
C           DELTA = (AMRQ2-AM2)/(2.0D0*(E+PTOT))
            E     = E+DELTA
            PTOT1 = PTOT-DELTA
            PX    = PX*PTOT1/PTOT
            PY    = PY*PTOT1/PTOT
            PZ    = PZ*PTOT1/PTOT
         ENDIF
      ENDIF
      PHKK(1,NHKK) = PX
      PHKK(2,NHKK) = PY
      PHKK(3,NHKK) = PZ
      PHKK(4,NHKK) = E
      PTOT = SQRT( PX**2+PY**2+PZ**2 )
      PHKK(5,NHKK) = (PHKK(4,NHKK)-PTOT)*(PHKK(4,NHKK)+PTOT)
C     IF ((PHKK(5,NHKK).LT.0.0D0).AND.(ABS(PHKK(5,NHKK)).GT.TINY4))
C    &   WRITE(LOUT,'(1X,A,G10.3)')
C    &     'EVTPUT: negative mass**2 ',PHKK(5,NHKK)
C     IF (ID.EQ.88888) THEN
      PHKK(5,NHKK) = SQRT(ABS(PHKK(5,NHKK)))
      IF (ID.EQ.88888.OR.ID.EQ.88887.OR.ID.EQ.88889) THEN
* special treatment for chains:
*    z coordinate of chain in Lab  = pos. of target nucleon
*    time of chain-creation in Lab = time of passage of projectile
*                                    nucleus at pos. of taget nucleus
C        VHKK(1,NHKK) = 0.5D0*(VHKK(1,MO1)+VHKK(1,MO2))
C        VHKK(2,NHKK) = 0.5D0*(VHKK(2,MO1)+VHKK(2,MO2))
         VHKK(1,NHKK) = VHKK(1,MO2)
         VHKK(2,NHKK) = VHKK(2,MO2)
         VHKK(3,NHKK) = VHKK(3,MO2)
         VHKK(4,NHKK) = VHKK(3,MO2)/BLAB-VHKK(3,MO1)/BGLAB
C        WHKK(1,NHKK) = 0.5D0*(WHKK(1,MO1)+WHKK(1,MO2))
C        WHKK(2,NHKK) = 0.5D0*(WHKK(2,MO1)+WHKK(2,MO2))
         WHKK(1,NHKK) = WHKK(1,MO1)
         WHKK(2,NHKK) = WHKK(2,MO1)
         WHKK(3,NHKK) = WHKK(3,MO1)
         WHKK(4,NHKK) = -WHKK(3,MO1)/BLAB+WHKK(3,MO2)/BGLAB
      ELSE
         DO 2 I=1,4
            VHKK(I,NHKK) = VHKK(I,MO1)
            WHKK(I,NHKK) = WHKK(I,MO1)
    2    CONTINUE
      ENDIF

      RETURN
      END
*
*===mashel=============================================================*
*
      SUBROUTINE MASHEL(PA1,PA2,XM1,XM2,P1,P2,IREJ)

************************************************************************
*                                                                      *
*    rescaling of momenta of two partons to put both                   *
*                                       on mass shell                  *
*                                                                      *
*    input:       PA1,PA2   input momentum vectors                     *
*                 XM1,2     desired masses of particles afterwards     *
*                 P1,P2     changed momentum vectors                   *
*                                                                      *
* The original version is written by R. Engel.                         *
* This version dated 19.11.95 is modified by S. Roesler.               *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY10=1.0D-10,ONE=1.0D0,ZERO=0.0D0)

      DIMENSION PA1(4),PA2(4),P1(4),P2(4)

      IREJ = 0

* Lorentz transformation into system CMS
      PX  = PA1(1)+PA2(1)
      PY  = PA1(2)+PA2(2)
      PZ  = PA1(3)+PA2(3)
      EE  = PA1(4)+PA2(4)
      XPTOT = SQRT(PX**2+PY**2+PZ**2)
      XMS   = (EE-XPTOT)*(EE+XPTOT)
      IF(XMS.LT.(XM1+XM2)**2) THEN
C        WRITE(LOUT,'(A,3E12.4)')' MASHEL Rej',XMS,XM1,XM2
         GOTO 9999
      ENDIF
      XMS = SQRT(XMS)
      BGX = PX/XMS
      BGY = PY/XMS
      BGZ = PZ/XMS
      GAM = EE/XMS
      CALL DALTRA(GAM,-BGX,-BGY,-BGZ,PA1(1),PA1(2),PA1(3),
     &           PA1(4),PTOT1,P1(1),P1(2),P1(3),P1(4))
* rotation angles
      COD = P1(3)/PTOT1
      SID = SQRT((ONE-COD)*(ONE+COD))
      COF = ONE
      SIF = ZERO
      IF(PTOT1*SID.GT.TINY10) THEN
         COF   = P1(1)/(SID*PTOT1)
         SIF   = P1(2)/(SID*PTOT1)
         ANORF = SQRT(COF*COF+SIF*SIF)
         COF   = COF/ANORF
         SIF   = SIF/ANORF
      ENDIF
* new CM momentum and energies (for masses XM1,XM2)
      XM12 = XM1**2
      XM22 = XM2**2
      SS   = XMS**2
      PCMP = YLAMB(SS,XM12,XM22)/(2.D0*XMS)
      EE1  = SQRT(XM12+PCMP**2)
      EE2  = XMS-EE1
* back rotation
      MODE = 1
      CALL MYTRAN(MODE,ZERO,ZERO,PCMP,COD,SID,COF,SIF,XX,YY,ZZ)
      CALL DALTRA(GAM,BGX,BGY,BGZ,XX,YY,ZZ,EE1,
     &            PTOT1,P1(1),P1(2),P1(3),P1(4))
      CALL DALTRA(GAM,BGX,BGY,BGZ,-XX,-YY,-ZZ,EE2,
     &            PTOT2,P2(1),P2(2),P2(3),P2(4))
* check consistency
      DEL = XMS*0.0001D0
      IF (ABS(PX-P1(1)-P2(1)).GT.DEL) THEN
        IDEV = 1
      ELSEIF (ABS(PY-P1(2)-P2(2)).GT.DEL) THEN
        IDEV = 2
      ELSEIF (ABS(PZ-P1(3)-P2(3)).GT.DEL) THEN
        IDEV = 3
      ELSEIF (ABS(EE-P1(4)-P2(4)).GT.DEL) THEN
        IDEV = 4
      ELSE
        IDEV = 0
      ENDIF
      IF (IDEV.NE.0) THEN
         WRITE(LOUT,'(/1X,A,I3)')
     &      'MASHEL: inconsistent transformation',IDEV
         WRITE(LOUT,'(1X,A)') 'MASHEL: input momenta/masses:'
         WRITE(LOUT,'(1X,5E12.5)') (PA1(K),K=1,4),XM1
         WRITE(LOUT,'(1X,5E12.5)') (PA2(K),K=1,4),XM2
         WRITE(LOUT,'(1X,A)') 'MASHEL: output momenta:'
         WRITE(LOUT,'(5X,4E12.5)') (P1(K),K=1,4)
         WRITE(LOUT,'(5X,4E12.5)') (P2(K),K=1,4)
      ENDIF
      RETURN

 9999 CONTINUE
      IREJ = 1
      RETURN
      END
*
*===mytran=============================================================*
*
      SUBROUTINE MYTRAN(IMODE,XO,YO,ZO,CDE,SDE,CFE,SFE,X,Y,Z)

************************************************************************
* This subroutine rotates the coordinate frame                         *
*    a) theta  around y                                                *
*    b) phi    around z      if IMODE = 1                              *
*                                                                      *
*     x'          cos(ph) -sin(ph) 0      cos(th)  0  sin(th)   x      *
*     y' = A B =  sin(ph) cos(ph)  0  .   0        1        0   y      *
*     z'          0       0        1     -sin(th)  0  cos(th)   z      *
*                                                                      *
* and vice versa if IMODE = 0.                                         *
* This version dated 5.4.94 is based on the original version DTRAN     *
* by J. Ranft and is written by S. Roesler.                            *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)

      IF (IMODE.EQ.1) THEN
         X= CDE*CFE*XO-SFE*YO+SDE*CFE*ZO
         Y= CDE*SFE*XO+CFE*YO+SDE*SFE*ZO
         Z=-SDE    *XO       +CDE    *ZO
      ELSE
         X= CDE*CFE*XO+CDE*SFE*YO-SDE*ZO
         Y= -SFE*XO+CFE*YO
         Z= SDE*CFE*XO+SDE*SFE*YO+CDE*ZO
      ENDIF
      RETURN
      END
*
*===ylamb==============================================================*
*
      DOUBLE PRECISION FUNCTION YLAMB(X,Y,Z)

************************************************************************
*                                                                      *
*     auxiliary function for three particle decay mode                 *
*     (standard LAMBDA**(1/2) function)                                *
*                                                                      *
* Adopted from an original version written by R. Engel.                *
* This version dated 12.12.94 is written by S. Roesler.                *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE

      YZ   = Y-Z
      XLAM = X*X-2.D0*X*(Y+Z)+YZ*YZ
      IF (XLAM.LE.0.D0) XLAM = ABS(XLAM)
      YLAMB = SQRT(XLAM)

      RETURN
      END
*
*===evtemc=============================================================*
*
      SUBROUTINE EVTEMC(PXIO,PYIO,PZIO,EIO,IMODE,IPOS,IREJ)

************************************************************************
* This version dated 19.11.94 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY1=1.0D-1,TINY2=1.0D-2,TINY4=1.0D-4,TINY10=1.0D-10,
     &           ZERO=0.0D0,TINY11=300.D0)

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI
      COMMON /TMPEMC/ PX,PY,PZ,E
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      DATA INII/0/

      IREJ = 0

      MODE = IMODE
      CHKLEV = TINY10
      CHKLXV=TINY11
      IF (MODE.EQ.4) THEN
         CHKLEV = TINY2
         MODE   = 3
      ELSEIF (MODE.EQ.5) THEN
         CHKLEV = TINY1
         MODE   = 3
      ELSEIF (MODE.EQ.-1) THEN
         CHKLEV = EIO
         MODE   = 3
**sr mod. for DPMJET: set check-level to some fixed value
*                     i.e. final state momentum is allowed to differ
*                     from the inital one by 50GeV (!!!)
C                     This was necessary to see wether the old
C                     version would work at all at high energy
C                     but it did not!
         CHKLXV = TINY11
         CHKLEV = CHKLXV
**
      ENDIF

      IF (ABS(MODE).EQ.3) THEN
         PXDEV = PX
         PYDEV = PY
         PZDEV = PZ
         EDEV  = E
         IF ((IFRAG(1).EQ.2).AND.(CHKLEV.LT.TINY4)) CHKLEV = TINY4
**sr mod. for DPMJET: use DPMJET check-level
	 IF ( IT.GE.200.AND.IP.GE.200)GO TO 9998
         IF ((ABS(PXDEV).GT.CHKLXV).OR.(ABS(PYDEV).GT.CHKLXV).OR.
     &       (ABS(PZDEV).GT.CHKLXV).OR.(ABS(EDEV).GT.CHKLXV)) THEN
**
	    INII=INII+1
	    IF(INII.LE.-10)THEN
            WRITE(LOUT,'(1X,A,I4,A,I6,A,/,4G10.3)')
     &         'EVTEMC: energy-momentum cons. failure at pos. ',IPOS,
     &         '  event  ',NEVHKK,
     &         ' ! ',PXDEV,PYDEV,PZDEV,EDEV
**sr mod. for DPMJET: additional output
      WRITE(6,'(A/4E12.3,3I5)')
     * ' Input values (PXIO,PYIO,PZIO,EIO,IMODE,IPOS,IREJ)',
     * PXIO,PYIO,PZIO,EIO,IMODE,IPOS,IREJ
      WRITE(6,'(A/4E12.3)')
     * ' Input values in /TMPEMC/ (PX,PY,PZ,E)',
     * PX,PY,PZ,E
       ENDIF
**
            PX   = 0.0D0
            PY   = 0.0D0
            PZ   = 0.0D0
            E    = 0.0D0
            GOTO 9999
         ENDIF
 9998    CONTINUE
         PX   = 0.0D0
         PY   = 0.0D0
         PZ   = 0.0D0
         E    = 0.0D0
         RETURN
      ENDIF

      IF (MODE.EQ.1) THEN
         PX = 0.0D0
         PY = 0.0D0
         PZ = 0.0D0
         E  = 0.0D0
      ENDIF

      PX = PX+PXIO
      PY = PY+PYIO
      PZ = PZ+PZIO
      E  = E+EIO

      RETURN

 9999 CONTINUE
      IREJ = 1
      RETURN
      END
*
*===ltrans=============================================================*
*
      SUBROUTINE LTRANS(PXI,PYI,PZI,PEI,PXO,PYO,PZO,PEO,ID,MODE)
 
************************************************************************
* Special Lorentz-transformations.                                     *
*   MODE = 1(-1)    projectile rest syst.   --> Lab (back)             *
*        = 2(-2)    projectile rest syst.   --> nucl.-nucl.cms (back)  *
*        = 3(-3)    target rest syst. (=Lab)--> nucl.-nucl.cms (back)  *
* This version dated 01.11.95 is written by  S. Roesler.               *
************************************************************************
 
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY3=1.0D-3,ZERO=0.0D0,TWO=2.0D0)
 
      PARAMETER (SQTINF=1.0D+15)
 
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)
 
      PXO = PXI
      PYO = PYI
      CALL LTNUC(PZI,PEI,PZO,PEO,MODE)
 
* check particle mass for consistency (numerical rounding errors)
      PO     = SQRT(PXO**2+PYO**2+PZO**2)
      AMO2   = (PEO-PO)*(PEO+PO)
      AMORQ2 = AAM(ID)**2
      AMDIF2 = ABS(AMO2-AMORQ2)
      IF ((AMDIF2.GT.TINY3).AND.(PEO.LT.SQTINF).AND.(PO.GT.ZERO)) THEN
         DELTA = (AMORQ2-AMO2)/(TWO*(PEO+PO))
         PEO   = PEO+DELTA
         PO1   = PO -DELTA
         PXO   = PXO*PO1/PO
         PYO   = PYO*PO1/PO
         PZO   = PZO*PO1/PO
      ENDIF
 
      RETURN
      END
*
*===ltnuc==============================================================*
*
      SUBROUTINE LTNUC(PIN,EIN,POUT,EOUT,MODE)

************************************************************************
* Lorentz-transformations.                                             *
*   PIN        longitudnal momentum       (input)                      *
*   EIN        energy                     (input)                      *
*   POUT       transformed long. momentum (output)                     *
*   EOUT       transformed energy         (output)                     *
*   MODE = 1(-1)    projectile rest syst.   --> Lab (back)             *
*        = 2(-2)    projectile rest syst.   --> nucl.-nucl.cms (back)  *
*        = 3(-3)    target rest syst. (=Lab)--> nucl.-nucl.cms (back)  *
* This version dated 01.11.95 is written by  S. Roesler.               *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (ZERO=0.0D0)

      COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,ECM,PCM,EPROJ,PPROJ

      IF (ABS(MODE).EQ.1) THEN
C        BG = -SIGN(BGLAB,DBLE(MODE))
              BG = -DSIGN(BGLAB,DBLE(MODE))
         CALL DALTRA(GALAB,ZERO,ZERO,-BG,ZERO,ZERO,PIN,EIN,
     &                               DUM,DUM,DUM,POUT,EOUT)
      ELSEIF (ABS(MODE).EQ.2) THEN
C        BG = SIGN(BGCMS,DBLE(MODE))
              BG = DSIGN(BGCMS,DBLE(MODE))
         CALL DALTRA(GACMS,ZERO,ZERO,BG,ZERO,ZERO,PIN,EIN,
     &                                 DUM,DUM,DUM,POUT,EOUT)
      ELSEIF (ABS(MODE).EQ.3) THEN
C        BG = -SIGN(BGCMS,DBLE(MODE))
              BG = -DSIGN(BGCMS,DBLE(MODE))
         CALL DALTRA(GACMS,ZERO,ZERO,BG,ZERO,ZERO,PIN,EIN,
     &                               DUM,DUM,DUM,POUT,EOUT)
      ELSE
         WRITE(LOUT,1000) MODE
 1000    FORMAT(1X,'LTNUC: not supported mode (MODE = ',I3,')')
         EOUT = EIN
         POUT = PIN
      ENDIF

      RETURN
      END
**sr mod. for DPMJET: short version of the original DTUNUC-routine
*
*===evtini=============================================================*
*
      SUBROUTINE EVTINI(ID,IP,IT,EPN,PPN,ECM,NHKKH1,MODE)

************************************************************************
* Initialization of HKKEVT.                                            *
* This version dated 19.11.95 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)

      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
      COMMON /NSTARI/NSTART

      GOTO (1,2) MODE

    1 CONTINUE
* initialization of EXTEVT
      DO 10 I=1,NHKK
         IDRES(I)  = 0
         IDXRES(I) = 0
         NOBAM(I)  = 0
         IDCH(I)   = 0
   10 CONTINUE
      CALL LTINI(ID,EPN,PPN,ECM)
C        IF(NSTART.NE.2.AND.NEUDEC.GE.20)
C    &	 CALL LTINI(IJPROJ,EPNI,DUM1,DUM2)

      RETURN 

    2 CONTINUE
      DO 20 I=1,NHKK
* get BAMJET-index of final state particle 
         IDBAM(I) = MCIHAD(IDHKK(I))
   20 CONTINUE
      NPOINT(1) = IP+IT+1
      NPOINT(4) = NHKKH1+1

      RETURN
      END
*
*===ltini==============================================================*
*
      SUBROUTINE LTINI(IDP,EPN,PPN,ECM)

************************************************************************
* Initializations of Lorentz-transformations, calculation of Lorentz-  *
* parameters.                                                          *
* This version dated 13.11.95 is written by  S. Roesler.               *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY3=1.0D-3,ZERO=0.0D0,ONE=1.0D0,TWO=2.0D0)

      COMMON /NUCCMS/ GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
**sr mod. for DPMJET: common added
      COMMON /TRAFOP/ GAMP,BGAMP,BETP
**
      CHARACTER*8  ANAME
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

**sr mod. for DPMJET: force calulation starting from EPN
      ECM = ZERO
      PPN = ZERO
**
      IF (ECM.GT.ZERO) THEN
         EPN = (ECM**2-AAM(IDP)**2-AAM(1)**2)/(2.0D0*AAM(1))
         PPN = SQRT((EPN-AAM(IDP))*(EPN+AAM(IDP)))
      ELSE
         IF ((EPN.NE.ZERO).AND.(PPN.EQ.ZERO)) THEN
            IF (EPN.LT.ZERO) EPN = ABS(EPN)+AAM(IDP)
            PPN = SQRT((EPN-AAM(IDP))*(EPN+AAM(IDP)))
         ELSEIF ((PPN.GT.ZERO).AND.(EPN.EQ.ZERO)) THEN
            EPN = PPN*SQRT(ONE+(AAM(IDP)/PPN)**2)
         ENDIF
         ECM = SQRT(AAM(IDP)**2+AAM(1)**2+2.0D0*AAM(1)*EPN)
      ENDIF
      UMO   = ECM
      EPROJ = EPN
      PPROJ = PPN
*   Lorentz-parameter for transformation Lab. - projectile rest system
      IF(AAM(IDP).GT.0.D0)THEN
      GALAB = EPROJ/AAM(IDP)
      BGLAB = PPROJ/AAM(IDP)
      ELSE
      GALAB = EPROJ/(AAM(IDP)+0.0001D0)
      BGLAB = PPROJ/(AAM(IDP)+0.0001D0)
      ENDIF
      BLAB  = BGLAB/GALAB
*   Lorentz-parameter for transformation Lab. - nucl.-nucl. cms.
      GACMS = (EPROJ+AAM(1))/UMO
      BGCMS = PPROJ/UMO
      PCM   = GACMS*PPROJ-BGCMS*EPROJ
**sr mod. for DPMJET: initialize /TRAFOP/
      GAMP  = GALAB
      BGAMP = BGLAB
      BETP  = BGAMP/GAMP
**
C     WRITE(6,*)
C    &'IDP,EPN,PPN,ECM',IDP,EPN,PPN,ECM 
C     WRITE(6,*)
C    &'GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ',
C    &GACMS,BGCMS,GALAB,BGLAB,BLAB,UMO,PCM,EPROJ,PPROJ
C     WRITE(6,*)' GAMP,BGAMP,BETP',GAMP,BGAMP,BETP

      RETURN
      END
*                                                                      *
*=== energy ===========================================================*
*                                                                      *
      DOUBLE PRECISION FUNCTION ENERGY (A,Z)
 
C     INCLUDE '(DBLPRC)'
*$ CREATE DBLPRC.ADD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER ( KALGNM = 2 )
      PARAMETER ( ANGLGB = 5.0D-16 )
      PARAMETER ( ANGLSQ = 2.5D-31 )
      PARAMETER ( AXCSSV = 0.2D+16 )
      PARAMETER ( ANDRFL = 1.0D-38 )
      PARAMETER ( AVRFLW = 1.0D+38 )
      PARAMETER ( AINFNT = 1.0D+30 )
      PARAMETER ( AZRZRZ = 1.0D-30 )
      PARAMETER ( EINFNT = +69.07755278982137 D+00 )
      PARAMETER ( EZRZRZ = -69.07755278982137 D+00 )
      PARAMETER ( ONEMNS = 0.999999999999999  D+00 )
      PARAMETER ( ONEPLS = 1.000000000000001  D+00 )
      PARAMETER ( CSNNRM = 2.0D-15 )
      PARAMETER ( DMXTRN = 1.0D+08 )
      PARAMETER ( ZERZER = 0.D+00 )
      PARAMETER ( ONEONE = 1.D+00 )
      PARAMETER ( TWOTWO = 2.D+00 )
      PARAMETER ( THRTHR = 3.D+00 )
      PARAMETER ( FOUFOU = 4.D+00 )
      PARAMETER ( FIVFIV = 5.D+00 )
      PARAMETER ( SIXSIX = 6.D+00 )
      PARAMETER ( SEVSEV = 7.D+00 )
      PARAMETER ( EIGEIG = 8.D+00 )
      PARAMETER ( ANINEN = 9.D+00 )
      PARAMETER ( TENTEN = 10.D+00 )
      PARAMETER ( HLFHLF = 0.5D+00 )
      PARAMETER ( ONETHI = ONEONE / THRTHR )
      PARAMETER ( TWOTHI = TWOTWO / THRTHR )
      PARAMETER ( ONEFOU = ONEONE / FOUFOU )
      PARAMETER ( THRTWO = THRTHR / TWOTWO )
      PARAMETER ( PIPIPI = 3.141592653589793238462643383279D+00 )
      PARAMETER ( TWOPIP = 6.283185307179586476925286766559D+00 )
      PARAMETER ( PIP5O2 = 7.853981633974483096156608458199D+00 )
      PARAMETER ( PIPISQ = 9.869604401089358618834490999876D+00 )
      PARAMETER ( PIHALF = 1.570796326794896619231321691640D+00 )
      PARAMETER ( ERFA00 = 0.886226925452758013649083741671D+00 )
      PARAMETER ( ENEPER = 2.718281828459045235360287471353D+00 )
      PARAMETER ( SQRENT = 1.648721270700128146848650787814D+00 )
      PARAMETER ( SQRSIX = 2.449489742783178098197284074706D+00 )
      PARAMETER ( SQRSEV = 2.645751311064590590501615753639D+00 )
      PARAMETER ( SQRT12 = 3.464101615137754587054892683012D+00 )
      PARAMETER ( CLIGHT = 2.99792458         D+10 )
      PARAMETER ( AVOGAD = 6.0221367          D+23 )
      PARAMETER ( BOLTZM = 1.380658           D-23 )
      PARAMETER ( AMELGR = 9.1093897          D-28 )
      PARAMETER ( PLCKBR = 1.05457266         D-27 )
      PARAMETER ( ELCCGS = 4.8032068          D-10 )
      PARAMETER ( ELCMKS = 1.60217733         D-19 )
      PARAMETER ( AMUGRM = 1.6605402          D-24 )
      PARAMETER ( AMMUMU = 0.113428913        D+00 )
      PARAMETER ( AMPRMU = 1.007276470        D+00 )
      PARAMETER ( AMNEMU = 1.008664904        D+00 )
      PARAMETER ( ALPFSC = 7.2973530791728595 D-03 )
      PARAMETER ( FSCTO2 = 5.3251361962113614 D-05 )
      PARAMETER ( FSCTO3 = 3.8859399018437826 D-07 )
      PARAMETER ( FSCTO4 = 2.8357075508200407 D-09 )
      PARAMETER ( PLABRC = 0.197327053        D+00 )
      PARAMETER ( AMELCT = 0.51099906         D-03 )
      PARAMETER ( AMUGEV = 0.93149432         D+00 )
      PARAMETER ( AMMUON = 0.105658389        D+00 )
      PARAMETER ( AMPRTN = 0.93827231         D+00 )
      PARAMETER ( AMNTRN = 0.93956563         D+00 )
      PARAMETER ( AMDEUT = 1.87561339         D+00 )
      PARAMETER ( COUGFM = ELCCGS * ELCCGS / ELCMKS * 1.D-07 * 1.D+13
     &                   * 1.D-09 )
      PARAMETER ( RCLSEL = 2.8179409183694872 D-13 )
      PARAMETER ( BLTZMN = 8.617385           D-14 )
      PARAMETER ( GEVMEV = 1.0                D+03 )
      PARAMETER ( EMVGEV = 1.0                D-03 )
      PARAMETER ( ALGVMV = 6.90775527898214   D+00 )
      PARAMETER ( RADDEG = 180.D+00 / PIPIPI )
      PARAMETER ( DEGRAD = PIPIPI / 180.D+00 )
      LOGICAL LGBIAS, LGBANA
      COMMON / GLOBAL / LGBIAS, LGBANA
C     INCLUDE '(DIMPAR)'
*$ CREATE DIMPAR.ADD
      PARAMETER ( MXXRGN = 5000 )
      PARAMETER ( MXXMDF = 56   )
      PARAMETER ( MXXMDE = 50   )
      PARAMETER ( MFSTCK = 1000 )
      PARAMETER ( MESTCK = 100  )
      PARAMETER ( NALLWP = 39   )
      PARAMETER ( MPDPDX = 8    )
      PARAMETER ( ICOMAX = 180  )
      PARAMETER ( NSTBIS = 304  )
      PARAMETER ( IDMAXP = 210  )
      PARAMETER ( IDMXDC = 620  )
      PARAMETER ( MKBMX1 = 1    )
      PARAMETER ( MKBMX2 = 1    )
C     INCLUDE '(IOUNIT)'
*$ CREATE IOUNIT.ADD
      PARAMETER ( LUNIN  = 5  )
      PARAMETER ( LUNOUT = 6  )
      PARAMETER ( LUNERR = 15 )
      PARAMETER ( LUNBER = 14 )
      PARAMETER ( LUNECH = 8  )
      PARAMETER ( LUNFLU = 13 )
      PARAMETER ( LUNGEO = 16 )
      PARAMETER ( LUNPGS = 12 )
      PARAMETER ( LUNRAN = 2  )
      PARAMETER ( LUNXSC = 9  )
      PARAMETER ( LUNDET = 17 )
      PARAMETER ( LUNRAY = 10 )
      PARAMETER ( LUNRDB = 1  )
*
*----------------------------------------------------------------------*
*                                                                      *
*     Revised version of the original routine from EVAP:               *
*                                                                      *
*     Created on   15 may 1990     by    Alfredo Ferrari & Paola Sala  *
*                                                   Infn - Milan       *
*                                                                      *
*     Last change on 01-oct-94     by    Alfredo Ferrari               *
*                                                                      *
*     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!     *
*     !!!  It is supposed to be used with the updated atomic   !!!     *
*     !!!                    mass data file                    !!!     *
*     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!     *
*                                                                      *
*----------------------------------------------------------------------*
*
*  Mass number below which "unknown" isotopes out of the Z-interval
*  reported in the mass tabulations are completely unstable and made
*  up by Z proton masses + N neutron masses:
      PARAMETER ( KAFREE =  4 )
*  Mass number below which "unknown" isotopes out of the Z-interval
*  reported in the mass tabulations are supposed to be particle unstable
      PARAMETER ( KAPUNS = 12 )
*  Minimum energy required for partilce unstable isotopes
      PARAMETER ( DEPUNS = 0.5D+00 )
*
C     INCLUDE '(EVA0)'
*$ CREATE EVA0.ADD
      COMMON / EVA0 / Y0, B0, P0 (1001), P1 (1001), P2 (1001),
     *                FLA (6), FLZ (6), RHO (6), OMEGA (6), EXMASS (6),
     *                CAM2 (130), CAM3 (200), CAM4 (130), CAM5 (200),
     *                T (4,7), RMASS (297), ALPH (297), BET (297),
     *                APRIME (250), IA (6), IZ (6)
C     INCLUDE '(ISOTOP)'
*$ CREATE ISOTOP.ADD
      PARAMETER ( NAMSMX = 270 )
      PARAMETER ( NZGVAX =  15 )
      PARAMETER ( NISMMX = 574 )
      COMMON / ISOTOP / WAPS   (NAMSMX,NZGVAX),  T12NUC (NAMSMX,NZGVAX),
     &                  WAPISM (NISMMX), T12ISM (NISMMX),
     &                  ABUISO (NSTBIS), ASTLIN (2,100), ZSTLIN (2,260),
     &                  AMSSST (100)  , ISOMNM (NSTBIS), ISONDX (2,100),
     &                  JSPNUC (NAMSMX,NZGVAX), JPTNUC (NAMSMX,NZGVAX),
     &                  INWAPS (NAMSMX), JSPISM (NISMMX),
     &                  JPTISM (NISMMX), IZWISM (NISMMX),
     &                  INWISM (0:NAMSMX)
*
ctp060123      SAVE KA0, KZ0, IZ0
      DATA KA0, KZ0, IZ0 / -1, -1, -1 /
*
      KA0 = NINT ( A )
      KZ0 = NINT ( Z )
      N   = KA0 - KZ0
*  +-------------------------------------------------------------------*
*  |  Only protons:
      IF ( N .LE. 0 ) THEN
         IF ( KA0 .NE. 1 ) THEN
            IF ( N .LT. 0 ) THEN
               WRITE ( LUNOUT, * )
     &      ' FLUKA stopped in energy: mass number =< atomic number !!',
     &        KA0, KZ0
               WRITE ( LUNOUT, * )
     &      ' FLUKA stopped in energy: mass number =< atomic number !!',
     &        KA0, KZ0
               WRITE ( 77, * )
     &   ' ^^^FLUKA stopped in energy: mass number =< atomic number !!',
     &        KA0, KZ0
               STOP 'ENERGY:KA0-KZ0'
            END IF
         ELSE
            ENERGY = WAPS ( 1, 2 )
            IZ0    = -1
            RETURN
         END IF
      END IF
*  |
*  +-------------------------------------------------------------------*
*  +-------------------------------------------------------------------*
*  |
*  |
*  +-------------------------------------------------------------------*
*  +-------------------------------------------------------------------*
*  |  A larger than maximum allowed:
      IF ( KA0 .GT. NAMSMX ) THEN
         ENERGY = ENRG ( A, Z )
         IZ0    = -1
         RETURN
      END IF
*  |
*  +-------------------------------------------------------------------*
      IZZ = INWAPS ( KA0 )
*  +-------------------------------------------------------------------*
*  |  Too much neutron rich with respect to the stability line:
      IF ( KZ0 .LT. IZZ ) THEN
*  |  +----------------------------------------------------------------*
*  |  |  Up to A=Kafree all "bound" masses are known, set it unbound:
         IF ( KA0 .LE. KAFREE ) THEN
            ENERGY = ( A - Z ) * WAPS (1,1) + Z * WAPS (1,2)
*  |  |
*  |  +----------------------------------------------------------------*
*  |  |  Up to Kapuns: be sure it is particle unstable
         ELSE IF ( KA0 .LE. KAPUNS ) THEN
            ENERGY = ENRG ( A, Z )
            JZZ    = INWAPS ( KA0 - 1 )
            LZZ    = INWAPS ( KA0 - 2 )
*  |  |  +-------------------------------------------------------------*
*  |  |  |  Residual mass for n-decay known:
            IF ( KZ0 .GE. JZZ .AND. KZ0 .LE. JZZ + NZGVAX - 1 ) THEN
               IZ0    = KZ0 - JZZ + 1
               ENERGY = MAX ( ENERGY, WAPS (KA0-1,IZ0) + WAPS (1,1)
     &                      + DEPUNS )
*  |  |  |
*  |  |  +-------------------------------------------------------------*
*  |  |  |  Residual mass for 2n-decay known:
            ELSE IF ( KZ0 .GE. LZZ .AND. KZ0 .LE. LZZ + NZGVAX - 1 )THEN
               IZ0    = KZ0 - LZZ + 1
               ENERGY = MAX ( ENERGY, WAPS (KA0-2,IZ0) + TWOTWO *
     &                      ( WAPS (1,1) + DEPUNS ) )
*  |  |  |
*  |  |  +-------------------------------------------------------------*
*  |  |  |  Set it unbound:
            ELSE
               ENERGY = AINFNT
            END IF
*  |  |  |
*  |  |  +-------------------------------------------------------------*
*  |  |  Be sure not to have a positive energy state:
            ENERGY = MIN ( ENERGY, (A-Z) * WAPS (1,1) + Z * WAPS (1,2) )
*  |  |
*  |  +----------------------------------------------------------------*
*  |  |  Proceed as usual:
         ELSE
            ENERGY = ENRG (A,Z)
         END IF
*  |  |
*  |  +----------------------------------------------------------------*
         IZ0    = -1
         RETURN
*  |
*  +-------------------------------------------------------------------*
*  |  Too much proton rich with respect to the stability line:
      ELSE IF ( KZ0 .GT. IZZ + NZGVAX - 1 ) THEN
*  |  +----------------------------------------------------------------*
*  |  |  Up to A=Kafree all "bound" masses are known, set it unbound:
         IF ( KA0 .LE. KAFREE ) THEN
            ENERGY = ( A - Z ) * WAPS (1,1) + Z * WAPS (1,2)
*  |  |
*  |  +----------------------------------------------------------------*
*  |  |  Up to Kapuns: be sure it is particle unstable
         ELSE IF ( KA0 .LE. KAPUNS ) THEN
            ENERGY = ENRG ( A, Z )
            JZZ    = INWAPS ( KA0 - 1 )
            LZZ    = INWAPS ( KA0 - 2 )
*  |  |  +-------------------------------------------------------------*
*  |  |  |  Residual mass for p-decay known:
            IF ( KZ0-1 .GE. JZZ .AND. KZ0-1 .LE. JZZ + NZGVAX - 1 ) THEN
               IZ0    = KZ0 - 1 - JZZ + 1
               ENERGY = MAX ( ENERGY, WAPS (KA0-1,IZ0) + WAPS (1,2)
     &                      + DEPUNS )
*  |  |  |
*  |  |  +-------------------------------------------------------------*
*  |  |  |  Residual mass for 2p-decay known:
            ELSE IF ( KZ0-2 .GE. LZZ .AND. KZ0-2 .LE. LZZ + NZGVAX - 1 )
     &         THEN
               IZ0    = KZ0 - 2 - LZZ + 1
               ENERGY = MAX ( ENERGY, WAPS (KA0-2,IZ0) + TWOTWO *
     &                      ( WAPS (1,2) + DEPUNS ) )
*  |  |  |
*  |  |  +-------------------------------------------------------------*
*  |  |  |  Set it unbound:
            ELSE
               ENERGY = AINFNT
            END IF
*  |  |  |
*  |  |  +-------------------------------------------------------------*
*  |  |  Be sure not to have a positive energy state:
            ENERGY = MIN ( ENERGY, (A-Z) * WAPS (1,1) + Z * WAPS (1,2) )
*  |  |
*  |  +----------------------------------------------------------------*
*  |  |  Proceed as usual:
         ELSE
            ENERGY = ENRG (A,Z)
         END IF
*  |  |
*  |  +----------------------------------------------------------------*
        IZ0    = -1
         RETURN
*  |
*  +-------------------------------------------------------------------*
*  |  Known isotope or anyway isotope "inside" the stability zone
      ELSE
         IZ0    = KZ0 - IZZ + 1
         ENERGY = WAPS ( KA0, IZ0 )
*  |  +----------------------------------------------------------------*
*  |  |  Mass not known
         IF ( ABS (ENERGY) .LT. ANGLGB .AND. (KA0 .NE. 12 .OR. KZ0
     &        .NE. 6) ) THEN
            IZ0    = -1
            ENERGY = ENRG ( A, Z )
         END IF
*  |  |
*  |  +----------------------------------------------------------------*
         RETURN
      END IF
*  |
*  +-------------------------------------------------------------------*
*=== End of Function Energy ===========================================*
*     RETURN
      END
*$ CREATE ENRG.FOR
*COPY ENRG
*                                                                      *
*=== enrg =============================================================*
*                                                                      *
      DOUBLE PRECISION FUNCTION ENRG(A,Z)
 
C     INCLUDE '(DBLPRC)'
*$ CREATE DBLPRC.ADD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER ( KALGNM = 2 )
      PARAMETER ( ANGLGB = 5.0D-16 )
      PARAMETER ( ANGLSQ = 2.5D-31 )
      PARAMETER ( AXCSSV = 0.2D+16 )
      PARAMETER ( ANDRFL = 1.0D-38 )
      PARAMETER ( AVRFLW = 1.0D+38 )
      PARAMETER ( AINFNT = 1.0D+30 )
      PARAMETER ( AZRZRZ = 1.0D-30 )
      PARAMETER ( EINFNT = +69.07755278982137 D+00 )
      PARAMETER ( EZRZRZ = -69.07755278982137 D+00 )
      PARAMETER ( ONEMNS = 0.999999999999999  D+00 )
      PARAMETER ( ONEPLS = 1.000000000000001  D+00 )
      PARAMETER ( CSNNRM = 2.0D-15 )
      PARAMETER ( DMXTRN = 1.0D+08 )
      PARAMETER ( ZERZER = 0.D+00 )
      PARAMETER ( ONEONE = 1.D+00 )
      PARAMETER ( TWOTWO = 2.D+00 )
      PARAMETER ( THRTHR = 3.D+00 )
      PARAMETER ( FOUFOU = 4.D+00 )
      PARAMETER ( FIVFIV = 5.D+00 )
      PARAMETER ( SIXSIX = 6.D+00 )
      PARAMETER ( SEVSEV = 7.D+00 )
      PARAMETER ( EIGEIG = 8.D+00 )
      PARAMETER ( ANINEN = 9.D+00 )
      PARAMETER ( TENTEN = 10.D+00 )
      PARAMETER ( HLFHLF = 0.5D+00 )
      PARAMETER ( ONETHI = ONEONE / THRTHR )
      PARAMETER ( TWOTHI = TWOTWO / THRTHR )
      PARAMETER ( ONEFOU = ONEONE / FOUFOU )
      PARAMETER ( THRTWO = THRTHR / TWOTWO )
      PARAMETER ( PIPIPI = 3.141592653589793238462643383279D+00 )
      PARAMETER ( TWOPIP = 6.283185307179586476925286766559D+00 )
      PARAMETER ( PIP5O2 = 7.853981633974483096156608458199D+00 )
      PARAMETER ( PIPISQ = 9.869604401089358618834490999876D+00 )
      PARAMETER ( PIHALF = 1.570796326794896619231321691640D+00 )
      PARAMETER ( ERFA00 = 0.886226925452758013649083741671D+00 )
      PARAMETER ( ENEPER = 2.718281828459045235360287471353D+00 )
      PARAMETER ( SQRENT = 1.648721270700128146848650787814D+00 )
      PARAMETER ( SQRSIX = 2.449489742783178098197284074706D+00 )
      PARAMETER ( SQRSEV = 2.645751311064590590501615753639D+00 )
      PARAMETER ( SQRT12 = 3.464101615137754587054892683012D+00 )
      PARAMETER ( CLIGHT = 2.99792458         D+10 )
      PARAMETER ( AVOGAD = 6.0221367          D+23 )
      PARAMETER ( BOLTZM = 1.380658           D-23 )
      PARAMETER ( AMELGR = 9.1093897          D-28 )
      PARAMETER ( PLCKBR = 1.05457266         D-27 )
      PARAMETER ( ELCCGS = 4.8032068          D-10 )
      PARAMETER ( ELCMKS = 1.60217733         D-19 )
      PARAMETER ( AMUGRM = 1.6605402          D-24 )
      PARAMETER ( AMMUMU = 0.113428913        D+00 )
      PARAMETER ( AMPRMU = 1.007276470        D+00 )
      PARAMETER ( AMNEMU = 1.008664904        D+00 )
      PARAMETER ( ALPFSC = 7.2973530791728595 D-03 )
      PARAMETER ( FSCTO2 = 5.3251361962113614 D-05 )
      PARAMETER ( FSCTO3 = 3.8859399018437826 D-07 )
      PARAMETER ( FSCTO4 = 2.8357075508200407 D-09 )
      PARAMETER ( PLABRC = 0.197327053        D+00 )
      PARAMETER ( AMELCT = 0.51099906         D-03 )
      PARAMETER ( AMUGEV = 0.93149432         D+00 )
      PARAMETER ( AMMUON = 0.105658389        D+00 )
      PARAMETER ( AMPRTN = 0.93827231         D+00 )
      PARAMETER ( AMNTRN = 0.93956563         D+00 )
      PARAMETER ( AMDEUT = 1.87561339         D+00 )
      PARAMETER ( COUGFM = ELCCGS * ELCCGS / ELCMKS * 1.D-07 * 1.D+13
     &                   * 1.D-09 )
      PARAMETER ( RCLSEL = 2.8179409183694872 D-13 )
      PARAMETER ( BLTZMN = 8.617385           D-14 )
      PARAMETER ( GEVMEV = 1.0                D+03 )
      PARAMETER ( EMVGEV = 1.0                D-03 )
      PARAMETER ( ALGVMV = 6.90775527898214   D+00 )
      PARAMETER ( RADDEG = 180.D+00 / PIPIPI )
      PARAMETER ( DEGRAD = PIPIPI / 180.D+00 )
      LOGICAL LGBIAS, LGBANA
      COMMON / GLOBAL / LGBIAS, LGBANA
C     INCLUDE '(DIMPAR)'
*$ CREATE DIMPAR.ADD
      PARAMETER ( MXXRGN = 5000 )
      PARAMETER ( MXXMDF = 56   )
      PARAMETER ( MXXMDE = 50   )
      PARAMETER ( MFSTCK = 1000 )
      PARAMETER ( MESTCK = 100  )
      PARAMETER ( NALLWP = 39   )
      PARAMETER ( MPDPDX = 8    )
      PARAMETER ( ICOMAX = 180  )
      PARAMETER ( NSTBIS = 304  )
      PARAMETER ( IDMAXP = 210  )
      PARAMETER ( IDMXDC = 620  )
      PARAMETER ( MKBMX1 = 1    )
      PARAMETER ( MKBMX2 = 1    )
C     INCLUDE '(IOUNIT)'
*$ CREATE IOUNIT.ADD
      PARAMETER ( LUNIN  = 5  )
      PARAMETER ( LUNOUT = 6  )
      PARAMETER ( LUNERR = 15 )
      PARAMETER ( LUNBER = 14 )
      PARAMETER ( LUNECH = 8  )
      PARAMETER ( LUNFLU = 13 )
      PARAMETER ( LUNGEO = 16 )
      PARAMETER ( LUNPGS = 12 )
      PARAMETER ( LUNRAN = 2  )
      PARAMETER ( LUNXSC = 9  )
      PARAMETER ( LUNDET = 17 )
      PARAMETER ( LUNRAY = 10 )
      PARAMETER ( LUNRDB = 1  )
*
*----------------------------------------------------------------------*
*                                                                      *
*     Revised version of the original routine from EVAP:               *
*                                                                      *
*     Created on   15 may 1990     by    Alfredo Ferrari & Paola Sala  *
*                                                   Infn - Milan       *
*                                                                      *
*     Last change on 01-oct-94     by    Alfredo Ferrari               *
*                                                                      *
*     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!     *
*     !!!  It is supposed to be used with the updated atomic   !!!     *
*     !!!                    mass data file                    !!!     *
*     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!     *
*                                                                      *
*----------------------------------------------------------------------*
*
      PARAMETER ( O16OLD = 931.145  D+00 )
      PARAMETER ( O16NEW = 931.19826D+00 )
      PARAMETER ( O16RAT = O16NEW / O16OLD )
      PARAMETER ( C12NEW = 931.49432D+00 )
      PARAMETER ( ADJUST = -8.322737768178909D-02 )
C     INCLUDE '(EVA0)'
*$ CREATE EVA0.ADD
      COMMON / EVA0 / Y0, B0, P0 (1001), P1 (1001), P2 (1001),
     *                FLA (6), FLZ (6), RHO (6), OMEGA (6), EXMASS (6),
     *                CAM2 (130), CAM3 (200), CAM4 (130), CAM5 (200),
     *                T (4,7), RMASS (297), ALPH (297), BET (297),
     *                APRIME (250), IA (6), IZ (6)
      LOGICAL LFIRST
ctp060123      SAVE LFIRST, EXHYDR, EXNEUT
      DATA LFIRST / .TRUE. /
      DATA NERG1/ 0/
*
      IF ( LFIRST ) THEN
         LFIRST = .FALSE.
         EXHYDR = ENERGY ( ONEONE, ONEONE )
         EXNEUT = ENERGY ( ONEONE, ZERZER )
      END IF
      IZ0 = NINT (Z)
      IF ( IZ0 .LE. 0 ) THEN
         ENRG = A * EXNEUT
         RETURN
      END IF
      IF (A .EQ. 0.D0)THEN
	WRITE (6,'(A)')' ENRG A=0.'
	ENRG = 0
	RETURN
      ENDIF
      N   = NINT (A-Z)
      IF ( N .LE. 0 ) THEN
         ENRG = Z * EXHYDR
         RETURN
      END IF
      AM2ZOA= (A-Z-Z)/A
      AM2ZOA=AM2ZOA*AM2ZOA
      A13 = RMASS(NINT(A))
*     A13 = A**.3333333333333333D+00
      IF(A13 .EQ. 0.D0) THEN
	NERG1=NERG1+1
	IF(NERG1.LE.10)THEN
          WRITE (6,'(A)')' ENRG A13=0.'
        ENDIF
	ENRG = 0
	RETURN
      ENDIF
      AM13 = 1.D+00/A13
      EV=-17.0354D+00*(1.D+00 -1.84619 D+00*AM2ZOA)*A
      ES= 25.8357D+00*(1.D+00 -1.712185D+00*AM2ZOA)*
     &    (1.D+00 -0.62025D+00*AM13*AM13)*
     &    (A13*A13 -.62025D+00)
      EC= 0.799D+00*Z*(Z-1.D+00)*AM13*(((1.5772D+00*AM13 +1.2273D+00)*
     &    AM13-1.5849D+00)*
     &    AM13*AM13 +1.D+00)
      EEX= -0.4323D+00*AM13*Z**1.3333333D+00*
     &   (((0.49597D+00*AM13 -0.14518D+00)*AM13 -0.57811D+00) * AM13
     &   + 1.D+00)
      ENRG  =8.367D+00*A -0.783D+00*Z +EV +ES +EC +EEX+CAM2(IZ0)+CAM3(N)
      ENRG  = ( ENRG + A * O16OLD ) * O16RAT - A * ( C12NEW - ADJUST )
      ENRG  = MIN ( ENRG, Z * EXHYDR + ( A - Z ) * EXNEUT )
      RETURN
*=== End of function Enrg =============================================*
      END
*$ CREATE BERTTP.FOR
*COPY BERTTP
*                                                                      *
*=== berttp ===========================================================*
*                                                                      *
      SUBROUTINE BERTTP
C     INCLUDE '(DBLPRC)'
*$ CREATE DBLPRC.ADD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER ( KALGNM = 2 )
      PARAMETER ( ANGLGB = 5.0D-16 )
      PARAMETER ( ANGLSQ = 2.5D-31 )
      PARAMETER ( AXCSSV = 0.2D+16 )
      PARAMETER ( ANDRFL = 1.0D-38 )
      PARAMETER ( AVRFLW = 1.0D+38 )
      PARAMETER ( AINFNT = 1.0D+30 )
      PARAMETER ( AZRZRZ = 1.0D-30 )
      PARAMETER ( EINFNT = +69.07755278982137 D+00 )
      PARAMETER ( EZRZRZ = -69.07755278982137 D+00 )
      PARAMETER ( ONEMNS = 0.999999999999999  D+00 )
      PARAMETER ( ONEPLS = 1.000000000000001  D+00 )
      PARAMETER ( CSNNRM = 2.0D-15 )
      PARAMETER ( DMXTRN = 1.0D+08 )
      PARAMETER ( ZERZER = 0.D+00 )
      PARAMETER ( ONEONE = 1.D+00 )
      PARAMETER ( TWOTWO = 2.D+00 )
      PARAMETER ( THRTHR = 3.D+00 )
      PARAMETER ( FOUFOU = 4.D+00 )
      PARAMETER ( FIVFIV = 5.D+00 )
      PARAMETER ( SIXSIX = 6.D+00 )
      PARAMETER ( SEVSEV = 7.D+00 )
      PARAMETER ( EIGEIG = 8.D+00 )
      PARAMETER ( ANINEN = 9.D+00 )
      PARAMETER ( TENTEN = 10.D+00 )
      PARAMETER ( HLFHLF = 0.5D+00 )
      PARAMETER ( ONETHI = ONEONE / THRTHR )
      PARAMETER ( TWOTHI = TWOTWO / THRTHR )
      PARAMETER ( ONEFOU = ONEONE / FOUFOU )
      PARAMETER ( THRTWO = THRTHR / TWOTWO )
      PARAMETER ( PIPIPI = 3.141592653589793238462643383279D+00 )
      PARAMETER ( TWOPIP = 6.283185307179586476925286766559D+00 )
      PARAMETER ( PIP5O2 = 7.853981633974483096156608458199D+00 )
      PARAMETER ( PIPISQ = 9.869604401089358618834490999876D+00 )
      PARAMETER ( PIHALF = 1.570796326794896619231321691640D+00 )
      PARAMETER ( ERFA00 = 0.886226925452758013649083741671D+00 )
      PARAMETER ( ENEPER = 2.718281828459045235360287471353D+00 )
      PARAMETER ( SQRENT = 1.648721270700128146848650787814D+00 )
      PARAMETER ( SQRSIX = 2.449489742783178098197284074706D+00 )
      PARAMETER ( SQRSEV = 2.645751311064590590501615753639D+00 )
      PARAMETER ( SQRT12 = 3.464101615137754587054892683012D+00 )
      PARAMETER ( CLIGHT = 2.99792458         D+10 )
      PARAMETER ( AVOGAD = 6.0221367          D+23 )
      PARAMETER ( BOLTZM = 1.380658           D-23 )
      PARAMETER ( AMELGR = 9.1093897          D-28 )
      PARAMETER ( PLCKBR = 1.05457266         D-27 )
      PARAMETER ( ELCCGS = 4.8032068          D-10 )
      PARAMETER ( ELCMKS = 1.60217733         D-19 )
      PARAMETER ( AMUGRM = 1.6605402          D-24 )
      PARAMETER ( AMMUMU = 0.113428913        D+00 )
      PARAMETER ( AMPRMU = 1.007276470        D+00 )
      PARAMETER ( AMNEMU = 1.008664904        D+00 )
      PARAMETER ( ALPFSC = 7.2973530791728595 D-03 )
      PARAMETER ( FSCTO2 = 5.3251361962113614 D-05 )
      PARAMETER ( FSCTO3 = 3.8859399018437826 D-07 )
      PARAMETER ( FSCTO4 = 2.8357075508200407 D-09 )
      PARAMETER ( PLABRC = 0.197327053        D+00 )
      PARAMETER ( AMELCT = 0.51099906         D-03 )
      PARAMETER ( AMUGEV = 0.93149432         D+00 )
      PARAMETER ( AMMUON = 0.105658389        D+00 )
      PARAMETER ( AMPRTN = 0.93827231         D+00 )
      PARAMETER ( AMNTRN = 0.93956563         D+00 )
      PARAMETER ( AMDEUT = 1.87561339         D+00 )
      PARAMETER ( COUGFM = ELCCGS * ELCCGS / ELCMKS * 1.D-07 * 1.D+13
     &                   * 1.D-09 )
      PARAMETER ( RCLSEL = 2.8179409183694872 D-13 )
      PARAMETER ( BLTZMN = 8.617385           D-14 )
      PARAMETER ( GEVMEV = 1.0                D+03 )
      PARAMETER ( EMVGEV = 1.0                D-03 )
      PARAMETER ( ALGVMV = 6.90775527898214   D+00 )
      PARAMETER ( RADDEG = 180.D+00 / PIPIPI )
      PARAMETER ( DEGRAD = PIPIPI / 180.D+00 )
      LOGICAL LGBIAS, LGBANA
      COMMON / GLOBAL / LGBIAS, LGBANA
C     INCLUDE '(DIMPAR)'
*$ CREATE DIMPAR.ADD
      PARAMETER ( MXXRGN = 5000 )
      PARAMETER ( MXXMDF = 56   )
      PARAMETER ( MXXMDE = 50   )
      PARAMETER ( MFSTCK = 1000 )
      PARAMETER ( MESTCK = 100  )
      PARAMETER ( NALLWP = 39   )
      PARAMETER ( MPDPDX = 8    )
      PARAMETER ( ICOMAX = 180  )
      PARAMETER ( NSTBIS = 304  )
      PARAMETER ( IDMAXP = 210  )
      PARAMETER ( IDMXDC = 620  )
      PARAMETER ( MKBMX1 = 1    )
      PARAMETER ( MKBMX2 = 1    )
C     INCLUDE '(IOUNIT)'
*$ CREATE IOUNIT.ADD
      PARAMETER ( LUNIN  = 5  )
      PARAMETER ( LUNOUT = 6  )
      PARAMETER ( LUNERR = 15 )
      PARAMETER ( LUNBER = 14 )
      PARAMETER ( LUNECH = 8  )
      PARAMETER ( LUNFLU = 13 )
      PARAMETER ( LUNGEO = 16 )
      PARAMETER ( LUNPGS = 12 )
      PARAMETER ( LUNRAN = 2  )
      PARAMETER ( LUNXSC = 9  )
      PARAMETER ( LUNDET = 17 )
      PARAMETER ( LUNRAY = 10 )
      PARAMETER ( LUNRDB = 1  )
C---------------------------------------------------------------------
C SUBNAME = BERTTP --- READ BERTINI DATA
C---------------------------------------------------------------------
C     ---------------------------------- I-N-C DATA
C     COMMON R8(2127),R4(64),CRSC(600,4),R8B(336),CS(29849)
C     REAL*8 R8,R8B,CRSC,CS
C     REAL*4 R4
C     --------------------------------- EVAPORATION DATA
C     INCLUDE '(COOKCM)'
*$ CREATE COOKCM.ADD
      PARAMETER ( ASMTOG = SIXSIX / PIPIPI**2 )
      LOGICAL LDEFOZ, LDEFON
      PARAMETER ( INCOOK = 150, IZCOOK = 98 )
      COMMON / COOKCM / ALPIGN, BETIGN, GAMIGN, POWIGN,
     &                SZCOOK (IZCOOK), SNCOOK (INCOOK), PZCOOK (IZCOOK),
     &                PNCOOK (INCOOK), LDEFOZ (IZCOOK), LDEFON (INCOOK)
C     INCLUDE '(EVA0)'
*$ CREATE EVA0.ADD
      COMMON / EVA0 / Y0, B0, P0 (1001), P1 (1001), P2 (1001),
     *                FLA (6), FLZ (6), RHO (6), OMEGA (6), EXMASS (6),
     *                CAM2 (130), CAM3 (200), CAM4 (130), CAM5 (200),
     *                T (4,7), RMASS (297), ALPH (297), BET (297),
     *                APRIME (250), IA (6), IZ (6)
C     INCLUDE '(FRBKCM)'
*$ CREATE FRBKCM.ADD
      PARAMETER ( MXFFBK =     6 )
      PARAMETER ( MXZFBK =     9 )
      PARAMETER ( MXNFBK =    10 )
      PARAMETER ( MXAFBK =    16 )
      PARAMETER ( NXZFBK = MXZFBK + MXFFBK / 3 )
      PARAMETER ( NXNFBK = MXNFBK + MXFFBK / 3 )
      PARAMETER ( NXAFBK = MXAFBK + 1 )
      PARAMETER ( MXPSST =   300 )
      PARAMETER ( MXPSFB = 41000 )
      LOGICAL LFRMBK, LNCMSS
      COMMON / FRBKCM /  AMUFBK, EEXFBK (MXPSST), AMFRBK (MXPSST),
     &          EXFRBK (MXPSFB), SDMFBK (MXPSFB), COUFBK (MXPSFB),
     &          EXMXFB, R0FRBK, R0CFBK, C1CFBK, C2CFBK,
     &          IFRBKN (MXPSST), IFRBKZ (MXPSST),
     &          IFBKSP (MXPSST), IFBKPR (MXPSST), IFBKST (MXPSST),
     &          IPSIND (0:MXNFBK,0:MXZFBK,2), JPSIND (0:MXAFBK),
     &          IFBIND (0:NXNFBK,0:NXZFBK,2), JFBIND (0:NXAFBK),
     &          IFBCHA (5,MXPSFB), IPOSST, IPOSFB, IFBSTF,
     &          IFBFRB, NBUFBK, LFRMBK, LNCMSS
C     INCLUDE '(HETTP)'
*$ CREATE HETTP.ADD
      COMMON /HETTP/  NHSTP,NBERTP,IOSUB,INSRS
C     INCLUDE '(INPFLG)'
*$ CREATE INPFLG.ADD
      COMMON /INPFLG/ IANG,IFISS,IB0,IGEOM,ISTRAG,KEYDK
C     INCLUDE '(ISOTOP)'
*$ CREATE ISOTOP.ADD
      PARAMETER ( NAMSMX = 270 )
      PARAMETER ( NZGVAX =  15 )
      PARAMETER ( NISMMX = 574 )
      COMMON / ISOTOP / WAPS   (NAMSMX,NZGVAX),  T12NUC (NAMSMX,NZGVAX),
     &                  WAPISM (NISMMX), T12ISM (NISMMX),
     &                  ABUISO (NSTBIS), ASTLIN (2,100), ZSTLIN (2,260),
     &                  AMSSST (100)  , ISOMNM (NSTBIS), ISONDX (2,100),
     &                  JSPNUC (NAMSMX,NZGVAX), JPTNUC (NAMSMX,NZGVAX),
     &                  INWAPS (NAMSMX), JSPISM (NISMMX),
     &                  JPTISM (NISMMX), IZWISM (NISMMX),
     &                  INWISM (0:NAMSMX)
C     INCLUDE '(NUCGEO)'
*$ CREATE NUCGEO.ADD
      PARAMETER ( PI     = PIPIPI )
      PARAMETER ( PISQ   = PIPISQ )
      PARAMETER ( SKTOHL = 0.5456645846610345D+00 )
      PARAMETER ( RZNUCL = 1.12        D+00 )
      PARAMETER ( RMSPRO = 0.8         D+00 )
      PARAMETER ( R0PROT = RMSPRO / SQRT12  )
      PARAMETER ( ARHPRO = 1.D+00 / 8.D+00 / PI / R0PROT / R0PROT
     &          / R0PROT )
      PARAMETER ( RLLE04 = RZNUCL )
      PARAMETER ( RLLE16 = RZNUCL )
      PARAMETER ( RLGT16 = RZNUCL )
      PARAMETER ( RCLE04 = 0.75D+00 / PI / RLLE04 / RLLE04 / RLLE04 )
      PARAMETER ( RCLE16 = 0.75D+00 / PI / RLLE16 / RLLE16 / RLLE16 )
      PARAMETER ( RCGT16 = 0.75D+00 / PI / RLGT16 / RLGT16 / RLGT16 )
      PARAMETER ( SKLE04 = 1.4D+00 )
      PARAMETER ( SKLE16 = 1.9D+00 )
      PARAMETER ( SKGT16 = 2.4D+00 )
      PARAMETER ( HLLE04 = SKTOHL * SKLE04 )
      PARAMETER ( HLLE16 = SKTOHL * SKLE16 )
      PARAMETER ( HLGT16 = SKTOHL * SKGT16 )
      PARAMETER ( ALPHA0 = 0.1D+00 )
      PARAMETER ( OMALH0 = 1.D+00 - ALPHA0 )
      PARAMETER ( GAMSK0 = 0.9D+00 )
      PARAMETER ( OMGAS0 = 1.D+00 - GAMSK0 )
      PARAMETER ( POTME0 = 0.6666666666666667D+00 )
      PARAMETER ( POTBA0 = 1.D+00 )
      PARAMETER ( PNFRAT = 1.533D+00 )
      PARAMETER ( RADPIM = 0.035D+00 )
      PARAMETER ( RDPMHL = 14.D+00   )
      PARAMETER ( APMRST = 4.D+00 / 44.D+00 )
      PARAMETER ( APMPRO = 1.D+00 / 6.D+00 )
      PARAMETER ( APPPRO = 5.D+00 / 6.D+00 )
      PARAMETER ( AP0PFS = 0.5D+00 )
      PARAMETER ( AP0PFP = 1.D+00 / 3.D+00 )
      PARAMETER ( AP0NFP = 2.D+00 / 3.D+00 )
      PARAMETER ( XPAUCO = 1.88495407241652 D+00 )
      PARAMETER ( MXSCIN = 50     )
      LOGICAL LABRST, LELSTC, LINELS, LCHEXC, LABSRP, LABSTH, LPREEQ,
     &        LNPHTC, LNWRAD, LPNRHO
      COMMON / NUCGID / RHOTAB (2:260), RHATAB (2:260), ALPTAB (2:260),
     &                  RADTAB (2:260), SKITAB (2:260), HALTAB (2:260),
     &                  SK3TAB (2:260), SK4TAB (2:260), HABTAB (2:260),
     &                  CWSTAB (2:260), EKATAB (2:260), PFATAB (2:260),
     &                  PFRTAB (2:260)
      COMMON / NUCGEO / RADTOT, RADIU1, RADIU0, RAD1O2, SKINDP, HALODP,
     &                  ALPHAL, OMALHL, RADSKN, SKNEFF, CPARWS, RADPRO,
     &                  RADCOR, RADCO2, RADMAX, BIMPTR, RIMPTR, XIMPTR,
     &                  YIMPTR, ZIMPTR, RHOIMT, EKFPRO, PFRPRO, RHOCEN,
     &                  RHOCOR, RHOSKN, EKFCEN (2), PFRCEN (2), EKFBIM,
     &                  PFRBIM, RHOIMP, EKFIMP, PFRIMP, RHOIM2, EKFIM2,
     &                  PFRIM2, RHOIM3, EKFIM3, PFRIM3, VPRWLL, RIMPCT,
     &                  BIMPCT, XIMPCT, YIMPCT, ZIMPCT, RIMPC2, XIMPC2,
     &                  YIMPC2, ZIMPC2, RIMPC3, XIMPC3, YIMPC3, ZIMPC3,
     &                  XBIMPC, YBIMPC, ZBIMPC, CXIMPC, CYIMPC, CZIMPC,
     &                  SQRIMP, SIGMAP, SIGMAN, SIGMAA, RHORED, R0TRAJ,
     &                  R1TRAJ, SBUSED, SBTOT , SBRES , RHOAVE, EKFAVE,
     &                  PFRAVE, AVEBIN, ACOLL , ZCOLL , RADSIG, OPACTY,
     &                  EKECON, PNUCCO, EKEWLL, PPRWLL, PXPROJ, PYPROJ,
     &                  PZPROJ, EKFERM, PNFRMI, PXFERM, PYFERM, PZFERM,
     &                  EKFER2, PNFRM2, PXFER2, PYFER2, PZFER2, EKFER3,
     &                  PNFRM3, PXFER3, PYFER3, PZFER3, RHOMEM, EKFMEM,
     &                  BIMMEM, WLLRED, VPRBIM, POTINC, POTOUT, EEXMIN
      COMMON / NUCGE2 / RDTTNC (2), RHONCP (2), RHONC2 (2), RHONC3 (2),
     &                  RHONCT (2), AMOTHR, EKOTHR, AMCREA, EKNCLN,
     &                  EEXDEL, EEXANY, CLMBBR, RDCLMB, BFCLMB, BFCEFF,
     &                  BNPROJ, BNDNUC, DEBRLM, SK4PAR, UBIMPC, VBIMPC,
     &                  WBIMPC, BNDPOT, SIGMAT, SIGABP, SIGABN, WLLRES,
     &                  POTBAR, POTMES, AGEPRI, OPNOPA,
     &                  BNENRG (3), DEFNUC (2), SIGMPR (4), SIGMNU (4),
     &                  SIGPAB (3), SIGNAB (3), HHLP   (2), FORTOT (2),
     &                  IPWELL, ITNCMX, KPRIN , NTARGT, KNUCIM, KNUCI2,
     &                  KNUCI3, IEVPRE, ISFCOL, ISFTAR, ISFTA2, ISFTA3,
     &                  NPOTHR, ICOTHR, IBOTHR, NPUMFN, ISTNCL, ITAUCM,
     &                  IADFLG, IGSFLG, IALFLG, ICBFLG, LPREEQ, LNPHTC,
     &                  LPNRHO, LNWRAD
      COMMON / NUCPWI / ALMBAR, BIMMAX, SIGGEO, LLLMAX, LLLACT
      COMMON / NUCGII / HOLEXP (2*MXSCIN), XEXPIN (3,MXSCIN),
     &                  YEXPIN (3,MXSCIN), ZEXPIN (3,MXSCIN),
     &                  AGEXIN (MXSCIN), RHOEXP (2), EKFEXP, EHLFIX,
     &                  NHLEXP, NHLFIX, IPRTYP, NNCEXI (MXSCIN),
     &                  NCEXPI (3,MXSCIN), ISEXIN (3,MXSCIN),
     &                  ISCTYP (MXSCIN), NUSCIN, NEXPEM,
     &                  LABRST, LELSTC, LINELS, LCHEXC, LABSRP, LABSTH
      DIMENSION AWSTAB (2:260), SIGMAB (3)
      EQUIVALENCE ( DEFPRO, DEFNUC (1) )
      EQUIVALENCE ( DEFNEU, DEFNUC (2) )
      EQUIVALENCE ( RHOIPP, RHONCP (1) )
      EQUIVALENCE ( RHOINP, RHONCP (2) )
      EQUIVALENCE ( RHOIP2, RHONC2 (1) )
      EQUIVALENCE ( RHOIN2, RHONC2 (2) )
      EQUIVALENCE ( RHOIP3, RHONC3 (1) )
      EQUIVALENCE ( RHOIN3, RHONC3 (2) )
      EQUIVALENCE ( RHOIPT, RHONCT (1) )
      EQUIVALENCE ( RHOINT, RHONCT (2) )
      EQUIVALENCE ( OMALHL, SK3PAR )
      EQUIVALENCE ( ALPHAL, HABPAR )
      EQUIVALENCE ( ALPTAB (2), AWSTAB (2) )
      EQUIVALENCE ( SIGMPE, SIGMPR (1) )
      EQUIVALENCE ( SIGMPC, SIGMPR (2) )
      EQUIVALENCE ( SIGMPI, SIGMPR (3) )
      EQUIVALENCE ( SIGMPA, SIGMPR (4) )
      EQUIVALENCE ( SIGMNE, SIGMNU (1) )
      EQUIVALENCE ( SIGMNC, SIGMNU (2) )
      EQUIVALENCE ( SIGMNI, SIGMNU (3) )
      EQUIVALENCE ( SIGMNA, SIGMNU (4) )
      EQUIVALENCE ( SIGMA2, SIGPAB (1) )
      EQUIVALENCE ( SIGMA3, SIGPAB (2) )
      EQUIVALENCE ( SIGMAS, SIGPAB (3) )
      EQUIVALENCE ( SIGPAB (1), SIGMAB (1) )
C     INCLUDE '(NUCLEV)'
*$ CREATE NUCLEV.ADD
      LOGICAL LCLVSL
      COMMON / NUCLEV / PAENUC (200,2), SHENUC (200,2), DEFRMI (2),
     &                  DEFMAG (2), ENNCLV (160,2), RANCLV (160,2),
     &                  CUMRAD (0:160,2), RUSNUC (2),
     &                  ENPLVL (114), ENNLVL(164), JUSNUC (160,2),
     &                  NTANUC (2), NAVNUC (2), NLSNUC (2), NCONUC (2),
     &                  NSKNUC (2), NHANUC (2), NUSNUC (2), JMXNUC (2),
     &                  IPRNUC (3), JPRNUC (3), MAGNUM (8), MAGNUC (2),
     &                  MGSNUC (8,2), MGSSNC (25,2), NSBSHL (2),
     &                  NPRNUC, INUCLV, LCLVSL
      DIMENSION JUSPRO (160), JUSNEU (160), MGSPRO (8), MGSNEU (8),
     &          MGSSPR (19) , MGSSNE (25)
      EQUIVALENCE ( RUSNUC (1), RUSPRO )
      EQUIVALENCE ( RUSNUC (2), RUSNEU )
      EQUIVALENCE ( JUSNUC (1,1), JUSPRO (1) )
      EQUIVALENCE ( JUSNUC (1,2), JUSNEU (1) )
      EQUIVALENCE ( MGSNUC (1,1), MGSPRO (1) )
      EQUIVALENCE ( MGSNUC (1,2), MGSNEU (1) )
      EQUIVALENCE ( MGSSNC (1,1), MGSSPR (1) )
      EQUIVALENCE ( MGSSNC (1,2), MGSSNE (1) )
      EQUIVALENCE ( NTANUC (1), NTAPRO )
      EQUIVALENCE ( NTANUC (2), NTANEU )
      EQUIVALENCE ( NAVNUC (1), NAVPRO )
      EQUIVALENCE ( NAVNUC (2), NAVNEU )
      EQUIVALENCE ( NLSNUC (1), NLSPRO )
      EQUIVALENCE ( NLSNUC (2), NLSNEU )
      EQUIVALENCE ( NCONUC (1), NCOPRO )
      EQUIVALENCE ( NCONUC (2), NCONEU )
      EQUIVALENCE ( NSKNUC (1), NSKPRO )
      EQUIVALENCE ( NSKNUC (2), NSKNEU )
      EQUIVALENCE ( NHANUC (1), NHAPRO )
      EQUIVALENCE ( NHANUC (2), NHANEU )
      EQUIVALENCE ( NUSNUC (1), NUSPRO )
      EQUIVALENCE ( NUSNUC (2), NUSNEU )
      EQUIVALENCE ( JMXNUC (1), JMXPRO )
      EQUIVALENCE ( JMXNUC (2), JMXNEU )
      EQUIVALENCE ( MAGNUC (1), MAGPRO )
      EQUIVALENCE ( MAGNUC (2), MAGNEU )
C     INCLUDE '(PAREVT)'
*$ CREATE PAREVT.ADD
      PARAMETER ( FRDIFF = 0.2D+00 )
      PARAMETER ( ETHSEA = 1.0D+00 )
 
      LOGICAL LDIFFR, LINCTV, LEVPRT, LHEAVY, LDEEXG, LGDHPR, LPREEX,
     &        LHLFIX, LPRFIX, LPARWV, LPOWER, LSNGCH, LLVMOD, LSCHDF
      COMMON / PAREVT / DPOWER, FSPRD0, FSHPFN, RN1GSC, RN2GSC,
     &                  LDIFFR (NALLWP),LPOWER, LINCTV, LEVPRT, LHEAVY,
     &                  LDEEXG, LGDHPR, LPREEX, LHLFIX, LPRFIX, LPARWV,
     &                  ILVMOD, JLVMOD, LLVMOD, LSNGCH, LSCHDF
C     INCLUDE '(XSEPAR)'
*$ CREATE XSEPAR.ADD
      COMMON / XSEPAR / AANXSE (100), BBNXSE (100), CCNXSE (100),
     &                  DDNXSE (100), EENXSE (100), ZZNXSE (100),
     &                  EMNXSE (100), XMNXSE (100),
     &                  AAPXSE (100), BBPXSE (100), CCPXSE (100),
     &                  DDPXSE (100), EEPXSE (100), FFPXSE (100),
     &                  ZZPXSE (100), EMPXSE (100), XMPXSE (100)
 
C---------------------------------------------------------------------
      NBERTP=LUNBER

      WRITE( LUNOUT,'(A,I2)')
     & ' *** Reading evaporation and nuclear data from unit: ', NBERTP
      REWIND NBERTP
C A. Ferrari: first of all read isotopic data
      READ (NBERTP) ISONDX
      READ (NBERTP) ISOMNM
      READ (NBERTP) ABUISO
      DO 1 I=1,4
C        READ  (NBERTP) (CRSC(J,I),J=1,600)
C A. Ferrari: commented also the dummy read to save disk space
C        READ  (NBERTP)
    1 CONTINUE
C     READ  (NBERTP) CS
C A. Ferrari: commented also the dummy read to save disk space
C     READ  (NBERTP)
C---------------------------------------------------------------------
      READ (NBERTP) (P0(I),P1(I),P2(I),I=1,1001)
      READ (NBERTP) IA,IZ
      DO 2 I=1,6
         FLA(I)=IA(I)
         FLZ(I)=IZ(I)
    2 CONTINUE
      READ (NBERTP) RHO,OMEGA
      READ (NBERTP) EXMASS
      READ (NBERTP) CAM2
      READ (NBERTP) CAM3
      READ (NBERTP) CAM4
      READ (NBERTP) CAM5
      READ (NBERTP) ((T(I,J),J=1,7),I=1,3)
      DO 3 I=1,7
         T(4,I) = ZERZER
    3 CONTINUE
      READ (NBERTP) RMASS
      READ (NBERTP) ALPH
      READ (NBERTP) BET
      READ (NBERTP) INWAPS
      READ (NBERTP) WAPS
      READ (NBERTP) T12NUC
      READ (NBERTP) JSPNUC
      READ (NBERTP) JPTNUC
      READ (NBERTP) INWISM
      READ (NBERTP) IZWISM
      READ (NBERTP) WAPISM
      READ (NBERTP) T12ISM
      READ (NBERTP) JSPISM
      READ (NBERTP) JPTISM
      READ (NBERTP) APRIME
      WRITE( LUNOUT,'(A)' ) ' *** Evaporation: using 1977 Waps data ***'
      READ (NBERTP) AHELP , BHELP , LRMSCH, LRD1O2, LTRASP
      IF ( ABS (AHELP-ALPHA0) .GT. CSNNRM * ALPHA0 .OR.
     &     ABS (BHELP-GAMSK0) .GT. CSNNRM * GAMSK0 ) THEN
         WRITE (LUNOUT,*)
     &         ' *** Inconsistent Nuclear Geometry data on file ***'
         STOP
      END IF
      READ (NBERTP) RHOTAB, RHATAB, ALPTAB, RADTAB, SKITAB, HALTAB,
     &              EKATAB, PFATAB, PFRTAB
      READ (NBERTP) AANXSE, BBNXSE, CCNXSE, DDNXSE, EENXSE, ZZNXSE,
     &              EMNXSE, XMNXSE
      READ (NBERTP) AAPXSE, BBPXSE, CCPXSE, DDPXSE, EEPXSE, FFPXSE,
     &              ZZPXSE, EMPXSE, XMPXSE
*  Data about Fermi-breakup:
      READ (NBERTP) IPOSST, MXPDUM, MXADUM, MXNDUM, MXZDUM, IFBSTF
      IF ( MXADUM .NE. MXAFBK .OR. MXNDUM .NE. MXNFBK .OR. MXZDUM .NE.
     &     MXZFBK .OR. MXPDUM .NE. MXPSST ) THEN
         WRITE (LUNOUT,*)' *** Inconsistent Fermi BreakUp data',
     &                   ' in the Nuclear Data file ***'
         STOP 'STOP:BERTTP-INCONS-FERMI-BREAKUP-DATA'
      END IF
      READ (NBERTP) IFRBKN
      READ (NBERTP) IFRBKZ
      READ (NBERTP) IFBKSP
      READ (NBERTP) IFBKST
      READ (NBERTP) EEXFBK
      CLOSE (UNIT=NBERTP)
      DO 100 JZ = 1, 130
         SHENUC ( JZ, 1 ) = EMVGEV * ( CAM2 (JZ) + CAM4 (JZ) )
  100 CONTINUE
      DO 200 JA = 1, 200
         SHENUC ( JA, 2 ) = EMVGEV * ( CAM3 (JA) + CAM5 (JA) )
  200 CONTINUE
      CALL STALIN
      IF ( ILVMOD .LE. 0 ) THEN
         ILVMOD = IB0
      ELSE
         IB0 = ILVMOD
      END IF
      IF ( LLVMOD ) THEN
         DO 300 JZ = 1, IZCOOK
            CAM4 (JZ) = PZCOOK (JZ)
  300    CONTINUE
         DO 400 JN = 1, INCOOK
            CAM5 (JN) = PNCOOK (JZ)
  400    CONTINUE
      END IF
      WRITE (LUNOUT,*)
      IF ( ILVMOD .EQ. 1 ) THEN
         WRITE (LUNOUT,*)
     &' **** Standard EVAP T=0 level density used ****'
      ELSE IF ( ILVMOD .EQ. 2 ) THEN
         WRITE (LUNOUT,*)
     &' **** Gilbert & Cameron T=0 N,Z-dep. level density used ****'
      ELSE IF ( ILVMOD .EQ. 3 ) THEN
         WRITE (LUNOUT,*)
     &   ' **** Julich A-dependent level density used ****'
      ELSE IF ( ILVMOD .EQ. 4 ) THEN
         WRITE (LUNOUT,*)
     &' **** Brancazio & Cameron T=0 N,Z-dep. level density used ****'
      ELSE
         WRITE (LUNOUT,*)
     &' **** Unknown T=0 level density option requested ****',ILVMOD
         STOP 'BERTTP-ILVMOD'
      END IF
      IF ( JLVMOD .LE. 0 ) THEN
         GAMIGN = ZERZER
         WRITE (LUNOUT,*)
     &' **** No Excitation en. dependence for level densities ****'
      ELSE IF ( JLVMOD .EQ. 1 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 1st) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with Ignyatuk (1975, 1st) set of parameters for T=oo ****'
         GAMIGN = 0.054D+00
         BETIGN = -6.3 D-05
         ALPIGN = 0.154D+00
         POWIGN = ZERZER
      ELSE IF ( JLVMOD .EQ. 2 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 1st) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with UNKNOWN set of parameters for T=oo ****'
         STOP 'BERTTP-JLVMOD'
      ELSE IF ( JLVMOD .EQ. 3 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 1st) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with UNKNOWN set of parameters for T=oo ****'
         STOP 'BERTTP-JLVMOD'
      ELSE IF ( JLVMOD .EQ. 4 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 2nd) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with Ignyatuk (1975, 2nd) set of parameters for T=oo ****'
         GAMIGN = 0.054D+00
         BETIGN = 0.162D+00
         ALPIGN = 0.114D+00
         POWIGN = -ONETHI
      ELSE IF ( JLVMOD .EQ. 5 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 2nd) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with Iljinov & Mebel 1st set of parameters for T=oo  ****'
         GAMIGN = 0.051D+00
         BETIGN = 0.098D+00
         ALPIGN = 0.114D+00
         POWIGN = -ONETHI
      ELSE IF ( JLVMOD .EQ. 6 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 2nd) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with Iljinov & Mebel 2nd set of parameters for T=oo  ****'
         GAMIGN = -0.46D+00
         BETIGN = 0.107D+00
         ALPIGN = 0.111D+00
         POWIGN = -ONETHI
      ELSE IF ( JLVMOD .EQ. 7 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 2nd) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with Iljinov & Mebel 3rd set of parameters for T=oo  ****'
         GAMIGN = 0.059D+00
         BETIGN = 0.257D+00
         ALPIGN = 0.072D+00
         POWIGN = -ONETHI
      ELSE IF ( JLVMOD .EQ. 8 ) THEN
         WRITE (LUNOUT,*)
     &' ****   Ignyatuk (1975, 2nd) level density en. dep. used   ****'
         WRITE (LUNOUT,*)
     &' **** with Iljinov & Mebel 4th set of parameters for T=oo  ****'
         GAMIGN = -0.37D+00
         BETIGN = 0.229D+00
         ALPIGN = 0.077D+00
         POWIGN = -ONETHI
      ELSE
         WRITE (LUNOUT,*)
     &' **** Unknown T=oo level density option requested ****'
         STOP 'BERTTP-JLVMOD'
      END IF
      IF ( LLVMOD ) THEN
         WRITE (LUNOUT,*)
     &   ' **** Cook''s modified pairing energy used ****'
      ELSE
         WRITE (LUNOUT,*)
     &   ' **** Original Gilbert/Cameron pairing energy used ****'
      END IF
      ILVMOD = IB0
      DO 500 JZ = 1, 130
         PAENUC ( JZ, 1 ) = EMVGEV * CAM4 (JZ)
  500 CONTINUE
      DO 600 JA = 1, 200
         PAENUC ( JA, 2 ) = EMVGEV * CAM5 (JA)
  600 CONTINUE
      RETURN
      END
 
 
*$ CREATE INCINI.FOR
*COPY INCINI
*                                                                      *
*=== incini ===========================================================*
*                                                                      *
      SUBROUTINE INCINI
 
C     INCLUDE '(DBLPRC)'
*$ CREATE DBLPRC.ADD
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER ( KALGNM = 2 )
      PARAMETER ( ANGLGB = 5.0D-16 )
      PARAMETER ( ANGLSQ = 2.5D-31 )
      PARAMETER ( AXCSSV = 0.2D+16 )
      PARAMETER ( ANDRFL = 1.0D-38 )
      PARAMETER ( AVRFLW = 1.0D+38 )
      PARAMETER ( AINFNT = 1.0D+30 )
      PARAMETER ( AZRZRZ = 1.0D-30 )
      PARAMETER ( EINFNT = +69.07755278982137 D+00 )
      PARAMETER ( EZRZRZ = -69.07755278982137 D+00 )
      PARAMETER ( ONEMNS = 0.999999999999999  D+00 )
      PARAMETER ( ONEPLS = 1.000000000000001  D+00 )
      PARAMETER ( CSNNRM = 2.0D-15 )
      PARAMETER ( DMXTRN = 1.0D+08 )
      PARAMETER ( ZERZER = 0.D+00 )
      PARAMETER ( ONEONE = 1.D+00 )
      PARAMETER ( TWOTWO = 2.D+00 )
      PARAMETER ( THRTHR = 3.D+00 )
      PARAMETER ( FOUFOU = 4.D+00 )
      PARAMETER ( FIVFIV = 5.D+00 )
      PARAMETER ( SIXSIX = 6.D+00 )
      PARAMETER ( SEVSEV = 7.D+00 )
      PARAMETER ( EIGEIG = 8.D+00 )
      PARAMETER ( ANINEN = 9.D+00 )
      PARAMETER ( TENTEN = 10.D+00 )
      PARAMETER ( HLFHLF = 0.5D+00 )
      PARAMETER ( ONETHI = ONEONE / THRTHR )
      PARAMETER ( TWOTHI = TWOTWO / THRTHR )
      PARAMETER ( ONEFOU = ONEONE / FOUFOU )
      PARAMETER ( THRTWO = THRTHR / TWOTWO )
      PARAMETER ( PIPIPI = 3.141592653589793238462643383279D+00 )
      PARAMETER ( TWOPIP = 6.283185307179586476925286766559D+00 )
      PARAMETER ( PIP5O2 = 7.853981633974483096156608458199D+00 )
      PARAMETER ( PIPISQ = 9.869604401089358618834490999876D+00 )
      PARAMETER ( PIHALF = 1.570796326794896619231321691640D+00 )
      PARAMETER ( ERFA00 = 0.886226925452758013649083741671D+00 )
      PARAMETER ( ENEPER = 2.718281828459045235360287471353D+00 )
      PARAMETER ( SQRENT = 1.648721270700128146848650787814D+00 )
      PARAMETER ( SQRSIX = 2.449489742783178098197284074706D+00 )
      PARAMETER ( SQRSEV = 2.645751311064590590501615753639D+00 )
      PARAMETER ( SQRT12 = 3.464101615137754587054892683012D+00 )
      PARAMETER ( CLIGHT = 2.99792458         D+10 )
      PARAMETER ( AVOGAD = 6.0221367          D+23 )
      PARAMETER ( BOLTZM = 1.380658           D-23 )
      PARAMETER ( AMELGR = 9.1093897          D-28 )
      PARAMETER ( PLCKBR = 1.05457266         D-27 )
      PARAMETER ( ELCCGS = 4.8032068          D-10 )
      PARAMETER ( ELCMKS = 1.60217733         D-19 )
      PARAMETER ( AMUGRM = 1.6605402          D-24 )
      PARAMETER ( AMMUMU = 0.113428913        D+00 )
      PARAMETER ( AMPRMU = 1.007276470        D+00 )
      PARAMETER ( AMNEMU = 1.008664904        D+00 )
      PARAMETER ( ALPFSC = 7.2973530791728595 D-03 )
      PARAMETER ( FSCTO2 = 5.3251361962113614 D-05 )
      PARAMETER ( FSCTO3 = 3.8859399018437826 D-07 )
      PARAMETER ( FSCTO4 = 2.8357075508200407 D-09 )
      PARAMETER ( PLABRC = 0.197327053        D+00 )
      PARAMETER ( AMELCT = 0.51099906         D-03 )
      PARAMETER ( AMUGEV = 0.93149432         D+00 )
      PARAMETER ( AMMUON = 0.105658389        D+00 )
      PARAMETER ( AMPRTN = 0.93827231         D+00 )
      PARAMETER ( AMNTRN = 0.93956563         D+00 )
      PARAMETER ( AMDEUT = 1.87561339         D+00 )
      PARAMETER ( COUGFM = ELCCGS * ELCCGS / ELCMKS * 1.D-07 * 1.D+13
     &                   * 1.D-09 )
      PARAMETER ( RCLSEL = 2.8179409183694872 D-13 )
      PARAMETER ( BLTZMN = 8.617385           D-14 )
      PARAMETER ( GEVMEV = 1.0                D+03 )
      PARAMETER ( EMVGEV = 1.0                D-03 )
      PARAMETER ( ALGVMV = 6.90775527898214   D+00 )
      PARAMETER ( RADDEG = 180.D+00 / PIPIPI )
      PARAMETER ( DEGRAD = PIPIPI / 180.D+00 )
      LOGICAL LGBIAS, LGBANA
      COMMON / GLOBAL / LGBIAS, LGBANA
C     INCLUDE '(DIMPAR)'
*$ CREATE DIMPAR.ADD
      PARAMETER ( MXXRGN = 5000 )
      PARAMETER ( MXXMDF = 56   )
      PARAMETER ( MXXMDE = 50   )
      PARAMETER ( MFSTCK = 1000 )
      PARAMETER ( MESTCK = 100  )
      PARAMETER ( NALLWP = 39   )
      PARAMETER ( MPDPDX = 8    )
      PARAMETER ( ICOMAX = 180  )
      PARAMETER ( NSTBIS = 304  )
      PARAMETER ( IDMAXP = 210  )
      PARAMETER ( IDMXDC = 620  )
      PARAMETER ( MKBMX1 = 1    )
      PARAMETER ( MKBMX2 = 1    )
C     INCLUDE '(IOUNIT)'
*$ CREATE IOUNIT.ADD
      PARAMETER ( LUNIN  = 5  )
      PARAMETER ( LUNOUT = 6  )
      PARAMETER ( LUNERR = 15 )
      PARAMETER ( LUNBER = 14 )
      PARAMETER ( LUNECH = 8  )
      PARAMETER ( LUNFLU = 13 )
      PARAMETER ( LUNGEO = 16 )
      PARAMETER ( LUNPGS = 12 )
      PARAMETER ( LUNRAN = 2  )
      PARAMETER ( LUNXSC = 9  )
      PARAMETER ( LUNDET = 17 )
      PARAMETER ( LUNRAY = 10 )
      PARAMETER ( LUNRDB = 1  )
*
*----------------------------------------------------------------------*
*                                                                      *
*     Created on  10  june  1990   by    Alfredo Ferrari & Paola Sala  *
*                                                   Infn - Milan       *
*                                                                      *
*     Last change on 02-may-95     by    Alfredo Ferrari               *
*                                                                      *
*                                                                      *
*----------------------------------------------------------------------*
*
C     INCLUDE '(FHEAVY)'
*$ CREATE FHEAVY.ADD
      PARAMETER ( MXHEAV = 100 )
      CHARACTER*8 ANHEAV
      COMMON / FHEAVY / CXHEAV (MXHEAV), CYHEAV (MXHEAV),
     &                  CZHEAV (MXHEAV), TKHEAV (MXHEAV),
     &                  PHEAVY (MXHEAV), WHEAVY (MXHEAV),
     &                  AMHEAV  ( 12 ) , AMNHEA  ( 12 ) ,
     &                  KHEAVY (MXHEAV), ICHEAV  ( 12 ) ,
     &                  IBHEAV  ( 12 ) , NPHEAV
      COMMON / FHEAVC / ANHEAV  ( 12 )
C     INCLUDE '(INPFLG)'
*$ CREATE INPFLG.ADD
      COMMON /INPFLG/ IANG,IFISS,IB0,IGEOM,ISTRAG,KEYDK
C     INCLUDE '(FRBKCM)'
*$ CREATE FRBKCM.ADD
      PARAMETER ( MXFFBK =     6 )
      PARAMETER ( MXZFBK =     9 )
      PARAMETER ( MXNFBK =    10 )
      PARAMETER ( MXAFBK =    16 )
      PARAMETER ( NXZFBK = MXZFBK + MXFFBK / 3 )
      PARAMETER ( NXNFBK = MXNFBK + MXFFBK / 3 )
      PARAMETER ( NXAFBK = MXAFBK + 1 )
      PARAMETER ( MXPSST =   300 )
      PARAMETER ( MXPSFB = 41000 )
      LOGICAL LFRMBK, LNCMSS
      COMMON / FRBKCM /  AMUFBK, EEXFBK (MXPSST), AMFRBK (MXPSST),
     &          EXFRBK (MXPSFB), SDMFBK (MXPSFB), COUFBK (MXPSFB),
     &          EXMXFB, R0FRBK, R0CFBK, C1CFBK, C2CFBK,
     &          IFRBKN (MXPSST), IFRBKZ (MXPSST),
     &          IFBKSP (MXPSST), IFBKPR (MXPSST), IFBKST (MXPSST),
     &          IPSIND (0:MXNFBK,0:MXZFBK,2), JPSIND (0:MXAFBK),
     &          IFBIND (0:NXNFBK,0:NXZFBK,2), JFBIND (0:NXAFBK),
     &          IFBCHA (5,MXPSFB), IPOSST, IPOSFB, IFBSTF,
     &          IFBFRB, NBUFBK, LFRMBK, LNCMSS
C     INCLUDE '(NUCDAT)'
*$ CREATE NUCDAT.ADD
      PARAMETER ( AMUAMU = AMUGEV )
      PARAMETER ( AMPROT = AMPRTN )
      PARAMETER ( AMNEUT = AMNTRN )
      PARAMETER ( AMELEC = AMELCT )
      PARAMETER ( R0NUCL = 1.12        D+00 )
      PARAMETER ( RCCOUL = 1.7         D+00 )
      PARAMETER ( COULPR = COUGFM )
      PARAMETER ( FERTHO = 14.33       D-09 )
      PARAMETER ( EXPEBN = 2.39        D+00 )
      PARAMETER ( BEXC12 = FERTHO * 72.40715579499394D+00 )
      PARAMETER ( AMUC12 = AMUGEV - HLFHLF * AMELCT + BEXC12 / 12.D+00 )
      PARAMETER ( AMHYDR = AMPRTN + AMELCT  )
      PARAMETER ( AMHTON = AMHYDR - AMNTRN  )
      PARAMETER ( AMNTOU = AMNTRN - AMUC12  )
      PARAMETER ( AMUCSQ = AMUC12 * AMUC12 )
      PARAMETER ( EBNDAV = HLFHLF * (AMPRTN + AMNTRN) - AMUC12 )
      PARAMETER ( GAMMIN = 1.0D-06 )
      PARAMETER ( GAMNSQ = 2.0D+00 * GAMMIN * GAMMIN )
      PARAMETER ( TVEPSI = GAMMIN / 100.D+00 )
      COMMON /NUCDAT/ AV0WEL,     APFRMX,     AEFRMX,     AEFRMA,
     &                RDSNUC,     V0WELL (2), PFRMMX (2), EFRMMX (2),
     &                EFRMAV (2), AMNUCL (2), AMNUSQ (2), EBNDNG (2),
     &                VEFFNU (2), ESLOPE (2), PKMNNU (2), EKMNNU (2),
     &                PKMXNU (2), EKMXNU (2), EKMNAV (2), EKINAV (2),
     &                EXMNAV (2), EKUPNU (2), EXMNNU (2), EXUPNU (2),
     &                ERCLAV (2), ESWELL (2), FINCUP (2), AMRCAV    ,
     &                AMRCSQ    , ATO1O3    , ZTO1O3    , ELBNDE (0:100)
C     INCLUDE '(PAREVT)'
*$ CREATE PAREVT.ADD
      PARAMETER ( FRDIFF = 0.2D+00 )
      PARAMETER ( ETHSEA = 1.0D+00 )
 
      LOGICAL LDIFFR, LINCTV, LEVPRT, LHEAVY, LDEEXG, LGDHPR, LPREEX,
     &        LHLFIX, LPRFIX, LPARWV, LPOWER, LSNGCH, LLVMOD, LSCHDF
      COMMON / PAREVT / DPOWER, FSPRD0, FSHPFN, RN1GSC, RN2GSC,
     &                  LDIFFR (NALLWP),LPOWER, LINCTV, LEVPRT, LHEAVY,
     &                  LDEEXG, LGDHPR, LPREEX, LHLFIX, LPRFIX, LPARWV,
     &                  ILVMOD, JLVMOD, LLVMOD, LSNGCH, LSCHDF
      COMMON / NUCOLD / HELP (2), HHLP (2), FTVTH (2), FINCX (2),
     &                  EKPOLD (2), BBOLD, ZZOLD, SQROLD, ASEASQ,
     &                  FSPRED, FEX0RD
c
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*
      BBOLD  = - 1.D+10
      ZZOLD  = - 1.D+10
      SQROLD = - 1.D+10
      APFRMX = PLABRC * ( ANINEN * PIPIPI / EIGEIG )**ONETHI / R0NUCL
      AMNUCL (1) = AMPROT
      AMNUCL (2) = AMNEUT
      AMNUSQ (1) = AMPROT * AMPROT
      AMNUSQ (2) = AMNEUT * AMNEUT
      AMNHLP = HLFHLF * ( AMNUCL (1) + AMNUCL (2) )
      ASQHLP = AMNHLP**2
*     ASQHLP = HLFHLF * ( AMNUSQ (1) + AMNUSQ (2) )
      AEFRMX = SQRT ( ASQHLP + APFRMX**2 ) - AMNHLP
      AEFRMA = 0.3D+00 * APFRMX**2 / AMNHLP * ( ONEONE - APFRMX**2 /
     &         ( 5.6D+00 * ASQHLP ) )
      AV0WEL = AEFRMX + EBNDAV
      EBNDNG (1) = EBNDAV
      EBNDNG (2) = EBNDAV
      AEXC12 = EMVGEV * ENERGY ( 12.D+00, 6.D+00 )
      CEXC12 = EMVGEV * ENRG   ( 12.D+00, 6.D+00 )
      AMMC12 = 12.D+00 * AMUGEV + AEXC12
      AMNC12 = AMMC12 - 6.D+00 * AMELCT + FERTHO * 6.D+00**EXPEBN
      AEXO16 = EMVGEV * ENERGY ( 16.D+00, 8.D+00 )
      CEXO16 = EMVGEV * ENRG   ( 16.D+00, 8.D+00 )
      AMMO16 = 16.D+00 * AMUGEV + AEXO16
      AMNO16 = AMMO16 - 8.D+00 * AMELCT + FERTHO * 8.D+00**EXPEBN
      AEXS28 = EMVGEV * ENERGY ( 28.D+00, 14.D+00 )
      CEXS28 = EMVGEV * ENRG   ( 28.D+00, 14.D+00 )
      AMMS28 = 28.D+00 * AMUGEV + AEXS28
      AMNS28 = AMMS28 - 14.D+00 * AMELCT + FERTHO * 14.D+00**EXPEBN
      AEXC40 = EMVGEV * ENERGY ( 40.D+00, 20.D+00 )
      CEXC40 = EMVGEV * ENRG   ( 40.D+00, 20.D+00 )
      AMMC40 = 40.D+00 * AMUGEV + AEXC40
      AMNC40 = AMMC40 - 20.D+00 * AMELCT + FERTHO * 20.D+00**EXPEBN
      AEXF56 = EMVGEV * ENERGY ( 56.D+00, 26.D+00 )
      CEXF56 = EMVGEV * ENRG   ( 56.D+00, 26.D+00 )
      AMMF56 = 56.D+00 * AMUGEV + AEXF56
      AMNF56 = AMMF56 - 26.D+00 * AMELCT + FERTHO * 26.D+00**EXPEBN
      AEX107 = EMVGEV * ENERGY ( 107.D+00, 47.D+00 )
      CEX107 = EMVGEV * ENRG   ( 107.D+00, 47.D+00 )
      AMM107 = 107.D+00 * AMUGEV + AEX107
      AMN107 = AMM107 - 47.D+00 * AMELCT + FERTHO * 47.D+00**EXPEBN
      AEX132 = EMVGEV * ENERGY ( 132.D+00, 54.D+00 )
      CEX132 = EMVGEV * ENRG   ( 132.D+00, 54.D+00 )
      AMM132 = 132.D+00 * AMUGEV + AEX132
      AMN132 = AMM132 - 54.D+00 * AMELCT + FERTHO * 54.D+00**EXPEBN
      AEX181 = EMVGEV * ENERGY ( 181.D+00, 73.D+00 )
      CEX181 = EMVGEV * ENRG   ( 181.D+00, 73.D+00 )
      AMM181 = 181.D+00 * AMUGEV + AEX181
      AMN181 = AMM181 - 73.D+00 * AMELCT + FERTHO * 73.D+00**EXPEBN
      AEX208 = EMVGEV * ENERGY ( 208.D+00, 82.D+00 )
      CEX208 = EMVGEV * ENRG   ( 208.D+00, 82.D+00 )
      AMM208 = 208.D+00 * AMUGEV + AEX208
      AMN208 = AMM208 - 82.D+00 * AMELCT + FERTHO * 82.D+00**EXPEBN
      AEX238 = EMVGEV * ENERGY ( 238.D+00, 92.D+00 )
      CEX238 = EMVGEV * ENRG   ( 238.D+00, 92.D+00 )
      AMM238 = 238.D+00 * AMUGEV + AEX238
      AMN238 = AMM238 - 92.D+00 * AMELCT + FERTHO * 92.D+00**EXPEBN
c DH
      if(ipri.gt.0) then
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Maximum Fermi momentum  : ',SNGL(APFRMX),
     &                  ' GeV/c ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Maximum Fermi energy    : ',SNGL(AEFRMX),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Average Fermi energy    : ',SNGL(AEFRMA),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Average binding energy  : ',SNGL(EBNDAV),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear well depth      : ',SNGL(AV0WEL),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 12-C  : ',SNGL(AEXC12),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 12-C  : ',SNGL(CEXC12),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 12-C  : ',SNGL(AMMC12),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 12-C  : ',SNGL(AMNC12),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 16-O  : ',SNGL(AEXO16),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 16-O  : ',SNGL(CEXO16),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 16-O  : ',SNGL(AMMO16),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 16-O  : ',SNGL(AMNO16),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 40-Ca : ',SNGL(AEXC40),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 40-Ca : ',SNGL(CEXC40),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 40-Ca : ',SNGL(AMMC40),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 40-Ca : ',SNGL(AMNC40),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 56-Fe : ',SNGL(AEXF56),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 56-Fe : ',SNGL(CEXF56),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 56-Fe : ',SNGL(AMMF56),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 56-Fe : ',SNGL(AMNF56),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 107-Ag: ',SNGL(AEX107),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 107-Ag: ',SNGL(CEX107),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 107-Ag: ',SNGL(AMM107),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 107-Ag: ',SNGL(AMN107),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 132-Xe: ',SNGL(AEX132),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 132-Xe: ',SNGL(CEX132),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 132-Xe: ',SNGL(AMM132),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 132-Xe: ',SNGL(AMN132),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 181-Ta: ',SNGL(AEX181),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 181-Ta: ',SNGL(CEX181),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 181-Ta: ',SNGL(AMM181),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 181-Ta: ',SNGL(AMN181),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 208-Pb: ',SNGL(AEX208),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 208-Pb: ',SNGL(CEX208),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 208-Pb: ',SNGL(AMM208),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 208-Pb: ',SNGL(AMN208),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Excess  mass  for 238-U : ',SNGL(AEX238),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Cameron E. m. for 238-U : ',SNGL(CEX238),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Atomic  mass  for 238-U : ',SNGL(AMM238),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      WRITE ( LUNOUT,* )' **** Nuclear mass  for 238-U : ',SNGL(AMN238),
     &                  ' GeV   ****'
      WRITE ( LUNOUT,* )
      endif
      AMHEAV (1) = AMUGEV + EMVGEV * ENERGY ( ONEONE, ZERZER )
      AMHEAV (2) = AMUGEV + EMVGEV * ENERGY ( ONEONE, ONEONE )
      AMHEAV (3) = TWOTWO * AMUGEV + EMVGEV * ENERGY ( TWOTWO, ONEONE )
      AMHEAV (4) = THRTHR * AMUGEV + EMVGEV * ENERGY ( THRTHR, ONEONE )
      AMHEAV (5) = THRTHR * AMUGEV + EMVGEV * ENERGY ( THRTHR, TWOTWO )
      AMHEAV (6) = FOUFOU * AMUGEV + EMVGEV * ENERGY ( FOUFOU, TWOTWO )
      ELBNDE (0) = ZERZER
      ELBNDE (1) = 13.6D-09
      DO 2000 IZ = 2, 100
         ELBNDE ( IZ ) = FERTHO * DBLE ( IZ )**EXPEBN
2000  CONTINUE
      AMNHEA (1) = AMHEAV (1) + ELBNDE (0)
      AMNHEA (2) = AMHEAV (2) - AMELCT + ELBNDE (1)
      AMNHEA (3) = AMHEAV (3) - AMELCT + ELBNDE (1)
      AMNHEA (4) = AMHEAV (4) - AMELCT + ELBNDE (1)
      AMNHEA (5) = AMHEAV (5) - TWOTWO * AMELCT + ELBNDE (2)
      AMNHEA (6) = AMHEAV (6) - TWOTWO * AMELCT + ELBNDE (2)
      IF ( LEVPRT ) THEN
         if(ipri.ge.1) then
         WRITE ( LUNOUT, * )' **** Evaporation from residual nucleus',
     &                      ' activated **** '
         IF ( LDEEXG ) WRITE ( LUNOUT, * )' **** Deexcitation gamma',
     &                      ' production activated **** '
         IF ( LHEAVY ) WRITE ( LUNOUT, * )' **** Evaporated "heavies"',
     &                      ' transport activated **** '
         IF ( IFISS .GT. 0 )
     &                 WRITE ( LUNOUT, * )' **** High Energy fission ',
     &                      ' requested & activated **** '
         IF ( LFRMBK )
     &                 WRITE ( LUNOUT, * )' **** Fermi Break Up ',
     &                      ' requested & activated **** '
         endif
         IF ( LFRMBK ) CALL FRBKIN (.FALSE.,.FALSE.)
      ELSE
         LDEEXG = .FALSE.
         LHEAVY = .FALSE.
         LFRMBK = .FALSE.
         IFISS  = 0
      END IF
      RETURN
*=== End of subroutine incini =========================================*
      END
*
*===decay==============================================================*
*
      SUBROUTINE DECAYS(PIN,IDXIN,POUT,IDXOUT,NSEC,IREJ)

************************************************************************
* Resonance-decay.                                                     *
* This subroutine replaces DDECAY/DECHKK.                              *
*             PIN(4)      4-momentum of resonance          (input)     *
*             IDXIN       BAMJET-index of resonance        (input)     *
*             POUT(20,4)  4-momenta of decay-products      (output)    *
*             IDXOUT(20)  BAMJET-indices of decay-products (output)    *
*             NSEC        number of secondaries            (output)    *
* Adopted from the original version DECHKK.                            *
* This version dated 09.01.95 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)
      PARAMETER (TINY17=1.0D-17)

      PARAMETER (IDMAX9=602)
      CHARACTER*8 ANAME,ZKNAME
      COMMON /DDECAC/ ZKNAME(IDMAX9),WT(IDMAX9),NZK(IDMAX9,3)
      COMMON /DPAR/   ANAME(210),AAM(210),GA(210),TAU(210),
     &                IICH(210),IIBAR(210),K1(210),K2(210)

      LOGICAL LEMCCK,LHADRO,LSEADI
      COMMON /FLAGS/  IFRAG(2),IRESCO,IMSHL,IRESRJ,
     &                LEMCCK,LHADRO(0:9),LSEADI

* ISTAB = 1 strong and weak decays
*       = 2 strong decays only
*       = 3 strong decays, weak decays for charmed particles and tau
*           leptons only
      DATA ISTAB /2/

      DIMENSION PIN(4),PI(20,4),POUT(20,4),IDXOUT(20),
     &          EF(3),PF(3),PFF(3),IDXSTK(20),IDX(3),
     &          CODF(3),COFF(3),SIFF(3),DCOS(3),DCOSF(3)

      IREJ = 0
      NSEC = 0
* put initial resonance to stack
      NSTK = 1
      IDXSTK(NSTK) = IDXIN
      DO 5 I=1,4
         PI(NSTK,I) = PIN(I)
    5 CONTINUE

* store initial configuration for energy-momentum cons. check
      IF (LEMCCK) CALL EVTEMC(PI(NSTK,1),PI(NSTK,2),PI(NSTK,3),
     &                                   PI(NSTK,4),1,IDUM,IDUM)

  100 CONTINUE
* get particle from stack
      IDXI = IDXSTK(NSTK)
* skip stable particles
      IF (ISTAB.EQ.1) THEN
         IF ((IDXI.EQ.135).OR. (IDXI.EQ.136)) GOTO 10
         IF ((IDXI.GE.  1).AND.(IDXI.LE.  7)) GOTO 10
      ELSEIF (ISTAB.EQ.2) THEN
         IF ((IDXI.GE.  1).AND.(IDXI.LE. 30)) GOTO 10
         IF ((IDXI.GE. 97).AND.(IDXI.LE.103)) GOTO 10
         IF ((IDXI.GE.115).AND.(IDXI.LE.122)) GOTO 10
         IF ((IDXI.GE.131).AND.(IDXI.LE.136)) GOTO 10
         IF ( IDXI.EQ.109)                    GOTO 10
         IF ((IDXI.GE.137).AND.(IDXI.LE.160)) GOTO 10
      ELSEIF (ISTAB.EQ.3) THEN
         IF ((IDXI.GE.  1).AND.(IDXI.LE. 23)) GOTO 10
         IF ((IDXI.GE. 97).AND.(IDXI.LE.103)) GOTO 10
         IF ((IDXI.GE.109).AND.(IDXI.LE.115)) GOTO 10
         IF ((IDXI.GE.133).AND.(IDXI.LE.136)) GOTO 10
      ENDIF

* calculate direction cosines and Lorentz-parameter of decaying part.
      PTOT = SQRT(PI(NSTK,1)**2+PI(NSTK,2)**2+PI(NSTK,3)**2)
      PTOT = MAX(PTOT,TINY17)
      DO 1 I=1,3
         DCOS(I) = PI(NSTK,I)/PTOT
    1 CONTINUE
      GAM  = PI(NSTK,4)/AAM(IDXI)
      BGAM = PTOT/AAM(IDXI)

* get decay-channel
      KCHAN = K1(IDXI)-1
    2 CONTINUE
      KCHAN = KCHAN+1
      IF ((RNDM(V)-TINY17).GT.WT(KCHAN)) GOTO 2

* identities of secondaries
      IDX(1) = NZK(KCHAN,1)
      IDX(2) = NZK(KCHAN,2)
      IF (IDX(2).LT.1) GOTO 9999
      IDX(3) = NZK(KCHAN,3)

* handle decay in rest system of decaying particle
      IF (IDX(3).EQ.0) THEN
*   two-particle decay
         NDEC = 2
         CALL DTWOPD(AAM(IDXI),EF(1),EF(2),PF(1),PF(2),
     &               CODF(1),COFF(1),SIFF(1),CODF(2),COFF(2),SIFF(2),
     &               AAM(IDX(1)),AAM(IDX(2)))
      ELSE
*   three-particle decay
         NDEC = 3
         CALL DTHREP(AAM(IDXI),EF(1),EF(2),EF(3),PF(1),PF(2),PF(3),
     &               CODF(1),COFF(1),SIFF(1),CODF(2),COFF(2),SIFF(2),
     &               CODF(3),COFF(3),SIFF(3),
     &               AAM(IDX(1)),AAM(IDX(2)),AAM(IDX(3)))
      ENDIF
      NSTK = NSTK-1

* transform decay products back
      DO 3 I=1,NDEC
         NSTK = NSTK+1
         CALL DTRAFO(GAM,BGAM,DCOS(1),DCOS(2),DCOS(3),
     &               CODF(I),COFF(I),SIFF(I),PF(I),EF(I),
     &               PFF(I),DCOSF(1),DCOSF(2),DCOSF(3),PI(NSTK,4))
* add particle to stack
         IDXSTK(NSTK) = IDX(I)
         DO 4 J=1,3
            PI(NSTK,J) = DCOSF(J)*PFF(I)
    4    CONTINUE
    3 CONTINUE
      GOTO 100

   10 CONTINUE
* stable particle, put to output-arrays
      NSEC = NSEC+1
      DO 6 I=1,4
         POUT(NSEC,I) = PI(NSTK,I)
    6 CONTINUE
      IDXOUT(NSEC) = IDXSTK(NSTK)
* store secondaries for energy-momentum conservation check
      IF (LEMCCK) 
     &CALL EVTEMC(-POUT(NSEC,1),-POUT(NSEC,2),-POUT(NSEC,3),
     &            -POUT(NSEC,4),2,IDUM,IDUM)
      NSTK = NSTK-1
      IF (NSTK.GT.0) GOTO 100

* check energy-momentum conservation
      IF (LEMCCK) THEN
         CALL EVTEMC(DUM,DUM,DUM,DUM,3,5,IREJ1)
         IF (IREJ1.NE.0) GOTO 9999
      ENDIF

      RETURN

 9999 CONTINUE
      IREJ = 1
      RETURN
      END
*
*===decay1=============================================================*
*
      SUBROUTINE DECAY11

************************************************************************
* Decay of resonances stored in HKKEVT.                                *
* This version dated 19.11.95 is written by S. Roesler                 *
************************************************************************

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (LOUT=6,LLOOK=9)

      PARAMETER (NMXHKK=49998) 
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK),
     &                JMOHKK(2,NMXHKK),JDAHKK(2,NMXHKK),
     &                PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)

      DIMENSION PIN(4),POUT(10,4),IDXOUT(10)

      NEND = NHKK
C     DO 1 I=NPOINT(5),NEND
CCC      DO 1 I=NPOINT(4),NEND
      N123=NPOINT(4)
      DO 1 I=N123,NEND
C         write(67,*)i,n123,nend
         i123=ISTHKK(I)
         i124=abs(i123)
C         write(67,*)i,i123,i124,n123,nend

CCC         IF (ABS(ISTHKK(I)).EQ.1) THEN
         IF (i124.EQ.1) THEN
            DO 2 K=1,4
               PIN(K) = PHKK(K,I)
    2       CONTINUE
            IDXIN = IDBAM(I)
            CALL DECAYS(PIN,IDXIN,POUT,IDXOUT,NSEC,IREJ)
            IF (NSEC.GT.1) THEN
               DO 3 N=1,NSEC
                  IDHAD = IPDGHA(IDXOUT(N))
                  CALL EVTPUT(1,IDHAD,I,0,POUT(N,1),POUT(N,2),
     &                               POUT(N,3),POUT(N,4),0,0,0)
    3          CONTINUE
            ENDIF
         ENDIF
    1 CONTINUE

      RETURN
      END
      FUNCTION ICIHAD(MCIND)
      ICIHAD=MCIHAD(MCIND)
      RETURN
      END
      FUNCTION IPDGHA(MCIND)
      IPDGHA=MPDGHA(MCIND)
      RETURN
      END
*
*===sihnab===============================================================*
*
      SUBROUTINE SIHNAB(IDP,IDT,PLAB,SIGABS)
 
**********************************************************************
* Pion 2-nucleon absorption cross sections.                          *
* (sigma_tot for pi+ d --> p p, pi- d --> n n                        *
*  taken from Ritchie PRC 28 (1983) 926 )                            *
* This version dated 18.05.96 is written by S. Roesler               *
**********************************************************************
 
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
      PARAMETER (ZERO=0.0D0,ONE=1.0D0,TWO=2.0D0,TINY3=1.0D-3)
      PARAMETER (AMPR = 938.0D0,
     &           AMPI = 140.0D0,
     &           AMDE = TWO*AMPR,
     &           A    = -1.2D0,
     &           B    = 3.5D0,
     &           C    = 7.4D0,
     &           D    = 5600.0D0,
     &           ER   = 2136.0D0)

      SIGABS = ZERO
      IF (((IDP.NE.13).AND.(IDP.NE.14).AND.(IDP.NE.23))
     & .OR.((IDT.NE.1).AND.(IDT.NE.8)))
     &                                                           RETURN
      PTOT = PLAB*1.0D3
      EKIN = SQRT(AMPI**2+PTOT**2)-AMPI
      IF ((EKIN.LT.TINY3).OR.(EKIN.GT.400.0D0)) RETURN
      ECM  = SQRT( (AMPI+AMDE)**2+TWO*EKIN*AMDE )
      SIGABS = A+B/SQRT(EKIN)+C*1.0D4/((ECM-ER)**2+D)
* approximate 3N-abs., I=1-abs. etc.
      SIGABS = SIGABS/0.40D0
      IF(IDP.EQ.23) SIGABS = 0.5D0*SIGABS

      RETURN
      END
C***********************************************************************
      SUBROUTINE DPMEVT(ELABT,IIPROJ,IIP,IIPZ,IIT,IITZ,KKMAT,NHKKH1)
C
C           J.R.   Version 9/99 for dpmjet25
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK=49998)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C
*KEEP,NUCC.
      COMMON /NUCC/ IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /NUCCC/ JT,JTZ,JP,JPZ,JJPROJ,JBPROJ,JJTARG,JBTARG
C                               from DTUJET93
*  *********************************************************************
*     /COLLIS/       contains the input specifying the considered event
C        ECM dropped as now in /USER/CMENER
*        S = is the Mandelstam s variable (=ECM**2)
*        IJPROJ,IJTARG = specifies the projectile rsp. target Q.N.
*        PTTHR  = the minimum pt still hard
*        PTTHR2 = the  pt of the first sampled hard scattering
*        IOPHRD = the option chosen for the hard scatterring
*        IJPRLU,IJTALU =
*  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C     COMMON/COLLIS/S,IJPROX,IJTAR,PTTHR,IOPHRD,IJPRLU,IJTALU,PTTHR2
      COMMON/COLLIS/S,IJPROX,IJTAR,PTTHR,PTTHR2,IOPHRD,IJPRLU,IJTALU
*
*  *********************************************************************
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*  *********************************************************************
*  /USER/ contains the parameters, expected to be modified by normal user
*      TITLE is a litteral string TITLE printet in the OUTPUT
*      PROJTY resp. TARGTY specify the type of particle scattering
*            The projectile moves in positive z-direction.
*          (Particle type specifications numbers for scatterers are stored
*           in COMMON /BOOKLT/ in BLOCKDATA on the end of this file.
*           Our comlete particle and resonance numbering is given in
*           the file DTUTCB in BLOCK DATA partic DATA ANAME
*           Also a list of our particle numbering
*           is obtained running the code word PARTICLE)
*      CMENERGY the center of mass energy in GeV
*      ISTRUF specifies the structure function as
*      ISINGD (ISINGX)specifies what is done with diffractive events
*              ISINGD=0: Single diffraction surpressed
*              ISINGD=1: Single diffraction included to fraction SDFRAC
*              ISINGD=2: Only single diffraction with target excited
*              ISINGD=3: Only single diffraction with projectile excited
*      IDUBLD specifies what is done with double diffractive events
*              ISINGD=0: Double diffraction included
*              ISINGD=1: Only double diffraction
*      SDFRAC see ISINGD
*      PTLAR  cutoff parameter requiring minijet of given size??

*  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      CHARACTER*80 TITLED
      CHARACTER*8 PROJTY,TARGTY
C     COMMON /USER/TITLED,PROJTY,TARGTY,CMENER,ISTRUF
C    &            ,ISINGX,IDUBLD,SDFRAC,PTLAR
      COMMON /USER1/TITLED,PROJTY,TARGTY
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGX,IDUBLD
      CHARACTER*8 BTYPE
      COMMON /PANAME/ BTYPE(30)
      COMMON /STRUFU/ ISTRUM,ISTRUT
C
      COMMON /BUFUEH/ ANNVV, ANNSS, ANNSV, ANNVS, ANNCC, ANNDV,
     * ANNVD, ANNDS, ANNSD, ANNHH, ANNZZ, PTVV, PTSS, PTSV, PTVS, 
     * PTCC, PTDV, PTVD, PTDS, PTSD, PTHH, PTZZ, EEVV, EESS, EESV, 
     * EEVS, EECC, EEDV, EEVD, EEDS, EESD, EEHH, EEZZ, ANNDI, PTDI, 
     * EEDI, ANNZD, ANNDZ, PTZD, PTDZ, EEZD, EEDZ
      COMMON /NCOUCH/ ACOUVV, ACOUSS, ACOUSV, ACOUVS, ACOUZZ, ACOUHH,
     * ACOUDS, ACOUSD, ACOUDZ, ACOUZD, ACOUDI, ACOUDV, ACOUVD, ACOUCC
C
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
C
ctp060123       SAVE ELABT_PREV
C       ON DOUBLE PRECISION UNDERFLOW IGNORE
C       ON REAL UNDERFLOW IGNORE
       DATA ELABT_PREV/-10./      !  lab-energy of previous collision
       DATA NINIT/0/
C
*  *********************************************************************
*                               PROJPAR
	IPROJ=IIPROJ
C                    New 4/97
C       KKMAT=IIP
	IF(IIPROJ.EQ.-1)IPROJ=1
C                    New 4/97
	IF(IPROJ.EQ.12.OR.IPROJ.EQ.19)THEN
	  IPROJ=24
	  IF(RNDM(V).LT.0.5D0)IPROJ=25
	ENDIF
        PROJTY=BTYPE(IPROJ)
        IJPROJ=IPROJ
        IJPROX=IPROJ
	IBPROJ=IIBAR(IPROJ)
	IP=IIP
	IPZ=IIPZ
*                               TARPAR
C       IT=14
C       ITZ=7
	IT=IIT
	ITZ=IITZ
	IJTAR=1
*                               MOMENTUM
      EPN=1000.D0*ELABT
      NNPP=IJPROJ
      AMPROJ=AAM(NNPP)
      PPROJ = SQRT((EPN-AMPROJ)*(EPN+AMPROJ))
      PPN=PPROJ
*                             nucleon-nucleon cms
      EPROJ=EPN
      AMTAR=AAM(1)
      UMO = SQRT(AMPROJ**2 + AMTAR**2 + 2.*AMTAR*EPROJ)
      CMENER=UMO
      GAMCM = (EPROJ+AMTAR)/UMO
      BGCM=PPROJ/UMO
      ECM=UMO
      S=ECM**2
      PCM=GAMCM*PPROJ - BGCM*EPROJ
          IF(ISTRUT.EQ.1)THEN
            PTTHR=2.1+0.15*(LOG10(CMENER/50.))**3
            PTTHR2=PTTHR
          ELSEIF(ISTRUT.EQ.2)THEN
            PTTHR=2.5+0.12*(LOG10(CMENER/50.))**3
            PTTHR2=PTTHR
          ENDIF
C
C     IIT=IT 
C     IITZ=ITZ
C     IIP=IP
C     IIPZ=IPZ
      IIPROJ=IJPROJ
      IITARG = IJTARG
C
C-- INITIALIZE COUNTERS before call to KKINC
C
 765  CONTINUE
      ANNVV=0.001         ! common /BUFUEH/
      ANNSS=0.001
      ANNSV=0.001
      ANNVS=0.001
      ANNCC=0.001
      ANNDV=0.001
      ANNVD=0.001
      ANNDS=0.001
      ANNSD=0.001
      ANNHH=0.001
      ANNZZ=0.001
      ANNDI=0.001
      ANNZD=0.001
      ANNDZ=0.001
      PTVV=0.
      PTSS=0.
      PTSV=0.
      PTVS=0.
      PTCC=0.
      PTDV=0.
      PTVD=0.
      PTDS=0.
      PTSD=0.
      PTHH=0.
      PTZZ=0.
      PTDI=0.
      PTZD=0.
      PTDZ=0.
      EEVV=0.
      EESS=0.
      EESV=0.
      EEVS=0.
      EECC=0.
      EEDV=0.
      EEVD=0.
      EEDS=0.
      EESD=0.
      EEHH=0.
      EEZZ=0.
      EEDI=0.
      EEZD=0.
      EEDZ=0.
C  
C-- COMMON /NCOUCH/ variables
C
       ACOUVV=0.
       ACOUSS=0.
       ACOUSV=0.
       ACOUVS=0.
       ACOUZZ=0.
       ACOUHH=0.
       ACOUDS=0.
       ACOUSD=0.
       ACOUDZ=0.
       ACOUZD=0.
       ACOUDI=0.
       ACOUDV=0.
       ACOUVD=0.
       ACOUCC=0.
C
C-- Pt initialisation each time collision energy varies
C

      IF (ELABT.NE.ELABT_PREV) THEN
CGB	CALL RD2OUT(ISEED,JSEED)
C	write(6,*) 'seeds before SAMPPT',ISEED,JSEED
	CALL SAMPPT(0,PT)
CGB	CALL RD2OUT(ISEED,JSEED)
C	write(6,*) 'seeds after SAMPPT',ISEED,JSEED
CGB	write(6,*)
      ENDIF   
      ELABT_PREV = ELABT
C
      IF(NINIT.LT.10)THEN
      NINIT=NINIT+1
C      WRITE(6,*)' DPMEVT  EPN=',EPN,'IIT,IITZ,IIP,IIPZ,IIPROJ,KKMAT',
C     *IIT,IITZ,IIP,IIPZ,IIPROJ,KKMAT, ' PTTHR=',PTTHR 
      ENDIF
C      WRITE(6,*)' DPMEVT  EPN=',EPN,' IIT,IITZ,IIP,IIPZ,IIPROJ,KKMAT',
C     *IIT,IITZ,IIP,IIPZ,IIPROJ,KKMAT, ' PTTHR=',PTTHR 
      CALL KKINC(EPN,IIT,IITZ,IIP,IIPZ,IIPROJ,KKMAT,
     * IITARG,NHKKH1,IREJ)
C      WRITE(6,*)'DPMEVT Exits from KKINC with IREJ=',IREJ
      IF (IREJ.EQ.1) THEN
C        if (ipev.ge.1) WRITE(6,*)'Exits from KKINC with IREJ=1'
        GO TO 765
      ENDIF
C      WRITE(6,*)'DECHKK called from DPMEVT : NHKKH1=',NHKKH1
C      CALL DECHKK(NHKKH1)
      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
      SUBROUTINE DIQTOC(NHKKH1)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
C
C  HADRKK CONSTRUCTS ONE HADRONIZED EVENT FOR KK-COLLISIONS
C     ALL TYPES OF CHAINS ARE CONSIDERED
C     OPTONALLY GIVEN TYPES ARE SELECTED ACCORDING TO /DROPPT/
C
C--------------------------------------------------------------------
*KEEP,INTMX.
C     PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
 
c_ae_ ------------------------------------------------------------------
c_ae_ change to use flexible output unit in DPMJET - automated procedure
c_ae_                     modified WRITE and PRINT statements not marked
c_ae_
c_ae_                                         nov-00  anton.empl@cern.ch
      common /IOdpmjet/ IOdpm
c_ae_
 
C     COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
C    +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
C    *                ,XPSU(248),XTSU(248)
C    *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
C     COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
C    +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
C    +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
C    +INTSS1(INTMX),INTSS2(INTMX),
C    +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
C    +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
C     COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
C    +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
C    +JHKKNT
C    +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
C    +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
C    &                MHKKHH(INTMX),
C    +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
C     LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
C     COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
C    +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C       INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
C     COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
C    +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
C    +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
C    +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
      COMMON /HKKEVT1/ NHKK1,NEVHKK1,ISTHKK1(NMXHKK),
     + IDHKK1(NMXHKK), JMOHKK1(2,NMXHKK),JDAHKK1(2,NMXHKK),
     + PHKK1(5,NMXHKK),VHKK1(4,NMXHKK),WHKK1(4,NMXHKK)
      COMMON /EXTEVT/ IDRES(NMXHKK),IDXRES(NMXHKK),NOBAM(NMXHKK),
     &                IDBAM(NMXHKK),IDCH(NMXHKK),NPOINT(10)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
C     COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,DROPPT.
C     LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
C    +ISHMAL,LPAULI
C     COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
C    +IPADIS,ISHMAL,LPAULI
*KEEP,CMHICO.
C     COMMON /CMHICO/ CMHIS
      COMMON /CHARMD/ICHARMD
*KEEP,DPRIN.
C     COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BEGIN AND END OF DECAY CHANNELS OF PARTICLE
C
C     CHARACTER*8  ANAME
C     COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
C    +IIBAR(210),K1(210),K2(210)
C------------------
*KEND.
C                                   modified DPMJET
C      COMMON /BUFUES/ BNNVV,BNNSS,BNNSV,BNNVS,BNNCC,
C    *                 BNNDV,BNNVD,BNNDS,BNNSD,
C    *                 BNNHH,BNNZZ,
C    *                 BPTVV,BPTSS,BPTSV,BPTVS,BPTCC,BPTDV,
C    *                 BPTVD,BPTDS,BPTSD,
C    *                 BPTHH,BPTZZ,
C    *                 BEEVV,BEESS,BEESV,BEEVS,BEECC,BEEDV,
C    *                 BEEVD,BEEDS,BEESD,
C    *                 BEEHH,BEEZZ
C    *                ,BNNDI,BPTDI,BEEDI
C    *                ,BNNZD,BNNDZ,BPTZD,BPTDZ,BEEZD,BEEDZ
C      COMMON /NCOUCS/ BCOUVV,BCOUSS,BCOUSV,BCOUVS,
C    *                 BCOUZZ,BCOUHH,BCOUDS,BCOUSD,
C    *                 BCOUDZ,BCOUZD,BCOUDI,
C    *                 BCOUDV,BCOUVD,BCOUCC
C      COMMON /BUFUEH/ ANNVV,ANNSS,ANNSV,ANNVS,ANNCC,
C    *                 ANNDV,ANNVD,ANNDS,ANNSD,
C    *                 ANNHH,ANNZZ,
C    *                 PTVV,PTSS,PTSV,PTVS,PTCC,PTDV,PTVD,PTDS,PTSD,
C    *                 PTHH,PTZZ,
C    *                 EEVV,EESS,EESV,EEVS,EECC,EEDV,EEVD,EEDS,EESD,
C    *                 EEHH,EEZZ
C    *                ,ANNDI,PTDI,EEDI
C    *                ,ANNZD,ANNDZ,PTZD,PTDZ,EEZD,EEDZ
C      COMMON /NCOUCH/ ACOUVV,ACOUSS,ACOUSV,ACOUVS,
C    *                 ACOUZZ,ACOUHH,ACOUDS,ACOUSD,
C    *                 ACOUDZ,ACOUZD,ACOUDI,
C    *                 ACOUDV,ACOUVD,ACOUCC
C---------------------
      COMMON /JSPA/PXS(40000),PYS(40000),PZS(40000),HES(40000),NNNPS
C---------------------
      COMMON /BAMCO/  NVDD
      COMMON /PYJETS/NPY,NPADPY,KPY(4000,5),PPY(4000,5),VPY(4000,5)
C     LOGICAL LSEADI
C     COMMON /SEADIQ/ LSEADI
C     COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
C     COMMON/DIQUAX/AMEDD,IDIQUA,IDIQUU
C     COMMON /SECINT/ISECIN
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
      COMMON /USER2/CMENER,SDFRAC,PTLAR,ISTRUF,ISINGD,IDUBLD      
C     DATA IEVCOU/0/


C---------------------
*
C     INTEGER PYCHGE
      CHARACTER*16 CHAU1,CHAU2,CHAUM,CHAU21,CHAU22
      DATA NCOUNT/0/
      DATA NCHBNEG/0/
      DATA NCHBPOS/0/
      DATA ISUM/0/
      DATA IDBG/0/
      DATA IDIQTOC/0/
      DATA IREJ/0/
C     DATA IFORWBACKW/0/
      ECM=CMENER
      NCOUNT=NCOUNT+1
      IF(NCOUNT.GT.2000)IDBG=0
      IF(IDBG.EQ.1)
     *WRITE(6,*)' DIQTOC ',NCOUNT
      IF(IDBG.EQ.1)
     *  WRITE(6,*)' entry DIQTOC event COMMON'
      NHKKK=NHKK
C      DO 315 KKK=1,NHKKK
C        IF(JMOHKK(1,KKK).EQ.0.AND.NHKKH1.LT.KKK)THEN
C          WRITE(6,*)' JMO EQ 0'
C          WRITE(6,'(2I4,I6,4I4,5F10.2)')
C     *    KKK,ISTHKK(KKK),IDHKK(KKK),
C     *    JMOHKK(1,KKK),JMOHKK(2,KKK),JDAHKK(1,KKK),JDAHKK(2,KKK),
C     *    (PHKK(LL,KKK),LL=1,5)
C        ENDIF
C        IF(ISUM.LE.20)
C     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
C     *    KKK,ISTHKK(KKK),IDHKK(KKK),
C     *    JMOHKK(1,KKK),JMOHKK(2,KKK),JDAHKK(1,KKK),JDAHKK(2,KKK), 
C     *    (PHKK(LL,KKK),LL=1,5)
C  315 CONTINUE  
      ISUM=ISUM+1
C
C	DIQCHARM=0.0060D0
 	DIQCHARM0=0.5000D0
c     PB 10-02-07
C            J.R.2.9.07       
         IF(ECM.GE.75.D0)CHAFAC=1.D0
           IF(ECM.LE.25.D0)CHAFAC=0.333D0
           IF(ECM.GT.25.D0.AND.ECM.LT.75.D0)CHAFAC=ECM/75.D0
           IF(IT.GE.2)THEN
              AAIT=IT
              CHAFAC=CHAFAC*(AAIT**0.28D0)*0.83D0
            ENDIF
            DIQCHARM=DIQCHARM0*CHAFAC
C            J.R.2.9.07

CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	
C       DIQCHARM=1.D0
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	
        IF(RNDM(VV).GT.DIQCHARM)GO TO 8667
C         WRITEOUT for selected event
C          IF(IDIQTOC.LT.500)THEN
C            WRITE(6,*)' DIQTOC,NCOUNT,NHKK,IDIQTOC ',NCOUNT,NHKK,IDIQTOC
C	    NHKKK=NHKK
C      DO 1315 KKK=1,NHKKK
C          WRITE(6,'(2I4,I6,4I4,5F10.2)')
C     *    KKK,ISTHKK(KKK),IDHKK(KKK),
C     *    JMOHKK(1,KKK),JMOHKK(2,KKK),JDAHKK(1,KKK),JDAHKK(2,KKK), 
C     *    (PHKK(LL,KKK),LL=1,5)
C 1315 CONTINUE  
C	    IDIQTOC=IDIQTOC+1
C          ENDIF
      DO 7667 KK=1,NHKKK
        IF(JMOHKK(1,KK).EQ.0.AND.NHKKH1.LT.KK)THEN
          WRITE(6,*)'JMOHKK(1,KK).EQ.0) RETURN KK= ',KK
          GO TO 7667
        ENDIF
        IDH=IDHKK(KK)/10000
        IF(IDH.LT.8)GO TO 7667
        IF(IDH.GT.8)GO TO 7667
        IF(JMOHKK(1,KK).NE.KK-2)GO TO 7667
        IF(JMOHKK(2,KK).NE.KK-1)GO TO 7667
        IDK1=0
        IDK2=0
        KKK=KK-2
        IDK1=ABS(IDHKK(KKK))
        KKK=KK-1
        IDK2=ABS(IDHKK(KKK))
        IF(IDK1/1000.EQ.0.AND.IDK2/1000.EQ.0)GO TO 7667
        IF(ABS(PHKK(4,KK)-PHKK(4,KK-1)-PHKK(4,KK-2)).GT.1.D-3)THEN
C          WRITE(6,*)' inconsistent chain'
	  GO TO 7667 
        ENDIF
        IF(ABS(PHKK(4,KK)).GT.8.0D0.AND.PHKK(5,KK).GT.6.D0)THEN
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'*** original chain and two chainends',
     *      ' to be transformed '
     *      ,'KK= ',KK,NHKK,NEVHKK   
C--------------------------------------------------------------     
          IF((ISTHKK(KK-2).EQ.121.AND.ISTHKK(KK-1).EQ.122).
     *      AND.(IDHKK(KK-2).GT.100))THEN
            IDHKKTEMP = IDHKK(KK-2)
            IDHKK(KK-2) = IDHKK(KK-1)
	    IDHKK(KK-1) = IDHKKTEMP
          ENDIF
C--------------------------------------------------------------      
          KKK=KK-2
          IDK1=ABS(IDHKK(KKK))
          KKK=KK-1
          IDK2=ABS(IDHKK(KKK))
C         IF(PHKK(3,KK-1).LT.0.D0)!!!!!!!!!!!!!
          IF(PHKK(3,KK-1).LT.0.D0)Go To 311
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVv	  
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVv	  
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVv	  
          IQ1=0
          IQ2=0
          IQQ1=0
          IQQ2=0
          IDQQ1=0
          IDQQ2=0
          IF(IDK1/1000.NE.0)THEN
            IQ1=IDK1/1000
	    IQ2=(IDK1-IQ1*1000)/100
	    IDQQ1=(IDK1-IQ1*1000-IQ2*100)
          ENDIF
          IF(IDK2/1000.NE.0)THEN
            IQQ1=IDK2/1000
	    IQQ2=(IDK2-IQQ1*1000)/100
	    IDQQ2=(IDK2-IQQ1*1000-IQQ2*100)
          ENDIF
C
          ID1=4
          IAD1=-4
          IF(IDK2.GT.100)THEN
            CALL PYKFDI(IDK2,ID1,INEW2,KF21)
            CALL PYNAME(KF21,CHAU21)
            AM21=PYMASS(KF21)
            CALL PYKFDI(ID1,IDK2,INEW2,KF22)
            CALL PYNAME(KF22,CHAU22)
            AM22=PYMASS(KF22)
            IF(IDBG.EQ.1)
     *        WRITE(6,*)' diqtoc KF21,KF22,AM21,AM22,CHAU21,CHAU22',KF21,KF22,
     *        AM21,AM22,CHAU21,CHAU22
	    IF(KF21.EQ.0.AND.KF22.EQ.0)GO TO 231
	    IF(KF21.NE.0.AND.KF22.NE.0)GO TO 232
C	    IF(KF21.NE.0)GO TO 234
C	    IF(KF22.NE.0)GO TO 235
C           j.r.31.10.07
 	    IF(KF21.NE.0)THEN
	      KF2=KF21
	      AM2=AM21
	      CHAU2=CHAU21
	      GO TO 233
	    ENDIF
 	    IF(KF22.NE.0)THEN
	      KF2=KF22
	      AM2=AM22
	      CHAU2=CHAU22
	      GO TO 233
	    ENDIF
	    GO TO 211
  232       CONTINUE
            IF(AM22.LT.AM21.AND.KF22.NE.0)THEN
  235         CONTINUE	    
	      KF2=KF22
	      AM2=AM22
	      CHAU2=CHAU22
	      GO TO 233
	    ELSEIF(AM22.GT.AM21.AND.KF21.NE.0)THEN  
  234         CONTINUE	    
	      KF2=KF21
	      AM2=AM21
	      CHAU2=CHAU21
	      GO TO 233
	    ENDIF
  231       CONTINUE
            GO TO 211
  233       CONTINUE     
            AM2=PYMASS(KF2)
            IF(IDBG.EQ.1)
     *        WRITE(6,*)' Baryon: KF2,AM2,CHAU2',KF2,AM2,CHAU2
            KFFF=KF2
          ENDIF
          IF(KFFF.EQ.0)GO TO 211
C         PT of charm-anticharm pair      
          CALL PYPTDI(KFFF,PX1,PY1)
          PX2=-PX1
          PY2=-PY1
C           Transverse mass of charm baryon?
          PR2=AM2**2+PX1**2+PY1**2
          CALL PYZDIS(IDHKK(KK-1),ID1,PR2,Z2)
          KKK=KK-2
C          we first transfom into chain rest frame
          BETCH=PHKK(3,KK)/PHKK(4,KK)
          BETGCH=PHKK(3,KK)/(PHKK(4,KK)*SQRT(1.D0-BETCH**2))
          GAMCH=1.D0/(SQRT(1.D0-BETCH**2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'Transform into chain rest frame',
     *'     BETCH,BETGCH,GAMCH ',BETCH,BETGCH,GAMCH  
          P3CH=GAMCH*PHKK(3,KK)-BETGCH*PHKK(4,KK)
          ECH=GAMCH*PHKK(4,KK)-BETGCH*PHKK(3,KK)
C       j.r.4.11.07	  
          KKK=KK-1
          P3CHM2=GAMCH*PHKK(3,KKK)-BETGCH*PHKK(4,KKK)
          ECHM2=GAMCH*PHKK(4,KKK)-BETGCH*PHKK(3,KKK)
          KKK=KK-2
          P3CHM1=GAMCH*PHKK(3,KKK)-BETGCH*PHKK(4,KKK)
          ECHM1=GAMCH*PHKK(4,KKK)-BETGCH*PHKK(3,KKK)
C       j.r.1.11.07	  
C         KKK=KK-1
C         P3CHM1=GAMCH*PHKK(3,KKK)-BETGCH*PHKK(4,KKK)
C         ECHM1=GAMCH*PHKK(4,KKK)-BETGCH*PHKK(3,KKK)
C         KKK=KK-2
C         P3CHM2=GAMCH*PHKK(3,KKK)-BETGCH*PHKK(4,KKK)
C         ECHM2=GAMCH*PHKK(4,KKK)-BETGCH*PHKK(3,KKK)
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  first chain end :',
     *      'W1= P3CHM1,ECHM1 ',KK-2,IDHKK(KK-2),P3CHM1,ECHM1
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  second chain end:',
     *      ' P3CHM2,ECHM2 ',KK-1,IDHKK(KK-1),P3CHM2,ECHM2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  Chain:',
     *      'P3CH,ECH ',KK,IDHKK(KK),P3CH,ECH
          KKK=KK-1
c           j.r.4.11.07
          W2=ECHM2+P3CHM2
c           j.r.2.11.07
C         W2=ECHM2-P3CHM2
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)' pos pz W2, Z2 ', W2, Z2
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV/VVVVVVVVVVVVVVVVVVVVVVVVVVV	  
          Z2=RNDM(V)*Z2
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)' pos pz W2, Z2 ', W2, Z2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' Mass and pt of charm baryon AM2,PX2,PY2 ',
     *      AM2,PX2,PY2      
          PR2=AM2**2+PX2**2+PY2**2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' in chain rest frame second chain end ',
     *      ' (diquark) :',
     *      'W2=ECHM2+P3CHM2,PR2 =AM2**2+PX2**2+PY2**2',
     *    KK-1,IDHKK(KK-1),W2,PR2
C           Energy and pz of charmed baryon     
          ENEW2=0.5D0*(Z2*W2+PR2/MAX(1.D-4,Z2*W2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)
     *      'ENEW2=0.5D0*(Z2*W2+PR2/MAX(1.D-4,Z2*W2))',
     *      ' ENEW2,ECHM2 ',ENEW2,ECHM2  
          IF(ENEW2.GT.ECHM2-0.01D0)GO TO 211
          PZNEW2=+0.5D0*(Z2*W2-PR2/MAX(1.D-4,Z2*W2))
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)' PZNEW2,P3CHM2 ',PZNEW2,P3CHM2
	  PXNEW2=PX2+PHKK(1,KK-1)
	  PYNEW2=PY2+PHKK(2,KK-1)
C         Enery and pz of residual anti-charm chain end     
          PXNEW2CHAINEND=PX1
          PYNEW2CHAINEND=PY1
C         NEW j.r.4.11.07	  1
          PZNEW2N = SQRT(ABS(ENEW2**2-PXNEW2**2-PYNEW2**2))
          ENEW2CHAINENDN=ECHM2-ENEW2
C         NEW j.r.4.11.07	  2
          ENEW2CHAINEND=ECHM2-ENEW2
          PZNEW2CHAINEND=P3CHM2-PZNEW2
C         NEW j.r.4.11.07	  3
          PZNEW2CHAINENDN = SQRT(ABS(ENEW2CHAINEND**2 -PX1**2-PY1**2))
          PZNEW2CHAINENDNN=P3CHM2-PZNEW2N
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)' ENEW2CHAINEND,PZNEW2CHAINEND,PZNEW2CHAINENDN,',
     *	 ' PZNEW2CHAINENDNN ',
     *   ENEW2CHAINEND,PZNEW2CHAINEND,PZNEW2CHAINENDN,PZNEW2CHAINENDNN 
C         NEW j.r.4.11.07	  4
          IF(IDBG.EQ.1)
     *    WRITE(6,*)'PZNEW2CHAINEND,ENEW2CHAINEND,ECHM2,ENEW2,P3CHM2,',
     *    'PZNEW2',
     *	  PZNEW2CHAINEND,ENEW2CHAINEND,ECHM2,ENEW2,P3CHM2,PZNEW2
          IF(ABS(PZNEW2CHAINEND).GT.ENEW2CHAINEND)THEN
C           NEW j.r.4.11.07	  5
	    IF(PZNEW2CHAINENDNN.LT.ENEW2CHAINEND)THEN
              IF(IDBG.EQ.1)
     *        WRITE(6,*)'PZNEW2CHAINENDNN,ENEW2CHAINEND',
     *	      PZNEW2CHAINENDNN,ENEW2CHAINEND
	      PZNEW2CHAINEND = PZNEW2CHAINENDNN
	      PZNEW2 = PZNEW2N
	      GO TO 9211
	    ENDIF  
	    IF(PZNEW2CHAINENDN.LT.ENEW2CHAINEND)THEN
              IF(IDBG.EQ.1)
     *        WRITE(6,*)'PZNEW2CHAINENDN,ENEW2CHAINEND',
     *	      PZNEW2CHAINENDN,ENEW2CHAINEND
	      PZNEW2CHAINEND = PZNEW2CHAINENDN
	      GO TO 9211
	    ENDIF  
C           NEW j.r.4.11.07	  6
	    GO TO 211
          ENDIF
 9211     CONTINUE	  
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' Produced charmed baryon:PX,PY,PZNEW2,ENEW2 ',
     *      PXNEW2,PYNEW2,ENEW2,PZNEW2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' resulting chain',
     *      'end:PX,PY,PZNEW2CHAINEND,ENEW2CHAINEND',
     *      PXNEW2CHAINEND,PYNEW2CHAINEND,PZNEW2CHAINEND,ENEW2CHAINEND
C            J.R.9.11.07	  
            PZNEW2CHAINEND= SQRT(ABS(ENEW2CHAINEND**2-
     *	    PXNEW2CHAINEND**2-PYNEW2CHAINEND**2))   
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' resulting chain',
     *      'end:PX,PY,PZNEW2CHAINEND,ENEW2CHAINEND',
     *      PXNEW2CHAINEND,PYNEW2CHAINEND,PZNEW2CHAINEND,ENEW2CHAINEND
C            J.R.9.11.07	  
C           Transform back into original Lorentz frame
          PHKK3KK=GAMCH*P3CH+BETGCH*ECH
          PHKK4KK=GAMCH*ECH+BETGCH*P3CH
          PZNEW1O=GAMCH*PZNEW2+BETGCH*ENEW2
          ENEW1O=GAMCH*ENEW2+BETGCH*PZNEW2
          PZNEW2CHAINENDO=GAMCH*PZNEW2CHAINEND+BETGCH*ENEW2CHAINEND
          ENEW2CHAINENDO=GAMCH*ENEW2CHAINEND+BETGCH*PZNEW2CHAINEND
C            J.R.9.11.07	  
          IF(ENEW2CHAINENDO.LT.0.D0)GO TO 211 
C            J.R.9.11.07	  
                PZNEW2CHAINENDO= SQRT(ABS(ENEW2CHAINENDO**2-
     *	    PXNEW2CHAINEND**2-PYNEW2CHAINEND**2))   
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' *** We go back into original Lorentz frame'
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' old chain:PX,PY,PHKK3KK,PHKK4KK ',
     *      PHKK(1,KK),PHKK(2,KK),PHKK3KK,PHKK4KK
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' new charmed baryon:PX,PY,PZNEW1O,ENEW1O ',
     *      PXNEW2,PYNEW2,PZNEW1O,ENEW1O
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' new chain end:PX,PY,PZNEW2CHAINENDO,'
     *      ,'ENEW2CHAINENDO',
     *      PXNEW2CHAINEND,PYNEW2CHAINEND,PZNEW2CHAINENDO,
     *      ENEW2CHAINENDO
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'other chain end PHKK(3,KK-2),PHKK(4,KK-2) '
     *      ,PHKK(1,KK-2),PHKK(2,KK-2),PHKK(3,KK-2),PHKK(4,KK-2)
          PZNEWCH1=PZNEW2CHAINENDO+PHKK(3,KK-2)
          ENEWCH1=ENEW2CHAINENDO+PHKK(4,KK-2)
	  PXNEWCH1=PHKK(1,KK-2)+PXNEW2CHAINEND
	  PYNEWCH1=PHKK(2,KK-2)+PYNEW2CHAINEND
	  AMASSNEWCH1=SQRT(ABS(ENEWCH1**2-PZNEWCH1**2-
     *	  PXNEWCH1**2-PYNEWCH1**2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' residual chain:PX,PY,PZNEWCH1,ENEWCH1,MASS ',
     *      PXNEWCH1,PYNEWCH1,PZNEWCH1,ENEWCH1,AMASSNEWCH1
C           Mass of charm meson     
            CALL PYKFDI(IDHKK(KK-2),IAD1,INEW2,KFM)
            CALL PYNAME(KFM,CHAUM)
            AMM2=PYMASS(KFM)
          IF(IDBG.EQ.1)
     *    WRITE(6,*)' Charmed MESON ',KFM,AMM2,CHAUM,NCOUNT
	    IF(AMM2.GT.AMASSNEWCH1-0.5D0)GO TO 211
C           Store charmed baryon in event COMMON 	    
            NHKK1=NHKK+1
            ISTHKK1(NHKK1)=1
	    IDHKK1(NHKK1)=KF2
	    JMOHKK1(1,NHKK1)=KK
	    JMOHKK1(2,NHKK1)=0
	    JDAHKK1(1,NHKK1)=0
	    JDAHKK1(2,NHKK1)=0
	    PHKK1(1,NHKK1)=PXNEW2
	    PHKK1(2,NHKK1)=PYNEW2
	    PHKK1(3,NHKK1)=PZNEW1O
	    PHKK1(4,NHKK1)=ENEW1O
	    PHKK1(5,NHKK1)=AM2
	    VHKK1(1,NHKK1)=VHKK(1,KK)
	    VHKK1(2,NHKK1)=VHKK(2,KK)
	    VHKK1(3,NHKK1)=VHKK(3,KK)
	    VHKK1(4,NHKK1)=VHKK(4,KK)
	    WHKK1(1,NHKK1)=WHKK(1,KK)
	    WHKK1(2,NHKK1)=WHKK(2,KK)
	    WHKK1(3,NHKK1)=WHKK(3,KK)
	    WHKK1(4,NHKK1)=WHKK(4,KK)
	    NPOINT(4)=NHKK
	    IPRELIM=NHKK1

	    DO 511 INHKK = IPRELIM,NHKK1
          IF(IDBG.EQ.1)
     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
     *    INHKK,ISTHKK1(INHKK),IDHKK1(INHKK),
     *    JMOHKK1(1,INHKK),JMOHKK1(2,INHKK),JDAHKK1(1,INHKK),
     *    JDAHKK1(2,INHKK), 
     *    (PHKK1(LL,INHKK),LL=1,5)
 511      CONTINUE     
          IDDAA1=JDAHKK(1,KK)
          IDDAA2=JDAHKK(2,KK)
C         DECAY of charmed baryon                                  
          NPY=1
	  KPY(1,1)=1
	  KPY(1,2)=KF2
	  KPY(1,3)=0
	  PPY(1,1)=PXNEW2
	  PPY(1,2)=PYNEW2
	  PPY(1,3)=PZNEW1O
	  PPY(1,4)=ENEW1O
	  PPY(1,5)=AM2
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)NPY,KPY(1,1),KPY(1,2),(PPY(1,IIII),IIII=1,5)
          CALL PYDECY(1)
	  DO 711 III=1,NPY
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' decay ',NPY,
     *      KPY(III,1),KPY(III,2),(PPY(III,IIII),IIII=1,5)
  711     CONTINUE	  
C         NHKK1=NHKK
          ISTHKK1(NHKK1)=2
	  NPYCHA=NPY
	  DO 811 III=2,NPY
	    NHKK1=NHKK1+1
	    ISTHKK1(NHKK1)=KPY(III,1)
	    IDHKK1(NHKK1)=KPY(III,2)
	    PHKK1(1,NHKK1)=PPY(III,1)
	    PHKK1(2,NHKK1)=PPY(III,2)
	    PHKK1(3,NHKK1)=PPY(III,3)
	    PHKK1(4,NHKK1)=PPY(III,4)
	    PHKK1(5,NHKK1)=PPY(III,5)
  811     CONTINUE
          NCHBPOS=NCHBPOS+1
          IF(IDBG.EQ.1)
     *      WRITE (6,*)' Event after charmed baryon in Hilfs- COMMON'
C           WRITE (6,*)' Event after charmed baryon in hC pos',NCHBPOS,
C    *      IDHKK(NHKK-1),ISTHKK(NHKK-1)	    
	    DO 523 INHKK = NHKK+1,NHKK+NPY
          IF(IDBG.EQ.1)
     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
     *    INHKK,ISTHKK1(INHKK),IDHKK1(INHKK),
     *    JMOHKK1(1,INHKK),JMOHKK1(2,INHKK),JDAHKK1(1,INHKK),
     *    JDAHKK1(2,INHKK), 
     *    (PHKK1(LL,INHKK),LL=1,5)
 523      CONTINUE     
          IF(IDBG.EQ.1)
     *WRITE(6,*)' transform', 'ENEWCH1,PZNEWCH1',ENEWCH1,PZNEWCH1
C         We transform residual jet into rest frame  
C=======================================================
C          we first transfom into chain rest frame
          BETCH=PZNEWCH1/ENEWCH1
          BETGCH=PZNEWCH1/(ENEWCH1*SQRT(1.D0-BETCH**2))
          GAMCH=1.D0/(SQRT(1.D0-BETCH**2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'Transform into residual chain rest frame',
     *'     BETCH,BETGCH,GAMCH ',BETCH,BETGCH,GAMCH  
C         Chain     
          PRE3CH=GAMCH*PZNEWCH1-BETGCH*ENEWCH1
          ERECH=GAMCH*ENEWCH1-BETGCH*PZNEWCH1
	  IF(ERECH.LT.2.7D0)GO TO 211
          P3RECHM2=GAMCH*PHKK(3,KK-2)-BETGCH*PHKK(4,KK-2)
          ERECHM2=GAMCH*PHKK(4,KK-2)-BETGCH*PHKK(3,KK-2)
          P3RECHM1=GAMCH*PZNEW2CHAINENDO-BETGCH*ENEW2CHAINENDO
          ERECHM1=GAMCH*ENEW2CHAINENDO-BETGCH*PZNEW2CHAINENDO
          IF(IDBG.EQ.1)
     *    WRITE(6,*)'IN rest frame residual chain' 	  
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  first chain end :',
     *      'W1= P3RECHM1,ERECHM1 ',-4,P3RECHM1,ERECHM1
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  second chain end:',
     *      ' P3RECHM2,ERECHM2 ',IDHKK(KK-2),P3RECHM2,ERECHM2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  Chain:',
     *      'P3RECH,ERECH ',P3RECH,ERECH
C============================================================     
	  ICHARMD=99
          NPY=0
          IOPT=3
	  IREJ=0
	  INHAD=4
C         CALL BAMLUN(4,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ)
C         WRITE(6,*)' BAMLUN(4,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ)',
C     *    4,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ
          itemp10=10
          itemzero=0
          CALL BAMLUN(INHAD,IDHKK(KK-2),itemp10,itempzero,itempzero,
     *     ERECH,IOPT,IREJ)
	  ICHARMD=0
	  DO 824 III=1,NPY
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' after pythia ',NPY,III,
     *      (KPY(III,IIII),IIII=1,3),(PPY(III,IIII),IIII=1,5)
  824     CONTINUE	  
C         TRANSFORM into original frame
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'Transform back into original frame',
     *'     BETCH,BETGCH,GAMCH ',BETCH,BETGCH,GAMCH  
	  DO 844 III=1,NPY
	  PPY3=GAMCH*PPY(III,3)+BETGCH*PPY(III,4)
	  PPY4=GAMCH*PPY(III,4) +BETGCH*PPY(III,3)
	  PPY(III,3)=PPY3
	  PPY(III,4)=PPY4
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' after back transf. ',NPY,III,
     *      (KPY(III,IIII),IIII=1,3),(PPY(III,IIII),IIII=1,5)
  844     CONTINUE	  
C   first we put Charmed Baryon into event COMMON  
C   first we put Charmed Baryon into event COMMON  
C           Store charmed baryon in event COMMON 	    
            NHKK=NHKK+1
C           WRITE(6,*)' charmed baryon in COMMON NHKK ',NHKK
            ISTHKK(NHKK)=ISTHKK1(NHKK)
	    IDHKK(NHKK)=IDHKK1(NHKK)
	    JMOHKK(1,NHKK)=KK
	    JMOHKK(2,NHKK)=0
	    JDAHKK(1,NHKK)=0
	    JDAHKK(2,NHKK)=0
	    PHKK(1,NHKK)=PHKK1(1,NHKK)
	    PHKK(2,NHKK)=PHKK1(2,NHKK)
	    PHKK(3,NHKK)=PHKK1(3,NHKK)
	    PHKK(4,NHKK)=PHKK1(4,NHKK)
	    PHKK(5,NHKK)=PHKK1(5,NHKK)
           IF(ISTHKK(NHKK).EQ.1)THEN
	   IF(PHKK(4,NHKK)**2-PHKK(5,NHKK)**2-
     *      PHKK(1,NHKK)**2-PHKK(2,NHKK)**2.GT.0.D0)THEN
      PHKK(3,NHKK)=SQRT(MAX(0D0,(PHKK(4,NHKK)+PHKK(5,NHKK))*(PHKK(
     * 4,NHKK)-PHKK(5,NHKK))-PHKK(1,NHKK)**2-PHKK(2,NHKK)**2))
           ENDIF
	   ENDIF
	    VHKK(1,NHKK)=VHKK1(1,KK)
	    VHKK(2,NHKK)=VHKK1(2,KK)
	    VHKK(3,NHKK)=VHKK1(3,KK)
	    VHKK(4,NHKK)=VHKK1(4,KK)
	    WHKK(1,NHKK)=WHKK1(1,KK)
	    WHKK(2,NHKK)=WHKK1(2,KK)
	    WHKK(3,NHKK)=WHKK1(3,KK)
	    WHKK(4,NHKK)=WHKK1(4,KK)
          NHKK1=NHKK
          ISTHKK1(NHKK)=2
	  DO 2811 III=2,NPYCHA
	    NHKK=NHKK+1
C           WRITE(6,*)' charmed baryon in COMMON NHKK',NHKK,NPYCHA
	    ISTHKK(NHKK)=ISTHKK1(NHKK)
	    IDHKK(NHKK)=IDHKK1(NHKK)
	    PHKK(1,NHKK)=PHKK1(1,NHKK)
	    PHKK(2,NHKK)=PHKK1(2,NHKK)
	    PHKK(3,NHKK)=PHKK1(3,NHKK)
	    PHKK(4,NHKK)=PHKK1(4,NHKK)
	    PHKK(5,NHKK)=PHKK1(5,NHKK)
           IF(ISTHKK(NHKK).EQ.1)THEN
	   IF(PHKK(4,NHKK)**2-PHKK(5,NHKK)**2-
     *      PHKK(1,NHKK)**2-PHKK(2,NHKK)**2.GT.0.D0)THEN
      PHKK(3,NHKK)=SQRT(MAX(0D0,(PHKK(4,NHKK)+PHKK(5,NHKK))*(PHKK(
     * 4,NHKK)-PHKK(5,NHKK))-PHKK(1,NHKK)**2-PHKK(2,NHKK)**2))
           ENDIF
	   ENDIF
 2811     CONTINUE
	  DO 611 III=IDDAA1,IDDAA2
 	    ISTHKK(III)=2
  611     CONTINUE	  

C   first we put Charmed Baryon into event COMMON  
C   first we put Charmed Baryon into event COMMON  
C         WE insert this into event COMMON  
          IF(IDBG.EQ.1)
     *    WRITE(6,*)' Back in EVENT COMMON residual chain'     
C         WRITE(6,*)' Back in EVENT COMMON pos',NHKK+NPY     
	  DO 855 III=1,NPY
	    NHKK=NHKK+1
	    ISTHKK(NHKK)=KPY(III,1)
	    IDHKK(NHKK)=KPY(III,2)
	    PHKK(1,NHKK)=PPY(III,1)
	    PHKK(2,NHKK)=PPY(III,2)
	    PHKK(3,NHKK)=PPY(III,3)
	    PHKK(4,NHKK)=PPY(III,4)
	    PHKK(5,NHKK)=PPY(III,5)
          IF(IDBG.EQ.1)
     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
     *    NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     *    JMOHKK(1,NHKK),JMOHKK(2,NHKK),JDAHKK(1,NHKK),
     *    JDAHKK(2,NHKK), 
     *    (PHKK(LL,NHKK),LL=1,5)
  855     CONTINUE
C         WRITE(6,*)' Back in EVENT COMMON pos',NHKK    
	  DO 871 I=1,NHKK
          IF(IDBG.EQ.1)
     *    WRITE(6,'(3I4,I6,4I4,5F10.2)')
     *    NHKK,I,ISTHKK(I),IDHKK(I),
     *    JMOHKK(1,I),JMOHKK(2,I),JDAHKK(1,I),
     *    JDAHKK(2,I), 
     *    (PHKK(LL,I),LL=1,5)
  871     CONTINUE

	  GO TO 211
  311     CONTINUE
CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx
CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx
CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx
C         Here we treat : IF(PHKK(3,KK-1).LT.0.D0)
          IF(IT.GE.2)THEN
C   PB JR CORRECTION 10-01-07
             IF(RNDM(VV).GT.0.012D0)GO TO 7667
C             IF(RNDM(VV).GT.1.D0/AAIT)GO TO 7667
C	    IF(RNDM(VV).GT.1.D0/AAIT)GO TO 8667
	  ENDIF
          IQ1=0
          IQ2=0
          IQQ1=0
          IQQ2=0
          IDQQ1=0
          IDQQ2=0
          IF(IDK1/1000.NE.0)THEN
            IQ1=IDK1/1000
	    IQ2=(IDK1-IQ1*1000)/100
	    IDQQ1=(IDK1-IQ1*1000-IQ2*100)
          ENDIF
          IF(IDK2/1000.NE.0)THEN
            IQQ1=IDK2/1000
	    IQQ2=(IDK2-IQQ1*1000)/100
	    IDQQ2=(IDK2-IQQ1*1000-IQQ2*100)
          ENDIF
C
          ID1=4
          IAD1=-4
          IF(IDK2.GT.100)THEN
            CALL PYKFDI(IDK2,ID1,INEW2,KF21)
            CALL PYNAME(KF21,CHAU21)
            AM21=PYMASS(KF21)
            CALL PYKFDI(ID1,IDK2,INEW2,KF22)
            CALL PYNAME(KF22,CHAU22)
            AM22=PYMASS(KF22)
	    IF(KF21.EQ.0.AND.KF22.EQ.0)GO TO 1231
	    IF(KF21.NE.0.AND.KF22.NE.0)GO TO 1232
C	    IF(KF21.NE.0)GO TO 1234
C	    IF(KF22.NE.0)GO TO 1235
 1232       CONTINUE
            IF(AM22.LT.AM21.AND.KF22.NE.0)THEN
 1235         CONTINUE	    
	      KF2=KF22
	      AM2=AM22
	      CHAU2=CHAU22
	      GO TO 1233
	    ELSEIF(AM22.GT.AM21.AND.KF21.NE.0  )THEN
 1234         CONTINUE	    
	      KF2=KF21
	      AM2=AM21
	      CHAU2=CHAU21
	      GO TO 1233
	    ENDIF
 1231       CONTINUE
            GO TO 211
 1233       CONTINUE     
            AM2=PYMASS(KF2)
            IF(IDBG.EQ.1)
     *        WRITE(6,*)' Baryon: KF2,AM2,CHAU2',KF2,AM2,CHAU2
            KFFF=KF2
          ENDIF
          IF(KFFF.EQ.0)GO TO 211
C         PT of charm-anticharm pair      
          CALL PYPTDI(KFFF,PX1,PY1)
          PX2=-PX1
          PY2=-PY1
C           Transverse mass of charm baryon?
          PR2=AM2**2+PX1**2+PY1**2
          CALL PYZDIS(IDHKK(KK-1),ID1,PR2,Z2)
          KKK=KK-2
C          we first transfom into chain rest frame
          BETCH=PHKK(3,KK)/PHKK(4,KK)
          BETGCH=PHKK(3,KK)/(PHKK(4,KK)*SQRT(1.D0-BETCH**2))
          GAMCH=1.D0/(SQRT(1.D0-BETCH**2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'Transform into chain rest frame',
     *'     BETCH,BETGCH,GAMCH ',BETCH,BETGCH,GAMCH  
          P3CH=GAMCH*PHKK(3,KK)-BETGCH*PHKK(4,KK)
          ECH=GAMCH*PHKK(4,KK)-BETGCH*PHKK(3,KK)
          KKK=KK-1
          P3CHM2=GAMCH*PHKK(3,KKK)-BETGCH*PHKK(4,KKK)
          ECHM2=GAMCH*PHKK(4,KKK)-BETGCH*PHKK(3,KKK)
          KKK=KK-2
          P3CHM1=GAMCH*PHKK(3,KKK)-BETGCH*PHKK(4,KKK)
          ECHM1=GAMCH*PHKK(4,KKK)-BETGCH*PHKK(3,KKK)
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  first chain end :',
     *      'W1= P3CHM1,ECHM1 ',KK-2,IDHKK(KK-2),P3CHM1,ECHM1
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  second chain end:',
     *      ' P3CHM2,ECHM2 ',KK-1,IDHKK(KK-1),P3CHM2,ECHM2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  Chain:',
     *      'P3CH,ECH ',KK,IDHKK(KK),P3CH,ECH
          KKK=KK-1
C         W2=ECHM2+P3CHM2
C                replace by
          W2=ECHM2-P3CHM2
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
          Z2=RNDM(V)*Z2
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
CVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV	  
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)' neg pz W2, Z2 ', W2, Z2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' Mass and pt of charm baryon AM2,PX2,PY2 ',
     *      AM2,PX2,PY2      
          PR2=AM2**2+PX2**2+PY2**2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' in chain rest frame second chain end ',
     *      ' (diquark) :',
     *      'W2=ECHM2-P3CHM2,PR2 =AM2**2+PX2**2+PY2**2',
     *    KK-1,IDHKK(KK-1),W2,PR2
C           Energy and pz of charmed baryon     
          ENEW2=0.5D0*(Z2*W2+PR2/MAX(1.D-4,Z2*W2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)
     *      'ENEW2=0.5D0*(Z2*W2+PR2/MAX(1.D-4,Z2*W2))',
     *      ' ENEW2,ECHM2 ',ENEW2,ECHM2  
          IF(ENEW2.GT.ECHM2-0.01D0)GO TO 211
C         PZNEW2=+0.5D0*(Z2*W2-PR2/MAX(1.D-4,Z2*W2))
C         Aenderung
          PZNEW2=-0.5D0*(Z2*W2-PR2/MAX(1.D-4,Z2*W2))
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)' PZNEW2,P3CHM2 ',PZNEW2,P3CHM2
	  PXNEW2=PX2+PHKK(1,KK-1)
	  PYNEW2=PY2+PHKK(2,KK-1)
C         Enery and pz of residual anti-charm chain end     
          PXNEW2CHAINEND=PX1
          PYNEW2CHAINEND=PY1
          ENEW2CHAINEND=ECHM2-ENEW2
          PZNEW2CHAINEND=P3CHM2-PZNEW2
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)'PZNEW2CHAINEND,ENEW2CHAINEND',
     *	  PZNEW2CHAINEND,ENEW2CHAINEND
          IF(ABS(PZNEW2CHAINEND).GT.ENEW2CHAINEND)THEN
	    GO TO 211
          ENDIF
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' Produced charmed baryon:PX,PY,PZNEW2,ENEW2 ',
     *      PXNEW2,PYNEW2,PZNEW2,ENEW2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' resulting chain ',
     *      'end:PX,PY,PZNEW2CHAINEND,ENEW2CHAINEND',
     *      PXNEW2CHAINEND,PYNEW2CHAINEND,PZNEW2CHAINEND,ENEW2CHAINEND
C           Transform back into original Lorentz frame
          PHKK3KK=GAMCH*P3CH+BETGCH*ECH
          PHKK4KK=GAMCH*ECH+BETGCH*P3CH
          PZNEW1O=GAMCH*PZNEW2+BETGCH*ENEW2
          ENEW1O=GAMCH*ENEW2+BETGCH*PZNEW2
          PZNEW2CHAINENDO=GAMCH*PZNEW2CHAINEND+BETGCH*ENEW2CHAINEND
          ENEW2CHAINENDO=GAMCH*ENEW2CHAINEND+BETGCH*PZNEW2CHAINEND
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' *** We go back into original Lorentz frame'
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' old chain:PX,PY,PHKK3KK,PHKK4KK ',
     *      PHKK(1,KK),PHKK(2,KK),PHKK3KK,PHKK4KK
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' new charmed baryon:PX,PY,PZNEW1O,ENEW1O ',
     *      PXNEW2,PYNEW2,PZNEW1O,ENEW1O
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' new chain end:PX,PY,PZNEW2CHAINENDO,'
     *      ,'ENEW2CHAINENDO',
     *      PXNEW2CHAINEND,PYNEW2CHAINEND,PZNEW2CHAINENDO,
     *      ENEW2CHAINENDO
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'other chain end PHKK(3,KK-2),PHKK(4,KK-2) '
     *      ,PHKK(1,KK-2),PHKK(2,KK-2),PHKK(3,KK-2),PHKK(4,KK-2)
          PZNEWCH1=PZNEW2CHAINENDO+PHKK(3,KK-2)
          ENEWCH1=ENEW2CHAINENDO+PHKK(4,KK-2)
	  PXNEWCH1=PHKK(1,KK-2)+PXNEW2CHAINEND
	  PYNEWCH1=PHKK(2,KK-2)+PYNEW2CHAINEND
	  AMASSNEWCH1=SQRT(ABS(ENEWCH1**2-PZNEWCH1**2-
     *	  PXNEWCH1**2-PYNEWCH1**2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)' residual chain:PX,PY,PZNEWCH1,ENEWCH1,MASS ',
     *      PXNEWCH1,PYNEWCH1,PZNEWCH1,ENEWCH1,AMASSNEWCH1
C           Mass of charm meson     
            CALL PYKFDI(IDHKK(KK-2),IAD1,INEW2,KFM)
            CALL PYNAME(KFM,CHAUM)
            AMM2=PYMASS(KFM)
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' Charmed MESON ',KFM,AMM2,CHAUM,NCOUNT
	    IF(AMM2.GT.AMASSNEWCH1-0.5D0)GO TO 211
C           Store charmed baryon in event COMMON 	    
            NHKK1=NHKK+1
            ISTHKK1(NHKK1)=1
	    IDHKK1(NHKK1)=KF2
	    JMOHKK1(1,NHKK1)=KK
	    JMOHKK1(2,NHKK1)=0
	    JDAHKK1(1,NHKK1)=0
	    JDAHKK1(2,NHKK1)=0
	    PHKK1(1,NHKK1)=PXNEW2
	    PHKK1(2,NHKK1)=PYNEW2
	    PHKK1(3,NHKK1)=PZNEW1O
	    PHKK1(4,NHKK1)=ENEW1O
	    PHKK1(5,NHKK1)=AM2
	    VHKK1(1,NHKK1)=VHKK(1,KK)
	    VHKK1(2,NHKK1)=VHKK(2,KK)
	    VHKK1(3,NHKK1)=VHKK(3,KK)
	    VHKK1(4,NHKK1)=VHKK(4,KK)
	    WHKK1(1,NHKK1)=WHKK(1,KK)
	    WHKK1(2,NHKK1)=WHKK(2,KK)
	    WHKK1(3,NHKK1)=WHKK(3,KK)
	    WHKK1(4,NHKK1)=WHKK(4,KK)
	    NPOINT(4)=NHKK
	    IPRELIM=NHKK+1

	    DO 1511 INHKK = IPRELIM,NHKK1
          IF(IDBG.EQ.1)
     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
     *    INHKK,ISTHKK1(INHKK),IDHKK1(INHKK),
     *    JMOHKK1(1,INHKK),JMOHKK1(2,INHKK),JDAHKK1(1,INHKK),
     *    JDAHKK1(2,INHKK), 
     *    (PHKK1(LL,INHKK),LL=1,5)
1511      CONTINUE     
          IDDAA1=JDAHKK(1,KK)
          IDDAA2=JDAHKK(2,KK)
C	  DO 1611 III=IDDAA1,IDDAA2
C 	    ISTHKK(III)=2
C1611     CONTINUE	  
C         DECAY of charmed baryon                                  
          NPY=1
	  KPY(1,1)=1
	  KPY(1,2)=KF2
	  KPY(1,3)=0
	  PPY(1,1)=PXNEW2
	  PPY(1,2)=PYNEW2
	  PPY(1,3)=PZNEW1O
	  PPY(1,4)=ENEW1O
	  PPY(1,5)=AM2
          IF(IDBG.EQ.1)
     *	  WRITE(6,*)NPY,KPY(1,1),KPY(1,2),(PPY(1,IIII),IIII=1,5)
          CALL PYDECY(1)
	  DO 1711 III=1,NPY
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' decay ',NPY,
     *      KPY(III,1),KPY(III,2),(PPY(III,IIII),IIII=1,5)
 1711     CONTINUE	  
          ISTHKK1(NHKK1)=2
	  DO 1811 III=2,NPY
	    NHKK1=NHKK1+1
	    ISTHKK1(NHKK1)=KPY(III,1)
	    IDHKK1(NHKK1)=KPY(III,2)
	    PHKK1(1,NHKK1)=PPY(III,1)
	    PHKK1(2,NHKK1)=PPY(III,2)
	    PHKK1(3,NHKK1)=PPY(III,3)
	    PHKK1(4,NHKK1)=PPY(III,4)
	    PHKK1(5,NHKK1)=PPY(III,5)
 1811     CONTINUE
          NCHBNEG=NCHBNEG+1
          IF(IDBG.EQ.1)
     *      WRITE (6,*)' Event after charmed baryon in hC neg',NCHBNEG
C           WRITE (6,*)' Event after charmed baryon in C neg',NCHBNEG,
C    *      IDHKK(NHKK-1),ISTHKK(NHKK-1)	    
	    DO 1523 INHKK = NHKK+1,NHKK+NPY
          IF(IDBG.EQ.1)
     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
     *    INHKK,ISTHKK1(INHKK),IDHKK1(INHKK),
     *    JMOHKK1(1,INHKK),JMOHKK1(2,INHKK),JDAHKK1(1,INHKK),
     *    JDAHKK1(2,INHKK), 
     *    (PHKK1(LL,INHKK),LL=1,5)
1523      CONTINUE     
          IF(IDBG.EQ.1)
     *WRITE(6,*)' transform', 'ENEWCH1,PZNEWCH1',ENEWCH1,PZNEWCH1
C         We transform residual jet into rest frame  
C=======================================================
C          we first transfom into chain rest frame
          BETCH=PZNEWCH1/ENEWCH1
          BETGCH=PZNEWCH1/(ENEWCH1*SQRT(1.D0-BETCH**2))
          GAMCH=1.D0/(SQRT(1.D0-BETCH**2))
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'Transform into residual chain rest frame',
     *'     BETCH,BETGCH,GAMCH ',BETCH,BETGCH,GAMCH  
C         Chain     
          PRE3CH=GAMCH*PZNEWCH1-BETGCH*ENEWCH1
          ERECH=GAMCH*ENEWCH1-BETGCH*PZNEWCH1
          IF(IDBG.EQ.1)WRITE(6,*)'PRE3CH,ERECH ',PRE3CH,ERECH
	  IF(ERECH.LT.2.7D0)GO TO 211
          P3RECHM2=GAMCH*PHKK(3,KK-2)-BETGCH*PHKK(4,KK-2)
          ERECHM2=GAMCH*PHKK(4,KK-2)-BETGCH*PHKK(3,KK-2)
          P3RECHM1=GAMCH*PZNEW2CHAINENDO-BETGCH*ENEW2CHAINENDO
          ERECHM1=GAMCH*ENEW2CHAINENDO-BETGCH*PZNEW2CHAINENDO
          IF(IDBG.EQ.1)
     *    WRITE(6,*)'IN rest frame residual chain' 	  
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  first chain end :',
     *      'W1= P3RECHM1,ERECHM1 ',-4,P3RECHM1,ERECHM1
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  second chain end:',
     *      ' P3RECHM2,ERECHM2 ',IDHKK(KK-2),P3RECHM2,ERECHM2
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'  Chain:',
     *      'P3RECH,ERECH ',P3RECH,ERECH
C============================================================     
	  ICHARMD=99
          NPY=0
          IOPT=3
	  IREJ=0
	  INHAD=4
C         WRITE(6,*)' BAMLUN(4,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ)'
C         WRITE(6,*)' BAMLUN(INHAD,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ)'
C         CALL BAMLUN(4,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ)
          CALL BAMLUN(INHAD,IDHKK(KK-2),10,0,0,ERECH,IOPT,IREJ)
	  ICHARMD=0
	  DO 1824 III=1,NPY
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' after pythia ',NPY,III,
     *      (KPY(III,IIII),IIII=1,3),(PPY(III,IIII),IIII=1,5)
 1824     CONTINUE	  
C         TRANSFORM into original frame
          IF(IDBG.EQ.1)
     *      WRITE(6,*)'Transform back into original frame',
     *'     BETCH,BETGCH,GAMCH ',BETCH,BETGCH,GAMCH  
	  DO 1844 III=1,NPY
	  PPY3=GAMCH*PPY(III,3)+BETGCH*PPY(III,4)
	  PPY4=GAMCH*PPY(III,4) +BETGCH*PPY(III,3)
	  PPY(III,3)=PPY3
	  PPY(III,4)=PPY4
          IF(IDBG.EQ.1)
     *	    WRITE(6,*)' after back transf. ',NPY,III,
     *      (KPY(III,IIII),IIII=1,3),(PPY(III,IIII),IIII=1,5)
 1844     CONTINUE	  
C   first we put Charmed Baryon into event COMMON  
C   first we put Charmed Baryon into event COMMON  
C           Store charmed baryon in event COMMON 	    
            NHKK=NHKK+1
C           WRITE(6,*)' charmed baryon in COMMON NHKK ',NHKK
            ISTHKK(NHKK)=ISTHKK1(NHKK)
	    IDHKK(NHKK)=IDHKK1(NHKK)
	    JMOHKK(1,NHKK)=KK
	    JMOHKK(2,NHKK)=0
	    JDAHKK(1,NHKK)=0
	    JDAHKK(2,NHKK)=0
	    PHKK(1,NHKK)=PHKK1(1,NHKK)
	    PHKK(2,NHKK)=PHKK1(2,NHKK)
	    PHKK(3,NHKK)=PHKK1(3,NHKK)
	    PHKK(4,NHKK)=PHKK1(4,NHKK)
	    PHKK(5,NHKK)=PHKK1(5,NHKK)
            IF(ISTHKK(NHKK).EQ.1)THEN
            IF(PHKK(4,NHKK)**2-PHKK(5,NHKK)**2-
     *      PHKK(1,NHKK)**2-PHKK(2,NHKK)**2.GT.0.D0)THEN
      PHKK(3,NHKK)=-SQRT(MAX(0D0,(PHKK(4,NHKK)+PHKK(5,NHKK))*(PHKK
     * (4,NHKK)-PHKK(5,NHKK))-PHKK(1,NHKK)**2-PHKK(2,NHKK)**2))
            ENDIF
            ENDIF
	    VHKK(1,NHKK)=VHKK1(1,KK)
	    VHKK(2,NHKK)=VHKK1(2,KK)
	    VHKK(3,NHKK)=VHKK1(3,KK)
	    VHKK(4,NHKK)=VHKK1(4,KK)
	    WHKK(1,NHKK)=WHKK1(1,KK)
	    WHKK(2,NHKK)=WHKK1(2,KK)
	    WHKK(3,NHKK)=WHKK1(3,KK)
	    WHKK(4,NHKK)=WHKK1(4,KK)
            IF(JMOHKK(1,NHKK).EQ.0)THEN
              WRITE(6,*)'JMOHKK(1,NHKK).EQ.0 NHKK ',NHKK
              GO TO 7667
            ENDIF
          NHKK1=NHKK
          ISTHKK1(NHKK)=2
	  DO 3811 III=2,NPYCHA
	    NHKK=NHKK+1
C           WRITE(6,*)' charmed baryon in COMMON NHKK',NHKK,NPYCHA
	    ISTHKK(NHKK)=ISTHKK1(NHKK)
	    IDHKK(NHKK)=IDHKK1(NHKK)
	    PHKK(1,NHKK)=PHKK1(1,NHKK)
	    PHKK(2,NHKK)=PHKK1(2,NHKK)
	    PHKK(3,NHKK)=PHKK1(3,NHKK)
	    PHKK(4,NHKK)=PHKK1(4,NHKK)
	    PHKK(5,NHKK)=PHKK1(5,NHKK)
            IF(ISTHKK(NHKK).EQ.1)THEN
            IF(PHKK(4,NHKK)**2-PHKK(5,NHKK)**2-
     *      PHKK(1,NHKK)**2-PHKK(2,NHKK)**2.GT.0.D0)THEN
      PHKK(3,NHKK)=-SQRT(MAX(0D0,(PHKK(4,NHKK)+PHKK(5,NHKK))*(PHKK
     * (4,NHKK)-PHKK(5,NHKK))-PHKK(1,NHKK)**2-PHKK(2,NHKK)**2))
            ENDIF
            ENDIF
 3811     CONTINUE
	  DO 1611 III=IDDAA1,IDDAA2
 	    ISTHKK(III)=2
 1611     CONTINUE	  

C   first we put Charmed Baryon into event COMMON  
C   first we put Charmed Baryon into event COMMON  
C         WE insert this into event COMMON  
          IF(IDBG.EQ.1)
     *    WRITE(6,*)' Back in EVENT COMMON residual chain'     
C         WRITE(6,*)' Back in EVENT COMMON pos',NHKK+NPY     
	  DO 1855 III=1,NPY
	    NHKK=NHKK+1
	    ISTHKK(NHKK)=KPY(III,1)
	    IDHKK(NHKK)=KPY(III,2)
	    PHKK(1,NHKK)=PPY(III,1)
	    PHKK(2,NHKK)=PPY(III,2)
	    PHKK(3,NHKK)=PPY(III,3)
	    PHKK(4,NHKK)=PPY(III,4)
	    PHKK(5,NHKK)=PPY(III,5)
          IF(IDBG.EQ.1)
     *    WRITE(6,'(2I4,I6,4I4,5F10.2)')
     *    NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     *    JMOHKK(1,NHKK),JMOHKK(2,NHKK),JDAHKK(1,NHKK),
     *    JDAHKK(2,NHKK), 
     *    (PHKK(LL,NHKK),LL=1,5)
 1855     CONTINUE
C         WRITE(6,*)' Back in EVENT COMMON neg ',NHKK    
	  DO 1871 I=1,NHKK
          IF(IDBG.EQ.1)
     *    WRITE(6,'(3I4,I6,4I4,5F10.2)')
     *    NHKK,I,ISTHKK(I),IDHKK(I),
     *    JMOHKK(1,I),JMOHKK(2,I),JDAHKK(1,I),
     *    JDAHKK(2,I), 
     *    (PHKK(LL,I),LL=1,5)
 1871     CONTINUE


	  GO TO 211


CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx
CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx
CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx

  211     CONTINUE
        ENDIF
 7667 CONTINUE     
C         WRITEOUT for selected event end of DIQTOC
C          IF(IDIQTOC.LT.500)THEN
C            WRITE(6,*)' end of DIQTOC,NCOUNT,NHKK,IDIQTOC ',NCOUNT,NHKK,
C     *	    IDIQTOC
C          NHKKK=NHKK
C      DO 2315 KKK=1,NHKKK
C          WRITE(6,'(2I4,I6,4I4,5F10.2)')
C     *    KKK,ISTHKK(KKK),IDHKK(KKK),
C     *    JMOHKK(1,KKK),JMOHKK(2,KKK),JDAHKK(1,KKK),JDAHKK(2,KKK), 
C     *    (PHKK(LL,KKK),LL=1,5)
C 2315 CONTINUE 
C      ENDIF
 8667   CONTINUE
C=============================================================     


      RETURN
      END
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      SUBROUTINE KKEVT(NHKKH1,EPN,PPN,KKMAT,IREJ)
*
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      SAVE
 
c_ae_ ------------------------------------------------------------------
c_ae_ change to use flexible output unit in DPMJET - automated procedure
c_ae_                     modified WRITE and PRINT statements not marked
c_ae_
c_ae_                                         nov-00  anton.empl@cern.ch
      common /IOdpmjet/ IOdpm
c_ae_
 
      COMMON/INTNEZ/NDZ,NZD
*KEEP,HKKEVT.
c     INCLUDE (HKKEVT)
      PARAMETER (NMXHKK= 49998)
c     PARAMETER (NMXHKK=25000)
      COMMON /HKKEVT/ NHKK,NEVHKK,ISTHKK(NMXHKK),IDHKK(NMXHKK), JMOHKK
     +(2,NMXHKK),JDAHKK(2,NMXHKK), PHKK(5,NMXHKK),VHKK(4,NMXHKK),WHKK
     +(4,NMXHKK)
C
C                       WHKK(4,NMXHKK) GIVES POSITIONS AND TIMES IN
C                       PROJECTILE FRAME, THE CHAINS ARE CREATED ON
C                       THE POSITIONS OF THE PROJECTILE NUCLEONS
C                       IN THE PROJECTILE FRAME (TARGET NUCLEONS IN
C                       TARGET FRAME) BOTH POSITIONS ARE THREFORE NOT
C                       COMPLETELY CONSISTENT. THE TIMES IN THE
C                       PROJECTILE FRAME HOWEVER ARE OBTAINED BY
C                       LORENTZ TRANSFORMING FROM THE LAB SYSTEM.
C
C  Based on the proposed standard COMMON block (Sjostrand Memo 17.3,89)
C
C NMXHKK: maximum numbers of entries (partons/particles) that can be
C    stored in the commonblock.
C
C NHKK: the actual number of entries stored in current event. These are
C    found in the first NHKK positions of the respective arrays below.
C    Index IHKK, 1 <= IHKK <= NHKK, is below used to denote a given
C    entry.
C
C ISTHKK(IHKK): status code for entry IHKK, with following meanings:
C    = 0 : null entry.
C    = 1 : an existing entry, which has not decayed or fragmented.
C        This is the main class of entries which represents the
C        "final state" given by the generator.
C    = 2 : an entry which has decayed or fragmented and therefore
C        is not appearing in the final state, but is retained for
C        event history information.
C    = 3 : a documentation line, defined separately from the event
C        history. (incoming reacting
C        particles, etc.)
C    = 4 - 10 : undefined, but reserved for future standards.
C    = 11 - 20 : at the disposal of each model builder for constructs
C        specific to his program, but equivalent to a null line in the
C        context of any other program. One example is the cone defining
C        vector of HERWIG, another cluster or event axes of the JETSET
C        analysis routines.
C    = 21 - : at the disposal of users, in particular for event tracking
C        in the detector.
C
C IDHKK(IHKK) : particle identity, according to the Particle Data Group
C    standard.
C
C JMOHKK(1,IHKK) : pointer to the position where the mother is stored.
C    The value is 0 for initial entries.
C
C JMOHKK(2,IHKK) : pointer to position of second mother. Normally only
C    one mother exist, in which case the value 0 is used. In cluster
C    fragmentation models, the two mothers would correspond to the q
C    and qbar which join to form a cluster. In string fragmentation,
C    the two mothers of a particle produced in the fragmentation would
C    be the two endpoints of the string (with the range in between
C    implied).
C
C JDAHKK(1,IHKK) : pointer to the position of the first daughter. If an
C    entry has not decayed, this is 0.
C
C JDAHKK(2,IHKK) : pointer to the position of the last daughter. If an
C    entry has not decayed, this is 0. It is assumed that the daughters
C    of a particle (or cluster or string) are stored sequentially, so
C    that the whole range JDAHKK(1,IHKK) - JDAHKK(2,IHKK) contains
C    daughters. Even in cases where only one daughter is defined (e.g.
C    K0 -> K0S) both values should be defined, to make for a uniform
C    approach in terms of loop constructions.
C
C PHKK(1,IHKK) : momentum in the x direction, in GeV/c.
C
C PHKK(2,IHKK) : momentum in the y direction, in GeV/c.
C
C PHKK(3,IHKK) : momentum in the z direction, in GeV/c.
C
C PHKK(4,IHKK) : energy, in GeV.
C
C PHKK(5,IHKK) : mass, in GeV/c**2. For spacelike partons, it is allowed
C    to use a negative mass, according to PHKK(5,IHKK) = -sqrt(-m**2).
C
C VHKK(1,IHKK) : production vertex x position, in mm.
C
C VHKK(2,IHKK) : production vertex y position, in mm.
C
C VHKK(3,IHKK) : production vertex z position, in mm.
C
C VHKK(4,IHKK) : production time, in mm/c (= 3.33*10**(-12) s).
C********************************************************************
*KEEP,INTMX.
      PARAMETER (INTMX=2488,INTMD=252)
*KEEP,DXQX.
C     INCLUDE (XQXQ)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON /DXQX/ XPVQ(248),XPVD(248),XTVQ(248),XTVD(248), XPSQ
     +(INTMX),XPSAQ(INTMX),XTSQ(INTMX),XTSAQ(INTMX)
     *                ,XPSU(248),XTSU(248)
     *                ,XPSUT(248),XTSUT(248)
*KEEP,INTNEW.
      COMMON /INTNEW/ NVV,NSV,NVS,NSS,NDV,NVD,NDS,NSD,
     +IXPV,IXPS,IXTV,IXTS, INTVV1(248),
     +INTVV2(248),INTSV1(248),INTSV2(248), INTVS1(248),INTVS2(248),
     +INTSS1(INTMX),INTSS2(INTMX),
     +INTDV1(248),INTDV2(248),INTVD1(248),INTVD2(248),
     +INTDS1(INTMD),INTDS2(INTMD),INTSD1(INTMD),INTSD2(INTMD)
 
C  /INTNEW/
C       NVV    :   NUMBER OF INTERACTING VALENCE-VALENCE SYSTEMS
C       NSV    :   NUMBER OF INTERACTING SEA-VALENCE SYSTEMS
C       NVS    :   NUMBER OF INTERACTING VALENCE-SEA SYSTEMS
C       NSS    :   NUMBER OF INTERACTING SEA-SEA SYSTEMS
C       IXPV, IXTV : NUMBER OF GENERATED X-VALUES FOR VALENCE-QUARK
C                     SYSTEMS FROM PROJECTILE/TARGET NUCLEI
C       IXPS, IXTS : NUMBER OF GENERATED X-VALUES FOR SEA-QUARK PAIRS
C                     FROM PROJECTILE/TARGET NUCLEI
C-------------------
*KEEP,IFROTO.
      COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
     +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
     +JHKKNT
     +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
     +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
     &                MHKKHH(INTMX),
     +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
*KEEP,LOZUO.
      LOGICAL ZUOVP,ZUOSP,ZUOVT,ZUOST,INTLO,INLOSS
      COMMON /LOZUO/ ZUOVP(248),ZUOSP(INTMX),ZUOVT(248),ZUOST(INTMX),
     +INTLO(INTMX),INLOSS(INTMX)
C  /LOZUO/
C      /
C INLOSS :  .FALSE. IF CORRESPONDING SEA-SEA INTERACTION
C                         REJECTED IN KKEVT
C------------------
*KEEP,DIQI.
      COMMON /DIQI/ IPVQ(248),IPPV1(248),IPPV2(248), ITVQ(248),ITTV1
     +(248),ITTV2(248), IPSQ(INTMX),IPSQ2(INTMX),
     +IPSAQ(INTMX),IPSAQ2(INTMX),ITSQ(INTMX),ITSQ2(INTMX),
     +ITSAQ(INTMX),ITSAQ2(INTMX),KKPROJ(248),KKTARG(248)
*KEEP,SHMAKL.
C     INCLUDE (SHMAKL)
* NOTE: INTMX set via INCLUDE(INTMX)
      COMMON/SHMAKL/JSSH(INTMX),JTSH(INTMX),INTER1(INTMX),INTER2(INTMX)
*KEEP,NUCC.
      COMMON /NUCC/   IT,ITZ,IP,IPZ,IJPROJ,IBPROJ,IJTARG,IBTARG
*KEEP,RPTSHM.
      COMMON /RPTSHM/ RPROJ,RTARG,BIMPAC
*KEEP,NSHMAK.
      COMMON /NSHMAK/ NNSHMA,NPSHMA,NTSHMA,NSHMAC,NSHMA2
*KEEP,ZENTRA.
      COMMON /ZENTRA/ ICENTR
*KEEP,NUCIMP.
      COMMON /NUCIMP/ PRMOM(5,248),TAMOM(5,248), PRMFEP,PRMFEN,TAMFEP,
     +TAMFEN, PREFEP,PREFEN,TAEFEP,TAEFEN, PREPOT(210),TAEPOT(210),
     +PREBIN,TAEBIN,FERMOD,ETACOU
*KEEP,DROPPT.
      LOGICAL INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA, IPADIS,
     +ISHMAL,LPAULI
      COMMON /DROPPT/ INTPT,FERMP,IHADSS,IHADSV,IHADVS,IHADVV,IHADA,
     +IPADIS,ISHMAL,LPAULI
*KEEP,NNCMS.
      COMMON /NNCMS/  GAMCM,BGCM,UMO,PCM,EPROJ,PPROJ
*KEEP,NUCPOS.
      COMMON /NUCPOS/INVVP(248),INVVT(248),INVSP(248),INVST(248), NUVV,
     +NUVS,NUSV,NUSS,INSVP(248),INSVT(248),INSSP(248),INSST(248), ISVEAP
     +(248),ISVEAT(248),ISSEAP(248),ISSEAT(248), IVSEAP(248),IVSEAT
     +(248), ISLOSP(248),ISLOST(248),INOOP(248),INOOT(248),NUOO
*KEEP,TAUFO.
      COMMON /TAUFO/  TAUFOR,KTAUGE,ITAUVE,INCMOD
      COMMON /EVAPPP/IEVAP
*KEEP,RTAR.
      COMMON /RTAR/ RTARNU
*KEEP,INNU.
      COMMON /INNU/INUDEC
*KEEP,HADTHR.
      COMMON /HADTHR/ EHADTH,INTHAD
*KEEP,DINPDA.
      COMMON /DINPDA/ IMPS(6,6),IMVE(6,6),IB08(6,21),IB10(6,21), IA08
     +(6,21),IA10(6,21), A1,B1,B2,B3,LT,LE,BET,AS,B8,AME,DIQ,ISU
*KEEP,FERMI.
      COMMON /FERMI/ PQUAR(4,248),PAQUAR(4,248), TQUAR(4,248),TAQUAR
     +(4,248)
*KEEP,KETMAS.
      COMMON /KETMAS/ AM8(2),AM10(2),IB88(2),IB1010(2),AMCH1N,AMCH2N
*KEEP,DPAR.
C     /DPAR/   CONTAINS PARTICLE PROPERTIES
C        ANAME  = LITERAL NAME OF THE PARTICLE
C        AAM    = PARTICLE MASS IN GEV
C        GA     = DECAY WIDTH
C        TAU    = LIFE TIME OF INSTABLE PARTICLES
C        IICH   = ELECTRIC CHARGE OF THE PARTICLE
C        IIBAR  = BARYON NUMBER
C        K1,K1  = BIGIN AND END OF DECAY CHANNELS OF PARTICLE
C
      CHARACTER*8  ANAME
      COMMON /DPAR/ ANAME(210),AAM(210),GA(210),TAU(210),IICH(210),
     +IIBAR(210),K1(210),K2(210)
C------------------
*KEEP,DPRIN.
      COMMON /DPRIN/  IPRI,IPEV,IPPA,IPCO,INIT,IPHKK,ITOPD,IPAUPR
*KEEP,NUCKOO.
      COMMON /NUCKOO/ PKOO(3,INTMX),TKOO(3,INTMX),PPOO(3,INTMX),
     +TPOO(3,INTMX)
*KEEP,REJEC.
      COMMON /REJEC/ IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,IRVS13,
     +IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
*KEEP,PROJK.
      COMMON /PROJK/ IPROJK
*KEEP,TANUIN.
      COMMON /TANUIN/ TASUMA,TASUBI,TABI,TAMASU,TAMA,TAIMMA
*KEND.
      COMMON /DIFFRA/ ISINGD,IDIFTP,IOUDIF,IFLAGD
*
      LOGICAL LSEADI
      COMMON /SEADIQ/ LSEADI
      COMMON /EVFLAG/NUMEV
      COMMON /DIQUAX/AMEDD,IDIQUA,IDIQUU
C
C-----------------------------------------------------------------------
C     PARAMETER (INTMX=2488)
      COMMON /ABRJT/XJQ1(INTMX),XJAQ1(INTMX),XJQ2(INTMX),XJAQ2(INTMX),
     *        IJJQ1(INTMX),IJJAQ1(INTMX),IJJQ2(INTMX),IJJAQ2(INTMX),
     *        AMJCH1(INTMX),AMJCH2(INTMX),GAMJH1(INTMX),GAMJH2(INTMX),
     *        BGJH1(INTMX),BGJH2(INTMX),THEJH1(INTMX),THEJH2(INTMX),
     *        BGXJH1(INTMX),BGYJH1(INTMX),BGZJH1(INTMX),
     *        BGXJH2(INTMX),BGYJH2(INTMX),BGZJH2(INTMX),
     *  PJETA1(INTMX,4),PJETA2(INTMX,4),PJETB1(INTMX,4),PJETB2(INTMX,4)
     * ,JHKKPH(INTMX),JHKKTH(INTMX),JHKKEX(INTMX),JHKKE1(INTMX)
      COMMON /ABRSOF/XSQ1(INTMX),XSAQ1(INTMX),XSQ2(INTMX),XSAQ2(INTMX),
     *        IJSQ1(INTMX),IJSAQ1(INTMX),IJSQ2(INTMX),IJSAQ2(INTMX),
     *        AMCCH1(INTMX),AMCCH2(INTMX),GAMCH1(INTMX),GAMCH2(INTMX),
     *        BGCH1(INTMX),BGCH2(INTMX),THECH1(INTMX),THECH2(INTMX),
     *        BGXCH1(INTMX),BGYCH1(INTMX),BGZCH1(INTMX),
     *        BGXCH2(INTMX),BGYCH2(INTMX),BGZCH2(INTMX),
     *        NCH1(INTMX),NCH2(INTMX),IJCH1(INTMX),IJCH2(INTMX),
     *  PSOFA1(INTMX,4),PSOFA2(INTMX,4),PSOFB1(INTMX,4),PSOFB2(INTMX,4)
     * ,JHKKPZ(INTMX),JHKKTZ(INTMX),JHKKSX(INTMX),JHKKS1(INTMX)
*KEEP,ABRSS.
C     INCLUDE (ABRSS)
      COMMON /ABRSS/ AMCSS1(INTMX),AMCSS2(INTMX), GACSS1(INTMX),GACSS2
     +(INTMX), BGXSS1(INTMX),BGYSS1(INTMX),BGZSS1(INTMX), BGXSS2(INTMX),
     +BGYSS2(INTMX),BGZSS2(INTMX), NCHSS1(INTMX),NCHSS2(INTMX), IJCSS1
     +(INTMX),IJCSS2(INTMX), PQSSA1(INTMX,4),PQSSA2(INTMX,4), PQSSB1
     +(INTMX,4),PQSSB2(INTMX,4)
      COMMON /NUCJTN/NONUJ1,NONUJT,NONUS1,NONUST
      COMMON /XSVTHR/ XSTHR,XVTHR,XDTHR,XSSTHR
      COMMON /MINIJ/IMINIJ,NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
      COMMON /NCSHXX/NCOUXH,NCOUXT
      COMMON/INTNEU/NDZSU,NZDSU
      COMMON /VXSVD/VXSP(50),VXST(50),VXSAP(50),VXSAT(50),
     *              VXVP(50),VXVT(50),VXDP(50),VXDT(50),
     *      NXSP,NXST,NXSAP,NXSAT,NXVP,NXVT,NXDP,NXDT
      COMMON /NPARTT/NPART
      COMMON /ZSEA/ZSEAAV,ZSEASU,ANZSEA
      DATA NCOUSH/0/
      DATA NCOUST/0/
      DATA SUNDZ /0/
      DATA SUNZD /0/
      DATA IEVEVEV /0/
      ANZSEA=0.D0
      ZSEASU=0.D0
      ZSEAAV=0.D0
C
      DO 5533 JJ=1,INTMX
        NCHSS1(JJ)=0
        NCHSS2(JJ)=0
 5533 CONTINUE
C                                    smoth transition between HADRIN and DPM
       EHADTW=EHADTH-RNDM(V)*2.D0
C*******************************************************************"
C
C     KINEMATICS
C
C********************************************************************
C
      IREJ = 0
*
      AAM(26)=AAM(23)
C
      KPROJ=1
      IF(IJPROJ.NE.0) KPROJ=IJPROJ
      KTARG=1
      ATNUC=IT
      ITN=IT-ITZ
      APNUC=IP
      IPN=IP-IPZ
      AMPROJ =AAM(KPROJ)
      AMTAR =AAM(KTARG)
*                             nucleon-nucleon cms
C     IBPROJ=1
      EPROJ=EPN
      PPROJ = SQRT((EPN-AMPROJ)*(EPN+AMPROJ))
      UMO = SQRT(AMPROJ**2 + AMTAR**2 + 2.*AMTAR*EPROJ)
      GAMCM = (EPROJ+AMTAR)/UMO
      BGCM=PPROJ/UMO
      ECM=UMO
      PCM=GAMCM*PPROJ - BGCM*EPROJ
C
      IF(IPEV.GE.1) WRITE(IOdpm,1000) 
     & IP,IPZ,IT,ITZ,IJPROJ,IBPROJ, EPROJ,PPROJ,
     +AMPROJ,AMTAR,UMO,GAMCM,BGCM
 1000 FORMAT(' ENTRY KKEVT'/ '    IP,IPZ,IT,ITZ,IJPROJ,IBPROJ',6I5/
     +'    EPROJ,PPROJ,AMPROJ,AMTAR,UMO,GAMCM,BGCM'/10E12.3)
 
C
C****                            CHANGE PARAMETERS FROM COMMON \INPDAT\
      AS=0.5
      B8=0.4
C                                CHAIN PT BIGGER THAN PARTICLE PT
      N9483=0
*  entry after rejection of an event because of kinematical reasons
*  several trials are made to realize a sampled Glauber event
   10 CONTINUE
C     WRITE(6,*)' rejection 10 in KKEVT '
      IREJ=0
      NDZ=0
      NZD=0
      N9483=N9483+1
      IF (MOD(N9483,125000).EQ.0) THEN
        WRITE(IOdpm,'(A,I5,A,I5,A)') ' KKEVT: Glauber event',NUMEV,
     +  ' rejected after', N9483, ' trials'
        WRITE(IOdpm, 1010) NN,NP,NT
        WRITE(IOdpm,1020) IRCO1,IRCO2,IRCO3,IRCO4,IRCO5, IRSS11,IRSS12,
     +  IRSS13,IRSS14, IRSV11,IRSV12,IRSV13,IRSV14, IRVS11,IRVS12,
     +  IRVS13,IRVS14, IRVV11,IRVV12,IRVV13,IRVV14
        N9483=1
        GO TO 20
      ELSEIF(N9483.GT.1) THEN
                                                                 GOTO 30
      ENDIF
 1010 FORMAT (5X,' N9483 LOOP - NN, NP, NT',5I10)
 1020 FORMAT (5X,' N9483 LOOP - REJECTION COUNTERS ',/,5I8/2(8I8/))
C
C***************************************************************
C
C     SAMPLE NUMBERS OF COLLISION A LA SHMAKOV---------------
C
C     TOTAL NUMBER OF INTERACTIONS = NN
C     NUMBER OF INTERACTING NUCLEONS
C                  FROM PROJECTILE = NP
C                  FROM TARGET = NT
C
      NCOUSH=NCOUSH+1
      NCOUXH=NCOUSH
      GO TO 2077
   20 CONTINUE
   22 CONTINUE
      NCOUST=NCOUST+1
      NCOUXT=NCOUST
 2077 CONTINUE
! **anfe Do not shmako in hadron-nucleon collisions
      If ((ip == 1) .And. (it==1)) Then
        If (icalsh == 0) Then
          CALL SHMAKO(IP,IT,BIMP,NN,NP,NT,JSSH,JTSH,PPROJ,KKMAT)
          icalsh = 1
          bimp = 0.D0
        End If
      Else
        CALL SHMAKO(IP,IT,BIMP,NN,NP,NT,JSSH,JTSH,PPROJ,KKMAT)
      End If
C     WRITE(6,*)' IP,IT,BIMP,NN,NP,NT ',IP,IT,BIMP,NN,NP,NT
      NPART=NP+NT
************    score characteristics of all sampled Glauber events
      CALL SHMAK(2,NN,NP,NT,IP,IT,ECM,BIMP)
      NSHMAC=NSHMAC+1
      IF ((ISINGD.GE.2).AND.((NT.NE.1).OR.(NN.NE.1))) GOTO 22
*
      IF (NN.GT.INTMX) THEN
        WRITE(IOdpm,1030)NN,NP,NT
 1030 FORMAT (' NN.GT.INTMX  SHMAKO SET TO INTMX ',3I10)
        NN=INTMX
      ENDIF
      NNSHMA=NN
      NPSHMA=NP
      NTSHMA=NT
C                    CENTRAL PRODUCTION FOR ICENTR.EQ.1 or 2
      IF (IP.LT.IT.AND.IT.LE.150)THEN
        IF(IP.LE.8)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-1)GO TO 20
        ELSEIF(IP.LE.16)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-2)GO TO 20
        ELSEIF(IP.LT.32)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-3)GO TO 20
        ELSEIF(IP.GE.32)THEN
C      Example S-Ag	
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-1)GO TO 20
        ENDIF
      ELSEIF (IP.LT.IT.AND.IT.GT.150)THEN
        IF(IP.LE.8)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-1)GO TO 20
        ELSEIF(IP.LE.16)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-2)GO TO 20
        ELSEIF(IP.LT.32)THEN
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-3)GO TO 20
        ELSEIF(IP.GE.32)THEN
C      Example S-Au	
          IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP)GO TO 20
        ENDIF
      ELSEIF(IP.EQ.IT)THEN
        IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.IP.EQ.32)THEN
C      Example S-S	
           IF(NP.LT.22.OR.NT.LT.22)                             GO TO 20
        ELSEIF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).
     *AND.(UMO.GT.200.).AND.(NP.LT.IP-IP/10))THEN
C      Example Pb-Pb   central like at RHIC,LHC  UMO .GT.100	
                     GO TO 20
        ELSEIF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).
     *AND.(UMO.LE.200.).AND.(NP.LT.IP-IP/4))THEN
C      Example Pb-Pb   central like at SPS umo .LE.200	
                     GO TO 20
        ELSEIF ((ICENTR.EQ.3).AND.NP.LT.IP-2*IP/3)THEN
C      Example Pb-Pb less central	
                     GO TO 20
        ENDIF
      ELSEIF(ABS(IP-IT).LT.3)THEN
        IF ((ICENTR.EQ.1.OR.ICENTR.EQ.2).AND.NP.LT.IP-IP/8)GO TO 20
      ENDIF
      BIMPAC=BIMP
C                    PERIPHERAL PRODUCTION FOR ICENTR.EQ.10
          IF (ICENTR.EQ.10.AND.NP.GT.6)                        GO TO 20
C------------------------------------------------------------
C     Drop diffractive collisions out of the Glauber
C     cascade in nucleus-nucleus collisions (For NN > 1 only)
      IF((ISINGD.LE.1).AND.(NN.GE.2).AND.(IP.GE.2).AND.(IT.GE.2).AND.
     *(IP.LE.200))THEN
        CALL DROPDI(NN,NP,NT,ECM)
        IF (IPEV.GE.3) THEN
        WRITE(IOdpm, 1040) IP,IPZ,IT,ITZ,EPROJ,PPROJ,NN,NP,NT
        WRITE(IOdpm,'(/A,2I5,1PE10.2,3I5)')
     +  ' KKEVT: IP,IT,BIMP,NN,NP,NT ',
     +  IP,IT,BIMP,NN,NP,NT
        WRITE(IOdpm,'(/2A)')
     +  ' KKEVT: JSSH(KKK),JTSH(KKK),INTER1(KKK),INTER2(KKK),',
     +  ' PKOO(3,KKK),TKOO(3,KKK)'
        ITUM=MAX(IT,IP,NN)
        DO 4011 KKK=1,ITUM
          WRITE(IOdpm,'(4I5,6(1PE11.3))')
     +  JSSH(KKK),JTSH(KKK),INTER1(KKK),
     +    INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),PKOO(3,KKK), TKOO(1,KKK),
     +    TKOO(2,KKK),TKOO(3,KKK)
 4011   CONTINUE
        ENDIF
      ENDIF
************    score characteristics of all sampled Glauber events
      CALL SHMAK1(2,NN,NP,NT,IP,IT,ECM,BIMP)
      NSHMA2=NSHMA2+1
C------------------------------------------------------------
C
*  entry for repeated trial to realize a sampled Glauber event
   30 CONTINUE
      IF (IPEV.GE.3) THEN
        WRITE(IOdpm, 1040) IP,IPZ,IT,ITZ,EPROJ,PPROJ,NN,NP,NT
 1040 FORMAT ('   752 FORM ',4I10,2F10.3,5I10)
        WRITE(IOdpm,'(/A,2I5,1PE10.2,3I5)')
     +  ' KKEVT: IP,IT,BIMP,NN,NP,NT ',
     +  IP,IT,BIMP,NN,NP,NT
        WRITE(IOdpm,'(/2A)')
     +  ' KKEVT: JSSH(KKK),JTSH(KKK),INTER1(KKK),INTER2(KKK),',
     +  ' PKOO(3,KKK),TKOO(3,KKK)'
        ITUM=MAX(IT,IP,NN)
        DO 40 KKK=1,ITUM
          WRITE(IOdpm,'(4I5,6(1PE11.3))')
     +  JSSH(KKK),JTSH(KKK),INTER1(KKK),
     +    INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),PKOO(3,KKK), TKOO(1,KKK),
     +    TKOO(2,KKK),TKOO(3,KKK)
 
   40   CONTINUE
      ENDIF
C
C-----------------------------------------------------------------------
C                  STORE PROJECTILE HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING PROJECTILES ISTHKK=11
C                              NONINTERACTING ...      ISTHKK=13
C                            - FERMI MOMENTA IN CORRESP. REST SYSTEM
C-----------
      NHKK=0
C
      NCPP=0
      NCPN=0
C                      DEFINE FERMI MOMENTA/ENERGIES FOR PROJECTILE
C
      PXFE=0.0
      PYFE=0.0
      PZFE=0.0
      DO 50 KKK=1,IP
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE(IOdpm,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IF (JSSH(KKK).GT.0) THEN
          ISTHKK(NHKK)=11
        ELSE
          ISTHKK(NHKK)=13
        ENDIF
C*
C                                       CHANGED 28.2.90.J.R.
C       IF(IJPROJ.EQ.0) THEN
        IF(IP.GE.2) THEN
C
          FRPNEU=FLOAT(IPN)/APNUC
          SAMTES=RNDM(v)
          IF(SAMTES.LT.FRPNEU.AND.NCPN.LT.IPN) THEN
            KPROJ=8
            NCPN=NCPN + 1
          ELSEIF(SAMTES.GE.FRPNEU.AND.NCPP.LT.IPZ) THEN
            KPROJ=1
            NCPP=NCPP + 1
          ELSEIF(NCPN.LT.IPN) THEN
            KPROJ=8
            NCPN=NCPN + 1
          ELSEIF(NCPP.LT.IPZ) THEN
            KPROJ=1
            NCPP=NCPP + 1
          ENDIF
C
          IF(KPROJ.EQ.1) THEN
            PFERM = PRMFEP
          ELSE
            PFERM = PRMFEN
          ENDIF
C         CALL FER4M(PFERM,FPX,FPY,FPZ,FE,KPROJ)
          CALL FER4MP(IP,PFERM,FPX,FPY,FPZ,FE,KPROJ)
          PXFE=PXFE + FPX
          PYFE=PYFE + FPY
          PZFE=PZFE + FPZ
          PHKK(1,NHKK)=FPX
          PHKK(2,NHKK)=FPY
          PHKK(3,NHKK)=FPZ
          PHKK(4,NHKK)=FE
          PHKK(5,NHKK)=AAM(KPROJ)
C
        ELSE
          KPROJ=IJPROJ
          PHKK(1,NHKK)=0.
          PHKK(2,NHKK)=0.
          PHKK(3,NHKK)=0.
          PHKK(4,NHKK)=AAM(KPROJ)
          PHKK(5,NHKK)=AAM(KPROJ)
        ENDIF
C
        KKPROJ(KKK)=KPROJ
        IDHKK(NHKK)=MPDGHA(KPROJ)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
C
        PHKK(5,NHKK)=AAM(KPROJ)
        VHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        VHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=PKOO(1,KKK)*1.E-12
        WHKK(2,NHKK)=PKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=PKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNP(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(IOdpm,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
 1050 FORMAT (I6,I4,5I6,9E10.2)
C
   50 CONTINUE
C                          balance Sampled Fermi momenta
      IF(IP.GE.2) THEN
        PXFE=PXFE/IP
        PYFE=PYFE/IP
        PZFE=PZFE/IP
        DO 60 KKK=1,IP
          IHKK=KKK
          PHKK(1,IHKK)=PHKK(1,IHKK) - PXFE
          PHKK(2,IHKK)=PHKK(2,IHKK) - PYFE
          PHKK(3,IHKK)=PHKK(3,IHKK) - PZFE
          PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)** 2+ PHKK(1,IHKK)** 2+ PHKK
     +    (2,IHKK)** 2+ PHKK(3,IHKK)**2)
        IF (IPHKK.GE.2) WRITE(IOdpm,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
   60   CONTINUE
      ENDIF
C
C-----------------------------------------------------------------------
C                  STORE TARGET HADRON/NUCLEONS INTO /HKKEVT/
C                            - PROJECTILE CENTRE AT ORIGIN IN SPACE
C                            - TARGET SHIFTED IN X DIRECTION BY
C                                             IMPACT PARAMETER 'BIMP'
C
C                            - SAMPLING OF NUCLEON TYPES
C                            - CONSISTENCY CHECK
C                              FOR SAMPLED P/N NUMBERS
C                            - INTERACTING TARGETS     ISTHKK=12
C                              NONINTERACTING ...      ISTHKK=14
C-----------
C---------------------
      NHADRI=0
      NCTP=0
      NCTN=0
C
      TXFE=0.0
      TYFE=0.0
      TZFE=0.0
      DO 70 KKK=1,IT
        NHKK=NHKK+1
         IF (NHKK.EQ.NMXHKK)THEN
           WRITE(IOdpm,'(A,2I5)')' :NHKK.EQ.NMXHKK ',NHKK,NMXHKK
           RETURN
         ENDIF
        IF (JTSH(KKK).GT.0) THEN
          ISTHKK(NHKK)=12
          NHADRI=NHADRI+1
          IF (NHADRI.EQ.1) IHTAWW=NHKK
          IF (EPN.LE.EHADTW) THEN
            IF (NHADRI.GT.1) ISTHKK(NHKK)=14
          ENDIF
        ELSE
          ISTHKK(NHKK)=14
        ENDIF
        IF(IT.GE.2)THEN
        FRTNEU=FLOAT(ITN)/ATNUC
        SAMTES=RNDM(V)
        IF(SAMTES.LT.FRTNEU.AND.NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(SAMTES.GE.FRTNEU.AND.NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ELSEIF(NCTN.LT.ITN) THEN
          KTARG=8
          NCTN=NCTN + 1
        ELSEIF(NCTP.LT.ITZ) THEN
          KTARG=1
          NCTP=NCTP + 1
        ENDIF
C
        IF(KTARG.EQ.1) THEN
          PFERM = TAMFEP
        ELSE
          PFERM = TAMFEN
        ENDIF
C       CALL FER4M(PFERM,FPX,FPY,FPZ,FE,KTARG)
        CALL FER4MT(IT,PFERM,FPX,FPY,FPZ,FE,KTARG)
        TXFE=TXFE + FPX
        TYFE=TYFE + FPY
        TZFE=TZFE + FPZ
        PHKK(1,NHKK)=FPX
        PHKK(2,NHKK)=FPY
        PHKK(3,NHKK)=FPZ
        PHKK(4,NHKK)=FE
        PHKK(5,NHKK)=AAM(KTARG)
        ELSE
        PHKK(1,NHKK)=0. 
        PHKK(2,NHKK)=0. 
        PHKK(3,NHKK)=0. 
        PHKK(4,NHKK)=AAM(KTARG)
        PHKK(5,NHKK)=AAM(KTARG)
        ENDIF
C
        KKTARG(KKK)=KTARG
        IDHKK(NHKK)=MPDGHA(KTARG)
        JMOHKK(1,NHKK)=0
        JMOHKK(2,NHKK)=0
        JDAHKK(1,NHKK)=0
        JDAHKK(2,NHKK)=0
        VHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        VHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        VHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        VHKK(4,NHKK)=0.
        WHKK(1,NHKK)=(TKOO(1,KKK)+BIMP)*1.E-12
        WHKK(2,NHKK)=TKOO(2,KKK)*1.E-12
        WHKK(3,NHKK)=TKOO(3,KKK)*1.E-12
        WHKK(4,NHKK)=0.
        JHKKNT(KKK)=NHKK
C
        IF (IPHKK.GE.2) WRITE(IOdpm,1050) NHKK,ISTHKK(NHKK),IDHKK(NHKK),
     +  JMOHKK(1,NHKK),JMOHKK(2,NHKK), JDAHKK(1,NHKK),JDAHKK(2,NHKK),
     +  (PHKK(KHKK,NHKK),KHKK=1,5), (VHKK(KHKK,NHKK),KHKK=1,4)
 
C
   70 CONTINUE
C                          balance Sampled Fermi momenta
      IF(IT.GE.2) THEN
        TASUMA=ITZ*AAM(1) + (IT-ITZ)*AAM(8)
        TASUBI=0.0
        TAMASU=0.0
        TXFE=TXFE/IT
        TYFE=TYFE/IT
        TZFE=TZFE/IT
        DO 80 KKK=1,IT
          IHKK=KKK + IP
          PHKK(1,IHKK)=PHKK(1,IHKK) - TXFE
          PHKK(2,IHKK)=PHKK(2,IHKK) - TYFE
          PHKK(3,IHKK)=PHKK(3,IHKK) - TZFE
          PHKK(4,IHKK)=SQRT(PHKK(5,IHKK)** 2+ PHKK(1,IHKK)** 2+ PHKK
     +    (2,IHKK)** 2+ PHKK(3,IHKK)**2)
          ITSEC=MCIHAD(IDHKK(IHKK))
          TASUBI=TASUBI + PHKK(4,IHKK) - PHKK(5,IHKK) - TAEPOT(ITSEC)
          TAMASU=TAMASU + PHKK(4,IHKK) - TAEPOT(ITSEC)
        IF (IPHKK.GE.2) WRITE(IOdpm,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
   80   CONTINUE
C***         definition of initial state
        TABI=-EBIND(IT,ITZ)
        TAMA=(IT-ITZ)*AAM(8) + ITZ*AAM(1) + TABI
        TAIMMA=TAMA - TAMASU
      ENDIF
C
      IF(IPEV.GT.3) THEN
        WRITE(IOdpm,'(/A/5X,A/5X,4(1PE11.3))') ' KKEVT: FERMI MOMENTA',
     +  'PRMFEP,PRMFEN, TAMFEP,TAMFEN', PRMFEP,PRMFEN, TAMFEP,TAMFEN
 
      ENDIF
C-----------------------------------------------------------------------
      IFLAGD = 0
C-----------------------------------------------------------------
C
C                                   Test j.r. 2/94
C
C----------------------------------------------------------------
	IQQDD=0
      IF(IPEV.GT.3) THEN
	WRITE(IOdpm,'(A,4I5)')' KKEVT before SDIFF',NP,NT,NN,ISINGD
      ENDIF
      IF ((NP.EQ.1).AND.(NT.EQ.1).AND.(NN.EQ.1)
C         Diffraction als for A-B collisions j.r. 2.2.99
C    &.AND.((IP.EQ.1).OR.(IT.EQ.1))
     &.AND.(EPN.GT.EHADTW))
     &   CALL SDIFF(EPROJ,PPROJ,KPROJ,NHKKH1,IQQDD)
C----------------------------------------------------------------
      IF (IFLAGD.EQ.1) RETURN
*
C----------------------------------------------------------------------
C
C********************************    SAMPLE THE X FRACTIONS
C                                    OF INTERACTING NUCLEONS / HADRONS
C
      IF (EPN.LE.EHADTW) THEN
 7107   CONTINUE
        ITTA=MCIHAD(IDHKK(IHTAWW))
      IF(IPEV.GT.1) THEN
        WRITE(IOdpm,'(A,I5,2F10.3)')
     + ' HADRIN CALL, IREJFO=',IREJFO, EHADTW
     *	,EHADTH
      ENDIF   
        CALL HADHAD(EPN,PPN,NHKKH1,IHTAWW,ITTA,IREJFO)
        IF(IREJFO.EQ.1) GO TO 7107
C                                  Transform into cms
	DO 111 I=NHKKH1+1,NHKK
	  PZNN=PHKK(3,I)
	  ENN=PHKK(4,I)
	  PHKK(3,I)=GAMCM*PZNN-BGCM*ENN
	  PHKK(4,I)=GAMCM*ENN-BGCM*PZNN
  111   CONTINUE
	
                                                           GO TO 110
      ENDIF
C-----------------------------------------------------------------------
C
C*********************  SAMPLE THE FLAVORS OF INTERACTING
C                       PROJECTILE AND TARGET HADRONS/NUCLEONS
C                       first run sea quarks
      CALL FLKSAA(NN,ECM)
C
      CALL XKSAMP(NN,ECM)
      DO 90 N=1,NSS
        INLOSS(N)=.TRUE.
   90 CONTINUE
      IF(IPEV.GE.6)WRITE(IOdpm,*)
     + ' KKEVT ,NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD ',
     *' after XKSAMP ',
     *NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD
C
      IF (IPEV.GE.6) THEN
        ITUM=MAX0(IP,IT,NN)
        WRITE(IOdpm,'(A,I10)')' KKEVT ITUM loop limit',ITUM
        WRITE(IOdpm,'(A,2A)') ' KKEVT (AFTER XKSAMP):',
     +  ' JSSH, JSSHS, JTSH, JTSHS, INTER1, INTER2',
     +  ' PKOO(1),PKOO(2),PKOO(3), TKOO(1),TKOO(2),TKOO(3)'
        DO 100 KKK=1,ITUM
          WRITE(IOdpm,'(6I5,6(1PE11.3))')
     +  JSSH(KKK),JSSHS(KKK),JTSH(KKK),
     +    JTSHS(KKK), INTER1(KKK),INTER2(KKK), PKOO(1,KKK),PKOO(2,KKK),
     +    PKOO(3,KKK), TKOO(1,KKK),TKOO(2,KKK),TKOO(3,KKK)
 
 
  100   CONTINUE
      ENDIF
C-----------------------------------------------------------------------
C
C*********************  SAMPLE THE FLAVORS OF INTERACTING
C                       PROJECTILE AND TARGET HADRONS/NUCLEONS
C                       second run valence quarks
      IF(IPEV.GE.6)WRITE(IOdpm,*)
     + ' KKEVT ,NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD ',
     *NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before flksam'
      CALL FLKSAM
C     IPEV=8
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after flksam'
      
 1012 FORMAT(' XKSAMP:',
     +' I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I),KKPROJ(I)')
 1022 FORMAT(I5,2E15.5,2I5,L5,I5)
 1032 FORMAT(' XKSAMP :  I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)')
 1042 FORMAT(I5,2E15.5,I5,L5)
 1060 FORMAT(' XKSAMP :  I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)')
 1052 FORMAT(' XKSAMP:',
     +' I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I),KKTARG(I)')
C     COMMON /IFROTO/ IFROVP(248),ITOVP(248),IFROSP(INTMX), IFROVT(248),
C    +ITOVT(248),IFROST(INTMX),JSSHS(INTMX),JTSHS(INTMX),JHKKNP(248),
C    +JHKKNT
C    +(248), JHKKPV(INTMX),JHKKPS(INTMX), JHKKTV(INTMX),JHKKTS(INTMX),
C    +MHKKVV(INTMX),MHKKSS(INTMX), MHKKVS(INTMX),MHKKSV(INTMX),
C    &                MHKKHH(INTMX),
C    +MHKKDV(248),MHKKVD(248), MHKKDS(INTMD),MHKKSD(INTMD)
C
      DO 511 I=1,IXPV
        IIPV=1+XPVQ(I)/0.02D0
	VXVP(IIPV)=VXVP(IIPV)+1.D0
        IIPD=1+XPVD(I)/0.02D0
	VXDP(IIPD)=VXDP(IIPD)+1.D0
	NXVP=NXVP+1
	NXDP=NXDP+1
  511 CONTINUE      
      DO 521 I=1,IXPS
        IIPS=1+XPSQ(I)/0.02D0
	VXSP(IIPS)=VXSP(IIPS)+1.D0
        IIPA=1+XPSAQ(I)/0.02D0
	VXSAP(IIPA)=VXSAP(IIPA)+1.D0
	NXSP=NXSP+1
	NXSAP=NXSAP+1
  521 CONTINUE      
      DO 531 I=1,IXTV
        IITV=1+XTVQ(I)/0.02D0
	VXVT(IITV)=VXVT(IITV)+1.D0
        IITD=1+XTVD(I)/0.02D0
	VXDT(IITD)=VXDT(IITD)+1.D0
	NXVT=NXVT+1
	NXDT=NXDT+1
  531 CONTINUE      
      DO 541 I=1,IXTS
        IITS=1+XTSQ(I)/0.02D0
	VXST(IITS)=VXST(IITS)+1.D0
        IITA=1+XTSAQ(I)/0.02D0
	VXSAT(IITA)=VXSAT(IITA)+1.D0
	NXST=NXST+1
	NXSAT=NXSAT+1
  541 CONTINUE      
      IF(IPCO.GE.1)THEN
        WRITE(IOdpm,'(A)')
     +  ' XKSAMP :  FINAL X-VALUES AFTER POTENTIAL CORRECTION'
        WRITE(IOdpm,1012)
        DO 510 I=1,IXPV
          WRITE(IOdpm,1022)
     +  I,XPVQ(I),XPVD(I),IFROVP(I),ITOVP(I),ZUOVP(I)
          WRITE(IOdpm,*)
     + ' I(1-IXPV),IPVQ(I),IPPV1(I),IPPV2(I)JHKKPV(I) ',
     *    I,IPVQ(I),IPPV1(I),IPPV2(I),JHKKPV(I)
  510   CONTINUE
        WRITE(IOdpm,1032)
        DO 520 I=1,IXPS
          WRITE(IOdpm,1042) I,XPSQ(I),XPSAQ(I),IFROSP(I),ZUOSP(I)
          WRITE(IOdpm,*)' I(1-IXPS),IPSQ(I),IPSAQ(I ),JHKKPS(I) ',
     *    I,IPSQ(I),IPSAQ(I),JHKKPS(I)
  520   CONTINUE
        WRITE(IOdpm,1052)
        DO 530 I=1,IXTV
          WRITE(IOdpm,1022)
     +  I,XTVQ(I),XTVD(I),IFROVT(I),ITOVT(I),ZUOVT(I)
          WRITE(IOdpm,*)
     + ' I(1-IXTV),ITVQ(I),ITTV1(I),ITTV2(I),JHKKTV(I) ',
     *    I,ITVQ(I),ITTV1(I),ITTV2(I),JHKKTV(I)
  530   CONTINUE
        WRITE(IOdpm,1060)
        DO 540 I=1,IXTS
          WRITE(IOdpm,1042) I,XTSQ(I),XTSAQ(I),IFROST(I),ZUOST(I)
          WRITE(IOdpm,*)' I(1-IXTS),ITSQ(I),ITSAQ(I),JHKKTS(I) ',
     *    I,ITSQ(I),ITSAQ(I),JHKKTS(I)
  540   CONTINUE
      ENDIF
      IF(IPEV.GE.6)WRITE(IOdpm,'(A,6I5)')
     *' XKSAMP NSV,NDV,NVS,NVD',
     +    NSV,NDV,NVS,NVD
C     IPEV=-1
C
C-------------------------
C                 TRANSFORM MOMENTA OF INTERACTING NUCLEONS
C                 (INCLUDING FERMI MOMENTA FROM NUCLEUS REST FRAMES)
C                 INTO NUCLEON-NUCLEON CMS (DEFINED WITHOUT FERMI MOM.
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before NUCMOM'
      DO 7745 IHKK=1,NHKK
        IF (IPHKK.GE.2) WRITE(IOdpm,1050) IHKK,ISTHKK(IHKK),IDHKK(IHKK),
     +  JMOHKK(1,IHKK),JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),
     +  (PHKK(KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 7745 CONTINUE
      CALL NUCMOM
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after NUCMOM'
      NONUST=0
      NONUJT=0
      NOMJE=0
      NOMJER=0
      IF(IPEV.GE.6)WRITE(IOdpm,*)
     + ' KKEVT ,NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD ',
     *NSS,NVS,NSV,NVV,NDS,NSD,NDV,NVD
C
C-----------------------------------------------------------------------
C
C          NOTE: THE FOLLOWING TREATMENT OF CHAIN SYSTEMS
C          ****  GENERALLY STARTS FROM THE NUCLEON-NUCLEON CMS
C                (DEFINED WITHOUT FERMI MOMENTA)
C-------------------------    TREATMENT OF SEA-SEA CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVSS, NSS',NSS
      IF(NSS.GT.0) CALL KKEVSS
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVSS'
C
C-----------------  TREATMENT OF sea diquark - sea CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVDS, NDS',NDS
C     IF(NDS.GT.0 .AND. LSEADI) THEN
      IF(NDS.GT.0) THEN
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before KKEVDS'
      IF(IDIQUA.EQ.1)  CALL KKEVDS(IREJDS)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVDS'
C       IPEV=1
        IF (IREJDS.EQ.1)                                        GO TO 10
      ENDIF
C
C
C-----------------  TREATMENT OF sea  - sea-diquark CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVSD NSD',NSD
C     IF(NSD.GT.0 .AND. LSEADI) THEN
      IF(NSD.GT.0) THEN
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before KKEVSD'
      IF(IDIQUA.EQ.1)  CALL KKEVSD(IREJSD)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVSD'
C       IPEV=1
        IF (IREJSD.EQ.1)                                        GO TO 10
      ENDIF
C
C
C-------------------------    TREATMENT OF SEA-VALENCE CHAIN SYSTEMS
C     IPEV=6
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVSV, NSV',NSV
      IF(NSV.GT.0) THEN
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before KKEVSV'
        CALL KKEVSV(IREJSV)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVSV'
C       IPEV=1
        IF (IREJSV.EQ.1)                                        GO TO 10
      ENDIF
C
C-----------------  TREATMENT OF sea diquark - VALENCE CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVDV, NDV',NDV
C     IF(NDV.GT.0 .AND. LSEADI) THEN
      IF(NDV.GT.0) THEN
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before KKEVDV'
      IF(IDIQUA.EQ.1)  CALL KKEVDV(IREJDV)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVDV'
C       IPEV=1
        IF (IREJDV.EQ.1)                                        GO TO 10
      ENDIF
C
C-------------------------    TREATMENT OF VALENCE-SEA CHAIN SYSTEMS
C     IPEV=6
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVVS, NVS',NVS
      IF(NVS.GT.0) THEN
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before KKEVVS'
        CALL KKEVVS(IREJVS)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVVS'
C       IPEV=1
        IF (IREJVS.EQ.1)                                        GO TO 10
      ENDIF
C
C-----------------  TREATMENT OF valence - sea diquark CHAIN SYSTEMS
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVVD,NVD',NVD
C     IF(NVD.GT.0 .AND. LSEADI) THEN
      IF(NVD.GT.0) THEN
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before KKEVVD'
      IF(IDIQUA.EQ.1)  CALL KKEVVD(IREJVD)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVVD'
C       IPEV=1
        IF (IREJVD.EQ.1)                                        GO TO 10
      ENDIF
C
C-------------------    TREATMENT OF VALENCE-VALENCE CHAIN SYSTEMS
C
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVVV, NVV',NVV
      CALL KKEVVV(IREJVV,IBPROJ)
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVVV'
C    &            IPVQ,IPPV1,IPPV2,ITVQ,ITTV1,ITTV2)
      IF (IREJVV.EQ.1)                                          GO TO 10
C     DO 5004 IHKK=1,NHKK
C         IF (IPHKK.GE.1) WRITE(6,5001)
C    *      IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),JMOHKK(2,IHKK),
C    &      JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK(KHKK,IHKK),KHKK=1,5),
C    &      (VHKK(KHKK,IHKK),KHKK=1,4)
C5004 CONTINUE
C

C
C-------------------    TREATMENT OF HARD CHAIN SYSTEMS
C
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVHH, NHH',NHH
      IF (IMINIJ.EQ.1) CALL KKEVHH
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVHH'
      IF(IPEV.GE.6)WRITE(IOdpm,*)' KKEVT before KKEVZZ, NZZ',NZZ
      CALL KKEVZZ
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT after KKEVZZ'
      NOMJT=NOMJT+NOMJE
      NOMJTR=NOMJTR+NOMJER
      IEVI=IEVI+1
C     IF(IEVI.LE.20)WRITE (6,7233)NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR
C7233 FORMAT (  '   NOMJE,NOMJER,NREJEV,NOMJT,NOMJTR ',5I10)
        DO 7787 III=1,NONUJT
          IF (IJJQ1(III).EQ.0.OR.IJJAQ1(III).EQ.0)THEN
            WRITE(IOdpm,7786)III,JHKKEX(III),IJJQ1(III),IJJAQ1(III),
     *                    AMJCH1(III)
 7786       FORMAT(' KKEVHH: III,JHKKEX,IJJQ1,IJJAQ1,AMCH1 ',4I10,F10.3)
            JHKKEX(III)=0
          ENDIF
 7787   CONTINUE
C-------------------------------------------------------------------
C
C                        COMBINE JETS
C
C------------------------------------------------------------------
C     IF(IPEV.GE.1)WRITE(6,*)' KKEVT before KKEVCC',LCOMBI
C     IF(LCOMBI) CALL KKEVCC(NN,IP,IT)
C     IF(IPEV.GE.6)WRITE(6,'(A)')' KKEVT after KKEVCC'
C----------------------------------------------------------------------
C          - TEST OF ENERGY MOMENTUM CONSERVATION ON NIVEAU OF CHAINS
C                                      AND ON NIVEAU OF CHAIN  ENDS
      IF(IPEV.GE.6)WRITE(IOdpm,'(A)')' KKEVT before EVTEST'
C     IF(IPEV.GE.1)CALL EVTEST(IREJ)
      CALL EVTEST(IREJ)
        IF (IPEV.GE.1) THEN
        WRITE(IOdpm,'(/A/)') ' KKEVT: FINAL LIST OF ENTRIES TO /HKKEVT/'
          DO 121 IHKK=1,NHKK
          WRITE(IOdpm,1050)
     +  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
  121     CONTINUE
        ENDIF
      IF (IREJ.EQ.1)THEN 
        IF(IPEV.GE.1)WRITE(IOdpm,'(A)')' EVTEST REJECTION would be '
 	IREJ=0
        IF (IREJ.EQ.1)GO TO 10
      ENDIF
      IF(IPEV.GE.1)WRITE(IOdpm,'(A)')' KKEVT after EVTEST'
C
C-----------------------------------------------------------------------
C                        CONSTRUCT HISTOGRAMS FROM PARTONS ON CHAIN ENDS
C
C     IF(IPADIS) CALL DISTPA(2)
C
C-----------------------------------------------------------------------
C               -  HADRONIZATION OF CHAINS  (HADRKK)
C                  AND BACK TRANSFORMATION FROM NN-CMS INTO LAB (HADRKK)
C
      IF(IPEV.GE.1)WRITE(IOdpm,'(A)')' KKEVT long before HADRKK'
      IF(IHADA.OR.IHADSS.OR.IHADSV.OR.IHADVS.OR.IHADVV) THEN
      IF(IPEV.GE.1)WRITE(IOdpm,'(A)')' KKEVT before HADRKK'
C      IF(IEVEVEV.LT.10)THEN
C        WRITE(IOdpm,'(/A/)') ' KKEVT: before HADRKK ENTRIES TO /HKKEVT/'
C        DO 1120 IHKK=1,NHKK
C          WRITE(IOdpm,1050)
C     +  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
C     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
C 1120   CONTINUE
C       ENDIF
        IEVEVEV=IEVEVEV+1

C       WRITE(6,*)' HADRKK IEVEVEV ',IEVEVEV
        CALL HADRKK(NHKKH1,PPN)
      IF(IPEV.GE.1)WRITE(IOdpm,'(A)')' KKEVT after HADRKK'
      ENDIF
C
  110 CONTINUE
C
C                           Correct HKKEVT COMMON
C                           ONLY FOR RUNS WITHOUT EVAPORATION
C     IF((IEVAP.EQ.0).AND.(KTAUGE.EQ.0))CALL CORRCO
C     not for runs with hadhad
      IF (EPN.GE.EHADTW) THEN
        CALL CORRCO
      ENDIF

C        DIQTOC CALL----------------------------------
C      WRITE(6,*)' diqtoc IEVEVEV ',IEVEVEV
      CALL DIQTOC(NHKKH1)
C      WRITE(6,*)' after diqtoc NHKK ',NHKK
C-----------------------------------------------------
      IIALAMC=0
      IILAMC=0
      DO 5120 IHKK=1,NHKK
        IF(ISTHKK(IHKK).EQ.1.AND.IDHKK(IHKK).EQ.-4122)IIALAMC=IIALAMC+1
       IF(ISTHKK(IHKK).EQ.1.AND.IDHKK(IHKK)/100.EQ.-4)IIALAMC=IIALAMC+1
        IF(ISTHKK(IHKK).EQ.1.AND.IDHKK(IHKK).EQ.4122)IILAMC=IILAMC+1
       IF(ISTHKK(IHKK).EQ.1.AND.IDHKK(IHKK)/100.EQ.4)IILAMC=IILAMC+1
 5120 CONTINUE     
C     IF(IIALAMC.EQ.1.AND.IILAMC.EQ.0)IREJ=1
C     IF(IIALAMC.EQ.1.AND.IILAMC.EQ.0)GO TO 10
C     IF(IEVEVEV.LT.10)THEN
C      WRITE(IOdpm,*) ' KKEVT: after  DIQTOC TO /HKKEVT/'
C    *  ,IILAMC,IIALAMC,IEVEVEV
C       DO 2120 IHKK=1,NHKK
C         WRITE(IOdpm,1050)
C    +  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
C    +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
C    +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
C
C2120   CONTINUE
C       ENDIF
C
C        Trigger ICENTR=8 NCH > 5 (NA35 p-S data)
      IIICH=0
      IF (ICENTR.EQ.8)THEN
        DO 128 IHKK=1,NHKK
	  IF(ISTHKK(IHKK).EQ.1)THEN
            NRHKK=MCIHAD(IDHKK(IHKK))
            ICHHKK=IICH(NRHKK)
            IF(ICHHKK.NE.0)THEN
C             PTT=PHKK(1,IHKK)**2+PHKK(2,IHKK)**2+0.000001
C             AMT=SQRT(PTT+PHKK(5,IHKK)**2)
C             YL=LOG((ABS(PHKK(3,IHKK) + PHKK(4,IHKK)))/AMT+1.E-18)
C             IF(YL.GT.0.6D0.AND.YL.LT.7.D0)THEN
	        IIICH=IIICH+1
C             ENDIF
	    ENDIF
	  ENDIF
  128   CONTINUE
         IF(IIICH.LE.14)THEN
          WRITE(IOdpm,*)' reject ',IIICH
          GO TO 22
	ENDIF
          WRITE(IOdpm,*)' no reject ',IIICH
      ENDIF
C
      IF (IPEV.GE.1) THEN
        WRITE(IOdpm,'(/A/)') ' KKEVT: FINAL LIST OF ENTRIES TO /HKKEVT/'
        DO 120 IHKK=1,NHKK
          WRITE(IOdpm,1050)
     +  IHKK,ISTHKK(IHKK),IDHKK(IHKK),JMOHKK(1,IHKK),
     +    JMOHKK(2,IHKK), JDAHKK(1,IHKK),JDAHKK(2,IHKK),(PHKK
     +    (KHKK,IHKK),KHKK=1,5), (VHKK(KHKK,IHKK),KHKK=1,4)
 
  120   CONTINUE
      ENDIF
C
      SUNDZ=SUNDZ+NDZ
      SUNZD=SUNZD+NZD
      NZDSU=SUNZD
      NDZSU=SUNDZ
      IF(IPEV.GE.6)WRITE(IOdpm,*)' END KKEVT NZD,NZDSU,NDZ,NDZSU',
     * NZD,NZDSU,NDZ,NDZSU
      RETURN
      END

